<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="embeded, 海思, hisilicon, Linux, Driver, 3798M, 3531a, MPP, UNF, Kernel">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=G-EWP4K8DJTE"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-EWP4K8DJTE');
</script>


    <title>海思MPP&amp;UNF构架源代码级分析 | 夜法之书</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/appotry/hexo@1.8/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/appotry/hexo@1.8/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/appotry/hexo@1.8/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/appotry/hexo@1.8/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/appotry/hexo@1.8/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/appotry/hexo@1.8/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/appotry/hexo@1.8/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/appotry/hexo@1.8/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/appotry/hexo@1.8/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="夜法之书" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/appotry/hexo@1.8/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">夜法之书</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-link" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>交流</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/contact">
          
          <i class="fas fa-comments" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>留言</span>
        </a>
      </li>
      
      <li>
        <a href="/bb">
          
          <i class="fas fa-bullhorn" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>哔哔</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://t.me/joinchat/Sg3__qc4LBE2VsLO">
          
          <i class="fab fa-telegram-plane" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>TG群</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-code" style="zoom: 0.6;"></i>
      
      <span>快查</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/cheatsheets/Vim_CN.docset/Contents/Resources/Documents/">
          
          <i class="fab fa-vimeo-v" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Vim快查表</span>
        </a>
      </li>
      
      <li>
        <a href="/cheatsheets/Visual_Studio_Code.docset/Contents/Resources/Documents/">
          
          <i class="fas fa-code" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>VSCode快查表</span>
        </a>
      </li>
      
      <li>
        <a href="/cheatsheets/Git.docset/Contents/Resources/Documents/">
          
          <i class="fab fa-git-square" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Git快查表</span>
        </a>
      </li>
      
      <li>
        <a href="/cheatsheets/SQLite.docset/Contents/Resources/Documents/">
          
          <i class="fas fa-database" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>SQLite快查表</span>
        </a>
      </li>
      
      <li>
        <a href="/cheatsheets/tmux.docset/Contents/Resources/Documents/">
          
          <i class="fas fa-terminal" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Tmux快查表</span>
        </a>
      </li>
      
      <li>
        <a href="/cheatsheets/Bash_Shortcuts.docset/Contents/Resources/Documents/">
          
          <i class="fas fa-terminal" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Bash快查表</span>
        </a>
      </li>
      
      <li>
        <a href="/cheatsheets/">
          
          <i class="fas fa-laptop-code" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>更多快查表</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-laptop-code" style="zoom: 0.6;"></i>
      
      <span>项目</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/drop-in">
          
          <i class="fab fa-docker" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Docker:VimIDE</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/hexo">
          
          <i class="fab fa-docker" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Docker:hexo</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/v2fly-privoxy">
          
          <i class="fab fa-docker" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Docker:v2fly-privoxy</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/nginx-purge">
          
          <i class="fab fa-docker" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Docker:nginx-purge</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/rclonebrowser">
          
          <i class="fab fa-docker" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Docker:rclonebrowser</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://github.com/appotry/PTtool">
          
          <i class="fab fa-linux" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>LinuxHarkLinkTools</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://github.com/appotry/">
          
          <i class="fab fa-github" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>更多项目</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-toolbox" style="zoom: 0.6;"></i>
      
      <span>工具</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a target="_blank" rel="noopener" href="https://linux-command.17lai.fun/">
          
          <i class="fas fa-terminal" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Linux命令查询</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="http://encode.chahuo.com/">
          
          <i class="fas fa-tools" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>在线加密解密</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://markmap.js.org/repl">
          
          <i class="fas fa-brain" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>在线思维导图</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://fontawesome.com/v5.15/icons">
          
          <i class="fab fa-font-awesome" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Awesome图标</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="http://ping.chinaz.com/">
          
          <i class="fas fa-tools" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>在线站长工具</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="http://tool.chinaz.com/port/">
          
          <i class="fas fa-tools" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>在线端口扫描</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-id-badge" style="zoom: 0.6;"></i>
      
      <span>关于</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/about">
          
          <i class="fas fa-user-circle" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>关于我</span>
        </a>
      </li>
      
      <li>
        <a href="/aboutme/mytech/">
          
          <i class="fas fa-address-card" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>我的技术</span>
        </a>
      </li>
      
      <li>
        <a href="/aboutme/myproject/">
          
          <i class="fas fa-laptop-code" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>我的项目</span>
        </a>
      </li>
      
      <li>
        <a href="/aboutme/mypost/">
          
          <i class="fas fa-pen-nib" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>我的文章</span>
        </a>
      </li>
      
      <li>
        <a href="/aboutme/needtoread/">
          
          <i class="fas fa-exclamation-circle" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>博客须知</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/appotry/hexo@1.8/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">夜法之书</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-link"></i>
			
			友链
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-comments"></i>
			
			交流
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/contact " style="margin-left:75px">
				  
				   <i class="fa fas fa-comments" style="position: absolute;left:50px" ></i>
			      
		          <span>留言</span>
                  </a>
                </li>
              
                <li>

                  <a href="/bb " style="margin-left:75px">
				  
				   <i class="fa fas fa-bullhorn" style="position: absolute;left:50px" ></i>
			      
		          <span>哔哔</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://t.me/joinchat/Sg3__qc4LBE2VsLO " style="margin-left:75px">
				  
				   <i class="fa fab fa-telegram-plane" style="position: absolute;left:50px" ></i>
			      
		          <span>TG群</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-code"></i>
			
			快查
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/cheatsheets/Vim_CN.docset/Contents/Resources/Documents/ " style="margin-left:75px">
				  
				   <i class="fa fab fa-vimeo-v" style="position: absolute;left:50px" ></i>
			      
		          <span>Vim快查表</span>
                  </a>
                </li>
              
                <li>

                  <a href="/cheatsheets/Visual_Studio_Code.docset/Contents/Resources/Documents/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-code" style="position: absolute;left:50px" ></i>
			      
		          <span>VSCode快查表</span>
                  </a>
                </li>
              
                <li>

                  <a href="/cheatsheets/Git.docset/Contents/Resources/Documents/ " style="margin-left:75px">
				  
				   <i class="fa fab fa-git-square" style="position: absolute;left:50px" ></i>
			      
		          <span>Git快查表</span>
                  </a>
                </li>
              
                <li>

                  <a href="/cheatsheets/SQLite.docset/Contents/Resources/Documents/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-database" style="position: absolute;left:50px" ></i>
			      
		          <span>SQLite快查表</span>
                  </a>
                </li>
              
                <li>

                  <a href="/cheatsheets/tmux.docset/Contents/Resources/Documents/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-terminal" style="position: absolute;left:50px" ></i>
			      
		          <span>Tmux快查表</span>
                  </a>
                </li>
              
                <li>

                  <a href="/cheatsheets/Bash_Shortcuts.docset/Contents/Resources/Documents/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-terminal" style="position: absolute;left:50px" ></i>
			      
		          <span>Bash快查表</span>
                  </a>
                </li>
              
                <li>

                  <a href="/cheatsheets/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-laptop-code" style="position: absolute;left:50px" ></i>
			      
		          <span>更多快查表</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-laptop-code"></i>
			
			项目
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/drop-in " style="margin-left:75px">
				  
				   <i class="fa fab fa-docker" style="position: absolute;left:50px" ></i>
			      
		          <span>Docker:VimIDE</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/hexo " style="margin-left:75px">
				  
				   <i class="fa fab fa-docker" style="position: absolute;left:50px" ></i>
			      
		          <span>Docker:hexo</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/v2fly-privoxy " style="margin-left:75px">
				  
				   <i class="fa fab fa-docker" style="position: absolute;left:50px" ></i>
			      
		          <span>Docker:v2fly-privoxy</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/nginx-purge " style="margin-left:75px">
				  
				   <i class="fa fab fa-docker" style="position: absolute;left:50px" ></i>
			      
		          <span>Docker:nginx-purge</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/rclonebrowser " style="margin-left:75px">
				  
				   <i class="fa fab fa-docker" style="position: absolute;left:50px" ></i>
			      
		          <span>Docker:rclonebrowser</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://github.com/appotry/PTtool " style="margin-left:75px">
				  
				   <i class="fa fab fa-linux" style="position: absolute;left:50px" ></i>
			      
		          <span>LinuxHarkLinkTools</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://github.com/appotry/ " style="margin-left:75px">
				  
				   <i class="fa fab fa-github" style="position: absolute;left:50px" ></i>
			      
		          <span>更多项目</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-toolbox"></i>
			
			工具
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a target="_blank" rel="noopener" href="https://linux-command.17lai.fun/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-terminal" style="position: absolute;left:50px" ></i>
			      
		          <span>Linux命令查询</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="http://encode.chahuo.com/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-tools" style="position: absolute;left:50px" ></i>
			      
		          <span>在线加密解密</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://markmap.js.org/repl " style="margin-left:75px">
				  
				   <i class="fa fas fa-brain" style="position: absolute;left:50px" ></i>
			      
		          <span>在线思维导图</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://fontawesome.com/v5.15/icons " style="margin-left:75px">
				  
				   <i class="fa fab fa-font-awesome" style="position: absolute;left:50px" ></i>
			      
		          <span>Awesome图标</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="http://ping.chinaz.com/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-tools" style="position: absolute;left:50px" ></i>
			      
		          <span>在线站长工具</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="http://tool.chinaz.com/port/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-tools" style="position: absolute;left:50px" ></i>
			      
		          <span>在线端口扫描</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-id-badge"></i>
			
			关于
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/about " style="margin-left:75px">
				  
				   <i class="fa fas fa-user-circle" style="position: absolute;left:50px" ></i>
			      
		          <span>关于我</span>
                  </a>
                </li>
              
                <li>

                  <a href="/aboutme/mytech/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-address-card" style="position: absolute;left:50px" ></i>
			      
		          <span>我的技术</span>
                  </a>
                </li>
              
                <li>

                  <a href="/aboutme/myproject/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-laptop-code" style="position: absolute;left:50px" ></i>
			      
		          <span>我的项目</span>
                  </a>
                </li>
              
                <li>

                  <a href="/aboutme/mypost/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-pen-nib" style="position: absolute;left:50px" ></i>
			      
		          <span>我的文章</span>
                  </a>
                </li>
              
                <li>

                  <a href="/aboutme/needtoread/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-exclamation-circle" style="position: absolute;left:50px" ></i>
			      
		          <span>博客须知</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/appotry/hexo@1.8/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/cover/hisi.jpeg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">海思MPP&amp;UNF构架源代码级分析</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/appotry/hexo@1.8/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Linux/">
                                <span class="chip bg-color">Linux</span>
                            </a>
                        
                            <a href="/tags/MPP/">
                                <span class="chip bg-color">MPP</span>
                            </a>
                        
                            <a href="/tags/embeded/">
                                <span class="chip bg-color">embeded</span>
                            </a>
                        
                            <a href="/tags/hisilicon/">
                                <span class="chip bg-color">hisilicon</span>
                            </a>
                        
                            <a href="/tags/Driver/">
                                <span class="chip bg-color">Driver</span>
                            </a>
                        
                            <a href="/tags/3798M/">
                                <span class="chip bg-color">3798M</span>
                            </a>
                        
                            <a href="/tags/UNF/">
                                <span class="chip bg-color">UNF</span>
                            </a>
                        
                            <a href="/tags/Kernel/">
                                <span class="chip bg-color">Kernel</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/embeded/" class="post-category">
                                embeded
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-07-01
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-09-16
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    7.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    30 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/appotry/hexo@1.8/libs/prism/prism.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <ul>
<li><p>文章写了好多年了，只在一个网站发布过PDF版本。行业内应该很多人看过这个。由于早期笔记使用Word格式，转换格式时有不少格式错误，笔者尽量修正。</p>
</li>
<li><p>关于本blog，<strong>图床</strong>一般使用<strong>github</strong>，已经配置了CDN，如果图片还是未显示请自行代理解决</p>
</li>
<li><p><strong>原创声明警告</strong>，文章<strong>禁止转载</strong>，禁止发布到其它任何网站，可以接受约稿。</p>
</li>
</ul>
<h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>​    本文通过分析海思文档和代码，把海思SDK的MPI和UNF构架大概实现思想和构架进行了简略的分析。着重分析了内存管理，底层功能如何实现。</p>
<p>​    前面章节简要分析了NVR芯片MPI构架及其内存管理机制，后面着重详细分析了3798M底层模块api和drv实现的细节过程及其方法流程。</p>
<p>​    本文前面简略分析了DVR，MPI构架的大体实现机制。后面就具体分析3798M UNF构架的实现。</p>
<p>本文不光分析了UNF构架，还使用了很多工具，辅助分析代码。这里从三个层面分析了UNF的实现。</p>
<p>1: 应用层，驱动层的实现框架，使用source insight查看代码并着重分析了avplay等几个模块。</p>
<p>2：静态分析函数调用。使用cflow，dot工具生成调用关系图</p>
<p>3：动态追踪运行过程。Ltrace, strace, valgrind分析函数调用，perf动态分析内核调用。</p>
<h2 id="1-Hi35xx系列芯片MPP构架"><a href="#1-Hi35xx系列芯片MPP构架" class="headerlink" title="1:Hi35xx系列芯片MPP构架"></a>1:Hi35xx系列芯片MPP构架</h2><h2 id="1-1-概述"><a href="#1-1-概述" class="headerlink" title="1.1 概述"></a>1.1 概述</h2><p>海思提供的媒体处理软件平台(Media Process Platform,简称 MPP)，可支持应用软件快速开发。该平台对应用软件屏蔽了芯片相关的复杂的底层处理，并对应用软件直接提供MPI（MPP Programe Interface）接口完成相应功能。该平台支持应用软件快速开发以下功能：输入视频捕获、H.264/MJPEG/JPEG/MPEG4 编码、H264/H.265/VC1/MPEG4/MPEG2/AVS 解码、视频输出显示、视频图像前处理（包括去噪、增强、锐化、Deinterlace） 、编码码流叠加 OSD、视频侦测分析、智能分析、音频捕获及输出、音频编解码等功能。</p>
<h2 id="1-2-整体软硬件构架"><a href="#1-2-整体软硬件构架" class="headerlink" title="1.2 整体软硬件构架"></a>1.2 整体软硬件构架</h2><p><img src="https://images.weserv.nl/?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730160509.png" alt="image-20210730160508049">                              </p>
<p>MPP 平台支持的典型的系统层次如上图所示，主要分为以下层次：</p>
<p><strong>硬件层</strong></p>
<p>硬件层由 Hi35xx 芯片加上必要的外围器件构成。外围器件包括 Flash、DDR<br>（Double Data-Rate） 、视频 Sensor 或 AD、音频 AD 等。</p>
<p><strong>操作系统层</strong></p>
<p>基于 Linux 3.10.y 的 OS 系统。</p>
<p><strong>媒体处理平台</strong></p>
<p>基于操作系统层，控制芯片完成相应的媒体处理功能。它对应用层屏蔽了硬件处理细节，并为应用层提供 API 接口完成相应功能。</p>
<p><strong>其他驱动</strong></p>
<p>除媒体处理平台外,海思为 Hi35xx 芯片的其他相关硬件处理单元提供了相应的驱动,</p>
<p>包括 GMAC、SDIO、I2C、USB、SSP 等驱动。</p>
<p><strong>应用层</strong></p>
<p>基于海思媒体处理平台及其他驱动，由用户开发的应用软件系统。</p>
<h2 id="1-3-海思媒体处理平台架构"><a href="#1-3-海思媒体处理平台架构" class="headerlink" title="1.3 海思媒体处理平台架构"></a>1.3 海思媒体处理平台架构</h2><p>海思媒体处理平台的主要内部处理流程如上图所示，主要分为视频输入（VI） 、视频处理（VPSS） 、视频编码（VENC） 、视频解码（VDEC） 、视频输出(VO)、视频侦测分析(VDA)、音频输入(AI)、音频输出(AO)、音频编码（AENC） 、音频解码（ADEC） 、区域管理（REGION）等模块。主要的处理流程介绍如下</p>
<p><img src="https://images.weserv.nl/?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730160451.png" alt="image-20210730160449679"></p>
<ul>
<li><p>VI 模块捕获视频图像，可对其做剪切、缩放、镜像等处理，并输出多路不同分辨<br> 率的图像数据。</p>
</li>
<li><p>解码模块对编码后的视频码流进行解码，并将解析后的图像数据送 VPSS 进行图<br> 像处理或直接送 VO 显示。可对 H.264/H.265/VC1/MPEG4/MPEG2/AVS 格式的视<br> 频码流进行解码。</p>
</li>
<li><p>VPSS 模块接收 VI 和解码模块发送过来的图像，可对图像进行去噪、图像增强、<br> 锐化等处理，并实现同源输出多路不同分辨率的图像数据用于编码、预览或抓<br> 拍。</p>
</li>
<li><p>编码模块接收 VI 捕获并经 VPSS 处理后输出的图像数据，可叠加用户通过 Region<br> 模块设置的 OSD 图像，然后按不同协议进行编码并输出相应码流。<br> VDA 模块接收 VI 的输出图像，并进行移动侦测和遮挡侦测，最后输出侦测分析<br> 结果。</p>
</li>
<li><p>VO 模块接收 VPSS 处理后的输出图像，可进行播放控制等处理，最后按用户配置<br> 的输出协议输出给外围视频设备。</p>
</li>
<li><p>AI 模块捕获音频数据，然后 AENC 模块支持按多种音频协议对其进行编码，最后<br> 输出音频码流。</p>
</li>
<li><p>用户从网络或外围存储设备获取的音频码流可直接送给 ADEC 模块，ADEC 支持</p>
</li>
</ul>
<h2 id="1-4-MMZ与模块绑定"><a href="#1-4-MMZ与模块绑定" class="headerlink" title="1.4 MMZ与模块绑定"></a>1.4 MMZ与模块绑定</h2><p><img src="https://images.weserv.nl/?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730160438.png" alt="image-20210730160437079"></p>
<p>MPP 提供系统绑定接口（HI_MPI_SYS_Bind） ，即通过数据接收者绑定数据源来建立</p>
<p>两者之间的关联关系（只允许数据接收者绑定数据源） 。绑定后，数据源生成的数据将</p>
<p>自动发送给接收者。</p>
<p>Uboot环境变量中定义linux内核使用的内存大小</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">setenv <span class="token string">'mem=288M console=ttyAMA0,115200 root=/dev/mtdblock2 rootfstype=jffs2 mtdparts=hi_sfc:768K(boot),2304K(sdr021000),13M(rootfs)'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>加载内核模块分配MMZ内存大小</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">insmod mmz.ko <span class="token assign-left variable">mmz</span><span class="token operator">=</span>anonymous,0,0x8E000000,792M <span class="token assign-left variable">anony</span><span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>例如512M的DDR</p>
<p>  DDR:                            </p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">DDR:                                                          
-----------<span class="token operator">|</span>----------<span class="token operator">|</span>  0x80000000   <span class="token comment"># Memory managed by OS.             </span>
   64M     <span class="token operator">|</span>   OS     <span class="token operator">|</span>                                                
           <span class="token operator">|</span>          <span class="token operator">|</span>                                                
-----------<span class="token operator">|</span>----------<span class="token operator">|</span>  0x84000000   <span class="token comment"># Memory managed by MMZ block anonymous.         </span>
   448M    <span class="token operator">|</span>    MMZ   <span class="token operator">|</span>                                                
           <span class="token operator">|</span>          <span class="token operator">|</span>                                                
-----------<span class="token operator">|</span>----------<span class="token operator">|</span>  0xA0000000   <span class="token comment"># Memory managed by MMZ block jpeg.                      </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="1-5-HiMPP-支持的绑定关系"><a href="#1-5-HiMPP-支持的绑定关系" class="headerlink" title="1.5 HiMPP 支持的绑定关系"></a>1.5 HiMPP 支持的绑定关系</h2><table>
<thead>
<tr>
<th>数据源</th>
<th>数据接收者</th>
</tr>
</thead>
<tbody><tr>
<td>VI</td>
<td>VO</td>
</tr>
<tr>
<td></td>
<td>VENC</td>
</tr>
<tr>
<td></td>
<td>VDA</td>
</tr>
<tr>
<td></td>
<td>VPSS</td>
</tr>
<tr>
<td></td>
<td>PCIV</td>
</tr>
<tr>
<td>VPSS</td>
<td>VO</td>
</tr>
<tr>
<td></td>
<td>VENC</td>
</tr>
<tr>
<td></td>
<td>VDA</td>
</tr>
<tr>
<td></td>
<td>VPSS</td>
</tr>
<tr>
<td></td>
<td>PCIV</td>
</tr>
<tr>
<td>VDEC</td>
<td>VPSS</td>
</tr>
<tr>
<td></td>
<td>VO（只能是标清设备或 single 模式分割）</td>
</tr>
<tr>
<td></td>
<td>VDA</td>
</tr>
<tr>
<td></td>
<td>PCIV</td>
</tr>
<tr>
<td>vo(WBC)</td>
<td>VO</td>
</tr>
<tr>
<td></td>
<td>VENC</td>
</tr>
<tr>
<td></td>
<td>VPSS</td>
</tr>
<tr>
<td></td>
<td>PCIV</td>
</tr>
<tr>
<td>AI</td>
<td>AENC</td>
</tr>
<tr>
<td></td>
<td>AO</td>
</tr>
<tr>
<td>ADEC</td>
<td>AO</td>
</tr>
</tbody></table>
<h2 id="1-6-函数约定说明"><a href="#1-6-函数约定说明" class="headerlink" title="1.6 函数约定说明"></a>1.6 函数约定说明</h2><ul>
<li><p>Open/Close<br>Open/Close 操作用来打开、关闭那些可枚举的设备。</p>
</li>
<li><p>Create/ Destroy<br>Create/ Destroy 操作用来创建、销毁那些不可枚举的设备。</p>
</li>
<li><p>Handle<br>Handle 用来标识一个“不可枚举”类型的设备。Handle 只在本进程内有效，也就是说 Handle 不可以跨进程传递Handle 是一个 32bit 的数据，其低 8bit 表示设备的 ID，高 16bit 表示模块 ID。比如0x00110000 表示模块 ID 为 0x11 的第 0 个设备。</p>
</li>
<li><p>Attach /Detach<br>Attach/Detach 用来绑定、解绑定两个设备直接的关联。</p>
</li>
</ul>
<p>Attach 后，目的设备将自动处于 Start/Enable 状态； Detach 后，目的设备将自动处于Stop/Disable 状态。<br>对于多级绑定，<strong>要求从最后一个设备逐级向前绑定，解绑定的顺序则相反，要求逐级向后。</strong>**<br>** 当绑定在一起的多个设备可以设置相同属性时，必须通过最后一个设备进行设置。</p>
<ul>
<li><p>Get/Put<br>Get/Put 用来往某个模块输入数据。</p>
</li>
<li><p>Acquire/Release<br>Acquire/Release 用来从某个模块获取数据。</p>
</li>
</ul>
<p>Get/Put和Acquire/Release推荐成对使用</p>
<p><img src="https://images.weserv.nl/?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155911.png" alt="image-20210730155909596"></p>
<h2 id="1-7-MPP优缺点"><a href="#1-7-MPP优缺点" class="headerlink" title="1.7 MPP优缺点"></a>1.7 MPP优缺点</h2><h3 id="1-7-1-MPP优点"><a href="#1-7-1-MPP优点" class="headerlink" title="1.7.1 MPP优点"></a>1.7.1 MPP优点</h3><p>​    内存VB管理和模块绑定子系统，proc运行时调试信息是MPP构架节约用户时间最大的设计。</p>
<p>​    大部分外围接口都封装好，用户调用接口直接使用，快速，方便。</p>
<h3 id="1-7-2-MPP缺点"><a href="#1-7-2-MPP缺点" class="headerlink" title="1.7.2 MPP缺点"></a>1.7.2 MPP缺点</h3><p>​    没有相应子系统的源代码。出了问题，有bug必须需要海思查看，解决。</p>
<p>​    MPI接口和标准linux接口差异非常大，构架也不一样。有问题需要找海思。中间时间成本。</p>
<p>不利于研发技术积累。</p>
<h2 id="2-MPP和UNF对比"><a href="#2-MPP和UNF对比" class="headerlink" title="2:  MPP和UNF对比"></a>2:  MPP和UNF对比</h2><p>从函数命名，参数，使用方法来看。UNF和MPP分开比较早，UNF构架在上面函数约定说明基础上的MPI接口封装了一层，UNF-&gt;MPI调用，UNF开发支持更多的模块接口。MPP的模块接口比较固定，比UNF少得多，增强了MMZ内存，VB管理功能，模块绑定功能。</p>
<p>MPP由HI_MPI_SYS_Bind来绑定两个模块，而UNF还是使用Hi_XXX_Attach来绑定两个模块。</p>
<p>MPP内存管理MMZ，VB也比UNF更细致，强大。</p>
<p>UNF支持更多的外设模块。如TUNER（广播电视），CIPHER（芯片内部加密），Subtitle（字幕），PDM（低功耗），SCI（智能卡），GPU等。</p>
<p>UNF开源。在一些模块的实现中，也使用了一些开源项目，如FFmpeg，Alsa，wpa_supplicant等。</p>
<h2 id="3-3798芯片UNF处理构架"><a href="#3-3798芯片UNF处理构架" class="headerlink" title="3:  3798芯片UNF处理构架"></a>3:  3798芯片UNF处理构架</h2><h2 id="3-1-应用架构"><a href="#3-1-应用架构" class="headerlink" title="3.1 应用架构"></a>3.1 应用架构</h2><p>海思媒体处理平台（ MSP）实现了对海思高清机顶盒解决方案处理器中媒体、图形以<br>及外设的屏蔽和封装，对应用软件直接提供 API（ Application Program Interface）接口<br>完成相应功能。典型的应用架构如下图所示</p>
<p><img src="https://images.weserv.nl/?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155841.png" alt="image-20210730155840578"></p>
<p><strong>3798<strong><strong>比35xx</strong></strong>多了一个UNF<strong><strong>层，它在MPI</strong></strong>基础上进行了一层封装</strong></p>
<p>软件架构主要包含以下 4 层：</p>
<ul>
<li><p>UNF层</p>
<p>媒体处理平台（ MSP）对外统一的应用开发接口。</p>
</li>
<li><p>MPI层</p>
<p>处理器各模块硬件能力实现层的用户态部分。</p>
</li>
<li><p>DRV层</p>
<p>处理器各模块硬件能力实现层的内核态部分。</p>
</li>
<li><p>HAL层</p>
<p>处理器各模块的硬件抽象层。</p>
</li>
</ul>
<h2 id="3-2-3798SDK-概览（功能介绍）"><a href="#3-2-3798SDK-概览（功能介绍）" class="headerlink" title="3.2 3798SDK 概览（功能介绍）"></a>3.2 3798SDK 概览（功能介绍）</h2><p>媒体处理平台（ MSP）中所有模块按照功能可以分为媒体处理，图形处理，外设处理 3<br>类：</p>
<ul>
<li><p>媒体处理</p>
<p>DEMUX、 AVPLAY、 SOUND、 DISPLAY、 VO、 HDMI、 PVR、 VDEC、 VENC、<br>ADEC、 AENC、 VI、 AI</p>
</li>
<li><p>图形处理</p>
<p>HIFB、 HIGO、 TDE、 JPEG、 JPGE、 GPU</p>
</li>
<li><p>外设处理</p>
<p>Cipher、 OTP、 PMOC、 Frontend、 I2C、 SCI、 KEYLED、 GPIO、 IR、 WDG、 C51</p>
</li>
</ul>
<h2 id="3-3-3798内存管理"><a href="#3-3-3798内存管理" class="headerlink" title="3.3 3798内存管理"></a>3.3 3798内存管理</h2><h3 id="3-3-1-Mmz内存"><a href="#3-3-1-Mmz内存" class="headerlink" title="3.3.1 Mmz内存"></a>3.3.1 Mmz内存</h3><p>3798的mmz内存在uboot bootargs环境变量中分配，在内核中大块连续内存使用dma_alloc_from_contiguous（drv/mmz/drv_media_mem_v2.c）来分配内存， 小块内存使用kmalloc分配，并且使用内核链表标记管理。和应用层交互使用mamp，umamp，并使用内核链表管理内存。这点和35xx DVR芯片有很大区别，DVR芯片模块内存和linux内核使用内存不再一个地方，应该是通过物理地址往虚拟地址映射来使用的。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># cat /proc/cmdline</span>
<span class="token assign-left variable">mem</span><span class="token operator">=</span>1G <span class="token assign-left variable">console</span><span class="token operator">=</span>ttyAMA0,115200 <span class="token assign-left variable">root</span><span class="token operator">=</span>/dev/romblock3 <span class="token assign-left variable">rootfstype</span><span class="token operator">=</span>squashfs <span class="token assign-left variable">mtdparts</span><span class="token operator">=</span>hinand:5M<span class="token punctuation">(</span>boot<span class="token punctuation">)</span>,1M<span class="token punctuation">(</span>baseparam<span class="token punctuation">)</span>,7M<span class="token punctuation">(</span>kernel<span class="token punctuation">)</span>,18M<span class="token punctuation">(</span>rootfs<span class="token punctuation">)</span>,64M<span class="token punctuation">(</span>appfs<span class="token punctuation">)</span>,16M<span class="token punctuation">(</span>qte<span class="token punctuation">)</span>,4M<span class="token punctuation">(</span>config<span class="token punctuation">)</span>,12M<span class="token punctuation">(</span>log<span class="token punctuation">)</span>,1M<span class="token punctuation">(</span>logo<span class="token punctuation">)</span> <span class="token assign-left variable">mmz</span><span class="token operator">=</span>ddr,0,0,500M<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>具体就是在bootargs中配置mem=1G mmz=ddr,0,0,435M</p>
<p>查看内存使用情况跟监控相同，通过cat /proc/media-mem</p>
<p><img src="https://images.weserv.nl/?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155600.png" alt="image-20210730155558827"></p>
<h3 id="3-3-2-解码vid内存"><a href="#3-3-2-解码vid内存" class="headerlink" title="3.3.2 解码vid内存"></a>3.3.2 解码vid内存</h3><p>关于码流解码过程中视频缓冲buffer u32VidBufSize配置：</p>
<p>创建avplay时，可以指定视频es buf大小，参考如下代码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Ret <span class="token operator">=</span> <span class="token function">HI_UNF_AVPLAY_GetDefaultConfig</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AvplayAttr<span class="token punctuation">,</span> HI_UNF_AVPLAY_STREAM_TYPE_ES<span class="token punctuation">)</span><span class="token punctuation">;</span>
AvplayAttr<span class="token punctuation">.</span>stStreamAttr<span class="token punctuation">.</span>u32VidBufSize <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span>
Ret <span class="token operator">|=</span> <span class="token function">HI_UNF_AVPLAY_Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AvplayAttr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hAvplay<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Es buf的作用存储码流原始es流。</p>
<p>这个buffer的大小跟码流分辨率、码率都有关系，一般情况下，D1/720P/1080P/4K 码流的配置为 2M/3M/5M/16M 即可，特殊码流除外。</p>
<h2 id="3-4-3798模块"><a href="#3-4-3798模块" class="headerlink" title="3.4 3798模块"></a>3.4 3798模块</h2><h3 id="DEMUX："><a href="#DEMUX：" class="headerlink" title="DEMUX："></a>DEMUX：</h3><p>​    数据输入模块。IF，TSI，RAM。</p>
<p>​    NVR使用的是RAM接口输入ES码流。</p>
<h3 id="VI"><a href="#VI" class="headerlink" title="VI:"></a>VI:</h3><p>虚拟VI</p>
<h3 id="VDEC"><a href="#VDEC" class="headerlink" title="VDEC"></a>VDEC</h3><p>​    解码器模块提供一组函数指针，供解码使用。目前有264，mpeg4两个。</p>
<p>视频解码的简单流程是：<br>步骤 1 VDEC 从 Demux 或 ES buffer 获取 ES 数据送 Firmware 进行解码（ Firmware: StreamInput(VDEC-&gt;Firmware)）。<br>步骤 2 Firmware 将解码完的 1D 或者 2D 帧存放在帧 buffer 中。<br>步骤 3 VDEC 从帧 buffer 中获取（ Firmware: Frame Output(Firmware-&gt;VDEC)）视频帧放入其帧队列中。<br>步骤 4 VPSS 在线程中从 VDEC 的帧队列中取帧做解码后处理（ Frame Output(VDEC-&gt;VPSS)）。<br>步骤 5 AVPLAY 向 VDEC 获取视频帧， VDEC 从 VPSS 获取视频帧返回给 AVPLAY。</p>
<h3 id="SYNC："><a href="#SYNC：" class="headerlink" title="SYNC："></a>SYNC：</h3><p>音视频同步工具</p>
<h3 id="DISPLAY：显示设备"><a href="#DISPLAY：显示设备" class="headerlink" title="DISPLAY：显示设备"></a>DISPLAY：显示设备</h3><h3 id="WINDOW：显示通道"><a href="#WINDOW：显示通道" class="headerlink" title="WINDOW：显示通道"></a>WINDOW：显示通道</h3><p>msp 目录下的“ windowXXYY”节点的中的 XX 为显示通道的编号， YY 为 window 序号。比如 window0100， bit[15:8]的 01 表示该 window 基于 DISPLAY1 创建， bit[7:0]的00 表示 window 序号为 0。有支持3D显示</p>
<p>DISP（ Display）模块接收 WINDOW 提供的视频图像、 Frame Buffer 提供的图形画<br>面，进行图像叠加处理和图像色彩调节，并将叠加后图像通过多种视频输出端口输出<br>给显示设备；此外， DISP 支持获取视频输出端口上的包含视频和图形的完整图像。</p>
<p>窗口类型</p>
<ul>
<li> Display：独立显示窗口</li>
<li> Virtual：虚拟窗口</li>
<li> Main：同源显示主窗口</li>
<li>Slave：同源显示从窗口</li>
</ul>
<p><img src="https://images.weserv.nl/?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155307.png" alt="image-20210730155305921"></p>
<p><img src="https://images.weserv.nl/?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155256.png" alt="image-20210730155254877"></p>
<h3 id="SO（-Subtitle-Output）"><a href="#SO（-Subtitle-Output）" class="headerlink" title="SO（ Subtitle Output）"></a>SO（ Subtitle Output）</h3><h3 id="PDM"><a href="#PDM" class="headerlink" title="PDM"></a>PDM</h3><p><img src="https://images.weserv.nl/?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155248.png" alt="image-20210730155247422"></p>
<p>PDM(Product Data Manager)模块用于管理与产品相关的数据，包括基本参数、开机画<br>面参数及数据、瞬播参数及数据的管理</p>
<p><img src="https://images.weserv.nl/?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155410.png" alt="image-20210730155408819"></p>
<p>用户通过镜像制作工具制作基本参数镜像与瞬播镜像，通过烧写工具烧写至 FLASH，PDM 模块在 BOOT 下将基本参数及瞬播数据读入内存，并传递至 KERNEL。 KERNEL下瞬播从 PDM 模块获取参数及数据，调用 DEMUX、 VDEC、 VO 等模块驱动，完成瞬播播放</p>
<p>demux</p>
<p><img src="https://images.weserv.nl/?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155234.png" alt="image-20210730155230706"></p>
<p>DEMUX 模块接收 DEMOD 或内存中的 TS 流，按客户应用程序（下简称 APP）的设<br>置提取出其中的 SEC 数据、 PES 数据、 TS 数据、音频数据和视频数据。 APP 获取<br>SEC 数据、 PES 数据和 TS 数据进行处理。 AVPLAY 获取音频数据进行处理， VDEC 获<br>取视频数据进行处理。</p>
<p><img src="https://images.weserv.nl/?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155217.png" alt="image-20210730155210711"></p>
<p>AVPLAY 主要依赖 ADEC/VDEC/DEMUX 等模块，其向应用或中间件播放器提供基本<br>的播放业务相关接口。</p>
<p><img src="https://images.weserv.nl/?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155202.png" alt="image-20210730155201373"></p>
<h2 id="3-5-3798和NVR模块使用方面区别："><a href="#3-5-3798和NVR模块使用方面区别：" class="headerlink" title="3.5 3798和NVR模块使用方面区别："></a>3.5 3798和NVR模块使用方面区别：</h2><p>3798模块中vpss，sync等模块是其它模块自动创建，自动绑定处理的。这点和NVR系列芯片差别很大，nvr中vi，vpss，vo都需要用户自己绑定，设置属性，而3798中vpss，vo创建，属性设置是在上层模块中自动处理的（少量设置属性上层传递下去）。</p>
<p>​    简单来说，MPP接口只实现了基本的功能接口，没有封装或很少封装。</p>
<p>UNF 应用层实现了很多业务接口，对底层驱动进行了多层封装，并且实现了一些常用的业务。</p>
<h2 id="4-3798代码祥看"><a href="#4-3798代码祥看" class="headerlink" title="4: 3798代码祥看"></a>4: 3798代码祥看</h2><h2 id="4-1-分析方法"><a href="#4-1-分析方法" class="headerlink" title="4.1 分析方法"></a>4.1 分析方法</h2><h3 id="4-1-1：查看代码，静态分析应用层，驱动层实现方法"><a href="#4-1-1：查看代码，静态分析应用层，驱动层实现方法" class="headerlink" title="4.1.1：查看代码，静态分析应用层，驱动层实现方法"></a>4.1.1：查看代码，静态分析应用层，驱动层实现方法</h3><p>​    使用Source insight分析kernel，msp代码。</p>
<h3 id="4-1-2：图示静态分析函数调用关系"><a href="#4-1-2：图示静态分析函数调用关系" class="headerlink" title="4.1.2：图示静态分析函数调用关系"></a>4.1.2：图示静态分析函数调用关系</h3><p>​    使用cflow， tree2dotx，和dot生成函数静态调用图。</p>
<h3 id="4-1-3：图示动态分析函数调用关系：库函数，系统调用，内核调用"><a href="#4-1-3：图示动态分析函数调用关系：库函数，系统调用，内核调用" class="headerlink" title="4.1.3：图示动态分析函数调用关系：库函数，系统调用，内核调用"></a>4.1.3：图示动态分析函数调用关系：库函数，系统调用，内核调用</h3><ul>
<li>​    使用ltrace分析系统库函数</li>
<li>​    strace分析系统调用流程</li>
<li>​    使用Ftrace，valgrind，gprof2dot生成运行时调用图。</li>
<li>​    Perf分析内核空间调用。发现一些依赖库在ubuntu12.04里面不可用。</li>
</ul>
<p>这一步实现了valgrind动态分析，其它的几个工具需要交叉编译，TODO。使用Perf可能需要换更新的linux版本。</p>
<p>其它还有time(大概运行时间)，gconv（覆盖率统计）等分析方式。</p>
<h2 id="4-2-基础模块：hi-media-hi-mmz-hi-common"><a href="#4-2-基础模块：hi-media-hi-mmz-hi-common" class="headerlink" title="4.2 基础模块：hi_media hi_mmz hi_common"></a>4.2 基础模块：hi_media hi_mmz hi_common</h2><p><img src="https://images.weserv.nl/?url=https://raw.githubusercontent.com/appotry/cloudimg/main/data/2021/07/3020210730155123.png" alt="image-20210730155121621"></p>
<p>​    可以从lsmod中很清晰的看出来hi_media hi_mmz hi_common这几个模块的基础地位。hi_media基础模块管理，hi_mmz提供内存管理，hi_common提供proc，log等基础功能，符号导出供其他海思模块使用。</p>
<p>Common</p>
<ul>
<li>COMMON 模块是 SDK 的基础模块，提供的 API 主要供 SDK 的其他模块调用。<br>COMMON 模块现在主要有以下功能：<ul>
<li>系统初始化和去初始化；</li>
<li>版本信息获取；</li>
<li>获取时间戳；</li>
<li>寄存器读写、映射功能；</li>
<li>MMZ 内存使用；</li>
<li>调试信息控制；</li>
<li>Flash 操作。</li>
</ul>
</li>
</ul>
<h3 id="4-2-1-基本通用模块应用层接口common-api"><a href="#4-2-1-基本通用模块应用层接口common-api" class="headerlink" title="4.2.1 基本通用模块应用层接口common/api"></a>4.2.1 基本通用模块应用层接口common/api</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">HiSTBLinuxFS<span class="token operator">/</span>source<span class="token operator">/</span>common<span class="token operator">/</span>api
mpi_mem<span class="token punctuation">.</span>c
MEM_POOL_Init 应用层的内存池，重复利用。
mpi_memmap<span class="token punctuation">.</span>c
映射使用链表区分。管理mmap映射
 
 
mpi_module<span class="token punctuation">.</span>c
HI_MODULE_Init中有打开内存操作，内存统一管理。
模块id，名称注册，相互查找。
 
mpi_stat<span class="token punctuation">.</span>c
线程时间归零，等相关处理
 
hi_common<span class="token punctuation">.</span>c
proc，sys一些路径目录增删提供了用户层接口，mmz内存管理用户层接口
 
mpi_userproc
用户层提供线程 通用proc接口，proc读写是在其它模块内部实现的，函数指针形式
 
 
注：himedia 相关模块是海思自己实现的内核子系统。有自己实现的总线，驱动，设备模型结构体。也是在标准linux模型基础上封装的。
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-2-2-基本通用模块驱动接口common-dev"><a href="#4-2-2-基本通用模块驱动接口common-dev" class="headerlink" title="4.2.2 基本通用模块驱动接口common/dev"></a>4.2.2 基本通用模块驱动接口common/dev</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">HiSTBLinuxFS<span class="token operator">/</span>source<span class="token operator">/</span>common<span class="token operator">/</span>dev
drv_dev_ext_k<span class="token punctuation">.</span>c 重要
HI_DRV_DEV_Init 所有模块宏定义在这里，注册模块结构体在这里
himedia<span class="token punctuation">.</span>c himedia_bash<span class="token punctuation">.</span>c     模块注册，注销基础函数
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DYNAMIC_MINORS</span> <span class="token expression"><span class="token number">128</span> </span><span class="token comment">/* like dynamic majors */</span>            <span class="token expression">himedia主设备号<span class="token number">218</span></span></span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> himedia_minors<span class="token punctuation">[</span>DYNAMIC_MINORS <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tagPM_BASEDEV_S</span><span class="token punctuation">{</span>
    HI_S32        id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> HI_S8    <span class="token operator">*</span> name<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span>    dev<span class="token punctuation">;</span>
<span class="token punctuation">}</span>PM_BASEDEV_S<span class="token punctuation">;</span>
 
<span class="token macro property"><span class="token directive-hash">#</spa