<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Github Pages + jekyll 全面介绍极简搭建个人网站和博客</title>
    <url>/posts/1991789c/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>利用github pages搭建个人博客。本文指导建立github工程，并配置github pages搭建博客的全过程。</p>
<p>注意：图床使用github，图片显示问题自己解决</p>
<h2 id="第一步，建立Github仓库">第一步，建立Github仓库</h2>
<p>首先到这里Github，创建一个仓库。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/03/05/20210305002728.png" alt=""></p>
<p>仓库名称有固定的格式： username.github.io，其中username必须是Github账户的用户名（我的是scottcgi），github.io是固定的，这个地址将会成为个人站点的网站地址。另外，我们可以勾选Initialize this repository with a README，让仓库自动创建一个README.md文件，我们用它来做站点的首页（当然也可以不创建，后面自行创建，或是建立index.html也行）。</p>
<p>注意： username如果不是Github账户名，这个仓库就会成为username.github.io的子站点，比如访问地址会是：username.github.io/aaa.github.io。可见，username.github.io是github默认分配给你的域名，同名仓库即代表着默认网站内容。而username.github.io/仓库名称，是用来访问你的其它仓库的地址。</p>
<h2 id="第二步，设置仓库开启Github-Pages">第二步，设置仓库开启Github Pages</h2>
<p>进入仓库设置界面，如图。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/03/05/20210305002731.png" alt=""></p>
<p>这里能够重新修改仓库的名称，比如这个仓库内容是fork别人的，就可以在这里修改成自己的username.github.io名称。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/03/05/20210305002731.png" alt=""></p>
<p>在Setting页面下有Github Pages的设置选项。绿色表示部署成功，每次修改仓库内容，都会出发Github jekyll重新编译部署，需要1-2分钟的时间，更新才能体现。如果有编译错误，包括js，css，html，markdown语法问题，都会显示红色以及错误页面和行号，同时会发邮件通知。其中，Source有以下几个选项：</p>
<p>gh-pages branch 是项目新建一个分支命名为这个，使用这个分支来做站点内容。<br>
master branch 是使用主分支也是默认的，来作为站点内容。<br>
master branch/docs folder 是使用主分支的docs文件夹来作为站点内容。<br>
None 就是禁用Github Pages。<br>
如果是username.github.io只能使用主分支，其它仓库项目可以选择其它两个。接下来Choose a theme是Github提供的内置的网站主题，选择即可应用无需其它设置。Custom domain是自定义域名，本文暂不讨论。</p>
<h2 id="第三步，使用Github内置主题">第三步，使用Github内置主题</h2>
<p>选择好主题，过一会刷新网站地址就已经能看到效果了，而在Code页面仅有两个文件。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/03/05/20210305002737.png" alt=""></p>
<p>编辑README.md文件的内容，就会默认显示在网站首页，<code>_config.yml</code> 是jekyll的全局配置文件，现在里面只有一句话，<code>theme: jekyll-theme-modernist</code>。我们可以手动修改这个theme主题配置，网站就会应用不同的主题。</p>
<p>Github内置支持的几个主题，官方的仓库在这里：https://pages.github.com/themes，每个README.md里都有介绍如何设置。</p>
<p>那么我们现在就有两种方法来使用这些主题：</p>
<p>第一种，就是直接fork一个主题仓库，然后修改仓库名称为我们自己的，然后修改我们需要的部分。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/03/05/20210305002743.png" alt=""></p>
<p>第二种，只是简单的Choose (Change) theme（或在<code>_config.yml</code>设置theme），然后我们对照着官方仓库的主题目录，需要改什么文件就按照同样的路径拷贝单独一个文件到自己的仓库来修改（保持路径一致），这样就可以保持自己仓库的简洁。（如果使用了github内置的主题，github就会把你仓库的内容和内置主题内容合并到一起编译成静态网页。）</p>
<p>另外，更多主题可以参看这两个地址（不要挑花眼了）： jekyll themes 和 jekyll wiki site。</p>
<h2 id="第四步，jekyll的目录结构">第四步，jekyll的目录结构</h2>
<p>我们只需要关注几个核心的目录结构如下（可以自己创建）：</p>
<pre class="line-numbers language-none"><code class="language-none">- _layouts （存放页面模板，md或html文件的内容会填充模板）
- _sass（存放样式表）
- _includes （可以复用在其它页面被include的html页面）
- _posts（博客文章页面）
- assets（原生的资源文件）
  - js
  - css
  - image
- _config.yml （全局配置文件）
- index.html, index.md, README.md （首页index.html优先级最高，如果没有index，默认启用README.md文件）
- 自定义文件和目录
  更多更详细的目录结构参看jekyll官网：https://jekyllrb.com/docs/structure<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="第五步，jekyll的模板编程语言Liquid的使用">第五步，jekyll的模板编程语言Liquid的使用</h2>
<ul>
<li>
<p>变量  被嵌入在页面中，会在静态页面生成的时候被替换成具体的数值。常用的全局变量对象有：site 和 page。这两个对象有很多默认自带的属性，比如：，。更多的默认值参看：https://jekyllrb.com/docs/variables。</p>
</li>
<li>
<p>site对象对应的就是网站范围，自定义变量放在_config.yml中，比如title:标题使用访问。</p>
</li>
<li>
<p>page对象对应的是单个页面，自定义变量放在每个页面的最开头，比如：</p>
</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">myNum:100
 
myStr:我是字符串<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>使用 和  访问。<br>
条件判断语句，更多详见：https://shopify.github.io/liquid/tags/control-flow</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/0920210709184021.png" alt=""></p>
<p>循环迭代，更多详见：https://shopify.github.io/liquid/tags/iteration</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/0920210709184048.png" alt=""></p>
<p>默认函数，可以对变量进行一些处理，比如大小写转化、数学运算、格式化、排序等等，在Liquid中叫做Filters。比如<code>{{ "Hello World!" | downcase }}</code>转换字符串为小写。更多内置函数详见：https://jekyllrb.com/docs/liquid/filters</p>
<h2 id="第六步，使用-config-yml文件设置jekyll">第六步，使用_config.yml文件设置jekyll</h2>
<p>如果不是fork别人的仓库，就需要自己创建一个这个文件。然后，我们就可以配置一些默认的属性来控制jekyll的编译过程。更多详细的内置属性详见：https://jekyllrb.com/docs/configuration/default</p>
<p>同时我们可以自定变量，会自动绑定到site对象上，比如我们可以把导航配置到_config.yml中：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/0920210709184117.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/0920210709183323.png" alt=""></p>
<p>当然，我们也可以把一些数据单独放入一个yml文件，然后放在固定的数据文件夹_data下，比如<code>_data/navigation.yml</code>，这样访问这个文件的数据对象就是site.data.navigation。</p>
<h2 id="第七步，-layouts模板配置">第七步，_layouts模板配置</h2>
<p>_layouts文件夹存放的是页面模板，默认需要一个default.html，什么意思？就是说，layout提供一个页面的布局框架，这是固定的模式，包括样式、结构、布局、脚本控制等等。然后，我们在用其它md或html文件去动态填充这个框架，这样就形成了一个完整的页面。比如我的default.html页面如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/0920210709183622.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/0920210709183638.png" alt=""></p>
<ul>
<li><code>{% seo %}</code> 是jekyll的一个插件提供的seo优化，详情在这里：https://github.com/jekyll/jekyll-seo-tag</li>
<li>核心在于 content 这个变量是内置的，会用我们的md或html页面填充这部分内容。</li>
<li>其它的，我们看到会大量使用变量和流程控制代码，来填充模板的方方面面。</li>
<li>于是，填充模板的内容，一方面是来自读取配置文件的变量，一方面是来自_includes的页面，还有就是来自 content 对应的页面。<br>
当然，我们也可以不使用 content 来填充模板，而是使用_includes的页面来代替content  ，但这样不够灵活，因为使用content ，我们可以在每个页面单独设置对应的layout模板。</li>
</ul>
<h2 id="第八步，md和html页面编写">第八步，md和html页面编写</h2>
<p>站点内容页面，可以使用markdown或html来编写，但markdown编写的md文件，在浏览器地址访问的时候依然使用html文件后缀。推荐使用markdown来书写内容，语法参见：Github md 示例 和 Github md 教程。比如下面这个About.md页面：</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token front-matter-block"><span class="token punctuation">---</span>
<span class="token front-matter yaml language-yaml">layout: default
title: About</span>
<span class="token punctuation">---</span></span>
<span class="token title important"><span class="token punctuation">#</span> About page</span>
 
This page tells you a little bit about me.
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>layout: default 就是告诉jekyll这个页面使用哪个模板，即这个页面会放入哪个模板的content。当然，我们可以在_layouts文件夹下提供多个不同的模板，然后根据需要不同的页面使用不同的layout。</p>
<p>页面可以放在任意位置和目录，访问的时候从站点域名开始，带上目录名称，再次注意需要使用html结尾。如果想要自定义浏览器的访问路径，可以参看详细设置：permalinks。</p>
<p>md和html页面的区别：</p>
<p>md有自己的语法，可以使用少量的html标签，最终会编译成html，侧重于内容编写。<br>
html可以随意使用html标签，可以使用liquid模板语言，侧重于页面模板和功能控制。<br>
至此，我们就可以在github上，新建md文件然后编辑提交，等待几分钟编译生成之后，就可以在浏览器里看到页面内容了。</p>
<h2 id="第九步，博客文章编写和管理">第九步，博客文章编写和管理</h2>
<p>我们自然可以新建目录，提交文章，然后添加一个文章列表页面。但我们也可以把这些交给jekyll的内置机制来完成，因为它提供了一些方便的内置文章管理功能。</p>
<ul>
<li>_posts文件夹是内置的放置文章的目录，我们可以将固定格式year-moth-day-name.md名称的md文件放到这里。比如新建一篇md的博客文章放到_posts目录下：</li>
</ul>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token front-matter-block"><span class="token punctuation">---</span>
<span class="token front-matter yaml language-yaml">layout: post</span>
<span class="token punctuation">---</span></span>
这是一篇博客文章。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>接下来我们需要添加一个post的模板页面到_layouts文件夹下面。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/0920210709184604.png" alt=""></p>
<p>可见，模板页面本身也可以使用模板，这里post使用了default模板，而这里 content 就会填充_posts下面编写的页面（如果页面使用了layout: post模板）。</p>
<p>最后，我们还需要编写一个博客文章列表的页面，用来展示所有的文章。比如在根目录新建blog.html页面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/0920210709183357.png" alt=""></p>
<ul>
<li>site.posts jekyll会自动生成_posts目录的对象。</li>
<li>_post.url jekyll会自动会设置在_posts目录下的页面url。</li>
<li>post.title 默认是md文件名称，但也可以在文章页面自定义title: 我的文章自定义名称。</li>
<li>post.excerpt 默认是文章第一段的摘要文字。</li>
</ul>
<h2 id="第十步，Github-Pages的限制">第十步，Github Pages的限制</h2>
<ul>
<li>Github Pages 并不是无限存储和无限流量的静态站点服务，一些限制如下：</li>
<li>内容存储不能超过1GB。</li>
<li>每个月100GB流量带宽。</li>
<li>每小时编译构建次数不超过10次。（在线修改重新编译并未发现这个限制）</li>
<li>更多参看官方说明：usage-limits。</li>
</ul>
<h2 id="总结">总结</h2>
<p>在实际的使用过程中，我发现完全可以在Github网站上，编写md和html页面，修改js和css文件，来完成站点的设置和搭建。只不过每次修改都要触发Github jekyll的编译行为，有点慢（不知道是不是增量编译），没有在本地修改调试的速度快。</p>
<p>更多jekyll详细的设置和功能，参看官方网站的文档：https://jekyllrb.com/docs。</p>
<p>原文链接：https://blog.csdn.net/tom_221x/article/details/84630283</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>blog</category>
      </categories>
      <tags>
        <tag>Github</tag>
        <tag>Jekyll</tag>
        <tag>blog</tag>
      </tags>
  </entry>
  <entry>
    <title>Gitlab的安装及使用</title>
    <url>/posts/d08eb7b/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="Gitlab概述">Gitlab概述</h2>
<h3 id="1-1-GitLab介绍">1.1 GitLab介绍</h3>
<p>GitLab是利用Ruby on Rails一个开源的版本管理系统，实现一个自托管的Git项目仓库，可通过Web界面进行访问公开的或者私人项目。</p>
<p>GitLab能够浏览源代码，管理缺陷和注释。可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库。团队成员可以利用内置的简单聊天程序(Wall)进行交流。</p>
<p>它还提供一个代码片段收集功能可以轻松实现代码复用，便于日后有需要的时候进行查找</p>
<h3 id="1-2-Gitlab服务构成">1.2 Gitlab服务构成</h3>
<ul>
<li>
<p>Nginx：静态web服务器。</p>
</li>
<li>
<p>gitlab-shell：用于处理Git命令和修改authorized keys列表。</p>
</li>
<li>
<p>gitlab-workhorse: 轻量级的反向代理服务器。</p>
</li>
<li>
<p>logrotate：日志文件管理工具。</p>
</li>
<li>
<p>postgresql：数据库。</p>
</li>
<li>
<p>redis：缓存数据库。</p>
</li>
<li>
<p>sidekiq：用于在后台执行队列任务（异步执行）。</p>
</li>
<li>
<p>unicorn：An HTTP server for Rack applications，GitLab Rails应用是托管在这个服务器上面的。</p>
</li>
</ul>
<h3 id="1-3-Gitlab工作流程">1.3 Gitlab工作流程</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222044.png" alt=""></p>
<h3 id="1-4-GitLab-Shell">1.4 GitLab Shell</h3>
<p>GitLab Shell有两个作用：为GitLab处理Git命令、修改authorized keys列表</p>
<p>当通过SSH访问GitLab Server时，GitLab Shell会：</p>
<ul>
<li>限制执行预定义好的Git命令（git push，git pull，git annex）</li>
<li>调用GitLab Rails API检查权限</li>
<li>执行pre-receive钩子（在企业版中叫做Git钩子）</li>
<li>执行用户请求的动作，处理GitLab的post-receive动作</li>
<li>处理自定义的post-receive动作</li>
</ul>
<p>当通过http(s)访问GitLab Server时，工作流程取决于你是从Git仓库拉取(pull)代码还是向git仓库推送(push)代码：</p>
<p>如果是从Git仓库拉取(pull)代码，GitLab Rails应用会全权负责处理用户鉴权和执行Git命令的工作</p>
<p>如果是向Git仓库推送(push)代码，GitLab Rails应用既不会进行用户鉴权也不会执行Git命令，它会把以下工作交由GitLab Shell进行处理：</p>
<ul>
<li>调用GitLab Rails API 检查权限</li>
<li>执行pre-receive钩子（在GitLab企业版中叫做Git钩子）</li>
<li>执行你请求的动作</li>
<li>处理GitLab的post-receive动作</li>
<li>处理自定义的post-receive动作</li>
</ul>
<h3 id="1-5-GitLab-Workhorse">1.5 GitLab Workhorse</h3>
<p>GitLab Workhorse是一个敏捷的反向代理。它会处理一些大的HTTP请求，比如文件上传、文件下载、Git push/pull和Git包下载。其它请求会反向代理到GitLab Rails应用，即反向代理给后端的unicorn。</p>
<h2 id="Gitlab的安装部署">Gitlab的安装部署</h2>
<hr>
<ul>
<li>Gitlab要求服务器内存2G以上</li>
</ul>
<h3 id="2-1-方式一-下载gitlab-ce的rpm包">2.1 方式一:下载gitlab-ce的rpm包</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://packages.gitlab.com/gitlab/gitlab-ce">gitlab官方rpm包下载</a></li>
<li><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/">清华的源</a></li>
</ul>
<p>将对应版本的gitlab-ce下载到本地后，直接yum安装即可</p>
<h4 id="要先将这个rpm包下载到本地">要先将这个rpm包下载到本地</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> -y gitlab-ce-13.6.1-ce.0.el7.x86_64.rpm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="2-2-方式二-配置yum源">2.2 方式二:配置yum源</h3>
<p>在 /etc/yum.repos.d/ 下新建 gitlab-ce.repo，写入如下内容：</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token punctuation">[</span>gitlab<span class="token operator">-</span>ce<span class="token punctuation">]</span>
name<span class="token operator">=</span>gitlab<span class="token operator">-</span>ce
baseurl<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>gitlab<span class="token operator">-</span>ce<span class="token operator">/</span>yum<span class="token operator">/</span>el7<span class="token operator">/</span> Repo_gpgcheck<span class="token operator">=</span><span class="token number">0</span>
Enabled<span class="token operator">=</span><span class="token number">1</span> Gpgkey<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>packages<span class="token punctuation">.</span>gitlab<span class="token punctuation">.</span>com<span class="token operator">/</span>gpg<span class="token punctuation">.</span>key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后创建cache，再直接安装gitlab-ce</p>
<p>yum makecache  # 这一步会创建大量的数据</p>
<h4 id="直接安装最新版">直接安装最新版</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> -y gitlab-ce <span class="token comment"># 如果要安装指定的版本，在后面填上版本号即可</span>
yum <span class="token function">install</span> -y  gitlab-ce-13.6.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="如果安装时出现gpgkey验证错误，只需在安装时明确指明不进行gpgkey验证">如果安装时出现gpgkey验证错误，只需在安装时明确指明不进行gpgkey验证</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> gitlab-ce -y --nogpgcheck<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="2-3-gitlab的配置">2.3 gitlab的配置</h3>
<p>配置文件位置  /etc/gitlab/gitlab.rb</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 test<span class="token punctuation">]</span><span class="token comment"># vim /etc/gitlab/gitlab.rb</span>
<span class="token punctuation">[</span>root@centos7 test<span class="token punctuation">]</span><span class="token comment"># grep "^[a-Z]" /etc/gitlab/gitlab.rb</span>
external_url <span class="token string">'http://10.0.0.51'</span>  <span class="token comment"># 这里一定要加上http://</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="配置邮件服务">配置邮件服务</h4>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_enable'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_address'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"smtp.qq.com"</span></span> gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_port'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">25</span> gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_user_name'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"hgzerowzh@qq.com"</span></span>  <span class="token comment"># 自己的qq邮箱账号</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_password'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"xxx"</span></span>  <span class="token comment"># 开通smtp时返回的授权码</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_domain'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"qq.com"</span></span> gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_authentication'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"login"</span></span> gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_enable_starttls_auto'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_tls'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'gitlab_email_from'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"hgzerowzh@qq.com"</span></span>  <span class="token comment"># 指定发送邮件的邮箱地址</span>
user<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"git_user_email"</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"shit@qq.com"</span></span>   <span class="token comment"># 指定接收邮件的邮箱地址</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>修改好配置文件后，要使用 gitlab-ctl reconfigure 命令重载一下配置文件，否则不生效。</strong></p>
<pre class="line-numbers language-none"><code class="language-none">gitlab-ctl reconfigure # 重载配置文件<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="2-4-Gitlab常用命令">2.4 Gitlab常用命令</h3>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">gitlab<span class="token operator">-</span>ctl start         <span class="token comment"># 启动所有 gitlab 组件</span>
gitlab<span class="token operator">-</span>ctl stop          <span class="token comment"># 停止所有 gitlab 组件</span>
gitlab<span class="token operator">-</span>ctl restart       <span class="token comment"># 重启所有 gitlab 组件</span>
gitlab<span class="token operator">-</span>ctl status        <span class="token comment"># 查看服务状态</span>
gitlab<span class="token operator">-</span>ctl reconfigure   <span class="token comment"># 启动服务</span>
gitlab<span class="token operator">-</span>ctl show<span class="token operator">-</span>config   <span class="token comment"># 验证配置文件</span>
gitlab<span class="token operator">-</span>ctl tail          <span class="token comment"># 查看日志</span>
gitlab<span class="token operator">-</span>rake gitlab<span class="token symbol">:check</span> <span class="token constant">SANITIZE</span><span class="token operator">=</span><span class="token boolean">true</span> <span class="token operator">-</span><span class="token operator">-</span>trace    <span class="token comment"># 检查gitlab</span>
vim <span class="token operator">/</span>etc<span class="token operator">/</span>gitlab<span class="token operator">/</span>gitlab<span class="token punctuation">.</span>rb <span class="token comment"># 修改默认的配置文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Gitlab的使用">Gitlab的使用</h2>
<hr>
<ul>
<li>Gitlab安装好后，设置密码，管理账户为root</li>
</ul>
<h3 id="3-1-创建Group"><strong>3.1 创建Group</strong></h3>
<ul>
<li>填上组名即可，这里组名为java</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222105.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211347.png" alt=""></p>
<h3 id="3-2-创建User"><strong>3.2 创建User</strong></h3>
<ul>
<li>创建四个User：pm、dev1、dev2、dev3</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222131.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222120.png" alt=""></p>
<h3 id="3-3-添加User到Group中并授权"><strong>3.3 添加User到Group中并授权</strong></h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222140.png" alt=""></p>
<h3 id="3-4-创建Project并配置SSH"><strong>3.4 创建Project并配置SSH</strong></h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222147.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222154.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222201.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222233.png" alt=""></p>
<h3 id="3-5-在项目中添加成员"><strong>3.5 在项目中添加成员</strong></h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211335.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211726.png" alt=""></p>
<h3 id="3-6-将本地文件推送到Gitlab">3.6 将本地文件推送到Gitlab</h3>
<h4 id="将app01项目克隆下来">将app01项目克隆下来</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone git@10.0.0.51:java/app01.git <span class="token comment"># 初始化配置</span>
<span class="token function">git</span> config --global user.name <span class="token string">"hgzero"</span> <span class="token function">git</span> config --global user.email <span class="token string">"hgzero@qq.com"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="在app01目录下新建一些文件">在app01目录下新建一些文件</h4>
<h4 id="推送到gitlab">推送到gitlab</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit -m <span class="token string">"first edition"</span> <span class="token function">git</span> push origin master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211546.png" alt=""></p>
<ol start="4">
<li>制定开发计划</li>
</ol>
<hr>
<h3 id="4-1-创建开发计划"><strong>4.1 创建开发计划</strong></h3>
<ul>
<li>项目：app01</li>
<li>版本：v1.0</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211325.png" alt=""></p>
<h3 id="4-2-创建里程碑Milestones"><strong>4.2 创建里程碑Milestones</strong></h3>
<ul>
<li>用pm账号登录gitlab后操作（先要在admin中设置pm账号的密码）</li>
<li>要根据开发计划来创建Milestones</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211538.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211719.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211315.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211303.png" alt=""></p>
<h3 id="4-3-根据开发计划创建issue">4.3 根据开发计划创建issue</h3>
<ul>
<li>创建4个issue，分派给dev1和dev2这两个开发人员</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211529.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211304.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211711.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211520.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211514.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211252.png" alt=""></p>
<h3 id="4-4-开发者登录账号查看分派的任务">**4.4 开发者登录账号查看分派的任务 **</h3>
<ul>
<li>然后开发dev1登录gitlab，就能看到任务已经分配过来了</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211513.png" alt=""></p>
<h3 id="4-5-开发流程"><strong>4.5 开发流程</strong></h3>
<ul>
<li>公司里的开发开始任务</li>
</ul>
<h4 id="1-先从仓库把项目拉下来">1. 先从仓库把项目拉下来</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone git@10.0.0.51:java/app01.git
<span class="token builtin class-name">cd</span> app01/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="2-先创建一个自己的分支，然后进行开发">2.先创建一个自己的分支，然后进行开发</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> checkout -b index   <span class="token comment"># 创建一个叫index的分支，并切换到这个分支</span>
<span class="token function">git</span> status <span class="token comment"># 3. 开始开发首页</span>
<span class="token builtin class-name">echo</span> <span class="token string">"&lt;h1&gt;welcome to this app&lt;/h1&gt;"</span> <span class="token operator">&gt;</span> index.html  <span class="token comment"># 假设就开发了一个index页面</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="4-开发完成后，把项目传到仓库">4. 开发完成后，把项目传到仓库</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit -m <span class="token string">"index"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="如果写成-git-commit-m-close-2-，则表示merge请求允许且merge成功之后，自动删除编号为-2的issue">如果写成 git commit -m "close #2" ，则表示merge请求允许且merge成功之后，自动删除编号为#2的issue</h4>
<h4 id="传到index分支">传到index分支</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> push origin index<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-6-合并分支"><strong>4.6 合并分支</strong></h3>
<p><strong>1）开发dev1发送合并分支请求给pm</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211242.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211503.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211701.png" alt=""></p>
<p><strong>2）pm收到开发的Merge请求后进行处理</strong></p>
<ul>
<li>使用pm登录，就可以看到pm已经收到了合并请求merge request</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211231.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211502.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211647.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211221.png" alt=""></p>
<p><strong>3）开发dev1确认任务完成</strong></p>
<ul>
<li>退出pm账户，登入dev1账户：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211220.png" alt=""></p>
<ul>
<li>或者点进去后，在侧边栏进行标识Done，然后已经完成的issue，可以将其Close</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211454.png" alt=""></p>
<ul>
<li>这个时候Milestones的进度已经往前进了一些了：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211446.png" alt=""></p>
<h3 id="4-7-开发其他功能">4.7 开发其他功能</h3>
<ul>
<li>然后其他开发者或者自己再次进行开发时，先要把刚刚更新后的内容（master主干）拉回来，然后再进行开发</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> checkout master  <span class="token comment"># 切换到master</span>
<span class="token function">git</span> pull             <span class="token comment"># 从远端仓库拉取数据</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后再进行其他操作</p>
<h2 id="Gitlab备份恢复">Gitlab备份恢复</h2>
<hr>
<h3 id="5-1-备份gitlab">5.1 备份gitlab</h3>
<p><strong>1）修改配置文件</strong></p>
<ul>
<li><strong>/etc/gitlab/gitlab.rb</strong></li>
</ul>
<h4 id="备份保存的位置，这里是默认位置，可修改成指定的位置">备份保存的位置，这里是默认位置，可修改成指定的位置</h4>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'backup_path'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"/var/opt/gitlab/backups"</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="设置备份保存的时间，超过此时间的日志将会被新覆盖">设置备份保存的时间，超过此时间的日志将会被新覆盖</h4>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'backup_keep_time'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">604800</span>  <span class="token comment"># 这里是默认设置，保存7天</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="特别注意：-如果自定义了备份保存位置，则要修改备份目录的权限，比如：-chown-R-git-git-data-backup-gitlab">特别注意： # 如果自定义了备份保存位置，则要修改备份目录的权限，比如： # chown -R git.git /data/backup/gitlab</h4>
<ul>
<li>配置完成后要重启以使配置生效</li>
</ul>
<h4 id="重读配置文件">重读配置文件</h4>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">gitlab<span class="token operator">-</span>ctl reconfigure <span class="token comment"># 重启gitlab</span>
gitlab<span class="token operator">-</span>ctl restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>2）设置定时任务</strong></p>
<h4 id="每天凌晨2点定时创建备份-将一下内容写入到定时任务中-crontab-e">每天凌晨2点定时创建备份 # 将一下内容写入到定时任务中 crontab -e</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">0</span> <span class="token number">2</span> * * * /usr/bin/gitlab-rake gitlab:backup:create <span class="token comment"># 备份策略建议： # 本地保留3到7天，在异地备份永久保存</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>3）备份时间的识别</strong></p>
<h4 id="备份后的文件类似这样的形式：1494170842-gitlab-backup-tar，可以根据前面的时间戳确认备份生成的时间">备份后的文件类似这样的形式：1494170842_gitlab_backup.tar，可以根据前面的时间戳确认备份生成的时间</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">data -d  @1494170842<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="5-2-恢复gitlab">5.2 恢复gitlab</h3>
<p><strong>1）停止数据写入服务</strong></p>
<h4 id="停止数据写入服务">停止数据写入服务</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitlab-ctl stop unicorn
gitlab-ctl stop sidekiq<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>2）进行数据恢复并重启</strong></p>
<h4 id="进行恢复">进行恢复</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitlab-rake gitlab:backup:restore <span class="token assign-left variable">BACKUP</span><span class="token operator">=</span><span class="token number">1494170842</span>  <span class="token comment"># 这个时间戳就是刚刚备份的文件前面的时间戳</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="重启">重启</h4>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">gitlab<span class="token operator">-</span>ctl restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="gitlab邮件通知配置">gitlab邮件通知配置</h2>
<hr>
<ul>
<li>vim  /etc/gitlab/gitlab.rb</li>
</ul>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'time_zone'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'Asia/Shanghai'</span></span> gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'gitlab_email_enabled'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'gitlab_email_from'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'example@163.com'</span></span> <span class="token comment"># 填写发件人的邮箱地址</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'gitlab_email_display_name'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'gitlab'</span></span> gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_enable'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_address'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"smtp.163.com"</span></span>  <span class="token comment"># smtp服务器的地址,如网易的地址</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_port'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">25</span>                 <span class="token comment"># 要注意如果使用了SSL/TLS的话,端口可能不是25</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_user_name'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"smtp用户名"</span></span> gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_password'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"smtp用户密码"</span></span> gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_domain'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"163.com"</span></span> gitlab_rails<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'smtp_authentication'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"login"</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="7">
<li>
<h2 id="使用SourceTree进行项目开发">使用SourceTree进行项目开发</h2>
</li>
</ol>
<hr>
<h3 id="7-1-项目拉取">7.1 项目拉取</h3>
<ul>
<li>先把项目克隆下来</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211633.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211438.png" alt=""></p>
<ul>
<li>如果ssh的方式克隆失败，可能是因为SSH Key没找到，可以在这里添加</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211211.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211201.png" alt=""></p>
<h3 id="7-2-创建分支进行功能开发">7.2 创建分支进行功能开发</h3>
<p><strong>1）新建立一个叫“pay”的分支</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211618.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211430.png" alt=""></p>
<p><strong>2）进行功能开发</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211152.png" alt=""></p>
<h3 id="7-3-提交项目">7.3 提交项目</h3>
<p><strong>1）开发pay功能完成后进行提交</strong></p>
<ul>
<li>可以看到SourceTree中已经有“未提交的更改”</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211422.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211144.png" alt=""></p>
<p><strong>2）添加“用户信息”</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211143.png" alt=""></p>
<p>** 3）进行提交**</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211415.png" alt=""></p>
<ul>
<li>注释也可以写成  close #3    ，作用是提交完成后关闭3号issue</li>
</ul>
<h3 id="7-4-推送到仓库"><strong>7.4 推送到仓库</strong></h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211136.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211407.png" alt=""></p>
<ul>
<li>然后就可以在gitlab上进行发送merge请求了，后面就可以进行其他操作了</li>
</ul>
<h3 id="7-5-项目上线">7.5 项目上线</h3>
<p><strong>1）当所有工作完成之后，就可以进行上线了</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211135.png" alt=""></p>
<p><strong>2）打标签</strong></p>
<ul>
<li>上线先打个标签</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211127.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913211124.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528225256.png" alt=""></p>
<p>** 3）删除无用分支**</p>
<ul>
<li>然后删除已经合并到主干中的不必要的分支，如index、pay等</li>
<li>最后一定要注意时间一定要同步，不然会错乱</li>
</ul>
<h2 id="参考">参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hgzero/p/14088215.html">Praywu</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>gitlab</category>
      </categories>
      <tags>
        <tag>Gitlab</tag>
        <tag>Git</tag>
        <tag>Crack</tag>
      </tags>
  </entry>
  <entry>
    <title>PT 工具集，Linux硬链接助手</title>
    <url>/posts/bb600b4b/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>由于自我需求，写了两个脚本完成PT下载和保种两全其美的硬链接 Linux shell 脚本方案。</p>
<h1>PTtool</h1>
<p>Github: <a target="_blank" rel="noopener" href="https://github.com/appotry/PTtool">appotry/PTtool</a><br>
Gitee: 镜像 <a target="_blank" rel="noopener" href="https://gitee.com/bloodwolf/PTtool">bloodwolf/PTtool</a></p>
<h2 id="PT工具集合">PT工具集合</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/appotry/PTtool/">硬链接工具</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/appotry/flexget-nexusphp">flexget-nexusphp</a>, Flexget插件，增强对NexusPHP的过滤</li>
<li><a target="_blank" rel="noopener" href="https://github.com/appotry/IYUUAutoReseed">IYUUAutoReseed</a> 自动辅种助手。<strong>PT三剑客</strong></li>
<li><a target="_blank" rel="noopener" href="https://github.com/appotry/PT-Plugin-Plus">PTPP</a> 浏览器辅种助手。<strong>PT三剑客</strong></li>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/r/crazyq/pt_helper">pt_helper</a>, 自动刷流与签到。<strong>PT三剑客</strong></li>
<li><a target="_blank" rel="noopener" href="https://github.com/appotry/universal-torrent-gallery">PT站生成海报墙</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/appotry/easy-upload">一键转种脚本</a></li>
</ul>
<h1>硬链接工具</h1>
<h2 id="设计目的">设计目的</h2>
<p>方便PT用户硬链接文件，在最大可能情况下节约空间，并保持做种。<br>
小于1M的文件直接复制，方便emby，tmm等工具刮削修改nfo等小文件。<br>
大于1M的文件硬链接到目的目录，可以修改文件名，但是不能修改文件内容！</p>
<p>例如：<br>
/share/Download/src #保存下载的PT文件<br>
/share/Download/dst #保存你自己处理过的视频文件，把emby，tmm的目录设置到dst下面<br>
下载脚本后chmod +x mklink.sh给与执行权限<br>
使用mklink脚本修改如下，然后直接运行mklink.sh。就可以把src下面的文件全部硬链接到dst目录。mklink适合一次性把源文件夹链接到目的文件夹</p>
<pre class="line-numbers language-none"><code class="language-none">SRC="/share/Download/src"
DST="/share/Download/dst"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>注意：</p>
<blockquote>
<p>源目录，目的目录需要在一个硬盘分区里面。硬链接不能跨分区。</p>
<p>硬链接过的文件可以使用mv来修改存储目录，不影响硬链接效果。但是cp会增加一份存储空间。所以对于已经硬链接过的文件，使用mv，不要使用cp。</p>
</blockquote>
<h2 id="解决的问题">解决的问题</h2>
<p>tmm，emby刮削的时候，必定修改nfo文件，下载的封面等图片不同刮削站点都不同，所以小文件复制，不怕修改。大文件硬链接，占有一份空间<br>
被硬链接过的文件，同时存在多个地方，但是都指向一个存储空间，只有所有的硬链接都删除了，这个文件才会被系统删除。<br>
同时，所有的硬链接文件，修改其中一个，其它所有指向这个位置的硬链接文件都被修改了。</p>
<h2 id="使用说明">使用说明</h2>
<p>下载资源目录/share/Download，qbittorrent资源分类下载到/share/Download/src/下面的各个子目录，例如tv, anime, tv, movie, 4k, soft等等<br>
创建一个资源整理使用目录/share/Download/dst/目录，然后就可以把/share/Download/src和/share/Download/dst目录作为下面2个脚本的输入目录，来使用了</p>
<p>小文件直接复制，方便tmm刮削修改nfo文件，大文件硬链接，只占有一份空间，但有2分文件，可以改名，移动目录，方便tmm整理刮削。 做种，emby使用两不误！</p>
<h3 id="建议目录结构">建议目录结构</h3>
<pre class="line-numbers language-none"><code class="language-none">/share/Downlosd/src       # BT下载工具默认保存主目录
/share/Download/dst       # 硬链接目的目录，Emby，tmm，使用的目录，保存各种刮削信息。以及个人文件名修改，目录结构修改。
在src目录下面建立子目录movie,music,anime,tv,4k等等，在qbittorrent里面设置分类，
指向这里的movie,music,anime，tv等子目录。下载完后使用下面的硬链接脚本，
把文件硬链接到目的文件夹。tmm，emby使用目的文件夹刮削数据。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="qbittorrent使用设置">qbittorrent使用设置</h4>
<ul>
<li>移动种子保存位置<br>
在qt的web界面种子上面右键，选择菜单保存位置</li>
<li>设置分类目录<br>
在qt的web界面种子上面右键，选择分类-&gt;新分类，先写分类名称和路径。对于多文件种子，种子添加时选择自动管理。对于单文件种子，请自行添加子文件夹，或强制创建子文件夹。</li>
</ul>
<h2 id="mklink-sh">mklink.sh</h2>
<p>修改脚本参数源目录，目的目录,替换为你自己的目录。<br>
脚本将把源目录所有文件硬链接到目的目录，小于1M的文件直接复制到目的目录。方便nfo等小文件刮削修改，大于1M的文件<br>
硬链接到目的目录，以节约空间，2份文件只占有一份空间。</p>
<pre class="line-numbers language-none"><code class="language-none">SRC="/share/Download/tmp/src"
DST="/share/Download/tmp/dst"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>mklink 直接针对2个文件夹做硬链接，小于1m的复制，但是没有判断是否已经硬链接过。适合全新的没有硬链接过的目录。</p>
<h2 id="dirlink-sh">dirlink.sh</h2>
<p>设计原理：针对输入原路径下一级子目录判断是否有文件islinked.lk，<br>
有这个文件就跳过，没有就硬链接这个子目录到目的目录生成对应的子目录。<br>
小于1M的文件复制，大于1M的文件硬链接。</p>
<p>可以直接修改脚本源目录，目的目录参数，也可以从参数$!,$2输入源目录，目的目录。<br>
此脚本和mklink.sh区别在于，将检查每个目录是否已经被硬链接过，已经连接过的将跳过去不再硬链接。<br>
原理是在源文件夹目录下添加文件islinked.lk，通过检测这个文件来判断是否硬链接过</p>
<pre class="line-numbers language-none"><code class="language-none">SRC="/share/Download/tmp/src/movie"
DST="/share/Download/tmp/dst/movie"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>注意：src目录下面的文件需要放到各个子目录下面去，例如src/anime/amine1,src/tv/tv2，这样才能保证islinked.lk工作正常<br>
目录设置可以直接修改脚本，也可以命令行参数输入</p>
<pre class="line-numbers language-none"><code class="language-none">#dirlink.sh sourcedir dstdir
dirlink.sh /share/Download/tmp/src /share/Download/tmp/dst<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="重新建立连接，一次性删除所有islinked-lk文件">重新建立连接，一次性删除所有islinked.lk文件</h3>
<pre class="line-numbers language-none"><code class="language-none">find /share/Download/tmp -name "islinked.lk" | xargs rm -f<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>替换前面的路径/share/Download/tmp为你自己的路径，操作和rm相关的命令一定<strong>注意不要输入错误</strong>，删错文件代价极大！</p>
<h3 id="一次性硬链接多个目录">一次性硬链接多个目录</h3>
<p>如下所示脚本link.sh</p>
<pre class="line-numbers language-none"><code class="language-none">#!/bin/sh
/share/Download/source/dirlink.sh /share/Download/source/anime /share/Download/dst/anime
/share/Download/source/dirlink.sh /share/Download/source/movie /share/Download/dst/movie
/share/Download/source/dirlink.sh /share/Download/source/tv /share/Download/dst/tv<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="修改限制2M大小以下的复制">修改限制2M大小以下的复制</h2>
<p>修改脚本参数FILEGIG，原脚本是1M大小，修改为下面这样就是2M大小</p>
<pre class="line-numbers language-none"><code class="language-none">FILEGIG=2000000c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="autolink-sh">autolink.sh</h2>
<p>qBittorrent 下载完成时自动硬链接下载完的种子，适用于新下载完成的种子文件。以前下载完成的文件建议使用<code>link.sh</code>脚本的方法。<br>
注意：脚本会判断是否进行硬链接的分类，分类详情见脚本内容。</p>
<ul>
<li>修改脚本目标目录<br>
将你的目录填在<code>your_path</code>的等号后。</li>
<li>设置下载完成后自动运行<br>
在qt的web界面g，点击工具-&gt;选项-&gt;下载，勾选“Torrent 完成时运行外部程序”，填入<code>/path/to/autolink.sh "%N" "%D" "%L"</code><br>
注意：填入autolink.sh的绝对位置，同时autolink与dirlink须在同一目录</li>
</ul>
<h2 id="使用声明">使用声明</h2>
<p>数据无价，小心操作。<br>
本脚本（除autolink.sh外）没有rm删除，只有mkdir和cp， 最多搞乱文件系统。但要注意不要把目的地目录设置到系统目录去了。<br>
一切后果自负</p>
<h2 id="感觉对你有帮助，来个star吧">感觉对你有帮助，来个star吧</h2>
<h2 id="Contributing">Contributing</h2>
<ol>
<li>Fork it ( https://github.com/[my-github-username]/PTtool/fork )</li>
<li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li>
<li>Commit your changes (<code>git commit -am 'Add some feature'</code>)</li>
<li>Push to the branch (<code>git push origin my-new-feature</code>)</li>
<li>Create a new Pull Request</li>
</ol>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>hardlink</tag>
        <tag>bt</tag>
        <tag>pt</tag>
      </tags>
  </entry>
  <entry>
    <title>破解Gitlab EE</title>
    <url>/posts/29a820b3/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>由于需要一些镜像等 gitlab 高级功能，所有破解gitlab ee版本。</p>
<h2 id="安装ruby">安装ruby</h2>
<p>安装完gitlab ee之后</p>
<p>安装ruby：yum install ruby</p>
<p>ruby版本需要2.3或以上。</p>
<h2 id="生成许可证"><strong>生成许可证</strong></h2>
<p>gem install gitlab-license</p>
<h2 id="创建一个rb文件">创建一个rb文件</h2>
<p>license.rb</p>
<hr>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">require</span> <span class="token string-literal"><span class="token string">"openssl"</span></span>
<span class="token keyword">require</span> <span class="token string-literal"><span class="token string">"gitlab/license"</span></span>
 
key_pair <span class="token operator">=</span> OpenSSL<span class="token double-colon punctuation">::</span>PKey<span class="token double-colon punctuation">::</span><span class="token constant">RSA</span><span class="token punctuation">.</span>generate<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>
<span class="token builtin">File</span><span class="token punctuation">.</span>open<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"license_key"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"w"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">|</span>f<span class="token operator">|</span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>key_pair<span class="token punctuation">.</span>to_pem<span class="token punctuation">)</span> <span class="token punctuation">}</span>
 
public_key <span class="token operator">=</span> key_pair<span class="token punctuation">.</span>public_key
<span class="token builtin">File</span><span class="token punctuation">.</span>open<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"license_key.pub"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"w"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">|</span>f<span class="token operator">|</span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>public_key<span class="token punctuation">.</span>to_pem<span class="token punctuation">)</span> <span class="token punctuation">}</span>
 
private_key <span class="token operator">=</span> OpenSSL<span class="token double-colon punctuation">::</span>PKey<span class="token double-colon punctuation">::</span><span class="token class-name">RSA</span><span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token builtin">File</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"license_key"</span></span><span class="token punctuation">)</span>
Gitlab<span class="token double-colon punctuation">::</span>License<span class="token punctuation">.</span>encryption_key <span class="token operator">=</span> private_key
 
license <span class="token operator">=</span> Gitlab<span class="token double-colon punctuation">::</span><span class="token class-name">License</span><span class="token punctuation">.</span><span class="token keyword">new</span>
license<span class="token punctuation">.</span>licensee <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-literal"><span class="token string">"Name"</span></span> <span class="token operator">=&gt;</span> <span class="token string-literal"><span class="token string">"none"</span></span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">"Company"</span></span> <span class="token operator">=&gt;</span> <span class="token string-literal"><span class="token string">"none"</span></span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">"Email"</span></span> <span class="token operator">=&gt;</span> <span class="token string-literal"><span class="token string">"example@test.com"</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
license<span class="token punctuation">.</span>starts_at <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 开始时间</span>
license<span class="token punctuation">.</span>expires_at <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2050</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 结束时间</span>
license<span class="token punctuation">.</span>notify_admins_at <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2049</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
license<span class="token punctuation">.</span>notify_users_at <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2049</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
license<span class="token punctuation">.</span>block_changes_at <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2050</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
license<span class="token punctuation">.</span>restrictions <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token symbol">active_user_count</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
 
puts <span class="token string-literal"><span class="token string">"License:"</span></span>
puts license
 
data <span class="token operator">=</span> license<span class="token punctuation">.</span>export
puts <span class="token string-literal"><span class="token string">"Exported license:"</span></span>
puts data
<span class="token builtin">File</span><span class="token punctuation">.</span>open<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"GitLabBV.gitlab-license"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"w"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">|</span>f<span class="token operator">|</span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">}</span>
 
public_key <span class="token operator">=</span> OpenSSL<span class="token double-colon punctuation">::</span>PKey<span class="token double-colon punctuation">::</span><span class="token class-name">RSA</span><span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token builtin">File</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"license_key.pub"</span></span><span class="token punctuation">)</span>
Gitlab<span class="token double-colon punctuation">::</span>License<span class="token punctuation">.</span>encryption_key <span class="token operator">=</span> public_key
 
data <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"GitLabBV.gitlab-license"</span></span><span class="token punctuation">)</span>
<span class="token variable">$license</span> <span class="token operator">=</span> Gitlab<span class="token double-colon punctuation">::</span>License<span class="token punctuation">.</span>import<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
 
puts <span class="token string-literal"><span class="token string">"Imported license:"</span></span>
puts <span class="token variable">$license</span>
 
<span class="token keyword">unless</span> <span class="token variable">$license</span>
  <span class="token keyword">raise</span> <span class="token string-literal"><span class="token string">"The license is invalid."</span></span>
<span class="token keyword">end</span>
 
<span class="token keyword">if</span> <span class="token variable">$license</span><span class="token punctuation">.</span>restricted<span class="token operator">?</span><span class="token punctuation">(</span><span class="token symbol">:active_user_count</span><span class="token punctuation">)</span>
  active_user_count <span class="token operator">=</span> <span class="token number">10000</span>
  <span class="token keyword">if</span> active_user_count <span class="token operator">&gt;</span> <span class="token variable">$license</span><span class="token punctuation">.</span>restrictions<span class="token punctuation">[</span><span class="token symbol">:active_user_count</span><span class="token punctuation">]</span>
    <span class="token keyword">raise</span> <span class="token string-literal"><span class="token string">"The active user count exceeds the allowed amount!"</span></span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
 
<span class="token keyword">if</span> <span class="token variable">$license</span><span class="token punctuation">.</span>notify_admins<span class="token operator">?</span>
  puts <span class="token string-literal"><span class="token string">"The license is due to expire on </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content"><span class="token variable">$license</span><span class="token punctuation">.</span>expires_at</span><span class="token delimiter punctuation">}</span></span><span class="token string">."</span></span>
<span class="token keyword">end</span>
 
<span class="token keyword">if</span> <span class="token variable">$license</span><span class="token punctuation">.</span>notify_users<span class="token operator">?</span>
  puts <span class="token string-literal"><span class="token string">"The license is due to expire on </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content"><span class="token variable">$license</span><span class="token punctuation">.</span>expires_at</span><span class="token delimiter punctuation">}</span></span><span class="token string">."</span></span>
<span class="token keyword">end</span>
 
<span class="token keyword">module</span> <span class="token class-name">Gitlab</span>
  <span class="token keyword">class</span> <span class="token class-name">GitAccess</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">check</span></span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> changes <span class="token operator">=</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token variable">$license</span><span class="token punctuation">.</span>block_changes<span class="token operator">?</span>
        <span class="token keyword">return</span> build_status_object<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"License expired"</span></span><span class="token punctuation">)</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
 
puts <span class="token string-literal"><span class="token string">"This instance of GitLab Enterprise Edition is licensed to:"</span></span>
<span class="token variable">$license</span><span class="token punctuation">.</span>licensee<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>key<span class="token punctuation">,</span> value<span class="token operator">|</span>
  puts <span class="token string-literal"><span class="token string">"</span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">key</span><span class="token delimiter punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">value</span><span class="token delimiter punctuation">}</span></span><span class="token string">"</span></span>
<span class="token keyword">end</span>
 
<span class="token keyword">if</span> <span class="token variable">$license</span><span class="token punctuation">.</span>expired<span class="token operator">?</span>
  puts <span class="token string-literal"><span class="token string">"The license expired on </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content"><span class="token variable">$license</span><span class="token punctuation">.</span>expires_at</span><span class="token delimiter punctuation">}</span></span><span class="token string">"</span></span>
<span class="token keyword">elsif</span> <span class="token variable">$license</span><span class="token punctuation">.</span>will_expire<span class="token operator">?</span>
  puts <span class="token string-literal"><span class="token string">"The license will expire on </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content"><span class="token variable">$license</span><span class="token punctuation">.</span>expires_at</span><span class="token delimiter punctuation">}</span></span><span class="token string">"</span></span>
<span class="token keyword">else</span>
  puts <span class="token string-literal"><span class="token string">"The license will never expire."</span></span>
<span class="token keyword">end</span>
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ruby license.rb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>生成 <code>GitLabBV.gitlab-license</code> <code>license_key</code> <code>license_key.pub</code> 这三个文件。</p>
<h2 id="使用许可证"><strong>使用许可证</strong></h2>
<p>用 <code>license_key.pub</code> 文件替换 <code>/opt/gitlab/embedded/service/gitlab-rails/.license_encryption_key.pub</code>。</p>
<p><code>GitLabBV.gitlab-license</code> 即是许可证，填入 <code>${address}/admin/license</code> 地址并重启 <code>gitlab-ctl restart</code> 。</p>
<h2 id="修改等级"><strong>修改等级</strong></h2>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token operator">/</span>opt<span class="token operator">/</span>gitlab<span class="token operator">/</span>embedded<span class="token operator">/</span>service<span class="token operator">/</span>gitlab<span class="token operator">-</span>rails<span class="token operator">/</span>ee<span class="token operator">/</span>app<span class="token operator">/</span>models<span class="token operator">/</span>license<span class="token punctuation">.</span>rb
<span class="token operator">+</span><span class="token operator">+</span><span class="token operator">+</span> <span class="token operator">/</span>opt<span class="token operator">/</span>gitlab<span class="token operator">/</span>embedded<span class="token operator">/</span>service<span class="token operator">/</span>gitlab<span class="token operator">-</span>rails<span class="token operator">/</span>ee<span class="token operator">/</span>app<span class="token operator">/</span>models<span class="token operator">/</span>license<span class="token punctuation">.</span>rb
@@ <span class="token operator">-</span><span class="token number">458</span><span class="token punctuation">,</span><span class="token number">7</span> <span class="token operator">+</span><span class="token number">458</span><span class="token punctuation">,</span><span class="token number">7</span> @@
  <span class="token keyword">end</span>
 
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">plan</span></span>
<span class="token operator">-</span>    restricted_attr<span class="token punctuation">(</span><span class="token symbol">:plan</span><span class="token punctuation">)</span><span class="token punctuation">.</span>presence <span class="token operator">||</span> <span class="token constant">STARTER_PLAN</span>
<span class="token operator">+</span>    restricted_attr<span class="token punctuation">(</span><span class="token symbol">:plan</span><span class="token punctuation">)</span><span class="token punctuation">.</span>presence <span class="token operator">||</span> <span class="token constant">ULTIMATE_PLAN</span>
  <span class="token keyword">end</span>
 
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">edition</span></span>
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改完成后使用 <code>gitlab-ctl restart</code> 重新加载配置。</p>
<h2 id="参考-2"><strong>参考</strong></h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.rubydoc.info/gems/gitlab-license/1.0.0/file/README.md">https://www.rubydoc.info/gems/gitlab-license/1.0.0/file/README.md</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>gitlab</category>
      </categories>
      <tags>
        <tag>Gitlab</tag>
        <tag>Git</tag>
        <tag>Crack</tag>
      </tags>
  </entry>
  <entry>
    <title>完美笔记进化论</title>
    <url>/posts/a8535f26/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="前言：">前言：</h2>
<p>​    受够了一些网络服务随意被关闭，如google reader等。经过google doc, 有道笔记，为知笔记，手机备忘录，记事本，git，等等方式记录笔记，使用过TXT，work，gitbook，markdown等格式，找到一种接近完美的解决记录笔记的方式。主要采用selfhost，自主搭建服务器，每个组件都可以被取代，大多数都是开源可定制的。<br>
​<br>
​		经历了很长时间，使用了各种各样的方案，最终选择了一种相对完美的方式。docker运行的为知笔记，使用markdown，github作为图床，picgo作为图像上传后端，pypora作为MD编辑器，Snipaste作为截图工具。后备gitlab ee selfhost后，图床也是自我搭建。</p>
<h2 id="笔记进化历史">笔记进化历史</h2>
<h2 id="浏览器书签">浏览器书签</h2>
<p>优点：使用方便，一些实时更新的内容可以直达。</p>
<p>缺点：需要联网，没办法搜索编辑，经常有链接失效。很多有实效的资源，或者可能只能存在一定时间的资源。</p>
<p>由于时效更新的缘故，一直和其它笔记记录方式一起使用。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2720210727143415.png" alt=""></p>
<h2 id="word笔记">word笔记</h2>
<p>优点：富文本支持</p>
<p>缺点：word相对笨重，很多低端平台没有word可用</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2520210725222121.png" alt=""></p>
<h2 id="txt笔记">txt笔记</h2>
<p>优点：多平台，随时随地，格式简单</p>
<p>缺点：富文本支持不好，同步机制只能自己想办法，没有富文本</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2520210725222325.png" alt=""></p>
<h2 id="gitbook">gitbook</h2>
<p>优点：同步机制，修改版本机制</p>
<p>缺点：富文本相对缺乏</p>
<p>单独来说只解决了修改日志问题</p>
<h2 id="markdown">markdown</h2>
<p>优点：富文本</p>
<p>缺点：无修改日志，显示上传不友好</p>
<p>单独来说解决了富文本问题</p>
<h2 id="google-doc">google doc</h2>
<p>优点：在线编辑，富文本支持，修改历史支持，搜索支持。</p>
<p>缺点：文件是google专有格式，数据保存在网上，国内访问需要代/理支持，google还有关闭热度不高网络服务先例。</p>
<h2 id=""><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2520210725221711.png" alt=""></h2>
<h2 id="有道笔记">有道笔记</h2>
<p>优点：对markdown支持非常好</p>
<p>缺点：收费，多平台不够友好，同步问题</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2520210725222556.png" alt=""></p>
<h2 id="手机-备忘录-app">手机''备忘录"app</h2>
<p>优点： 方便，随时随地</p>
<p>缺点：一般只能同型号手机之间同步， 对于多平台同步没有支持，也没有富文本，没有修改历史。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2520210725220932.jpg" alt=""></p>
<h2 id="最终选择方案">最终选择方案</h2>
<h2 id="为知笔记docker版-Typora-Picgo-github-snipaste">为知笔记docker版+Typora+Picgo+github+snipaste</h2>
<blockquote>
<p>最近替换wiznote为Joplin，完全开源免费。Joplin插件异常强大，支持各种Markdown语法。</p>
</blockquote>
<p>wiznote docker版作为笔记管理搜索工具，typora作为markdown编辑器，只使用markdown格式笔记，Picgo作为图上上传工具，github作为图像图床，Snippaste作为截屏工具。一起组成笔记工具链。</p>
<p>怎么样？ 够复杂吧，作者也觉得很复杂，但整体免费，满足selfhost， 富文本，多平台，版本管理，目录管理，可搜索，对图像友好的苛刻要求，超越市面所有产品，wiznote 还可以对外网提供服务。</p>
<p>优点：selfhost， 富文本，多平台，版本管理，目录管理，可搜索，对图像友好。只使用其中部分功能，每个功能都是有其它可替代方案</p>
<p>缺点：配置异常复杂，配置完整难度较高，一些组件还不够成熟，稳定性不够好，存在bug</p>
<h2 id="完整解决方案图示">完整解决方案图示</h2>
<h2 id="wiznote-docker版">wiznote docker版</h2>
<p>数据完整保存在自己搭建的服务器上面，备份转移方便。其实主要是使用wiznote docker版的目录管理，多文档搜索，修改记录功能。可以使用gitlab docker版来代替。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2720210727145645.png" alt=""></p>
<h3 id="教程：-为知笔记私有化Docker部署">教程： <a href="https://blog.17lai.site/note/2021-09-09-deploy-wiznote-docker-on-nas/">为知笔记私有化Docker部署</a></h3>
<h2 id="最近更新-Joplin-docker-Typora-VIM-Picgo-github-snipaste">最近更新 Joplin docker +Typora+VIM + Picgo+github+snipaste</h2>
<blockquote>
<p>选用理由： <strong>从服务器到客户端，到APP完全开源</strong>，支持dropbox，webdav，本地文件系统，docker镜像等同步方式。</p>
</blockquote>
<p>Jopin配合Typora才是最佳搭档, 配置如下</p>
<h2 id="Joplin">Joplin</h2>
<h2 id="Joplin教程：">Joplin教程：</h2>
<blockquote>
<ul>
<li><a href="https://blog.17lai.site/note/2021-09-09-play-with-joplin/">替代Evernote免费开源笔记Joplin-网盘同步笔记历史版本Markdown可视化</a></li>
<li><a href="https://blog.17lai.site/note/2021-09-09-start-to-use-joplin/">Joplin 入门指南&amp;实践方案</a></li>
<li><a href="https://blog.17lai.site/note/2021-09-10-the-joplin-plugin-recommend/">Joplin 插件使用推荐</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/joplin/plugins/blob/master/README.md#plugins">官方插件下载地址</a></li>
</ul>
</blockquote>
<h3 id="中文界面">中文界面</h3>
<p>工具–&gt;选项</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907180949.png" alt=""></p>
<p>点击下方图的按钮来触发Joplin设置的外部编辑器</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907181345.png" alt=""></p>
<h2 id="把-Joplin-用在日常工作中">把 Joplin 用在日常工作中</h2>
<p>此处主要介绍 Joplin 在<strong>终端中的使用</strong>，主要参考了<a target="_blank" rel="noopener" href="https://github.com/laurent22/joplin/blob/master/readme/terminal.md">官方文档</a>。</p>
<h3 id="和-Vim-协作编辑文档">和 Vim 协作编辑文档</h3>
<p>我喜欢 Joplin 终端的设计，它很符合 tmux 和 Vim 的逻辑。</p>
<p>终端 Joplin 由三个横向的 Panel 组成，切换的时候用 <em>tab</em> 和 <em>Shift-Tab</em>。为了使得它更符合 Vim 的风格（Control + 方向键），可以在 <em>~/.config/joplin/keymap.json</em> 中加入以下的设置（完整版见此 gist <a href="https://link.zhihu.com/?target=https%3A//gist.github.com/BaksiLi/3e64647ab590c9ca44d78af3021a4419">keymap.json</a> ）：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">...
        <span class="token punctuation">{</span> <span class="token property">"keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"TAB"</span><span class="token punctuation">,</span><span class="token string">"l"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"function"</span><span class="token punctuation">,</span> <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"focus_next"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"SHIFT_TAB"</span><span class="token punctuation">,</span><span class="token string">"h"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"function"</span><span class="token punctuation">,</span> <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"focus_previous"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"UP"</span><span class="token punctuation">,</span><span class="token string">"k"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"function"</span><span class="token punctuation">,</span> <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"move_up"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"DOWN"</span><span class="token punctuation">,</span><span class="token string">"j"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"function"</span><span class="token punctuation">,</span> <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"move_down"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"PAGE_UP"</span><span class="token punctuation">,</span><span class="token string">"K"</span><span class="token punctuation">,</span><span class="token string">"{"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"function"</span><span class="token punctuation">,</span> <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"page_up"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"PAGE_DOWN"</span><span class="token punctuation">,</span><span class="token string">"J"</span><span class="token punctuation">,</span><span class="token string">"}"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"function"</span><span class="token punctuation">,</span> <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"page_down"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样就变成了 HJKL 风格了。</p>
<p>选择好要编辑的笔记之后，回车就会用默认的终端编辑器打开了。对我来说，必然是 Vim。要注意的是编辑中的语法高亮需要加入 <a target="_blank" rel="noopener" href="https://github.com/plasticboy/vim-markdown">vim-markdown.vim</a>，预览则要 <a target="_blank" rel="noopener" href="https://github.com/iamcco/markdown-preview.nvim">markdown-preview.nvim</a>。</p>
<h3 id="利用-CLI-快速记录">利用 CLI 快速记录</h3>
<p>假设你正在工作环境中（例如 Shell 下、tmux 下或着 Vim 下），不想离开终端，更不想离开现在的窗口，这种情况下 Joplin 的命令行介面就很有帮助了。你可以快速记录、查询一些笔记内容。</p>
<p>我在这里写了一些例子供你参考。</p>
<ul>
<li>创建一个笔记本 = 为项目建立日志存储：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ joplin mkbook <span class="token string">"My-Project"</span>
$ joplin use <span class="token string">"My-Project"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>创建新笔记并以当前时间命名 = 记录当前进度：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ joplin mknote <span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%Y/%m/%d<span class="token variable">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>查看已有的笔记：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ joplin <span class="token function">ls</span> -l<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>完成当前进度：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ joplin todo toggle <span class="token string">"Feature1"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>更多的命令行，你可以通过 <code>joplin help all</code> 查看。</p>
<h2 id="Joplin-插件以及Markdown语法">Joplin 插件以及Markdown语法</h2>
<blockquote>
<p>教程： <a href="https://blog.17lai.site/note/2021-09-09-the-joplin-plugin-and-its-markdown-syntax./">Joplin 插件以及其Markdown语法</a></p>
</blockquote>
<h2 id="Gitlab-docker">Gitlab docker</h2>
<p>和上面的wiznote docker基本一样的使用功能。</p>
<p>除了记录笔记，还可以保存自己的各种代码。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2720210727144447.png" alt=""></p>
<h2 id="Typora">Typora</h2>
<p><a target="_blank" rel="noopener" href="https://www.typora.io/">Typora官方介绍及下载地址</a></p>
<p>编辑器演示</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2520210725223243.png" alt=""></p>
<h3 id="上传图片图示">上传图片图示</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2520210725223249.png" alt=""></p>
<h3 id="后端图像上传工具picgo">后端图像上传工具picgo</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2520210725223403.png" alt=""></p>
<h3 id="一次性上传本MD文件中所有图片">一次性上传本MD文件中所有图片</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2520210725224343.png" alt=""></p>
<h2 id="picgo">picgo</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/PicGo/releases">Picgo官方下载地址</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/PicGo/Awesome-PicGo">官方插件下载地址及其介绍</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2520210725223544.png" alt=""></p>
<h3 id="picgo插件配置">picgo插件配置</h3>
<p>要想picgo用的过得去，一般来说需要插件</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2520210725223646.png" alt=""></p>
<p>picgo使用github作为图床需要github配置，也可以使用sm.ms， gitee。选择github相对来说被随意关闭可能性更低。</p>
<h2 id="Snipaste截图工具">Snipaste截图工具</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2520210725224605.png" alt=""></p>
<p><a target="_blank" rel="noopener" href="https://www.snipaste.com/download.html">Snipaste官方下载地址</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>note</tag>
        <tag>markdown</tag>
        <tag>picgo</tag>
        <tag>wiz</tag>
        <tag>Joplin</tag>
        <tag>Typora</tag>
      </tags>
  </entry>
  <entry>
    <title>qnap硬盘移动位置</title>
    <url>/posts/10fee780/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>qnap硬盘移动位置，改变硬盘位</p>
<h2 id="需求：硬盘位4的硬盘移动到硬盘位3">需求：硬盘位4的硬盘移动到硬盘位3</h2>
<h2 id="步骤1">步骤1</h2>
<p>造作步骤： 存储和快照总管app-&gt;存储/快照-&gt;管理-&gt;操作-&gt;安全卸载磁盘区</p>
<p>如此，硬盘4卸载下来了，如下图</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2520210725213003.png" alt=""></p>
<h2 id="步骤2">步骤2</h2>
<p>再把硬盘4拔下来，插入硬盘位3。等待硬盘被识别到，一般1分钟之内。</p>
<h2 id="步骤3">步骤3</h2>
<p>造作步骤： 存储和快照总管app-&gt;磁盘/VJBOD-&gt;点击磁盘3-&gt;还原-&gt;链接并回复存储池</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/2520210725213820.png" alt=""></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>qnap</category>
      </categories>
      <tags>
        <tag>QNAP</tag>
        <tag>硬盘</tag>
        <tag>nas</tag>
      </tags>
  </entry>
  <entry>
    <title>3G,4G,Wifi选型需求分析及技术简介</title>
    <url>/posts/6b2ba137/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="3G-4G-Wifi选型需求分析及技术简介">3G,4G,Wifi选型需求分析及技术简介</h2>
<ul>
<li>
<p>文章写了好多年了，只在一个网站发布过PDF版本。行业内应该很多人看过这个。</p>
</li>
<li>
<p>关于本blog，<strong>图床</strong>一般使用<strong>github</strong>，已经配置了CDN，如果图片还是未显示请自行代理解决</p>
</li>
<li>
<p><strong>原创声明警告</strong>，文章<strong>禁止转载</strong>，禁止发布到其它任何网站，可以接受约稿。</p>
</li>
</ul>
<h2 id="用户需求分析">用户需求分析</h2>
<p>减少布线，或有的地方很难布线。</p>
<p>​    例如：偏远森林，沙漠，海岛，土地所有制导致不能随便开挖等各种原因。</p>
<h3 id="3G，4G">--3G，4G--</h3>
<p>优点： 布线，距离远。</p>
<p>缺点：流量费高（可以和运营商合作 ）</p>
<h3 id="Wifi">--Wifi--</h3>
<p>优点：费用低，</p>
<p>缺点：距离近</p>
<h2 id="研发需求分析">研发需求分析</h2>
<h2 id="WANTED">WANTED!</h2>
<h3 id="3G，4G选型标准需求">3G，4G选型标准需求</h3>
<p>1：产品生命周期，时间空间的重叠。 初产时间较近，出货时间长，</p>
<p>2：客户那里运营商网络制式？？（例如<strong>TD-LTE****，<strong><strong>FDD-LTE</strong></strong>，<strong><strong>CDMA2000</strong></strong>等等</strong>），</p>
<p>​    运营商名称？？（一般不同国家不一样，一个国家很多个运营商）</p>
<p>3：3G，4G具体型号选择： 1：厂家选择？？？ 2：网络制式选择（需要选择制式尽可能支持区域大的，亚洲，欧美，日韩）？？？ 3：USB 使用的技术代差（1：usb猫，2：usb光驱，3：html拨号）</p>
<p>4：客户3G，4G使用场景？？。流量大小，费用</p>
<p>**注意：**可能客户那里支持的制式和国内不一样，我们这边验证的制式在客户那里不能用，客户那里支持的制式在国内又没法验证。选择制式的时候特别需要注意。</p>
<h3 id="Wifi选择需求">Wifi选择需求</h3>
<p>5：芯片厂家需要支持Linux驱动。 芯片出来年代？？？，价格？？？，协议标准（决定速度），网络信号质量？？？，传输速度（不同距离速度，是否要求穿墙）？？？</p>
<p>6：对应的无线路由器调试</p>
<p>7：客户Wifi使用场景？？。 主要是使用距离引起速度衰变， 现在有2,4G，5G路由，速度有150Mbit/s 300Mbit/s，450Mbit/s。需要ap评估这种速度能否满足各种场景使用需求</p>
<h2 id="3G，4G部分">3G，4G部分</h2>
<h3 id="中国2G，3G，4G制式标准">中国2G，3G，4G制式标准</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730141533.jpg" alt="运营商制式"></p>
<p>UMTS(Universal Mobile Telecommunications System)，意即通用移动通信系统。UMTS是国际标准化组织3GPP制定的全球3G标准之一。作为一个完整的3G移动通信技术标准，UMTS并不仅限于定义空中接口。它的主体包括CDMA接入网络和分组化的核心网络等一系列技术规范和接口协议。除WCDMA作为首选空中接口技术获得不断完善外，UMTS还相继引入了TD-SCDMA和HSDPA技术。<br>
UMTS网络优先选择的就是WCDMA，国内就是中国联通</p>
<h3 id="电信"><strong>电信</strong></h3>
<ul>
<li><strong>2G CDMA</strong></li>
<li><strong>3G CDMA2000</strong></li>
<li><strong>4G TD-LTE</strong>**，**<strong>FDD-LTE</strong></li>
</ul>
<h3 id="移动"><strong>移动</strong></h3>
<ul>
<li><strong>2G GSM</strong></li>
<li><strong>3G TD-SCDMA</strong></li>
<li><strong>4G TD-LTE</strong>**，**<strong>FDD-LTE</strong></li>
</ul>
<h3 id="联通"><strong>联通</strong></h3>
<ul>
<li>
<p><strong>2G GSM</strong></p>
</li>
<li>
<p><strong>3G WCDMA</strong></p>
</li>
<li>
<p><strong>4G TD-LTE</strong>**，**<strong>FDD-LTE</strong></p>
</li>
<li>
<p>中国移动TD-LTE：支持频段38、39、40</p>
</li>
<li>
<p>中国联通TD-LTE：支持频段40、41</p>
</li>
<li>
<p>中国电信TD-LTE：支持频段40、41</p>
</li>
<li>
<p>中国联通FDD-LTE：支持频段3</p>
</li>
<li>
<p>中国电信FDD-LTE：支持频段3</p>
</li>
</ul>
<h3 id="全球制式和区域">全球制式和区域</h3>
<h4 id="2G有GSM，还有CDMA。">2G有GSM，还有CDMA。</h4>
<p>​    我们平时说的G 网或者C 网了。联通和移动都是GSM，电信的133号段（之前是联通主营，后来转移给电信）是C网</p>
<h4 id="3G有3种：WCDMA，CDMA2000，TD-CDMA">3G有3种：WCDMA，CDMA2000，TD_CDMA</h4>
<p>WCDMA（日本、欧洲）、CDMA2000（北美）、TD-SCDMA（中国移动）</p>
<p>使用最广泛的是WCDMA。美国、欧洲等国很多是WCDMA和CDMA2000都有的。<br>
另外WCDMA、CDMA2000里面还有更细的划分，主要是技术、标准、速度的细微差别。</p>
<p>WCDMA（欧洲版）：这个是欧洲的主流，也是目前世界范围3G 的使用模式最广的，在中国大陆，是中国联通3G （沃）的模式。<br>
CDMA2000（美国版）：这个数量相对少些，由美国为代表。在大陆，是中国电信3G （天翼）的模式<br>
TD-SCDMA（中国版）：这个是中国大陆自主知识产权的，可以说是中国特色的3G ，虽然大部分的通讯厂商宣布对此技术可以支持，但世界范围内使用的范围有限。在大陆，是中国移动3G的网络模式。</p>
<h4 id="4G有2种-LTE-FDD，LTE-TDD">4G有2种: LTE FDD，LTE TDD</h4>
<p>LTE FDD（世界绝大多数国家）、LTE TDD（中国移动和国外极少数地区的个别运营商）。</p>
<p>TD- LTE是我国自主研发的4G标准，是由TD-SCDMA（3G网络）发展而来。</p>
<p>LTE FDD是现在国际上主流的，使用最广泛的4G网络，由WCDMA演化而来。</p>
<p>现在全球有超过200个LTE的商用网络，其中超过90%是FDD的。</p>
<p>从技术上说，TD- LTE采用的是时分双工，而LTE FDD采用的是频分双工</p>
<p>TD-LTE和FDD-LTE 是4G的两种国际标准，各有利弊。TD-LTE占用频段少，节省资源，带宽长，适合区域热点覆盖；FDD速度更快，覆盖更广，但占用资源多。适合广域覆盖。</p>
<h4 id="国内三家运营商4G网络制式分别如下：">国内三家运营商4G网络制式分别如下：</h4>
<p>联通4G：TD-LTE、FDD-LTE</p>
<p>电信4G：TD-LTE、FDD-LTE</p>
<p>移动4G：TD-LTE</p>
<p>虽然联通跟电信都是采用双4G网络制式，但目前4G网络仅在部分地区覆盖，3G网络仍然是不可或缺的。而联通3G采用的是WCDMA，为欧洲标准，是技术发展最成熟、国际通用和覆盖范围最广的制式，目前是国内3G网络最快的，最高可达42Mbps，在国外已将其定义为4G标准。</p>
<p>综合以上，选型推荐。</p>
<h2 id="3G推荐选型：WCDMA欧洲，CDMA2000美国">3G推荐选型：WCDMA欧洲，CDMA2000美国</h2>
<h2 id="4G推荐选型：FDD-LTE">4G推荐选型：FDD-LTE</h2>
<h2 id="WIFI部分">WIFI部分</h2>
<h2 id="2-4G和5G究竟是什么">2.4G和5G究竟是什么</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730141643.jpg" alt="">   以往我们一直使用的Wi-Fi大多数是支持 IEEE 802.11n（第四代）无线标准的，而且工作在2.4GHz这个频段上的，所以称之为2.4gWi-Fi，但是严格来说工作在5GHz频段上的不一定就是5G Wi-Fi，因为IEEE 802.11a（第一代）IEEE 802.11n（第四代）和IEEE 802.11ac（第五代)这三种标准都可以工作在5GHz这个频段上。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730141655.jpg" alt="">   严格来说只有支持802.11ac的才是真正5G Wi-Fi（在这个视频里我们将它称作ac 5G)，现来在说支持2.4G和5G双频的路由器其实很多都是指支持第四代无线标准，也就是802.11n的双频，而真正支持ac 5G的路由最便宜都要400、500甚至上千元</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730141748.jpg" alt="">   我们的路由器一般会有标有一些类似54Mbps，150Mbps，300Mbps这样的参数，要说明一下，这个参数不是指路由器的无线覆盖范围，而是指它的最高传输速率。若要支持ac 5G的也要双方同时支持，单方面支持是不行的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730141738.jpg" alt="">   这个速率就相当于车道上的限速标志，当然也不能完全等同与限速标志，因为如果网络中多个设备同时传输要分流的</p>
<p><strong><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730141801.jpg" alt=""></strong></p>
<p>最后不要忘记要考虑空间的大小，200多平米的房子一般普通无线路由器的2.4G勉强可以覆盖，5G的话150平米就开始有压力，如果房屋太大或者多楼层的话可能就要考虑一下多个无线路由桥接了。</p>
<h3 id="5GWifi速度快，穿墙弱">5GWifi速度快，穿墙弱</h3>
<p>5G Wi-Fi的最大缺点就是穿墙能力比较弱，墙体对Wi-Fi信号的强度影响是比较大的，每穿过一面墙，Wi-Fi信号就要减弱不少。</p>
<h3 id="路由器摆放小技巧。增强信号。">路由器摆放小技巧。增强信号。</h3>
<h4 id="最根本一半是有线速度限制，但信号强度也很重要">最根本一半是有线速度限制，但信号强度也很重要</h4>
<p>另外分享一个摆放路由器的方法，如果受制与网线或者台式电脑的位置就没得说，但是如果可以移动的话，这个位置的原则是要经过尽量少的墙体</p>
<p>最好不要放在地上，更不要放在角落，</p>
<h4 id="放在高处">放在高处</h4>
<p>而且应该经适当的放高一点，而不是放在地上，这和手机信号塔的原理是一样的，更加不应该因为他碍眼把它放进抽屉、柜子等里面。这些方法可以略微增强信号强度，不过想从根本上解决信号问题，还是要换一款更好的路由。</p>
<h2 id="无线网卡选购简介">无线网卡选购简介</h2>
<p>常见值得选购的USB无线网卡按技术规格和价位，大致可以分为如下3类：</p>
<p>单频11n网卡，标注速度200-300M，20-30元。</p>
<p>双频11n网卡，支持5g频段，标注速度600M，40-50元。</p>
<p>双频11ac网卡，支持5g频段，标注速度900-1200M或更高，80元以上。</p>
<p>无线网卡要想达到标注的技术标准和速度，首先需要路由器支持该标准及速度，否则会降速运行。</p>
<h3 id="USB协议：速度，选择2-0还是3-0">USB协议：速度，选择2.0还是3.0</h3>
<p>USB2.0的速度传输，理论最大速率480M bit/S。 60MB/S</p>
<p>USB3.0的理论最大速率是5G bit/S，要比USB2.0快10倍！ 640MB/S</p>
<p>看线路，工艺质量，实际速度可能不到理论速度一半</p>
<h3 id="USB3-0-对wifi和BlueTooth干扰。">USB3.0 对wifi和BlueTooth干扰。</h3>
<p>USB3.0的传输频率确实是5GHz串行，但USB3.0使用4条数据线组成2组，每组负责一个传输方向，实现全双工双向5GHz，而每条数据线的基准频率是2.5GHz。</p>
<p>所以，总带宽是5GHz没错，但每条线上是2.5GHz，这个频率距离2.4G Wifi的频率太近了，又因为高频设备大多数都使用了SSC技术（扩频时钟？）使得信号不完全分布在一个固定频率上，所以就波及了2.5GHz附近的其它频率，所以对Wifi和蓝牙产生了较大的干扰。</p>
<h3 id="USB-3-0-干扰-Wifi-2-4G通讯的问题和解决方法">USB 3.0 干扰 Wifi 2.4G通讯的问题和解决方法</h3>
<h4 id="USB3-0-WIFI干扰解决方法">USB3.0 WIFI干扰解决方法</h4>
<p>USB3.0的确对2.4G有影响，不过一样可以解决，比如<strong>网件</strong>的解决方法就是，USB3.0 和网口,天线不在一面，USB3.0接口弄到前面，而且是所有接口有<strong>金属屏蔽罩</strong>（包括WAN和LAN口），连USB接口与主板连线处都用<strong>屏蔽胶布</strong>包裹。可惜国内厂商哪怕是大如华为，网口也舍不得这点成本用金属屏蔽的。</p>
<p>带有USB 3.0接口的无线路由，如果出现外接3.0移动硬盘后网速下降，断网，或者ping延时变得很高，说明出现了3.0对无线的干扰。</p>
<p>USB3.0与无线冲突解决办法：</p>
<p>第一种：给USB接口加金属膜做屏蔽可以适当降低干扰，但不能完全屏蔽</p>
<p>第二种：给主板的USB底座增加统一（并与使用设备）接地和增加金属屏蔽罩，基本可以排除</p>
<p>【推荐】第三种：用1.2米 双磁环带屏蔽层的USB延长线将移动硬盘放到一米外的地方使用，基本可以完全可以排除</p>
<p>其实不单是无线路由，像我们平常使用的无线鼠标键盘、蓝牙、wifi电视、iPad、手机等各种使用民用2.4G的通信设备都会出现与USB3.0冲突的情况。</p>
<h4 id="USB3-0-移动硬盘干扰解决方法">USB3.0 移动硬盘干扰解决方法</h4>
<p>相信随着USB3.0使用的用户越来越多，不少人遇到了一插上USB3.0的硬盘，wifi就出现降速或者中断的问题。其本质原因是USB 3.0 干扰2.4GHz下的Wifi通讯。</p>
<p>解决方法如下，</p>
<p>1.更换无线路由为5GHz，因为USB 3.0对5GHz的Wifi干扰程度较低<br>
2.把硬盘盒从USB3.0接口换到USB2.0接口也可以将问题解决<br>
3.使用高质量带屏蔽的USB3.0设备/线缆/接口。或者在USB3.0接口处加屏蔽罩（金属箔即可）<br>
4.最简单的，使用1m以上的高质量USB3.0延长线。将USB3.0设备远离电脑主机。</p>
<p>Intel官方对USB3.0对WIFI干扰的描述文档：</p>
<p>http://www.usb.org/developers/whitepapers/327216.pdf</p>
<h2 id="目前在调试的两款型号：">目前在调试的两款型号：</h2>
<h3 id="TL-WN823N">TL-WN823N</h3>
<ul>
<li>​         Bus 002 Device 007: ID 0bda:818b</li>
<li>​         RTL8192EU</li>
<li>​         300M迷你型无线USB网卡 TL-WN823N</li>
</ul>
<h3 id="TL-WN725N">TL-WN725N</h3>
<ul>
<li>​         Bus 002 Device 008: ID 0bda:8179</li>
<li>​         rtl8188eu</li>
<li>​         150M无线USB网卡 TL-WN725N</li>
<li>​         网上的驱动版本数据结构和3.10差异较大，不能用</li>
</ul>
<h2 id="Wifi芯片厂家">Wifi芯片厂家</h2>
<h3 id="Realtek：">Realtek：</h3>
<p>​         官方无linux驱动支持</p>
<h3 id="Ralink">Ralink</h3>
<p>（已经被MTK收购）： 官方有linux驱动</p>
<h3 id="Atheros">Atheros</h3>
<p>（已经被高通qualcomm收购）：AR9271</p>
<h2 id="整理推荐芯片型号：">整理推荐芯片型号：</h2>
<p>USB 2.0 Mbit/s</p>
<h3 id="rt3070">rt3070</h3>
<ul>
<li>http://www.mediatek.cn/products/broadbandWifi/rt3070</li>
<li>IEEE 802.11:b/g/n</li>
<li>Wi-Fi Frequency:2.4GHz</li>
<li>Antenna:1T1R</li>
<li>Data Throughput:150Mbit/s</li>
</ul>
<h3 id="rt5370">rt5370</h3>
<ul>
<li>http://www.mediatek.cn/products/broadbandWifi/rt5370</li>
<li>IEEE 802.11:b/g/n</li>
<li>Wi-Fi Frequency:2.4GHz</li>
<li>Antenna:1T1R</li>
<li>Data Throughput:150Mbit/s</li>
</ul>
<h3 id="RT3573">RT3573</h3>
<ul>
<li>http://www.mediatek.cn/products/broadbandWifi/rt3573</li>
<li>IEEE 802.11:b/g/n/ac</li>
<li>Wi-Fi Frequency:2.4GHz, 5GHz</li>
<li>Antenna:3T3R</li>
<li>Data Throughput:450Mbit/s</li>
</ul>
<h3 id="RT5572">RT5572</h3>
<ul>
<li>http://www.mediatek.cn/products/broadbandWifi/rt5572</li>
<li>IEEE 802.11:b/g/n/ac</li>
<li>Wi-Fi Frequency:2.4GHz, 5GHz</li>
<li>Antenna:2T2R</li>
<li>Data Throughput:300Mbit/s</li>
</ul>
<h1>集成分析</h1>
<h2 id="3G，4G集成分析">3G，4G集成分析</h2>
<p>根据拨号技术流程，现在已经发现的USB上网有三种</p>
<ul>
<li>1：默认识别为USB Modem，使用pppoe拨号脚本拨号。</li>
<li>2：默认识别为usb cdrom，使用usb-modeswitch 转换usb设备工作状态，转换为USB Modem后再采用pppoe拨号脚本拨号。</li>
<li>3：使用CGI 调用Html链接方式拨号。不需要我们配置用户名密码，网络制式，最方便。</li>
</ul>
<h3 id="1：Pppoe拨号">1：Pppoe拨号</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pppd call wcdma <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="2：usb-modeswitch转换usb设备工作模式。">2：usb_modeswitch转换usb设备工作模式。</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">usb_modeswitch -W -c /etc/usb_modeswitch.d/19D2:0117<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="3：CGI拨号示例">3：CGI拨号示例</h3>
<p>从集成实现来说，这种最方便。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./curl --header <span class="token string">"Referer: http://192.168.0.1/index.html"</span> http://192.168.0.1/goform/goform_set_cmd_process?goformId<span class="token operator">=</span>SET_CONNECTION_MODE<span class="token operator">&amp;</span><span class="token assign-left variable">ConnectionMode</span><span class="token operator">=</span>auto_dial

./curl --header <span class="token string">"Referer: http://192.168.0.1/index.html"</span> http://192.168.0.1/goform/goform_process?goformId<span class="token operator">=</span>MODE_SWITCH<span class="token operator">&amp;</span><span class="token assign-left variable">switchCmd</span><span class="token operator">=</span>FACTORY<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="Wifi集成分析">Wifi集成分析</h2>
<p>步骤：</p>
<ul>
<li>1：驱动移植识别</li>
<li>2：wireless_tools或者wpa_supplicant拨号</li>
</ul>
<p>wpa_supplicant依赖openssl和libnl，支持PSK加密需要用到这个。wireless_tools只支持普通web加密。</p>
<h1>带宽性能测试</h1>
<p>服务器运行 iperf -s</p>
<p>客户端运行 iperf -c 服务器ip -t 60000 -i 2</p>
<pre class="line-numbers language-none"><code class="language-none">iperf -c 192.168.1.100 -t 60000 -i 2
TP—Link 845<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>笔记本有线连接运行服务端, H3531a（2716TE_C）使用TL-WN823N连接</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@Tvt iperf<span class="token punctuation">]</span><span class="token comment"># ./iperf.hisi3531A -c 192.168.1.100 -t 60000 -i 2</span>
<span class="token punctuation">\</span>------------------------------------------------------------
Client connecting to <span class="token number">192.168</span>.1.100, TCP port <span class="token number">5001</span>
TCP window size: <span class="token number">21.0</span> KByte <span class="token punctuation">(</span>default<span class="token punctuation">)</span>
<span class="token punctuation">\</span>------------------------------------------------------------
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token builtin class-name">local</span> <span class="token number">192.168</span>.1.103 port <span class="token number">47671</span> connected with <span class="token number">192.168</span>.1.100 port <span class="token number">5001</span>
<span class="token punctuation">[</span> ID<span class="token punctuation">]</span> Interval    Transfer   Bandwidth
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">0.0</span>- <span class="token number">2.0</span> sec <span class="token number">2.25</span> MBytes <span class="token number">9.44</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">2.0</span>- <span class="token number">4.0</span> sec  <span class="token number">256</span> KBytes <span class="token number">1.05</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">4.0</span>- <span class="token number">6.0</span> sec  <span class="token number">128</span> KBytes  <span class="token number">524</span> Kbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">6.0</span>- <span class="token number">8.0</span> sec  <span class="token number">256</span> KBytes <span class="token number">1.05</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">8.0</span>-10.0 sec <span class="token number">1.25</span> MBytes <span class="token number">5.24</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">10.0</span>-12.0 sec <span class="token number">3.75</span> MBytes <span class="token number">15.7</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">12.0</span>-14.0 sec <span class="token number">4.25</span> MBytes <span class="token number">17.8</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">14.0</span>-16.0 sec <span class="token number">3.13</span> MBytes <span class="token number">13.1</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">16.0</span>-18.0 sec <span class="token number">1.75</span> MBytes <span class="token number">7.34</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">18.0</span>-20.0 sec <span class="token number">1.38</span> MBytes <span class="token number">5.77</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">20.0</span>-22.0 sec <span class="token number">1.13</span> MBytes <span class="token number">4.72</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">22.0</span>-24.0 sec  <span class="token number">256</span> KBytes <span class="token number">1.05</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">24.0</span>-26.0 sec  <span class="token number">128</span> KBytes  <span class="token number">524</span> Kbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">26.0</span>-28.0 sec  <span class="token number">128</span> KBytes  <span class="token number">524</span> Kbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">28.0</span>-30.0 sec  <span class="token number">512</span> KBytes <span class="token number">2.10</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">30.0</span>-32.0 sec <span class="token number">2.88</span> MBytes <span class="token number">12.1</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">32.0</span>-34.0 sec <span class="token number">1.63</span> MBytes <span class="token number">6.82</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">34.0</span>-36.0 sec <span class="token number">3.50</span> MBytes <span class="token number">14.7</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">36.0</span>-38.0 sec  <span class="token number">768</span> KBytes <span class="token number">3.15</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">38.0</span>-40.0 sec <span class="token number">4.38</span> MBytes <span class="token number">18.4</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">40.0</span>-42.0 sec <span class="token number">5.38</span> MBytes <span class="token number">22.5</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">42.0</span>-44.0 sec <span class="token number">7.13</span> MBytes <span class="token number">29.9</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">44.0</span>-46.0 sec <span class="token number">6.63</span> MBytes <span class="token number">27.8</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">46.0</span>-48.0 sec <span class="token number">5.38</span> MBytes <span class="token number">22.5</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">48.0</span>-50.0 sec <span class="token number">5.75</span> MBytes <span class="token number">24.1</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">50.0</span>-52.0 sec <span class="token number">7.50</span> MBytes <span class="token number">31.5</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">52.0</span>-54.0 sec <span class="token number">4.63</span> MBytes <span class="token number">19.4</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">54.0</span>-56.0 sec <span class="token number">7.50</span> MBytes <span class="token number">31.5</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">56.0</span>-58.0 sec <span class="token number">6.75</span> MBytes <span class="token number">28.3</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">58.0</span>-60.0 sec <span class="token number">5.13</span> MBytes <span class="token number">21.5</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">60.0</span>-62.0 sec <span class="token number">5.38</span> MBytes <span class="token number">22.5</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">62.0</span>-64.0 sec <span class="token number">4.75</span> MBytes <span class="token number">19.9</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">64.0</span>-66.0 sec <span class="token number">6.00</span> MBytes <span class="token number">25.2</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">66.0</span>-68.0 sec <span class="token number">3.50</span> MBytes <span class="token number">14.7</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">68.0</span>-70.0 sec <span class="token number">5.50</span> MBytes <span class="token number">23.1</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">70.0</span>-72.0 sec <span class="token number">4.75</span> MBytes <span class="token number">19.9</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">72.0</span>-74.0 sec <span class="token number">1.50</span> MBytes <span class="token number">6.29</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">74.0</span>-76.0 sec <span class="token number">4.50</span> MBytes <span class="token number">18.9</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">76.0</span>-78.0 sec <span class="token number">4.25</span> MBytes <span class="token number">17.8</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">78.0</span>-80.0 sec <span class="token number">5.13</span> MBytes <span class="token number">21.5</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">80.0</span>-82.0 sec <span class="token number">7.88</span> MBytes <span class="token number">33.0</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">82.0</span>-84.0 sec <span class="token number">7.38</span> MBytes <span class="token number">30.9</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">84.0</span>-86.0 sec <span class="token number">4.38</span> MBytes <span class="token number">18.4</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">86.0</span>-88.0 sec <span class="token number">5.25</span> MBytes <span class="token number">22.0</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">88.0</span>-90.0 sec <span class="token number">6.63</span> MBytes <span class="token number">27.8</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">90.0</span>-92.0 sec <span class="token number">5.00</span> MBytes <span class="token number">21.0</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">92.0</span>-94.0 sec <span class="token number">6.88</span> MBytes <span class="token number">28.8</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">94.0</span>-96.0 sec <span class="token number">8.25</span> MBytes <span class="token number">34.6</span> Mbits/sec
<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token number">96.0</span>-98.0 sec <span class="token number">7.25</span> MBytes <span class="token number">30.4</span> Mbits/sec<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1>附录</h1>
<h2 id="1：TD-LTE和LTE-FDD标准差异">1：TD- LTE和LTE FDD标准差异</h2>
<p>TD- LTE是我国自主研发的4G标准，是由TD-SCDMA（3G网络）发展而来。</p>
<p>LTE FDD是现在国际上主流的，使用最广泛的4G网络。</p>
<p>现在全球有超过200个LTE的商用网络，其中超过90%是FDD的。</p>
<p>从技术上说，TD- LTE采用的是时分双工，而LTE FDD采用的是频分双工</p>
<p>那什么是频分双工，什么又是时分双工呢？</p>
<p>先来解释“双工”。</p>
<p>移动通信系统的工作方式分为：单工、半双工和全双工</p>
<p>1，单工就是信息只能向一个方向传播。例如寻呼机和收音机，只能接收信息，不能发出信息。</p>
<p>2，半双工就是信息可以双向传播，但是上传信息的时候只能上传，下载的时候只能下载。例如对讲机，你说话的时候听不见别人别人说，听别人说的时候自己不能说。</p>
<p>3， 全双工就是信息可以同时双向传播。例如手机，可以边听边说。<br>
其中全双工又分为：时分双工TDD，与频分双工FDD。</p>
<p>​    所谓的频分双工就是将信息上传和信息下载放在两个不同的频段，称为上行频段和下行频段，且这两个频段必须对称。为了不防止上下行频段之间的信息串频，两个频段不能重叠，而且中间必须隔开一段，称为保护频。如下图：上行和下行频段相互分开</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730142158.jpg" alt="保护帧"></p>
<p>所谓的时分双工就是将上传和下载放在同一个频段，也就是上行频段和下行频段完全一样。那它是如何做到上下的信息不串频呢？其实很简单，顾名思义，频分双工分的是频段，那时分双工分的就是时间。将波传播的时间轴一分为二，</p>
<p>前半部分用于信息的上传，后一部分用于信息的下载。其实这从理论上更像是同步的半双工，但是由于上行和下行时间差距极短，我们无法感觉到，所以从效果上也是全双工。如下图：时间帧的第一帧为上行，第二帧而为下行，上下行共用一个频段，用时间的差将他们隔开。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730142220.jpg" alt="数据帧"></p>
<p>​    接下来说一说移动TD- LTE和电信联通LTE FDD的优缺点，其实就是时分双工与频分双工的特点。</p>
<p>​     TD- LTE由于采用上行和下行分时，所以上行和下行的时间差导致他信息传输的速度受到一定的限制。他的理论下载峰值为100Mbps，相比FDD的150Mbps来说，慢了不少。当然TD- LTE的基站信号覆盖半径也比LTE FDD小一点。</p>
<p>​    LTE FDD也并非都是优点。FDD制式必须要找对称分开的上行、下行频段，也就是说它必须浪费更多的频段资源。那中国联通的FDD网为例，工信部给他发的频段牌照为，上行1755<sub>1765MHz和下行1850</sub>1860MHz（2×10M），实际联通只得到了上下各10M的频段，但是加上当中的保护频段，一共占用了1755~1860MHz也就是105MHz的频段。这就导致了频段资源利用率低，是一种资源的浪费。目前，频率资源本身就紧张，能找到对称的上行和下行频段就尤其难。频率除了用在手机上网通讯上，像广播，军事,甚至无线路由器等民用领域也广泛使用。将来随着科技的进步，频率频段的稀缺会日益严重。</p>
<p>​    TD-LTE和FDD-LTE 是4G的两种国际标准，各有利弊。TD-LTE占用频段少，节省资源，带宽长，适合区域热点覆盖；FDD速度更快，覆盖更广，但占用资源多。适合广域覆盖。</p>
<hr>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>embeded</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>embeded</tag>
        <tag>3G</tag>
        <tag>4G</tag>
        <tag>3531a</tag>
        <tag>移植</tag>
        <tag>嵌入式</tag>
      </tags>
  </entry>
  <entry>
    <title>海思MPP&amp;UNF构架源代码级分析</title>
    <url>/posts/13894dce/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><ul>
<li>
<p>文章写了好多年了，只在一个网站发布过PDF版本。行业内应该很多人看过这个。由于早期笔记使用Word格式，转换格式时有不少格式错误，笔者尽量修正。</p>
</li>
<li>
<p>关于本blog，<strong>图床</strong>一般使用<strong>github</strong>，已经配置了CDN，如果图片还是未显示请自行代理解决</p>
</li>
<li>
<p><strong>原创声明警告</strong>，文章<strong>禁止转载</strong>，禁止发布到其它任何网站，可以接受约稿。</p>
</li>
</ul>
<h2 id="前言：-2">前言：</h2>
<p>​    本文通过分析海思文档和代码，把海思SDK的MPI和UNF构架大概实现思想和构架进行了简略的分析。着重分析了内存管理，底层功能如何实现。</p>
<p>​    前面章节简要分析了NVR芯片MPI构架及其内存管理机制，后面着重详细分析了3798M底层模块api和drv实现的细节过程及其方法流程。</p>
<p>​    本文前面简略分析了DVR，MPI构架的大体实现机制。后面就具体分析3798M UNF构架的实现。</p>
<p>本文不光分析了UNF构架，还使用了很多工具，辅助分析代码。这里从三个层面分析了UNF的实现。</p>
<p>1: 应用层，驱动层的实现框架，使用source insight查看代码并着重分析了avplay等几个模块。</p>
<p>2：静态分析函数调用。使用cflow，dot工具生成调用关系图</p>
<p>3：动态追踪运行过程。Ltrace, strace, valgrind分析函数调用，perf动态分析内核调用。</p>
<h2 id="1-Hi35xx系列芯片MPP构架">1:Hi35xx系列芯片MPP构架</h2>
<h2 id="1-1-概述">1.1 概述</h2>
<p>海思提供的媒体处理软件平台(Media Process Platform,简称 MPP)，可支持应用软件快速开发。该平台对应用软件屏蔽了芯片相关的复杂的底层处理，并对应用软件直接提供MPI（MPP Programe Interface）接口完成相应功能。该平台支持应用软件快速开发以下功能：输入视频捕获、H.264/MJPEG/JPEG/MPEG4 编码、H264/H.265/VC1/MPEG4/MPEG2/AVS 解码、视频输出显示、视频图像前处理（包括去噪、增强、锐化、Deinterlace） 、编码码流叠加 OSD、视频侦测分析、智能分析、音频捕获及输出、音频编解码等功能。</p>
<h2 id="1-2-整体软硬件构架">1.2 整体软硬件构架</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730160509.png" alt=""></p>
<p>MPP 平台支持的典型的系统层次如上图所示，主要分为以下层次：</p>
<p><strong>硬件层</strong></p>
<p>硬件层由 Hi35xx 芯片加上必要的外围器件构成。外围器件包括 Flash、DDR<br>
（Double Data-Rate） 、视频 Sensor 或 AD、音频 AD 等。</p>
<p><strong>操作系统层</strong></p>
<p>基于 Linux 3.10.y 的 OS 系统。</p>
<p><strong>媒体处理平台</strong></p>
<p>基于操作系统层，控制芯片完成相应的媒体处理功能。它对应用层屏蔽了硬件处理细节，并为应用层提供 API 接口完成相应功能。</p>
<p><strong>其他驱动</strong></p>
<p>除媒体处理平台外,海思为 Hi35xx 芯片的其他相关硬件处理单元提供了相应的驱动,</p>
<p>包括 GMAC、SDIO、I2C、USB、SSP 等驱动。</p>
<p><strong>应用层</strong></p>
<p>基于海思媒体处理平台及其他驱动，由用户开发的应用软件系统。</p>
<h2 id="1-3-海思媒体处理平台架构">1.3 海思媒体处理平台架构</h2>
<p>海思媒体处理平台的主要内部处理流程如上图所示，主要分为视频输入（VI） 、视频处理（VPSS） 、视频编码（VENC） 、视频解码（VDEC） 、视频输出(VO)、视频侦测分析(VDA)、音频输入(AI)、音频输出(AO)、音频编码（AENC） 、音频解码（ADEC） 、区域管理（REGION）等模块。主要的处理流程介绍如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730160451.png" alt=""></p>
<ul>
<li>
<p>VI 模块捕获视频图像，可对其做剪切、缩放、镜像等处理，并输出多路不同分辨<br>
率的图像数据。</p>
</li>
<li>
<p>解码模块对编码后的视频码流进行解码，并将解析后的图像数据送 VPSS 进行图<br>
像处理或直接送 VO 显示。可对 H.264/H.265/VC1/MPEG4/MPEG2/AVS 格式的视<br>
频码流进行解码。</p>
</li>
<li>
<p>VPSS 模块接收 VI 和解码模块发送过来的图像，可对图像进行去噪、图像增强、<br>
锐化等处理，并实现同源输出多路不同分辨率的图像数据用于编码、预览或抓<br>
拍。</p>
</li>
<li>
<p>编码模块接收 VI 捕获并经 VPSS 处理后输出的图像数据，可叠加用户通过 Region<br>
模块设置的 OSD 图像，然后按不同协议进行编码并输出相应码流。<br>
VDA 模块接收 VI 的输出图像，并进行移动侦测和遮挡侦测，最后输出侦测分析<br>
结果。</p>
</li>
<li>
<p>VO 模块接收 VPSS 处理后的输出图像，可进行播放控制等处理，最后按用户配置<br>
的输出协议输出给外围视频设备。</p>
</li>
<li>
<p>AI 模块捕获音频数据，然后 AENC 模块支持按多种音频协议对其进行编码，最后<br>
输出音频码流。</p>
</li>
<li>
<p>用户从网络或外围存储设备获取的音频码流可直接送给 ADEC 模块，ADEC 支持</p>
</li>
</ul>
<h2 id="1-4-MMZ与模块绑定">1.4 MMZ与模块绑定</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730160438.png" alt=""></p>
<p>MPP 提供系统绑定接口（HI_MPI_SYS_Bind） ，即通过数据接收者绑定数据源来建立</p>
<p>两者之间的关联关系（只允许数据接收者绑定数据源） 。绑定后，数据源生成的数据将</p>
<p>自动发送给接收者。</p>
<p>Uboot环境变量中定义linux内核使用的内存大小</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">setenv <span class="token string">'mem=288M console=ttyAMA0,115200 root=/dev/mtdblock2 rootfstype=jffs2 mtdparts=hi_sfc:768K(boot),2304K(sdr021000),13M(rootfs)'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>加载内核模块分配MMZ内存大小</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">insmod mmz.ko <span class="token assign-left variable">mmz</span><span class="token operator">=</span>anonymous,0,0x8E000000,792M <span class="token assign-left variable">anony</span><span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>例如512M的DDR</p>
<p>DDR:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">DDR:                                                          
-----------<span class="token operator">|</span>----------<span class="token operator">|</span>  0x80000000   <span class="token comment"># Memory managed by OS.             </span>
   64M     <span class="token operator">|</span>   OS     <span class="token operator">|</span>                                                
           <span class="token operator">|</span>          <span class="token operator">|</span>                                                
-----------<span class="token operator">|</span>----------<span class="token operator">|</span>  0x84000000   <span class="token comment"># Memory managed by MMZ block anonymous.         </span>
   448M    <span class="token operator">|</span>    MMZ   <span class="token operator">|</span>                                                
           <span class="token operator">|</span>          <span class="token operator">|</span>                                                
-----------<span class="token operator">|</span>----------<span class="token operator">|</span>  0xA0000000   <span class="token comment"># Memory managed by MMZ block jpeg.                      </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="1-5-HiMPP-支持的绑定关系">1.5 HiMPP 支持的绑定关系</h2>
<table>
<thead>
<tr>
<th>数据源</th>
<th>数据接收者</th>
</tr>
</thead>
<tbody>
<tr>
<td>VI</td>
<td>VO</td>
</tr>
<tr>
<td></td>
<td>VENC</td>
</tr>
<tr>
<td></td>
<td>VDA</td>
</tr>
<tr>
<td></td>
<td>VPSS</td>
</tr>
<tr>
<td></td>
<td>PCIV</td>
</tr>
<tr>
<td>VPSS</td>
<td>VO</td>
</tr>
<tr>
<td></td>
<td>VENC</td>
</tr>
<tr>
<td></td>
<td>VDA</td>
</tr>
<tr>
<td></td>
<td>VPSS</td>
</tr>
<tr>
<td></td>
<td>PCIV</td>
</tr>
<tr>
<td>VDEC</td>
<td>VPSS</td>
</tr>
<tr>
<td></td>
<td>VO（只能是标清设备或 single 模式分割）</td>
</tr>
<tr>
<td></td>
<td>VDA</td>
</tr>
<tr>
<td></td>
<td>PCIV</td>
</tr>
<tr>
<td>vo(WBC)</td>
<td>VO</td>
</tr>
<tr>
<td></td>
<td>VENC</td>
</tr>
<tr>
<td></td>
<td>VPSS</td>
</tr>
<tr>
<td></td>
<td>PCIV</td>
</tr>
<tr>
<td>AI</td>
<td>AENC</td>
</tr>
<tr>
<td></td>
<td>AO</td>
</tr>
<tr>
<td>ADEC</td>
<td>AO</td>
</tr>
</tbody>
</table>
<h2 id="1-6-函数约定说明">1.6 函数约定说明</h2>
<ul>
<li>
<p>Open/Close<br>
Open/Close 操作用来打开、关闭那些可枚举的设备。</p>
</li>
<li>
<p>Create/ Destroy<br>
Create/ Destroy 操作用来创建、销毁那些不可枚举的设备。</p>
</li>
<li>
<p>Handle<br>
Handle 用来标识一个“不可枚举”类型的设备。Handle 只在本进程内有效，也就是说 Handle 不可以跨进程传递Handle 是一个 32bit 的数据，其低 8bit 表示设备的 ID，高 16bit 表示模块 ID。比如0x00110000 表示模块 ID 为 0x11 的第 0 个设备。</p>
</li>
<li>
<p>Attach /Detach<br>
Attach/Detach 用来绑定、解绑定两个设备直接的关联。</p>
</li>
</ul>
<p>Attach 后，目的设备将自动处于 Start/Enable 状态； Detach 后，目的设备将自动处于Stop/Disable 状态。<br>
对于多级绑定，<strong>要求从最后一个设备逐级向前绑定，解绑定的顺序则相反，要求逐级向后。</strong>**<br>
** 当绑定在一起的多个设备可以设置相同属性时，必须通过最后一个设备进行设置。</p>
<ul>
<li>
<p>Get/Put<br>
Get/Put 用来往某个模块输入数据。</p>
</li>
<li>
<p>Acquire/Release<br>
Acquire/Release 用来从某个模块获取数据。</p>
</li>
</ul>
<p>Get/Put和Acquire/Release推荐成对使用</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730155911.png" alt=""></p>
<h2 id="1-7-MPP优缺点">1.7 MPP优缺点</h2>
<h3 id="1-7-1-MPP优点">1.7.1 MPP优点</h3>
<p>​    内存VB管理和模块绑定子系统，proc运行时调试信息是MPP构架节约用户时间最大的设计。</p>
<p>​    大部分外围接口都封装好，用户调用接口直接使用，快速，方便。</p>
<h3 id="1-7-2-MPP缺点">1.7.2 MPP缺点</h3>
<p>​    没有相应子系统的源代码。出了问题，有bug必须需要海思查看，解决。</p>
<p>​    MPI接口和标准linux接口差异非常大，构架也不一样。有问题需要找海思。中间时间成本。</p>
<p>不利于研发技术积累。</p>
<h2 id="2-MPP和UNF对比">2:  MPP和UNF对比</h2>
<p>从函数命名，参数，使用方法来看。UNF和MPP分开比较早，UNF构架在上面函数约定说明基础上的MPI接口封装了一层，UNF-&gt;MPI调用，UNF开发支持更多的模块接口。MPP的模块接口比较固定，比UNF少得多，增强了MMZ内存，VB管理功能，模块绑定功能。</p>
<p>MPP由HI_MPI_SYS_Bind来绑定两个模块，而UNF还是使用Hi_XXX_Attach来绑定两个模块。</p>
<p>MPP内存管理MMZ，VB也比UNF更细致，强大。</p>
<p>UNF支持更多的外设模块。如TUNER（广播电视），CIPHER（芯片内部加密），Subtitle（字幕），PDM（低功耗），SCI（智能卡），GPU等。</p>
<p>UNF开源。在一些模块的实现中，也使用了一些开源项目，如FFmpeg，Alsa，wpa_supplicant等。</p>
<h2 id="3-3798芯片UNF处理构架">3:  3798芯片UNF处理构架</h2>
<h2 id="3-1-应用架构">3.1 应用架构</h2>
<p>海思媒体处理平台（ MSP）实现了对海思高清机顶盒解决方案处理器中媒体、图形以<br>
及外设的屏蔽和封装，对应用软件直接提供 API（ Application Program Interface）接口<br>
完成相应功能。典型的应用架构如下图所示</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730155841.png" alt=""></p>
<p><strong>3798<strong><strong>比35xx</strong></strong>多了一个UNF<strong><strong>层，它在MPI</strong></strong>基础上进行了一层封装</strong></p>
<p>软件架构主要包含以下 4 层：</p>
<ul>
<li>
<p>UNF层</p>
<p>媒体处理平台（ MSP）对外统一的应用开发接口。</p>
</li>
<li>
<p>MPI层</p>
<p>处理器各模块硬件能力实现层的用户态部分。</p>
</li>
<li>
<p>DRV层</p>
<p>处理器各模块硬件能力实现层的内核态部分。</p>
</li>
<li>
<p>HAL层</p>
<p>处理器各模块的硬件抽象层。</p>
</li>
</ul>
<h2 id="3-2-3798SDK-概览（功能介绍）">3.2 3798SDK 概览（功能介绍）</h2>
<p>媒体处理平台（ MSP）中所有模块按照功能可以分为媒体处理，图形处理，外设处理 3<br>
类：</p>
<ul>
<li>
<p>媒体处理</p>
<p>DEMUX、 AVPLAY、 SOUND、 DISPLAY、 VO、 HDMI、 PVR、 VDEC、 VENC、<br>
ADEC、 AENC、 VI、 AI</p>
</li>
<li>
<p>图形处理</p>
<p>HIFB、 HIGO、 TDE、 JPEG、 JPGE、 GPU</p>
</li>
<li>
<p>外设处理</p>
<p>Cipher、 OTP、 PMOC、 Frontend、 I2C、 SCI、 KEYLED、 GPIO、 IR、 WDG、 C51</p>
</li>
</ul>
<h2 id="3-3-3798内存管理">3.3 3798内存管理</h2>
<h3 id="3-3-1-Mmz内存">3.3.1 Mmz内存</h3>
<p>3798的mmz内存在uboot bootargs环境变量中分配，在内核中大块连续内存使用dma_alloc_from_contiguous（drv/mmz/drv_media_mem_v2.c）来分配内存， 小块内存使用kmalloc分配，并且使用内核链表标记管理。和应用层交互使用mamp，umamp，并使用内核链表管理内存。这点和35xx DVR芯片有很大区别，DVR芯片模块内存和linux内核使用内存不再一个地方，应该是通过物理地址往虚拟地址映射来使用的。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># cat /proc/cmdline</span>
<span class="token assign-left variable">mem</span><span class="token operator">=</span>1G <span class="token assign-left variable">console</span><span class="token operator">=</span>ttyAMA0,115200 <span class="token assign-left variable">root</span><span class="token operator">=</span>/dev/romblock3 <span class="token assign-left variable">rootfstype</span><span class="token operator">=</span>squashfs <span class="token assign-left variable">mtdparts</span><span class="token operator">=</span>hinand:5M<span class="token punctuation">(</span>boot<span class="token punctuation">)</span>,1M<span class="token punctuation">(</span>baseparam<span class="token punctuation">)</span>,7M<span class="token punctuation">(</span>kernel<span class="token punctuation">)</span>,18M<span class="token punctuation">(</span>rootfs<span class="token punctuation">)</span>,64M<span class="token punctuation">(</span>appfs<span class="token punctuation">)</span>,16M<span class="token punctuation">(</span>qte<span class="token punctuation">)</span>,4M<span class="token punctuation">(</span>config<span class="token punctuation">)</span>,12M<span class="token punctuation">(</span>log<span class="token punctuation">)</span>,1M<span class="token punctuation">(</span>logo<span class="token punctuation">)</span> <span class="token assign-left variable">mmz</span><span class="token operator">=</span>ddr,0,0,500M<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>具体就是在bootargs中配置mem=1G mmz=ddr,0,0,435M</p>
<p>查看内存使用情况跟监控相同，通过cat /proc/media-mem</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730155600.png" alt=""></p>
<h3 id="3-3-2-解码vid内存">3.3.2 解码vid内存</h3>
<p>关于码流解码过程中视频缓冲buffer u32VidBufSize配置：</p>
<p>创建avplay时，可以指定视频es buf大小，参考如下代码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Ret <span class="token operator">=</span> <span class="token function">HI_UNF_AVPLAY_GetDefaultConfig</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AvplayAttr<span class="token punctuation">,</span> HI_UNF_AVPLAY_STREAM_TYPE_ES<span class="token punctuation">)</span><span class="token punctuation">;</span>
AvplayAttr<span class="token punctuation">.</span>stStreamAttr<span class="token punctuation">.</span>u32VidBufSize <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span>
Ret <span class="token operator">|=</span> <span class="token function">HI_UNF_AVPLAY_Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AvplayAttr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hAvplay<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>Es buf的作用存储码流原始es流。</p>
<p>这个buffer的大小跟码流分辨率、码率都有关系，一般情况下，D1/720P/1080P/4K 码流的配置为 2M/3M/5M/16M 即可，特殊码流除外。</p>
<h2 id="3-4-3798模块">3.4 3798模块</h2>
<h3 id="DEMUX：">DEMUX：</h3>
<p>​	数据输入模块。IF，TSI，RAM。</p>
<p>​	NVR使用的是RAM接口输入ES码流。</p>
<h3 id="VI">VI:</h3>
<p>虚拟VI</p>
<h3 id="VDEC">VDEC</h3>
<p>​	解码器模块提供一组函数指针，供解码使用。目前有264，mpeg4两个。</p>
<p>视频解码的简单流程是：<br>
步骤 1 VDEC 从 Demux 或 ES buffer 获取 ES 数据送 Firmware 进行解码（ Firmware: StreamInput(VDEC-&gt;Firmware)）。<br>
步骤 2 Firmware 将解码完的 1D 或者 2D 帧存放在帧 buffer 中。<br>
步骤 3 VDEC 从帧 buffer 中获取（ Firmware: Frame Output(Firmware-&gt;VDEC)）视频帧放入其帧队列中。<br>
步骤 4 VPSS 在线程中从 VDEC 的帧队列中取帧做解码后处理（ Frame Output(VDEC-&gt;VPSS)）。<br>
步骤 5 AVPLAY 向 VDEC 获取视频帧， VDEC 从 VPSS 获取视频帧返回给 AVPLAY。</p>
<h3 id="SYNC：">SYNC：</h3>
<p>音视频同步工具</p>
<h3 id="DISPLAY：显示设备">DISPLAY：显示设备</h3>
<h3 id="WINDOW：显示通道">WINDOW：显示通道</h3>
<p>msp 目录下的“ windowXXYY”节点的中的 XX 为显示通道的编号， YY 为 window 序号。比如 window0100， bit[15:8]的 01 表示该 window 基于 DISPLAY1 创建， bit[7:0]的00 表示 window 序号为 0。有支持3D显示</p>
<p>DISP（ Display）模块接收 WINDOW 提供的视频图像、 Frame Buffer 提供的图形画<br>
面，进行图像叠加处理和图像色彩调节，并将叠加后图像通过多种视频输出端口输出<br>
给显示设备；此外， DISP 支持获取视频输出端口上的包含视频和图形的完整图像。</p>
<p>窗口类型</p>
<ul>
<li>Display：独立显示窗口</li>
<li>Virtual：虚拟窗口</li>
<li>Main：同源显示主窗口</li>
<li>Slave：同源显示从窗口</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730155307.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730155256.png" alt=""></p>
<h3 id="SO（-Subtitle-Output）">SO（ Subtitle Output）</h3>
<h3 id="PDM">PDM</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730155248.png" alt=""></p>
<p>PDM(Product Data Manager)模块用于管理与产品相关的数据，包括基本参数、开机画<br>
面参数及数据、瞬播参数及数据的管理</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730155410.png" alt=""></p>
<p>用户通过镜像制作工具制作基本参数镜像与瞬播镜像，通过烧写工具烧写至 FLASH，PDM 模块在 BOOT 下将基本参数及瞬播数据读入内存，并传递至 KERNEL。 KERNEL下瞬播从 PDM 模块获取参数及数据，调用 DEMUX、 VDEC、 VO 等模块驱动，完成瞬播播放</p>
<p>demux</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730155234.png" alt=""></p>
<p>DEMUX 模块接收 DEMOD 或内存中的 TS 流，按客户应用程序（下简称 APP）的设<br>
置提取出其中的 SEC 数据、 PES 数据、 TS 数据、音频数据和视频数据。 APP 获取<br>
SEC 数据、 PES 数据和 TS 数据进行处理。 AVPLAY 获取音频数据进行处理， VDEC 获<br>
取视频数据进行处理。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730155217.png" alt=""></p>
<p>AVPLAY 主要依赖 ADEC/VDEC/DEMUX 等模块，其向应用或中间件播放器提供基本<br>
的播放业务相关接口。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730155202.png" alt=""></p>
<h2 id="3-5-3798和NVR模块使用方面区别：">3.5 3798和NVR模块使用方面区别：</h2>
<p>3798模块中vpss，sync等模块是其它模块自动创建，自动绑定处理的。这点和NVR系列芯片差别很大，nvr中vi，vpss，vo都需要用户自己绑定，设置属性，而3798中vpss，vo创建，属性设置是在上层模块中自动处理的（少量设置属性上层传递下去）。</p>
<p>​    简单来说，MPP接口只实现了基本的功能接口，没有封装或很少封装。</p>
<p>UNF 应用层实现了很多业务接口，对底层驱动进行了多层封装，并且实现了一些常用的业务。</p>
<h2 id="4-3798代码祥看">4: 3798代码祥看</h2>
<h2 id="4-1-分析方法">4.1 分析方法</h2>
<h3 id="4-1-1：查看代码，静态分析应用层，驱动层实现方法">4.1.1：查看代码，静态分析应用层，驱动层实现方法</h3>
<p>​    使用Source insight分析kernel，msp代码。</p>
<h3 id="4-1-2：图示静态分析函数调用关系">4.1.2：图示静态分析函数调用关系</h3>
<p>​    使用cflow， tree2dotx，和dot生成函数静态调用图。</p>
<h3 id="4-1-3：图示动态分析函数调用关系：库函数，系统调用，内核调用">4.1.3：图示动态分析函数调用关系：库函数，系统调用，内核调用</h3>
<ul>
<li>​    使用ltrace分析系统库函数</li>
<li>​    strace分析系统调用流程</li>
<li>​    使用Ftrace，valgrind，gprof2dot生成运行时调用图。</li>
<li>​    Perf分析内核空间调用。发现一些依赖库在ubuntu12.04里面不可用。</li>
</ul>
<p>这一步实现了valgrind动态分析，其它的几个工具需要交叉编译，TODO。使用Perf可能需要换更新的linux版本。</p>
<p>其它还有time(大概运行时间)，gconv（覆盖率统计）等分析方式。</p>
<h2 id="4-2-基础模块：hi-media-hi-mmz-hi-common">4.2 基础模块：hi_media hi_mmz hi_common</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730155123.png" alt=""></p>
<p>​    可以从lsmod中很清晰的看出来hi_media hi_mmz hi_common这几个模块的基础地位。hi_media基础模块管理，hi_mmz提供内存管理，hi_common提供proc，log等基础功能，符号导出供其他海思模块使用。</p>
<p>Common</p>
<ul>
<li>COMMON 模块是 SDK 的基础模块，提供的 API 主要供 SDK 的其他模块调用。<br>
COMMON 模块现在主要有以下功能：
<ul>
<li>系统初始化和去初始化；</li>
<li>版本信息获取；</li>
<li>获取时间戳；</li>
<li>寄存器读写、映射功能；</li>
<li>MMZ 内存使用；</li>
<li>调试信息控制；</li>
<li>Flash 操作。</li>
</ul>
</li>
</ul>
<h3 id="4-2-1-基本通用模块应用层接口common-api">4.2.1 基本通用模块应用层接口common/api</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">HiSTBLinuxFS<span class="token operator">/</span>source<span class="token operator">/</span>common<span class="token operator">/</span>api
mpi_mem<span class="token punctuation">.</span>c
MEM_POOL_Init 应用层的内存池，重复利用。
mpi_memmap<span class="token punctuation">.</span>c
映射使用链表区分。管理mmap映射
 
 
mpi_module<span class="token punctuation">.</span>c
HI_MODULE_Init中有打开内存操作，内存统一管理。
模块id，名称注册，相互查找。
 
mpi_stat<span class="token punctuation">.</span>c
线程时间归零，等相关处理
 
hi_common<span class="token punctuation">.</span>c
proc，sys一些路径目录增删提供了用户层接口，mmz内存管理用户层接口
 
mpi_userproc
用户层提供线程 通用proc接口，proc读写是在其它模块内部实现的，函数指针形式
 
 
注：himedia 相关模块是海思自己实现的内核子系统。有自己实现的总线，驱动，设备模型结构体。也是在标准linux模型基础上封装的。
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-2-2-基本通用模块驱动接口common-dev">4.2.2 基本通用模块驱动接口common/dev</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">HiSTBLinuxFS<span class="token operator">/</span>source<span class="token operator">/</span>common<span class="token operator">/</span>dev
drv_dev_ext_k<span class="token punctuation">.</span>c 重要
HI_DRV_DEV_Init 所有模块宏定义在这里，注册模块结构体在这里
himedia<span class="token punctuation">.</span>c himedia_bash<span class="token punctuation">.</span>c     模块注册，注销基础函数
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DYNAMIC_MINORS</span> <span class="token expression"><span class="token number">128</span> </span><span class="token comment">/* like dynamic majors */</span>            <span class="token expression">himedia主设备号<span class="token number">218</span></span></span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> himedia_minors<span class="token punctuation">[</span>DYNAMIC_MINORS <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tagPM_BASEDEV_S</span><span class="token punctuation">{</span>
    HI_S32        id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> HI_S8    <span class="token operator">*</span> name<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span>    dev<span class="token punctuation">;</span>
<span class="token punctuation">}</span>PM_BASEDEV_S<span class="token punctuation">;</span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">TO_PM_BASEDEV</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token function">container_of</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> PM_BASEDEV_S<span class="token punctuation">,</span> dev<span class="token punctuation">)</span></span></span>
 
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tagPM_BASEOPS_S</span> <span class="token punctuation">{</span>
    <span class="token function">HI_S32</span>  <span class="token punctuation">(</span><span class="token operator">*</span>probe<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HI_S32</span>  <span class="token punctuation">(</span><span class="token operator">*</span>remove<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HI_VOID</span> <span class="token punctuation">(</span><span class="token operator">*</span>shutdown<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HI_S32</span>  <span class="token punctuation">(</span><span class="token operator">*</span>prepare<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HI_VOID</span> <span class="token punctuation">(</span><span class="token operator">*</span>complete<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HI_S32</span>  <span class="token punctuation">(</span><span class="token operator">*</span>suspend<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">pm_message_t</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HI_S32</span>  <span class="token punctuation">(</span><span class="token operator">*</span>suspend_late<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">pm_message_t</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HI_S32</span>  <span class="token punctuation">(</span><span class="token operator">*</span>resume_early<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HI_S32</span>  <span class="token punctuation">(</span><span class="token operator">*</span>resume<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>PM_BASEOPS_S<span class="token punctuation">;</span>
 
 
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tagPM_BASEDRV_S</span> <span class="token punctuation">{</span>
    <span class="token function">HI_S32</span>  <span class="token punctuation">(</span><span class="token operator">*</span>probe<span class="token punctuation">)</span> <span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HI_S32</span>  <span class="token punctuation">(</span><span class="token operator">*</span>remove<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HI_VOID</span> <span class="token punctuation">(</span><span class="token operator">*</span>shutdown<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HI_S32</span>  <span class="token punctuation">(</span><span class="token operator">*</span>suspend<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">pm_message_t</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HI_S32</span>  <span class="token punctuation">(</span><span class="token operator">*</span>suspend_late<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">pm_message_t</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HI_S32</span>  <span class="token punctuation">(</span><span class="token operator">*</span>resume_early<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HI_S32</span>  <span class="token punctuation">(</span><span class="token operator">*</span>resume<span class="token punctuation">)</span><span class="token punctuation">(</span>PM_BASEDEV_S <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> driver<span class="token punctuation">;</span>
<span class="token punctuation">}</span>PM_BASEDRV_S<span class="token punctuation">;</span>
 
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tagPM_DEVICE_S</span>  <span class="token punctuation">{</span>
    HI_S32 minor<span class="token punctuation">;</span>
    <span class="token keyword">const</span> HI_S8 <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>app_ops<span class="token punctuation">;</span>
    PM_BASEOPS_S <span class="token operator">*</span>base_ops<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>app_device<span class="token punctuation">;</span>
    PM_BASEDEV_S <span class="token operator">*</span>base_device<span class="token punctuation">;</span>
    PM_BASEDRV_S <span class="token operator">*</span>base_driver<span class="token punctuation">;</span>
<span class="token punctuation">}</span>PM_DEVICE_S<span class="token punctuation">;</span>
 
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>himedia_class<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> himedia_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>owner        <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open        <span class="token operator">=</span> himedia_open<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="设备模型结构体">设备模型结构体</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">himedia_devobj</span> <span class="token punctuation">{</span>
    PM_BASEDEV_S pdev<span class="token punctuation">;</span>
    <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tagPM_BASEDEV_S</span><span class="token punctuation">{</span>
    HI_S32        id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> HI_S8    <span class="token operator">*</span> name<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span>    dev<span class="token punctuation">;</span>
<span class="token punctuation">}</span>PM_BASEDEV_S<span class="token punctuation">;</span>
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="海思模块顶层总线himedia-bus">海思模块顶层总线himedia_bus</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">device</span> himedia_bus <span class="token operator">=</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span>init_name        <span class="token operator">=</span> <span class="token string">"himediaBusDev"</span><span class="token punctuation">,</span>
         <span class="token punctuation">.</span>release    <span class="token operator">=</span> himedia_bus_release
<span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment">/*top level bus, parent and bus member are both NULL*/</span><span class="token comment">/*CNcomment:这是顶层总线，parent 和 bus 成员为 NULL*/</span>
<span class="token keyword">struct</span> <span class="token class-name">bus_type</span> himedia_bus_type <span class="token operator">=</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span>name                <span class="token operator">=</span> <span class="token string">"himediaBus"</span><span class="token punctuation">,</span>
         <span class="token punctuation">.</span>dev_attrs        <span class="token operator">=</span> himedia_dev_attrs<span class="token punctuation">,</span>
         <span class="token punctuation">.</span>match               <span class="token operator">=</span> himedia_match<span class="token punctuation">,</span>
         <span class="token punctuation">.</span>uevent              <span class="token operator">=</span> himedia_uevent<span class="token punctuation">,</span>
         <span class="token punctuation">.</span>pm                     <span class="token operator">=</span> HIMEDIA_PM_OPS_PTR<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
定义HIMEDIA_PM_OPS_PTR
                            <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">dev_pm_ops</span> himedia_dev_pm_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
                                     <span class="token punctuation">.</span>prepare        <span class="token operator">=</span> himedia_pm_prepare<span class="token punctuation">,</span>
                                     <span class="token punctuation">.</span>complete       <span class="token operator">=</span> himedia_pm_complete<span class="token punctuation">,</span>
                                     <span class="token punctuation">.</span>suspend        <span class="token operator">=</span> himedia_pm_suspend<span class="token punctuation">,</span>
                                     <span class="token punctuation">.</span>resume         <span class="token operator">=</span> himedia_pm_resume<span class="token punctuation">,</span>
                                     <span class="token punctuation">.</span>freeze         <span class="token operator">=</span> himedia_pm_freeze<span class="token punctuation">,</span>
                                     <span class="token punctuation">.</span>thaw           <span class="token operator">=</span> himedia_pm_thaw<span class="token punctuation">,</span>
                                     <span class="token punctuation">.</span>poweroff       <span class="token operator">=</span> himedia_pm_poweroff<span class="token punctuation">,</span>
                                     <span class="token punctuation">.</span>restore        <span class="token operator">=</span> himedia_pm_restore<span class="token punctuation">,</span>
                                     <span class="token punctuation">.</span>suspend_noirq  <span class="token operator">=</span> himedia_pm_suspend_noirq<span class="token punctuation">,</span>
                                     <span class="token punctuation">.</span>resume_noirq   <span class="token operator">=</span> himedia_pm_resume_noirq<span class="token punctuation">,</span>
                                     <span class="token punctuation">.</span>freeze_noirq   <span class="token operator">=</span> himedia_pm_freeze_noirq<span class="token punctuation">,</span>
                                     <span class="token punctuation">.</span>thaw_noirq     <span class="token operator">=</span> himedia_pm_thaw_noirq<span class="token punctuation">,</span>
                                     <span class="token punctuation">.</span>poweroff_noirq <span class="token operator">=</span> himedia_pm_poweroff_noirq<span class="token punctuation">,</span>
                                     <span class="token punctuation">.</span>restore_noirq  <span class="token operator">=</span> himedia_pm_restore_noirq<span class="token punctuation">,</span>
                            <span class="token punctuation">}</span><span class="token punctuation">;</span>
                            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HIMEDIA_PM_OPS_PTR</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token operator">&amp;</span>himedia_dev_pm_ops<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730154854.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730154845.png" alt=""></p>
<h3 id="内核到用户往用户空间写文件调试">内核到用户往用户空间写文件调试</h3>
<p>drv_file_ext.c 提供内核空间创建，读写用户空间文件函数，/mnt文件存储路径。提供了内核数据导出到用户空间的方法。</p>
<p>应该是echo * &gt; /proc/msp/** 这种调试方式的实现方式</p>
<h3 id="内核log日志">内核log日志</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">drv_log_ioctl<span class="token punctuation">.</span>h  打印日志相关。  这里日志位置可选<span class="token number">0</span><span class="token operator">:</span>串口 <span class="token number">1</span><span class="token operator">:</span>网络 <span class="token number">2</span><span class="token operator">:</span>U盘
<span class="token comment">/*structure of mode log level */</span>
<span class="token comment">/*CNcomment: 模块打印级别控制信息结构 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">hiLOG_CONFIG_INFO_S</span>
<span class="token punctuation">{</span>
    HI_U8 ModName<span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">+</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">/*mode name 16 + '_' 1 + pid 10 */</span>
    HI_U8 u8LogLevel<span class="token punctuation">;</span>         <span class="token comment">/*log level*/</span><span class="token comment">/*CNcomment:  模块打印级别控制 */</span>
    HI_U8 u8LogPrintPos<span class="token punctuation">;</span>      <span class="token comment">/*log output location, 0:serial port; 1:network;2:u-disk*/</span><span class="token comment">/*CNcomment:  模块打印位置控制 0:串口 1:网络 2:U盘 */</span>
    HI_U8 u8UdiskFlag<span class="token punctuation">;</span>        <span class="token comment">/* u-disk log flag */</span>
<span class="token punctuation">}</span>LOG_CONFIG_INFO_S<span class="token punctuation">;</span>
 
 
hi_debug<span class="token punctuation">.</span>h    log调试级别
<span class="token comment">/**Default level of the output debugging information*/</span>
<span class="token comment">/**CNcomment: 默认的调试信息输出级别*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HI_LOG_LEVEL_DEFAULT</span> <span class="token expression">HI_LOG_LEVEL_ERROR</span></span>
 
<span class="token comment">/**Level of the output debugging information*/</span>
<span class="token comment">/**CNcomment: 调试信息输出级别*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token class-name">hiLOG_LEVEL_E</span>
<span class="token punctuation">{</span>
    HI_LOG_LEVEL_FATAL   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>     <span class="token comment">/**&lt;Fatal error. It indicates that a critical problem occurs in the system. Therefore, you must pay attention to it.*/</span>
                                  <span class="token comment">/**&lt;CNcomment: 致命错误, 此类错误需要特别关注，一般出现此类错误代表系统出现了重大问题 */</span>
    HI_LOG_LEVEL_ERROR   <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>     <span class="token comment">/**&lt;Major error. It indicates that a major problem occurs in the system and the system cannot run.*/</span>
                                  <span class="token comment">/**&lt;CNcomment: 一般错误, 一般出现此类错误代表系统出现了比较大的问题，不能再正常运行 */</span>
    HI_LOG_LEVEL_WARNING <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>     <span class="token comment">/**&lt;Warning. It indicates that a minor problem occurs in the system, but the system still can run properly.*/</span>
                                  <span class="token comment">/**&lt;CNcomment: 告警信息, 一般出现此类信息代表系统可能出现问题，但是还能继续运行 */</span>
    HI_LOG_LEVEL_INFO    <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>     <span class="token comment">/**&lt;Message. It is used to prompt users. Users can open the message when locating problems. It is recommended to disable this message in general.*/</span>
                                  <span class="token comment">/**&lt;CNcomment: 提示信息, 一般是为提醒用户而输出，在定位问题的时候可以打开，一般情况下建议关闭 */</span>
    HI_LOG_LEVEL_DBG     <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>     <span class="token comment">/**&lt;Debug. It is used to prompt developers. Developers can open the message when locating problems. It is recommended to disable this message in general.*/</span>
                                  <span class="token comment">/**&lt;CNcomment: 提示信息, 一般是为开发人员调试问题而设定的打印级别，一般情况下建议关闭 */</span>
 
    HI_LOG_LEVEL_BUTT
<span class="token punctuation">}</span> HI_LOG_LEVEL_E<span class="token punctuation">;</span>
 
drv_media_mem_v2<span class="token punctuation">.</span>c    实现了cat <span class="token operator">/</span>proc<span class="token operator">/</span>media<span class="token operator">-</span>mem
 
drv_mem_ext<span class="token punctuation">.</span>c 实现了 KMEM_POOL_S 的管理，
 
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="内核模块管理">内核模块管理</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">drv_module_ext<span class="token punctuation">.</span>c

COMMON_DRV_ModInit

         MMNGR_DRV_ModInit

        

    s32Ret <span class="token operator">=</span> <span class="token function">HI_DRV_MODULE_Register</span><span class="token punctuation">(</span>HI_ID_SYS<span class="token punctuation">,</span>    <span class="token string">"HI_SYS"</span><span class="token punctuation">,</span>      HI_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    s32Ret <span class="token operator">|=</span> <span class="token function">HI_DRV_MODULE_Register</span><span class="token punctuation">(</span>HI_ID_MODULE<span class="token punctuation">,</span> <span class="token string">"HI_MODULE"</span><span class="token punctuation">,</span>   HI_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    s32Ret <span class="token operator">|=</span> <span class="token function">HI_DRV_MODULE_Register</span><span class="token punctuation">(</span>HI_ID_LOG<span class="token punctuation">,</span>    <span class="token string">"HI_LOG"</span><span class="token punctuation">,</span>      HI_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    s32Ret <span class="token operator">|=</span> <span class="token function">HI_DRV_MODULE_Register</span><span class="token punctuation">(</span>HI_ID_PROC<span class="token punctuation">,</span>   <span class="token string">"HI_PROC"</span><span class="token punctuation">,</span>     HI_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    s32Ret <span class="token operator">|=</span> <span class="token function">HI_DRV_MODULE_Register</span><span class="token punctuation">(</span>HI_ID_STAT<span class="token punctuation">,</span>   <span class="token string">"HI_STAT"</span><span class="token punctuation">,</span>     HI_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    s32Ret <span class="token operator">|=</span> <span class="token function">HI_DRV_MODULE_Register</span><span class="token punctuation">(</span>HI_ID_MEM<span class="token punctuation">,</span>    <span class="token string">"HI_MEM"</span><span class="token punctuation">,</span>      HI_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

 

drv_media_mem<span class="token punctuation">.</span>c  使用dma_alloc_from_contiguous来分配

HI_DRV_MMZ_Init 这里根据bootargs传递的mmz参数分配内存大小。 mmz分配时的参数：<span class="token operator">&lt;</span>mmz_name<span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token operator">&lt;</span>gfp<span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token operator">&lt;</span>phys_start_addr<span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token operator">&lt;</span>size<span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token operator">&lt;</span>alloc_type<span class="token operator">&gt;</span>"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730154720.png" alt=""></p>
<h3 id="内核Proc的实现">内核Proc的实现</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">drv_proc_ext<span class="token punctuation">.</span>c
HI_DRV_PROC_Init 实现cat <span class="token operator">/</span>proc<span class="token operator">/</span>hisi<span class="token operator">/</span>msp<span class="token operator">/</span>
    <span class="token function">proc_mkdir</span><span class="token punctuation">(</span><span class="token string">"graphics"</span><span class="token punctuation">,</span> g_pHisi_proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">proc_symlink</span><span class="token punctuation">(</span><span class="token string">"msp"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"hisi/msp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">proc_symlink</span><span class="token punctuation">(</span><span class="token string">"graphics"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"hisi/graphics"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>drv_userproc.c    proc使用红黑树管理目录路径</p>
<p>​    创建销毁目录，路径在这里实现，具体每一个不同模块的proc文件读写在每个模块内部实现，使用函数指针。</p>
<h3 id="4-2-3-业务模块应用层通用组件source-component">4.2.3 业务模块应用层通用组件source/component</h3>
<p>/home/andy/HiSTBLinuxFS/source/component  这个目录里面很多目录只有.so .a库，没有源代码。</p>
<p>/source/component/hiplayer 没有源码。</p>
<p>hi_debug.h   各种调试宏定义，不同级别调试定义</p>
<p>HI_MALLOC   内存分配使用了内核链表管理</p>
<p>内存在一个模块内分配，往用户空间传递物理地址，其它模块使用这个物理地址映射到虚拟地址，这样来共享内存</p>
<p>​    海思这里大多数模块都只提供了编译后的库</p>
<h2 id="4-3-海思专用组件">4.3 海思专用组件</h2>
<h3 id="4-3-1-海思MSP模块应用层接口source-msp-api">4.3.1 海思MSP模块应用层接口source/msp/api</h3>
<h4 id="Avplay分析">Avplay分析</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">HI_MPI_AVPLAY_Create
         AVPLAY_FrcCreate  帧率控制？    
         HI_MPI_SYNC_Create     音视频同步
         AVPLAY_CreateThread<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>​     <img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730154354.svg" alt="HI_MPI_AVPLAY_Create.__avplay_mpi_avplay_c"></p>
<p>上图插图的是svg格式图片，可以使用IE，firefox打开，最好使用专门的看图软件打开。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">HI_MPI_VDEC_AllocChan
         <span class="token function">VPSS_Control</span><span class="token punctuation">(</span>pstVdec<span class="token operator">-&gt;</span>hVdec<span class="token punctuation">,</span>VPSS_CMD_CREATEVPSS<span class="token punctuation">,</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>pstVdec<span class="token operator">-&gt;</span>hVpss<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
UNF调用一般过程，最终采用ioctl调用驱动   
HI_UNF_AVPLAY_GetBuf
         HI_MPI_AVPLAY_GetBuf
                   HI_MPI_VDEC_ChanGetBuffer
                            VDEC_GetStreamBuf                <span class="token comment">/* If get but not put, return last address */</span>    这里有对不对称调用特殊处理
                                     <span class="token function">ioctl</span><span class="token punctuation">(</span>s_stVdecAdpParam<span class="token punctuation">.</span>s32DevFd<span class="token punctuation">,</span> UMAPC_VDEC_GETBUF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stBufParam<span class="token punctuation">)</span><span class="token punctuation">;</span>     
                                    
HI_MPI_AVPLAY_Start
         AVPLAY_StartVidChn
                   HI_MPI_SYNC_Start
                   HI_MPI_VDEC_ChanStart
                             <span class="token function">ioctl</span><span class="token punctuation">(</span>g_SyncDevFd<span class="token punctuation">,</span> CMD_SYNC_START_SYNC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SyncId<span class="token punctuation">)</span><span class="token punctuation">;</span>
         HI_MPI_SYNC_Play 结构体状态改变
         AVPLAY_Play             结构体状态控制
         HI_MPI_STAT_Event                                   
 
HI_MPI_AVPLAY_Stop
         AVPLAY_StopVidChn
                   HI_MPI_VDEC_ChanStop
                            VDEC_ChanStop      这里调用函数指针
                   HI_MPI_VDEC_ResetChan
                            VDEC_ResetStreamBuf
                            <span class="token function">VDEC_VPSSCMD</span><span class="token punctuation">(</span>hVdec<span class="token punctuation">,</span> VPSS_CMD_RESETVPSS<span class="token punctuation">,</span> HI_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>         调用函数指针，指向VPSS_Control
                   AVPLAY_ResetWindow
                   HI_MPI_SYNC_Stop
         <span class="token function">HI_MPI_STAT_Event</span><span class="token punctuation">(</span>STAT_EVENT_VSTOP<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
VDEC使用函数指针集来支持多种解码方式，内部vfmw。mjpeg，内部硬件<span class="token number">265</span>协处理器
mpi_vdec_vpu<span class="token punctuation">.</span>c
HI_MPI_VDEC_Init
         <span class="token function">HI_CODEC_Register</span><span class="token punctuation">(</span><span class="token function">VDEC_MJPEG_Codec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">HI_CODEC_Register</span><span class="token punctuation">(</span><span class="token function">VDEC_VFMW_Codec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token keyword">static</span> HI_CODEC_S hi_codecVPU_entry <span class="token operator">=</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span>pszName                  <span class="token operator">=</span> <span class="token string">"VPU"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unVersion                 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">.</span>stVersion <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>pszDescription <span class="token operator">=</span> <span class="token string">"Hisilicon H265 codec"</span><span class="token punctuation">,</span>
 
    <span class="token punctuation">.</span>GetCap                      <span class="token operator">=</span> HI_VPU_GetCap<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>Create                       <span class="token operator">=</span> HI_VPU_Create<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>Destroy            <span class="token operator">=</span> HI_VPU_Destroy<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>Start                           <span class="token operator">=</span> HI_VPU_Start<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>Stop                            <span class="token operator">=</span> HI_VPU_Stop<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>Reset                         <span class="token operator">=</span> HI_VPU_Reset<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>SetAttr             <span class="token operator">=</span> HI_VPU_SetAttr<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>GetAttr            <span class="token operator">=</span> HI_VPU_GetAttr<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>DecodeFrame          <span class="token operator">=</span> HI_VPU_DecodeFrame<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>EncodeFrame <span class="token operator">=</span> HI_NULL<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>RegFrameBuffer <span class="token operator">=</span> HI_VPU_RegFrameBuffer<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>GetStreamInfo        <span class="token operator">=</span> HI_VPU_GetStreamInfo<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>Control             <span class="token operator">=</span> HI_VPU_Control<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
avplay，vi和 vo之间使用vpss关联。
HI_UNF_VO_DetachWindow
         HI_MPI_AVPLAY_DetachWindow
                   HI_MPI_VDEC_DestroyPort
         <span class="token function">HI_MPI_VI_Detach</span><span class="token punctuation">(</span>hSrc<span class="token punctuation">,</span> hWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   VI_DetachFromVpss
        
HI_MPI_AVPLAY_ChnClose
         AVPLAY_FreeVidChn
                   HI_MPI_VDEC_ChanBufferDeInit
                            <span class="token function">VDEC_VFMWSpecCMD</span><span class="token punctuation">(</span>hVdec<span class="token punctuation">,</span> VFMW_CMD_DETACHBUF<span class="token punctuation">,</span> HI_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">VDEC_DestroyStreamBuf</span><span class="token punctuation">(</span>pstVdec<span class="token operator">-&gt;</span>hStreamBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>                   ummap内存块，ioctl通知内核vdec销毁内存
                   AVPLAY_FreeVdec
                            HI_MPI_VDEC_FreeChan
                                     <span class="token function">VPSS_Control</span><span class="token punctuation">(</span>pstVdec<span class="token operator">-&gt;</span>hVdec<span class="token punctuation">,</span>VPSS_CMD_DESTORYVPSS<span class="token punctuation">,</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>pstVdec<span class="token operator">-&gt;</span>hVpss<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                     <span class="token function">VDEC_DestroyCodec</span><span class="token punctuation">(</span>pstVdec<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
HI_UNF_AVPLAY_Destroy
         HI_MPI_AVPLAY_Destroy
                   <span class="token function">HI_MPI_SYNC_Destroy</span><span class="token punctuation">(</span>pAvplay<span class="token operator">-&gt;</span>hSync<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token function">ioctl</span><span class="token punctuation">(</span>g_AvplayDevFd<span class="token punctuation">,</span> CMD_AVPLAY_DESTROY<span class="token punctuation">,</span> <span class="token operator">&amp;</span>AvplayUsrAddr<span class="token punctuation">.</span>AvplayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  
avplay内部的线程
    <span class="token punctuation">(</span>HI_VOID<span class="token punctuation">)</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>pAvplay<span class="token operator">-&gt;</span>AvplayDataThdInst<span class="token punctuation">,</span> HI_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">AVPLAY_VID_THREAD</span></span>
    <span class="token punctuation">(</span>HI_VOID<span class="token punctuation">)</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>pAvplay<span class="token operator">-&gt;</span>AvplayVidDataThdInst<span class="token punctuation">,</span> HI_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">(</span>HI_VOID<span class="token punctuation">)</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>pAvplay<span class="token operator">-&gt;</span>AvplayStatThdInst<span class="token punctuation">,</span> HI_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-3-2-海思MSP模块驱动层接口source-msp-drv">4.3.2 海思MSP模块驱动层接口source/msp/drv/</h3>
<h4 id="VENC">VENC</h4>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730161000.png" alt=""></p>
<p>VENC 模块的具体工作原理如上图所示，注意图中褐色箭头，是 VENC 调用到VPSS 模块，来对帧信息做缩放处理后编码的数据流，该处理只用于外部用户送帧的模式。若在绑定情况下出现帧信息分辨率与编码分辨率不匹配， VENC 模块会通知绑定的前级模块进行缩放处理，而不会自行调用 VPSS 模块缩放。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">VENC_DRV_ModInit
         VENC_DRV_Init
                   <span class="token function">HI_DRV_MODULE_Register</span><span class="token punctuation">(</span>HI_ID_VENC<span class="token punctuation">,</span> <span class="token string">"HI_VENC"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>HI_VOID<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>s_VencExportFuncs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            MODULE_DRV_Register
                                     <span class="token function">ModuleMgr_Link_AddNode</span><span class="token punctuation">(</span>g_pstKModuleHeader<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stModule<span class="token punctuation">)</span><span class="token punctuation">;</span> 链表管理
                                     <span class="token function">LOGAddModule</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HI_PCHAR<span class="token punctuation">)</span>pu8ModuleName<span class="token punctuation">,</span> <span class="token punctuation">(</span>HI_MOD_ID_E<span class="token punctuation">)</span>u32ModuleID<span class="token punctuation">)</span><span class="token punctuation">;</span>  在log模块中注册
         <span class="token function">HI_DRV_DEV_Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_VencRegisterData<span class="token punctuation">)</span>
                   HI_DRV_PM_Register     海思模块管理非常重要的模块，了解这个函数实现过程就大概明白海思内核模块实现思想了
         <span class="token function">VENC_DRV_BoardDeinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      一些寄存器配置，reset，clock操作。
         venc调用硬件协处理器，涉及<span class="token number">263</span><span class="token punctuation">,</span><span class="token number">264</span>，mpeg4，
    <span class="token function">snprintf</span><span class="token punctuation">(</span>g_VencRegisterData<span class="token punctuation">.</span>devfs_name<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> UMAP_DEVNAME_VENC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_VencRegisterData<span class="token punctuation">.</span>fops   <span class="token operator">=</span> <span class="token operator">&amp;</span>VENC_FOPS<span class="token punctuation">;</span>
    g_VencRegisterData<span class="token punctuation">.</span>minor  <span class="token operator">=</span> UMAP_MIN_MINOR_VENC<span class="token punctuation">;</span>
    g_VencRegisterData<span class="token punctuation">.</span>owner  <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
    g_VencRegisterData<span class="token punctuation">.</span>drvops <span class="token operator">=</span> <span class="token operator">&amp;</span>venc_drvops<span class="token punctuation">;</span>      <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="avplay">avplay</h4>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730154040.png" alt=""></p>
<ul>
<li>AVPLAY 主要由以下三部分组成：
<ul>
<li>音视频解码器</li>
<li>同步播放控制模块</li>
<li>命令与状态管理模块</li>
</ul>
</li>
</ul>
<p>主要负责响应外部控制命令的执行、状态查询上报、使解码后的帧数据通过同步控制<br>
模块输出</p>
<h4 id="avplay初始化分析">avplay初始化分析</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">AVPLAY_DRV_ModInit
​    HI_DRV_MODULE_Register
​         <span class="token function">HI_DRV_MODULE_Register</span><span class="token punctuation">(</span>HI_ID_AVPLAY<span class="token punctuation">,</span> AVPLAY_NAME<span class="token punctuation">,</span> HI_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
​             ModuleMgr_Link_AddNode  内核模块管理
​             KMODULE_MEM_POOL_AddModule
​                 KMODULE_MEM_POOL_FindNode    找到空的没有使用的节点
​                 KMODULE_MEM_POOL_MALLOC 分配内存，然后放到链表
​             LOGAddModule                    日志
​    <span class="token function">HI_DRV_DEV_Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_AvplayRegisterData<span class="token punctuation">)</span>
​         <span class="token function">HI_DRV_PM_Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s_umap_devs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   himedia封装处理
​             <span class="token function">himedia_device_alloc</span><span class="token punctuation">(</span>himedia<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
​             <span class="token function">himedia_device_add</span><span class="token punctuation">(</span>bdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
​                 <span class="token function">dev_set_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s.%d"</span><span class="token punctuation">,</span> pdev<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> pdev<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
​                 <span class="token function">device_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
​             <span class="token function">device_create</span><span class="token punctuation">(</span>himedia_class<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>bdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> dev<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> himedia<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
​             <span class="token function">himedia_driver_alloc</span><span class="token punctuation">(</span>himedia<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> himedia<span class="token operator">-&gt;</span>owner<span class="token punctuation">,</span> himedia<span class="token operator">-&gt;</span>base_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
​             <span class="token function">himedia_driver_register</span><span class="token punctuation">(</span>bdrv<span class="token punctuation">)</span><span class="token punctuation">;</span>
​                 <span class="token function">driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>drv<span class="token operator">-&gt;</span>driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
​   
 
  g_AvplayRegisterData<span class="token punctuation">.</span>fops <span class="token operator">=</span> <span class="token operator">&amp;</span>AVPLAY_FOPS<span class="token punctuation">;</span>
  g_AvplayRegisterData<span class="token punctuation">.</span>minor <span class="token operator">=</span> UMAP_MIN_MINOR_AVPLAY<span class="token punctuation">;</span>
  g_AvplayRegisterData<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
  g_AvplayRegisterData<span class="token punctuation">.</span>drvops <span class="token operator">=</span> <span class="token operator">&amp;</span>AVPLAY_DRVOPS<span class="token punctuation">;</span>  
 
  s_umap_devs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>minor <span class="token operator">=</span> umapd<span class="token operator">-&gt;</span>minor<span class="token punctuation">;</span>
  s_umap_devs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">=</span> umapd<span class="token operator">-&gt;</span>devfs_name<span class="token punctuation">;</span>
  s_umap_devs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>owner <span class="token operator">=</span> umapd<span class="token operator">-&gt;</span>owner<span class="token punctuation">;</span>
  s_umap_devs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>app_ops <span class="token operator">=</span> umapd<span class="token operator">-&gt;</span>fops<span class="token punctuation">;</span>
  s_umap_devs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base_ops <span class="token operator">=</span> umapd<span class="token operator">-&gt;</span>drvops<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="IOCTL实现分析-基于avplay">IOCTL实现分析 基于avplay</h4>
<p>在HI_DRV_DEV_Register<strong>中注册</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> AVPLAY_FOPS <span class="token operator">=</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span>owner          <span class="token operator">=</span>  THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open           <span class="token operator">=</span>  AVPLAY_DRV_Open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span>  AVPLAY_DRV_Ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release        <span class="token operator">=</span>  AVPLAY_DRV_Close<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>      
AVPLAY_DRV_Ioctl
         <span class="token function">HI_DRV_UserCopy</span><span class="token punctuation">(</span>ffile<span class="token operator">-&gt;</span>f_dentry<span class="token operator">-&gt;</span>d_inode<span class="token punctuation">,</span> ffile<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> AVPLAY_Ioctl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token function">func</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> file<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span>parg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           这里对ioctl进行了一层封装，copy_from_user，copy_to_user的自动化处理
<span class="token function">AVPLAY_Ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> HI_VOID <span class="token operator">*</span>arg<span class="token punctuation">)</span>  
                   CMD_AVPLAY_CREATE            
                            AVPLAY_Create
                                     <span class="token function">HI_DRV_MMZ_AllocAndMap</span><span class="token punctuation">(</span>BufName<span class="token punctuation">,</span> MMZ_OTHERS<span class="token punctuation">,</span> <span class="token number">0x2000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>MemBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                     <span class="token function">HI_DRV_PROC_AddModule</span><span class="token punctuation">(</span>ProcName<span class="token punctuation">,</span> HI_NULL<span class="token punctuation">,</span> HI_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>                 这里实现了proc目录的生成，下面是读写proc
                                pProcItem<span class="token operator">-&gt;</span>read <span class="token operator">=</span> AVPLAY_ProcRead<span class="token punctuation">;</span>
                                pProcItem<span class="token operator">-&gt;</span>write <span class="token operator">=</span> AVPLAY_ProcWrite<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="avplay-多个实例如何找到对应实例">avplay 多个实例如何找到对应实例</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">AVPLAY_GET_INST_AND_LOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         AVPLAY_CheckHandle
                   pAvplayUsrAddr<span class="token operator">-&gt;</span>AvplayId <span class="token operator">=</span> hAvplay <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
                   <span class="token function">ioctl</span><span class="token punctuation">(</span>g_AvplayDevFd<span class="token punctuation">,</span> CMD_AVPLAY_CHECK_ID<span class="token punctuation">,</span> pAvplayUsrAddr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>drv中的实现</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">AVPLAY_Ioctl            
         AVPLAY_CheckId              
                   pAvplayUsrAddr<span class="token operator">-&gt;</span>AvplayUsrAddr <span class="token operator">=</span> g_AvplayGlobalState<span class="token punctuation">.</span>AvplayInfo<span class="token punctuation">[</span>pAvplayUsrAddr<span class="token operator">-&gt;</span>AvplayId<span class="token punctuation">]</span><span class="token punctuation">.</span>AvplayUsrAddr<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="VPSS">VPSS</h4>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730153749.png" alt=""></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">    g_VpssRegisterData<span class="token punctuation">.</span>fops   <span class="token operator">=</span> <span class="token operator">&amp;</span>s_VpssFileOps<span class="token punctuation">;</span>
    g_VpssRegisterData<span class="token punctuation">.</span>minor  <span class="token operator">=</span> UMAP_MIN_MINOR_VPSS<span class="token punctuation">;</span>
    g_VpssRegisterData<span class="token punctuation">.</span>owner  <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
g_VpssRegisterData<span class="token punctuation">.</span>drvops <span class="token operator">=</span> <span class="token operator">&amp;</span>s_VpssBasicOps<span class="token punctuation">;</span>
VPSS_DRV_Init
VPSS_CTRL_Init
         VPSS_CTRL_RegistISR     注册中断
         <span class="token function">VPSS_CTRL_InitInstList</span><span class="token punctuation">(</span><span class="token punctuation">(</span>VPSS_IP_E<span class="token punctuation">)</span>i<span class="token punctuation">)</span>     管理vpss实例链表初始化
         VPSS_HAL_Init                   内存，寄存器配置
         VPSS_CTRL_CreateThread      内核线程
                   VPSS_CTRL_ThreadProc
                            VPSS_CTRL_CreateTask           创建任务
                            VPSS_CTRL_StartTask               开始任务<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="VDEC-2">VDEC</h4>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730153702.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730153709.png" alt=""></p>
<h4 id="Avplay解码ES流过程">Avplay解码ES流过程</h4>
<p>步骤 1 初始化并配置相关设备，如 DISPLAY、 VO、 SOUND、 DEMUX 设备等。<br>
步骤 2 调用 HI_UNF_AVPLAY_Init 接口初始化 AVPLAY 设备。<br>
步骤 3 调用 HI_UNF_AVPLAY_GetDefaultConfig 接口获取缺省的 AVPLAY 配置，注意选择HI_UNF_AVPLAY_STREAM_TYPE_ES 模式。<br>
步骤 4 根据应用需要，修改码流属性参数。<br>
步骤 5 调用 HI_UNF_AVPLAY_Create 接口创建 AVPLAY 播放器。<br>
步骤 6 调用 HI_UNF_AVPLAY_ChnOpen 接口打开音频或视频通道。</p>
<p>步骤 7 调用 HI_UNF_AVPLAY_SetAttr 接口设置音频解码器或视频解码器属性，同步设置为自由播放。<br>
步骤 8 调用 HI_UNF_SND_CreateTrack 创建 Track。<br>
步骤 9 调用 HI_UNF_SND_Attach 接口将音频播放器与 Track 绑定。<br>
步骤 10 调用 HI_UNF_VO_AttachWindow 接口将视频播放器与 VO 的窗口绑定。<br>
步骤 11 调用 HI_UNF_VO_SetWindowEnable 接口使能窗口。<br>
步骤 12 调用 HI_UNF_AVPLAY_Start 接口发送 Start 命令，开始播放音频或视频。<br>
步骤 13 调用 HI_UNF_AVPLAY_GetBuf 接口申请存放音频或视频的缓冲区。<br>
步骤 14 通过内存拷贝或文件读取等方式，将音频或视频数据直接写到缓冲区中。<br>
步骤 15 调用 HI_UNF_AVPLAY_PutBuf 接口更新音视频缓冲区中的读写指针。<br>
步骤 16 播放任务结束后，首先调用 HI_UNF_AVPLAY_Stop 接口停止 AVPLAY，再调用HI_UNF_AVPLAY_Destroy 接口销毁 AVPLAY，释放相关资源。<br>
步骤 17 关闭相关设备，如 DISPLAY 设备、 VO 设备、 SOUND 设备、 DEMUX 设备和AVPLAY</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730164615.svg" alt="HI_MPI_AVPLAY_Create.__avplay_mpi_avplay_c"></p>
<p>MCE实现了启动过程画面的平滑切换</p>
<h4 id="IR">IR</h4>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730153646.png" alt=""></p>
<p>驱动层</p>
<p>负责完成红外模块的中断处理，在底半部中遍历所有协议并调用 match 函数来判定当前收到的红外帧属于哪种协议。如果没有匹配，则丢弃当前帧。完成最顶层的错误处理：如果当前帧当前时刻还不能被解析，则会等待大约 200ms 之后再次尝试，如果失败，则丢弃当前帧。</p>
<p>协议适配层</p>
<p>完成各个协议的初始化工作，向上提供遍历协议的接口，向下提供容纳协议描述符的存储空间。</p>
<p>协议处理层</p>
<p>协议处理层完成判定：由从某个 symbol 开始的一连串 symbol 是不是符合本协议的一<br>
帧。在判定某一帧符合本协议的前提条件下，完成一帧 symbol 的解析，将对应的键值解析出来。如果在解析过程中出错，或者判定是本协议的帧，但无法解析时，完成错误处理。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730153556.png" alt=""></p>
<p>​    <img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730153604.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730153611.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730153623.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730153630.png" alt=""></p>
<h3 id="4-4-Sample-mosaic分析">4.4 Sample_mosaic分析</h3>
<h4 id="应用层调用">应用层调用</h4>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730153315.png" alt=""></p>
<p>上图是部分截图，完整大的原图见目录中svg文件</p>
<p>valgrind --tool=callgrind ./sample_mosaic 1080P.h264 h264</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730153400.svg" alt="samplemosaic-callgrind-all"></p>
<h4 id="系统调用">系统调用</h4>
<p>Strace分析</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/07/3020210730153300.png" alt=""></p>
<h2 id="5-小结：">5:小结：</h2>
<p>海思MPI驱动其实就是在标准linux驱动基础之上封装了一层，增加了log，proc，内存管理（映射，链表）功能。MPI是在标准linux驱动基础上封装了DVR常用外围逻辑接口，并且统一并简化了接口操作方式，原来各个外围子系统操作方式差别很大，不同实现框架，实现方式使用方法也不一样（如VI，VO，AI/AO，VPSS，如果自己用标准linux子系统实现要复杂得多）。</p>
<p>应用层MPI接口是在MPI驱动基础上再次封装了一层，封装了驱动的调用，配置等操作，在驱动功能的基础上进一步封装完成了一些简单的业务功能接口，方便了用户的使用。UNF就是在MPI基础上增加了业务逻辑封装，把常用的业务逻辑封装成接口，大大方便用户的应用程序开发。</p>
<h2 id="5-1-UNF相对标准内核模块区别">5.1 UNF相对标准内核模块区别</h2>
<h3 id="5-1-1-Proc读写调试。">5.1.1 Proc读写调试。</h3>
<p>实时查询运行状态，修改设置。通用的proc目录、文件创建销毁有通用接口。读写proc文件在每个内核模块中有单独实现。</p>
<h3 id="5-1-2-内核空间往应用空间写文件">5.1.2 内核空间往应用空间写文件</h3>
<p>方便调试，Dump内核数据到用户控件方便定位Bug。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">HI_DRV_FILE_Open
filp_open
HI_DRV_FILE_Close
​    filp_close
HI_DRV_FILE_Read
​    pFile<span class="token operator">-&gt;</span>f_op<span class="token operator">-&gt;</span>read
HI_DRV_FILE_Write
​    pFile<span class="token operator">-&gt;</span>f_op<span class="token operator">-&gt;</span>write
HI_DRV_FILE_Lseek
​    vfs_llseek<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="5-1-3Log管理">5.1.3Log管理</h3>
<p>日志打印分级，实时修改。如何实现的见前面章节。</p>
<h3 id="5-1-4内存映射">5.1.4内存映射</h3>
<p>物理地址，虚拟地址映射关系管理，小块内存使用kmalloc申请，大块内存使用dma_alloc_from_contiguous申请。</p>
<p>使用内核链表管理。</p>
<p>打印到proc，log模块中，实时查看运行状态，内存。</p>
<p>方便查找，打印。</p>
<p>在多个内核共享数据也是这样实现的。</p>
<h2 id="5-2代码分析方法">5.2代码分析方法</h2>
<h3 id="5-2-1-查看代码，静态分析应用层，驱动层实现方法">5.2.1 查看代码，静态分析应用层，驱动层实现方法</h3>
<h3 id="5-2-2-图示静态分析函数调用关系">5.2.2 图示静态分析函数调用关系.</h3>
<p>Cflow, dot</p>
<h3 id="5-2-3-图示动态分析函数调用关系：库函数，系统调用，内核调用">5.2.3 图示动态分析函数调用关系：库函数，系统调用，内核调用</h3>
<p>​    Ltrace, strace, valgrind, perf</p>
<p>具体分析方法，使用工具见前面章节。</p>
<h2 id="参考文档：">参考文档：</h2>
<ol>
<li>03-HMS 开发指南.pdf</li>
<li>HiSTBAndroidV600R001C00SPC060_cn\document\01-Development Guide</li>
<li>HiMPP V3.0 媒体处理软件开发参考.pdf</li>
<li>HiSTBAndroidV600R001C00SPC060_cn\document\01-Development Guide</li>
<li>3798m SDK 代码</li>
<li>HMS API Development Reference.chm</li>
<li>HiSTBAndroidV600R001C00SPC060_cn\document\01-Development Guide\09-API Reference</li>
</ol>
<hr>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>embeded</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>embeded</tag>
        <tag>hisilicon</tag>
        <tag>Driver</tag>
        <tag>3798M</tag>
        <tag>MPP</tag>
        <tag>UNF</tag>
        <tag>Kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>宝塔linux面板重启、重置等命令整合</title>
    <url>/posts/7b4e434c/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="宝塔linux面板重启、重置等命令整合">宝塔linux面板重启、重置等命令整合</h2>
<p>宝塔对新手入门还是比较友好的，方便了入门小站搭建。入门可用，一些新东西也可以在里面看看。大型应用还是的自己搭建。</p>
<p>来源于网络，原作已经不可考据，整理更新到目前最新版。</p>
<p>现在有很多网友都在使用宝塔主机管理系统、对一些不懂linux操作的朋友来说，是一个很好的管理系统、<br>
但是有些朋友重启服务器以后，有可能造成一些服务无法重启。今天我们搜集下关于宝塔面板的命令集锦</p>
<h2 id="Linux面板7-6-0安装命令："><strong>Linux面板7.6.0安装命令：</strong></h2>
<h3 id="Centos安装命令："><strong>Centos安装命令：</strong></h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> -y <span class="token function">wget</span> <span class="token operator">&amp;&amp;</span> <span class="token function">wget</span> -O install.sh http://download.bt.cn/install/install_6.0.sh <span class="token operator">&amp;&amp;</span> <span class="token function">sh</span> install.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><em>复制代码</em></p>
<p><a target="_blank" rel="noopener" href="https://www.bt.cn/offline">咨询离线安装版本</a></p>
<p><strong>试验性Centos/Ubuntu/Debian安装命令</strong> <strong>独立运行环境（py3.7） 可能存在少量兼容性问题 不断优化中</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> -sSO http://download.bt.cn/install/install_panel.sh <span class="token operator">&amp;&amp;</span> <span class="token function">bash</span> install_panel.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><em>复制代码</em></p>
<h3 id="Ubuntu-Deepin安装命令："><strong>Ubuntu/Deepin安装命令：</strong></h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">bash</span> install.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><em>复制代码</em></p>
<h3 id="Debian安装命令："><strong>Debian安装命令：</strong></h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh <span class="token operator">&amp;&amp;</span> <span class="token function">bash</span> install.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><em>复制代码</em></p>
<h3 id="Fedora安装命令"><strong>Fedora安装命令:</strong></h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> -O install.sh http://download.bt.cn/install/install_6.0.sh <span class="token operator">&amp;&amp;</span> <span class="token function">bash</span> install.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><em>复制代码</em></p>
<p>**<br>
**Linux面板7.6.0升级命令：**curl http://download.bt.cn/install/update6.sh|bash<em>复制代码</em></p>
<p>以上节点无法使用的情况下，请使用下面的备用节点：<br>
**</p>
<h3 id="备用节点【香港】："><strong>备用节点【香港】：</strong></h3>
<p><strong>（宝塔推荐使用CN2 双程GIA高品质，免备案的</strong><a target="_blank" rel="noopener" href="https://www.zun.com/server/buy.html?lineid=1671157323431053"><strong>尊云zun.com</strong></a><strong>香港云服务器安装）</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> -y <span class="token function">wget</span> <span class="token operator">&amp;&amp;</span> <span class="token function">wget</span> -O install.sh http://103.224.251.67:5880/install/install_6.0.sh <span class="token operator">&amp;&amp;</span> <span class="token function">sh</span> install.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="管理宝塔">管理宝塔</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#停止</span>
/etc/init.d/bt stop
<span class="token comment">#启动</span>
/etc/init.d/bt start
<span class="token comment">#重启</span>
/etc/init.d/bt restart
<span class="token comment">#卸载</span>
/etc/init.d/bt stop <span class="token operator">&amp;&amp;</span> <span class="token function">chkconfig</span> --del bt <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -f /etc/init.d/bt <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -rf /www/server/panel
<span class="token comment">#查看当前面板端口</span>
<span class="token function">cat</span> /www/server/panel/data/port.pl
<span class="token comment">#修改面板端口，如要改成8881（centos 6  系统）</span>
<span class="token builtin class-name">echo</span> <span class="token string">'8881'</span>  <span class="token operator">&gt;</span>  /www/server/panel/data/port.pl <span class="token operator">&amp;&amp;</span>  /etc/init.d/bt restart
iptables -I INPUT -p tcp -m state --state NEW -m tcp --dport <span class="token number">8881</span>  -j ACCEPT
<span class="token function">service</span> iptables save
<span class="token function">service</span> iptables restart
<span class="token comment">#修改面板端口，如要改成8881（centos 7  系统）</span>
<span class="token builtin class-name">echo</span> <span class="token string">'8881'</span>  <span class="token operator">&gt;</span>  /www/server/panel/data/port.pl <span class="token operator">&amp;&amp;</span>  /etc/init.d/bt restart
firewall-cmd --permanent --zone<span class="token operator">=</span>public  --add-port<span class="token operator">=</span><span class="token number">8881</span>/tcp
firewall-cmd --reload
<span class="token comment">#强制修改MySQL管理(root)密码，如要改成123456</span>
<span class="token builtin class-name">cd</span> /www/server/panel <span class="token operator">&amp;&amp;</span> python tools.pyc root <span class="token number">123456</span>
<span class="token comment">#修改面板密码，如要改成123456</span>
<span class="token builtin class-name">cd</span> /www/server/panel <span class="token operator">&amp;&amp;</span> python tools.pyc panel <span class="token number">123456</span>
<span class="token comment">#查看宝塔日志</span>
<span class="token function">cat</span> /tmp/panelBoot.pl
<span class="token comment">#查看软件安装日志</span>
<span class="token function">cat</span> /tmp/panelExec.log
<span class="token comment">#站点配置文件位置</span>
/www/server/panel/vhost
<span class="token comment">#删除域名绑定面板</span>
<span class="token function">rm</span> -f /www/server/panel/data/domain.conf
<span class="token comment">#清理登陆限制</span>
<span class="token function">rm</span> -f /www/server/panel/data/*.login
<span class="token comment">#查看面板授权IP</span>
<span class="token function">cat</span> /www/server/panel/data/limitip.conf
<span class="token comment">#关闭访问限制</span>
<span class="token function">rm</span> -f /www/server/panel/data/limitip.conf
<span class="token comment">#查看许可域名</span>
<span class="token function">cat</span> /www/server/panel/data/domain.conf
<span class="token comment">#关闭面板SSL</span>
<span class="token function">rm</span> -f /www/server/panel/data/ssl.pl <span class="token operator">&amp;&amp;</span> /etc/init.d/bt restart
<span class="token comment">#查看面板错误日志</span>
<span class="token function">cat</span> /tmp/panelBoot
<span class="token comment">#查看数据库错误日志</span>
<span class="token function">cat</span> /www/server/data/*.err
<span class="token comment">#站点配置文件目录(nginx)</span>
/www/server/panel/vhost/nginx
<span class="token comment">#站点配置文件目录(apache)</span>
/www/server/panel/vhost/apache
<span class="token comment">#站点默认目录</span>
/www/wwwroot
<span class="token comment">#数据库备份目录</span>
/www/backup/database
<span class="token comment">#站点备份目录</span>
/www/backup/site
<span class="token comment">#站点日志</span>
/www/wwwlogs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Nginx服务管理">Nginx服务管理</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#nginx安装目录</span>
/www/server/nginx
<span class="token comment">#启动</span>
/etc/init.d/nginx start
<span class="token comment">#停止</span>
/etc/init.d/nginx stop
<span class="token comment">#重启</span>
/etc/init.d/nginx restart
<span class="token comment">#启载</span>
/etc/init.d/nginx reload
<span class="token comment">#nginx配置文件</span>
/www/server/nginx/conf/nginx.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Apache服务管理">Apache服务管理</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apache安装目录</span>
/www/server/httpd
<span class="token comment">#启动</span>
/etc/init.d/httpd start
<span class="token comment">#停止</span>
/etc/init.d/httpd stop
<span class="token comment">#重启</span>
/etc/init.d/httpd restart
<span class="token comment">#启载</span>
/etc/init.d/httpd reload
<span class="token comment">#apache配置文件</span>
/www/server/apache/conf/httpd.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="MySQL服务管理">MySQL服务管理</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#mysql安装目录</span>
/www/server/mysql
<span class="token comment">#phpmyadmin安装目录</span>
/www/server/phpmyadmin
<span class="token comment">#数据存储目录</span>
/www/server/data
<span class="token comment">#启动</span>
/etc/init.d/mysqld start
<span class="token comment">#停止</span>
/etc/init.d/mysqld stop
<span class="token comment">#重启</span>
/etc/init.d/mysqld restart
<span class="token comment">#启载</span>
/etc/init.d/mysqld reload
<span class="token comment">#mysql配置文件</span>
/etc/my.cnf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="FTP服务管理">FTP服务管理</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#ftp安装目录</span>
/www/server/pure-ftpd
<span class="token comment">#启动</span>
/etc/init.d/pure-ftpd start
<span class="token comment">#停止</span>
/etc/init.d/pure-ftpd stop
<span class="token comment">#重启</span>
/etc/init.d/pure-ftpd restart
<span class="token comment">#ftp配置文件</span>
/www/server/pure-ftpd/etc/pure-ftpd.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="PHP服务管理">PHP服务管理</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#php安装目录</span>
/www/server/php
<span class="token comment">#启动(请根据安装PHP版本号做更改，例如：/etc/init.d/php-fpm-54 start)</span>
/etc/init.d/php-fpm-<span class="token punctuation">{</span><span class="token number">52</span><span class="token operator">|</span><span class="token number">53</span><span class="token operator">|</span><span class="token number">54</span><span class="token operator">|</span><span class="token number">55</span><span class="token operator">|</span><span class="token number">56</span><span class="token operator">|</span><span class="token number">70</span><span class="token operator">|</span><span class="token number">71</span><span class="token punctuation">}</span> start
<span class="token comment">#停止(请根据安装PHP版本号做更改，例如：/etc/init.d/php-fpm-54 stop)</span>
/etc/init.d/php-fpm-<span class="token punctuation">{</span><span class="token number">52</span><span class="token operator">|</span><span class="token number">53</span><span class="token operator">|</span><span class="token number">54</span><span class="token operator">|</span><span class="token number">55</span><span class="token operator">|</span><span class="token number">56</span><span class="token operator">|</span><span class="token number">70</span><span class="token operator">|</span><span class="token number">71</span><span class="token punctuation">}</span> stop
<span class="token comment">#重启(请根据安装PHP版本号做更改，例如：/etc/init.d/php-fpm-54 restart)</span>
/etc/init.d/php-fpm-<span class="token punctuation">{</span><span class="token number">52</span><span class="token operator">|</span><span class="token number">53</span><span class="token operator">|</span><span class="token number">54</span><span class="token operator">|</span><span class="token number">55</span><span class="token operator">|</span><span class="token number">56</span><span class="token operator">|</span><span class="token number">70</span><span class="token operator">|</span><span class="token number">71</span><span class="token punctuation">}</span> restart
<span class="token comment">#启载(请根据安装PHP版本号做更改，例如：/etc/init.d/php-fpm-54 reload)</span>
/etc/init.d/php-fpm-<span class="token punctuation">{</span><span class="token number">52</span><span class="token operator">|</span><span class="token number">53</span><span class="token operator">|</span><span class="token number">54</span><span class="token operator">|</span><span class="token number">55</span><span class="token operator">|</span><span class="token number">56</span><span class="token operator">|</span><span class="token number">70</span><span class="token operator">|</span><span class="token number">71</span><span class="token punctuation">}</span> reload
<span class="token comment">#配置文件(请根据安装PHP版本号做更改，例如：/www/server/php/52/etc/php.ini)</span>
/www/server/php/<span class="token punctuation">{</span><span class="token number">52</span><span class="token operator">|</span><span class="token number">53</span><span class="token operator">|</span><span class="token number">54</span><span class="token operator">|</span><span class="token number">55</span><span class="token operator">|</span><span class="token number">56</span><span class="token operator">|</span><span class="token number">70</span><span class="token operator">|</span><span class="token number">71</span><span class="token punctuation">}</span>/etc/php.ini<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Redis服务管理">Redis服务管理</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#redis安装目录</span>
/www/server/redis
<span class="token comment">#启动</span>
/etc/init.d/redis start
<span class="token comment">#停止</span>
/etc/init.d/redis stop
<span class="token comment">#redis配置文件</span>
/www/server/redis/redis.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Memcached服务管理">Memcached服务管理</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#memcached安装目录</span>
/usr/local/memcached
<span class="token comment">#启动</span>
/etc/init.d/memcached start
<span class="token comment">#停止</span>
/etc/init.d/memcached stop
<span class="token comment">#重启</span>
/etc/init.d/memcached restart
<span class="token comment">#启载</span>
/etc/init.d/memcached reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如有不全、欢迎投稿。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>vps</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>宝塔</tag>
        <tag>VPS</tag>
        <tag>建站</tag>
        <tag>Nginx</tag>
        <tag>Apache</tag>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>docker使用简明教程</title>
    <url>/posts/42b6a86d/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>关于docker安装，查看，镜像管理，以及一个实用Dockerfile， LAMP，PHP，LTMJ。</p>
<ul>
<li>关于本blog，<strong>图床</strong>一般使用<strong>github</strong>，已经配置了CDN，如果图片还是未显示请自行代理解决</li>
</ul>
<h2 id="一、Docker安装">一、Docker安装</h2>
<ul>
<li>在Ubuntu系统下安装：</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>在Fedora/CentOS系统下安装：</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">yum <span class="token function">install</span> <span class="token function">docker</span>
dnf <span class="token function">install</span> <span class="token function">docker</span> <span class="token comment"># Fedora 25+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>在SUSE系统下安装：</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">zypper</span> <span class="token function">install</span> <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="二、Docker容器">二、Docker容器</h2>
<ul>
<li>首先启动Docker</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 启动Docker</span>
systemctl start <span class="token function">docker</span>
<span class="token comment"># 设置开机自启动，可选</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>启动Docker测试容器</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">docker</span> run <span class="token string">"hello-world"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>在启动容器时，如果使用的镜像在本地不存在，会尝试从网络上获取。</li>
<li>在一般情况下，启动Web服务的容器，使用以下命令：</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># -d：daemon，使容器在后台运行</span>
<span class="token comment"># -p：port，指定容器的端口，这里是将容器的80端口映射到主机的8001端口</span>
<span class="token function">docker</span> run -d -p <span class="token number">8001</span>:80 <span class="token string">"image_name"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>查看容器运行情况</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">docker</span> <span class="token function">ps</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>Docker会为容器分配一个Container ID和一个Container Name，Name可以在运行时通过<code>-name</code>自行指定，这两个可以用来标识容器。</li>
<li>需要停止容器时，使用以下命令：</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">docker</span> stop <span class="token string">"container_name"</span>
<span class="token comment"># 或使用ID查找</span>
<span class="token function">docker</span> stop <span class="token string">"container_id"</span>
<span class="token comment"># 重启</span>
<span class="token function">docker</span> restart <span class="token string">"container_id"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="三、Docker镜像">三、Docker镜像</h2>
<h3 id="Dokerfile编译镜像">Dokerfile编译镜像</h3>
<ul>
<li>Docker容器是运行的Docker镜像实例，一般情况下，我们需要制作自己的Docker镜像。</li>
<li>Docker镜像的制作依赖于Dockerfile，我们稍后在讨论Dockerfile的编写，这里假定我们有一个编写好的Dockerfile。</li>
<li>下面的命令将在当前路径查找Dockerfile并构建一个名为“image_name”的镜像。</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">docker</span> build -t <span class="token string">"image_name"</span> ./<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="查看本地所有镜像">查看本地所有镜像</h3>
<ul>
<li>在构建过程中需要在网络上下载来源镜像，可能需要一段时间。</li>
<li>如果Dockerfile中的命令都正确结束（Exit code 0），那么Docker镜像的构建也将顺利完成，我们可以通过下面的命令查看我们的所有镜像：</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">docker</span> images<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="导出备份已有镜像文件">导出备份已有镜像文件</h3>
<ul>
<li>我们还可以导出我们制作好的Docker镜像，下面的命令将image_name镜像导出为image_name.tar</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">docker</span> save <span class="token string">"image_name"</span> <span class="token operator">&gt;</span> image_name.tar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="导入已有镜像备份">导入已有镜像备份</h3>
<ul>
<li>在另一台机器上，我们不需要网络就可以导入并使用该镜像：</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">docker</span> load <span class="token operator">&lt;</span> image_name.tar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="四、Dockerfile">四、Dockerfile</h2>
<ul>
<li>Dockerfile本质上是一组命令集合，用于自动化构建镜像，下面以几个实例来说明Dockerfile的编写方法：</li>
</ul>
<h3 id="实例一：LAMP（Linux-Apache-MySQL-PHP）环境配置">实例一：LAMP（Linux+Apache+MySQL+PHP）环境配置</h3>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 来源镜像，一般可以使用标准的系统或者带有各种环境的系统</span>
<span class="token comment"># 显然这里使用的是标准的Ubuntu 14.04系统</span>
FROM ubuntu<span class="token punctuation">:</span><span class="token number">14.04</span>
<span class="token comment"># 镜像作者</span>
MAINTAINER wrlu
<span class="token comment"># 刷新日期</span>
ENV REFRESHED_AT 2018<span class="token punctuation">-</span>08<span class="token punctuation">-</span><span class="token number">05</span>
<span class="token comment"># 设定字符集</span>
ENV LANG C.UTF<span class="token punctuation">-</span><span class="token number">8</span>
<span class="token comment"># RUN命令用于执行系统命令</span>
<span class="token comment"># 因为需要自动化安装，所以最好通过-y命令跳过确认</span>
<span class="token comment"># 更新APT软件源</span>
RUN apt<span class="token punctuation">-</span>get update <span class="token punctuation">-</span>y
<span class="token comment"># 安装MySQL</span>
RUN apt<span class="token punctuation">-</span>get <span class="token punctuation">-</span>y install mysql<span class="token punctuation">-</span>server
<span class="token comment"># 安装Apache</span>
RUN apt<span class="token punctuation">-</span>get <span class="token punctuation">-</span>y install apache2
<span class="token comment"># 安装PHP5</span>
RUN apt<span class="token punctuation">-</span>get <span class="token punctuation">-</span>y install php5 libapache2<span class="token punctuation">-</span>mod<span class="token punctuation">-</span>php5
RUN apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>yqq php5<span class="token punctuation">-</span>mysql php5<span class="token punctuation">-</span>curl php5<span class="token punctuation">-</span>gd php5<span class="token punctuation">-</span>intl php<span class="token punctuation">-</span>pear php5<span class="token punctuation">-</span>imagick php5<span class="token punctuation">-</span>imap php5<span class="token punctuation">-</span>mcrypt php5<span class="token punctuation">-</span>memcache php5<span class="token punctuation">-</span>ming php5<span class="token punctuation">-</span>ps php5<span class="token punctuation">-</span>pspell php5<span class="token punctuation">-</span>recode php5<span class="token punctuation">-</span>snmp php5<span class="token punctuation">-</span>sqlite php5<span class="token punctuation">-</span>tidy php5<span class="token punctuation">-</span>xmlrpc php5<span class="token punctuation">-</span>xsl
<span class="token comment"># 删除Apache2列出目录配置</span>
RUN sed <span class="token punctuation">-</span>i 's/Options Indexes FollowSymLinks/Options None/' /etc/apache2/apache2.conf
<span class="token comment"># COPY命令可以复制文件，但是似乎不能递归复制文件</span>
COPY IncludeAirline/* /var/www/html/
COPY IncludeAirline/airlines/* /var/www/html/airlines/
<span class="token comment"># 删除默认的主页</span>
RUN rm /var/www/html/index.html
<span class="token comment"># 复制启动脚本</span>
COPY start.sh /root/start.sh
RUN chmod +x /root/start.sh
<span class="token comment"># 设置启动目录以及启动脚本</span>
ENTRYPOINT cd /root; ./start.sh
<span class="token comment"># 设置需要暴露的端口</span>
EXPOSE 80<span class="token punctuation">,</span><span class="token number">3306</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>本例中还有一个启动脚本<code>start.sh</code>，用于导入数据库，编写如下：</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#!/bin/bash</span>
<span class="token comment"># 启动后延时</span>
sleep 1
<span class="token comment"># 启动Apache服务器</span>
/etc/init.d/apache2 start
<span class="token comment"># 启动MySQL数据库</span>
find /var/lib/mysql <span class="token punctuation">-</span>type f <span class="token punctuation">-</span>exec touch <span class="token punctuation">{</span><span class="token punctuation">}</span> ; <span class="token important">&amp;&amp;</span> service mysql start
<span class="token comment"># 定义SQL文件路径</span>
sqlfile=/var/www/html/includeAirline.sql
if <span class="token punctuation">[</span> <span class="token punctuation">-</span>f $flagfile <span class="token punctuation">]</span>; then
	<span class="token comment"># 修改MySQL的密码</span>
    mysqladmin <span class="token punctuation">-</span>u root password "root"
    <span class="token comment"># 登录MySQL并导入SQL文件执行</span>
    mysql <span class="token punctuation">-</span>uroot <span class="token punctuation">-</span>proot &lt; $sqlfile
    <span class="token comment"># 删除SQL文件</span>
    rm <span class="token punctuation">-</span>f $sqlfile
fi
<span class="token comment"># 此处注意，如果命令执行完后脚本退出</span>
<span class="token comment"># 则Docker容器也会因为没有前台应用运行而中止</span>
<span class="token comment"># 所以这里使用一个前台命令来保活Docker容器</span>
tail <span class="token punctuation">-</span>f /var/log/apache2/error.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="实例二：PHP环境配置：">实例二：PHP环境配置：</h3>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 来源镜像，自带Apache+PHP环境</span>
FROM php<span class="token punctuation">:</span>7.0<span class="token punctuation">-</span>apache
MAINTAINER tl
ENV REFRESHED_AT 2018‐08‐03
ENV LANG C.UTF‐8
<span class="token comment"># ADD命令在COPY命令的基础上，具有自动解包tar的功能</span>
ADD web_tired.tar /var/www/html/
EXPOSE 80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="实例三：LTMJ（Linux-Tomcat-MySQL-JSP）环境配置">实例三：LTMJ（Linux+Tomcat+MySQL+JSP）环境配置</h3>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">FROM ubuntu<span class="token punctuation">:</span><span class="token number">16.04</span>
MAINTAINER wrlu
ENV REFRESHED_AT 2018<span class="token punctuation">-</span>08<span class="token punctuation">-</span><span class="token number">05</span>
ENV LANG C.UTF<span class="token punctuation">-</span><span class="token number">8</span>
RUN apt<span class="token punctuation">-</span>get update <span class="token punctuation">-</span>y
RUN apt<span class="token punctuation">-</span>get <span class="token punctuation">-</span>y install mysql<span class="token punctuation">-</span>server
<span class="token comment"># 安装wget，因为Docker提供的镜像是最小镜像，所以用到的其他工具需要自行安装</span>
RUN apt<span class="token punctuation">-</span>get <span class="token punctuation">-</span>y install wget
<span class="token comment"># 安装Java 8</span>
RUN apt<span class="token punctuation">-</span>get <span class="token punctuation">-</span>y install openjdk<span class="token punctuation">-</span>8<span class="token punctuation">-</span>jre
<span class="token comment"># 下载Tomcat 8服务器</span>
RUN wget http<span class="token punctuation">:</span>//mirrors.hust.edu.cn/apache/tomcat/tomcat<span class="token punctuation">-</span>8/v8.5.32/bin/apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>8.5.32.tar.gz
<span class="token comment"># 解压tar.gz</span>
RUN tar <span class="token punctuation">-</span>xzf apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>8.5.32.tar.gz <span class="token punctuation">-</span>C /root
RUN mv /root/apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>8.5.32 /root/tomcat
<span class="token comment"># 删除默认页面</span>
RUN rm <span class="token punctuation">-</span>rf /root/tomcat/webapps/*
<span class="token comment"># 拷贝war文件</span>
COPY CAAC<span class="token punctuation">-</span>SQL<span class="token punctuation">-</span>Injection.war /root/tomcat/webapps/
COPY wafwtf.sql /root/
COPY start.sh /root/start.sh
RUN chmod +x /root/start.sh
ENTRYPOINT cd /root; ./start.sh
<span class="token comment"># Tomcat使用8080端口，不同于Apache</span>
EXPOSE 8080<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>启动脚本如下：</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#!/bin/bash</span>
sleep 1
find /var/lib/mysql <span class="token punctuation">-</span>type f <span class="token punctuation">-</span>exec touch <span class="token punctuation">{</span><span class="token punctuation">}</span> ; <span class="token important">&amp;&amp;</span> service mysql start
chmod +x /root/tomcat/bin/startup.sh
<span class="token comment"># 启动Tomcat服务器</span>
/root/tomcat/bin/startup.sh
sqlfile=/root/wafwtf.sql
if <span class="token punctuation">[</span> <span class="token punctuation">-</span>f $flagfile <span class="token punctuation">]</span>; then
    mysqladmin <span class="token punctuation">-</span>u root password "root"
    mysql <span class="token punctuation">-</span>uroot <span class="token punctuation">-</span>proot &lt; $sqlfile
    rm <span class="token punctuation">-</span>f $sqlfile
fi
<span class="token comment"># 容器保活</span>
tail <span class="token punctuation">-</span>f /root/tomcat/conf/server.xml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>MySQL</tag>
        <tag>Docker</tag>
        <tag>LAMP</tag>
        <tag>PHP</tag>
        <tag>Tomcat</tag>
        <tag>JSP</tag>
        <tag>教程</tag>
      </tags>
  </entry>
  <entry>
    <title>Gitlab的安装及使用教程完全版</title>
    <url>/posts/acc13b70/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-Gitlab概述">1. Gitlab概述</h2>
<hr>
<h3 id="1-1-GitLab介绍-2">1.1 GitLab介绍</h3>
<p>GitLab是利用Ruby on Rails一个开源的版本管理系统，实现一个自托管的Git项目仓库，可通过Web界面进行访问公开的或者私人项目。</p>
<p>GitLab能够浏览源代码，管理缺陷和注释。可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库。团队成员可以利用内置的简单聊天程序(Wall)进行交流。</p>
<p>它还提供一个代码片段收集功能可以轻松实现代码复用，便于日后有需要的时候进行查找</p>
<h3 id="1-2-Gitlab服务构成-2">1.2 Gitlab服务构成</h3>
<p>Nginx：静态web服务器。</p>
<p>gitlab-shell：用于处理Git命令和修改authorized keys列表。</p>
<p>gitlab-workhorse: 轻量级的反向代理服务器。</p>
<p>logrotate：日志文件管理工具。</p>
<p>postgresql：数据库。</p>
<p>redis：缓存数据库。</p>
<p>sidekiq：用于在后台执行队列任务（异步执行）。</p>
<p>unicorn：An HTTP server for Rack applications，GitLab Rails应用是托管在这个服务器上面的。</p>
<h3 id="1-3-Gitlab工作流程-2">1.3 Gitlab工作流程</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222044.png" alt=""></p>
<h3 id="1-4-GitLab-Shell-2">1.4 GitLab Shell</h3>
<p>GitLab Shell有两个作用：为GitLab处理Git命令、修改authorized keys列表</p>
<p>当通过SSH访问GitLab Server时，GitLab Shell会：</p>
<ul>
<li>限制执行预定义好的Git命令（git push，git pull，git annex）</li>
<li>调用GitLab Rails API检查权限</li>
<li>执行pre-receive钩子（在企业版中叫做Git钩子）</li>
<li>执行用户请求的动作，处理GitLab的post-receive动作</li>
<li>处理自定义的post-receive动作</li>
</ul>
<p>当通过http(s)访问GitLab Server时，工作流程取决于你是从Git仓库拉取(pull)代码还是向git仓库推送(push)代码：</p>
<p>如果是从Git仓库拉取(pull)代码，GitLab Rails应用会全权负责处理用户鉴权和执行Git命令的工作</p>
<p>如果是向Git仓库推送(push)代码，GitLab Rails应用既不会进行用户鉴权也不会执行Git命令，它会把以下工作交由GitLab Shell进行处理：</p>
<ul>
<li>调用GitLab Rails API 检查权限</li>
<li>执行pre-receive钩子（在GitLab企业版中叫做Git钩子）</li>
<li>执行你请求的动作</li>
<li>处理GitLab的post-receive动作</li>
<li>处理自定义的post-receive动作</li>
</ul>
<h3 id="1-5-GitLab-Workhorse-2">1.5 GitLab Workhorse</h3>
<p>GitLab Workhorse是一个敏捷的反向代理。它会处理一些大的HTTP请求，比如文件上传、文件下载、Git push/pull和Git包下载。其它请求会反向代理到GitLab Rails应用，即反向代理给后端的unicorn。</p>
<h2 id="2-Gitlab的安装部署">2. Gitlab的安装部署</h2>
<ul>
<li>Gitlab要求服务器内存2G以上</li>
</ul>
<h3 id="2-1-方式一-下载gitlab-ce的rpm包-2">2.1 方式一:下载gitlab-ce的rpm包</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://packages.gitlab.com/gitlab/gitlab-ce">gitlab官方rpm包下载</a></li>
<li><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/">清华的源</a></li>
</ul>
<p>将对应版本的gitlab-ce下载到本地后，直接yum安装即可</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 要先将这个rpm包下载到本地</span>
yum <span class="token function">install</span> -y gitlab-ce-13.6.1-ce.0.el7.x86_64.rpm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="2-2-方式二-配置yum源-2">2.2 方式二:配置yum源</h3>
<p>在 /etc/yum.repos.d/ 下新建 gitlab-ce.repo，写入如下内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>gitlab-ce<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>gitlab-ce
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/
<span class="token assign-left variable">Repo_gpgcheck</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">Enabled</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">Gpgkey</span><span class="token operator">=</span>https://packages.gitlab.com/gpg.key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后创建cache，再直接安装gitlab-ce</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum makecache  <span class="token comment"># 这一步会创建大量的数据</span>
 
<span class="token comment"># 直接安装最新版</span>
yum <span class="token function">install</span> -y gitlab-ce
 
<span class="token comment"># 如果要安装指定的版本，在后面填上版本号即可</span>
yum <span class="token function">install</span> -y  gitlab-ce-13.6.1
 
<span class="token comment"># 如果安装时出现gpgkey验证错误，只需在安装时明确指明不进行gpgkey验证</span>
yum <span class="token function">install</span> gitlab-ce -y --nogpgcheck<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-2-1-单服务启动模式"><strong>2.2.1. 单服务启动模式</strong></h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run -d --name gitlab --hostname gitlab.example.com <span class="token punctuation">\</span>
-e <span class="token assign-left variable">GITLAB_OMNIBUS_CONFIG</span><span class="token operator">=</span><span class="token string">"
    external_url 'https://gitlab.example.com'
    gitlab_rails['gitlab_shell_ssh_port'] = 22
    nginx['redirect_http_to_https'] = true
    nginx['ssl_dhparam'] = '/etc/gitlab/ssl/dhparam.pem'
    nginx['ssl_certificate'] = '/etc/gitlab/ssl/domain.crt'
    nginx['ssl_certificate_key'] = '/etc/gitlab/ssl/domain.key'
    nginx['custom_gitlab_server_config'] = 'location ^~ /.well-known {<span class="token entity" title="\n">\n</span> alias /var/opt/gitlab/letsencrypt/.well-known;<span class="token entity" title="\n">\n</span>}<span class="token entity" title="\n">\n</span>'
    high_availability['mountpoint'] = ['/etc/gitlab', '/var/log/gitlab' '/var/opt/gitlab'  # 严格限定gitlab服务启动前，指定文件系统挂完毕
"</span> <span class="token punctuation">\</span>
-p <span class="token number">22</span>:22 -p <span class="token number">80</span>:80 -p <span class="token number">443</span>:443 <span class="token punctuation">\</span>
-v /srv/gitlab/config:/etc/gitlab <span class="token punctuation">\</span>
-v /srv/gitlab/logs:/var/log/gitlab <span class="token punctuation">\</span>
-v /srv/gitlab/data:/var/opt/gitlab <span class="token punctuation">\</span>
-v /etc/certs:/etc/gitlab/ssl <span class="token punctuation">\</span>
--restart<span class="token operator">=</span>always gitlab/gitlab-ce:latest
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-2-1-Compose服务编排模式-推荐方式"><strong>2.2.1. Compose服务编排模式(推荐方式)</strong></h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> pull gitlab/gitlab-ce:latest
 
<span class="token comment">############################ 多行命令开始 ##########################</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> docker-compose.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
version: '2'
 
services:
 
  Gitlab:
    image: 'gitlab/gitlab-ce:latest'
    container_name: 'gitlab'
    hostname: 'gitlab.example.com'
    restart: always
    ports:
      - '22:22'
      - '80:80'
      - '443:443'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # Add any other gitlab.rb configuration here, each on its own line
        external_url 'https://gitlab.example.com'
        gitlab_rails['gitlab_shell_ssh_port'] = 22
        nginx['redirect_http_to_https'] = true
        nginx['ssl_dhparam'] = "/etc/gitlab/ssl/dhparam.pem"
        nginx['ssl_certificate'] = "/etc/gitlab/ssl/domain.crt"
        nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/domain.key"
        nginx['custom_gitlab_server_config'] = "location ^~ /.well-known {<span class="token entity" title="\n">\n</span> alias /var/opt/gitlab/letsencrypt/.well-known;<span class="token entity" title="\n">\n</span>}<span class="token entity" title="\n">\n</span>"
        high_availability['mountpoint'] = ["/etc/gitlab", "/var/log/gitlab", "/var/opt/gitlab"]  # 严格限定gitlab服务启动前，指定文件系统挂完毕
    volumes:
      - /srv/gitlab/config:/etc/gitlab
      - /srv/gitlab/logs:/var/log/gitlab
      - /srv/gitlab/data:/var/opt/gitlab
      - /etc/certs:/etc/gitlab/ssl
EOF</span>
<span class="token comment">############################ 多行命令结束 ##########################</span>
 
<span class="token comment"># 启动服务</span>
<span class="token function">docker-compose</span> -f docker-compose.yaml up -d
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-3-gitlab的配置-2">2.3 gitlab的配置</h3>
<p>配置文件位置  /etc/gitlab/gitlab.rb</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 test<span class="token punctuation">]</span><span class="token comment"># vim /etc/gitlab/gitlab.rb</span>
 
<span class="token punctuation">[</span>root@centos7 test<span class="token punctuation">]</span><span class="token comment"># grep "^[a-Z]" /etc/gitlab/gitlab.rb</span>
 
external_url <span class="token string">'http://10.0.0.51'</span>  <span class="token comment"># 这里一定要加上http://</span>
 
<span class="token comment"># 配置邮件服务</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_address'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"smtp.qq.com"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">25</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_user_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hgzerowzh@qq.com"</span>  <span class="token comment"># 自己的qq邮箱账号</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_password'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"xxx"</span>  <span class="token comment"># 开通smtp时返回的授权码</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_domain'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"qq.com"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_authentication'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"login"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable_starttls_auto'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_tls'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_from'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hgzerowzh@qq.com"</span>  <span class="token comment"># 指定发送邮件的邮箱地址</span>
user<span class="token punctuation">[</span><span class="token string">"git_user_email"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"shit@qq.com"</span>   <span class="token comment"># 指定接收邮件的邮箱地址</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>修改好配置文件后，要使用 gitlab-ctl reconfigure 命令重载一下配置文件，否则不生效。</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitlab-ctl reconfigure <span class="token comment"># 重载配置文件</span>
gitlab-ctl restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="测试邮件服务器">测试邮件服务器</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitlab-rails console
Notify.test_email<span class="token punctuation">(</span><span class="token string">'rollinghell@foxmail.com'</span>,<span class="token string">'testbiaoti'</span>,<span class="token string">'testzhegnwen1'</span><span class="token punctuation">)</span>.deliver_now<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@test102 ~<span class="token punctuation">]</span><span class="token comment"># gitlab-rails console</span>
--------------------------------------------------------------------------------
 GitLab:       <span class="token number">12.5</span>.0 <span class="token punctuation">(</span>1f0ab8978ef<span class="token punctuation">)</span>
GitLab Shell: <span class="token number">10.2</span>.0
 PostgreSQL:   <span class="token number">10.9</span>
--------------------------------------------------------------------------------
Loading production environment <span class="token punctuation">(</span>Rails <span class="token number">5.2</span>.3<span class="token punctuation">)</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:001:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> Notify.test_email<span class="token punctuation">(</span><span class="token string">'andycrusoe@gmail.com'</span>,<span class="token string">'test'</span>,<span class="token string">'test'</span><span class="token punctuation">)</span>.deliver_now
Notify<span class="token comment">#test_email: processed outbound mail in 1.4ms</span>
Sent mail to anliven@126.com <span class="token punctuation">(</span><span class="token number">73</span>.0ms<span class="token punctuation">)</span>
Date: Wed, <span class="token number">27</span> Nov <span class="token number">2019</span> <span class="token number">15</span>:12:58 +0800
From: GitLab <span class="token operator">&lt;</span>gitlab@192.168.16.10<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>
Reply-To: GitLab <span class="token operator">&lt;</span>noreply@192.168.16.10<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>
To: anliven@126.com
Message-ID: <span class="token operator">&lt;</span>5dde21fa612d4_3a1b3fcb38fcf9c0651b@test102.mail<span class="token operator">&gt;</span>
Subject: <span class="token builtin class-name">test</span>
Mime-Version: <span class="token number">1.0</span>
Content-Type: text/html<span class="token punctuation">;</span>
<span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8
Content-Transfer-Encoding: 7bit
Auto-Submitted: auto-generated
X-Auto-Response-Suppress: All
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html PUBLIC <span class="token string">"-//W3C//DTD HTML 4.0 Transitional//EN"</span> <span class="token string">"http://www.w3.org/TR/REC-html40/loose.dtd"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>test<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;Mail::Message:70141649239780, Multipart: false, Headers: &lt;Date: Wed, 27 Nov 2019 15:12:58 +0800&gt;, &lt;From: GitLab &lt;gitlab@192.168.16.102&gt;&gt;, &lt;Reply-To: GitLab &lt;noreply@192.168.16.102&gt;&gt;, &lt;To: anliven@126.com&gt;, &lt;Message-ID: &lt;5dde21fa612d4_3a1b3fcb38fcf9c0651b@test102.mail&gt;&gt;, &lt;Subject: test&gt;, &lt;Mime-Version: 1.0&gt;, &lt;Content-Type: text/html; charset=UTF-8&gt;, &lt;Content-Transfer-Encoding: 7bit&gt;, &lt;Auto-Submitted: auto-generated&gt;, &lt;X-Auto-Response-Suppress: All&gt;&gt;</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:002:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:003:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> <span class="token builtin class-name">exit</span>
<span class="token punctuation">[</span>root@test102 ~<span class="token punctuation">]</span><span class="token comment">#</span>
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="配置gitlab代理">配置gitlab代理</h4>
<p>https://docs.gitlab.com/omnibus/settings/environment-variables.html</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitaly<span class="token punctuation">[</span><span class="token string">'env'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"http_proxy"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"http://USERNAME:PASSWORD@example.com:8080"</span>,
    <span class="token string">"https_proxy"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"http://USERNAME:PASSWORD@example.com:8080"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-4-Gitlab常用命令-2">2.4 Gitlab常用命令</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitlab-ctl start         <span class="token comment"># 启动所有 gitlab 组件</span>
gitlab-ctl stop          <span class="token comment"># 停止所有 gitlab 组件</span>
gitlab-ctl restart       <span class="token comment"># 重启所有 gitlab 组件</span>
gitlab-ctl status        <span class="token comment"># 查看服务状态</span>
 
gitlab-ctl reconfigure   <span class="token comment"># 启动服务</span>
gitlab-ctl show-config   <span class="token comment"># 验证配置文件</span>
 
gitlab-ctl <span class="token function">tail</span>          <span class="token comment"># 查看日志</span>
 
gitlab-rake gitlab:check <span class="token assign-left variable">SANITIZE</span><span class="token operator">=</span>true --trace    <span class="token comment"># 检查gitlab</span>
 
<span class="token function">vim</span> /etc/gitlab/gitlab.rb <span class="token comment"># 修改默认的配置文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-5-gitlab-ctl常用命令介绍">2.5 gitlab-ctl常用命令介绍</h3>
<table>
<thead>
<tr>
<th style="text-align:right">命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">check-config</td>
<td>检查在gitlab中是否有任何配置。在指定版本中删除的rb</td>
</tr>
<tr>
<td style="text-align:right">deploy-page</td>
<td>安装部署页面</td>
</tr>
<tr>
<td style="text-align:right">diff-config</td>
<td>将用户配置与包可用配置进行比较</td>
</tr>
<tr>
<td style="text-align:right">remove-accounts</td>
<td>删除所有用户和组</td>
</tr>
<tr>
<td style="text-align:right">upgrade</td>
<td>升级</td>
</tr>
<tr>
<td style="text-align:right">service-list</td>
<td>查看所有服务</td>
</tr>
<tr>
<td style="text-align:right">once</td>
<td>如果GitLab服务停止了就启动服务，如果已启动就不做任何操作</td>
</tr>
<tr>
<td style="text-align:right">restart</td>
<td>重启GitLab服务</td>
</tr>
<tr>
<td style="text-align:right">start</td>
<td>如果GitLab服务停止了就启动服务，如果已启动就重启服务</td>
</tr>
<tr>
<td style="text-align:right">stop</td>
<td>停止GitLab服务</td>
</tr>
<tr>
<td style="text-align:right">status</td>
<td>查看GitLab服务状态</td>
</tr>
<tr>
<td style="text-align:right">reconfigure</td>
<td>重新配置GitLab并启动</td>
</tr>
</tbody>
</table>
<h2 id="3-Gitlab的使用">3. Gitlab的使用</h2>
<ul>
<li>Gitlab安装好后，设置密码，管理账户为root</li>
</ul>
<h3 id="3-1-创建Group-2"><strong>3.1 创建Group</strong></h3>
<ul>
<li>填上组名即可，这里组名为java</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222105.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164637.png" alt=""></p>
<h3 id="3-2-创建User-2"><strong>3.2 创建User</strong></h3>
<ul>
<li>创建四个User：pm、dev1、dev2、dev3</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222131.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222120.png" alt=""></p>
<h3 id="3-3-添加User到Group中并授权-2"><strong>3.3 添加User到Group中并授权</strong></h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222140.png" alt=""></p>
<h3 id="3-4-创建Project并配置SSH-2"><strong>3.4 创建Project并配置SSH</strong></h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222147.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222154.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222201.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528222233.png" alt=""></p>
<h3 id="3-5-在项目中添加成员-2"><strong>3.5 在项目中添加成员</strong></h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164730.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164804.png" alt=""></p>
<h3 id="3-6-将本地文件推送到Gitlab-2">3.6 将本地文件推送到Gitlab</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将app01项目克隆下来</span>
<span class="token function">git</span> clone git@10.0.0.51:java/app01.git
 
<span class="token comment"># 初始化配置</span>
<span class="token function">git</span> config --global user.name <span class="token string">"hgzero"</span>
<span class="token function">git</span> config --global user.email <span class="token string">"hgzero@qq.com"</span>
 
<span class="token comment"># 在app01目录下新建一些文件</span>
 
<span class="token comment"># 推送到gitlab</span>
<span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit -m <span class="token string">"first edition"</span>
<span class="token function">git</span> push origin master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164823.png" alt=""></p>
<h2 id="4-制定开发计划">4. 制定开发计划</h2>
<h3 id="4-1-创建开发计划-2"><strong>4.1 创建开发计划</strong></h3>
<ul>
<li>项目：app01</li>
<li>版本：v1.0</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802173643.png" alt=""></p>
<h3 id="4-2-创建里程碑Milestones-2"><strong>4.2 创建里程碑Milestones</strong></h3>
<ul>
<li>用pm账号登录gitlab后操作（先要在admin中设置pm账号的密码）</li>
<li>要根据开发计划来创建Milestones</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164839.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164935.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164956.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802165053.png" alt=""></p>
<h3 id="4-3-根据开发计划创建issue-2">4.3 根据开发计划创建issue</h3>
<ul>
<li>创建4个issue，分派给dev1和dev2这两个开发人员</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802165109.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802165138.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802165158.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802165215.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802165238.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802165257.png" alt=""></p>
<h3 id="4-4-开发者登录账号查看分派的任务-2">**4.4 开发者登录账号查看分派的任务 **</h3>
<ul>
<li>然后开发dev1登录gitlab，就能看到任务已经分配过来了</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802165316.png" alt=""></p>
<h3 id="4-5-开发流程-2"><strong>4.5 开发流程</strong></h3>
<ul>
<li>公司里的开发开始任务</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 1. 先从仓库把项目拉下来</span>
<span class="token function">git</span> clone git@10.0.0.51:java/app01.git
<span class="token builtin class-name">cd</span> app01/
 
<span class="token comment"># 2.先创建一个自己的分支，然后进行开发</span>
<span class="token function">git</span> checkout -b index   <span class="token comment"># 创建一个叫index的分支，并切换到这个分支</span>
<span class="token function">git</span> status
 
<span class="token comment"># 3. 开始开发首页</span>
<span class="token builtin class-name">echo</span> <span class="token string">"&lt;h1&gt;welcome to this app&lt;/h1&gt;"</span> <span class="token operator">&gt;</span> index.html  <span class="token comment"># 假设就开发了一个index页面</span>
 
<span class="token comment"># 4. 开发完成后，把项目传到仓库</span>
<span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit -m <span class="token string">"index"</span>
<span class="token comment"># 如果写成 git commit -m "close #2" ，则表示merge请求允许且merge成功之后，自动删除编号为#2的issue</span>
 
<span class="token comment"># 传到index分支</span>
<span class="token function">git</span> push origin index<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-6-合并分支-2"><strong>4.6 合并分支</strong></h3>
<p><strong>1）开发dev1发送合并分支请求给pm</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802165333.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802165341.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802165350.png" alt=""></p>
<p><strong>2）pm收到开发的Merge请求后进行处理</strong></p>
<ul>
<li>使用pm登录，就可以看到pm已经收到了合并请求merge request</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802165452.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802165505.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802165423.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164313.png" alt=""></p>
<p><strong>3）开发dev1确认任务完成</strong></p>
<ul>
<li>退出pm账户，登入dev1账户：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164301.png" alt=""></p>
<ul>
<li>或者点进去后，在侧边栏进行标识Done，然后已经完成的issue，可以将其Close</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164248.png" alt=""></p>
<ul>
<li>这个时候Milestones的进度已经往前进了一些了：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164237.png" alt=""></p>
<h3 id="4-7-开发其他功能-2">4.7 开发其他功能</h3>
<ul>
<li>然后其他开发者或者自己再次进行开发时，先要把刚刚更新后的内容（master主干）拉回来，然后再进行开发</li>
</ul>
<p>git checkout master  # 切换到master<br>
git pull             # 从远端仓库拉取数据<br>
# 然后再进行其他操作</p>
<h2 id="5-Gitlab备份恢复">5. Gitlab备份恢复</h2>
<h3 id="5-1-备份gitlab-2">5.1 备份gitlab</h3>
<p><strong>1）修改配置文件</strong></p>
<ul>
<li><strong>/etc/gitlab/gitlab.rb</strong></li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 备份保存的位置，这里是默认位置，可修改成指定的位置</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'backup_path'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/var/opt/gitlab/backups"</span>
 
<span class="token comment"># 设置备份保存的时间，超过此时间的日志将会被新覆盖</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'backup_keep_time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">604800</span>  <span class="token comment"># 这里是默认设置，保存7天</span>
 
<span class="token comment"># 特别注意：</span>
<span class="token comment">#     如果自定义了备份保存位置，则要修改备份目录的权限，比如：</span>
<span class="token comment">#     chown -R git.git /data/backup/gitlab</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>配置完成后要重启以使配置生效</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 重读配置文件</span>
gitlab-ctl reconfigure
 
<span class="token comment"># 重启gitlab</span>
gitlab-ctl restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>2）设置定时任务</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 每天凌晨2点定时创建备份</span>
<span class="token comment"># 将一下内容写入到定时任务中 crontab -e</span>
<span class="token number">0</span> <span class="token number">2</span> * * * /usr/bin/gitlab-rake gitlab:backup:create
 
<span class="token comment"># 备份策略建议：</span>
<span class="token comment">#     本地保留3到7天，在异地备份永久保存</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>3）备份时间的识别</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 备份后的文件类似这样的形式：1494170842_gitlab_backup.tar，可以根据前面的时间戳确认备份生成的时间</span>
 
data  -d  @1494170842<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="5-2-恢复gitlab-2">5.2 恢复gitlab</h3>
<h4 id="1）停止停止相关数据连接-数据写入服务"><strong>1）停止停止相关数据连接,数据写入服务</strong></h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 停止数据写入服务</span>
gitlab-ctl stop puma
gitlab-ctl stop sidekiq<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="2）进行数据恢复并重启"><strong>2）进行数据恢复并重启</strong></h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 进行恢复</span>
gitlab-rake gitlab:backup:restore <span class="token assign-left variable">BACKUP</span><span class="token operator">=</span>1627839447_2021_08_01_14.1.1-ee  <span class="token comment"># 这个时间戳就是刚刚备份的文件前面的时间戳</span>
 
<span class="token comment"># 重启</span>
gitlab-ctl restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="6-gitlab邮件通知配置">6. gitlab邮件通知配置</h2>
<ul>
<li>vim  /etc/gitlab/gitlab.rb</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitlab_rails<span class="token punctuation">[</span><span class="token string">'time_zone'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Asia/Shanghai'</span>
 
gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_enabled'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_from'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'example@163.com'</span> <span class="token comment"># 填写发件人的邮箱地址</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_display_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'gitlab'</span>
 
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_address'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"smtp.163.com"</span>  <span class="token comment"># smtp服务器的地址,如网易的地址</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">25</span>                 <span class="token comment"># 要注意如果使用了SSL/TLS的话,端口可能不是25</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_user_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"smtp用户名"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_password'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"smtp用户密码"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_domain'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"163.com"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_authentication'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"login"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>启用邮件功能</strong><br>
Gitlab 的 Compose 配置 <code>GITLAB_OMNIBUS_CONFIG</code> 节点下增加如下几行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">########## 邮件服务配置 ##########</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_address'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"smtp.exmail.qq.com"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">465</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_tls'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_user_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"账号"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_password'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"密码"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_authentication'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"login"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable_starttls_auto'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span> 
gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_from'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"发件人邮箱"</span>
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="7-使用SourceTree进行项目开发">7. 使用SourceTree进行项目开发</h2>
<hr>
<h3 id="7-1-项目拉取-2">7.1 项目拉取</h3>
<ul>
<li>先把项目克隆下来</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164210.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164157.png" alt=""></p>
<ul>
<li>如果ssh的方式克隆失败，可能是因为SSH Key没找到，可以在这里添加</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164146.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164132.png" alt=""></p>
<h3 id="7-2-创建分支进行功能开发-2">7.2 创建分支进行功能开发</h3>
<p><strong>1）新建立一个叫“pay”的分支</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164122.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164113.png" alt=""></p>
<p><strong>2）进行功能开发</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164103.png" alt=""></p>
<h3 id="7-3-提交项目-2">7.3 提交项目</h3>
<p><strong>1）开发pay功能完成后进行提交</strong></p>
<ul>
<li>可以看到SourceTree中已经有“未提交的更改”</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164054.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164042.png" alt=""></p>
<p><strong>2）添加“用户信息”</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164029.png" alt=""></p>
<p>** 3）进行提交**</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164014.png" alt=""></p>
<ul>
<li>注释也可以写成  close #3    ，作用是提交完成后关闭3号issue</li>
</ul>
<h3 id="7-4-推送到仓库-2"><strong>7.4 推送到仓库</strong></h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802164002.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802163947.png" alt=""></p>
<ul>
<li>然后就可以在gitlab上进行发送merge请求了，后面就可以进行其他操作了</li>
</ul>
<h3 id="7-5-项目上线-2">7.5 项目上线</h3>
<p><strong>1）当所有工作完成之后，就可以进行上线了</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802163932.png" alt=""></p>
<p><strong>2）打标签</strong></p>
<ul>
<li>上线先打个标签</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802163916.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802163907.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/05/2820210528225256.png" alt=""></p>
<p>** 3）删除无用分支**</p>
<ul>
<li>然后删除已经合并到主干中的不必要的分支，如index、pay等</li>
<li>最后一定要注意时间一定要同步，不然会错乱</li>
</ul>
<h2 id="8-Gitlab调优"><strong>8. Gitlab调优</strong></h2>
<p>gitlab对内存资源的消耗比较厉害<br>
其中尤以 sidekiq队列 及 unicorn服务 两个组件对内存消耗最多<br>
可以再容器启动时对相关参数进行微调：</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">unicorn<span class="token punctuation">[</span><span class="token string">'worker_processes'</span><span class="token punctuation">]</span> = 1
unicorn<span class="token punctuation">[</span><span class="token string">'worker_memory_limit_min'</span><span class="token punctuation">]</span> = "300 * 1 &lt;&lt; 20"
unicorn<span class="token punctuation">[</span><span class="token string">'worker_memory_limit_max'</span><span class="token punctuation">]</span> = "400 * 1 &lt;&lt; 20"
unicorn<span class="token punctuation">[</span><span class="token string">'worker_timeout'</span><span class="token punctuation">]</span> = 15
sidekiq<span class="token punctuation">[</span><span class="token string">'concurrency'</span><span class="token punctuation">]</span> = 10
sidekiq_cluster<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> = false
sidekiq_cluster<span class="token punctuation">[</span><span class="token string">'ha'</span><span class="token punctuation">]</span> = false
redis<span class="token punctuation">[</span><span class="token string">'maxclients'</span><span class="token punctuation">]</span> = "100"
nginx<span class="token punctuation">[</span><span class="token string">'worker_processes'</span><span class="token punctuation">]</span> = 2
nginx<span class="token punctuation">[</span><span class="token string">'worker_connections'</span><span class="token punctuation">]</span> = 512
nginx<span class="token punctuation">[</span><span class="token string">'keepalive_timeout'</span><span class="token punctuation">]</span> = 300
nginx<span class="token punctuation">[</span><span class="token string">'cache_max_size'</span><span class="token punctuation">]</span> = '200m'
mattermost<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> = false
mattermost_nginx<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> = false
gitlab_pages<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> = false
pages_nginx<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> = false
postgresql<span class="token punctuation">[</span><span class="token string">'shared_buffers'</span><span class="token punctuation">]</span> = "256MB"
postgresql<span class="token punctuation">[</span><span class="token string">'max_connections'</span><span class="token punctuation">]</span> = 30
postgresql<span class="token punctuation">[</span><span class="token string">'work_mem'</span><span class="token punctuation">]</span> = "8MB"
postgresql<span class="token punctuation">[</span><span class="token string">'maintenance_work_mem'</span><span class="token punctuation">]</span> = "16MB"
postgresql<span class="token punctuation">[</span><span class="token string">'effective_cache_size'</span><span class="token punctuation">]</span> = "1MB"
postgresql<span class="token punctuation">[</span><span class="token string">'checkpoint_timeout'</span><span class="token punctuation">]</span> = "5min"
postgresql<span class="token punctuation">[</span><span class="token string">'checkpoint_warning'</span><span class="token punctuation">]</span> = "30s"
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置调整后需要重载一下</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> gitlab gitlab-ctl reconfigure
<span class="token function">docker-compose</span> down
<span class="token function">docker-compose</span> up -d
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="9-Gitlab-启用-ContainerRegistry">9. Gitlab 启用 ContainerRegistry</h2>
<ul>
<li><code>ContainerRegistry</code>是<code>Gitlab</code>内置的<code>Docker Registry</code>集成组件</li>
<li>集成后每个项目可获得私有的 <code>Docker</code> 镜像存储空间</li>
<li><code>ContainerRegistry</code> 可以复用 <code>Gitlab</code> 域名 或者 独立域名</li>
<li>这里配置为复用域名（此时<code>ContainerRegistry</code> 将复用 <code>Gitlab</code> 的 <code>TLS</code> 证书）</li>
</ul>
<ol>
<li><code>docker-compose.yaml</code>中Gitlab服务的 <code>GITLAB_OMNIBUS_CONFIG</code> 节点下增加如下配置：</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">registry_external_url <span class="token string">"https://gitlab.example.com:4567"</span>  <span class="token comment"># ContainerRegistry的外部访问地址</span>
registry_nginx<span class="token punctuation">[</span><span class="token string">'ssl_certificate'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/etc/gitlab/ssl/domain.crt"</span>
registry_nginx<span class="token punctuation">[</span><span class="token string">'ssl_certificate_key'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/etc/gitlab/ssl/domain.key"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'registry_host'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"gitlab.example.com"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'registry_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"4567"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'registry_api_url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"http://localhost:5000"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_default_projects_features_builds'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_default_projects_features_container_registry'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li>端口开放增加 <code>- 4567:4567</code></li>
<li>服务重启 <code>docker-compose restart Gitlab</code></li>
</ol>
<p><code>ContainerRegistry</code> 集成后可以通过 <code>Gitlab</code> 账户登录： <code>docker login gitlab.example.com:4567</code></p>
<hr>
<h2 id="日常维护命令">日常维护命令</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Gitlab维护</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> gitlab gitlab-ctl status  <span class="token comment"># gitlab各组件服务状态</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> gitlab gitlab-ctl start/restart/stop <span class="token punctuation">[</span>组件名<span class="token punctuation">]</span>  <span class="token comment"># gitlab所有组件的统一控制（其中Unicorn组件重启完成前GitLab会报502）</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> gitlab gitlab-ctl <span class="token function">tail</span> <span class="token punctuation">[</span>/var/log/gitlab下的某子目录<span class="token punctuation">]</span>  <span class="token comment"># 实时查看日志</span>
 
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> gitlab update-permissions  <span class="token comment"># 修复gitlab版本升级后出现的权限问题</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> gitlab gitlab-ctl reconfigure  <span class="token comment"># 重载配置</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> -t gitlab gitlab-rake gitlab:backup:create  <span class="token comment"># 创建备份</span>
 
<span class="token comment"># ContainerRegistry维护</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> gitlab gitlab-ctl registry-garbage-collect  <span class="token comment"># 垃圾回收，清理废弃layer（registry停机）</span>
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h3 id="Import-Repository-Repo-By-Url">Import Repository(Repo By Url)</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 账号密码若存在特殊字符则需要url编码</span>
https://username:password@host:port/group/project.git
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="10-GitLab重置用户名密码"><strong>10. GitLab重置用户名密码</strong></h2>
<p>打开终端，访问：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitlab-rails console<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>输入：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">user <span class="token operator">=</span> User.where<span class="token punctuation">(</span>id: <span class="token number">1</span><span class="token punctuation">)</span>.first
user.password<span class="token operator">=</span><span class="token string">'123456'</span>
user.password_confirmation <span class="token operator">=</span> <span class="token string">'123456'</span>
user.save<span class="token operator">!</span> <span class="token comment">#注意加上 “！”</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后退出命令行即可。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">quit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"> gitlab-rails console production 命令 开始初始化密码
<span class="token comment"># 在irb(main):001:0&gt; 后面通过 u=User.where(id:1).first 来查找与切换账号（User.all 可以查看所有用户）</span>
<span class="token comment"># 通过u.password='12345678'设置密码为12345678(这里的密码看自己喜欢)：</span>
<span class="token comment"># 通过u.password_confirmation='12345678' 再次确认密码</span>
<span class="token comment"># 通过 u.save!进行保存</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="11-HTTPS-SSL-支持"><strong>11. HTTPS SSL 支持</strong></h2>
<ul>
<li>
<p>nginx反向代理方式</p>
<ul>
<li>注意docker 内部没有ca支持， 需要手动添加</li>
</ul>
</li>
<li>
<p>域名提供商提供的免费证书</p>
<ul>
<li>这种证书直接用，如果是自签名证书，需要添加自己的ca root证书到服务器</li>
</ul>
</li>
</ul>
<h2 id="12-Gitlab恢复数据出现must-be-owner-of解决方法">12. Gitlab恢复数据出现must be owner of解决方法</h2>
<p>按正常Gitlab备份数据gitlab-rake gitlab:backup:create</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">ERROR: must be owner <span class="token keyword">of</span> extension plpgsql
ERROR: must be owner <span class="token keyword">of</span> <span class="token keyword">schema</span> <span class="token keyword">public</span>
ERROR: <span class="token keyword">schema</span> “<span class="token keyword">public</span>” already <span class="token keyword">exists</span>
ERROR: must be owner <span class="token keyword">of</span> <span class="token keyword">schema</span> <span class="token keyword">public</span>
ERROR: must be owner <span class="token keyword">of</span> extension plpgsql
WARNING: <span class="token keyword">no</span> <span class="token keyword">privileges</span> could be revoked <span class="token keyword">for</span> “<span class="token keyword">public</span>”
WARNING: <span class="token keyword">no</span> <span class="token keyword">privileges</span> could be revoked <span class="token keyword">for</span> “<span class="token keyword">public</span>”
WARNING: <span class="token keyword">no</span> <span class="token keyword">privileges</span> were granted <span class="token keyword">for</span> “<span class="token keyword">public</span>”
WARNING: <span class="token keyword">no</span> <span class="token keyword">privileges</span> were granted <span class="token keyword">for</span> “<span class="token keyword">public</span>”<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解决方法：</p>
<h4 id="1-修改postgresql配置">**1. 修改postgresql配置 **</h4>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">cd</span> /var/opt/gitlab/postgresql/data
$ <span class="token function">vi</span> /var/opt/gitlab/postgresql/data/postgresql.conf
listen_addresses <span class="token operator">=</span> <span class="token string">'*'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>找到listen_addresses = ” 改为listen_addresses = ‘*’</p>
<p>修改 /var/opt/gitlab/postgresql/data/pg_hba.conf<br>
在这个文件最后面加入</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">vi</span> /var/opt/gitlab/postgresql/data/pg_hba.conf
<span class="token builtin class-name">local</span>   all         all                               trust
<span class="token function">host</span>    all         all                               <span class="token number">127.0</span>.0.1/32 trust
<span class="token function">host</span>    all         all                               ::1/128 trust    <span class="token comment">#ipv6 可以不配置</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-重启gitlab生效"><strong>2. 重启gitlab生效</strong></h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitlab-ctl restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="3-修改gitlab账号为超级用户"><strong>3. 修改gitlab账号为超级用户</strong></h4>
<p>进入postgresql命令行</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /opt/gitlab/embedded/bin
<span class="token function">su</span> gitlab-psql
./psql -h <span class="token number">127.0</span>.0.1 gitlabhq_production<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>查看账户权限</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">\</span>du<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>执行修改gitlab用户为超级权限</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ALTER <span class="token environment constant">USER</span> gitlab WITH SUPERUSER<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>退出</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">\</span>q<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/0220210802135016.png" alt=""></p>
<h5 id="4-从1462989681编号备份中恢复">4. 从1462989681编号备份中恢复</h5>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitlab-rake gitlab:backup:restore <span class="token assign-left variable">BACKUP</span><span class="token operator">=</span><span class="token number">1462989681</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这样Gitlab恢复数据就不会再报must be owner of extension plpgsql错误。</p>
<h4 id="4-重启gitlab"><strong>4. 重启gitlab</strong></h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitlab-ctl restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>本文作者：夜法之书       写作不易，转载请注明来源地址！</p>
<h2 id="参考链接：">参考链接：</h2>
<ol>
<li>https://www.cnblogs.com/hgzero/p/14088215.html</li>
<li>http://www.51blogs.net/2017/11/10/1110113243.html</li>
<li>https://my.oschina.net/u/2400083/blog/808097</li>
</ol>
<hr>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>gitlab</category>
      </categories>
      <tags>
        <tag>Gitlab</tag>
        <tag>Git</tag>
        <tag>Docker</tag>
        <tag>教程</tag>
        <tag>Rigistry</tag>
        <tag>email</tag>
        <tag>https</tag>
        <tag>ssl</tag>
      </tags>
  </entry>
  <entry>
    <title>Debian Lenny Laptop安装记录</title>
    <url>/posts/b1fe1bb8/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="Debian-Lenny-Laptop安装记录">Debian Lenny Laptop安装记录</h2>
<p>这是一篇非常有历史的文章了，写了十多年了。只在个人google doc中公开共享过。时至今日，参考价值还是非常大的。</p>
<p>目的是完全采用Linux系统来完成所有工作。</p>
<p>这篇文章当年我写了一周，每个步骤都是实践后仔细记录的。</p>
<h2 id="摘-要">摘 要</h2>
<p>​        在现在电子信息化社会中，网络越来越重要，各种电子商务，网上银行，网络交友，SNS社区等越来越红火，各国政府都在进行电子信息化建设，准备网上办公，无纸化作业。信息化就是现代化的思想已经深入人心，然而信息化建设的基础硬件和软件：</p>
<p>硬件：CPU、主板、内存，硬盘等</p>
<p>软件：操作系统（Operate System如Linux,Windows,Mac OS等），浏览器(如Firefox，Opera，Maxthon，IE等)，文档处理（OpenOffice,WPS,Word等），媒体播放（Mplayer,Realplayer等），以及其它软件工具。</p>
<p>则是其中的重中之重，电子信息化社会信息安全最为关键。因为你不知道微软的Windows中给你预留了多少漏洞和后门，你不知道Intel或者AMD在它们生产的硬件中留下了什么缺陷，了解一点软硬件知识的人都知道，软件后门可以使微软进入你的电脑如同自己的电脑一样，微软可以看到所有你的文档，照片，工作生活的数据，你的电脑中的数据对微软而言没有任何秘密而言；硬件缺陷同样可以做后门用，甚至发送一段短码瞬间可以使你的电脑崩溃。可见安全多么重要，那么如何提高安全了？</p>
<p>​        答案就是使用开源！开源早已经形成了一套完整的套件，上面介绍的软件中每样的地一种都是开源工具，完全免费！而且开放源代码，你可以知道每行代码的作用，后门、间谍将不复存在！你常用的Windows工具每样Linux都有替代品，很多工具甚至本来就是Linux中移植到Windows中来的，如暴风影音，比特精灵，Vim，Emacs等。</p>
<p>​        本文简单的介绍了开源操作系统Debian的安装和配置，包括操作系统的安装、配置，常用工具的安装等详细过程，下文所叙全部经过测试，稳定运行。通过本文，您可以了解Linux操作系统大体组成结构，并且获得一部完全自己定制的操作系统！</p>
<p>[TOC]</p>
<h2 id="一：前言">一：前言</h2>
<h3 id="从今天开始做个Debianer">从今天开始做个Debianer</h3>
<p>刚从OpenSuSE 换过来的，感觉Debian非常强大。SuSE的yast2真的非常强大，刚离开yast感觉很痛苦，Novll的yast系统设置几乎在里面实现，它包括了系统硬件，软件设置，网络配置，服务器配置，各种系统设置等等。它把很多底层配置都接管了，使用SuSE的用户会发现SuSE比其他Linux发行版少很多配置文件。SuSE的yast2有命令行和图形界面两种操作方式，还有zypper这种完全命令行包管理工具。不过Debian的apt包管理更加强大，比zypper强大多了。</p>
<p>Debian以定制性非常强，运行稳定而著称，是最符合GNU精神的发行版，对各种硬件构架都支持，是世界上唯一一种几乎可以在所有硬件平台运行的操作系统。Ubuntu就是在Debian的基础上发行的衍生版。但是本人使用感觉Ubuntu的感觉不好，Ubuntu就像一个在Debian testing基础上优化过得Debian一样，而且阉割的厉害。不过正由于阉割的厉害，把用户管理的东西Ubuntu都自己设置了，Ubuntu才成为最容易操作的Linux操作系统，而且也是最流行的Linux操作系统。不过Ubuntu限制用户操作非常严，感觉这样很大程度上失去了Linux的自由，可定制等特性。对Linux新人来说一开始使用Debian会非常困难的，强烈建议对Linux包管理，运行结构了解大概后再开始使用Debian。</p>
<p>推荐的发行版有：</p>
<p><strong>OpenSuSE</strong>：优点是从Windows转过来几乎马上就可以上手，用户不需要改变多少使用习惯，并且图形界面非常华丽，号称是最华丽的Linux操作系统。默认的就比Windows XP漂亮多了，开启Compiz Fusion后的3D特效比Vista,Win 7都要漂亮。对一般用户家庭使用和办公使用完全可以满足要求。缺点就是国内源很少，官方源在国外比较慢，速度也不保证，升级只能是半夜了，不过采用DVD安装的话就没多大问题。SuSE的中文社区不完善也是一大缺点。</p>
<p><strong>Fedora</strong>：著名的Redhat公司出品，国内源非常多，中文化非常好，中文社区也非常活跃，很多问题可以直接中文搜出结果。缺点是对习惯Windows的用户来说，一开始就使用Fedora对大家的入门门坎比OpenSuSE高。</p>
<p><strong>Ubuntu</strong>：最流行的Linux发行版，使用非常简单，中文社区建设的非常好，源很多，缺点就是阉割的太厉害了。感觉这样的版本对深入了解Linux不好，个人看法，不过对非技术型用户使用到是个不错的选择。</p>
<p><strong>Debian</strong>是最自由，定制性最高的发行版，当然对用户的入门要求就更高了。但是，一经你上手了，那么就再别无他求。Debian的好是谁用谁知道！</p>
<p>刚用上Debian，总结下，下面可能有错误之处，希望大家指出来。参考了很多人的文章下来的，对他们表示感谢！</p>
<p>注意：本教程为</p>
<h2 id="二：安装Debian之前的准备工作">二：安装Debian之前的准备工作</h2>
<p>●   强烈建议新人刚开始装不要按《 Debian etch 简要安装指南》那篇文章来，特别是笔记本用户，除非你对你的硬件非常熟悉。建议大家安装的时候选择图形界面安装。安装的时候选择图形界面，把Base system,Loptop,Desktop都安装上，这样会少很多麻烦的，它装了多余的东西和服务还是等进入桌面后再自己删除比较好。发现这样安装还是非常干净的，比之SuSE，Fedora之类的发行版默认安装东西要少多了。</p>
<p>●   阵痛了好几天了，这几天重装了好多次Debian了，现在终于差不多了，3d打开了，系统很稳定。</p>
<p>笔记本是Dell Inspiron6400。</p>
<p>●   强烈建议大家装机之前看看debian的官方wiki</p>
<p>例如我，就看下面这个：</p>
<p>http://wiki.debian.org/InstallingDebianOn/Dell/Inspiron6400/lenny</p>
<p>●   大家的笔记本其他型号的话到下面网址找对应的型号</p>
<p>http://wiki.debian.org/InstallingDebianOn/</p>
<p>上面网址的参考下就可以了，有些问题很多种解决方法的。</p>
<h2 id="三：开始安装Debian">三：开始安装Debian</h2>
<h3 id="3-1：安装前的准备和安装方法选择">3.1：安装前的准备和安装方法选择</h3>
<p>debian提供了很多安装方法，有网络安装，光盘安装，U盘安装，硬盘安装等多种方法。这里介绍下载光盘安装，这是对大多数人来说最为方便的安装发放，下载第一张光盘CD或者DVD镜像准备刻录安装。</p>
<p>注意：先备份好重要的资料！比如copy到移动硬盘，或者其它主机上等以免错误的操作造成不必要的损失。</p>
<p>进入Bios中设置光驱第一启动，放入光盘，等加载内核界面过去后，就进入安装界面了。</p>
<h3 id="3-2：开始安装Debian">3.2：开始安装Debian</h3>
<ol>
<li>
<p>选择安装程序使用的语言，推荐选择English，选中文会装zhcon。</p>
</li>
<li>
<p>选择国家，首先选择 other ，然后在选择 Asia ，最后选上 China 。</p>
</li>
<li>
<p>选择键盘，直接默认就好了，也就是 American English ，如果你的不是美式键盘，就选择相应的键盘。</p>
</li>
<li>
<p>设置网络，如果是 DHCP ，填上主机名和所在的域名就好了，如果是静态 IP ，根据相应的填上就 OK。这里有无线网卡的朋友就有些郁闷了，记得先去下载你的无线驱动的deb包，放到u盘根目录插上usb结构，系统会自动安装你的无线驱动。（但是这里安装好了还是无法dhcp连上无线，我采用有线装的，不知道谁这里无线配成功了。装完系统后再使用＃apt-get install firmware-iwlwifi 也可以。）</p>
</li>
<li>
<p>磁盘分区，根据个人的情况进行。这里要小心了，如果你有重要的资料的话，推荐手动分区。</p>
</li>
<li>
<p>对分区进行确认后就开始安装基本的系统，等待一段时间。</p>
</li>
<li>
<p>然后就是设置 root 账户的密码，以及日常使用的一个账户名称和密码。</p>
</li>
<li>
<p>账户设置好后对源进行设置，这里推荐手工输入。选择最上面一项。</p>
</li>
</ol>
<p>○   输入：debian.cn99.com 或者：mirrors.163.com</p>
<p>○   目录就是/debian/   不需要改动。这两个其实都是一个源，我看到主机ip地址一样。这个应该是国内最快的源了。至少对大部分人来说。</p>
<ol start="9">
<li>
<p>根据个人的情况选择安装软件，推荐选择base system,laptop,desktop。</p>
</li>
<li>
<p>安装中，看网络状况时间不同，等待.........。</p>
</li>
<li>
<p>安装 GRUB ，Yes安装到 MBR。</p>
</li>
<li>
<p>安装完毕，最后 Continue 回车重启进入期待已久的 Debian Lenny GNU/Linux。</p>
</li>
</ol>
<h2 id="四：配置Debia的基本中文操作环境">四：配置Debia的基本中文操作环境</h2>
<p>他哦难过上面二、三步，到现在你已经获得了一个基本的Debian Lenny操作系统了。但是到现在为止说能够顺手使用还太早，在正是使用之前还有几个事情需要做。</p>
<p>（注意＃号提示的是root用户权限）</p>
<h3 id="4-1：中文语言环境">4.1：中文语言环境</h3>
<h4 id="4-1-1-重新配置locale，添加中文locale">4.1.1:重新配置locale，添加中文locale</h4>
<p>​        选择以下locale，以下为推荐语言环境，用户可以根据自己语言习惯自由选择：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#dpkg-reconfigure locales</span>
en_US ISO-8859-1
en_US.UTF-8 UTF-8
zh_CN GB2312
zh_CN.GB18030 GB18030
zh_CN.GBK GBK
zh_CN.UTF-8 UTF-8
zh_HK BIG5-HKSCS
zh_HK.UTF-8 UTF-8
zh_TW BIG5
zh_TW.EUC-TW EUC-TW
zh_TW.UTF-8 UTF-8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>选择默认的locale为en_US.UTF-8或者 zh_CN.UTF-8。</p>
<h4 id="4-1-2-安装localepurge">4.1.2:安装localepurge</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">＃apt-get <span class="token function">install</span> localepurge<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>​       在对话框中选择你要保留使用的locale，默认情况下它已经选好了你现前设置的那些locale，不过还是请仔细确认后再回车。当然你也可以使用 dpkg-reconfigure localepurge 来进行详细的配置。</p>
<p>●   清除你用不着的locale，让他们释放你的磁盘空间</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">＃localepurge<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>​       以后你不管安装什么软件，它都将自动帮你清除那些没用的locale。清除完，它会提示你释放了多少磁盘空间。当然你可以配置它让它显示清除了哪些locale。</p>
<p>​       Linux下面还有其他工具清理,如BleachBit，这是一款专为Linux 设计的系统清理工具。使用BleachBit，你可以清理系统中的缓存、不要的语言文件，历史、临时文件、cookies 等不需要的东西，这样可以释放你空间。推荐，不过Stable的源中没有该包，需要手动下载安装。</p>
<h3 id="4-2-实现root用户登录自动Tab补全">4.2:实现root用户登录自动Tab补全</h3>
<p>修改 .bashrc ，打开bash_completion，让apt-get install 在ROOT 登录的情况下自动补全，其他用户自动设置好了的，不用修改。你可以先用VI打开 /etc/bash.bashrc ,在最下面用命令模式下的V 再按上下左右键老选择，按y键复制，（默认打开VI就处于命令模式。i a o s键插入，编辑模式，ESC返回，：q! 退出。） 然后 vi ~/.bashrc 按p 键粘贴。最后象这样</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">if</span> <span class="token punctuation">[</span> -f /etc/bash_completion <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
<span class="token builtin class-name">.</span> /etc/bash_completion
<span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>当然你也可以用nano ,更简单。要复制功能,那么apt-get install gpm 然后 /etc/init.d/gpm start ，现在动下鼠标。是不是在动了，gpm是一个控制台下的鼠标服务。用鼠标左击拖动选中，右键粘贴。</p>
<h3 id="4-3：将用户加入到sudoers列表中">4.3：将用户加入到sudoers列表中</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#chmod +w /etc/sudoers</span>
<span class="token comment">#vim /etc/sudoers</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>添加一行：username ALL=(ALL) ALL</p>
<p>其中username是你的用户名，保存</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#chmod 0440 /etc/sudoers</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这样，您的普通用户可以使用"sudo + [命令]"来执行需要管理员权限的操作</p>
<h3 id="4-4-配置更新源并更新系统">4.4:配置更新源并更新系统</h3>
<h4 id="4-4-1-备份旧的源">4.4.1:备份旧的源</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">＃cp /etc/apt/sources.list /etc/apt/sources.list.old<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="4-4-2-配置新源">4.4.2:配置新源</h4>
<p>把下面的加进去，应该可以满足绝大多数人的要求了。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#gedit /etc/apt/sources.list</span>
＃＃＃<span class="token operator">==</span><span class="token operator">==</span>sources.list <span class="token assign-left variable">Begin</span><span class="token operator">==</span><span class="token operator">=</span>＃＃＃
<span class="token comment">##cn99</span>
deb http://debian.cn99.com/debian/ lenny main non-free contrib
deb-src http://debian.cn99.com/debian/ lenny main non-free contrib
deb http://debian.cn99.com/debian/ lenny-proposed-updates main non-free contrib
deb-src http://debian.cn99.com/debian/ lenny-proposed-updates main non-free contrib
 
deb http://debian.cn99.com/debian-security/ lenny/updates main contrib non-free
deb-src http://debian.cn99.com/debian-security/ lenny/updates main contrib non-free
deb http://debian.cn99.com/debian-backport/ lenny-backports main contrib non-free
deb-src http://debian.cn99.com/debian-backport/ lenny-backports main contrib non-free
deb http://security.debian.org/ lenny/updates main contrib non-free
deb-src http://security.debian.org/ lenny/updates main contrib non-free

deb http://volatile.debian.org/debian-volatile lenny/volatile main contrib non-free
deb-src http://volatile.debian.org/debian-volatile lenny/volatile main contrib non-free 

deb http://http.us.debian.org/debian/ lenny main contrib non-free
deb-src http://http.us.debian.org/debian/ lenny main contrib non-free
deb http://www.debian-multimedia.org/ lenny main
deb-src http://www.debian-multimedia.org/ lenny main 

deb http://download.virtualbox.org/virtualbox/debian lenny non-free
＃＃＃<span class="token operator">==</span><span class="token operator">=</span>sources.list <span class="token assign-left variable">End</span><span class="token operator">==</span><span class="token operator">=</span>＃＃＃<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意：debian-multimedia.org的源需要安装KEY，在http://debian-multimedia.org 下载安装debian-multimedia-keyring_2008.10.16_all.deb</p>
<p>Debian采用严格的GPG认证来保证安装包不被恶意篡改，使您已经安装就是最新最稳定的系统！</p>
<h4 id="4-4-3-更新源并升级系统">4.4.3:更新源并升级系统</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt－get update</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里就会提醒你有那些源没有GPG密匙，把错误密匙代号放到 iceweasel的搜索框，回车，就会看到大量的相关问题，随便点开2个就可以看到怎么样取得密匙。这个是偷懒的办法，但是非常有效！建议。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">＃apt-get update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> upgrade<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这次才是真的升级系统。如果通过网络安装，一般安装过程中就会自动选择最新的稳定的最新无漏洞包，一般来说没有更新包。</p>
<h3 id="四：网卡，声卡及显卡驱动安装">四：网卡，声卡及显卡驱动安装</h3>
<h3 id="4-1-配置无线网卡和ADSL来上网">4.1: 配置无线网卡和ADSL来上网</h3>
<p>系统默认一般会识别有线的网卡驱动，Linux几乎可以识别现在所有的有线网卡，而无线网卡驱动由于是非</p>
<h4 id="4-1-1-配置无线网卡">4.1.1:配置无线网卡</h4>
<p>●   驱动 这个看个文的硬件了</p>
<p>​                   ＃apt-get install firmware-iwlwifi</p>
<p>​                        ＃modprobe iwl3945   ＃加载内核模块</p>
<p>​                   这个我的Dell Inspiron6400的无线网卡是Intel 3945，其他无线网卡型号的用户请自己查找相关驱动包。</p>
<p>●   安装管理工具</p>
<p>​                   apt-get install wifi-radar</p>
<p>●   配置无线</p>
<p>看大家的无线设置，选择Essid,加密方式，频段等。</p>
<h4 id="4-1-2-使用PPPOE连接ADSL">4.1.2:使用PPPOE连接ADSL</h4>
<p>●   使用PPPOE连接Adsl</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt-get install pppoeconf</span>
<span class="token comment">#pppoeconf #设置用户名与密码</span>
<span class="token comment">#pon dsl-provider #连接</span>
<span class="token comment">#poff #断开</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-2-让alsa把你的声卡驱动起来">4.2:让alsa把你的声卡驱动起来</h3>
<p>#apt-get install alsa-base alsa-utils alsa-oss</p>
<p>**配置声卡：**执行 alsaconf 一路回车。 再执行alsa-mixer 设置音量，M键取消静音，ESC 键退出。保存设置 alsactl store。</p>
<p>**测试 声卡：**cat /dev/urandom &gt; /dev/dsp 你将会听到非常好听的声音，恭喜你，你的声卡工作了。</p>
<p>ctrl+c 终止它，当然你喜欢它的话，可以不那么做<sup>_</sup></p>
<p>到这里，你的X服务器和声卡就安装配置好了。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt-get install gnome-audio esound</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>esound是gnome下的软件混音器</p>
<h3 id="4-3-显卡驱动的安装及配置">4.3:显卡驱动的安装及配置</h3>
<p>http://wiki.cchtml.com/index.php/Ubuntu_Dapper_Installation_Guide</p>
<p>安装编译驱动所需的环境</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> module-assistant build-essential
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> fakeroot dh-make debconf libstdc++5 linux-headers-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -r<span class="token variable">)</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>创建安装包</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> ./ati-driver-installer-8.x.x.run --buildpkg debian/testing<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装这些创建的包b</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> dpkg -i xorg-driver-fglrx_8.x.x-1_i386.deb -f
<span class="token function">sudo</span> dpkg -i fglrx-kernel-source_8.x.x-1_i386.deb -f
<span class="token function">sudo</span> dpkg -i fglrx-control_8.x.x-1_i386.deb -f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>删除旧的源码包</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">rm</span> /usr/src/fglrx-kernel*.deb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>编译并安装驱动模块</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> module-assistant build fglrx
<span class="token function">sudo</span> module-assistant <span class="token function">install</span> fglrx
<span class="token function">sudo</span> depmod -a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>编辑你的/etc/X11/xorg.conf</p>
<p>在 Section "Module" 中加入</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Load <span class="token string">"fglrx"</span>
Load <span class="token string">"dri"</span>
Load <span class="token string">"glx"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>在Section "Device" 中把驱动换成</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Driver <span class="token string">"fglrx"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="4-3-1-ATI显卡驱动安装">4.3.1:ATI显卡驱动安装</h4>
<p>To build your own .deb packages you will need to install at least the following packages from the apt repositories:</p>
<p>●   fakeroot</p>
<p>●   debhelper</p>
<p>●   build-essential</p>
<p>●   make</p>
<p>●   module-assistant</p>
<h5 id="Installing-from-Debian-non-free">Installing from Debian non-free</h5>
<p>Note: in lenny, they've renamed fglrx-kernel-src to fglrx-source (but the following worked for me with that substitution).</p>
<h5 id="Install-the-driver">Install the driver</h5>
<p>sudo apt-get update</p>
<p>sudo apt-get install module-assistant fglrx-driver fglrx-kernel-src</p>
<h5 id="build-and-install-the-module">build and install the module</h5>
<p>#:sudo module-assistant auto-install fglrx-kernel-src</p>
<p>After this, you need</p>
<p>#:sudo aticonfig --initial</p>
<p>This will update your xorg.conf to use the new driver. Restart for the changes to take effect.</p>
<p>＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝</p>
<p><strong>1</strong> <strong>构建相应的系统驱动包：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./ati-driver-installer-8.41.7-x86.x86_64.run --buildpkg Debian/unstable<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们可以用下面的命令来列出所有可以构建的程序包：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./ati-driver-installer-8.41.7-x86.x86_64.run --listpkg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们可以从这个输出中选择适合我们系统的参数来进行构建相应的程序包。</p>
<p><strong>2</strong> <strong>安装所构建的程序包：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># dpkg -i fglrx*.deb</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>3</strong> <strong>安装module-assistant工具：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># apt-get install module-assistant</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>4</strong> <strong>使用m-a安装驱动模块</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># m-a prepare</span>
<span class="token comment"># m-a a-i fglrx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>驱动模块的安装需要相应的内核头文件，所以我们在进行这一步之前需要安装相应的头文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># apt-get install linux-headers-`uname -r`</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这样就可以自动来安装fglrx驱动模块了。</p>
<p>此时我们可以通过下面的命令来测试fglrx驱动模块是否安装成功：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># modprobe fglrx </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>5</strong> <strong>配置Xorg.conf</strong></p>
<p>在配置中我们要做的主要工作就要载入fglrx模块，在"Deveice"部分，将vesa驱动改为fglrx，重新启动X。如果一切正常，我们就可以享受到ATI驱动的带来的视觉效果了。</p>
<p>我们可以用下面的命令来检测我们的ATI驱动是否安装成功：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ fglrxinfo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们应得到下面的输出：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">display: :0.0 screen: <span class="token number">0</span>
OpenGL vendor string: ATI Technologies Inc.
OpenGL renderer string: ATI Mobility Radeon HD <span class="token number">2400</span> XT
OpenGL version string: <span class="token number">2.1</span>.7059 Release<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ glxinfo <span class="token operator">|</span> <span class="token function">grep</span> direct<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们希望的输出结果为：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">direct rendering: Yes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>而我们在源中也可以找到相应的fglrx程序包：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># apt-cache search fglrx</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>个人觉得没有必要非得安装所谓的官方驱动包，因为由所谓的官方驱动包中所解出正是源中的几个程序包，而我在安装了官方的驱动程序包后进行了一下upgrade，居然更新其中的两个包，既然这样，我们还不如直接安装源中的驱动程序包方便：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># apt-get install fglrx* </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>使用m-a安装驱动模块时，我们也可以使用分步的安装方式，先编译，再安装，而不必一步到位：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># m-a get fglrx</span>
<span class="token comment"># m-a build fglrx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这 时就会在/usr/src/目录下生成一个fglrx的deb包。编译驱动程序模块时需要安装Linux内核头文件，我的内核是自己编译的2.6.23， 但是在源中却迟迟没有相应的头文件包，真是相当郁闷的说。但是即使是这样，我却依然得到了一个编译生成的fglrx的deb包。我们可以使用dpkg来进 行安装。</p>
<p>最后需要进行Xorg的配置。最简单的就是将驱动改为fglrx。当然我们也可以使用ati所提供的相应工具来进行配置：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># aticonfig --initial --input=/etc/X11/xorg.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这会进行相应的检测，并且修改xorg.conf文件。</p>
<h4 id="4-3-2-NVIDIA显卡驱动的安装">4.3.2:NVIDIA显卡驱动的安装</h4>
<h2 id="五：常用软件安装及配置">五：常用软件安装及配置</h2>
<p>​            发现Debian 即使是选择了base system,laptop,desktop其实也没有装多少东西，很多还需要自己安装,例如alsa-oss,gnome-audio等默认没有安装（应该没有记错）。下面很多东西可能系统已经安装了，但是这么做没有错的，下面的都是几乎不可缺少的组件。</p>
<h4 id="5-1-Gnome相关">5.1:Gnome相关</h4>
<h4 id="5-1-1-Gnome基本系统及基本管理工具">5.1.1:Gnome基本系统及基本管理工具</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt-get install xorg gnome-core gdm gdm-themes gnome-system-tools gconf-editor nautilus-open-terminal gnome-power-manager gnome-screensaver</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>xorg X窗口系统</p>
<blockquote>
<p>gnome-core     gnome核型组件</p>
<p>gdm  #gnome 默认的窗口管理器</p>
<p>gnome-system-tools     服务、网络等系统工具</p>
<p>gconf-editor     配置编辑器</p>
<p>nautilus-open-terminal    在右键菜单中加入终端</p>
<p>gnome-power-manager   #电源管理，休眠支持</p>
<p>gnome-screensaver      #锁屏</p>
<p>gconf-editor     #配置编辑器</p>
<p>ntfs-3g  #支持NTFS文件格式的读写</p>
<p>nautilus-gksu #以管理员权限打开目录</p>
</blockquote>
<h4 id="5-1-2-安装gnome主题、图标、背景">5.1.2:安装gnome主题、图标、背景</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt-get install  gnome-themes gnome-icon-theme-dlg-neu gnome-backgrounds</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="5-3-常用软件工具安装">5.3:常用软件工具安装</h3>
<h4 id="5-3-1-字体安装">5.3.1:字体安装</h4>
<h5 id="●-使用apt">●   使用apt</h5>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">＃ <span class="token function">apt-get</span> <span class="token function">install</span> ttf-bitstream-vera ttf-arphic-uming  ttf-freefont <span class="token comment">#ttf-freefont 解决flash菜单可能的乱码，</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>WQY点整字体: apt-get install xfonts-wqy</p>
<p>ttf-wqy-zenhei #文泉驿正黑字体</p>
<h5 id="●-手工安装字体">●   手工安装字体</h5>
<p>把字体".ttf"字体copy到"/usr/share/fonts"下面的某目录中</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> mkfontscale
<span class="token function">sudo</span> mkfontdir
<span class="token function">sudo</span> fc-cache<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h5 id="●-系统字体优化：">●   系统字体优化：</h5>
<p>1.右击桌面，打开外观管理器中的字体选项卡，将其中的字体全部改成雅黑字体，同时把窗口标题设置为加粗，并选择LCD模式。</p>
<p>2.在终端里输入指令</p>
<pre class="line-numbers language-none"><code class="language-none">sudo gedit /etc/fonts/conf.d/49-sansserif.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>将其中的字体全部改成雅黑，该操作也可以同时解决flash中出现方框的问题。</p>
<h4 id="-2"></h4>
<p>5.3.2:输入法</p>
<p>●   安装scim中文输入法，可选其他的如fcitx</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt-get install scim scim-pinyin scim-tables-zh im-switch</span>
<span class="token comment">#im-switch -z en_US -s scim #英文系统下使用SCIM：</span>
scim-qtimm <span class="token comment">#scim兼容QT程序</span>
<span class="token comment">#im-switch -s scim -z default</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>●   光标跟随</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#gedit /etc/X11/xinit/xinput.d/scim</span>
<span class="token comment">#GTK_IM_MODULE=xim</span>
<span class="token comment">#QT_IM_MODULE=xim</span>
<span class="token assign-left variable">GTK_IM_MODULE</span><span class="token operator">=</span>scim
<span class="token assign-left variable">QT_IM_MODULE</span><span class="token operator">=</span>scim<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>●   或者选择fctix</p>
<p>不管你是kde还是gnome 安装fcitx就这样：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt-get</span> <span class="token function">install</span> fcitx im-switch
im-switch -s fcitx -z default<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="5-3-3-双击安装deb文件">5.3.3:双击安装deb文件</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt-get install gdeb</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="5-3-4-压缩与解压缩">5.3.4:压缩与解压缩</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt-get install file-roller p7zip-full cabextract rar unrar  p7zip-rar rar unrar cabextract#7z,rar，cab</span>

＃apt-get <span class="token function">install</span> gnochm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="gnochm-CHM阅读，或者chmsee">gnochm #CHM阅读，或者chmsee</h4>
<p>5.3.5:安装OpenOffice.org</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt-get install openoffice.org-writer openoffice.org-calc openoffice.org-math openoffice.org-impress openoffice.org-gtk openoffice.org-help-en-us</span>
<span class="token comment">#apt-get install openoffice.org-l10n-zh-cn openoffice.org-help-zh-cn #中文界面和中文帮助</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="5-3-6-安装视频播放器">5.3.6:安装视频播放器</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt-get install mplayer w32codecs smplayer</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>w32codecs #多媒体库</p>
<h4 id="5-3-7-PDF阅读">5.3.7:PDF阅读</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt-get install evince xpdf xpdf-chinese-simplified xpdf-chinese-traditional poppler-data</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>xpdf-chinese-simplified xpdf-chinese-traditional poppler-data完美中文支持</p>
<h4 id="5-3-8-图像处理">5.3.8:图像处理</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt-get install gimp</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="5-3-9-网络通讯">5.3.9:网络通讯</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt-get install pidgin</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol start="11">
<li>编程环境支持</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt-get install build-essential libgtk2.0-dev freeglut3-dev libtool autoconf automake subversion</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">deb http://apt.jenslody.de/ any main
deb-src http://apt.jenslody.de/ any main
deb http://apt.wxwidgets.org/ etch-wx main
<span class="token comment">#KEY：</span>
<span class="token function">wget</span> -q http://apt.jenslody.de/jens.asc -O- <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -
<span class="token function">wget</span> -q http://apt.wxwidgets.org/key.asc -O- <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li>其他安装</li>
</ol>
<p>安装Multiget：<a target="_blank" rel="noopener" href="https://multiget.sourceforge.net/download.html">http://multiget.sourceforge.net/download.html</a></p>
<p>安装Opera：<a target="_blank" rel="noopener" href="https://www.opera.com/download/">http://www.opera.com/download/</a></p>
<p>安装RealPlayer：<a target="_blank" rel="noopener" href="https://www.real.com/linux">http://www.real.com/linux</a></p>
<p>安装AdobeReader：<a target="_blank" rel="noopener" href="https://www.adobe.com/products/acrobat/readstep2_allversions.html">http://www.adobe.com/products/acrobat/readstep2_allversions.html</a></p>
<p>安装FlashPlayer：<a target="_blank" rel="noopener" href="https://www.adobe.com/shockwave/download/download.cgi?P1_Prod_Version=ShockwaveFlash&amp;P2_Platform=Linux">http://www.adobe.com/shockwave/download/download.cgi?P1_Prod_Version=ShockwaveFlash&amp;P2_Platform=Linux</a></p>
<p>编译CodeBlocks的SVN版本：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">svn checkout svn://svn.berlios.de/codeblocks/trunk ~/Downloads/CodeBlocks<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装CodeBlocks：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> codeblocks<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>alien    a package converter,将rpm,dpkg,stampede slp己slackware tgz档格式间的转换</p>
<p>pdfedit 修改pdf文件</p>
<p>linux开发工具： gcc,make,autoconf,diff,patch,rcs,emacs</p>
<p>mysql-admin,mysql-navigator,mysql-query-browser</p>
<p>安装版本控制软件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> subversion cvs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装中文输入法</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> scim-pinyin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装词典 http://stardict.sourceforge.net</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> stardict sox<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>/usr/share/stardict/dic/stardict-langdao-ce-gb-2.4.2 (郎道汉英辞典)</p>
<p>/usr/share/stardict/dic/stardict-langdao-ec-gb-2.4.2 (郎道英汉辞典)</p>
<p>/usr/share/WyabdcRealPeopleTTS (英文语音词库)</p>
<p>安装邮件客户端</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> thunderbird<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装 win-xchm查看器</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> xchm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装 msn for linux</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> emesene<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装下载工具 ( bt 工具 transmission 默认已安装 ; amule 对应windows平台的 emule)</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> gwget amule<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装 rss 订阅工具</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> liferea<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>硬件监控工具</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> sensors-applet<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>远程桌面管理,RDP默认已安装</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> xvnc4viewer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装视频/音频解码器</p>
<p>gnome 平台推荐用 totem+gstreamer*, 直接点击多媒体文件,totem会自动搜索匹配解码器安装</p>
<p>特殊的rm, rmvb格式文件, RealPlayer 11 for Linux 刚发布 (http://www.real.com/linux) ,效果不错,可以不用 w32codecs 了.</p>
<p>安装 flash for firefox, 新版多了一个选项”swfdec player”, 推荐, 其对CPU消耗改善了</p>
<ol>
<li>
<p>swfdec player for adobe/macromedia flash</p>
</li>
<li>
<p>adobe flash player</p>
</li>
<li>
<p>gnash swf player</p>
</li>
</ol>
<p>中文编码配置</p>
<p>sudo vi /var/lib/locales/supported.d/zh</p>
<p>加入以下编码支持</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">zh_CN.GB18030 GB18030
zh_CN.GBK GBK
zh_CN.GB2312 GB2312
zh_HK.BIG5 BIG5
zh_TW.BIG5 BIG5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>立即应用更新</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> locale-gen<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装 vim</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">vim</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>配置 vim</p>
<p>sudo vi /etc/vim.local</p>
<p>加入以下设置(个人喜好)</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">syntax on

<span class="token builtin class-name">set</span> expandtab

<span class="token builtin class-name">set</span> <span class="token assign-left variable">tabstop</span><span class="token operator">=</span><span class="token number">4</span>

<span class="token builtin class-name">set</span> <span class="token assign-left variable">shiftwidth</span><span class="token operator">=</span><span class="token number">4</span>

<span class="token builtin class-name">set</span> <span class="token assign-left variable">sts</span><span class="token operator">=</span><span class="token number">4</span>

<span class="token builtin class-name">set</span> autoindent

<span class="token builtin class-name">set</span> smartindent

<span class="token builtin class-name">set</span> cindent

<span class="token builtin class-name">set</span> number

<span class="token builtin class-name">let</span> <span class="token operator">&amp;</span><span class="token assign-left variable">termencoding</span><span class="token operator">=</span><span class="token operator">&amp;</span>encoding

<span class="token builtin class-name">set</span> <span class="token assign-left variable">fileencodings</span><span class="token operator">=</span>utf-8,gb18030,gbk,gb2312,big5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置 gedit</p>
<p>执行 sudo gconf-editor</p>
<p>选择 apps/gedit-2/preferences/encodings</p>
<p>找到 auto_detected 编辑，在Values中分别加入 GB18030,GBK,GB2312,BIG5</p>
<p>界面风格 http://art.gnome.org</p>
<p>Ubuntu 默认的橘黄风格让我”焦躁”,一直偏向用蓝,灰的风格</p>
<p>窗体用 SimpleBox (2.6 kb, 下载安装)</p>
<p>图标用 tango ( apt-get install tango-icon-theme )</p>
<p>Others</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apt-show-source apt-show-versions archmage chmsee aria2 debian-faq-zh-cn fontforge gedit-plugins gtkcookie gupnp-tools htmldoc powersaved tor ttf-bitstream-vera vim-addon-manager<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="六：笔记本配置专辑">六：笔记本配置专辑</h2>
<p><strong>Dell Inspiron 6400</strong></p>
<table>
<thead>
<tr>
<th><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223005.jpg" alt=""></th>
<th>- Video card: Intel Corporation- Mobile 945GM/GMS/940GML Express Integrated Graphics Controller- RAM: 2Go- Hard disk drive: 100Go- Processor: Pentium Dual-core 1.86GHz <em>(T2130)</em>- Ethernet card: Broadcom Corporation BCM4401-B0 100Base-TX- Wifi Card: Intel Corporation PRO/Wireless 3945ABG Network Connection- Optical device: DVD+RW- Screen WSXGA+: resolution=1200x800, size=15,4" wide</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="Overall-Status">Overall Status</h2>
<table>
<thead>
<tr>
<th><strong>Core Components</strong></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Boot Standard Kernel:</td>
<td><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223057.gif" alt=""></td>
<td></td>
</tr>
<tr>
<td>LAN network card:</td>
<td><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223104.gif" alt=""></td>
<td></td>
</tr>
<tr>
<td>Detect CD/DVD:</td>
<td><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223104.gif" alt=""></td>
<td></td>
</tr>
<tr>
<td>Detect hard drives:</td>
<td><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223119.gif" alt=""></td>
<td></td>
</tr>
<tr>
<td><strong>Extra Features</strong></td>
<td></td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://wiki.debian.org/InstallingDebianOn/Dell/Inspiron6400/lenny#cpu">CPU Frequency Scaling</a></td>
<td><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223130.gif" alt=""></td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://wiki.debian.org/InstallingDebianOn/Dell/Inspiron6400/lenny#power">Hibernation</a></td>
<td><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223136.gif" alt=""></td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://wiki.debian.org/InstallingDebianOn/Dell/Inspiron6400/lenny#power">Sleep / Suspend</a></td>
<td><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223136.gif" alt=""></td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://wiki.debian.org/InstallingDebianOn/Dell/Inspiron6400/lenny#display">Xorg</a></td>
<td><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223148.gif" alt=""></td>
<td></td>
</tr>
<tr>
<td>- OpenGL</td>
<td><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223200.gif" alt=""></td>
<td></td>
</tr>
<tr>
<td>- Resize-and-Rotate(randr)</td>
<td><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223209.gif" alt=""></td>
<td></td>
</tr>
<tr>
<td>Switch to External Screen</td>
<td><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223223.gif" alt=""></td>
<td></td>
</tr>
<tr>
<td>Mouse</td>
<td></td>
<td></td>
</tr>
<tr>
<td>- Built-in (Trackpoint)</td>
<td>[-]</td>
<td></td>
</tr>
<tr>
<td>- Built-in (Touchpad)</td>
<td><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223231.gif" alt=""></td>
<td></td>
</tr>
<tr>
<td>Modem</td>
<td>[?]</td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://wiki.debian.org/InstallingDebianOn/Dell/Inspiron6400/lenny#wifi">Wireless/Wifi</a></td>
<td><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223237.gif" alt=""></td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://wiki.debian.org/InstallingDebianOn/Dell/Inspiron6400/lenny#keys">Keyboard's Hotkeys</a></td>
<td><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223238.gif" alt=""></td>
<td></td>
</tr>
</tbody>
</table>
<p>Legend :</p>
<ul>
<li>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223249.gif" alt=""> = OK ;</p>
</li>
<li>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223256.gif" alt=""> Unsupported(No Driver) ;</p>
</li>
<li>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223302.gif" alt=""> = Error (Couldn't get it working);</p>
</li>
<li>
<p>[?] Unknown, Not Test ;</p>
</li>
<li>
<p>[-] Not-applicable</p>
</li>
<li>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223346.gif" alt=""> = Configuration Required;</p>
</li>
<li>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818223308.gif" alt=""> = Only works with a non-free driver/firmware</p>
</li>
</ul>
<h2 id="Configuration">Configuration</h2>
<h2 id="Display">Display</h2>
<p>You will need to install the 915resolution package:</p>
<p># apt-get install 915resolution xserver-xorg-video-intel</p>
<p># 915resolution</p>
<p>The 915resolution will try to get highest resolution, you can change this at /etc/default/915resolution.</p>
<p>If you wish to enable DRI, GLX, etc. see <a href="https://wiki.debian.org/InstallingDebianOn/Dell/Inspiron6400/lenny?action=AttachFile&amp;do=view&amp;target=Xorg.conf_Lenny_DellInspiron6400.txt">Xorg.conf_Lenny_DellInspiron6400.txt</a> . My configuration works fine with <a target="_blank" rel="noopener" href="https://wiki.debian.org/Compiz">Compiz</a>.</p>
<p>If using newer "xserver-xorg" (version 7.3 +), do not install "915resolution" as it conflicts with "xserver-xorg-video-all" and "xserver-xorg-video-intel". Also install "libgl1-mesa-dri" (and this also installs "libgl1-mesa-glx") for OpenGL support. Use "glxinfo | grep direct" to check for direct rendering. The "glxinfo" util comes with the "mesa-utils" package. (Thanks to enouf and Nemoder on #debian@OFTC)</p>
<h2 id="Hibernation-and-Sleep-Suspend">Hibernation and Sleep/Suspend</h2>
<p>Works fine. Install,</p>
<pre class="line-numbers language-none"><code class="language-none"># apt-get install acpid hal pm-utils uswsusp powermgmt-base<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>We will need to unload the "b44" module before hibernating, add the following to "/etc/pm/config.d/unload_modules":</p>
<p>SUSPEND_MODULES="b44"</p>
<p>The wireless drivers will be automatically handled by pm-utils. You should then be able to hibernate:</p>
<pre class="line-numbers language-none"><code class="language-none"># pm-hibernate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>And suspend:</p>
<pre class="line-numbers language-none"><code class="language-none"># pm-suspend<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Note that if you are trying to hibernate/suspend from within GNOME, you will need to be a member of the " powerdev" group.</p>
<h2 id="CPU-Power-Scaling">CPU Power Scaling</h2>
<p>Add a few modules to be loaded,</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># echo "acpi-cpufreq" &gt;&gt; /etc/modules</span>
<span class="token comment"># echo "speedstep_centrino" &gt;&gt; /etc/modules</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Then, install the "powernowd" daemon:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># apt-get install powernowd</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Powenowd's default settings should be OK for most people.</p>
<h2 id="Hotkeys">Hotkeys</h2>
<p>These are automatically configures by:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># apt-get install hotkey-setup</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="WiFi">WiFi</h2>
<p>We need to install the firmware:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># apt-get install firmware-iwlwifi</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>And it should work. If you get an error like "Kill switch must be turned off in order for wireless networking to work." during system boot, you need to press the magic Fn + F2 button.</p>
<h2 id="七：其他问题">七：其他问题</h2>
<h3 id="0-多源混合使用">0.多源混合使用</h3>
<p>安装完稳定版系统，请先为整个系统所有软件包设置 hold on 状态，aptitude 可以很容易的完成此任务。 接着，添加多个版本的源，即由上而下依次为： stable stable-backports （当前是 lenny-backports，http://wiki.debian.org/Backports） testing sid experimental， 然后，请针对特定软件包的特定版本升级，注意一次升级一个包彻底解决一个包，勿贪心。 升级完成，再次设置 hold on 状态，如此反复。</p>
<p>有时需要人工介入满足特定软件包的依赖关系。 如，为了使用 DRI，给 lenny 安装新版 ati 开源驱动 radeon 软件包， 需要先手工升级 mesalib-7.4.<em>、xorg-server-1.6.</em> 等， 再手工安装 radeon 软件包，而不能直接安装 radeon 软件包的新版本， 混用多个版本的源时，aptitude 自动计算的依赖关系并不总是可靠的。</p>
<p>如果仍不够新，那就要自己动手配置编译。 如果愿意可以使用 debian 方式编译打包。</p>
<p>如果升级的软件包依赖一些基本的软件包如 glibc，最终得到的系统将不再是 debian 稳定版。</p>
<ol>
<li>
<h3 id="自动挂载U盘中文文件名乱码问题">自动挂载U盘中文文件名乱码问题</h3>
</li>
</ol>
<p>解决方法：系统工具-&gt;配置编辑-&gt;/system/storage/default_options/vfat，双击mount_options，”添加”，在“新列表值”中填入“utf8”。</p>
<ol start="2">
<li>
<h3 id="apt-get与dpkg的基本用法">apt-get与dpkg的基本用法</h3>
</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#apt-get install packagename #安装一个新软件包</span>
<span class="token comment">#apt-get remove packagename #卸载一个已安装的软件包（保留配置文件）</span>
<span class="token comment">#apt-get --purge remove packagename #卸载一个已安装的软件包（删除配置文件）</span>
<span class="token comment">#dpkg --force-all --purge packagename #强制卸载，风险大！</span>
<span class="token comment">#apt-get upgrade #更新所有已安装的软件包</span>
<span class="token comment">#apt-get dist-upgrade #将系统升级到新版本</span>
<span class="token variable">$apt</span>-cache search 正则表达式 <span class="token comment">#在软件包列表中搜索字符串</span>
<span class="token variable">$dpkg</span> -l 正则表达式 <span class="token comment">#列出所有与模式相匹配的软件包</span>
<span class="token comment">#apt-get clean #清理所有软件缓存</span>
<span class="token comment">#apt-get autoclean #清理旧版本的软件缓存</span>
<span class="token comment">#apt-get autoremove #删除系统不再使用的孤立软件</span>
<span class="token comment">#apt-cdrom add #增加一个光盘源</span>
<span class="token variable">$dpkg</span> -l <span class="token operator">|</span><span class="token function">grep</span> ^rc<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{print $2}'</span> <span class="token operator">|</span> <span class="token comment">#xargs dpkg -P #清除所有已删除包的残馀配置文件</span>
<span class="token comment">#auto-apt run ./configure #编译时缺少h文件的自动处理</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="3">
<li>
<h3 id="安装RealPlay">安装RealPlay</h3>
</li>
</ol>
<p>下载bin包，到realplayer主页上下载 <a target="_blank" rel="noopener" href="https://www.real.com/linux">http://www.real.com/linux</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#chmod 755 ./*.bin #或chmod +x ./*.bin</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>#./*.bin #一定要root安装，否则安装后无法启动。</p>
<ol start="4">
<li>
<h3 id="安装FlashPlayer">安装FlashPlayer</h3>
</li>
</ol>
<p>在iceweasel提示安装时选择安装，如果安装失败：</p>
<p>下载install_flash_player_9_linux.tar.gz并解压，进入解压目录，执行</p>
<p>安装：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> ./flashplayer-installer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>若flashplayer菜单有乱码问题的话，执行：sudo mv /etc/fonts/conf.d/49-sansserif.conf /etc/fonts/conf.d/49-sansserif.conf.bak</p>
<p>安装ttf-freefont字体可解决swf文件中文乱码。</p>
<ol start="5">
<li>编译Code::Blocks的SVN版本</li>
</ol>
<p>(a) 下载源码</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">svn checkout svn://svn.berlios.de/codeblocks/trunk ~/Sources/CodeBlocks<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>(b) 编译</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">ACLOCAL_FLAGS</span><span class="token operator">=</span><span class="token string">"-I <span class="token variable"><span class="token variable">`</span>wx-config --prefix<span class="token variable">`</span></span>/share/aclocal"</span>

./bootstrap

./configure 或 ./configure --with-contrib-plugins<span class="token operator">=</span>all

<span class="token function">make</span>

<span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>(c) 缷载</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">make</span> uninstall<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>(d) 重新编译</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> clean
<span class="token function">make</span> distclean
<span class="token function">make</span> clean-bin
<span class="token function">make</span> clean-zipfiles<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>详情：<a target="_blank" rel="noopener" href="https://wiki.codeblocks.org/index.php?title=Installing_Code::Blocks_from_source_on_Linux">http://wiki.codeblocks.org/index.php...ource_on_Linux</a></p>
<p>●   关于64位系统使用32位软件额外需求</p>
<p>64位系统同样能使用32位的软件，只要在终端输入以下命令，安装相应的32位包：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> ia32-libs ia32-libs-gtk linux32 lib32asound2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="●-MLdonkey-sancho安装">●   MLdonkey+sancho安装</h2>
<p>MLdonkey被誉为<a target="_blank" rel="noopener" href="https://forum.ubuntu.org.cn/viewtopic.php?t=42337&amp;highlight=mldonkey">速度最快的电驴</a>，同时支持很多种P2P的下载协议，包括edonkey2000、gnutella、gnutella2、bt、FileTP</p>
<p>等等。网上有很多安装和设置的文章，但是有点乱，有些也不够完整，今天有空将它整理如下</p>
<p>下载最新版 <a target="_blank" rel="noopener" href="https://sourceforge.net/project/showfiles.php?group_id=156414&amp;package_id=174487">MLdonkey</a> &amp; <a target="_blank" rel="noopener" href="https://sancho-gui.sourceforge.net/download.phtml">sancho</a>（左键点击）</p>
<h3 id="一-安装-mldonkey：">一.安装 mldonkey：</h3>
<p>解压缩mldonkey源代码并进入其目录，然后</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> ocaml
$ ./configure
$ <span class="token function">make</span>
$ <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>（使用新版本的mldonkey源代码编译安装后已不会有下载后文件名不支持中文的问题）</p>
<h3 id="二-安装-sancho：">二.安装 sancho：</h3>
<p>sancho是mldonkey最好用的一个前端，下载回来的sancho只有一个文件，是一个脚本，先右键单击它，找到属性-权限部分，钩上“可执行”，然后在终端中运行之：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ ./sancho-*-linux-gtk.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后会显示</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Extract to directory <span class="token punctuation">[</span><span class="token operator">&lt;</span>sancho-*-linux-gtk<span class="token operator">&gt;</span><span class="token punctuation">]</span>:<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>输入自定义安装目录，随便你，我安装在/usr/local/sancho</p>
<p>稍等一会就装好了，在/usr/local/sancho/下有个sancho，双击它就能运行sancho</p>
<p># 下载 sancho 后用 root权限安装</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">user@~$ <span class="token function">sudo</span> <span class="token function">sh</span> sancho-0.9.4-59-linux-gtk.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p># 选择安装目录, 这里我安装在 /opt/sancho/</p>
<p># 修改用户配置文件目录的权限</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">user@~$ <span class="token function">sudo</span> <span class="token function">chown</span> user:user -R ~/.sancho/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p># 把 user 改成自己的用户名</p>
<h3 id="三-sancho设置">三.sancho设置</h3>
<p>先运行mlnet，在/usr/local/bin或/usr/bin下，然后运行sancho，首次运行会有配置向导，需要设置mlnet位置。在sancho里面也可以设置mlnet的运行路径</p>
<p>在<strong>工具</strong>-&gt;<strong>首选项</strong>-&gt;**sancho:**<strong>主要</strong>-&gt;<strong>可选的可执行core</strong> 那里填上你的mlnet路径。这样以后就可以直接启动sancho。</p>
<p>设置中文: 在<strong>工具</strong>-&gt;<strong>首选项</strong>-&gt;**sancho:**<strong>主要</strong>-&gt;<strong>使用本地文件</strong> 选择zh-CN,重启sancho后即为中文。</p>
<p>在<strong>工具</strong>-&gt;<strong>首选项</strong>-&gt;<strong>Main</strong> 设置 <strong>client_name</strong> 推荐设置成[CHN][VeryCD]<strong>yourname</strong>的形式，支持中文。</p>
<p>在<strong>工具</strong>-&gt;<strong>首选项</strong>-&gt;<strong>Bandwidth</strong> 设置 <strong>max_hard_upload_rate</strong> 和 <strong>max_hard_download_rate</strong> 分别是上传和下载速度，单位是KB</p>
<p>在<strong>工具</strong>-&gt;<strong>首选项</strong>-&gt;<strong>Networks</strong> 勾选 <strong>enable_overnet</strong> 和 <strong>enable_kademlia</strong></p>
<p>在<strong>工具</strong>-&gt;<strong>首选项</strong>-&gt;<strong>Networks</strong>-&gt;<strong>Donkey</strong>有这两项：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ED2K-force_client_high_id
ED2K-force_high_id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>如果你是公网用户，或者你是内网，且设置了端口映射，则勾选它们，如果你打死都是内网低ID用户，就不要选了，否则会很难连上服务器。</p>
<p>你可以选上试试看，不行再取消。</p>
<p>在<strong>工具</strong>-&gt;<strong>首选项</strong>-&gt;<strong>Networks</strong>-&gt;<strong>Donkey</strong>-&gt;<strong>ED2K-port</strong> 设置端口，如果你有windows下的emule，最好把他们的端口(tcp的)设成一样，因为有些路由器有记忆功能，导致windows下的端口在重启后仍然保留。一般emule默认端口为4662,但有些宽带运营商会封掉该端口，建议改掉。</p>
<p>在<strong>工具</strong>-&gt;<strong>首选项</strong>-&gt;<strong>Networks</strong>-&gt;<strong>Donkey</strong>-&gt;<strong>ED2K-max_connected_servers</strong> 设置服务器最大连接数，默认为3，不用太大，大了也没用，一般稳定下来也就三四个左右，我把它设为7</p>
<p>打开sancho主界面，点击控制台，然后在最下方的命令输入框那里</p>
<p>用如下命令导入服务器</p>
<p>servers http://www.emule.org.cn/server.met</p>
<p>用ov_load命令导入overnet的node列表，推荐下载<a target="_blank" rel="noopener" href="https://download.overnet.org/contact.dat">http://download.overnet.org/contact.dat</a></p>
<p>用kad_load命令导入kad的node列表，推荐下载<a target="_blank" rel="noopener" href="https://www.emule-inside.net/nodes.dat">http://www.emule-inside.net/nodes.dat</a></p>
<p>或<a target="_blank" rel="noopener" href="https://renololo1.free.fr/e/nodes.dat">http://renololo1.free.fr/e/nodes.dat</a>，也可使用eMule的nodes.data</p>
<p>对于ov_load和kad_load，需要先下载回本地，比如把contact.dat下载到桌面后，输入：</p>
<p>ov_load /home/xxb/桌面/contact.dat</p>
<p>路径请修改为适合你自己的。</p>
<p>修改下载目录和temp目录: 默认目录分别为 ~/.mldonkey/incoming/files （BT则为~/.mldonkey/incoming/directories) 和 ~/.mldonkey/temp</p>
<p>修改 ~/.mldonkey/downloads.ini，找到“SECTION : Paths”，然后修改第一段和倒数第二段的路径，注意这里是相对路径。下载目录和temp目录最好放在同一个硬盘分区，否则下载完成转移临时文件时，硬 盘灯会狂闪。或者通过建立软链接来更改下载目录也可以（推荐）。</p>
<p>比如我把下载目录和临时目录都移到/home/xxb/Videos/下，则把~/.mldonkey/下的incoming和temp目录都剪切到/home/xxb/Videos/下，然后建立软链接：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ln</span> -s ~/Videos/incoming ~/.mldonkey/incoming

$ <span class="token function">ln</span> -s ~/Videos/temp ~/.mldonkey/temp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="四-设置浏览器关联">四.设置浏览器关联</h3>
<p>这里只说firefox的关联，如果需要设置其它浏览器，请参考<a target="_blank" rel="noopener" href="https://forum.ubuntu.org.cn/viewtopic.php?t=47733&amp;highlight=mldonkey+%E5%85%B3%E8%81%94">mldonkey 和浏览器关联的办法,适用 firefox, konqueror</a></p>
<p>先建立脚本,这里我们把它取名为 submit, 放在 ~/.mldonkey 下面。内容如下:</p>
<pre class="line-numbers language-none"><code class="language-none">#!/bin/bash

echo dllink $*|nc -q 1 127.0.0.1 4000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如果系统是ArchLinux，则需安装netcat(gnu-netcat),并改为</p>
<pre class="line-numbers language-none"><code class="language-none">#!/bin/bash

echo dllink $*|nc 127.0.0.1 4000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后右键单击它，找到属性-权限部分，钩上“可执行”</p>
<p>接下来在firefox地址栏输入 about:config</p>
<p>新建 字符串(string)</p>
<pre class="line-numbers language-none"><code class="language-none">network.protocol-handler.app.ed2k<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>值为submit 脚本的位置，比如我的是 /home/xxb/.mldonkey/submit</p>
<p>也可以安装firefox扩展，以关联ed2k、bt等，解压后的mldoneky-distrib-xxx/ed2k_mozilla/文件夹下 有个 mldonkey_protocol_handler-xx.xpi，把它拖到fx窗口选择安装。重启后就可以双击MLdonkey Protocal Handler这个扩展设置关联了，这个扩展也可以关联到amule。不过扩展当然是能不装就不装，所以推荐使用submit脚本的方法。</p>
<h3 id="五-WEB界面">五.WEB界面</h3>
<p>你也可以用浏览器控制和观察mldonkey，地址是 <a target="_blank" rel="noopener" href="https://localhost:4080/">http://localhost:4080/</a></p>
<p>我比较推崇用这个，不占额外资源（不必一直开着sancho，毕竟java的东西会占不少内存和cpu），设置更强，不过是英文的。你还可以编辑~/.mldonkey下的各个文件进行设置，这里不再敖述。</p>
<h3 id="六-端口映射">六.端口映射</h3>
<p>打开 <a target="_blank" rel="noopener" href="https://localhost:4080/">http://localhost:4080/</a>后，点击<strong>Help+</strong>-&gt;<strong>Sysinfo</strong> 这里可以查看mldonkey的端口使用情况，除了core那3个，建议其余的都在路由器里设置端口映射，如果有防火墙，还要打开相应端口。</p>
<p><a target="_blank" rel="noopener" href="https://www.emule.org.cn/topic/nat/">点击查看各种主流路由器映射的设置方法</a></p>
<h3 id="七-其它">七.其它</h3>
<p>本文基本只涉及电驴部分，如果还需要其它比如BT功能，请自行摸索，附一些主要的配置文件：</p>
<ul>
<li>
<p>~/.mldonkey/downloads.ini 基本的设置( 这个是for edonkey和其他协议的)</p>
</li>
<li>
<p>~/.mldonkey/servers.ini 服务器列表文件</p>
</li>
<li>
<p>~/.mldonkey/files.ini 当前已经完成的和未完成的文件列表</p>
</li>
<li>
<p>~/.mldonkey/friends.ini 好友列表</p>
</li>
<li>
<p>~/.mldonkey_gui.ini 图形前端的配置文件</p>
</li>
</ul>
<p>另外其他的网络协议都有其单独的配置文件，一般都放在~/.mldonkey目录下</p>
<p>祝骑驴愉快 <sup>_</sup></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Driver</tag>
        <tag>Debian</tag>
        <tag>Laptop</tag>
        <tag>ED2K</tag>
        <tag>ATI</tag>
        <tag>WIFI</tag>
        <tag>Hotkey</tag>
      </tags>
  </entry>
  <entry>
    <title>qnap IO 错误消除</title>
    <url>/posts/5b1993ac/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="处理步骤">处理步骤</h2>
<h2 id="备份">备份</h2>
<p>先备份数据，rsync比HBS3好用多了。</p>
<h2 id="如果没有坏块">如果没有坏块</h2>
<p>如果没有坏块，就在下图位置扫描坏块，扫描完，自动清除异常标志</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818152952.png" alt=""></p>
<h2 id="如果有坏块">如果有坏块</h2>
<h3 id="坏块修复">坏块修复</h3>
<p>如果有坏块，可以使用 “DiskGenius”扫描修复</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818162038.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818162057.png" alt=""></p>
<h2 id="强制消除异常标志">强制消除异常标志</h2>
<blockquote>
<ol>
<li>開啟SSH</li>
<li>登入 console</li>
<li><code># sed -i '/pd_err_wwn_/d' /mnt/HDA_ROOT/.conf</code></li>
<li>重啟 NAS.</li>
</ol>
</blockquote>
<h2 id="总结：">总结：</h2>
<p>为了安全和稳定性，有坏块后，备份数据，使用DiskGenius修复坏块，（只能修复逻辑坏块，不能修复物理坏块），然后最好全盘格式化再使用。</p>
<p>SDD可以使用低级格式化，但会全盘减少一次写寿命。尽量少用。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>qnap</category>
      </categories>
      <tags>
        <tag>QNAP</tag>
        <tag>nas</tag>
        <tag>SSD</tag>
        <tag>HDD</tag>
      </tags>
  </entry>
  <entry>
    <title>几种常用管理模型和方法</title>
    <url>/posts/ca630feb/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>这些只是基本的工具，你需要了解。但是，和行业相关的知识更重要。就像做数学题，把一堆错综复杂的线索中归纳总结出来问题，提出解决方法，这中间需要丰富的行业知识，这个没法速成。总结完后，执行阶段，就像数学加减乘除一样，这些是基本的工具和方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020449.jpeg" alt=""></p>
<h2 id="PDCA原则意义"><strong>PDCA原则意义</strong></h2>
<p>Plan：制定目标与计划；</p>
<p>Do：任务展开，组织实施；</p>
<p>Check：对过程中的关键点和最终结果进行检查；</p>
<p>Action：纠正偏差，对成果进行标准化，并确定新的目标，制定下一轮计划。</p>
<p>意义：每一项工作，都是一个pdca循环，都需要计划、实施、检查结果，并进一步进行改进，同时进入下一个循环，只有在日积月累的渐进改善中，才可能会有质的飞跃，才可能取得完善每一项工作，完善自己的人生。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020557.jpeg" alt=""></p>
<blockquote>
<h2 id="PDCA原则的八大步骤"><strong>PDCA原则的八大步骤</strong></h2>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020456.jpeg" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020603.jpeg" alt=""></p>
<h2 id="5W2H分析法的意义"><strong>5W2H分析法的意义</strong></h2>
<p>What：工作的内容和达成的目标；</p>
<p>Why：做这项工作的原因；</p>
<p>Who：参加这项工作的具体人员，以及负责人；</p>
<p>When：在什么时间、什么时间段进行工作；</p>
<p>Where：工作发生的地点 ；</p>
<p>Which：哪一种方法或途径；</p>
<p>How：用什么方法进行；</p>
<p>How much：需要多少成本？</p>
<p>意义：做任何工作都应该从6W2H来思考，这有助于我们的思路的条理化，杜绝盲目性。我们的汇报也应该用6W2H，能节约写报告及看报告的时间。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020503.jpeg" alt=""></p>
<blockquote>
<p><strong>5W2H分析法的内容</strong></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020610.jpeg" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020509.jpeg" alt=""></p>
<h2 id="SMART原则的意义"><strong>SMART原则的意义</strong></h2>
<p>Specific 具体的；</p>
<p>Measurable 可测量的；</p>
<p>Attainable 可达到的；</p>
<p>Relevant 相关的；</p>
<p>Time based 时间的；</p>
<p>意义：人们在制定工作目标或者任务目标时，考虑一下目标与计划是不是SMART化的。只有具备SMART化的计划才是具有良好可实施性的，也才能指导保证计划得以实现。</p>
<p>有的又如此解释此原则：</p>
<p>——S代表具体(Specific)，指绩效考核要切中特定的工作指标，不能笼统；</p>
<p>——M代表可度量(Measurable)，指绩效指标是数量化或者行为化的，验证这些绩效指标的数据或者信息是可以获得的；</p>
<p>——A代表可实现(Attainable)，指绩效指标在付出努力的情况下可以实现，避免设立过高或过低的目标；</p>
<p>——R代表现实性(realistic)，指绩效指标是实实在在的，可以证明和观察；</p>
<p>——T代表有时限(time bound)，注重完成绩效指标的特定期限。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020516.jpeg" alt=""></p>
<blockquote>
<p><strong>SMART原则实施要领</strong></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020517.jpeg" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020523.jpeg" alt=""></p>
<h2 id="STAR法则的意义"><strong>STAR法则的意义</strong></h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020529.jpeg" alt=""></p>
<blockquote>
<p><strong>STAR法则的内容</strong></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020621.jpeg" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020537.jpeg" alt=""></p>
<h2 id="SWOT分析模型的意义"><strong>SWOT分析模型的意义</strong></h2>
<p>Strengths：优势</p>
<p>Weaknesses：劣势</p>
<p>Opportunities：机会</p>
<p>Threats：威胁</p>
<p>意义：帮您清晰地把握全局，分析自己在资源方面的优势与劣势，把握环境提供的机会，防范可能存在的风险与威胁，对我们的成功有非常重要的意义。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020628.jpeg" alt=""></p>
<blockquote>
<p><strong>SWOT分析模型组合</strong></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020706.jpeg" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020634.jpeg" alt=""></p>
<h2 id="GROW教练模型的意义"><strong>GROW教练模型的意义</strong></h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020544.jpeg" alt=""></p>
<blockquote>
<p><strong>GROW教练模型的内容</strong></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819020641.jpeg" alt=""></p>
<h2 id="时间管理-重要与紧急"><strong>时间管理-重要与紧急</strong></h2>
<p>A、重要且紧急</p>
<p>紧急状况</p>
<p>迫切的问题</p>
<p>限期完成的工作</p>
<p>你不做其他人也不能做</p>
<p>B、重要不紧急</p>
<p>准备工作</p>
<p>预防措施</p>
<p>价值观的澄清</p>
<p>计划</p>
<p>人际关系的建立</p>
<p>真正的再创造</p>
<p>增进自己的能力</p>
<p>C、紧急不重要</p>
<p>造成干扰的事、电话、</p>
<p>信件、报告</p>
<p>会议</p>
<p>许多迫在眉捷的急事</p>
<p>符合别人期望的事</p>
<p>D、不重要不紧急</p>
<p>忙碌琐碎的事</p>
<p>广告函件</p>
<p>电话</p>
<p>逃避性活动</p>
<p>等待时间</p>
<p>优先顺序=重要性*紧迫性在进行时间安排时，应权衡各种事情的优先顺序，要学会“弹钢琴”；对工作要有前瞻能力，防患于未然，如果总是在忙于救火，那将使我们的工作永远处理被动之中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819015812.png" alt="揭秘人生七工具：SWOT、PDCA、6W2H、SMART、WBS、时间管理、OKR"></p>
<h2 id="任务分解法-WBS"><strong>任务分解法[WBS]</strong></h2>
<p>即Work Breakdown Structure，如何进行WBS分解：目标→任务→工作→活动</p>
<p><strong>WBS分解的原则：</strong></p>
<p>将主体目标逐步细化分解，最底层的任务活动可直接分派到个人去完成；每个任务原则上要求分解到不能再细分为止。</p>
<p><strong>WBS分解的方法：</strong></p>
<p>至上而下与至下而上的充分沟通；</p>
<p>一对一个别交流；</p>
<p>小组讨论。</p>
<p><strong>WBS分解的标准：</strong></p>
<p>分解后的活动结构清晰；</p>
<p>逻辑上形成一个大的活动；</p>
<p>集成了所有的关键因素包含临时的里程碑和监控点；</p>
<p>所有活动全部定义清楚。</p>
<p>意义：学会分解任务，只有将任务分解得足够细，您才能心里有数，您才能有条不紊地工作，您才能统筹安排您的时间表。</p>
<h2 id="OKR，目标与关键结果"><strong>OKR，目标与关键结果</strong></h2>
<p>OKR 实施过程中起草制定好目标和关键结果是非常重要的一环，有效的 OKR 制定需要满足 SMART 原则——明确的、可衡量的、可实现的、有相关性和有时限性。</p>
<p>目标（O）回答的是“我们想做什么”的问题，是定性的，要求能够鼓舞人心，激发团队共鸣。</p>
<p>关键结果（KR）回答的是“我们如何知道自己是否达成了目标要求”的问题，是定量的，设计 KR 最具挑战的部分是如何把目标中定性的描述抽象为定量的表示。</p>
<p>最后：只有掌握了正确科学的工作方法，才可能在未来的工作中，做到事半功倍的效果，才能更加从容且有重点的开展工作。好的工作方法，是成功的一半！</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>PMBOK</category>
      </categories>
      <tags>
        <tag>管理</tag>
        <tag>PDCA</tag>
        <tag>5W2H</tag>
        <tag>SMART</tag>
        <tag>SWOT</tag>
        <tag>GROW</tag>
        <tag>OKR</tag>
        <tag>WBS</tag>
      </tags>
  </entry>
  <entry>
    <title>qBittorrent 参数详细设置教程</title>
    <url>/posts/f6b32521/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>全文将以目前的最新版v4.2.1为例，进行参数设置，老版本某些功能不太一致，请知悉。特别鸣谢 原创者：Evine！</p>
<h2 id="行为参数">行为参数</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818154449.jpeg" alt="qBittorrent参数详细设置教程"></p>
<h2 id="下载参数">下载参数</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818154453.jpeg" alt="qBittorrent参数详细设置教程"></p>
<h2 id="连接参数">连接参数</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818154528.jpeg" alt="qBittorrent参数详细设置教程"></p>
<h2 id="速度参数">速度参数</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818154500.jpeg" alt="qBittorrent参数详细设置教程"></p>
<h2 id="BT参数">BT参数</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818154539.jpeg" alt="qBittorrent参数详细设置教程"></p>
<h2 id="RSS设置">RSS设置</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818154502.png" alt="qBittorrent参数详细设置教程"></p>
<h2 id="web参数">web参数</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818154508.jpeg" alt="qBittorrent参数详细设置教程"></p>
<h2 id="高级参数">高级参数</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818154558.jpeg" alt="qBittorrent参数详细设置教程"></p>
<h3 id="关于磁盘缓存的补充说明："><strong>关于磁盘缓存的补充说明：</strong></h3>
<p>经常有人吐槽qB特别吃内存，个人猜测应该是磁盘缓存设置不正确导致的。磁盘缓存设置过小，磁盘缓存到期间隔过长，先下载的文件块来不及写入硬盘，新的文件块又到了，可能就会导致内存爆掉甚至磁盘I/O错误。个人建议：在进行高速下载时，适当将磁盘缓存调高，磁盘缓存到期间隔调低（下载时间隔越低写入越频繁，自己根据电脑的资源占用情况调整最适合自己的值）。实在不知道怎么调的，就干脆把磁盘缓存设置为-1（自动）好了，还不行，就把磁盘缓存到期间隔再调低一些。举一个例子，比如设置2048MiB磁盘缓存、300s磁盘缓存到期间隔时，当下载速度为50MiB/s的时候，300s的时间总共可以下载15000MiB，早就远远超过2048MiB了，不爆内存、不I/O错误才怪。所以当达到这个下载速度的时候，在磁盘缓存不变的情况下，根据简单的除法（磁盘缓存除以下载速度）可知，磁盘缓存到期间隔就应该设置到40s以下了。</p>
<p>qB在正常运行后，其占用的内存会比你所设置的磁盘缓存多几百M。所有的参数没有标准答案，一切都得根据你机子的本身属性以及实际的使用场景（比如CPU性能、内存大小、硬盘写入速度、下载速度等）来设置，建议大家多试验。</p>
<h3 id="关于TCP、UTP的补充说明："><strong>关于TCP、UTP的补充说明：</strong></h3>
<p>TCP是Internet上最常用的协议，是一种面向连接的、可靠的、基于字节流的传输层通信协议。TCP的优势在于双向互动机制兼顾数据传输的完整性、可控制性和可靠性，但复杂的校验与控制机制也使其没有UDP传输效率高。</p>
<p>UDP协议与TCP协议一样用于处理数据包，是一种无连接的协议。UDP的缺点是不提供数据包分组、组装和不能对数据包进行排序的缺点，也就是说，当报文发送之后，是无法得知其是否安全完整到达的。UDP优势在于带宽占用小、传输效率和连接成功率高，有益于内网用户（如通过UDP内网穿透UDP Hole Punching连接），但UDP与TCP协议相比也存在无反向确认机制、无流量和序列控制等弊端。</p>
<p>uTP(Micro Transport Protocol)是一种正在标准化的开放式BT协议，主要功能是提高宽带使用效率、减少网络问题。在减缓网络延迟和拥堵的同时最大化网络吞吐量、克服多数防火墙和NAT的阻碍，增强网络穿透和传输效率，同时增益流量控制，这对BT用户和ISP都是互利的。uTP虽基于UDP协议但有所不同，uTP通过拥堵控制算法（Ledbat）可限制延时，当延时不严重时可最大限度利用带宽，并能通过uTP提供的信息用于选择TCP连接的传输率，即使在不作限速设置的情况下，也能减少网络拥堵产生，当用户端之间都启用uTP时，可见明显的传输速率提升。内网无法实现端口映射的用户启用uTP，可以改善与网外用户的连接。</p>
<p>使用uTP进行连接的用户，其标志将包含“P”。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>bt</category>
      </categories>
      <tags>
        <tag>QNAP</tag>
        <tag>nas</tag>
        <tag>PT</tag>
        <tag>BT</tag>
        <tag>qbittorrent</tag>
      </tags>
  </entry>
  <entry>
    <title>transmission 使用及其配置</title>
    <url>/posts/8f76d9dd/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="安装">安装</h2>
<h3 id="qnapclub"><strong>qnapclub</strong></h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818163248.png" alt=""></p>
<h3 id="docker"><strong>docker</strong></h3>
<p><a target="_blank" rel="noopener" href="https://hub.docker.com/r/linuxserver/transmission">docker hub</a></p>
<blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"2.1"</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">transmission</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/linuxserver/transmission
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> transmission
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> PUID=1000
      <span class="token punctuation">-</span> PGID=1000
      <span class="token punctuation">-</span> TZ=Europe/London
      <span class="token punctuation">-</span> TRANSMISSION_WEB_HOME=/combustion<span class="token punctuation">-</span>release/ <span class="token comment">#optional</span>
      <span class="token punctuation">-</span> USER=username <span class="token comment">#optional</span>
      <span class="token punctuation">-</span> PASS=password <span class="token comment">#optional</span>
      <span class="token punctuation">-</span> WHITELIST=iplist <span class="token comment">#optional</span>
      <span class="token punctuation">-</span> HOST_WHITELIST=dnsnane list <span class="token comment">#optional</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> &lt;path to data<span class="token punctuation">&gt;</span><span class="token punctuation">:</span>/config
      <span class="token punctuation">-</span> &lt;path to downloads<span class="token punctuation">&gt;</span><span class="token punctuation">:</span>/downloads
      <span class="token punctuation">-</span> &lt;path to watch folder<span class="token punctuation">&gt;</span><span class="token punctuation">:</span>/watch
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 9091<span class="token punctuation">:</span><span class="token number">9091</span>
      <span class="token punctuation">-</span> 51413<span class="token punctuation">:</span><span class="token number">51413</span>
      <span class="token punctuation">-</span> 51413<span class="token punctuation">:</span>51413/udp
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<h2 id="控制脚本">控制脚本</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/etc/init.d/QTransmission.sh start
/etc/init.d/QTransmission.sh stop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="Transmission-配置详解">Transmission 配置详解</h2>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vi</span> /share/CACHEDEV1_DATA/.qpkg/QTransmission/etc/settings.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"alt-speed-up"</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> # 限速时段上传限速值
<span class="token property">"alt-speed-down"</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> # 限速时段下载限速值
<span class="token property">"alt-speed-enabled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">"alt-speed-time-begin"</span><span class="token operator">:</span> <span class="token number">540</span><span class="token punctuation">,</span>
<span class="token property">"alt-speed-time-day"</span><span class="token operator">:</span> <span class="token number">127</span><span class="token punctuation">,</span> # 时段限速日期（星期几），<span class="token number">127</span> 表示每天，更复杂配置参考官网。用 <span class="token number">7</span> 位二进制数表示，然后转换成十进制数，<span class="token number">0000001</span> 表示周日，<span class="token number">1000000</span> 表示周六，<span class="token number">0000010</span> 表示周一，<span class="token number">0000100</span> 表示周二。如果你只要在周末限速，该数应该 <span class="token number">1000001</span>，转换为十进制就是 <span class="token number">65</span>
<span class="token property">"alt-speed-time-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> # 启用限速，为 <span class="token boolean">false</span> 时，以上计划配置则不生效，生效时会自动禁用 alt-speed-enabled 配置，二者只能选一个
<span class="token property">"alt-speed-time-end"</span><span class="token operator">:</span> <span class="token number">420</span><span class="token punctuation">,</span> # 限速时段结束时间，这个配置表示的是凌晨零点到开始时间的分钟数，比如 <span class="token number">7</span><span class="token operator">:</span><span class="token number">00</span> 就是 <span class="token number">7</span>*<span class="token number">60</span>=<span class="token number">420</span>。需要注意的是，该时间是用的 GMT 时间，即北京时间 <span class="token number">-8</span> 小时。比如你计划北京时间 <span class="token number">7</span> 点 <span class="token number">30</span> 分开始，这个数字应该是（<span class="token number">7</span><span class="token number">-8</span>+<span class="token number">24</span>）*<span class="token number">60</span>+<span class="token number">30</span>=<span class="token number">1410</span>
<span class="token property">"bind-address-ipv4"</span><span class="token operator">:</span> <span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> # IPv4 地址绑定，一般不要改动
<span class="token property">"bind-address-ipv6"</span><span class="token operator">:</span> <span class="token string">"::"</span><span class="token punctuation">,</span> #IPv6 地址绑定，一般不要改动
<span class="token property">"blocklist-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> # 启动白名单，默认不启动，需要启动改为 <span class="token boolean">true</span>
<span class="token property">"blocklist-updates-enabled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">"blocklist-url"</span><span class="token operator">:</span> <span class="token string">"http://www.example.com/blocklist"</span><span class="token punctuation">,</span>
<span class="token property">"cache-size-mb"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> #缓存大小，以 MB 为单位，建议设大一些，避免频繁读写硬盘而伤硬盘，建议设为内存大小的 <span class="token number">1</span>/<span class="token number">6</span>～<span class="token number">1</span>/<span class="token number">4</span>
<span class="token property">"compact-view"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">"dht-enabled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> #关闭 DHT（不通过 tracker 寻找节点）功能，不少 PT 站的要求，但 BT 下载设置为 <span class="token boolean">true</span> 会使得下载更好
<span class="token property">"download-dir"</span><span class="token operator">:</span> <span class="token string">"/share/Downloads"</span><span class="token punctuation">,</span> #下载的内容存放的目录
<span class="token property">"download-queue-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  # 下载队列开关
<span class="token property">"download-queue-size"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> # 下载队列数量
<span class="token property">"encryption"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> # 加密。指定节点的加密模式，默认 <span class="token number">1</span>。<span class="token number">0</span> 表示关闭 <span class="token punctuation">,</span> <span class="token number">0</span>= 不加密，<span class="token number">1</span>= 优先加密，<span class="token number">2</span>= 必须加密
<span class="token property">"lazy-bitfield-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> # 默认为 <span class="token boolean">true</span>，设置为 <span class="token boolean">true</span> 时可以避免某些 ISP 通过查询完整位段来屏蔽 BT，从而破解部分 ISP 对 BT 的封杀，当然不一定完全有效
<span class="token property">"idle-seeding-limit"</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
<span class="token property">"idle-seeding-limit-enabled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">"incomplete-dir"</span><span class="token operator">:</span> <span class="token string">"/share/Downloads"</span><span class="token punctuation">,</span>  # 临时文件路径
<span class="token property">"incomplete-dir-enabled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">"inhibit-desktop-hibernation"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">"lpd-enabled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> #禁用 LDP（本地节点发现，用于在本地网络寻找节点）<span class="token punctuation">,</span> 不少 PT 站的要求
<span class="token property">"main-window-height"</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
<span class="token property">"main-window-is-maximized"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token property">"main-window-width"</span><span class="token operator">:</span> <span class="token number">615</span><span class="token punctuation">,</span>
<span class="token property">"main-window-x"</span><span class="token operator">:</span> <span class="token number">337</span><span class="token punctuation">,</span>
<span class="token property">"main-window-y"</span><span class="token operator">:</span> <span class="token number">211</span><span class="token punctuation">,</span>
<span class="token property">"message-level"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token property">"open-dialog-dir"</span><span class="token operator">:</span> <span class="token string">"/share/Download"</span><span class="token punctuation">,</span>  # 网页对话框打开的根目录
<span class="token property">"peer-congestion-algorithm"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
<span class="token property">"peer-limit-global"</span><span class="token operator">:</span> <span class="token number">240</span><span class="token punctuation">,</span> # 全局连接数
<span class="token property">"peer-limit-per-torrent"</span><span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span> # 每个种子最多的连接数
<span class="token property">"peer-port"</span><span class="token operator">:</span> <span class="token number">51413</span><span class="token punctuation">,</span> # 传入端口，预设的 port 口
<span class="token property">"peer-port-random-high"</span><span class="token operator">:</span> <span class="token number">65535</span><span class="token punctuation">,</span> # 传入端口随机值范围上限
<span class="token property">"peer-port-random-low"</span><span class="token operator">:</span> <span class="token number">49152</span><span class="token punctuation">,</span> # 传入端口随机值范围下限
<span class="token property">"peer-port-random-on-start"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> # 启用随机端口，默认关闭，不建议改为 <span class="token boolean">true</span>
<span class="token property">"peer-socket-tos"</span><span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>
<span class="token property">"pex-enabled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> # 是否启用用户交换，默认为 <span class="token boolean">true</span>，关于 PEX，有兴趣的朋友可参考 http<span class="token operator">:</span><span class="token comment">//en.wikipedia.org/wiki/Peer_exchange，对于只用 PT 的朋友，可以设为 false, 禁用 PEX（节点交换，用于同已与您相连接的节点交换节点名单）, 不少 PT 站的要求</span>
<span class="token property">"port-forwarding-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> # 启用端口转发（uPnP），如果路由支持并且也开启了 uPnP，则路由会自动做端口映射，但是需要注意的是如果内网有几台机器同时使用 transmission，就必须更改 peer-port 值为不一样
<span class="token property">"preallocation"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> # 预分配文件磁盘空间，<span class="token number">0</span>= 关闭，<span class="token number">1</span>= 快速，<span class="token number">2</span>= 完全。建议取 <span class="token number">1</span> 开启该功能，防止下载大半了才发现磁盘不够。取 <span class="token number">2</span> 时，可以减少磁盘碎片，但速度较慢。
<span class="token property">"prefetch-enabled"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token property">"queue-stalled-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">"queue-stalled-minutes"</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
<span class="token property">"ratio-limit"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> # 分享率限制
<span class="token property">"ratio-limit-enabled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> # 启用分享率限制，默认不启用
<span class="token property">"rename-partial-files"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> #在未完成的文件名后添加后缀.part<span class="token punctuation">,</span><span class="token boolean">false</span>= 禁用
<span class="token property">"rpc-authentication-required"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> # 远程控制需要验证，默认为需要
<span class="token property">"rpc-bind-address"</span><span class="token operator">:</span> <span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> # 远程控制地址绑定，允许 IP 通过 RPC 访问，默认值表示任何地址都可以访问
<span class="token property">"rpc-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> # 启用远程控制，默认启用
<span class="token property">"rpc-host-whitelist-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> # 是否开启主机白名单
<span class="token property">"rpc-host-whitelist"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> # 白名单，如果需要远程访问，最好配置
<span class="token property">"rpc-password"</span><span class="token operator">:</span> <span class="token string">"{cxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxaE"</span><span class="token punctuation">,</span> #web-ui 的密码，可直接修改，重新运行或者 reload 服务的时候密码会自动 HASH 增加安全性
<span class="token property">"rpc-port"</span><span class="token operator">:</span> <span class="token number">9091</span><span class="token punctuation">,</span> # 默认 web-ui 的 port 口，也是远程控制端口，可自行更改
<span class="token property">"rpc-url"</span><span class="token operator">:</span> <span class="token string">"/transmission/"</span><span class="token punctuation">,</span>
<span class="token property">"rpc-username"</span><span class="token operator">:</span> <span class="token string">"transmission"</span><span class="token punctuation">,</span> #默认登入名称，也是远程控制用户名
<span class="token property">"rpc-whitelist"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> # 远程控制白名单，默认值为所有地址，支持通配符*，如 <span class="token number">192.168</span>.<span class="token number">2</span>.*
<span class="token property">"rpc-whitelist-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> # 启用远程控制白名单，如果启用，则仅仅上面列出的地址可以远程连接
<span class="token property">"scrape-paused-torrents-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">"script-torrent-done-enabled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">"script-torrent-done-filename"</span><span class="token operator">:</span> <span class="token string">"/home/"</span><span class="token punctuation">,</span>
<span class="token property">"seed-queue-enabled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">"seed-queue-size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
<span class="token property">"show-backup-trackers"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">"show-extra-peer-details"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">"show-filterbar"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">"show-notification-area-icon"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">"show-options-window"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">"show-statusbar"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">"show-toolbar"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">"show-tracker-scrapes"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">"sort-mode"</span><span class="token operator">:</span> <span class="token string">"sort-by-age"</span><span class="token punctuation">,</span>
<span class="token property">"sort-reversed"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">"speed-limit-down"</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span> #平时的下载限速
<span class="token property">"speed-limit-down-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> #启用平时下载限速
<span class="token property">"speed-limit-up"</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span> #平时上传限速
<span class="token property">"speed-limit-up-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> #启用平时上传限速
<span class="token property">"start-added-torrents"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">"statusbar-stats"</span><span class="token operator">:</span> <span class="token string">"total-ratio"</span><span class="token punctuation">,</span>
<span class="token property">"torrent-added-notification-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">"torrent-complete-notification-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">"torrent-complete-sound-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">"trash-can-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">"trash-original-torrent-files"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">"umask"</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
<span class="token property">"upload-slots-per-torrent"</span><span class="token operator">:</span> <span class="token number">14</span>
<span class="token property">"utp-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> #启用μTP 协议
<span class="token property">"watch-dir"</span><span class="token operator">:</span> <span class="token string">"/share/bt"</span><span class="token punctuation">,</span>  # 监听文件夹目录
<span class="token property">"watch-dir-enabled"</span><span class="token operator">:</span> <span class="token boolean">false</span> # 是否监听文件夹<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Q：TR提示FILE-NAME-TOO-LONG">Q：TR提示FILE NAME TOO LONG</h3>
<p>A：TR最大文件名MAX_PATH ,260个字符<br>
方法1：改路径和保存路径的文件夹名字，越短越好，在web control种子上面右键，修改种子文件或目录名称。次选方法，不勾选下载文件名过长的文件</p>
<p>方法2：遇到个名字特长的，一直下载失败，使用软连接进一步缩短路径名长度</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#cd /</span>
<span class="token comment">#ln -s  /share/CACHEDEV1_DATA/Download/ DL</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>方法3：<br>
上面两种还是不行，换QBittorrent吧</p>
<p>不过，最近有好消息，这个bug我去看了下源代码，找到原来有人试图修复过它，但是并没有合并到最新版本。发个post提醒bug没有修复，居然有回复了。这个bug将在3.0版本修复，见<a target="_blank" rel="noopener" href="https://github.com/transmission/transmission/issues/122"><strong>下图</strong></a>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1820210818164746.png" alt=""></p>
<h3 id="Q-transmission-如何修改登陆密码">Q: transmission 如何修改登陆密码</h3>
<p>A: 第一种方式<br>
qnap 中，transmission3.0的配置文件路径如下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/share/CACHEDEV1_DATA/.qpkg/QTransmission3/etc/settings.json
 
<span class="token builtin class-name">cd</span> /share/CACHEDEV1_DATA/.qpkg/QTransmission3/etc/settings.json
<span class="token function">vim</span> settings.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>找到”rpc-password”:</p>
<p>后面引号内就是经过加密的密码，不要管他怎么加密的，直接把引号内的内容修改为你的新密码就可以了，比如”rpc-password”:”xxorg.com”</p>
<p>然后按“ESC”键，输入:wq 保存退出，然后重启tr即可</p>
<p>第二种方式：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1、控制台输入，-u后边是用户名，-v后边跟着的是登陆密码</span>
transmission-daemon --paused -t -u admin -v <span class="token number">123456</span>
<span class="token comment"># 将会把生成的密码保存到：~/.config/transmission-daemon/settings.json</span>
<span class="token comment"># 其实是生成配置文件并保存到当前登陆用户的家目录下</span>
<span class="token comment"># 2、打开~/.config/transmission-daemon/settings.json并复制加密的密码</span>
<span class="token comment"># 3、将加密的密码粘贴到/media/AiCard_01/transmission/config/settings.json</span>
<span class="token comment"># 替换掉内容为：rpc-password 后面的密码</span>
<span class="token comment"># 4、重启Transmission</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ps:通过ps定位transmission位置</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> trans
<span class="token comment"># cd /share/CACHEDEV1_DATA/.qpkg/QTransmission3/bin</span>
<span class="token comment"># ./transmission-daemon --paused -t -u [name] -v [password]</span>
<span class="token comment"># cd ~/.config/transmission-daemon</span>
<span class="token punctuation">[</span>~/.config/transmission-daemon<span class="token punctuation">]</span> <span class="token comment"># vi settings.json</span>
复制生成的密码到前面的配置文件里面。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Q-为Transmission增加种子目录监控，实现自动下载">Q: 为Transmission增加种子目录监控，实现自动下载</h3>
<p>/share/CACHEDEV3_DATA/.qpkg/QTransmission3/etc</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">改/var/packages/transmission/target/var/settings.json 在最后面增加<span class="token number">2</span>行。
<span class="token property">"upload-slots-per-torrent"</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span>（原文件最后一行，注意添加个逗号，不添加transmission好像不能启动） 
<span class="token property">"watch-dir"</span><span class="token operator">:</span> <span class="token string">"/XXXXX/XXXXX"</span><span class="token punctuation">,</span> （修改成自己nas上的同步目录） 
<span class="token property">"watch-dir-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span>（无逗号）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>保存，退出。</p>
<p>启动Transmission  等待1-2分钟，就好了。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">    <span class="token property">"speed-limit-up-enabled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"start-added-torrents"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"trash-original-torrent-files"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"umask"</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
    <span class="token property">"upload-slots-per-torrent"</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span>
    <span class="token property">"utp-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"watch-dir"</span><span class="token operator">:</span> <span class="token string">"/share/Download/Seed/complete"</span><span class="token punctuation">,</span>
    <span class="token property">"watch-dir-enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Q-Nas-上面-Transmission-如何做种？">Q: Nas 上面 Transmission 如何做种？</h3>
<p><strong>A:</strong></p>
<p>注意，此方法仅适用于开启了ssh的机器<br>
可以看到可执行文件目录下有这么几个文件，每个人的安装目录都不一样，自行查找，或用<br>
我的文件位置是在/volume1/@appstore/transmission/bin，用到的命令是 transmission-create</p>
<p>方法也很简单，写一个范例</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./transmission-create -p -o /volume1/data/Wi
kiLeaks-Year-Zero-2017-v1.torrent -t https://announce.XXXXXXXXXX.cc/announce.php -s <span class="token number">2048</span> /volume1/da
ta/WikiLeaks-Year-Zero-2017-v1.7z <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>参数<br>
-p 表示这是私用的种子，这个必须要加上<br>
-o 生成的种子输出位置，不要忘记把名字打上<br>
-t tracker的地址，我用的家园的做范本，大家自行修改<br>
-s 每个文件块的大小，单位是KB，我设置的是2M，也就是2048KB<br>
最后空一格写源文件的位置，也就是文件的存放位置，可以是一个文件或者一整个目录<br>
最后可以空一行加一个&amp;，这样即使关掉窗口也可以在后台运行<br>
填完，回车，种子就在制作了</p>
<p>种子已经躺在这了</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>/opt/QTransmission3/bin<span class="token punctuation">]</span> <span class="token comment"># ./transmission-create -p -o /share/CACHEDEV1_DATA/Download/Seed/海贼王\ \(1999\).torrent -t https://announce.XXXXXXXX.video/announce.php -s 2048 /share/CACHEDEV1_DATA/Download/海贼王\ \(1999\)/ &amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>bt</category>
      </categories>
      <tags>
        <tag>QNAP</tag>
        <tag>nas</tag>
        <tag>PT</tag>
        <tag>BT</tag>
        <tag>transmission</tag>
      </tags>
  </entry>
  <entry>
    <title>使用jeckett,sonarr,iyuu,qt,emby打造全自动追剧流程</title>
    <url>/posts/9912bd5d/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>使用jeckett,sonarr,iyuu,qt,emby打造全自动追剧流程，打造一个完整的HTPC。</p>
<p><strong>持续滚动更新</strong>，欢迎收藏关注。也可以<a href="https://blog.17lai.site/atom.xml">RSS订阅</a>本博客！</p>
<p>jackett 作为种子源，sonarr剧集管理，bt下载，qbittorrent主力下载，使用iyuu转移辅种，emby，jellyfin做海报墙，sunfinder自动下载字幕。基本算是完美打通全流程自动追剧。bt种子文件命名规则SxxExx的自动识别下载，国内的资源手动查找下载，自动推送到emby刮削好。</p>
<p>结合本地DNS管理，DNS去广告，Nginx 反向代理去端口访问，形成一个完整解决方案。</p>
<p>硬链接工具导入到新目录，使用TMM刮削。</p>
<p>Tips：博主只是把个人使用经验的一部分<em><strong>无偿</strong></em>写下来，写完后发现整理流程很复杂，要求很高，博主整体软硬件成本上2W以上了。各位读者赶着看得懂的做，如果看不懂，请略过，或者Google之。</p>
</blockquote>
<h2 id="indexer-种子索引源"><strong>indexer 种子索引源</strong></h2>
<p>种子索引来源。</p>
<h3 id="jackett"><strong>jackett</strong></h3>
<ul>
<li>docker: linuxserver/jackett:latest</li>
<li>老牌选手，种子源非常丰富。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819002543.png" alt="jackett 界面"></p>
<h3 id="prowlarr"><strong>prowlarr</strong></h3>
<ul>
<li>indexer manager/proxy</li>
<li>Docker:  <a target="_blank" rel="noopener" href="https://hub.docker.com/r/linuxserver/prowlarr">linuxserver/prowlarr:develop</a></li>
<li>新开发的，和sonarr, lidarr等结合比jackett 配置更简单。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819002628.png" alt="prowlarr"></p>
<h2 id="sonarr动画剧集管理"><strong>sonarr动画剧集管理</strong></h2>
<p>管理剧集名，查找剧集种子推送到下载工具</p>
<p>剧集管理示例图片</p>
<p>管理剧集目录，剧集日历，提醒你那一天哪些节目播放</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819001244.png" alt="sonarr"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819211051.png" alt="sonarr 日历提醒"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819001328.png" alt="sonarr"></p>
<p>自动识别下载对英文剧集支持较好，对于中文资源，结合手动识别下载更佳。</p>
<h3 id="手动识别下载"><strong>手动识别下载</strong></h3>
<p>示例图片</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819001055.png" alt="sonarr"></p>
<p>电影使用radarr, 音乐使用lidarr，同样可以自动化过程</p>
<h2 id="多媒体中心">多媒体中心</h2>
<blockquote>
<p>Emby，Jellyfin, Plex都是优秀的多媒体中心。Jellyfin是开源的，基于Emby早期版本。</p>
</blockquote>
<h3 id="emby海报墙，流媒体中心"><strong>emby海报墙，流媒体中心</strong></h3>
<p>emby作为海报墙，元数据查看器，结合tampermonkey js脚本调用外部potplayer播放减少nas服务器压力，并且得到更好解码性能。手机端也有emby客户端。jellyfin，plex也可以</p>
<p>js脚本: <a target="_blank" rel="noopener" href="https://greasyfork.org/scripts/406811-embylaunchpotplayer/code/embyLaunchPotplayer.user.js">embyLaunchPotplayer</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819001419.png" alt="emby"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819000847.png" alt="emby"></p>
<h3 id="jellyfin-开源版本的emby"><strong>jellyfin 开源版本的emby</strong></h3>
<ul>
<li>jellyfin硬件解码</li>
<li>jellyfin中文字体显示方块问题</li>
</ul>
<p>上面两个问题见下面compose 配置解决方法</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">jellyfin</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> jellyfin/jellyfin
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> jellyfin
    <span class="token key atrule">user</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>PUID<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>PGID<span class="token punctuation">}</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> jellyfin
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">devices</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> /dev/dri<span class="token punctuation">:</span>/dev/dri     <span class="token comment">#使jellfin支持硬件解码</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> PUID=$<span class="token punctuation">{</span>PUID<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> PGID=$<span class="token punctuation">{</span>PGID<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> TZ=$<span class="token punctuation">{</span>TZ<span class="token punctuation">}</span>
      <span class="token comment"># 给一些插件做代理</span>
      <span class="token punctuation">-</span> http_proxy=http<span class="token punctuation">:</span>//xxx.17lai.site<span class="token punctuation">:</span>1089/
      <span class="token punctuation">-</span> https_proxy=http<span class="token punctuation">:</span>//xxx.17lai.site<span class="token punctuation">:</span>1089/
    <span class="token comment"># ports:    # 使用nginx 反向代理，所以这里就不用开端口了</span>
      <span class="token comment"># - 8098:8096</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> $<span class="token punctuation">{</span>USERDIR<span class="token punctuation">}</span>/jellyfin/config<span class="token punctuation">:</span>/config
      <span class="token punctuation">-</span> $<span class="token punctuation">{</span>USERDIR<span class="token punctuation">}</span>/jellyfin/cache<span class="token punctuation">:</span>/cache
      <span class="token comment"># 把windowsfonts目录下面的字体都复制到`jellyfin/fonts`目录中</span>
      <span class="token punctuation">-</span> $<span class="token punctuation">{</span>USERDIR<span class="token punctuation">}</span>/jellyfin/fonts<span class="token punctuation">:</span>/usr/share/fonts    <span class="token comment"># 给jellyfin装载更多字体，使中文显示正确，不再是方块</span>
      <span class="token punctuation">-</span> $<span class="token punctuation">{</span>USERDIR<span class="token punctuation">}</span>/nginx/resolv.conf<span class="token punctuation">:</span>/etc/resolv.conf    <span class="token comment"># 定制dns</span>
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>赋予emby，jellyfin访问硬件加速驱动权限</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token number">755</span> /dev/dri
<span class="token function">chmod</span> <span class="token number">666</span> /dev/dri/renderD128<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="TMM刮削，改名，目录整理"><strong>TMM刮削，改名，目录整理</strong></h2>
<blockquote>
<p>电影，电视剧，动画等视频为了更好的体验效果，需要刮削元数据。</p>
</blockquote>
<p>一些命名不规范，不能被emby识别的剧集使用tmm刮削改名，配合硬链接工具，可以不影响做种的前提下改名，该目录。大文件硬链接，小文件直接复制方便刮削，推荐一个自己写的硬链接bash shell脚本，PTtool在nas，linux环境使用更方便。</p>
<p>电影，电视剧，动画完整刮削教程，见<a href="https://blog.17lai.site/video/2021-10-11-how-to-scrape-video-whit-tinymediamanager/">如何使用tinyMediaManager刮削电影和电视剧，动画，并自动下载字幕</a>。</p>
<blockquote>
<ul>
<li>
<p>Github: <a target="_blank" rel="noopener" href="https://github.com/appotry/PTtool">appotry/PTtool</a></p>
</li>
<li>
<p>Gitee: 镜像 <a target="_blank" rel="noopener" href="https://gitee.com/bloodwolf/PTtool">bloodwolf/PTtool</a></p>
</li>
<li>
<p><a href="https://blog.17lai.site/video/2021-10-11-how-to-scrape-video-whit-tinymediamanager/">如何使用tinyMediaManager刮削电影和电视剧，动画，并自动下载字幕</a></p>
</li>
</ul>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819001155.png" alt="tmm"></p>
<p>注意：使用v3版本，不要升级到v4，v4版本收费。</p>
<h2 id="硬链接工具"><strong>硬链接工具</strong></h2>
<blockquote>
<ul>
<li>
<p>博主编写的脚本，自推一下，在Nas，linux环境使用的Shell 脚本。</p>
</li>
<li>
<p>PT hard link tools。方便PT用户硬链接文件，在最大可能情况下节约空间，并保持做种。 小于1M的文件直接复制，方便emby，tmm等工具刮削修改nfo等小文件。 大于1M的文件硬链接到目的目录，可以随意修改文件名，但是不能修改文件内容！</p>
</li>
<li>
<p>从此，做种，刮削改名两不误！</p>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><strong>Github</strong>: <a target="_blank" rel="noopener" href="https://github.com/appotry/PTtool"><strong>PTools</strong></a></li>
<li><strong>使用教程</strong>： <a href="https://blog.17lai.site/blogging/pt/2021-07-09-linux-pt-hard-link-tools/"><strong>Linux PT硬链接助手使用教程</strong></a></li>
</ul>
</blockquote>
<h2 id="BT下载工具"><strong>BT下载工具</strong></h2>
<blockquote>
<p>qBittorrent下载，种子分类整理较好，但占用资源，内存较多。Transmissoin种子整理分类远不如qBittorrent，但资源占用低，是PT做种混魔力的首选！建议qBittorrent和Transmissoin搭配使用，使用Iyuu自动在两者之间转移种子。</p>
</blockquote>
<h3 id="Transmissoin"><strong>Transmissoin</strong></h3>
<ul>
<li><a href="https://blog.17lai.site/bt/2021-08-18-transmission-parameter-reference-configuration/"><strong>transmission 使用及其配置</strong></a></li>
</ul>
<h3 id="qBittorrent">qBittorrent</h3>
<ul>
<li><a href="https://blog.17lai.site/bt/2021-08-18-qbittorrent-parameter-reference-configuration/"><strong>qBittorrent 参数详细设置教程</strong></a></li>
</ul>
<p>都分别有docker版本和套件版本。</p>
<p>虽然下载工具很多，但IYUU只支持这两个辅种工具，开发者的话是这两个工具的RPC调用接口稳定。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819005826.png" alt="Transmissoin"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819005858.png" alt="qBittorrent"></p>
<h2 id="辅种工具IYUU"><strong>辅种工具IYUU</strong></h2>
<p><strong>Doker版本</strong></p>
<ul>
<li>
<p><a target="_blank" rel="noopener" href="https://hub.docker.com/r/iyuucn/iyuuautoreseed">iyuucn/iyuuautoreseed</a></p>
<blockquote>
<p>命令行版本</p>
</blockquote>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://hub.docker.com/r/iyuucn/iyuuplus">iyuucn/iyuuplus</a></p>
<blockquote>
<p>图形界面版本，更轻松上手。</p>
</blockquote>
</li>
</ul>
<p>自动辅种，解放双手，更多魔力，更容易养多站。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819010407.png" alt="iyuuplus"></p>
<h2 id="字幕下载"><strong>字幕下载</strong></h2>
<p>想要较好的自动下载字幕，最好用前面介绍的tmm刮削改名之后再使用下面工具。</p>
<h3 id="subfinder-自动下载字幕">subfinder 自动下载字幕</h3>
<ul>
<li>Docker： <a target="_blank" rel="noopener" href="https://hub.docker.com/r/superng6/subfinder">superng6/subfinder</a></li>
</ul>
<p>下载完成，刮削后的目录，挂载到subfinder的media目录，就会自动下载字幕。</p>
<p>字幕下载对电影，英文剧集支持较好。对于一些tv，动画手动下载字幕会更好一些。</p>
<p>注意：官方的配置文件有问题，时效问题。修改URL到最新即可。</p>
<h3 id="chinesesubfinder">chinesesubfinder</h3>
<ul>
<li>
<h3 id="Docker：-allanpk716-chinesesubfinder">Docker： <a target="_blank" rel="noopener" href="https://hub.docker.com/r/allanpk716/chinesesubfinder">allanpk716/chinesesubfinder</a></h3>
</li>
<li>
<p>新开发的中文字幕查找工具，上面那个很久没更新了，这个刚出来。使用nfo里面刮削出来的文件名来匹配字幕。所以就原理来说，这个字幕匹配更准确。</p>
</li>
</ul>
<h3 id="bazarr">bazarr</h3>
<ul>
<li>Docker：<a target="_blank" rel="noopener" href="https://hub.docker.com/r/linuxserver/bazarr">linuxserver/bazarr</a></li>
<li>字幕下载管理，配合sonarr, radarr 使用效果更好。对于英文剧集命名规范的支持较好，比如<code>[name]S01E01</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819002816.png" alt="bazarr"></p>
<hr>
<h2 id="电影管理">电影管理</h2>
<blockquote>
<p>电影，电视剧，动画等视频都是类似。</p>
</blockquote>
<h3 id="使用radarr管理电影"><strong>使用radarr管理电影</strong></h3>
<p>radarr示例图片<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819001114.png" alt="radarr"></p>
<h3 id="使用Emby观看电影">使用Emby观看电影</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819000847.png" alt="emby"></p>
<h2 id="音乐管理">音乐管理</h2>
<h3 id="使用lidarr管理音乐"><strong>使用lidarr管理音乐</strong></h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819001200.png" alt="lidarr示例图片"></p>
<h3 id="音乐刮削">音乐刮削</h3>
<blockquote>
<p>使用Mp3tag, MediaGo, MusicBrainZ等工具刮削</p>
<p>音乐刮削教程： <a href="https://blog.17lai.site/music/2021-10-11-how-to-scrape-music-idtag/">如何使用media Go,MusicBrainz,Mp3tag工具刮削音乐 整理音乐资料库</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011175602.png" alt=""></p>
<h3 id="使用Mstream听音乐">使用Mstream听音乐</h3>
<blockquote>
<p>教程： <a href="https://blog.17lai.site/music/2021-10-06-private-music-service/">私人在线音乐服务器搭建与使用介绍</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/0620211006015739.png" alt="私人音乐服务"></p>
<h2 id="Docker管理">Docker管理</h2>
<h3 id="使用docker-compose-管理docker配置文件，一键安装，升级">使用docker compose 管理docker配置文件，一键安装，升级</h3>
<h3 id="使用portainer管理docker"><strong>使用portainer管理docker</strong></h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819001116.png" alt="portainer"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">version: <span class="token string">'3'</span>
services:
  portainer-ce:
    container_name:  portainer-ce
    image: portainer/portainer-ce
    command: -H unix:///var/run/docker.sock
    restart: always
    ports:
      - <span class="token number">9300</span>:9000
      - <span class="token number">9301</span>:8000
    environment:
      - <span class="token assign-left variable">TZ</span><span class="token operator">=</span>Asia/Shanghai
      - <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>en_US.UTF-8
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /share/Container/portainer_data:/data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="使用watchtower自动升级docker"><strong>使用watchtower自动升级docker</strong></h3>
<p>使所有软件保持最新最佳状态</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819001124.png" alt="watchtower"></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">watchtower</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> watchtower
    <span class="token key atrule">image</span><span class="token punctuation">:</span> containrrr/watchtower<span class="token punctuation">:</span>latest
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/var/run/docker.sock
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> TZ=Asia/Shanghai
      <span class="token punctuation">-</span> WATCHTOWER_CLEANUP=true
      <span class="token punctuation">-</span> WATCHTOWER_SCHEDULE=0 0 1 * * *
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">command</span><span class="token punctuation">:</span> nginx redis<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述配置文件中<code>volumes</code>使用了绝对路径,使这个容器能访问系统<code>docker.sock</code>目录,用于方便监控容器镜像的版本以便更新.其他的一些环境变量,例如时区,清理旧镜像,定时任务都转换为<code>environment</code>,而特殊的<code>command</code>命令则定义了指定监控<code>nginx</code>和<code>redis</code>两个容器。没有command这一行，默认监控升级所有运行中的docker</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 运行一次，更新所有的容器，并清除旧的容器 </span>
<span class="token function">docker</span> run -d --name watchtower -v /var/run/docker.sock:/var/run/docker.sock containrrr/watchtower --cleanup --run-once<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#只更新nginx和redis</span>
<span class="token function">docker</span> run -d --name watchtower -v /var/run/docker.sock:/var/run/docker.sock containrrr/watchtower --cleanup --run-once nginx redis<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="使用muximux来管理多个docker入口"><strong>使用muximux来管理多个docker入口</strong></h3>
<p>主页面</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819001210.png" alt="muximux"></p>
<p>配置页面</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819001131.png" alt="muximux"></p>
<h2 id="更进阶定制本地域名访问"><strong>更进阶定制本地域名访问</strong></h2>
<h3 id="nginx-管理域名访问"><strong>nginx 管理域名访问</strong></h3>
<ul>
<li>Docker: <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/nginx-purge">bloodstar/nginx-purge</a></li>
<li>Github： <a target="_blank" rel="noopener" href="https://github.com/appotry/nginx-purge-docker">nginx</a></li>
<li>去掉烦人的端口后缀，实现80,443 端口复用。这个docker 是博主定制功能版。</li>
<li>配置SSL证书访问，密码等敏感数据从此加密传输。并可以使用http2高级特性。</li>
<li><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819010407.png" alt="nginx"></li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">version: <span class="token string">'3'</span>
services:
  nginxweb:
    image: bloodstar/nginx-purge
    container_name: <span class="token string">"nginxweb"</span>
    hostname: nginxweb
    ports:
      - <span class="token string">"80:80"</span>
      - <span class="token string">"443:443"</span>
    restart: always
    volumes:
      <span class="token comment"># 映射主机目录</span>
      - <span class="token variable">${USERDIR}</span>/nginx/conf.d:/etc/nginx/conf.d:ro
      - <span class="token variable">${USERDIR}</span>/nginxproxy/certs:/etc/nginx/certs:ro
      - <span class="token variable">${USERDIR}</span>/nginx/nginx.conf:/etc/nginx/nginx.conf:ro<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里推荐博主制作的nginx docker镜像： <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/nginx-purge">bloodstar/nginx-purge</a></p>
<blockquote>
<p>支持ARM64, ARMV7, AMD64 ，增加 CA 证书，防火墙，brotli, Proxy-cache-purge, htpasswd 支持</p>
</blockquote>
<h3 id="DNS-域名管理"><strong>DNS 域名管理</strong></h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819003924.png" alt="DNS"></p>
<ul>
<li>
<p>和nginx 配合使用。 简单的可以直接修改<code>/etc/hosts</code>。</p>
</li>
<li>
<p>DNSCrypt Proxy： 作为DNS前端访问DOH的DNS</p>
</li>
<li>
<p>DNSMasq： 作为DNS后端，连接到DNSCrypt Proxy，并配置本地域名。还可以添加DNS去广告功能，浏览器插件去广告非常消耗CPU和内存，但是在DNS前端去广告，资源消耗低，并一次性解决所有的访问终端（pc，手机，平板）广告问题。</p>
<blockquote>
<p>配置一个去广告，本地域名管理工具。</p>
</blockquote>
</li>
</ul>
<h2 id="Xteve-看IPTV"><strong>Xteve 看IPTV</strong></h2>
<p>Docker: <a target="_blank" rel="noopener" href="https://hub.docker.com/r/dnsforge/xteve">dnsforge/xteve</a></p>
<p>结合Emby， jellyfin直接看iptv。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/1920210819010804.png" alt="Xteve"></p>
<h2 id="注意事项">注意事项</h2>
<ul>
<li>
<p>tmm，jackett，sonarr最好配置代理。否则，刮削，图片墙可能工作不正常。</p>
</li>
<li>
<p>docker最好配置镜像加速，提高安装docker速度</p>
</li>
<li>
<p>一些docker初始化安装，运行、更新时需要访问github，最好配置代理。推荐博主定制Docker <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/v2fly-privoxy">bloodstar/v2fly-privoxy</a></p>
</li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>Emby</tag>
        <tag>Sonarr</tag>
        <tag>Jeckett</tag>
        <tag>Portainer</tag>
        <tag>Watchtower</tag>
        <tag>DNSMasq</tag>
        <tag>DNSCrypt</tag>
      </tags>
  </entry>
  <entry>
    <title>QNAP 修改应用启动顺序</title>
    <url>/posts/77da2f80/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><ul>
<li>关于本blog，<strong>图床</strong>一般使用<strong>github</strong>，已经配置了CDN，如果图片还是未显示请自行代理解决</li>
</ul>
<p>有时候，你想修改一下安装的应用启动顺序。该怎么做了？</p>
<p>在无意中，博主发现了这个技巧。配置方法如下：</p>
<h2 id="配置文件路径">配置文件路径</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0120210901233948.png" alt=""></p>
<h2 id="配置文件内容">配置文件内容</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0120210901234357.png" alt=""></p>
<p>RC_Number是qnap配置应用启动顺序，数字越小优先级越高。看着100差不多就是用户程序高优先级上限了。如此，你可以把一些应用调整高优先级启动，例如代理配置v2ray, dns配置DNSCrypt Proxy和DNSMasq，以实现其它应用采用这些服务。把一些应用调整低优先级，如qbittorrent等。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span> /etc/config -alh
lrwxrwxrwx <span class="token number">1</span> admin administrators <span class="token number">21</span> <span class="token number">2021</span>-08-31 <span class="token number">17</span>:20 /etc/config -<span class="token operator">&gt;</span> /mnt/HDA_ROOT/.config/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="qnap使用init-v系统。">qnap使用init v系统。</h2>
<p>如果改为systemd 系统启动，可以加快启动速度。一些应用延迟加载技术看起来也没做好。用户这里修改RC_Number 可以手动实现一些延迟加载功能。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/etc/init.d/QTransmission3.sh start         <span class="token comment">#启动</span>
/etc/init.d/QTransmission3.sh stop            <span class="token comment">#停止</span>
/etc/init.d/QTransmission3.sh restart        <span class="token comment">#重启</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="原创首发">原创首发</h2>
<p>可以转载，但必须完整转载，并且带上原始地址链接。</p>
<hr>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>qnap</category>
      </categories>
      <tags>
        <tag>QNAP</tag>
        <tag>nas</tag>
        <tag>启动</tag>
      </tags>
  </entry>
  <entry>
    <title>通过宝塔面板实现MySQL性能简单调优</title>
    <url>/posts/d5f56dd0/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>在PHP+MYSQL架构网站运行过程中，往往会遇到各种性能问题影响，如MySQL、PHP、CPU、磁盘IO、缓存等，其中MySQL瓶颈就是最常见也最难解决的一种影响网站性能的因素；通常，我们会使用redis、memcached等缓存软件来缓存内容，这确实是最优的解决方案之一，但这需要网站程序的支持，然而多数常用网站程序并不支持或者不能完美支持这些缓存软件，今天我们就来谈谈如何通过MySQL自身的配置调整来优化MySQL性能，以缓解MySQL瓶颈问题。</p>
</blockquote>
<h2 id="准备："><strong>准备：</strong></h2>
<blockquote>
<p>​    1、宝塔Linux面板 正式版 5.2.0+ (2017/09/20发布)  测试版5.2.4+</p>
<p>​    2、MySQL 5.x</p>
</blockquote>
<h3 id="通常MySQL调优我们分以下几部分："><strong>通常MySQL调优我们分以下几部分：</strong></h3>
<blockquote>
<p>​    1、MySQL配置参数调优 (需要根据网站运行情况调整)</p>
<p>​    2、数据表索引调优 (效果明显，但通常优秀的开源程序都不需要调整)</p>
<p>​    3、SQL语句调优 (这是程序员或DBA干的事)</p>
</blockquote>
<p>今天我们主要谈谈如果配合宝塔面板的新功能来进行MySQL配置参数调优，我们先来看两张图片：</p>
<p>(图1)</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/2720210827205902.png" alt=""></p>
<p>(图2)</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/2720210827205906.png" alt=""></p>
<p>很明显，(图1)显示的是MySQL当前的运行状态，(图2)显示的是MySQL主要配置参数</p>
<p>下面我们就来解读一下这两张图：</p>
<h3 id="1、活动-峰值连接数"><strong>1、活动/峰值连接数</strong></h3>
<p>​      (图1)中当前活动的连接为1个，自MySQL服务启动以来，最高连接数为54；当最高连接数接近或等于(图2)中的max_connections时，应适当增加max_connections，需要注意的是，不要一下子增加过多，建议每次增加50，观察一段时间，不够再继续增加。</p>
<h3 id="2、线程缓存命中率"><strong>2、线程缓存命中率</strong></h3>
<p>​      (图1)中线程缓存命中率为99.78%，若这个值小于90%，建议适当增加(图2)中的thread_cache_size，建议每次增加8。</p>
<h3 id="3、索引命中率"><strong>3、索引命中率</strong></h3>
<p>​      (图1)中索引命中率为99.50%，若这个值小于95%，建议适当增加(图2)中的key_buffer_size，建议每次增加64，需要说明的是，若您的数据库使用的是Innodb引擎，可忽略这个选项</p>
<p><strong>4、Innodb索引命中率</strong><br>
(图1)中Innodb索引命中率为100%，若这个值小于95%，建议适当增加(图2)中的innodb_buffer_pool_size，建议每次增加64，需要说明的是，若您的数据库没有使用Innodb引擎，可忽略这个选项</p>
<h3 id="5、查询缓存命中率"><strong>5、查询缓存命中率</strong></h3>
<p>​      MySQL查询缓存是个比较受争议的功能，个人建议当你有在使用redis、memcached等缓存软件时，在(图2)中将query_cache_size设为0可以将其关闭，当你没有使用缓存软件，有多余的内存使用，且数据库瓶颈明显存在时，可以尝试开启查询缓存，这是个非常依赖数据表结构及SQL语句优化的功能，若数据表结构和SQL语句都针对查询缓存进行过优化，它的效果还是很不错的。</p>
<h3 id="6、创建临时表到磁盘"><strong>6、创建临时表到磁盘</strong></h3>
<p>​      (图1)中创建临时表到磁盘的比例是0.42%，这说明大部分临时表创建到内存了，不会过多增加磁盘IO的开销，建议，当比例大于2%时适当增加(图1)中的tmp_cache_size，建议每次增加32，当比例大于60%时，放弃吧，有些开源程序并没有专门优化过SQL语句，所以在运行过程中会开启大量临时表，加多少缓存都是不够用的。</p>
<h3 id="7、已打开的表"><strong>7、已打开的表</strong></h3>
<p>​      当(图1)中的已打开的表接近或等于(图2)中的table_open_cache时，可以适当增加table_open_cache，但若设置过大可能导致您的程序频繁中断MySQL连接，建议在1024以内，最大不要超过2048。</p>
<h3 id="8、没有使用索引的量、没有使用索引的JOIN量"><strong>8、没有使用索引的量、没有使用索引的JOIN量</strong></h3>
<p>​      若不为0，就检查下数据表索引吧，其实只要没有疯涨，比如一天增涨几千，一般可以忽略，必竟优化索引还是程序员或DBA去干比较合适。</p>
<h3 id="9、排序后的合并次数"><strong>9、排序后的合并次数</strong></h3>
<p>​      如果这个值在缓慢增张，建议适当增加(图2)中的sort_buffer_size，建议每次增加512，但最大不要超过8192，如果这个值一直在疯涨，增加sort_buffer_size也没用，就放弃这个选项吧，这个锅还是给程序开发者背。</p>
<h3 id="10、锁表次数"><strong>10、锁表次数</strong></h3>
<p>​      如果服务器CPU开销不大的情况下，疯狂锁表，建议你将所有数据表转换成innodb，记得转换前备份哦。</p>
<h3 id="11、优化方案"><strong>11、优化方案</strong></h3>
<p>​      这个是我们根据内存大小给的一个推荐优化方案，仅是建议仅用于基础参考值，还是要根据实据情况来调整每一个配置项。</p>
<p>注意：保存参数配置后不会立即生效，记得要重启MySQL服务。</p>
<p>写在最后：<br>
因我本人并不是专业DBA，难免有错误或遗漏的地方，还请大家给予指正，另外，可能面板提供的参考数据及调整选项还不够丰富，我们在往后的更新中会根据需要考虑继续增加更多的调整选项，谢谢大家的支持。</p>
<p>来自网络整理。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>MySQL</tag>
        <tag>优化</tag>
      </tags>
  </entry>
  <entry>
    <title>ESNI和加密DNS - 保护信息隐私的最后一块拼图</title>
    <url>/posts/ec2cad2/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>随着<a target="_blank" rel="noopener" href="https://www.ietf.org/blog/tls13/">TLS1.3</a>的发布，让该协议成为有史以来最安全、也是最复杂的TLS协议。在该协议之中，有很多的对于以往协议安全漏洞的修复，包括废弃RSA启用新的秘钥交换机制PSK等等。而<code>Encrypted SNI</code>作为一个<code>TLS1.3</code>的扩展协议用来防止传统的HTTPS流量受到ISP或者陌生网络环境的窥探以及一些网络审查。在过去，由于<code>HTTPS</code>协议之中<code>Server Name Indication - SNI</code>的使用，我们的HTTPS流量经常被窥探我们所访问站点的域名</p>
<h3 id="那么什么是SNI？⌗">那么什么是SNI？<a href="#%E9%82%A3%E4%B9%88%E4%BB%80%E4%B9%88%E6%98%AFsni">⌗</a></h3>
<blockquote>
<p>服务器名称指示（英语：Server Name Indication，简称SNI）是一个扩展的TLS计算机联网协议，在该协议下，在握手过程开始时客户端告诉它正在连接的服务器要连接的主机名称。这允许服务器在相同的IP地址和TCP端口号上呈现多个证书，并且因此允许在相同的IP地址上提供多个安全（HTTPS）网站（或其他任何基于TLS的服务），而不需要所有这些站点使用相同的证书。它与HTTP/1.1基于名称的虚拟主机的概念相同，但是用于HTTPS。所需的主机名未加密， 因此窃听者可以查看请求的网站 为了使SNI协议起作用，绝大多数访问者必须使用实现它的Web浏览器。使用未实现SNI浏览器的用户将被提供默认证书，因此很可能会收到证书警告</p>
</blockquote>
<ul>
<li>SNI协议示意图</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/2820210828144946.webp" alt=""></p>
<ul>
<li>TLS1.3完整握手流程</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/2820210828144904.webp" alt=""></p>
<h3 id="为了弥补缺陷因应运而生的ESNI⌗">为了弥补缺陷因应运而生的ESNI<a href="#%E4%B8%BA%E4%BA%86%E5%BC%A5%E8%A1%A5%E7%BC%BA%E9%99%B7%E5%9B%A0%E5%BA%94%E8%BF%90%E8%80%8C%E7%94%9F%E7%9A%84esni">⌗</a></h3>
<p>在上述过程之中，存在的问题就是，在ClientHello环节中，TLS会在这个位置以<strong>明文</strong>的形式讲要请求的Host写在数据包之中，如果在网络路由中有任何的监听节点，那么用户所访问网站的域名将暴露无遗，这将是巨大的用户隐私泄露: <img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/2820210828144907.webp" alt=""></p>
<p>所以在最新的关于<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/draft-rescorla-tls-esni-00">ESNI的草案</a>中，<code>IETF</code>重新设计了一种加密的Client Hello机制，从而修复了这个问题: <img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/2820210828144915.webp" alt=""></p>
<p><strong>不过这里问题又来了，之前服务器和客户端并没有事先交换任何数据啊，这个加密的凭证从何而来啊？？？</strong></p>
<h3 id="依靠安全DNS的ESNI⌗">依靠安全DNS的ESNI<a href="#%E4%BE%9D%E9%9D%A0%E5%AE%89%E5%85%A8dns%E7%9A%84esni">⌗</a></h3>
<p>上一个问题没有难倒工程师们，他们设计了这样一个办法。首先让网站提供者在DNS提供商上公布一个记录，这个记录包含着一个<code>公钥</code>，这个公钥由网站提供者生成，其<code>私钥</code>存储在Web服务器等待着被Web程序读取。如此，当用户想通过TLS1.3协议访问这个域名的时候，首先读取这个公开的公钥，在用公钥加密其想访问的<code>域名Host</code>，装在<code>Client Hello</code>里面发送给目标服务器，目标服务器再用自己的私钥解密，从而和用户建立HTTPS链接，这样就不会暴露Host信息 这时候有人会想，如果有人某Wall想给你的DNS偷天换日，那会不会很不安全啊,请继续向下看</p>
<p>在<code>ESNI</code>的实现草案之中，里面要求<code>安全加密的DNS</code><strong>是推荐的</strong>。大家都知道我们的DNS查询一般是<code>TCP</code>报文或者是<code>UDP</code>报文，本身它是不加密的，所以如果有人想在篡改你的DNS是相对简单的，大家可能都知道我们伟大的妨炎蔷会使用DNS污染的方式干扰一些网站的正常访问。正式由于DNS的非加密性，DNS也成为了审查信息的利器。此时加密的DNS势在必行</p>
<h3 id="DNS-over-TLS-DoT-and-DNS-over-HTTPS-DoH-⌗">DNS over TLS (DoT) and DNS over HTTPS (DoH)<a href="#dns-over-tls-dot-and-dns-over-https-doh">⌗</a></h3>
<p>于是出现了这两种新型的DNS查询方式</p>
<ul>
<li>DNS over HTTPS (DoH)</li>
</ul>
<blockquote>
<p>DNS Over HTTPS (DOH) 是一个进行安全化的域名解析的方案，当前尚处于实验性阶段。其意义在于以加密的HTTPS协议进行DNS解析请求，避免原始DNS协议中用户的DNS解析请求被窃听或者修改的问题（例如中间人攻击）来达到保护用户隐私的目的。 Google及Mozilla基金会正在测试这一协议，作为其提高网络安全性的努力的一部分。 当前，该方案由IETF支持，其规范文档以 RFC 8484 的名义发布。2018年9月5日发布的Firefox 62正式版加入了这项功能，但需要用户手动开启 DNS Over HTTPS利用HTTP协议的GET命令发出经由JSON等编码的DNS解析请求。较于传统的DNS协议，此处的HTTP协议通信处于具有加密作用的SSL/TLS协议（两者统称作HTTPS）的保护之下。但是，由于其基于HTTPS，而HTTPS本身需要经由多次数据来回传递才能完成协议初始化，其域名解析耗时较原DNS协议会显著增加。 传统的DNS协议形成于互联网早期，直接基于UDP或TCP协议，且彼时未虑及现代安全性的需要，未利用密码学等手段进行加密或验证。因而，其无法抵御现代互联网常见的DNS投毒污染等攻击手段或监听。虽然后来的DNSSEC方案通过电子签名进行验证，强化了DNS的安全性，并能够抵御DNS投毒污染等篡改通信的手段，但其对于中间网络设备进行的监听仍然没有抵御能力（随后，监听者可以通过获取的通信数据知晓用户访问了哪一域名，而域名往往与具体的网站相关系）。此外，DNSSEC的起效要求现有的大量DNS解析服务的提供商（常为互联网服务提供商或第三方大型互联网机构）对已有的DNS服务器进行大范围修改等问题，其推进进程并不理想。而对于DNS Over HTTPS，在正确部署服务端并妥善配置客户端的前提下，互联网服务提供商或其它中间网络设备无法解密（亦即无法获知请求的实际内容）或者篡改已经加密的HTTPS通信，故其能够有效保护互联网用户的安全及隐私；另一方面，其基于已经成熟并已广泛部署的HTTPS协议，客户端进行利用较为方便。</p>
</blockquote>
<ul>
<li>DNS over TLS (DoT)</li>
</ul>
<blockquote>
<p>DNS over TLS (DoT) 是通过传输层安全协议（TLS）来加密并打包域名系统（DNS）的安全协议。此协议旨在防止中间人攻击与控制DNS数据以保护用户隐私。 RFC 7858及RFC 8310定义了DNS over TLS。 截至2018年，Cloudflare、Quad9与CleanBrowsing均向大众提供支持DNS over TLS的公共DNS解析服务。2018年4月，Google宣布Android P将包含对DNS over TLS的支持。PowerDNS的DNSDist也宣布在其最新的1.3.0版本中添加了对DNS over TLS的支持。BIND用户也可以通过stunnel代理提供DNS over TLS服务。</p>
</blockquote>
<h3 id="手动配置⌗">手动配置<a href="#%E6%89%8B%E5%8A%A8%E9%85%8D%E7%BD%AE">⌗</a></h3>
<p>Firefox所在的Mozilla宣布从<code>Firefox 62</code>版本之后开始支持<code>ESNI</code>，默认没有开启，需要用户手动配置打开，那么我们现在试验一下 这里Firefox的解决方案是使用<code>DNS over HTTPS (DoH)</code>和<code>ESNI</code></p>
<ol>
<li>
<p>安装<code>Firefox Nightly</code>版本，这个版本是预发布版本，使得开发这和即可门可以提前尝鲜到新功能。<a target="_blank" rel="noopener" href="https://www.mozilla.org/zh-CN/firefox/nightly/all/">下载地址</a></p>
</li>
<li>
<p>在浏览器地址栏输入<code>about:config</code>并回车，打开配置页面，在搜索位置搜索<code>network.trr.mode</code>，这个是打开浏览器对于<code>DoH</code>的支持，将此项的数值修改为3（<code>0</code>对应的是不开启此功能；<code>1</code>对应的是交由浏览器选择<code>DoH</code>与传统方式那种更快；<code>2</code>代表优先使用加密DNS查询，如果失败则回落到普通DNS查询；<code>3</code>代表只使用加密DNS查询；<code>5</code>代表明确的关闭此功能）</p>
</li>
<li>
<p>继续搜索<code>network.trr.uri</code>，将此项的值修改为<code>https://mozilla.cloudflare-dns.com/dns-query</code>，这个是默认的<code>DoH</code>查询地址，当然我们也可以使用诸如<code>https://1.1.1.1/dns-query</code>、<code>https://dns.google.com/experimental</code>这样的地址，我们可以事先<code>ping</code>检测一下对比哪个延迟更低来使用</p>
</li>
<li>
<p>（可选）搜索<code>network.trr.bootstrapAddress</code>，讲此值修改位第三步的DNS域名的<code>IP</code>。此举是为了避免使用操作系统DNS查询域名受到劫持，一般来说这些DNS的<code>IP</code>是不会变的</p>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/2820210828145006.webp" alt=""></p>
<ol start="5">
<li>
<p>将<code>network.security.esni.enabled</code>设置为<code>true</code>,此举为了打开浏览器对于ESNI的支持（感谢<a target="_blank" rel="noopener" href="https://github.com/chenIshi">chenlshi</a>同学的提醒，在原版的文章中我不小心遗漏了这个关键的步骤）</p>
</li>
<li>
<p>完成配置后重启浏览器，再打开<a target="_blank" rel="noopener" href="https://encryptedsni.com/">在线验证页面验证</a>来查询你的浏览器是否完全支持<code>ESNI</code>功能，如果出现如图说明配置成功了</p>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/2820210828144924.webp" alt=""></p>
<h3 id="验证⌗">验证<a href="#%E9%AA%8C%E8%AF%81">⌗</a></h3>
<p>为了验证是否真的加密了<code>Client Hello</code>，我们使用<code>Wireshark</code>进行网络抓包 由于这个特性仍在试验阶段，并没有太多站点支持这个特性，<a target="_blank" rel="noopener" href="https://cloudflare.com/">CloudFlare</a>是第一个全站支持<code>ESNI</code>的网站，这里我们使用<a target="_blank" rel="noopener" href="https://blog.cloudflare.com/">blog.cloudflare.com</a>来做测试：</p>
<ol>
<li>首先打开<code>Wireshark</code>的抓包功能，然后开启<code>Chrome</code>浏览器打开上述网址，页面加载完后停止抓包，在得到的结果中查询协议为<code>TLS1.3</code>和报文为<code>Client Hello</code>的报文，通过观察发现域名的Host果然被以明文形式写在数据包中（参见<code>Server_Name</code>字段）：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/2820210828144932.webp" alt=""></p>
<ol start="2">
<li>然后打开<code>Firefox Nightly</code>浏览器重复上述操作，这次发现在整个数据包中根本找不到<code>Server_Name</code>字段，说明<code>Host</code>已经被加密：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/08/2820210828144933.webp" alt=""></p>
<p>目前来说，我查阅了相关的关键词，仍然没有任何一篇教程有介绍如何在自己的服务器上支持<code>ESNI</code>，同时我也看到在<code>Nginx</code>的论坛里面有人呼吁尽快支持<code>ESNI</code>，所以我推测这个功能仍然在试验期，还没有被这两个Web软件所支持，起劲为止我也没有查阅到任何的Web软件预计支持此项功能。这项扩展已经进入<code>IETF</code>的草案阶段，可以预见到，在不就的将来，这项技术可以普及开来，为我们的网络隐私保驾护航 目前来说，有了<code>HTTPS</code>+<code>TLS1.3</code>+<code>ESNI</code>+<code>DoH/DoT</code>的加持，我们的网络隐私的到了极大的保障，最后还有一个问题是访问服务器<code>IP</code>的泄露仍然无法被避免，迫于<code>IP协议</code>设计的机制，他目前还不能被解决。不过我相信，随着网技术不断的趋于保护个人隐私和更快速的发展方向，这个问题可以最终被解决</p>
<p>From: <a target="_blank" rel="noopener" href="https://blog.hackerchai.com/post/encrypted-sni-anti-censorship/">hackerchai</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>web</category>
      </categories>
      <tags>
        <tag>SSL</tag>
        <tag>TLS</tag>
        <tag>隐私</tag>
        <tag>安全</tag>
      </tags>
  </entry>
  <entry>
    <title>【Gitlab】GitBook+GitLab撰写发布技术文档-Part2:GitLab篇</title>
    <url>/posts/7790e989/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>上一篇文章介绍了如果用 gitbook 写书，并且我们已经通过 <code>gitbook build</code>命令把书的内容打包成 HTML 格式发布到了<code>_book</code>文件夹中。<br>
接下来这篇文章将向大家介绍如何把写好的书发布到 gitlab 上。这里 gitlab 是我们自己搭建在公司内网中的，不过要用到的原理其实都是一样的，就是利用其 CI/CD 功能。<br>
关于 CI/CD 网上有很多详细的介绍，这里我就不不再重复啰嗦，如果有想学习的可以参看文末的致谢&amp;引用部分。</p>
<h1>原理</h1>
<p>简单来说CI 就类似一个触发器，你可以设定响应触发的条件，比如 master 分支有新的 commit合并进来，或者带有特殊 tag 的合并，亦或者其他指定分支的特殊提交，可以触发指定的指令。<br>
一般来说标准的流程是3步，打包(build)、测试(test)和发布(deploy)。也就是我们只需要把源码提交上以后，CI 可以帮我们完成自动化部署工作。<br>
考虑到我们在用 gitbook 写书的过程中需要预览时，其实已经在做build 和 test 的工作了，所以我们只需要在代码传到 gitlab 上后，让服务器帮我们执行发布的工作。<br>
所以前提是我们搭建好了一个web 服务，然后 CI 帮我们把打包好的内容部署到相应的网站目录中就好了。</p>
<h1>实现</h1>
<p>我们就按照原理，来一步一步尝试着完成工作吧。</p>
<h2 id="CI配置">CI配置</h2>
<p>还记得我们上一篇文章中最后介绍目录结构时，有提到一个文件： <code>gitlab-ci.yml</code>。 这个文件是用YAML 进行配置，我们来看一下我们要用到的配置文件吧</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token comment"># make backup</span>
    <span class="token punctuation">-</span> sudo rm <span class="token punctuation">-</span>rf /usr/share/nginx/html/TechDocs/example_bak
    <span class="token punctuation">-</span> sudo mv /usr/share/nginx/html/TechDocs/example /usr/share/nginx/html/TechDocs/example_bak
    <span class="token punctuation">-</span> sudo mkdir /usr/share/nginx/html/TechDocs/example
    <span class="token comment"># deploy latest files</span>
    <span class="token punctuation">-</span> cd _book
    <span class="token punctuation">-</span> sudo cp <span class="token punctuation">-</span>rf . /usr/share/nginx/html/TechDocs/example/
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> master <span class="token comment"># this job will affect only the 'master' branch</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这段 yaml 配置就只有deploy 的步骤，我们在 <code>script</code>部分进行了一系列的操作，完成旧文件的备份以及新文件的部署。当我们的代码上传到远端后，就会自动执行 script 里的内容了。让我们尝试下吧。</p>
<h2 id="查看-CI-任务执行状态">查看 CI 任务执行状态</h2>
<p>上传代码到 gitlab 的步骤这里就不介绍了。理论上说，当代码上传到 master 分支后，会自动执行我们设定好的部署任务。我们可以通过访问gitlab对应项目的页面， 在左侧菜单栏点击<code>CI/CD</code>来查看任务的执行情况。<br>
但是如果你和我一样是第一次处理 CI 任务，我们会得到下面的提示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907192617.png" alt=""></p>
<p>原因页面上也给出了我们提示<code>This job is waiting to be picked by a runner</code>。</p>
<h2 id="Runner">Runner</h2>
<p>这里就需要引入第2个概念： runner。很容易从字面上理解，runner 就是我们任务的执行者，也很形象，我们提交了一个任务以后，总得有人来执行。这些任务有些是需要shell 脚本执行，有些可能需要登录到远程机器，有些可能需要 docker 的执行权限，所以这些执行者也都有个子的分工，可能有些执行者只负责执行特定项目的任务，有些执行者执行特殊 tag 的。所以接下来我们看看如何才能创建 runner 吧。</p>
<h3 id="shared-runner">shared runner</h3>
<p>前文提到了我们可能需要一些高权限的 runner 来跨项目间来执行任务。因为我们要做的是多个项目的技术文档，所以会有多个 gitbook 的项目，那这些项目的 CI 任务自然是公用1个 runner 就好，这种 runner 就叫做 shared runner。<br>
shared runner 的创建需要我们用管理员的帐号登录gitlab 页面，在 admin area 区域，点击 runner 来根据提示创建。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907192622.png" alt=""></p>
<p>这个页面会显示当前所有的 runner，包括项目独享的 runner 和共享的 shared runner。 我们看到目前还没有一个可用的 runner，所以之前的任务才会停留在等待 runner 来运行的状态。<br>
我们就根据页面的提示来创建 runner 吧。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907192629.png" alt=""></p>
<h3 id="安装-gitlab-runner-工具">安装 gitlab-runner 工具</h3>
<p>第一步是安装工具，可以通过页面上的提示来进行不同主机环境的安装。我们这里用到的是 RHEL/CentOS，其他版本可以参见页面链接。<br>
我们登录到自建 gitlab 所在的主机，然后执行以下脚本</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">wget</span> -O /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64
$ <span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/gitlab-runner
$ <span class="token function">sudo</span> <span class="token function">useradd</span> --comment <span class="token string">'GitLab Runner'</span> --create-home gitlab-runner --shell /bin/bash
$ <span class="token function">sudo</span> gitlab-runner <span class="token function">install</span> --user<span class="token operator">=</span>gitlab-runner --working-directory<span class="token operator">=</span>/home/gitlab-runner
$ <span class="token function">sudo</span> gitlab-runner start<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="新建-shared-runner">新建 shared runner</h3>
<p>工具安装好了之后，我们就可以来创建用户了。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ gitlab-runner register<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>之后按照提示，一步一步创建就好了：</p>
<ol>
<li>输入URL</li>
<li>输入token。 URL 和 token 按照页面上给出的提示来创建就好了。token 用来标识创建的 runner 是某个项目特有的，还是 shared runner</li>
<li>输入 runner 的描述，这个可以随便填写，只要自己能看明白，能区分就好了</li>
<li>输入特定的 tag。 <strong>注意</strong>，这里最好留空，否则该 runner 仅会执行特定 tag 的提交</li>
<li>选择执行类型。这里提供了很多常见的执行类型，例如 docker, docker-ssh, shell 等，我们这里输入 shell。</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907192642.png" alt=""></p>
<p>之后我们就创建好了一个可以执行 shell 命令的 shared runner。再次回到之前的 web 页面上查看我们创建的 runner 信息。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907192643.png" alt=""></p>
<p>可以看到页面提示我们已经创建了一个 runner 可以执行<code>all unassigned projects</code>的任务</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907192655.png" alt=""></p>
<p>我们还可以进入到特定的项目，在设置里面查看 runner 的情况，可以看到已经有一个可用的 shared runner。如果想创建该项目特有的 runner，按照页面上的提示，输入特定的 token 就好了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907192654.png" alt=""></p>
<h3 id="其他细节">其他细节</h3>
<p>我们重新查看CI任务页面，大多数情况下，你的任务状态会是<code>failed</code>或者<code>pendding</code>。 如果是 failed，我们可以点击查看具体失败的原因，例如我遇到的问题就是 gitlab-runner 用户没有 sudo 权限。<br>
如果是 pendding，通常情况下是你的 job 没有合适的 runner 来执行，例如指定了分支或者添加了 tag 导致没有 runner 可用。</p>
<hr>
<p>如果一切都设置妥当，我们可以看到 CI 页面任务的最终状态是 passed，也就是成功执行了。这样，gitbook 的内容就成功部署到你的 web 页面上了。</p>
<h1>致谢&amp;引用</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/41330476">基于 GitLab 的 CI 实践(https://zhuanlan.zhihu.com/p/41330476)</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@mvpdw06/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-gitlab-ci-ebf0b68ce24b">如何使用 GitLab CI(https://medium.com/@mvpdw06/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-gitlab-ci-ebf0b68ce24b)</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/runners/">Configuring GitLab Runners(https://docs.gitlab.com/ee/ci/runners/)</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/register/">Registering Runners(https://docs.gitlab.com/runner/register/)</a></li>
<li><a target="_blank" rel="noopener" href="https://xiaosuiba.github.io/Gitbook-CI-With-Gitlab/">Gitbook CI With Gitlab(https://xiaosuiba.github.io/Gitbook-CI-With-Gitlab/)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kenming.idv.tw/simple-create-gitbook_at_gitlab_steps/">在 Gitlab 平台簡單創建 GitBook 電子書的步驟(https://www.kenming.idv.tw/simple-create-gitbook_at_gitlab_steps/)</a></li>
<li><a target="_blank" rel="noopener" href="https://getpublii.com/docs/host-static-website-gitlab-pages.html">How to create a static website using GitLab Pages(https://getpublii.com/docs/host-static-website-gitlab-pages.html)</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/install/linux-manually.html">Install GitLab Runner manually on GNU/Linux(https://docs.gitlab.com/runner/install/linux-manually.html)</a></li>
</ul>
<p>From: <a target="_blank" rel="noopener" href="http://lipeng1667.github.io/2019/01/15/public-doc-with-gitlab-ci-writing-with-gitbook/">lipeng1667</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>gitbook</category>
      </categories>
      <tags>
        <tag>Git</tag>
        <tag>linux</tag>
        <tag>GitBook</tag>
      </tags>
  </entry>
  <entry>
    <title>【Gitbook】GitBook+GitLab撰写发布技术文档-Part1:GitBook篇</title>
    <url>/posts/7fe86002/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>随着工作时间越来越久，项目越做越多，很多时候，手里面的技术文档都是零散的技术点。最近一直在着手把项目的技术开发文档(Technical Document)系统地整理一下。正好看到了非常棒的 GitBook 工具，又顺带研究了如何借助 Gitlab 的 CI/CD 功能实现自动部署。<br>
正好开个简短的教程，介绍一下 <code>GitBook</code> + <code>GitLab</code>怎样来撰写并发布文档。<br>
第一部分先来介绍一下 GitBook。</p>
<h1>系统环境</h1>
<p>惯例列出来我们的环境以及用到的工具。</p>
<ul>
<li>MacOS 10.12</li>
<li>Node.js (版本 &gt; 4.0.0)</li>
<li>Atom/MWebLite</li>
</ul>
<p>其实 Gitbook 有官方的编辑器，但是似乎对中文的支持不是很好，而且会有 bug，虽然最新版本做了优化，Mardown 格式的文字有些会自动显示成最终样式，而我个人还是比较喜欢原生的 markdown，所以我个人就没有用官方的编辑器。<br>
如果读者注册了 gitbook，并且打算文章都发布到 gitbook 官网上的话，还是建议可以使用官方的编辑器。因为我的目标是发布到公司内网的 gitlab 上，所以这里就用 atom 或者 MWebLite 来编写文档。<br>
其实这篇文章过后，大家对 Gitbook 的工作机制就很清楚了，完全可以自由地创作了。</p>
<h1>基本使用</h1>
<h2 id="安装-2">安装</h2>
<p>安装过程非常简单</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> gitbook-cli -g<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="新建book">新建book</h2>
<p>安装成功后，我们就可以开始用gitbook 的命令来进行各种操作了。如果熟悉<code>hexo</code>的同学会发现，其实大同小异，只不过一个用来写blog，一个用来写 book。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">mkdir</span> myBook
$ <span class="token builtin class-name">cd</span> myBook
$ gitbook init<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>初始化后，我们能在<code>myBook</code>目录下看到两个 markdown 文f件。这两个文件就是我们写一本书唯二必须要用的文件了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907191936.png" alt=""></p>
<h2 id="预览book">预览book</h2>
<p>先不做任何变动，模拟一下我们发布之后的页面的成品吧。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ gitbook serve<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907191946.png" alt=""></p>
<p>我们打开浏览器，在浏览器中输入<code>0.0.0.0:4000</code>就可以在本地预览了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907191948.png" alt=""></p>
<p>可以看到，左侧是我们的菜单栏，自带一个搜索栏，右侧就是我们的 book 的内容了，右上角有默认的诸如 twitter,facebook 等分享快捷方式。基本上和其他人用 gitbook 写出来的页面是一样的。</p>
<blockquote>
<p>注：</p>
<ol>
<li>gitbook 新版本提供了本地预览功能的热更新，也就是说本地预览的页面会随着我们写书的内容变化而自动更新，这着实是一个很使用的功能。</li>
<li>在命令行ctrl+c可以关闭本地服务器，即预览页面。</li>
</ol>
</blockquote>
<p>我们可以尝试修改一下书的内容，看一下页面的变化。打开<code>README.md</code>文件，修改成如下内容：</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> Introduction</span>
 
Hello World!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>再回头看一眼我们的预览页面，是不是自动变成了下面的样子。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907192001.png" alt=""></p>
<p>关于 gitbook 自建的 README.md 文件我就不做过多的介绍了，都是一些 Markdown 的基本语法，相信使用 gitbook 的各位一定是对 markdown 语法非常熟悉的了。</p>
<h2 id="目录">目录</h2>
<p>现在我们把注意力放到 gitbook 为我们创建的第二个文件<code>SUMMARY.md</code>上，这个文件决定了我们的目录结构。 一个比较简单的目录结构如下：</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> Summary</span>
 
<span class="token list punctuation">*</span> <span class="token url">[<span class="token content">前言</span>](<span class="token url">README.md</span>)</span>
<span class="token list punctuation">*</span> <span class="token url">[<span class="token content">第一章</span>](<span class="token url">xx.md</span>)</span>
<span class="token list punctuation">*</span> <span class="token url">[<span class="token content">第二章</span>](<span class="token url">xx.md</span>)</span>
<span class="token list punctuation">*</span> <span class="token url">[<span class="token content">第三章</span>](<span class="token url">xx.md</span>)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>xx.md</code>就是我们每个章节独立的 markdown 文件，所以用 gitbook 写一本书真的非常方便，一个目录文件，和若干个你的书的内容就好了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907192009.png" alt=""></p>
<h3 id="目录分层">目录分层</h3>
<p>简单的目录有一个小的问题就是我们目录都只有一级，如果想要分层，比如第一章有1，2，3个小节，该怎么办呢？ 这里有两种方式：</p>
<h4 id="标题区分">标题区分</h4>
<p>我们把<code>SUMMARY.md</code>文件修改成如下内容</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> Summary</span>
 
<span class="token title important"><span class="token punctuation">##</span> 前言</span>
<span class="token list punctuation">*</span> <span class="token url">[<span class="token content">前言</span>](<span class="token url">README.md</span>)</span>
 
<span class="token title important"><span class="token punctuation">##</span> 第一章</span>
<span class="token list punctuation">*</span> [1.1小节]()
<span class="token list punctuation">*</span> [1.2小节]()
 
<span class="token title important"><span class="token punctuation">##</span> 第二章</span>
<span class="token list punctuation">*</span> [2.1小节]()
<span class="token list punctuation">*</span> [2.2小节]()
 
<span class="token title important"><span class="token punctuation">##</span> 第三章</span>
<span class="token list punctuation">*</span> [3.1小节]()
<span class="token list punctuation">*</span> [3.2小节]()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最终的样式如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907192025.png" alt=""></p>
<h4 id="缩进区分">缩进区分</h4>
<p>我们还可以用缩进的方式对目录进行级别的区分</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> Summary</span>
 
<span class="token list punctuation">*</span> <span class="token url">[<span class="token content">前言</span>](<span class="token url">README.md</span>)</span>
<span class="token list punctuation">*</span> [第一章]()
    <span class="token list punctuation">*</span> [1.1小节]()
    <span class="token list punctuation">*</span> [1.2小节]()
<span class="token list punctuation">*</span> [第二章]()
    <span class="token list punctuation">*</span> [2.1小节]()
    <span class="token list punctuation">*</span> [2.2小节]()
<span class="token list punctuation">*</span> [第三章]()
    <span class="token list punctuation">*</span> [3.1小节]()
    <span class="token list punctuation">*</span> [3.2小节]()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最终的样式如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0720210907192039.png" alt=""></p>
<p>大家可以根据自己的喜好选择不同的样式，也可以把这两者结合起来一起用，as you wish.</p>
<h2 id="打包发布">打包发布</h2>
<p>通过预览模式，我们可以随时掌握书籍的更新内容。当你完成了部分章节或者全书的编写后，我们需要把写好的内容打包并发布。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ gitbook build<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>执行完上面的命令后，我们会发现在根目录下出现了<code>_build</code>文件夹，里面的文件就是我们需要发布的内容，你可以把所有的内容放到你的网站目录下，或者 gitlab/github 的 page页面，就实现了 gitbook 的线上发布了~</p>
<h1>进阶技巧</h1>
<p>看完上面的章节，你已经可以独立完成一本书的编写和发布，接下来的章节，我们提供一些进阶的技巧，你可以安装一些插件、更直观地规划你的目录结构等等。</p>
<h2 id="插件">插件</h2>
<p>和众多开源的软件一样，gitbook 也有一些插件，这些插件可以让你的书更加完美。这里我仅附上我个人觉得比较有用的几个插件，更多的插件，可以访问<a target="_blank" rel="noopener" href="https://plugins.gitbook.com/">社区</a>来获取。<br>
插件的引入和修改都是在配置文件中完成的，那我们可以在根目录下创建<code>book.json</code>文件来修改当前书的一些配置，因为是 json 格式的，所以诸如书的标题、作者、内容等都可以在配置文件中完成，我们重点来说插件。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
     <span class="token property">"plugins"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">"-lunr"</span><span class="token punctuation">,</span>
          <span class="token string">"-search"</span><span class="token punctuation">,</span>
          <span class="token string">"search-plus"</span><span class="token punctuation">,</span>
          <span class="token string">"splitter"</span><span class="token punctuation">,</span>
          <span class="token string">"copy-code-button"</span><span class="token punctuation">,</span>
          <span class="token string">"expandable-chapters-small"</span>
     <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以上是我的<code>book.json</code>配置文件，只有一个关于插件的配置项，其实总共就4个</p>
<ul>
<li>search-plus 让搜索支持中文，注意需要先把默认的两个插件<code>lunr</code>和<code>serach</code>禁用掉，禁用的方式就是在前面加上<code>-</code>号</li>
<li>spliter 菜单栏宽度可调节</li>
<li>copy-code-button 代码可以一键 copy</li>
<li>expandable-chapters-small 菜单栏可以折叠</li>
</ul>
<blockquote>
<p>注：<br>
如果引入了新的插件，需要通过<code>gitbook install</code> 命令来安装新的插件，否则在打包发布的时候会提示错误。</p>
</blockquote>
<h2 id="目录结构">目录结构</h2>
<p>一个基本的目录结构是这样的</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">.
├── _book/
├── book.json
├── README.md
├── SUMMARY.md
├── xx1.md
├── xx2.md
├── xx3.md
├── xx4.md
├── ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不过为了我们自己方便，个人建议的目录结构如下</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">.
├── _book/
├── node_modules/
├── .gitlab-ci.yml
├── book.json
├── SUMMARY.md
├── content/
|   ├── chapter1/
|       ├── README.md
|       └── something.md
|   ├── chapter2/
|       ├── README.md
|       └── something.md
├── res/
|   ├── 1.png
|   └── 2.jpg
|   └── 3.jpeg
|   └── ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：</p>
<ul>
<li><code>_book</code> 目录是我们打包后要发布的文件目录</li>
<li><code>node_modules</code> 目录是我们安装插件后默认生成的目录</li>
<li><code>.gitlab-ci.yml</code>这个是 gitlab 要用的 ci 配置文件，下一章节我们马上就会用到</li>
<li><code>book.json</code> 是我们的配置文件</li>
<li><code>content</code>目录是我们的书的内容，所有章节都可以分类继续整理，方便自己查看</li>
<li><code>res</code>目录是我们要用到的一些图片资源文件夹，除了用到床图，我们可以把其他本地图片资源也包含进来</li>
</ul>
<h1>参考&amp;致谢</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://gitbook.zhangjikai.com/">Gitbook 简要介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://yangjh.oschina.io/gitbook/">GitBook 学习笔记</a></li>
</ul>
<p>From: <a target="_blank" rel="noopener" href="http://lipeng1667.github.io/2019/01/15/how-to-write-techdoc-with-gitbook/">lipeng1667</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>gitbook</category>
      </categories>
      <tags>
        <tag>Git</tag>
        <tag>linux</tag>
        <tag>GitBook</tag>
      </tags>
  </entry>
  <entry>
    <title>Mariadb/Mysql命令行常用命令</title>
    <url>/posts/f0b0af52/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="一、初始化等">一、初始化等</h2>
<h3 id="1、登陆数据库方法"><strong>1、登陆数据库方法</strong></h3>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql <span class="token operator">-</span>u用户名 <span class="token operator">-</span>p用户密码<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="2、修改root及用户密码">2、修改root及用户密码</h3>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">use</span> mysql<span class="token punctuation">;</span>
<span class="token keyword">update</span> <span class="token keyword">user</span> <span class="token keyword">set</span> password<span class="token operator">=</span>password<span class="token punctuation">(</span><span class="token string">'11111111'</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token keyword">user</span><span class="token operator">=</span><span class="token string">'root'</span> <span class="token operator">and</span> host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">;</span>
flush <span class="token keyword">privileges</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">MariaDB <span class="token punctuation">[</span>mysql<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">update</span> <span class="token keyword">user</span> <span class="token keyword">set</span> password<span class="token operator">=</span>password<span class="token punctuation">(</span><span class="token string">'11111111'</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token keyword">user</span><span class="token operator">=</span><span class="token string">'root'</span> <span class="token operator">and</span> host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>
 
MariaDB <span class="token punctuation">[</span>mysql<span class="token punctuation">]</span><span class="token operator">&gt;</span> flush <span class="token keyword">privileges</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
 
MariaDB <span class="token punctuation">[</span>mysql<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">exit</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3、创建用户"><strong>3、创建用户</strong></h3>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span><span class="token keyword">user</span><span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span><span class="token string">"test"</span><span class="token punctuation">,</span>password<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
flush <span class="token keyword">privileges</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="4、删除用户">4、删除用户</h3>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> <span class="token keyword">User</span><span class="token operator">=</span><span class="token string">"test"</span> <span class="token operator">and</span> Host<span class="token operator">=</span><span class="token string">"localhost"</span><span class="token punctuation">;</span>
flush <span class="token keyword">privileges</span><span class="token punctuation">;</span>　　<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="5、删除用户的数据库">5、删除用户的数据库</h3>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">database</span> test1<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="6、交互模式初始化">6、交互模式初始化</h3>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql_secure_installation<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="二、-常用操作">二、 常用操作</h2>
<h3 id="1、显示数据库列表"><strong>1、显示数据库列表</strong></h3>
<p><code>show databases;</code>:查看所有的数据库</p>
<h3 id="2、创建数据库">2、创建数据库</h3>
<p><code>create database zxg;</code>：创建名尾zxg的数据库</p>
<h3 id="3、进入数据库">3、进入数据库</h3>
<p><code>use zxg;</code>:进入zxg的数据库</p>
<h3 id="4、显示库中的数据表">4、显示库中的数据表</h3>
<p><code>show tables;</code>：查看数据库里有多少张表</p>
<h3 id="5、创建数据表">5、创建数据表</h3>
<p><code>create table t1 (id varchar(20),name varchar(20));</code>:创建名为t1表，并创建两两个字段，id、name，varchar表示设置数据长度，用字符来定义长度单位，其</p>
<h3 id="6、插入数据">6、插入数据</h3>
<p><code>insert into t1 values（"1"，"zxg"）;</code>:向表中插入数据</p>
<h3 id="7、查看数据表">7、查看数据表</h3>
<p><code>select * from t1;</code> ：查看t1表数据内容</p>
<h3 id="8、多条件查询">8、多条件查询</h3>
<p><code>select * from t1 where id=1 and age = 'zxg ' ;</code>: id、age 多个条件查询</p>
<h3 id="9、查看字段内容">9、查看字段内容</h3>
<p><code>desc t1;</code>:查看t1 表字段内容</p>
<h3 id="10、修改字段长度">10、修改字段长度</h3>
<p><code>alter table t1 modify column name varchar(20);</code>:修改name字段的长度</p>
<h3 id="11、修改该字段内容">11、修改该字段内容</h3>
<p><code>update t1 set name='zxg.net' where id=1;</code>：修改name字段的内容</p>
<h3 id="12、权限刷新"><strong>12、权限刷新</strong></h3>
<p><code>flush privileges;</code> :刷新权限</p>
<h3 id="13、清空表单">13、清空表单</h3>
<p>delete from t1;` :清空表内容</p>
<h3 id="14、删除数据表">14、删除数据表</h3>
<p>`drop table t1:删除表</p>
<h3 id="15、删除数据库">15、删除数据库</h3>
<p><code>drop database zxg;</code>：删除zxg数据库</p>
<h3 id="16、查看数据库字符集">16、查看数据库字符集</h3>
<p><code>show variables like '%char%';</code>:查看数据库字符集</p>
<h3 id="17、查看存储引擎">17、查看存储引擎</h3>
<p><code>show engines;</code>:查看MySQL存储引擎。</p>
<h3 id="18、查看默认存储引擎">18、查看默认存储引擎</h3>
<p><code>show variables like '%storage_engine%';</code>:查看MySQL默认的存储引擎</p>
<h3 id="19、修改存储引擎">19、修改存储引擎</h3>
<p><code>alter table t1 engine=innodb;</code>:修改MySQL t1表存储引擎</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">[</span>root<span class="token variable">@web2</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysql</span>
Welcome <span class="token keyword">to</span> the MariaDB monitor<span class="token punctuation">.</span>  Commands <span class="token keyword">end</span> <span class="token keyword">with</span> <span class="token punctuation">;</span> <span class="token operator">or</span> \g<span class="token punctuation">.</span>
Your MariaDB connection id <span class="token operator">is</span> <span class="token number">2</span>
Server version: <span class="token number">5.5</span><span class="token number">.60</span><span class="token operator">-</span>MariaDB MariaDB Server
 
Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">2018</span><span class="token punctuation">,</span> Oracle<span class="token punctuation">,</span> MariaDB Corporation Ab <span class="token operator">and</span> others<span class="token punctuation">.</span>
 
<span class="token keyword">Type</span> <span class="token string">'help;'</span> <span class="token operator">or</span> <span class="token string">'\h'</span> <span class="token keyword">for</span> help<span class="token punctuation">.</span> <span class="token keyword">Type</span> <span class="token string">'\c'</span> <span class="token keyword">to</span> clear the <span class="token keyword">current</span> input statement<span class="token punctuation">.</span>
 
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> test               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
 
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>  <span class="token keyword">create</span> <span class="token keyword">database</span> zxg<span class="token punctuation">;</span>                 
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
 
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">use</span> zxg<span class="token punctuation">;</span>
<span class="token keyword">Database</span> changed
MariaDB <span class="token punctuation">[</span>zxg<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>
Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
 
MariaDB <span class="token punctuation">[</span>zxg<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">table</span> t1<span class="token punctuation">(</span>id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
 
MariaDB <span class="token punctuation">[</span>zxg<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+</span>
<span class="token operator">|</span> Tables_in_zxg <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+</span>
<span class="token operator">|</span> t1            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
 
MariaDB <span class="token punctuation">[</span>zxg<span class="token punctuation">]</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">MariaDB <span class="token punctuation">[</span>zxg<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">insert</span> <span class="token keyword">into</span> t1 <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"zxg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
 
MariaDB <span class="token punctuation">[</span>zxg<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span><span class="token keyword">from</span> t1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> zxg <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
 
MariaDB <span class="token punctuation">[</span>zxg<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span><span class="token keyword">from</span> t1 <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> zxg <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
 
MariaDB <span class="token punctuation">[</span>zxg<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span><span class="token keyword">from</span> t1 <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> name<span class="token operator">=</span><span class="token string">'zxg'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> zxg <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
 
MariaDB <span class="token punctuation">[</span>zxg<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">desc</span> t1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------+-------------+------+-----+---------+-------+</span>
<span class="token operator">|</span> Field <span class="token operator">|</span> <span class="token keyword">Type</span> <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> <span class="token keyword">Key</span> <span class="token operator">|</span> <span class="token keyword">Default</span> <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+-------------+------+-----+---------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES <span class="token operator">|</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token operator">|</span>
<span class="token operator">|</span> name <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES <span class="token operator">|</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+-------------+------+-----+---------+-------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
 
MariaDB <span class="token punctuation">[</span>zxg<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> t1 <span class="token keyword">modify</span> <span class="token keyword">column</span> name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
Records: <span class="token number">0</span> Duplicates: <span class="token number">0</span> <span class="token keyword">Warnings</span>: <span class="token number">0</span>
 
MariaDB <span class="token punctuation">[</span>zxg<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">update</span> t1 <span class="token keyword">set</span> name<span class="token operator">=</span><span class="token string">'zxg.net'</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span> Changed: <span class="token number">1</span> <span class="token keyword">Warnings</span>: <span class="token number">0</span>
MariaDB <span class="token punctuation">[</span>zxg<span class="token punctuation">]</span><span class="token operator">&gt;</span>
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="三、mysql-数据库字符集设置">三、mysql 数据库字符集设置</h2>
<p>mysql数据库存储数据时，默认编码为latinl，存储中文字符时，在调用时会显示为乱码，为了解决该乱码问题，需修改该mysql默认字符集为UTE-8</p>
<p>装mariadb的是时候看已经默认为ute-8</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%char%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------------------+----------------------------+</span>
<span class="token operator">|</span> Variable_name            <span class="token operator">|</span> <span class="token keyword">Value</span>                      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------+----------------------------+</span>
<span class="token operator">|</span> character_set_client     <span class="token operator">|</span> utf8                       <span class="token operator">|</span>
<span class="token operator">|</span> character_set_connection <span class="token operator">|</span> utf8                       <span class="token operator">|</span>
<span class="token operator">|</span> character_set_database   <span class="token operator">|</span> latin1                     <span class="token operator">|</span>
<span class="token operator">|</span> character_set_filesystem <span class="token operator">|</span> <span class="token keyword">binary</span>                     <span class="token operator">|</span>
<span class="token operator">|</span> character_set_results    <span class="token operator">|</span> utf8                       <span class="token operator">|</span>
<span class="token operator">|</span> character_set_server     <span class="token operator">|</span> latin1                     <span class="token operator">|</span>
<span class="token operator">|</span> character_set_system     <span class="token operator">|</span> utf8                       <span class="token operator">|</span>
<span class="token operator">|</span> character_sets_dir       <span class="token operator">|</span> <span class="token operator">/</span>usr<span class="token operator">/</span><span class="token keyword">share</span><span class="token operator">/</span>mysql<span class="token operator">/</span>charsets<span class="token operator">/</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------+----------------------------+</span>
<span class="token number">8</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如不是，可以设置</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> character_set_client <span class="token operator">=</span> utf8<span class="token punctuation">;</span>
<span class="token keyword">SET</span> character_set_results <span class="token operator">=</span> utf8<span class="token punctuation">;</span>
<span class="token keyword">SET</span> character_set_connection <span class="token operator">=</span> utf8<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="四、mysql-数据库密码管理">四、mysql 数据库密码管理</h2>
<p>设置密码访问，密码破解、密码权限、修改密码；</p>
<h3 id="1、创建用户及授权">1、创建用户及授权</h3>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">on</span> zxg<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> test<span class="token variable">@localhost</span> identified <span class="token keyword">by</span> <span class="token string">'pas'</span><span class="token punctuation">;</span>
<span class="token keyword">grant</span> <span class="token keyword">select</span><span class="token punctuation">,</span><span class="token keyword">insert</span><span class="token punctuation">,</span><span class="token keyword">update</span><span class="token punctuation">,</span><span class="token keyword">delete</span> <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token keyword">to</span> test<span class="token variable">@"%"</span> identified <span class="token keyword">by</span> <span class="token string">'pas'</span><span class="token punctuation">;</span>
<span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">on</span> zxg<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> test<span class="token variable">@`192.168.216.53`</span> identified <span class="token keyword">by</span> <span class="token string">'pas'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="2、破解密码方法">2、破解密码方法</h3>
<p>停止服务---》跳过权限方式启动---》单开一个窗口登陆---》登陆修改密码即可</p>
<p>1）systemctl stop mariadb</p>
<p>2）mysqld_safe --skip-grant-tables &amp;</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">[</span>root<span class="token variable">@web2</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysqld_safe --skip-grant-tables &amp;</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">47542</span>
<span class="token punctuation">[</span>root<span class="token variable">@web2</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># 190520 15:45:22 mysqld_safe Logging to '/var/log/mariadb/mariadb.log'.</span>
<span class="token number">190520</span> <span class="token number">15</span>:<span class="token number">45</span>:<span class="token number">22</span> mysqld_safe <span class="token keyword">Starting</span> mysqld daemon <span class="token keyword">with</span> <span class="token keyword">databases</span> <span class="token keyword">from</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">[</span>root<span class="token variable">@web2</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysql</span>
Welcome <span class="token keyword">to</span> the MariaDB monitor<span class="token punctuation">.</span>  Commands <span class="token keyword">end</span> <span class="token keyword">with</span> <span class="token punctuation">;</span> <span class="token operator">or</span> \g<span class="token punctuation">.</span>
Your MariaDB connection id <span class="token operator">is</span> <span class="token number">1</span>
Server version: <span class="token number">5.5</span><span class="token number">.60</span><span class="token operator">-</span>MariaDB MariaDB Server
 
Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">2018</span><span class="token punctuation">,</span> Oracle<span class="token punctuation">,</span> MariaDB Corporation Ab <span class="token operator">and</span> others<span class="token punctuation">.</span>
 
<span class="token keyword">Type</span> <span class="token string">'help;'</span> <span class="token operator">or</span> <span class="token string">'\h'</span> <span class="token keyword">for</span> help<span class="token punctuation">.</span> <span class="token keyword">Type</span> <span class="token string">'\c'</span> <span class="token keyword">to</span> clear the <span class="token keyword">current</span> input statement<span class="token punctuation">.</span>
 
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">use</span> mysql<span class="token punctuation">;</span>
Reading <span class="token keyword">table</span> information <span class="token keyword">for</span> completion <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token operator">and</span> <span class="token keyword">column</span> names
You can turn <span class="token keyword">off</span> this feature <span class="token keyword">to</span> get a quicker startup <span class="token keyword">with</span> <span class="token operator">-</span>A
 
<span class="token keyword">Database</span> changed
MariaDB <span class="token punctuation">[</span>mysql<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">update</span> <span class="token keyword">user</span> <span class="token keyword">set</span> password<span class="token operator">=</span>password<span class="token punctuation">(</span><span class="token string">'11111111'</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token keyword">user</span><span class="token operator">=</span><span class="token string">'root'</span> <span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">4</span>  Changed: <span class="token number">3</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>
 
MariaDB <span class="token punctuation">[</span>mysql<span class="token punctuation">]</span><span class="token operator">&gt;</span> flush <span class="token keyword">privileges</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
 
MariaDB <span class="token punctuation">[</span>mysql<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token keyword">exit</span>
Bye
<span class="token punctuation">[</span>root<span class="token variable">@web2</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后退出”跳过权限方式“ ctrl+c ，正常启动mysql就可以了</p>
<h2 id="五、mysql-配置文件详解">五、mysql 配置文件详解</h2>
<h3 id="1、参数说明">1、参数说明</h3>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">mysqld</span><span class="token punctuation">]</span></span>                                                              #服务端配置
<span class="token key attr-name">port</span>        <span class="token punctuation">=</span> <span class="token value attr-value">3306                                                    #监听端口</span>
<span class="token key attr-name">socket</span>      <span class="token punctuation">=</span> <span class="token value attr-value">/tmp/mysql.sock                                         #通信设置</span>
<span class="token key attr-name">user</span>    <span class="token punctuation">=</span> <span class="token value attr-value">mariadb                                                     #使用mariadb用户启动</span>
<span class="token key attr-name">basedir</span> <span class="token punctuation">=</span> <span class="token value attr-value">/usr/local/mariadb                                          #安装路径</span>
<span class="token key attr-name">datadir</span> <span class="token punctuation">=</span> <span class="token value attr-value">/data/mysql                                                 #数据目录</span>
<span class="token key attr-name">log_error</span> <span class="token punctuation">=</span> <span class="token value attr-value">/data/mysql/mariadb.err                             　　　 #错误日志</span>
<span class="token key attr-name">pid-file</span> <span class="token punctuation">=</span> <span class="token value attr-value">/data/mysql/mariadb.pid                             　　　　#pid进程文件</span>
skip-external-locking                                                 #避免mysql的外部锁定，减少出错几率提高稳定性
<span class="token key attr-name">key_buffer_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">64M                                                 #缓存存储引擎参数，这个参数可以设置为64M</span>
<span class="token key attr-name">max_allowed_packet</span> <span class="token punctuation">=</span> <span class="token value attr-value">1M                                               #允许最大接收数据包的大小，防止服务器发送过大的数据包，可以设置为16MB或者更大，但设置太大也可能有危险</span>
<span class="token key attr-name">table_open_cache</span> <span class="token punctuation">=</span> <span class="token value attr-value">256                                                #mysql每打开一个表，都会读入一些数据到table_open_cache缓存中，当MYSQL在这个缓存中找不到相应的信息时，才会去磁盘读取，默认值64，假设系统有200个并发连接，则需将此参数设置为200*N（N为每个连接所需的文件描述符数目）；当设置为很大时，如果系统处理不了那么多文件描述符，那么就会出现客户端失效，连接不上</span>
<span class="token key attr-name">sort_buffer_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">1M                                                 #在表进行order by和group by 排序操作时，由于排序的字段没有索引，会出现Using filesort，为了提高性能，可用此参数增加每个线程分配的缓存区大小，默认时256k，这个参数不要设置过大，一般128~256k，另外一般出现using filesort的时候，要通过增加索引来解决</span>
<span class="token key attr-name">net_buffer_length</span> <span class="token punctuation">=</span> <span class="token value attr-value">8K                                                #包消息缓冲区初始化net_buffer_length字节，但需要时可以增长到max_allowed_packet字节</span>
<span class="token key attr-name">read_buffer_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">1M                                                 #该参数用于表的顺序扫描，表示每个线程分配的缓冲区大小，比如在进行全表扫描时，mysql会按照数据的存储顺序一次读取数据块，每次读取的数据块首先会暂存在read_buffer_size中，当buffer空间被写满或者全部数据读取结束后，在将buffer中的数据返回给上层调用者，以提高效率默认128k，也不要设置过大</span>
<span class="token key attr-name">read_rnd_buffer_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">512K                                           #该参数用于表的随机读取，表示每个线程分配的缓冲区大小，比如，按照一个非索引字段做order by排序操作时，就会利用这个缓冲区来暂存读取的数据，默认时256k，也不要设置过大</span>
<span class="token key attr-name">myisam_sort_buffer_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">16M                                         #当myisam表执行repair table或创建索引时，用以缓冲排序索引，设置太小可能会遇到"myisam_sort_buffer_size is to small"</span>
<span class="token key attr-name">thread_cache_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">32                                                #线程池，线程缓冲。用来缓冲空闲的线程，以至于不被销毁，如果线程缓冲在的空闲线程，需要重新建立新连接，则会优先调用线程池中的缓冲，很快就能相应连接请求，每建立一个连接，都需要一个线程与之匹配。</span>
<span class="token key attr-name">query_cache_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">32M                                                #缓存select语句和结果集大小的参数。查询缓存会存储一个select查询的文本与被传送到客户端的相应结果。如果之后接收到一个相同的查询，服务器会从查询缓存中检索结果，而不是再次分析和执行这个同样的查询。如果你的环境中写操作很少，读操作频繁，那么打开query_cache_type=1，会对性能有明显提升。如果写操作频繁，则应该关闭它（query_cache_type=0）。</span>
<span class="token key attr-name">tmp_table_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">64M                                                  #临时HEAP数据表的最大长度(默认设置是32M); 超过这个长度的临时数据表将被转换为MyISAM数据表并存入一个临时文件。</span>
                                                                      <span class="token comment">#</span>
<span class="token key attr-name">explicit_defaults_for_timestamp</span> <span class="token punctuation">=</span> <span class="token value attr-value">true                     　　　　　　 #是否显示默认时间戳</span>
<span class="token comment">#skip-networking                                                      #</span>
<span class="token key attr-name">max_connections</span> <span class="token punctuation">=</span> <span class="token value attr-value">500                                                 #该参数用来设置最大连接数，告诉你当前你的服务器允许多少并发连接。默认为100，一般设置为512-1000即可。请记住，太多的连接会导致内存的使用量过高并且会锁住你的 MySQL 服务器。一般小网站需要 100-200 的连接数，而较大可能需要 500-800 甚至更多。这里的值很大程度上取决于你 MySQL/MariaDB 的使用情况。</span>
<span class="token key attr-name">max_connect_errors</span> <span class="token punctuation">=</span> <span class="token value attr-value">100                                              #如果有时网络抽风，或者应用配置错误，或者其他原因导致客户端短时间内不断的尝试连接，客户端可能会被列入黑名单，然后将无法连接，直到再次刷新主机缓存。这个选项默认值太小了，可以考虑设的足够大（如果你的服务器配置够强大的话）。</span>
<span class="token key attr-name">open_files_limit</span> <span class="token punctuation">=</span> <span class="token value attr-value">65535                                              #mysql打开最大文件数</span>
                                                                      <span class="token comment">#</span>
<span class="token key attr-name">log-bin</span><span class="token punctuation">=</span><span class="token value attr-value">mysql-bin                                                     #这些路径相对于datadir</span>
<span class="token key attr-name">binlog_format</span><span class="token punctuation">=</span><span class="token value attr-value">mixed                                                   #日志格式</span>
<span class="token key attr-name">server-id</span>   <span class="token punctuation">=</span> <span class="token value attr-value">1                                                       #给服务器分配一个独一无二的ID编号; n的取值范围是1~2的32次方启用二进制日志功能。在复制数据同步的时候会用到，Helloweba后面会有文章介绍。</span>
<span class="token key attr-name">expire_logs_days</span> <span class="token punctuation">=</span> <span class="token value attr-value">10                                                 #启用二进制日志后，保留日志的天数。服务器会自动清理指定天数前的日志文件，如果不设置则会导致服务器空间耗尽。一般设置为7～14天。</span>
                                                                       <span class="token comment">#</span>
<span class="token key attr-name">default_storage_engine</span> <span class="token punctuation">=</span> <span class="token value attr-value">InnoDB                                     　#新数据表的默认存储引擎(默认设置是MyISAM)。这项设置还可以通过–default-table-type选项来设置。</span>
<span class="token key attr-name">innodb_file_per_table</span> <span class="token punctuation">=</span> <span class="token value attr-value">1                                             #提供了更灵活的方式，它把每个数据库的信息保存在一个 .ibd 数据文件中。每个 .idb 文件代表它自己的表空间。通过这样的方式可以更快地完成类似 “TRUNCATE” 的数据库操作，当删除或截断一个数据库表时，你也可以回收未使用的空间。这样配置的另一个好处是你可以将某些数据库表放在一个单独的存储设备。这可以大大提升你磁盘的 I/O 负载。</span>
<span class="token key attr-name">innodb_data_home_dir</span> <span class="token punctuation">=</span> <span class="token value attr-value">/data/mysql                             　　　　#InnoDB主目录，所有与InnoDB数据表有关的目录或文件路径都相对于这个路径。在默认的情况下，这个主目录就是MySQL的数据目录。</span>
<span class="token key attr-name">innodb_data_file_path</span> <span class="token punctuation">=</span> <span class="token value attr-value">ibdata1:10M:autoextend     　　　　　　　　　　　#用来容纳InnoDB为数据表的表空间: 可能涉及一个以上的文件; 每一个表空间文件的最大长度都必须以字节(B)、兆字节(MB)或千兆字节(GB)为单位给出; 表空间文件的名字必须以分号隔开; 最后一个表空间文件还可以带一个autoextend属性和一个最大长度(max:n)。</span>
<span class="token key attr-name">innodb_log_group_home_dir</span> <span class="token punctuation">=</span> <span class="token value attr-value">/data/mysql                     　　　　　　#用来存放InnoDB日志文件的目录路径(如ib_logfile0、ib_logfile1等)。在默认的情况下，InnoDB驱动程序将使用 MySQL数据目录作为自己保存日志文件的位置。</span>
<span class="token key attr-name">innodb_buffer_pool_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">256M                                     　　#这个参数是InnoDB存储引擎的核心参数，默认为128KB，这个参数要设置为物理内存的60%～70%。</span>
<span class="token key attr-name">innodb_log_file_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">64M                                            #事务日志文件写操作缓存区的最大长度(默认设置是1MB)。</span>
<span class="token key attr-name">innodb_log_buffer_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">8M                                           #事务日志所使用的缓存区。InnoDB在写事务日志的时候，为了提高性能，先将信息写入Innodb Log Buffer中，当满足innodb_flush_log_trx_commit参数所设置的相应条件（或者日志缓冲区写满）时，再将日志写到文件（或者同步到磁盘）中。可以通过innodb_log_buffer_size参数设置其可以使用的最大内存空间。默认是8MB，一般为16～64MB即可。</span>
<span class="token key attr-name">innodb_flush_log_at_trx_commit</span> <span class="token punctuation">=</span> <span class="token value attr-value">1                             　　　　#这个选项决定着什么时候把日志信息写入日志文件以及什么时候把这些文件物理地写(术语称为”同步”)到硬盘上。设置值0的意思是每隔一秒写一次日 志并进行 同步，这可以减少硬盘写操作次数，但可能造成数据丢失; 设置值1(设置设置)的意思是在每执行完一条COMMIT命令就写一次日志并进行同步，这可以防止数据丢失，但硬盘写操作可能会很频繁; 设置值2是一般折衷的办法，即每执行完一条COMMIT命令写一次日志，每隔一秒进行一次同步。</span>
<span class="token key attr-name">innodb_lock_wait_timeout</span> <span class="token punctuation">=</span> <span class="token value attr-value">50                                         #如果某个事务在等待n秒(s)后还没有获得所需要的资源，就使用ROLLBACK命令放弃这个事务。这项设置对于发现和处理未能被InnoDB数据表驱动 程序识别出来的死锁条件有着重要的意义。这个选项的默认设置是50s。</span>
                                                                      <span class="token comment">#</span>
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">mysqldump</span><span class="token punctuation">]</span></span>                                                           #
quick                                                                 #
<span class="token key attr-name">max_allowed_packet</span> <span class="token punctuation">=</span> <span class="token value attr-value">16M                                              #</span>          
                                                                      <span class="token comment">#</span>
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">mysql</span><span class="token punctuation">]</span></span>                                                               #
no-auto-rehash                                                        #
                                                                      <span class="token comment">#</span>
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">myisamchk</span><span class="token punctuation">]</span></span>                                                           #
<span class="token key attr-name">key_buffer_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">64M                                                 #</span>  
<span class="token key attr-name">sort_buffer_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">1M                                                 #</span>  
<span class="token key attr-name">read_buffer</span> <span class="token punctuation">=</span> <span class="token value attr-value">2M                                                      #</span>
<span class="token key attr-name">write_buffer</span> <span class="token punctuation">=</span> <span class="token value attr-value">2M                                                     #</span>
                                                                      <span class="token comment">#</span>
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">mysqlhotcopy</span><span class="token punctuation">]</span></span>                                                        #
interactive-timeout                                                   #<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2、mysql数据库索引案例（百万量级）">2、mysql数据库索引案例（百万量级）</h3>
<p>[client]</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">port    <span class="token operator">=</span><span class="token number">3306</span>                                  
socket    <span class="token operator">=</span><span class="token operator">/</span>tmp<span class="token operator">/</span>mysql<span class="token punctuation">.</span>sock                     
 
 
 
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>                                                                             
port        <span class="token operator">=</span> <span class="token number">3306</span>                                                         
socket      <span class="token operator">=</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>mysql<span class="token punctuation">.</span>sock                                   
<span class="token keyword">user</span>    <span class="token operator">=</span> mysql  
server_id　　<span class="token operator">=</span> <span class="token number">10</span>
datadir　　<span class="token operator">=</span> <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mysql<span class="token operator">/</span>
old_passwords　　<span class="token operator">=</span> <span class="token number">1</span>
lower_case_table_names　　<span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">character</span><span class="token operator">-</span><span class="token keyword">set</span><span class="token operator">-</span>server　　<span class="token operator">=</span> utf8
<span class="token keyword">default</span><span class="token operator">-</span>storage<span class="token operator">-</span><span class="token keyword">engine</span>　　<span class="token operator">=</span> MYISAM
log<span class="token operator">-</span>bin　　<span class="token operator">=</span> bin<span class="token punctuation">.</span>log
log<span class="token operator">-</span>error　　<span class="token operator">=</span> error<span class="token punctuation">.</span>log
pid<span class="token operator">-</span><span class="token keyword">file</span>　　<span class="token operator">=</span> mysql<span class="token punctuation">.</span>pid
long_query_time　　<span class="token operator">=</span> <span class="token number">2</span>
slow_query_time　　<span class="token operator">=</span> <span class="token number">2</span>
slow_query_log　
slow_query_log_file　　<span class="token operator">=</span> slow<span class="token punctuation">.</span>log
binlog_cache_size　　<span class="token operator">=</span> <span class="token number">4</span>MB
binlog_format　　<span class="token operator">=</span> mixed
max_binlog_cache_size　　<span class="token operator">=</span> <span class="token number">16</span>MB
max_binlog_size　　<span class="token operator">=</span> <span class="token number">1</span>GB
expire_logs_days　　<span class="token operator">=</span> <span class="token number">30</span>
ft_min_word_len　　<span class="token operator">=</span> <span class="token number">4</span>
back_log　　<span class="token operator">=</span> <span class="token number">512</span>
max_allowed_packet　　<span class="token operator">=</span> <span class="token number">64</span>MB
max_connections　　<span class="token operator">=</span> <span class="token number">4096</span>
max_connect_errors　　<span class="token operator">=</span> <span class="token number">100</span>
join_buffer_size　　<span class="token operator">=</span> <span class="token number">2</span>MB
read_buffer_size　　<span class="token operator">=</span> <span class="token number">2</span>MB
read_rnd_buffer_size　　<span class="token operator">=</span> <span class="token number">2</span>MB
sort_buffer_size　　　　<span class="token operator">=</span> <span class="token number">2</span>MB
query_cache_size　　<span class="token operator">=</span> <span class="token number">2</span>MB
table_open_cache　　<span class="token operator">=</span> <span class="token number">10000</span>
thread_cache_size　　<span class="token operator">=</span> <span class="token number">256</span>
max_heap_table_size　　<span class="token operator">=</span> <span class="token number">64</span>MB
tmp_table_size　　<span class="token operator">=</span> <span class="token number">64</span>MB
thread_stack　　<span class="token operator">=</span> <span class="token number">192</span>KB
thread_concurrency　　<span class="token operator">=</span> <span class="token number">24</span>
<span class="token keyword">local</span><span class="token operator">-</span><span class="token keyword">infile</span>　　<span class="token operator">=</span> <span class="token number">0</span>
skip<span class="token operator">-</span><span class="token keyword">show</span><span class="token operator">-</span><span class="token keyword">database</span>
skip<span class="token operator">-</span>name<span class="token operator">-</span>resolve
skip<span class="token operator">-</span>external<span class="token operator">-</span>locking
connect_timeout　　<span class="token operator">=</span> <span class="token number">600</span>
interactive_timeout　　<span class="token operator">=</span> <span class="token number">600</span>
wait_timeout　　<span class="token operator">=</span> <span class="token number">600</span>
<span class="token comment">#MyISAM</span>
key_buffer_size　　<span class="token operator">=</span> <span class="token number">512</span>MB
bulk_insert_buffer_size　　<span class="token operator">=</span> <span class="token number">64</span>MB
mysiam_sort_buffer_size　　<span class="token operator">=</span> <span class="token number">64</span>MB
mysiam_max_sort_file_size　　<span class="token operator">=</span> <span class="token number">1</span>GB
mysiam_repair_threads　　<span class="token operator">=</span> <span class="token number">1</span>
concurrent_insert　　<span class="token operator">=</span> <span class="token number">2</span>
myisam_recover
<span class="token comment">#INNODB</span>
innodb_buffer_pool_size　　<span class="token operator">=</span> <span class="token number">64</span>G
innodb_additional_mem_pool_size　　<span class="token operator">=</span> <span class="token number">32</span>MB
innodb_data_file_path　　<span class="token operator">=</span>　ibdata1:<span class="token number">1</span>G<span class="token punctuation">;</span>ibdata2:<span class="token number">1</span>G:autoextend
innodb_read_io_threads　　<span class="token operator">=</span> <span class="token number">8</span>
innodb_write_io_threads 　　<span class="token operator">=</span> <span class="token number">8</span>
innodb_file_per_table　　<span class="token operator">=</span> <span class="token number">1</span>
innodb_flush_log_at_thx_commit　　<span class="token operator">=</span> <span class="token number">2</span>
innodb_lock_wait_timeout　　<span class="token operator">=</span> <span class="token number">120</span>
innodb_log_buffer_size　　<span class="token operator">=</span> <span class="token number">8</span>MB
innodb_log_file_size　　<span class="token operator">=</span> <span class="token number">256</span>MB
innodb_log_files_in_group　　<span class="token operator">=</span> <span class="token number">3</span>
innodb_max_dirty_pages_pct　　<span class="token operator">=</span> <span class="token number">90</span>
innodb_thread_concurrency　　<span class="token operator">=</span> <span class="token number">16</span>
innodb_open_files　　<span class="token operator">=</span> <span class="token number">10000</span>
<span class="token comment">#innodb_force_recovery　　= 4</span>
<span class="token comment">#replication slave</span>
<span class="token keyword">read</span><span class="token operator">-</span>only
<span class="token comment">#skip-salve-start</span>
relay<span class="token operator">-</span>log　　<span class="token operator">=</span> relay<span class="token punctuation">.</span>log
log<span class="token operator">-</span>slave<span class="token operator">-</span>updates<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>本文参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.centos.bz/2018/02/mariadb-mysql%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6my-cnf%E8%A7%A3%E8%AF%BB/">mariadb-mysql配置文件my-cnf解读</a></p>
<p><a target="_blank" rel="noopener" href="http://c.biancheng.net/mysql/">MySQL教程</a></p>
<p>《曝光：Linux企业运维实战》</p>
<p>夜法之书 整理编辑 <strong>From:</strong> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhangxingeng/p/10882845.html">zhangxingeng</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Docker</tag>
        <tag>MySql</tag>
        <tag>Mariadb</tag>
        <tag>技巧</tag>
      </tags>
  </entry>
  <entry>
    <title>Joplin 插件以及其Markdown语法。All in One!</title>
    <url>/posts/92d347d6/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Joplin是一个以Markdown为主要语法的笔记程序，发展到今天增加了许多插件，这些插件也大大增强了它的功能，今天我们就讲讲Joplin的各个插件的作用和使用方法。</p>
<p>首先我们打开Joplin，依次点击<strong>工具-&gt;选项</strong>设置页面，然后点击<strong>Markdown</strong>选项卡，我们就可以看到如下界面</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910083827.png" alt="Joplin插件选择配置界面"></p>
<p>下面我们一个一个讲解一下每个插件的大概作用和用法，某些插件的详细使用方法可能需要我独立写一篇文章来介绍，这里我就先抛砖引玉大致介绍一下。</p>
<h2 id="启动软中断插件">启动软中断插件</h2>
<p>Joplin默认使用的是硬中断方式，那么什么是软中断什么是硬中断呢？如果你刚开始使用Markdown撰写自己的笔记你可能会非常的不习惯，因为标准的Markdown语法里面换行需要两个回车符号，但是像word之类的编辑器都是一个回车，普通人会感觉很不习惯，所以Joplin默认采用了硬中断方式，这样你可以使用一个回车符实现换行。但是当我们启用软中断插件之后，我们就需要两个回车符来实现换行（准确说应该是分段），使用两个空格加一个回车来实现换行，前者的间距会比后者的大。启用软中断其实对于普通人来说不是很好用，很难适应，所以我不建议大家开启该插件！</p>
<h2 id="启用typographer支持">启用typographer支持</h2>
<p>这个插件的作用是用来申明我们的版权的，因为有时候我们可能需要将我们的笔记分享给别人，但是想要声明文章是我们写的，我们就可以启用该插件来声明我们的著作权，而且该插件会给我们渲染成指定的版权声明格式，讲讲怎么用：</p>
<p>我们启用插件之后，在我们想要声明著作权的地方键入：</p>
<pre class="line-numbers language-none"><code class="language-none">(c)著作权所有人<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后Joplin就会给我们渲染为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909174240.png" alt="typographer插件语法渲染结果"></p>
<p>是不是很熟悉，很多网页的底部都会有这个声明！</p>
<h2 id="启用数学表达式">启用数学表达式</h2>
<p>这个是Markdown自带语法，Joplin使用插件来实现的，其实就是大家在<a target="_blank" rel="noopener" href="http://lightzhan.xyz/index.php/2020/02/28/markdowntutorial/">Markdown语法</a>里面看到的行内公式使用<img src="https://math.now.sh?inline=%E2%80%A6" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;">，行间公式使用$$…$$。需要说明的是Joplin使用的是Katex来解析数学符号，它的语法和Latex的数学公式写法差不多，我到现在还没有碰到很大的不同的地方！</p>
<h2 id="启用高亮-Mark-句法">启用高亮<code>==Mark==</code>句法</h2>
<p>这个其实就是一个语句高亮插件，中间的语句会被高亮显示，有助于我们对重要的内容进行强调，自己一试就一目了然了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909174304.png" alt="Joplin Mark插件示例"></p>
<h2 id="启用脚注">启用脚注</h2>
<p>脚注的功能就是对文中的某一个特定的术语等进行解释补充说明，有点像是论文的参考文献，下面是一个简单的示例，相信大家一看就懂</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909174326.png" alt="Joplin 启用脚注插件示例图"></p>
<p>根据图片你可能明白了脚注的使用方法：在我们想要使用脚注的地方使用[^唯一标识符]注明，然后在文章的最后使用响应的标识符进行说明即可，比如例子中的</p>
<pre class="line-numbers language-none"><code class="language-none">[^lightzhan]:知乎搜索light zhan即可找到我了<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>注意那个冒号一定要是英文冒号，中文冒号可能无法被成功解析</strong>。</p>
<h2 id="启用目录扩展">启用目录扩展</h2>
<p>启用该扩展，我们就可以使用相应的语法在某个位置插入我们文章的目录，具体的语法为</p>
<pre class="line-numbers language-none"><code class="language-none">[toc]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意着是一个固定的符号，不需要改变什么，只需要在我们想要插入目录的地方放上**[toc]**即可，例如</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909174350.png" alt="Joplin toc目录生成插件示例图"></p>
<p>上图最重要的就是坐上脚的[toc]指令，该指令自动生成了右边的整个目录！</p>
<h2 id="启用下标-sub-和上标-sup-句法">启用下标<code>~sub~</code>和上标<code>^sup^</code>句法</h2>
<p>一看到<sub>sub</sub>如果不小心就会认为这个是删除线，大错特错了，一定要明白两者的区别，删除线是左右都是两个波浪线，而这个只有一个波浪线，一定要搞清楚这个。下面我们看看这个插件的作用和用法。</p>
<p>这两个插件的作用其实很简单，就是下标和上标，看例子应该就明白的</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909174420.png" alt=""></p>
<h2 id="启用术语表插件">启用术语表插件</h2>
<p>对于这个插件得先知道什么是术语表。所谓的术语表其实可以理解为一个定义的列表，很多专业的书籍的前面都会有术语表，因为它需要给出书中所用术语的定义和解释。还不懂？我们在Joplin中启用该插件，然后新建一个笔记，输入如下文字：</p>
<pre class="line-numbers language-none"><code class="language-none">Qdown

:   Qdown是由lightzhan开发的全功能软件下载程序，这里是程序的介绍页哦:http://lightzhan.xyz/index.php/qdown/ 

LightZhan

:   计算机爱好一名，爱折腾哎生活，*欢迎知乎关注lightzhan哦*

        可以嵌入一些代码

    定义第三段 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这些文字会被解析显示为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909174558.png" alt="Joplin术语表插件示例"></p>
<p>对比一下发现了什么没有？术语表的每一项由两个部分组成，第一部分是术语，第二部分是该术语的解释，多个术语及其解释组合在一起就组成了表，这就是术语表！需要特别注意的是术语表的书写格式是固定的，如果你想要快速上手，建议你拷贝上面我提供的示例进行修改，修改两下你就懂格式到底是怎么回事了！</p>
<h2 id="启用缩写句法">启用缩写句法</h2>
<p>这个插件很有意思，也很有用。你是否记得有些程序的按钮，当你把鼠标放上去的时候它会显示按钮的作用。不记得了？不存在，我们也使用例子来说明。下面我们启用缩写句法插件，然后新建笔记，在笔记里面输入：</p>
<pre class="line-numbers language-none"><code class="language-none">*[Qdown]: 由lightzhan开发
*[LightZhan]:  欢迎知乎关注我哦
Qdown 是由 LightZhan 开发的一款全协议下载器.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>该文本会被Joplin显示为</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909174619.png" alt="Markdown Joplin 缩写表插件示例图"></p>
<p>这可能并不能完全显示出该插件的作用，因为截图的原因截不到，当我们把鼠标放在Qdown上面的时候，鼠标所在的位置处会弹出“由lightzhan”开发的提示。不理解的可以拷贝上面的代码到Joplin感受一下，记得要开启该插件哦！需要注意的是该句中对应的<strong>缩写词前后都要有空格</strong>，负责你可能看不到上面的效果。</p>
<h2 id="启用Markdown-emoji">启用Markdown emoji</h2>
<p>该插件是用于在我们的笔记中插入表情的，这是一个简单的示例截图</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909174639.png" alt="Joplin表情插件示例"></p>
<p>详细的表情和表情的代码，可以参考<a target="_blank" rel="noopener" href="https://github.com/zhouie/markdown-emoji">这里</a>。</p>
<h2 id="启用-insert-句法">启用<code>++insert++</code>句法</h2>
<p>这个插件很好理解，一试便知道作用和用法了</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909174656.png" alt="Joplin insert插件示例"></p>
<p>说了那么多，就是在对应的文字下面显示一个下划线！</p>
<p>Markdown是非常好用的笔记书写规范，记着，Markdown不是某一个软件，而是一个通用的笔记书写规范，通过使用该规范进行写作，解析器会按照规定的样式将其渲染显示出来，说得直白点就是用于文字排版的。</p>
<h2 id="Markdown的排版语法">Markdown的排版语法</h2>
<p>这里的讲解如果有不懂的可以参见下一节的示例：</p>
<ol>
<li>标题。markdown的标题使用“#”符号开头，一级标题一个”#”，二级标题两个“#”（也就是“##”），以此类推三级标题四级标题…….，不同级的标题会被渲染为不同的大小和样式（根据各个软件和相应的主题而定）；</li>
<li>粗体。markdown的粗体字使用两个“**”包裹即可，比如 “<strong>你好</strong>”解析后变为“你好”；</li>
<li>斜体。markdown的斜体使用“*”或者“_”包裹，比如“<em>你好</em>”解析显示为“你好”；</li>
<li>引用。markdown的引用使用“&gt;”开头，大部分软件要求“&gt;”要和引用内容之间有一个空格；</li>
<li>代码。对于程序员来说可能想要在文中插入代码，markdown是支持插入代码的，行间代码使用一个"`"符号包裹，注意这个符号是键盘左上角Esc下面的那个键，不是我们所谓的英文上一撇；</li>
<li>数学公式。markdown的数学解析一般使用latex语法，行内公式使用一个<code>$</code>包裹即可，行间公式使用两个<code>$</code>包裹；</li>
<li>markdown的列表分为有序列表和无序列表。有序列表就是有序号，无序列表就是 无序号，有序列表就是在数字后面一个点，然后空一格写正文，比如：<code>1. xxxxxxx</code>，第二点需要新起一行<code>2. xxxxxx</code>。无序列表是使用“*”或者“-”开始，后面跟一个空格写上正文。</li>
<li>markdown的勾选框。markdown的勾选框使用<code>- [ ]</code>，注意字符之间都是有空格的。比如：第一行<code>- [ ] A</code>,第二行<code>- [ ] B</code>。这样对应的渲染结果就是勾选框和对应的选项。注意字符之间的空格！</li>
<li>表格。markdown的表格非常易于理解，请看下面的示例。</li>
</ol>
<h2 id="示例代码和渲染结果">示例代码和渲染结果</h2>
<p>下面的示例左边是书写文字，右边是渲染结果，<strong>注意书写文字里面的标识符和内容之间的空格</strong>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909175337.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909175353.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909175417.png" alt=""></p>
<p>需要说明的是上面的粗体显示为了橘红色的字体，这是我自己设置的格式，这个等大家熟悉了后可以使用CSS设计自己喜欢的样式。下面是表格的渲染结果 （其中左边的源代码不用那样对齐 ，横线的个数一处最少3个就行 ，右边是解析后的显示结果） ：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909175444.png" alt=""></p>
<p>额~，左边左下角那个是鼠标光标，不是文字内容哈。需要说明的是不同的软件的不同的主题可能显示的结果会不一样，但是书写的语法是不变的。</p>
<h2 id="启用-multimarkdown-表格扩展">启用 multimarkdown 表格扩展</h2>
<p>这个插件说高深也不高深，看名字应该就能知道这是一个增强Markdown表格功能的插件，大家记得Markdown的表格是怎么使用的吗？如果忘记的话赶紧看看<a target="_blank" rel="noopener" href="http://lightzhan.xyz/index.php/2020/02/28/markdowntutorial/">这篇文章</a>回顾一下，不然下面的内容可能体会不会那么深！</p>
<p>好啦，我这里假设读者知道markdown的表格是怎么用的，然后我们开始讲解multimarkdown扩展。Markdown自带的表格功能是非常有限的，如果你使用过的话就会发现它能做出来的表格一定是规整的，行和列一定是划分均匀整齐的，但是有时候我们需要的表格可能是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909175608.png" alt=""></p>
<p>这种表格使用Markdown的表格是不可能做出来的，因为分组的效果和占用两个格子的效果是做不出来的，但是如果你启用了MultiMarkdown插件，你就可以使用下面的代码渲染出来：</p>
<pre class="line-numbers language-none"><code class="language-none">|             |          分组                 ||
第一个表头     | 第二个表头     | 第三个表头      |
 ------------ | :-----------: | -----------:   |
内容          |          占用两个格子           ||
内容          |   **内容**     |         内容    |
新的一部分     |     更多       |         更多    |
更多          | 带有一个跳过的 '\|'              ||
[LightZhan制作]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>你可以把上面的代码拷贝进Joplin编辑器研究一番就能理解MultiMardown表格扩展的用法了，下面我详细讲解一下。</p>
<p>MultiMarkdown的表格扩展支持下面的功能：</p>
<ul>
<li>使得元素占据多个列（上面的示例中有）</li>
<li>使得元素占据多个行</li>
<li>在表格上面或者下面对表头进行分组（上面的例子中有）</li>
<li>在表格的上面或者下面标注表格标题（上面的例子中有）</li>
<li>在表格中包含分块元素（列表、代码、段落等等）</li>
<li>表格不需要表头</li>
</ul>
<p>上面标注了“上面的例子中有”的我这里就不在讲了，因为代码一研究或者修改修改就知道咋回事的，下面我们主要讲讲上面的例子中没有涉及到的。</p>
<p><strong>1.使得表格占据多行</strong>。这个其实很好用，但是有两种情况。第一种情况是一个项目占据两格。这种情况要占据多行的话，在我们对应列的起始行写上内容，然后接下来要合并的行直接写“^^”。不明白不存在，我们来一个例子：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909175656.png" alt="MultiMarkdown表格扩展内容占据多行示例图"></p>
<p>上面对应的代码是什么呢？看下面：</p>
<pre class="line-numbers language-none"><code class="language-none">作者		| 信息			  | 信息		 |
----:		| --------------:         | ---------:	         |
LightZhan	| ligthzhan.xyz 				||
^^		| 更多Joplin教程           | Qdown下载器	         |
[LightZhan制作，允许规范转载]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>把上面的代码拷贝进编辑器改改试试，很容易明白里面的玄机的！</p>
<p>第二种情况是我们添加块，看下面一点。</p>
<p>2.**在表格中添加块元素。**这个不用多说，直接在表格的格子里面用Markdown语法写作，渲染成对应的Markdown格式！比如加粗、斜体、代码块等等。下面来一个简单的例子，需要注意的是下面的例子当中我们的内容有几行！</p>
<pre class="line-numbers language-none"><code class="language-none">|   Markdown   | 渲染结果       |
|--------------|---------------|
|    *斜体*    | *斜体*         | \
|              |               |
|    - 项目1   | - 项目1        | \
|    - 项目2   | - 项目2        |
|    ```python | ```python       \
|    .1 + .2   | .1 + .2         \
|    ```       | ```           |
[LightZhan制作，允许规范转载]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意代码后面的”\”，这个符号是指定换行的，如果项目占据多行一定要写上。上面的代码复制黏贴进编辑器可以看到下面的渲染结果</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909175924.png" alt="Joplin多行和内容块的示例图"></p>
<p>**3.表格不需要表头。**这个也很简单，直接不写表头即可。拷贝下面的代码进编辑器</p>
<pre class="line-numbers language-none"><code class="language-none">----:		| --------------: | ---------:	 |
LightZhan	| lightzhan.xyz 	        ||
^^		| 更多Joplin教程  | Qdown下载器	 |
[LightZhan制作，允许规范转载]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后你就可以看到惊喜</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909180209.png" alt="Joplin表格扩展没有表头的表格示例图"></p>
<h2 id="启用Fountain语法支持">启用Fountain语法支持</h2>
<p>这个插件的目标人群非常少，Fountain语法是用来写电影剧本的，而且要是要细讲的话估计又是一篇文章，因为使用的人非常少，所以我这里就不讲这个了。</p>
<h2 id="Mermaid插件的作用">Mermaid插件的作用</h2>
<p>Mermaid是一个用于画流程图、时序图、类图、状态图、甘特图、饼图的Markdown扩展，其中状态图是最新8.4版本的新功能。如果你不知道这些图是干什么的，不存在，下面的教程里面我会每个都给出例子。</p>
<h2 id="在Joplin里面使用Mermaid">在Joplin里面使用Mermaid</h2>
<p>在Joplin里面如果想要使用Mermaid，那么你需要使用代码块，并且代码的类型填写mermaid，详细的格式如下：</p>
<pre class="line-numbers language-none"><code class="language-none">```mermaid
graph TD
    Start --&gt; Stop
```<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>在渲染区我们就能得到如下的结果</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909180438.png" alt="Mermid绘图渲染示例"></p>
<h2 id="Mermaid流程图">Mermaid流程图</h2>
<p>下面我们讲解在Mermaid里面画流程图。上一节的示例便是流程图，我们把上一节的代码拿出来分析一下。首先我们看代码的第一行：graph TD，这一行代码有两个作用，graph表示我们图的类型，graph表示流程图，而第二个TD表示图的方向，可能的方向有如下几个</p>
<ul>
<li>TB：自顶向下</li>
<li>BT：自底向上</li>
<li>RL：从右到左</li>
<li>LR：从左到右</li>
<li>TD：和TB一样</li>
</ul>
<p>上面我们的例子使用的是TD，如果你对其它的方向不明白，可以把代码拷贝到编辑器里面修改方向参数就可以理解各个方向的意义了。</p>
<p>上面的代码非常基础，因为如果要实现比较复杂的流程图，我们就需要使用一些比较高级的语法，比如定义节点。所谓的节点，你可以简单的理解为上面图片中的方框，但是如果我们要使用其它形状的节点怎么办呢？在上面的例子中我使用了默认的节点定义方法，也就是直接使用文本,这种方式定义节点的话id和显示文本是一样的，而且形状是固定的矩形。如果要定义不同的节点形状，或者使得id和显示文本不一样，可以使用下面的语法</p>
<ul>
<li>定义矩形形状的节点：id[text]</li>
<li>定义圆角矩形的节点：id(text)</li>
<li>定义椭圆形的节点：id([text])</li>
<li>定义圆柱形的节点：id[(text)]</li>
<li>定义圆形的节点：id((text))</li>
<li>定义非对称图形的节点：id&gt;text]</li>
<li>定义菱形的节点：id{text}</li>
<li>定义六角形的节点：id</li>
<li>定义平行四边形的节点(两个方向)：id[/text/]或者[\text]</li>
<li>定义梯形的节点(两个方向)：id[/text] 或者 di[\text/]</li>
</ul>
<p>注意上面的id和text是需要我们自己定义替换的，如果同一个id有多个text，取最后一次的定义值！</p>
<p>有了节点我们还需要将节点连接起来，也就是我们要使用线条或者箭头来进行节点的连接，Mermaid支持下面的方式：</p>
<ul>
<li>实线箭头：A–&gt;B</li>
<li>实线无箭头：A–B</li>
<li>无箭头实线上带文本：A–text–B</li>
<li>实线箭头带文本：A–&gt;|text|B 或者 A–text–&gt;B</li>
<li>虚线箭头：A-.-&gt;B</li>
<li>虚线箭头带文本：A-.text.-&gt;B</li>
<li>粗线箭头：A==&gt;B</li>
<li>粗线箭头带箭头：A<mark>text</mark>&gt;B</li>
</ul>
<p>最好的办法就是把上面的代码拷贝进编辑器看看，一看你应该就能理解各个图形的形状！</p>
<p>上面我们讲解了节点和连线，下面我们说说图形的绘制。上面我使用的例子非常基础，下面来一个复杂点的例子供大家修改和研究</p>
<pre class="line-numbers language-none"><code class="language-none">```mermaid
graph TD
    light[LightZhan]
    url[lightzhan.xyz]
    QdownUrl[访问LightZhan博客Qdown页面]
    Qdown((Qdown))
    function[功能]
    Qdown--&gt;|作者|light 
    light--个人主页--&gt;url
    Qdown--&gt;function
    Qdown--&gt;QdownUrl
    function1[极速下载]
    function2[磁链/BT下载]
    function3[迅雷下载]
    function5[下载体验]
    function4[Http/Https/FTP/SFTP]
    function-.功能1.-&gt;function1
    function-.功能2.-&gt;function2
    function-.功能3.-&gt;function3
    function-.功能4.-&gt;function4
    function-.更多功能.-&gt;function5
    annocement[本文首发于lightzhan.xyz,允许规范转载]

```<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面代码的渲染结果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909181150.png" alt="Mermaid流程图示例代码渲染结果"></p>
<p>如果不清楚，可以把上面的代码拷贝到编辑器进行修改和摸索！</p>
<h2 id="Mermaid时序图">Mermaid时序图</h2>
<p>时序图是用于展示过程的方式和顺序的。举例来说，两个人之间的对话:</p>
<p>A先问B：Qdown是啥？B回答：Qdown是全功能的下载软件！A又问：哪里可以下载呀？B回答： http://lightzhan.xyz/index.php/qdown/ 。我们使用mermaid绘制时序图来展示上面的对话过程：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909181418.png" alt="mermaid时序图示例图"></p>
<p>这样是不是看上去清晰了很多了呢？希望通过这个例子能让你深切地感受到时序图是干什么用的！好了，放上上面的时序图的代码供大家研究：</p>
<pre class="line-numbers language-none"><code class="language-none">```mermaid
sequenceDiagram
A-&gt;&gt;B:Qdown是啥？
B--&gt;&gt;A:Qdown是全功能的下载软件！
A-&gt;&gt;B:哪里可以下载呀？
B--&gt;&gt;A:http://lightzhan.xyz/index.php/qdown/
```<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>让我们来简单分析一下上面的代码。你可能注意到了第一行的sequenceDiagram，这个就是告诉mermaid我们在这里绘制时序图，然后下面有箭头，在时序图里面，mermaid支持下面类型的箭头和线段：</p>
<ul>
<li>实线并且没有箭头：A-&gt;B:text</li>
<li>虚线没有箭头：A–&gt;B:text</li>
<li>实线带箭头：A-&gt;&gt;B:text</li>
<li>虚线带箭头：A–&gt;&gt;B:text</li>
<li>实线并且在终点带一个x：A-xB:text</li>
<li>虚线并且在终点带一个x：A–xB:text</li>
</ul>
<p>上面的text就是要显示在箭头或线段上的文本，在mermaid的时序图里面被称为消息，线段或箭头类型如果有不清楚的可以拷贝到编辑器里面看看，一目了然！</p>
<p>还记得上面我们在流程图里面的节点吗？在时序图里面不是定义节点，而是定义参与者，也就是上面的A和B。上面的代码中我们定义参与者的方式采用的是默认方式，也就是不显示定义，有时候我们的参与者的名字太长的话可以使用显示定义来定义别名：</p>
<pre class="line-numbers language-none"><code class="language-none">participant John
participant Alice
participant A as Alice
participant J as John<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面代码的第一二行仅仅是显式定义我们的参与者，第三四行给我们的参与者定义别名，定义了别名后我们在下面的使用中就可以直接使用A代替Alice，使用J代替John了，这样输入会方便很多！</p>
<p>好了，时序图差不多就讲到这里，接下来的一些高级用法大部分我们都用不到，或者要使用的话不如使用专业的绘图软件使用插图的方式导入。</p>
<h2 id="使用Mermaid绘制类图">使用Mermaid绘制类图</h2>
<h3 id="类的定义">类的定义</h3>
<p>在讲解如何绘制类图之前我们先了解一下什么是类图！如果你是计算机专业或者会计算机编程的话应该就懂面向对象编程，对象是类的实例，而这里要绘制的类图就和面向对象编程里面的类相关。</p>
<p>对于编程人员来说，函数具有参数和返回值，属性具有变量类型，我们举一个例子来说一下：</p>
<pre class="line-numbers language-none"><code class="language-none">class BankAccount{
  +String owner
  +BigDecimal balance
  +deposit(amount) bool
  +withdrawl(amount)
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的代码的渲染结果为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909182000.png" alt="BankAccount类图"></p>
<p>上面的代码是我直接从官方借鉴的，可以直观地看出对于银行账户（BankAccount），一共有两个属性和两个方法，属性都是具有对应的变量类型，而对于函数具有参数（amount），并且deposit函数还具有bool类型的返回值。你或许看到了前面的+号，这个是对应变量或属性的可见性，分别有：</p>
<ul>
<li>+ public</li>
<li>– private</li>
<li># protected</li>
<li><code>~</code> Package/Internal</li>
</ul>
<p>如果我们想要定义的函数是抽象函数咋办呢？在括号的后面添加*即可：</p>
<pre class="line-numbers language-none"><code class="language-none">someAbstractMethod()*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在渲染过后抽象函数会使用斜体进行显示，这里就不截图展示了。对于静态函数，将后面的*换为$即可，在显示时静态函数会具有下划线。</p>
<h3 id="类之间的关系">类之间的关系</h3>
<p>在编程中我们常常会用到的关系：</p>
<table>
<thead>
<tr>
<th>&lt;|–</th>
<th>继承（Inheritance）</th>
</tr>
</thead>
<tbody>
<tr>
<td>*–</td>
<td>组成（Composition）</td>
</tr>
<tr>
<td>o–</td>
<td>聚集（Aggregation）</td>
</tr>
<tr>
<td>–&gt;</td>
<td>关联（Association）</td>
</tr>
<tr>
<td>—</td>
<td>实线（Link (Solid)）</td>
</tr>
<tr>
<td>…&gt;</td>
<td>依赖（Dependency）</td>
</tr>
<tr>
<td>…|&gt;</td>
<td>实现（Realization）</td>
</tr>
<tr>
<td>…</td>
<td>虚线（Link (Dashed)）</td>
</tr>
</tbody>
</table>
<p>下面我们举一个例子：“狗”继承自“动物”类别</p>
<pre class="line-numbers language-none"><code class="language-none">```mermaid
classDiagram
    class 动物{
        特点1：能动
        特点2：能叫
    }
    class 狗{
        特点1：4条腿
        特点2：会汪汪叫
        特点3：可爱至极
        汪汪叫(陌生人)
    }
    动物 &lt;|-- 狗
```<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>渲染结果为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909182019.png" alt="继承关系展示"></p>
<p>结合代码和展示结果应该很好理解，这就是一个狗继承自动物的简单例子，我们还可以对关系结果打标签：</p>
<pre class="line-numbers language-none"><code class="language-none">```mermaid
classDiagram
    class 动物{
        特点1：能动
        特点2：能叫
    }
    class 狗{
        特点1：4条腿
        特点2：会汪汪叫
        特点3：可爱至极
        汪汪叫(陌生人)
    }
    动物 &lt;|-- 狗:属于（继承）
```<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们在关系指示后面加上冒号，然后后面加上关系说明，这样在渲染结果当中我们就可以看到箭头上出现了我们需要的标签说明：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909182129.png" alt="给关系加上说明标签"></p>
<p>好了，使用mermaid绘制类图就讲到这里，还有一些用法不是很常用，我就不讲了。</p>
<h2 id="使用mermaid绘制饼图">使用mermaid绘制饼图</h2>
<p>绘制饼图的需求比较多，很多数据展示需要我们绘制饼图，幸运的是mermaid给我们提供了绘制饼图的功能，使用方法极其简单：</p>
<pre class="line-numbers language-none"><code class="language-none">```mermaid
pie
    title LightZhan创作，允许规范转载（http://lightzhan.xyz）
    "Joplin" : 42.96
    "Qdown" : 50.05
    " 黑科技" : 10.01
    "其它" :  5

```<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上面的代码中，pie关键字指定我们要绘制饼图，然后tiltile指定我们的标题，后面是数据分布，注意，mermaid会将我们输入的数据进行计算，上面的数据加起来并不是100，所以我们看到在下面的渲染结果中数据对应不上。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909182237.png" alt=""></p>
<p>Joplin插件非常丰富，你能找到各种各样的功能，这里推荐一些插件使用，见下面这篇文章， <a href="https://blog.17lai.site/note/2021-09-10-the-joplin-plugin-recommend/">Joplin插件推荐</a>。</p>
<h2 id="参考：">参考：</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://lightzhan.xyz/index.php/category/software-installation-and-use/joplin/">lightzhan.xyz</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>note</tag>
        <tag>Joplin</tag>
        <tag>MarkDown</tag>
        <tag>Mermaid</tag>
      </tags>
  </entry>
  <entry>
    <title>为知笔记私有化Docker部署</title>
    <url>/posts/1802a8a7/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>登陆NAS，打开套件中心，搜索docker，并安装。</p>
<p>搜索wiznote，找到wiznote/wizserver，双击下载</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909114640.png" alt=""></p>
<p>在NAS中创建共享目录，用于存放笔记数据</p>
<ol>
<li>
<p>启动File Station</p>
</li>
<li>
<p>在docker目录下创建文件夹：</p>
<p>wiz</p>
</li>
<li>
<p>在wiz文件夹下创建文件夹：data</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909114704.png" alt=""></p>
</li>
<li>
<p>双击创建容器，启用资源限制，设置为内存限制4096MB，官方介绍说需要4G内存</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909114710.jpeg" alt=""></p>
</li>
<li>
<p>高级设置，启动自动重新启动</p>
</li>
<li>
<p>卷设置，使用刚才我们创建的data目录进行配置，装载路径<code>/wiz/storage</code>，<code>docker/wiz/config</code>装载路径<code>/wiz/app/wizserver/config</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909114724.png" alt=""></p>
</li>
<li>
<p>网络设置不动，端口设置添加映射：8888映射80端口（8888可以随便设置，跟访问地址有关）</p>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909114731.png" alt=""></p>
<ol start="8">
<li>
<p>设置环境变量</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909114732.png" alt=""></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">SEARCH</span><span class="token operator">=</span>true <span class="token assign-left variable">TZ</span><span class="token operator">=</span>Asia/Shanghai<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>直接应用，启动docker，然后就静静的等待吧，可以看看镜像的日志，看到这些基本上就差不多启动好了（最新的镜像在NAS上首次启动非常慢，本人等了一个多小时才完全启动完毕，在本地安装速度非常快）<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909114738.jpeg" alt=""></p>
</li>
<li>
<p>通过 <code>http://NAS的IP:8888</code>，进行访问，就可以看到已经启动完成</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909114744.jpeg" alt="为知笔记启动界面"></p>
</li>
</ol>
<blockquote>
<p>默认管理员账号：admin@wiz.cn，密码：123456</p>
<p>管理后台登陆地址：http://IP地址:端口/wapp/pages/admin</p>
</blockquote>
<h2 id="NAS开启SSH">NAS开启SSH</h2>
<p>首先在NAS上启动SSH</p>
<p>登陆NAS，打开<code>控制面板-终端机和SNMP</code>，在<code>启动SSH功能</code>前打上勾</p>
<p>打开命令行，输入</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> NAS管理员账号@NAS的IP地址 ssh端口号默认是22<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>看到提示符，输入账号的密码，输入时不可见，输入完成按回车，看到命令行提示符变了，登陆成功。</p>
<h2 id="进入容器">进入容器</h2>
<p>在命令行中输入</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> <span class="token function">ps</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>可能提示输入密码，就输入NAS管理员的密码即可，显示列表，查看到如下列表，找到其中运行了为知笔记的一行</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909114805.png" alt=""></p>
<p>复制为知笔记的<code>CONTAINER ID</code>，然后再输入如下命令并回车：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it 粘贴刚复制好的ID号 /bin/bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>至此进入到容器中</p>
<h2 id="修改配置文件">修改配置文件</h2>
<p>输入如下命令打开配置文件进行编辑：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vi</span> /wiz/app/wizserver/config/default.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>vi命令的具体使用方法请自行百度，保存好后退出，重启容器生效。</p>
<p>进入docker，修改文件/wiz/wizserver/app/config/default.json</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"as"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token property">"admin"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"admin@wiz.cn"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
     <span class="token property">"share"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token property">"admin"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"admin@wiz.cn"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token property">"enableHttps"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
       <span class="token property">"enableSubDomain"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
       <span class="token property">"appShareUrl"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1:5001"</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中<code>127.0.0.1:5001</code>修改为自己的服务器访问地址，可以给docker做个端口映射（因为群晖NAS占用了5001端口），譬如映射8889端口到容器的5001端口，则设置为<code>xxx.xxx.xxx.xxx:8889</code>，分享后的链接即为该链接。</p>
<p>在NAS上可以用反向代理来解决二级域名的问题。</p>
<p>分享功能需要用户绑定手机，并完成认证，在docker中登陆数据库，并修改数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql <span class="token operator">-</span>u root <span class="token operator">-</span>p<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>输入密码，密码在docker中<code>/wiz/wizserver/app/config/default.json</code>中查看</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"mysql"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"as"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>
   <span class="token property">"user"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
   <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"******************"</span><span class="token punctuation">,</span>
   <span class="token property">"database"</span><span class="token operator">:</span> <span class="token string">"wizasent"</span><span class="token punctuation">,</span>
   <span class="token property">"connectionLimit"</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
   <span class="token property">"connectTimeout"</span><span class="token operator">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>
   <span class="token property">"aquireTimeout"</span><span class="token operator">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>
   <span class="token property">"waitForConnections"</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中<code>password</code>就是密码，进入mysql控制台后，执行以下命令：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">use</span> wizasent<span class="token punctuation">;</span>
<span class="token keyword">update</span> wiz_user <span class="token keyword">set</span> MOBILE<span class="token operator">=</span><span class="token string">'你的手机号'</span><span class="token punctuation">,</span> MOBILE_VERIFY<span class="token operator">=</span><span class="token string">'1'</span> <span class="token keyword">where</span> ID<span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>web端登陆为知笔记，并修改默认账号后，修改后的账号无法登陆管理后台，需要做以下配置，修改文件<code>/wiz/wizserver/app/config/default.json</code>，找到以下代码：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"as"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"admin"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"admin@wiz.cn"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"share"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"admin"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"admin@wiz.cn"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"enableHttps"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"enableSubDomain"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"appShareUrl"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1:5001"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中<code>admin@wiz.cn</code>修改为修改后的账号。</p>
<p>登陆NAS，打开<code>控制面板-应用程序门户-反向代理</code></p>
<p>点击新增，然后输入如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909114813.png" alt=""></p>
<p>实际测试来源协议选择https时只有网页端可以登陆，客户端无法登陆，暂时还是选择http为好，也可以网页端通过https登陆，客户端通过http登陆，配置两个不同的端口（记得要在路由上配置端口映射）。</p>
<p>修改<code>default.json</code></p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"debug"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"enableHttps"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"storage"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token property">"__comments"</span><span class="token operator">:</span> <span class="token string">"oss|local|s3|cos"</span><span class="token punctuation">,</span>
     <span class="token property">"use"</span><span class="token operator">:</span> <span class="token string">"local"</span><span class="token punctuation">,</span>
     <span class="token property">"oss"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token property">"bucket"</span><span class="token operator">:</span> <span class="token string">"data_root"</span><span class="token punctuation">,</span>
       <span class="token property">"region"</span><span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
       <span class="token property">"accessKeyId"</span><span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
       <span class="token property">"accessKeySecret"</span><span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
       <span class="token property">"internal"</span><span class="token operator">:</span> <span class="token boolean">false</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中<code>enableHttps</code>配置成<code>true</code></p>
<p>重启服务</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /wiz/app/wizserver
pm2 restart all<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>删除<code>/wiz/storage/index/.search</code>文件和<code>/wiz/storage/index/nodes</code>目录</p>
<p>重启容器</p>
<p>链接数据库，执行下列SQL</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">update</span> wizksent<span class="token punctuation">.</span>wiz_kb_stat <span class="token keyword">set</span> index_new_status<span class="token operator">=</span><span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>进入容器，执行</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /wiz/app/wizserver
pm2 start app.js --name<span class="token operator">=</span><span class="token string">"index2"</span>  -f -- -c <span class="token number">1</span> -i <span class="token number">1</span> -t <span class="token number">2</span> -s index
pm2 start app.js --name<span class="token operator">=</span><span class="token string">"index2"</span>  -f --  -s copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>查看日志</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pm2 logs index2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>下载官方插件，并安装到Chrome中</p>
<p>http://www.wiz.cn/downloads-webclipperchrome.html</p>
<p>在浏览器中输入<code>chrome://extensions/</code>打开插件列表，开启开发者模式</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909114820.png" alt=""></p>
<p>看ID号，在浏览器中输入<code>chrome://inspect/#extensions</code>在打开的列表中找到<code>WizClipper</code>，点击<code>inspect</code>，开启调试窗口。</p>
<p>选择<code>Sources</code>标签，并打开文件<code>Scripts\wiz\WizConstant.js</code></p>
<p>在代码中查看<code>note.wiz.cn</code>和<code>api.wiz.cn</code>的网址全部替换成自己私有云的地址，实测，登陆没问题，保存失败。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909114826.jpeg" alt=""></p>
<h2 id="管理功能">管理功能</h2>
<ol>
<li>
<p>增加重建索引功能，以备不时之需</p>
</li>
<li>
<p>增加备份与恢复功能</p>
</li>
<li>
<p>增加markdown语法扩展：</p>
<p>flow（流程图）、sequence（时序图）、mermaid（流程图、时序图、甘特图）、LaTeX（公式）</p>
</li>
<li>
<p>增加手动配置分享链接</p>
</li>
<li>
<p>支持社交绑定的配置</p>
</li>
<li>
<p>支持对象存储或webdav存储</p>
</li>
</ol>
<h2 id="Web-Mac客户端">Web&amp;Mac客户端</h2>
<ol>
<li>
<p>增加自定义模板</p>
</li>
<li>
<p>增加偏好设置，自定义快捷键（主要是编辑和预览切换的快捷键非常不适应）</p>
</li>
<li>
<p>增加同步预览模式，可以参考下Typora，Bear都不错</p>
</li>
<li>
<p>增加https访问方式</p>
</li>
<li>
<p>支持导出jpg、png、docx格式</p>
</li>
</ol>
<h2 id="浏览器插件">浏览器插件</h2>
<ol>
<li>增加支持私有云登陆</li>
</ol>
<p>【部署环境】<br>
群晖DS1517+（DSM6.2.2）<br>
容器分配内存4G，CPU*2核</p>
<p>【出现的问题】</p>
<ol>
<li>
<p>网页版上提示，自动保存失败，网络错误，请尽快保存（最后发现是时区不通道导致的，第8点解决了此问题）</p>
</li>
<li>
<p>所有社交平台账号无法绑定</p>
</li>
<li>
<p>mywiz邮箱不可修改</p>
</li>
<li>
<p>绑定手机无法收到验证码，即无法绑定手机（通过修改数据库搞定）</p>
</li>
<li>
<p>存储设置功能多余（因为已经本地化部署了），改成数据备份/恢复就好了</p>
</li>
<li>
<p>支付信息是支付到为知去的，这个功能容易产生误解（如果多人使用的话）</p>
</li>
<li>
<p>docker容器的时区与宿主机时区不同，添加环境变量解决，TZ=Asia/Shanghai</p>
</li>
</ol>
<p>编辑整理 From： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/JQBUqdq1YNsGqolQ0jjfNg">大大木头 [为知社区]</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>note</tag>
        <tag>wiz</tag>
        <tag>Docker</tag>
        <tag>linux</tag>
        <tag>Nas</tag>
        <tag>群晖</tag>
      </tags>
  </entry>
  <entry>
    <title>Joplin 入门指南&amp;实践方案</title>
    <url>/posts/e6086437/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Evernote笔记是我们常用的一个笔记服务，国内叫印象笔记，免费版本的Evernote笔记其实已经足够我们使用了，但是对于重度的笔记用户，Evernote某些功能可能需要付费升级才可以使用，而且你的笔记是存放在Evernote的服务器上。</p>
<p>有些同学可能觉得放在Evernote服务器上的笔记会不安全，况且有些隐私性很强的笔记确实不适合放在公共的服务器上。此时，你需要一个可以保护个人隐私同时还可以与Evernote笔记功能相媲美的免费笔记服务：Joplin，它是一款免费开源的笔记软件。</p>
<p>Joplin跨平台支持，包括PC桌面端，移动端，甚至提供了命令行版本，原生支持 markdown 格式，搜索速度快，可以通过其他第三方同步工具 (Dropbox/NextCloud/OneDrive/WebDAV/etc) 进行备份以及同步 ，支持浏览器Web clipper即网页剪贴。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135705.png" alt=""></p>
<p>Evernote笔记该有的功能Joplin都有了，如果你不想掏钱购买Evernote付费版本，Joplin将是最佳的替代品。更多的自建服务还有：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://wzfou.com/chevereto/">Chevereto免费相册程序安装与使用-免费自建图床和公共图片相册</a></li>
<li><a target="_blank" rel="noopener" href="https://wzfou.com/tt-rss/">自建RSS阅读器Tiny Tiny RSS安装和配置自动更新,全文RSS,更换主题,手机RSS登录</a></li>
<li><a target="_blank" rel="noopener" href="https://wzfou.com/bitwarden-rs/">放弃付费1Password改用免费开源的bitwarden_rs自建密码管理系统-安装,使用和备份</a></li>
</ol>
<p><strong>PS：更新记录</strong></p>
<blockquote>
<p>1、平时经常要校对文本，以及有大量的文件需要在电脑和移动硬盘同步，可以试试这些免费的同步对比工具：<a target="_blank" rel="noopener" href="https://wzfou.com/files-sync-softs/">八大免费的文件对比同步工具-免费文件对比分析与复制同步备份软件</a>。2021.3.24</p>
<p>2、对于1Password这类的密码管理软件重度依赖，但是苦于囊中羞涩的话，不防自建密码管理平台：<a target="_blank" rel="noopener" href="https://wzfou.com/bitwarden-mima/">Bitwarden自建密码存储系统图文教程-开源免费的bitwarden_rs安装与使用</a>。2020.10.10</p>
</blockquote>
<h2 id="一、Joplin安装和使用">一、Joplin安装和使用</h2>
<p>网站：</p>
<ol>
<li>https://joplinapp.org/</li>
</ol>
<p>直接到官网下载Joplin安装包，安装好了就可以启动Joplin了，以下是Joplin的软件界面，分成三栏，和我们平时熟悉的笔记软件是一样的。（点击放大）</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135716.png" alt=""></p>
<p>这是Joplin的编辑器，支持 MarkDown，图片、数学公式、复选框等 MarkDown 语法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135813.png" alt=""></p>
<p>不习惯MarkDown，直接切换为可视编辑即可。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135820.png" alt=""></p>
<p>在Joplin的设置选项中还提供了非常多的MarkDown的插件，对于MarkDown深度用户来是一个福音。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135723.png" alt=""></p>
<h2 id="二、Joplin的特色功能">二、Joplin的特色功能</h2>
<h3 id="2-1-笔记历史版本">2.1 笔记历史版本</h3>
<p>Joplin提供了笔记历史版本，让你轻松地恢复任意时间的笔记版本。在“工具” &gt; “选项” &gt; “笔记历史”中启用，以及设置保留的笔记历史天数。要查看笔记的历史版本，点击编辑器上方的笔记属性图标，然后选择恢复：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135828.png" alt=""></p>
<h3 id="2-2-E2EE安全加密">2.2 E2EE安全加密</h3>
<p>在同步过程中，笔记本、笔记、标签等均以纯文本文件的方式同步，如果你还觉得不安全，你可以开启端到端加密（E2EE），把文件加密后同步到云端。由于 Joplin 的去中心化，密码必须手动在每个终端设置。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135736.png" alt=""></p>
<p>**注意：不要在多个设备上同时启用加密，否则可能会造成加密密钥问题。特别提醒：**<strong>加密之前，先将笔记导出JEX备份一份，以防万一。</strong></p>
<h3 id="2-3-Joplin手机APP">2.3 Joplin手机APP</h3>
<p>Joplin可以直接在各大应用市场上下载，使用起来也很方便。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135835.png" alt=""></p>
<h3 id="2-4-外部编辑器">2.4 外部编辑器</h3>
<p>Joplin自带的编辑已经非常强大的，如果你想要使用自己的编辑器来编辑笔记也是可以的，包括 文本编辑器（如 Notepad++）、 Markdown 编辑器（如 Typora）等。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135928.png" alt=""></p>
<p>通过 Ctrl+E，或 Joplin 编辑器上方的图标（如下图）从外部编辑器打开笔记，从外部编辑器打开后，Joplin 将持续监控该文件，当你从外部编辑机保存后，Joplin 将自动同步最新变动。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135841.png" alt=""></p>
<p>你可以在“工具” &gt; “选项” &gt; “通用选项”中指定编辑器的路径。</p>
<h2 id="三、Joplin同步与备份">三、Joplin同步与备份</h2>
<p>Joplin与其它的笔记软件很大的不同就是没有存储功能，你需要将Joplin的笔记放在自己的主机或者网盘里，幸运的是Joplin支持多种方式的云同步：Nextcloud / Dropbox / OneDrive / File system / WebDAV。</p>
<h3 id="3-1-Joplin免费网盘同步">3.1 Joplin免费网盘同步</h3>
<p>目前，Joplin支持Dropbox 、OneDrive 网盘同步，在同步选项中选择OneDrive，然后就会打开认证。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135739.png" alt=""></p>
<p>同意验证。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135848.png" alt=""></p>
<p>与 OneDrive 同步时，Joplin 会在 OneDrive 中创建一个子目录：<code>/Apps/Joplin</code>，Joplin 仅有此目录的读写权限。如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135746.png" alt=""></p>
<h3 id="3-2-Joplin使用WebDAV同步">3.2 Joplin使用WebDAV同步</h3>
<p>WebDAV 可以自建，或使用支持 WebDAV 的云盘，另外 NAS（如群晖）通常也支持 WebDAV。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135855.png" alt=""></p>
<p>**Nextcloud：**Nextcloud是一个开源的免费的自建个人云存储方案，要启用 Nextcloud 同步，你需要在 Nextcloud 中创建一个目录（比如：Joplin），在左下角的“设置”中获取 WebDAV 的 URL，在 Joplin 同步设置中，填入 WebDAV URL、用户名和密码。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135902.png" alt=""></p>
<p>有关于Nextcloud安装与使用教程，请参考：<a target="_blank" rel="noopener" href="https://wzfou.com/nextcloud-lixian/">Oneinstack安装NextCloud以及使用Aria2离线下载和ocDownloader插件配置</a>。</p>
<p>**坚果云：**首次同步时会因为 WebDAV 短时间内的大量请求被坚果云临时限制，坚果云提示为“Too many requests”，这个封锁会持续大约6小时。同步之前，在 Joplin 的“工具” &gt; “选项” &gt; “同步” &gt; “高级选项”中，将“最大并发连接数”改为1可以有效避免。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135753.png" alt=""></p>
<p>关于坚果云的使用方法，请参考：<a target="_blank" rel="noopener" href="https://wzfou.com/upyun-jianguoyun/">巧用又拍云FTP和坚果云WebDAV-打造个人文件备份和数据云存储</a>。</p>
<h2 id="四、Joplin导入与导出">四、Joplin导入与导出</h2>
<p>Joplin可以很方便地支持从Evernote（印象笔记）导入，方法如下：</p>
<p>从 Evernote（印象笔记）导入：</p>
<blockquote>
<p>打开 Evernote，右击要导出的笔记本，选择“导出笔记“，导出 .enex 格式文件。</p>
<p>在 Joplin 中，选择“文件” &gt; “导入” &gt; “ENEX – Evernote导出文件（Markdown）”即可导入。</p>
</blockquote>
<p>从 Markdown 文件导入：</p>
<blockquote>
<p>使用 Joplin 可以轻松导入 Markdown 文件或整个目录，选择“文件” &gt; “导入” &gt; “MD – Markdown（文件/目录）”导入即可。</p>
</blockquote>
<p>从其他应用程序导入：</p>
<blockquote>
<p>通常，很多应用程序都支持导入到 Evernote 中，所以从其他应用程序导入的思路是先导入 Evernote，再导出 .enex 文件，最后导入 Joplin 中。</p>
</blockquote>
<p>如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135909.png" alt=""></p>
<p>如果哪天你不想使用Joplin了，也可以很方便地导出。Joplin 支持多种导出格式，导出格式均为标准格式，可以在不依赖 Joplin 的情况下查看、编辑，部分格式支持无损/有损重新导入：</p>
<blockquote>
<p>JEX：Joplin 的无损导出格式，包含所有的元数据如标签、更新时间等。JEX是实际上是一个tar文件，可以直接解压出 MarkDown 文件。这种格式常用于备份，<strong>可以无损重新导入</strong>。</p>
<p>RAW：同 JEX 格式相似，只是数据会保存为目录，并且每个笔记都会导出为一个单独的文件。<strong>可以无损重新导入</strong>。</p>
<p>JSON：导出为 JSON 格式的文件。不支持重新导入。</p>
<p>MD：按照笔记本的分级结构导出为目录，每条笔记在对应的目录中导出为 Markdown 格式的文件，目录名和文件名与原笔记本对应，此种格式易于读取，但是导出的文件将丢失元数据。可以有损导入（丢失元数据）。</p>
<p>HTML：导出为网页文件，将 Markdown 格式转为 html 标签，带有样式。不支持导入。</p>
<p>PDF：将单个笔记导出为 PDF 格式的文件。不支持导入。</p>
</blockquote>
<p>如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135801.png" alt=""></p>
<h2 id="五、总结">五、总结</h2>
<p>免费开源的笔记Joplin无论在功能上还是使用体验上基本上与Evernote印象笔记无异了，在隐私保护方面做得非常好，特别适合那些想要保存个人信息笔记的用户。</p>
<p>使用免费开源的笔记Joplin最大的问题就是找好同步的网盘或者云存储，另外强烈建议大家在对Joplin的设置进行调整时先备份一个，以免同步后删除了所有的笔记。</p>
<p>编辑整理 From：<a target="_blank" rel="noopener" href="https://wzfou.com/joplin/">挖站否</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>note</tag>
        <tag>Joplin</tag>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>替代Evernote免费开源笔记Joplin-网盘同步笔记历史版本Markdown可视化</title>
    <url>/posts/45f878cd/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Evernote笔记是我们常用的一个笔记服务，国内叫印象笔记，免费版本的Evernote笔记其实已经足够我们使用了，但是对于重度的笔记用户，Evernote某些功能可能需要付费升级才可以使用，而且你的笔记是存放在Evernote的服务器上。</p>
<p>有些同学可能觉得放在Evernote服务器上的笔记会不安全，况且有些隐私性很强的笔记确实不适合放在公共的服务器上。此时，你需要一个可以保护个人隐私同时还可以与Evernote笔记功能相媲美的免费笔记服务：Joplin，它是一款免费开源的笔记软件。</p>
<p>Joplin跨平台支持，包括PC桌面端，移动端，甚至提供了命令行版本，原生支持 markdown 格式，搜索速度快，可以通过其他第三方同步工具 (Dropbox/NextCloud/OneDrive/WebDAV/etc) 进行备份以及同步 ，支持浏览器Web clipper即网页剪贴。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135705.png" alt=""></p>
<p>Evernote笔记该有的功能Joplin都有了，如果你不想掏钱购买Evernote付费版本，Joplin将是最佳的替代品。更多的自建服务还有：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://wzfou.com/chevereto/">Chevereto免费相册程序安装与使用-免费自建图床和公共图片相册</a></li>
<li><a target="_blank" rel="noopener" href="https://wzfou.com/tt-rss/">自建RSS阅读器Tiny Tiny RSS安装和配置自动更新,全文RSS,更换主题,手机RSS登录</a></li>
<li><a target="_blank" rel="noopener" href="https://wzfou.com/bitwarden-rs/">放弃付费1Password改用免费开源的bitwarden_rs自建密码管理系统-安装,使用和备份</a></li>
</ol>
<p><strong>PS：更新记录</strong></p>
<blockquote>
<p>1、平时经常要校对文本，以及有大量的文件需要在电脑和移动硬盘同步，可以试试这些免费的同步对比工具：<a target="_blank" rel="noopener" href="https://wzfou.com/files-sync-softs/">八大免费的文件对比同步工具-免费文件对比分析与复制同步备份软件</a>。2021.3.24</p>
<p>2、对于1Password这类的密码管理软件重度依赖，但是苦于囊中羞涩的话，不防自建密码管理平台：<a target="_blank" rel="noopener" href="https://wzfou.com/bitwarden-mima/">Bitwarden自建密码存储系统图文教程-开源免费的bitwarden_rs安装与使用</a>。2020.10.10</p>
</blockquote>
<h2 id="一、Joplin安装和使用-2">一、Joplin安装和使用</h2>
<p>网站：</p>
<ol>
<li>https://joplinapp.org/</li>
</ol>
<p>直接到官网下载Joplin安装包，安装好了就可以启动Joplin了，以下是Joplin的软件界面，分成三栏，和我们平时熟悉的笔记软件是一样的。（点击放大）</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135716.png" alt=""></p>
<p>这是Joplin的编辑器，支持 MarkDown，图片、数学公式、复选框等 MarkDown 语法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135813.png" alt=""></p>
<p>不习惯MarkDown，直接切换为可视编辑即可。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135820.png" alt=""></p>
<p>在Joplin的设置选项中还提供了非常多的MarkDown的插件，对于MarkDown深度用户来是一个福音。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135723.png" alt=""></p>
<h2 id="二、Joplin的特色功能-2">二、Joplin的特色功能</h2>
<h3 id="2-1-笔记历史版本-2">2.1 笔记历史版本</h3>
<p>Joplin提供了笔记历史版本，让你轻松地恢复任意时间的笔记版本。在“工具” &gt; “选项” &gt; “笔记历史”中启用，以及设置保留的笔记历史天数。要查看笔记的历史版本，点击编辑器上方的笔记属性图标，然后选择恢复：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135828.png" alt=""></p>
<h3 id="2-2-E2EE安全加密-2">2.2 E2EE安全加密</h3>
<p>在同步过程中，笔记本、笔记、标签等均以纯文本文件的方式同步，如果你还觉得不安全，你可以开启端到端加密（E2EE），把文件加密后同步到云端。由于 Joplin 的去中心化，密码必须手动在每个终端设置。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135736.png" alt=""></p>
<p>**注意：不要在多个设备上同时启用加密，否则可能会造成加密密钥问题。特别提醒：**<strong>加密之前，先将笔记导出JEX备份一份，以防万一。</strong></p>
<h3 id="2-3-Joplin手机APP-2">2.3 Joplin手机APP</h3>
<p>Joplin可以直接在各大应用市场上下载，使用起来也很方便。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135835.png" alt=""></p>
<h3 id="2-4-外部编辑器-2">2.4 外部编辑器</h3>
<p>Joplin自带的编辑已经非常强大的，如果你想要使用自己的编辑器来编辑笔记也是可以的，包括 文本编辑器（如 Notepad++）、 Markdown 编辑器（如 Typora）等。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135928.png" alt=""></p>
<p>通过 Ctrl+E，或 Joplin 编辑器上方的图标（如下图）从外部编辑器打开笔记，从外部编辑器打开后，Joplin 将持续监控该文件，当你从外部编辑机保存后，Joplin 将自动同步最新变动。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135841.png" alt=""></p>
<p>你可以在“工具” &gt; “选项” &gt; “通用选项”中指定编辑器的路径。</p>
<h2 id="三、Joplin同步与备份-2">三、Joplin同步与备份</h2>
<p>Joplin与其它的笔记软件很大的不同就是没有存储功能，你需要将Joplin的笔记放在自己的主机或者网盘里，幸运的是Joplin支持多种方式的云同步：Nextcloud / Dropbox / OneDrive / File system / WebDAV。</p>
<h3 id="3-1-Joplin免费网盘同步-2">3.1 Joplin免费网盘同步</h3>
<p>目前，Joplin支持Dropbox 、OneDrive 网盘同步，在同步选项中选择OneDrive，然后就会打开认证。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135739.png" alt=""></p>
<p>同意验证。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135848.png" alt=""></p>
<p>与 OneDrive 同步时，Joplin 会在 OneDrive 中创建一个子目录：<code>/Apps/Joplin</code>，Joplin 仅有此目录的读写权限。如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135746.png" alt=""></p>
<h3 id="3-2-Joplin使用WebDAV同步-2">3.2 Joplin使用WebDAV同步</h3>
<p>WebDAV 可以自建，或使用支持 WebDAV 的云盘，另外 NAS（如群晖）通常也支持 WebDAV。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135855.png" alt=""></p>
<p>**Nextcloud：**Nextcloud是一个开源的免费的自建个人云存储方案，要启用 Nextcloud 同步，你需要在 Nextcloud 中创建一个目录（比如：Joplin），在左下角的“设置”中获取 WebDAV 的 URL，在 Joplin 同步设置中，填入 WebDAV URL、用户名和密码。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135902.png" alt=""></p>
<p>有关于Nextcloud安装与使用教程，请参考：<a target="_blank" rel="noopener" href="https://wzfou.com/nextcloud-lixian/">Oneinstack安装NextCloud以及使用Aria2离线下载和ocDownloader插件配置</a>。</p>
<p>**坚果云：**首次同步时会因为 WebDAV 短时间内的大量请求被坚果云临时限制，坚果云提示为“Too many requests”，这个封锁会持续大约6小时。同步之前，在 Joplin 的“工具” &gt; “选项” &gt; “同步” &gt; “高级选项”中，将“最大并发连接数”改为1可以有效避免。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135753.png" alt=""></p>
<p>关于坚果云的使用方法，请参考：<a target="_blank" rel="noopener" href="https://wzfou.com/upyun-jianguoyun/">巧用又拍云FTP和坚果云WebDAV-打造个人文件备份和数据云存储</a>。</p>
<h2 id="四、Joplin导入与导出-2">四、Joplin导入与导出</h2>
<p>Joplin可以很方便地支持从Evernote（印象笔记）导入，方法如下：</p>
<p>从 Evernote（印象笔记）导入：</p>
<blockquote>
<p>打开 Evernote，右击要导出的笔记本，选择“导出笔记“，导出 .enex 格式文件。</p>
<p>在 Joplin 中，选择“文件” &gt; “导入” &gt; “ENEX – Evernote导出文件（Markdown）”即可导入。</p>
</blockquote>
<p>从 Markdown 文件导入：</p>
<blockquote>
<p>使用 Joplin 可以轻松导入 Markdown 文件或整个目录，选择“文件” &gt; “导入” &gt; “MD – Markdown（文件/目录）”导入即可。</p>
</blockquote>
<p>从其他应用程序导入：</p>
<blockquote>
<p>通常，很多应用程序都支持导入到 Evernote 中，所以从其他应用程序导入的思路是先导入 Evernote，再导出 .enex 文件，最后导入 Joplin 中。</p>
</blockquote>
<p>如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135909.png" alt=""></p>
<p>如果哪天你不想使用Joplin了，也可以很方便地导出。Joplin 支持多种导出格式，导出格式均为标准格式，可以在不依赖 Joplin 的情况下查看、编辑，部分格式支持无损/有损重新导入：</p>
<blockquote>
<p>JEX：Joplin 的无损导出格式，包含所有的元数据如标签、更新时间等。JEX是实际上是一个tar文件，可以直接解压出 MarkDown 文件。这种格式常用于备份，<strong>可以无损重新导入</strong>。</p>
<p>RAW：同 JEX 格式相似，只是数据会保存为目录，并且每个笔记都会导出为一个单独的文件。<strong>可以无损重新导入</strong>。</p>
<p>JSON：导出为 JSON 格式的文件。不支持重新导入。</p>
<p>MD：按照笔记本的分级结构导出为目录，每条笔记在对应的目录中导出为 Markdown 格式的文件，目录名和文件名与原笔记本对应，此种格式易于读取，但是导出的文件将丢失元数据。可以有损导入（丢失元数据）。</p>
<p>HTML：导出为网页文件，将 Markdown 格式转为 html 标签，带有样式。不支持导入。</p>
<p>PDF：将单个笔记导出为 PDF 格式的文件。不支持导入。</p>
</blockquote>
<p>如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/0920210909135801.png" alt=""></p>
<h2 id="五、总结-2">五、总结</h2>
<p>免费开源的笔记Joplin无论在功能上还是使用体验上基本上与Evernote印象笔记无异了，在隐私保护方面做得非常好，特别适合那些想要保存个人信息笔记的用户。</p>
<p>使用免费开源的笔记Joplin最大的问题就是找好同步的网盘或者云存储，另外强烈建议大家在对Joplin的设置进行调整时先备份一个，以免同步后删除了所有的笔记。</p>
<p>编辑整理 From：<a target="_blank" rel="noopener" href="https://wzfou.com/joplin/">挖站否</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>note</tag>
        <tag>Joplin</tag>
        <tag>Docker</tag>
        <tag>Webdav</tag>
      </tags>
  </entry>
  <entry>
    <title>Joplin 插件使用推荐</title>
    <url>/posts/e3ee7f8b/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="Joplin插件推荐">Joplin插件推荐</h2>
<blockquote>
<p>Gif图片加载较慢，请耐心等待！</p>
</blockquote>
<h2 id="persistent-text-folding-in-editor"><a target="_blank" rel="noopener" href="https://github.com/ambrt/joplin-plugin-fold-cm/releases/">persistent-text-folding-in-editor</a></h2>
<p><img src="https://aws1.discourse-cdn.com/standard14/uploads/cozic/original/2X/3/371b2bfa2825255462241d6390400e0ed4dcf55b.gif" alt="persistent-text-folding-in-editor 演示"></p>
<ul>
<li>Ctrl(or Cmd) + Alt + F to fold all</li>
<li>Ctrl(or Cmd) + Alt + U to unfold all</li>
</ul>
<h2 id="Plugin-Conflict-Resolution"><a target="_blank" rel="noopener" href="https://discourse.joplinapp.org/t/plugin-conflict-resolution/19204">Plugin: Conflict Resolution</a></h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910084450.png" alt="plugin-conflict-resolution演示"></p>
<h2 id="Joplin-Kanban-Plugin"><a target="_blank" rel="noopener" href="https://github.com/joplin/plugin-kanban/wiki">Joplin Kanban Plugin</a></h2>
<p><img src="https://images.weserv.nl?url=https://github.com/joplin/plugin-kanban/wiki/images/kanban-screenshot.png" alt=""></p>
<p><strong>Usage</strong></p>
<p>To get started, you'll need a notebook which will contain all tasks that you want to see on the board. The plugin will only show tasks in a single notebook and it's sub-notebooks.</p>
<p>A kanban board is defined by a special type of note, which contains all of its configuration. Create a new note, and paste in the following:</p>
<pre class="line-numbers language-none"><code class="language-none">```kanban
columns:
  - name: Backlog
    backlog: true
  - name: Work in progress
    tag: wip
  - name: Finished
    tag: done
```<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>It is important that the confiuration is surrounded by a code block (<code>kanban ... </code>), otherwise it won't be detected.</p>
<h2 id="joplin-plugin-nlr"><a target="_blank" rel="noopener" href="https://github.com/fengqiaozhu/joplin_plugin_nlr">joplin_plugin_nlr</a></h2>
<ol>
<li>插件安装后会在工具菜单添加一项：<strong>NLR</strong></li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910101315.png" alt="1.png"></p>
<ol start="2">
<li>点击 <strong>NLR</strong> 打开新的panel，即可在输入框输入书名或作者名称搜索小说</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910101332.png" alt="2.png"></p>
<ol start="3">
<li>点击卡片右上方 <strong>INFO</strong> 打开新的小说目录，章节卡片右上checkbox选中即代表下载此chapter，选中后，点击上方<strong>DOWNLOAD</strong>开始下载，在笔记列表中即可看到小说文本了。</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910101414.png" alt="3.png"></p>
<h2 id="joplin-outline"><a target="_blank" rel="noopener" href="https://github.com/cqroot/joplin-outline">joplin-outline</a></h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910105707.png" alt=""></p>
<h2 id="joplin-persistent-layout"><a target="_blank" rel="noopener" href="https://github.com/benji300/joplin-persistent-layout">joplin-persistent-layout</a></h2>
<p>Save editor layout (editor/split view/viewer/rich text) for each note separately.</p>
<p>To persist the layout for a note follow these steps:</p>
<ol>
<li>
<p>Specify the tags for which a specific layout should be used.</p>
<ul>
<li>
<p>To do this, go to the plugin's settings/options page and add the tags to the settings.</p>
</li>
<li>
<p>An example configuration could like this:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/benji300/joplin-persistent-layout/blob/master/assets/tags-config.png"><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910105956.png" alt="layout-tags-config"></a></p>
</li>
</ul>
</li>
<li>
<p>Make sure that the correct value is selected in <code>View &gt; Layout button sequence</code>.</p>
<ul>
<li>To be able to use the layout switching correctly, this setting must be set accordingly. Otherwise the editor layout might not be switched to the expected one.</li>
<li>For example: If a tag is specified in option <code>Tags for editor layout mode: Rendered Markdown viewer</code> and least one note uses it, the setting must also contain <code>Viewer</code>.</li>
</ul>
</li>
<li>
<p>Add the appropriate tags to the notes. If not already done.</p>
<ul>
<li>When the selected note is changed, the editor layout is switched.</li>
<li>If none of the selected note's tags matches a specified layout tag, the default layout from the option <code>Default editor layout</code> is used.
<ul>
<li>If nothing is selected as default editor layout, the currently active editor layout will be kept.</li>
</ul>
</li>
<li>If more than one tag is specified for a note, the first matching one is used.</li>
</ul>
</li>
</ol>
<h2 id="Plugin-inline-tags"><a target="_blank" rel="noopener" href="https://github.com/roman-r-m/joplin-inline-tags-plugin">Plugin: inline tags</a></h2>
<p><img src="https://aws1.discourse-cdn.com/standard14/uploads/cozic/original/2X/0/0065618a26a81a8f01a1dc440bbbd1e216266e2f.gif" alt="ezgif.com-gif-maker"></p>
<h2 id="joplin-plugin-note-overview"><a target="_blank" rel="noopener" href="https://github.com/JackGruber/joplin-plugin-note-overview">joplin-plugin-note-overview</a></h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910111844.png" alt=""></p>
<p>Create one or more notes with the following content:</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;!-- note-overview-plugin
search: -tag:*
fields: updated_time, title
alias: updated_time AS Last edit, title AS Title
sort: title DESC
--&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Several of these blocks can be included in one note, also between text.</p>
<p>The note content is updated every x minutes (depending on your setting) or manualy by <code>Tools &gt; Create Note overview</code>.</p>
<h2 id="joplin-plugin-embed-search"><a target="_blank" rel="noopener" href="https://github.com/ambrt/joplin-plugin-embed-search">joplin-plugin-embed-search</a></h2>
<pre class="line-numbers language-none"><code class="language-none">```search
your search query
```<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="https://aws1.discourse-cdn.com/standard14/uploads/cozic/original/2X/9/9dfb27924c8fd373c5db8178e1cda27c74a4e50c.gif" alt="Peek 2021-01-26 19-22"></p>
<p><strong>Additional features</strong></p>
<ul>
<li>you can paste <code>sort:asc</code> or <code>sort:desc</code> to sort notes by title ascending or descending</li>
<li>A shorthand <code>notebook:this</code>, that narrows search to current notebook only.</li>
<li>Basic content embedding <code>content:true</code> (beta):</li>
</ul>
<p><img src="https://aws1.discourse-cdn.com/standard14/uploads/cozic/original/2X/0/06aa9cff292ac6a5f5f3c3a2acc35d13c0fb65c9.png" alt=""></p>
<h2 id="Spoilers">Spoilers</h2>
<ul>
<li>
<ul>
<li>
<p>可使用%%遮盖部分文字。</p>
</li>
<li>
<ul>
<li>
<p>格式：</p>
</li>
<li>
<ul>
<li><code>%%扰流板、遮挡板%%</code></li>
</ul>
</li>
<li>
<p>软件内呈现：</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910174557.png" alt="点击前">点击前</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910174618.png" alt="点击后">点击后</p>
<ul>
<li>
<ul>
<li>以及一个类似闪卡的可折叠块</li>
<li>格式：</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">:[

测试，标题

测试，内容

]:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<ul>
<li>软件内呈现：</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910174638.png" alt="点击前">点击前</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910180108.png" alt="点击后">点击后</p>
<h2 id="Notes-statistics">Notes statistics</h2>
<ul>
<li>
<ul>
<li>笔记内部的数据统计。</li>
</ul>
</li>
</ul>
<h2 id="Note-tabs"><a target="_blank" rel="noopener" href="https://github.com/benji300/joplin-note-tabs">Note tabs</a></h2>
<ul>
<li>
<ul>
<li>像浏览器一样浏览文档，支持多个打开放置。</li>
</ul>
</li>
<li>
<p><img src="https://images.weserv.nl?url=https://raw.githubusercontent.com/benji300/joplin-note-tabs/master/assets/screencast.gif" alt=""></p>
</li>
</ul>
<h2 id="Quick-links">Quick links</h2>
<ul>
<li>
<ul>
<li>使用<code>@@</code>快速链接笔记文件。</li>
</ul>
</li>
<li>
<p><img src="https://aws1.discourse-cdn.com/standard14/uploads/cozic/original/2X/9/98abc7c6beb7551c1a8d375d358707143305ef58.gif" alt=""></p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/marc0l92/joplin-plugin-jira-issue">Jira Issue</a></p>
<p><img src="https://images.weserv.nl?url=https://raw.githubusercontent.com/marc0l92/joplin-plugin-jira-issue/main/doc/usage_example.gif" alt=""></p>
<h2 id="Homenotes">Homenotes</h2>
<ul>
<li>选择一个笔记作为每次打开软件时的首个笔记，可以把这个功能当作书签用。</li>
</ul>
<h2 id="Admonition"><a target="_blank" rel="noopener" href="https://github.com/maxnegro/joplin-plugin-admonition">Admonition</a></h2>
<pre class="line-numbers language-none"><code class="language-none">!!! note This is the admonition title
This is the admonition body
!!!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910185118.png" alt=""></p>
<p>The following admonition types, supported by Docarys, are recognized by this plugin:</p>
<table>
<thead>
<tr>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>note</td>
</tr>
<tr>
<td>abstract</td>
</tr>
<tr>
<td>info</td>
</tr>
<tr>
<td>tip</td>
</tr>
<tr>
<td>success</td>
</tr>
<tr>
<td>question</td>
</tr>
<tr>
<td>warning</td>
</tr>
<tr>
<td>failure</td>
</tr>
<tr>
<td>danger</td>
</tr>
<tr>
<td>bug</td>
</tr>
<tr>
<td>example</td>
</tr>
<tr>
<td>quote</td>
</tr>
</tbody>
</table>
<h2 id="Encrypted-notes">Encrypted notes</h2>
<ul>
<li>字面意义，加密笔记，记住密码不得找回。</li>
</ul>
<h2 id="Favorites"><a target="_blank" rel="noopener" href="https://github.com/benji300/joplin-favorites">Favorites</a></h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910225438.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910225056.png" alt=""></p>
<ul>
<li>
<p>收藏夹，支持笔记、标签笔记本的收纳（随取随用）</p>
</li>
<li>
<ul>
<li>更改收藏夹中的笔记名不会更改原始笔记。</li>
</ul>
</li>
</ul>
<h2 id="Highlight">Highlight</h2>
<ul>
<li>打出<code>[h:colour:scope]</code>后，插件会自动识别成代码。</li>
</ul>
<table>
<thead>
<tr>
<th>颜色</th>
<th>范围（自动选择的）</th>
</tr>
</thead>
<tbody>
<tr>
<td>m = mark</td>
<td>e = empty</td>
</tr>
<tr>
<td>r = red</td>
<td>w = word</td>
</tr>
<tr>
<td>g = green</td>
<td>s = sentence</td>
</tr>
<tr>
<td>b = blue</td>
<td>l = line</td>
</tr>
<tr>
<td>y = yellow</td>
<td></td>
</tr>
</tbody>
</table>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910225117.png" alt=""></p>
<p>其他插件：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/joplin/plugins/blob/master/README.md#plugins">官方插件下载地址及其介绍</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>note</tag>
        <tag>Joplin</tag>
        <tag>MarkDown</tag>
      </tags>
  </entry>
  <entry>
    <title>浏览器的渲染过程</title>
    <url>/posts/69a052c9/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>通常，我们只需要编写HTML，CSS，JavaScript，浏览器上就能呈现出漂亮的网页了，但是浏览器是如何使用我们的代码在屏幕上渲染像素的呢？</p>
</blockquote>
<h3 id="首先，请先看一张大图"><strong>首先，请先看一张大图</strong></h3>
<p>浏览器将HTML，CSS，JavaScript代码转换成屏幕上所能呈现的实际像素，这期间所经历的一系列步骤，叫做关键渲染路径（Critical Rendering Path）。其中包含：</p>
<ul>
<li>构建对象模型（DOM，CSSOM）</li>
<li>构建渲染树（RenderTree）</li>
<li>布局</li>
<li>渲染</li>
</ul>
<p>在构建对象模型到构建渲染树的这一过程，还穿插着JS脚本的加载和执行。如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913220512.jpeg" alt=""></p>
<h3 id="1-DOMTree的构建"><strong>1.DOMTree的构建</strong></h3>
<p>浏览器的渲染从解析HTML文档开始，宏观上，可以分为下面几个步骤：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913220515.jpeg" alt=""></p>
<ul>
<li>第一步（解析）：从网络或者磁盘下读取的HTML原始字节码，通过设置的charset编码，转换成相字符</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913220653.jpeg" alt=""></p>
<ul>
<li>第二步（token化）：通过词法分析器，将字符串解析成Token，Token中会标注出当前的Token是<code>开始标签</code>，还是<code>结束标签</code>，或者<code>文本标签</code>等。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913220522.jpeg" alt=""></p>
<ul>
<li>第三步（生成Nodes并构建DOM树）：浏览器会根据Tokens里记录的<code>开始标签</code>，<code>结束标签</code>，将Tokens之间相互串联起来_（带有结束标签的Token不会生成Node）_。<br>
Node包含了这个节点的所有属性。例如<code>&lt;img src="xxx.png" &gt;</code>标签最终生成出的节点对象中会保存图片地址等信息。<br>
事实上，在构建DOM树时，不是要等所有的Tokens都转换成Nodes后才开始，而是一边生成Token一边采取<code>深度遍历算法</code>消耗Token来生成Node，如下图所示：<br>
图中有颜色的小数字代表构建的具体步骤，可以看出，首先生成出<code>html Token</code>,并消耗Token创建出<code>html 节点对象</code>，接着生成<code>head Token</code>并消耗Token创建出<code>head节点对象</code>......，当所有的Tokens都消耗完了，紧接着DOM树也就构建完了。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913220658.jpeg" alt=""></p>
<p>这里抛出个小问题，为什么有时在js中访问DOM时浏览器会报错呢？<br>
因为在上述的解析的过程中，如果碰到了<code>script</code>或者<code>link</code>标签，就会根据<code>src</code>对应的地址去加载资源，在<code>script</code>标签没有设置<code>async/defer</code>属性时，这个加载过程是<code>下载并执行完全部的代码</code>，此时，DOM树还没有完全创建完毕，这个时候如果js企图访问script标签后面的DOM元素，浏览器就会抛出<strong>找不到该DOM元素</strong>的错误。<br>
值得注意的是：从bytes到Tokens的这个过程，浏览器都可以交给其他单独的线程去处理，不会堵塞浏览器的渲染线程。但是后面的部分就都在渲染线程下进行了，也就是我们常说的js单线程环境。</p>
<h3 id="2-CSSOMTree的构建"><strong>2.CSSOMTree的构建</strong></h3>
<p>DOM会记录页面的内容，但是浏览器还需要知道这些内容该用什么样式去展示，所以还需要构建CSSOMTree。CSSOM的生成过程和DOM的生成过程十分相似，也是：1.解析，2.Token化，3.生成Nodes并构建CSSOMTree：</p>
<p>假设浏览器收到了下面这样一段css:</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">{</span><span class="token property">font-size</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token selector">p</span> <span class="token punctuation">{</span><span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token selector">p span</span> <span class="token punctuation">{</span><span class="token property">display</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token selector">span</span> <span class="token punctuation">{</span><span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token selector">img</span> <span class="token punctuation">{</span><span class="token property">float</span><span class="token punctuation">:</span> right<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最终会生成如下的CSSOMTree:</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913220529.jpeg" alt=""></p>
<p>从图中可以看出，最开始<code>body</code>有一个样式规则是<code>font-size:16px</code>，之后，在body这个样式基础上每个子节点还会添加自己单独的样式规则，比如<code>span</code>又添加了一个样式规则<code>color:red</code>。正是因为样式这种类似于继承的特性，浏览器设定了一条规则：<strong>CSSOMTree需要等到完全构建后才可以被使用，因为后面的属性可能会覆盖掉前面的设置</strong>。比如在上面的css代码基础上再添加一行代码<code>p {font-size:12px}</code>，那么之前设置的<code>16px</code>将会被覆盖成<code>12px</code>。</p>
<p>下面是官方给的一种解释：</p>
<blockquote>
<p>未构建完的CSSOMTree是不准确的，浏览器必须等到CSSOMTree构建完毕后才能进入下一阶段。<br>
所以，CSS的加载速度与构建CSSOMTree的速度将直接影响首屏渲染速度，因此在默认情况下CSS被视为阻塞渲染的资源，需要将它尽早、尽快地下载到客户端，以便缩短首次渲染的时间。</p>
</blockquote>
<p>那么回到上面生成DOM时提到的JS问题：<strong>在标签没有设置<code>async/defer</code>属性时，js会阻塞DOM的生成</strong>。原因是js会改变DOMTree的内容，如果不阻塞，会出现一边生成DOM内容，一边修改DOM内容的情况，无法确保最终生成的DOMTree是确定唯一的。</p>
<p>同理，JS也会可以修改CSS样式，影响CSSOMTree最终的结果。而我们前面提到，不完整的CSSOMTree是不可以被使用的，如果JS试图在<strong>浏览器还未完成CSSOMTree的下载和构建</strong>时去操作CSS样式，浏览器会<strong>暂停脚本的运行和DOM的构建</strong>，直至浏览器完成了CSSOM的下载和构建。也就是说，<strong>JS脚本的出现会让CSSOM的构建阻塞DOM的构建</strong>。</p>
<blockquote>
<p>平时谈及页面性能优化，经常会强调css文件应该放在html文档中的前面引入，js文件应该放在后面引入，这么做的原因是什么呢？</p>
</blockquote>
<p>举个例子：本来，DOM构建和CSSOM构建是两个过程，井水不犯河水。假设DOM构建完成需要1s，CSSOM构建也需要1s，在DOM构建了0.2s时发现了一个<code>link</code>标签，此时完成这个操作需要的时间大概是1.2s，如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913220540.jpeg" alt=""></p>
<p>而此时我们在HTML文档的中间插中入了一段JS代码，在DOM构建中间的过程中发现了这个<code>script</code>标签，假设这段JS代码只需要执行0.0001s，那么完成这个操作需要的时间就会变成：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913220546.jpeg" alt=""></p>
<p>那如果我们把css放到前面，js放到最后引入时，构建时间会变成：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913220705.jpeg" alt=""></p>
<p>由此可见，虽然只是插入了小小的一段只运行0.0001s的js代码，不同的引入时机也会严重影响DOMTree的构建速度。</p>
<p>简而言之，如果在DOM，CSSOM和JavaScript执行之间引入大量的依赖关系，可能会导致浏览器在处理渲染资源时出现大幅度延迟：</p>
<ul>
<li>当浏览器遇到一个script标签时，DOMTree的构建将被暂停，直至脚本执行完毕</li>
<li>JavaScript可以查询和修改DOMTree与CSSOMTree</li>
<li>直至CSSOM构建完毕，JavaScript才会执行</li>
<li>脚本在文档中的位置很重要</li>
</ul>
<h3 id="3-渲染树的构建"><strong>3.渲染树的构建</strong></h3>
<p>现在，我们已经拥有了完整的DOM树和CSSOM树。DOM 树上每一个节点对应着网页里每一个元素，CSSOM树上每个节点对应着网页里每个元素的样式，并且此时浏览器也可以通过 JavaScript 操作DOM/CSSOM树，动态改变它的结构。但是DOM/CSSOM树本身并不能直接用于排版和渲染，浏览器还会生成另外一棵树：Render树</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913220711.jpeg" alt=""></p>
<p>接下来我们来谈几条概念</p>
<ul>
<li>
<p>Render 树上的每一个节点被称为：<code>RenderObject</code>。</p>
</li>
<li>
<p>RenderObject跟 DOM 节点几乎是一一对应的，当一个<code>可见的 DOM 节点</code>被添加到 DOM 树上时，内核就会为它生成对应的 RenderOject 添加到 Render 树上。</p>
</li>
<li>
<p>其中，可见的DOM节点不包括：</p>
</li>
<li>
<p>一些不会体现在渲染输出中的节点（<code>&lt;html&gt;&lt;script&gt;&lt;link&gt;….</code>），会直接被忽略掉。</p>
</li>
<li>
<p>通过CSS隐藏的节点。例如上图中的<code>span</code>节点，因为有一个CSS显式规则在该节点上设置了<code>display:none</code>属性，那么它在生成RenderObject时会被直接忽略掉。</p>
</li>
<li>
<p>Render 树是衔接浏览器排版引擎和渲染引擎之间的<strong>桥梁</strong>，它是<strong>排版引擎的输出，渲染引擎的输入</strong>。</p>
</li>
</ul>
<p>此时的Render树上，已经包含了网页上所有可见元素的内容和位置信息 排版引擎会根据Render树的内容和结构，准确的计算出元素该在网页上的什么位置。到此，我们已经具备进入布局的一切准备条件，但是通过上面我们知道，布局后面还有一个渲染过程，那么_Render 树是衔接浏览器排版引擎和渲染引擎之间的桥梁，它是排版引擎的输出，渲染引擎的输入。_这句话是什么意思呢？</p>
<h3 id="RenderObject-and-RenderLayer"><strong>RenderObject and RenderLayer</strong></h3>
<blockquote>
<p>浏览器渲染引擎并不是直接使用Render树进行绘制，为了方便处理<strong>Positioning,Clipping,Overflow-scroll,CSS Transfrom/Opacrity/Animation/Filter,Mask or Reflection,Z-indexing</strong>等属性，浏览器需要生成另外一棵树：<strong>Layer树</strong></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913220730.jpeg" alt=""></p>
<p>浏览器会为一些<strong>特定</strong>的<code>RenderObject</code>生成对应的<code>RenderLayer</code>，其中的规则是：</p>
<ul>
<li>是否是页面的根节点 <em>It’s the root object for the page</em></li>
<li>是否有css的一些布局属性（relative absolute or a transform) <em>It has explicit CSS position properties (relative, absolute or a transform)</em></li>
<li>是否透明 <em>It is transparent</em></li>
<li>是否有溢出 <em>Has overflow, an alpha mask or reflection</em></li>
<li>是否有css滤镜 <em>Has a CSS filter</em></li>
<li>是否包含一个canvas元素使得节点拥有视图上下文 <em>Corresponds to canvas element that has a 3D (WebGL) context or an accelerated 2D context</em></li>
<li>是否包含一个video元素 <em>Corresponds to a video element</em></li>
</ul>
<p>当满足上面其中一个条件时，这个<code>RrenderObject</code>就会被浏览器选中生成对应的<code>RenderLayer</code>。至于那些没有被命运选中的RrenderObject，会从属与父节点的RenderLayer。最终，每个RrenderObject都会直接或者间接的属于一个RenderLayer。</p>
<p>浏览器渲染引擎在布局和渲染时会遍历整个Layer树，访问每一个<code>RenderLayer</code>，再遍历从属于这个RenderLayer的 <code>RrenderObject</code>，将每一个 RenderObject 绘制出来。可以理解为：Layer 树决定了网页绘制的层次顺序，而从属于RenderLayer 的 RrenderObject决定了这个 Layer 的内容，所有的 <code>RenderLayer</code> 和 <code>RrenderObject</code> 一起就决定了网页在屏幕上最终呈现出来的内容。</p>
<h3 id="4-布局"><strong>4.布局</strong></h3>
<p>到目前为止，浏览器计算出了哪些节点是可见的以及它的信息和样式，接下来就需要计算这些节点在设备视口内的确切位置和大小，这个过程我们称之为“布局”。</p>
<p>布局最后的输出是一个“盒模型”：将所有相对测量值都转换成屏幕上的绝对像素。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913220553.jpeg" alt=""></p>
<h3 id="5-渲染"><strong>5.渲染</strong></h3>
<p>最后，既然我们知道了哪些节点可见、它们的计算样式以及几何信息，我们终于可以将这些信息传递给最后一个阶段：将渲染树中的每个节点转换成屏幕上的实际像素：浏览器通过发出“Paint Setup”和“Paint”事件，将渲染树转换成屏幕上的像素。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913220718.jpeg" alt=""></p>
<p>至此，我们就能够在浏览器上看到漂亮的网页了</p>
<blockquote>
<p>谈及页面性能优化，我们也常说要尽量减少浏览器的重排和重绘，浏览器重排和重绘时究竟做了哪些工作呢？</p>
</blockquote>
<p>我们平时常说的重排，其实就是浏览器计算render树，布局到渲染的这个过程，而重绘就是计算layer树到渲染的这个过程，每当触发一次重绘和重排时，浏览器都需要重新经过一遍上述的计算。很显然，重排会产生比重绘更大的开销，但无论是重排还是重绘，都会给浏览器渲染线程造成很大的负担，所以，我们在实际生产中要严格注意减少重排和重绘的触发。至于如何减少重排和重绘的次数，这里就不多做展开了，详细请听下回分解~</p>
<h3 id="总结：-2"><strong>总结：</strong></h3>
<ul>
<li>经过：1.构建对象模型（DOM，CSSOM），2.构建渲染树（RenderTree），3.布局，4.渲染 这几个步骤后，我们就能在浏览器上看到漂亮的网页啦。</li>
<li>CSS被视为阻塞渲染的资源，应放到代码的头部尽快加载。</li>
<li>同步的JavaScript会暂停DOMTree的构建，应放到代码的尾部最后加载，或者使用<code>async/defer属性</code>异步加载JavaScript。</li>
<li>重排和重绘会给浏览器渲染线程造成很大的负担，尽量减少重排和重绘的触发次数</li>
</ul>
<h3 id="参考文献："><strong>参考文献：</strong></h3>
<p><a href="https://link.zhihu.com/?target=https%3A//developers.google.com/web/fundamentals/performance/critical-rendering-path/constructing-the-object-model%3Fhl%3Dzh-cn">https://developers.google.com/web/fundamentals/performance/critical-rendering-path/constructing-the-object-model?hl=zh-cn</a></p>
<p><a href="https://link.zhihu.com/?target=https%3A//developers.google.com/web/fundamentals/performance/critical-rendering-path/render-tree-construction%3Fhl%3Dzh-cn">https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-tree-construction?hl=zh-cn</a></p>
<p><a href="https://link.zhihu.com/?target=https%3A//developers.google.com/web/fundamentals/performance/critical-rendering-path/render-blocking-css%3Fhl%3Dzh-cn">https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-blocking-css?hl=zh-cn</a></p>
<p><a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s%3F__biz%3DMzA5NzkwNDk3MQ%3D%3D%26mid%3D2650588806%26idx%3D1%26sn%3D408a54e7c8102fd6944c9a40b119015a%26scene%3D21%23wechat_redirect">https://mp.weixin.qq.com/s?__biz=MzA5NzkwNDk3MQ==&amp;mid=2650588806&amp;idx=1&amp;sn=408a54e7c8102fd6944c9a40b119015a&amp;scene=21#wechat_redirect</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>web</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>http</tag>
        <tag>css</tag>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title>在浏览器输入 URL 回车之后发生了什么</title>
    <url>/posts/656a0abb/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="前言">前言</h2>
<hr>
<p>这个问题已经是老生常谈了，更是经常被作为面试的压轴题出现，网上也有很多文章，但最近闲的无聊，然后就自己做了一篇笔记，感觉比之前理解更透彻了。</p>
<p>这篇笔记是我这两天看了数十篇文章总结出来的，所以相对全面一点，但由于我是做前端的，所以会比较重点分析浏览器渲染页面那一部分，至于其他部分我会罗列出关键词，感兴趣的可以自行查阅，</p>
<p>**注意：**本文的步骤是建立在，请求的是一个简单的 HTTP 请求，没有 HTTPS、HTTP2、最简单的 DNS、没有代理、并且服务器没有任何问题的基础上，尽管这是不切实际的。</p>
<h2 id="大致流程">大致流程</h2>
<ol>
<li>URL 解析</li>
<li>DNS 查询</li>
<li>TCP 连接</li>
<li>处理请求</li>
<li>接受响应</li>
<li>渲染页面</li>
</ol>
<h2 id="一、URL-解析">一、URL 解析</h2>
<h3 id="地址解析："><strong>地址解析：</strong></h3>
<p>首先判断你输入的是一个合法的 URL 还是一个待搜索的关键词，并且根据你输入的内容进行自动完成、字符编码等操作。</p>
<h3 id="HSTS"><strong>HSTS</strong></h3>
<p>由于安全隐患，会使用 HSTS 强制客户端使用 HTTPS 访问页面。详见：<a target="_blank" rel="noopener" href="https://www.barretlee.com/blog/2015/10/22/hsts-intro/">你所不知道的 HSTS (opens new window)</a>。</p>
<h3 id="其他操作"><strong>其他操作</strong></h3>
<p>浏览器还会进行一些额外的操作，比如安全检查、访问限制（之前国产浏览器限制 996.icu）。</p>
<h3 id="检查缓存"><strong>检查缓存</strong></h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913094301.png" alt=""></p>
<h2 id="二、DNS-查询">二、DNS 查询</h2>
<p><strong>基本步骤</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913094305.png" alt=""></p>
<h3 id="1-浏览器缓存"><strong>1. 浏览器缓存</strong></h3>
<p>浏览器会先检查是否在缓存中，没有则调用系统库函数进行查询。</p>
<h3 id="2-操作系统缓存"><strong>2. 操作系统缓存</strong></h3>
<p>操作系统也有自己的 DNS 缓存，但在这之前，会向检查域名是否存在本地的 Hosts 文件里，没有则向 DNS 服务器发送查询请求。</p>
<h3 id="3-路由器缓存"><strong>3. 路由器缓存</strong></h3>
<p>路由器也有自己的缓存。</p>
<h3 id="4-ISP-DNS-缓存"><strong>4. ISP DNS 缓存</strong></h3>
<p>ISP DNS 就是在客户端电脑上设置的首选 DNS 服务器，它们在大多数情况下都会有缓存。</p>
<h3 id="根域名服务器查询"><strong>根域名服务器查询</strong></h3>
<p>在前面所有步骤没有缓存的情况下，本地 DNS 服务器会将请求转发到互联网上的根域，下面这个图很好的诠释了整个流程：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913094311.png" alt=""></p>
<blockquote>
<p>根域名服务器：<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%A0%B9%E7%B6%B2%E5%9F%9F%E5%90%8D%E7%A8%B1%E4%BC%BA%E6%9C%8D%E5%99%A8">维基百科 (opens new window)</a></p>
</blockquote>
<p><strong>需要注意的点</strong></p>
<ol>
<li>递归方式：一路查下去中间不返回，得到最终结果才返回信息（浏览器到本地 DNS 服务器的过程）</li>
<li>迭代方式，就是本地 DNS 服务器到根域名服务器查询的方式。</li>
<li>什么是 DNS 劫持</li>
<li>前端 dns-prefetch 优化</li>
</ol>
<h2 id="三、TCP-连接">三、TCP 连接</h2>
<p>TCP/IP 分为四层，在发送数据时，每层都要对数据进行封装：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913094325.png" alt=""></p>
<h3 id="1-应用层：发送-HTTP-请求"><strong>1. 应用层：发送 HTTP 请求</strong></h3>
<p>在前面的步骤我们已经得到服务器的 IP 地址，浏览器会开始构造一个 HTTP 报文，其中包括：</p>
<ul>
<li>请求报头（Request Header）：请求方法、目标地址、遵循的协议等等</li>
<li>请求主体（其他参数）</li>
</ul>
<p>其中需要注意的点：</p>
<ul>
<li>浏览器只能发送 GET、POST 方法，而打开网页使用的是 GET 方法</li>
</ul>
<h3 id="2-传输层：TCP-传输报文"><strong>2. 传输层：TCP 传输报文</strong></h3>
<p>传输层会发起一条到达服务器的 TCP 连接，为了方便传输，会对数据进行分割（以报文段为单位），并标记编号，方便服务器接受时能够准确地还原报文信息。</p>
<p>在建立连接前，会先进行 TCP 三次握手。</p>
<blockquote>
<p>关于 TCP/IP 三次握手，网上已经有很多段子和图片生动地描述了。</p>
<p>相关知识点：</p>
<ol>
<li>SYN 泛洪攻击</li>
</ol>
</blockquote>
<h3 id="3-网络层：IP-协议查询-Mac-地址"><strong>3. 网络层：IP 协议查询 Mac 地址</strong></h3>
<p>将数据段打包，并加入源及目标的 IP 地址，并且负责寻找传输路线。</p>
<p>判断目标地址是否与当前地址处于同一网络中，是的话直接根据 Mac 地址发送，否则使用路由表查找下一跳地址，以及使用 ARP 协议查询它的 Mac 地址。</p>
<blockquote>
<p>注意：在 OSI 参考模型中 ARP 协议位于链路层，但在 TCP/IP 中，它位于网络层。</p>
</blockquote>
<h3 id="4-链路层：以太网协议"><strong>4. 链路层：以太网协议</strong></h3>
<p><strong>以太网协议</strong></p>
<p>根据以太网协议将数据分为以“帧”为单位的数据包，每一帧分为两个部分：</p>
<ul>
<li>标头：数据包的发送者、接受者、数据类型</li>
<li>数据：数据包具体内容</li>
</ul>
<p><strong>Mac 地址</strong></p>
<p>以太网规定了连入网络的所有设备都必须具备“网卡”接口，数据包都是从一块网卡传递到另一块网卡，网卡的地址就是 Mac 地址。每一个 Mac 地址都是独一无二的，具备了一对一的能力。</p>
<p><strong>广播</strong></p>
<p>发送数据的方法很原始，直接把数据通过 ARP 协议，向本网络的所有机器发送，接收方根据标头信息与自身 Mac 地址比较，一致就接受，否则丢弃。</p>
<p><strong>注意</strong>：接收方回应是单播。</p>
<blockquote>
<p>相关知识点：</p>
<ol>
<li>ARP 攻击</li>
</ol>
</blockquote>
<p><strong>服务器接受请求</strong></p>
<p>接受过程就是把以上步骤逆转过来，参见上图。</p>
<h2 id="四、服务器处理请求">四、服务器处理请求</h2>
<p><strong>大致流程</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913094339.png" alt=""></p>
<h3 id="HTTPD"><strong>HTTPD</strong></h3>
<p>最常见的 HTTPD 有 Linux 上常用的 Apache 和 Nginx，以及 Windows 上的 IIS。</p>
<p>它会监听得到的请求，然后开启一个子进程去处理这个请求。</p>
<h3 id="处理请求"><strong>处理请求</strong></h3>
<p>接受 TCP 报文后，会对连接进行处理，对 HTTP 协议进行解析（请求方法、域名、路径等），并且进行一些验证：</p>
<ul>
<li>验证是否配置虚拟主机</li>
<li>验证虚拟主机是否接受此方法</li>
<li>验证该用户可以使用该方法（根据 IP 地址、身份信息等）</li>
</ul>
<h3 id="重定向"><strong>重定向</strong></h3>
<p>假如服务器配置了 HTTP 重定向，就会返回一个 <code>301</code>永久重定向响应，浏览器就会根据响应，重新发送 HTTP 请求（重新执行上面的过程）。</p>
<blockquote>
<p>关于更多：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/workest/p/3891321.html">详见这篇文章 (opens new window)</a></p>
</blockquote>
<h3 id="URL-重写"><strong>URL 重写</strong></h3>
<p>然后会查看 URL 重写规则，如果请求的文件是真实存在的，比如图片、html、css、js 文件等，则会直接把这个文件返回。</p>
<p>否则服务器会按照规则把请求重写到 一个 REST 风格的 URL 上。</p>
<p>然后根据动态语言的脚本，来决定调用什么类型的动态文件解释器来处理这个请求。</p>
<p>以 PHP 语言的 MVC 框架举例，它首先会初始化一些环境的参数，根据 URL 由上到下地去匹配路由，然后让路由所定义的方法去处理请求。</p>
<h2 id="五、浏览器接受响应">五、浏览器接受响应</h2>
<p>浏览器接收到来自服务器的响应资源后，会对资源进行分析。</p>
<p>首先查看 Response header，根据不同状态码做不同的事（比如上面提到的重定向）。</p>
<p>如果响应资源进行了压缩（比如 gzip），还需要进行解压。</p>
<p>然后，对响应资源做缓存。</p>
<p>接下来，根据响应资源里的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types">MIME (opens new window)</a> 类型去解析响应内容（比如 HTML、Image 各有不同的解析方式）。</p>
<h2 id="六、渲染页面">六、渲染页面</h2>
<p><strong>浏览器内核</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913094432.png" alt=""></p>
<p>不同的浏览器内核，渲染过程也不完全相同，但大致流程都差不多。</p>
<p><strong>基本流程</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913094347.png" alt=""></p>
<h3 id="1-HTML-解析"><strong>1. HTML 解析</strong></h3>
<p>首先要知道浏览器解析是从上往下一行一行地解析的。</p>
<p>解析的过程可以分为四个步骤：</p>
<h4 id="1-解码（encoding）"><strong>1. 解码（encoding）</strong></h4>
<p>传输回来的其实都是一些二进制字节数据，浏览器需要根据文件指定编码（例如 UTF-8）转换成字符串，也就是 HTML 代码。</p>
<h4 id="2-预解析（pre-parsing）"><strong>2. 预解析（pre-parsing）</strong></h4>
<p>预解析做的事情是提前加载资源，减少处理时间，它会识别一些会请求资源的属性，比如<code>img</code>标签的<code>src</code>属性，并将这个请求加到请求队列中。</p>
<h4 id="3-符号化（Tokenization）"><strong>3. 符号化（Tokenization）</strong></h4>
<p>符号化是词法分析的过程，将输入解析成符号，HTML 符号包括，开始标签、结束标签、属性名和属性值。</p>
<p>它通过一个状态机去识别符号的状态，比如遇到<code>&lt;</code>，<code>&gt;</code>状态都会产生变化。</p>
<h4 id="4-构建树（tree-construction）"><strong>4. 构建树（tree construction）</strong></h4>
<blockquote>
<p>注意：符号化和构建树是并行操作的，也就是说只要解析到一个开始标签，就会创建一个 DOM 节点。</p>
</blockquote>
<p>在上一步符号化中，解析器获得这些标记，然后以合适的方法创建<code>DOM</code>对象并把这些符号插入到<code>DOM</code>对象中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913094354.png" alt=""></p>
<h4 id="浏览器容错进制"><strong>浏览器容错进制</strong></h4>
<p>你从来没有在浏览器看过类似"语法无效"的错误，这是因为浏览器去纠正错误的语法，然后继续工作。</p>
<h4 id="事件"><strong>事件</strong></h4>
<p>当整个解析的过程完成以后，浏览器会通过<code>DOMContentLoaded</code>事件来通知<code>DOM</code>解析完成。</p>
<h3 id="2-CSS-解析">2. CSS 解析</h3>
<p>一旦浏览器下载了 CSS，CSS 解析器就会处理它遇到的任何 CSS，根据<a target="_blank" rel="noopener" href="https://drafts.csswg.org/css-syntax-3/">语法规范 (opens new window)</a>解析出所有的 CSS 并进行标记化，然后我们得到一个规则表。</p>
<h4 id="CSS-匹配规则"><strong>CSS 匹配规则</strong></h4>
<p>在匹配一个节点对应的 CSS 规则时，是按照从右到左的顺序的，例如：<code>div p { font-size :14px }</code>会先寻找所有的<code>p</code>标签然后判断它的父元素是否为<code>div</code>。</p>
<p>所以我们写 CSS 时，尽量用 id 和 class，千万不要过度层叠。</p>
<h3 id="3-渲染树">3. 渲染树</h3>
<p>其实这就是一个 DOM 树和 CSS 规则树合并的过程。</p>
<blockquote>
<p>注意：渲染树会忽略那些不需要渲染的节点，比如设置了<code>display:none</code>的节点。</p>
</blockquote>
<h4 id="计算"><strong>计算</strong></h4>
<p>通过计算让任何尺寸值都减少到三个可能之一：<code>auto</code>、百分比、px，比如把<code>rem</code>转化为<code>px</code>。</p>
<h4 id="级联"><strong>级联</strong></h4>
<p>浏览器需要一种方法来确定哪些样式才真正需要应用到对应元素，所以它使用一个叫做<code>specificity</code>的公式，这个公式会通过：</p>
<ol>
<li>标签名、class、id</li>
<li>是否内联样式</li>
<li><code>!important</code></li>
</ol>
<p>然后得出一个权重值，取最高的那个。</p>
<h4 id="渲染阻塞"><strong>渲染阻塞</strong></h4>
<p>当遇到一个<code>script</code>标签时，DOM 构建会被暂停，直至脚本完成执行，然后继续构建 DOM 树。</p>
<p>但如果 JS 依赖 CSS 样式，而它还没有被下载和构建时，浏览器就会延迟脚本执行，直至 CSS Rules 被构建。</p>
<p>所有我们知道：</p>
<ul>
<li>CSS 会阻塞 JS 执行</li>
<li>JS 会阻塞后面的 DOM 解析</li>
</ul>
<p>为了避免这种情况，应该以下原则：</p>
<ul>
<li>CSS 资源排在 JavaScript 资源前面</li>
<li>JS 放在 HTML 最底部，也就是 <code>&lt;/body&gt;</code>前</li>
</ul>
<p>另外，如果要改变阻塞模式，可以使用 defer 与 async，详见：<a target="_blank" rel="noopener" href="https://github.com/xiaoyu2er/blog/issues/8">这篇文章 (opens new window)</a></p>
<ol start="4">
<li>布局与绘制</li>
</ol>
<p>确定渲染树种所有节点的几何属性，比如：位置、大小等等，最后输入一个盒子模型，它能精准地捕获到每个元素在屏幕内的准确位置与大小。</p>
<p>然后遍历渲染树，调用渲染器的 paint() 方法在屏幕上显示其内容。</p>
<h3 id="5-合并渲染层"><strong>5. 合并渲染层</strong></h3>
<p>把以上绘制的所有图片合并，最终输出一张图片。</p>
<h3 id="6-回流与重绘"><strong>6. 回流与重绘</strong></h3>
<h4 id="回流-reflow"><strong>回流(reflow)</strong></h4>
<p>当浏览器发现某个部分发现变化影响了布局时，需要倒回去重新渲染，会从<code>html</code>标签开始递归往下，重新计算位置和大小。</p>
<p>reflow 基本是无法避免的，因为当你滑动一下鼠标、resize 窗口，页面就会产生变化。</p>
<h4 id="重绘-repaint"><strong>重绘(repaint)</strong></h4>
<p>改变了某个元素的背景色、文字颜色等等不会影响周围元素的位置变化时，就会发生重绘。</p>
<p>每次重绘后，浏览器还需要合并渲染层并输出到屏幕上。</p>
<p>回流的成本要比重绘高很多，所以我们应该尽量避免产生回流。</p>
<p>比如：</p>
<ul>
<li><code>display:none</code> 会触发回流，而 <code>visibility:hidden</code> 只会触发重绘。</li>
</ul>
<ol start="7">
<li>JavaScript 编译执行</li>
</ol>
<p><strong>大致流程</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913094359.png" alt=""></p>
<p>可以分为三个阶段：</p>
<h5 id="1-词法分析"><strong>1. 词法分析</strong></h5>
<p>JS 脚本加载完毕后，会首先进入语法分析阶段，它首先会分析代码块的语法是否正确，不正确则抛出“语法错误”，停止执行。</p>
<p>几个步骤：</p>
<ul>
<li>分词，例如将<code>var a = 2</code>，，分成<code>var</code>、<code>a</code>、<code>=</code>、<code>2</code>这样的词法单元。</li>
<li>解析，将词法单元转换成抽象语法树（AST）。</li>
<li>代码生成，将抽象语法树转换成机器指令。</li>
</ul>
<h5 id="2-预编译"><strong>2. 预编译</strong></h5>
<p>JS 有三种运行环境：</p>
<ul>
<li>全局环境</li>
<li>函数环境</li>
<li>eval</li>
</ul>
<p>每进入一个不同的运行环境都会创建一个对应的执行上下文，根据不同的上下文环境，形成一个函数调用栈，栈底永远是全局执行上下文，栈顶则永远是当前执行上下文。</p>
<p><strong>创建执行上下文</strong></p>
<p>创建执行上下文的过程中，主要做了以下三件事：</p>
<ul>
<li>创建变量对象
<ul>
<li>参数、函数、变量</li>
</ul>
</li>
<li>建立作用域链
<ul>
<li>确认当前执行环境是否能访问变量</li>
</ul>
</li>
<li>确定 This 指向</li>
</ul>
<h5 id="3-执行"><strong>3. 执行</strong></h5>
<p><strong>JS 线程</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913094406.png" alt=""></p>
<p>虽然 JS 是单线程的，但实际上参与工作的线程一共有四个：</p>
<blockquote>
<p>其中三个只是协助，只有 JS 引擎线程是真正执行的</p>
</blockquote>
<ul>
<li>JS 引擎线程：也叫 JS 内核，负责解析执行 JS 脚本程序的主线程，例如 V8 引擎</li>
<li>事件触发线程：属于浏览器内核线程，主要用于控制事件，例如鼠标、键盘等，当事件被触发时，就会把事件的处理函数推进事件队列，等待 JS 引擎线程执行</li>
<li>定时器触发线程：主要控制<code>setInterval</code>和<code>setTimeout</code>，用来计时，计时完毕后，则把定时器的处理函数推进事件队列中，等待 JS 引擎线程。</li>
<li>HTTP 异步请求线程：通过 XMLHttpRequest 连接后，通过浏览器新开的一个线程，监控 readyState 状态变更时，如果设置了该状态的回调函数，则将该状态的处理函数推进事件队列中，等待 JS 引擎线程执行。</li>
</ul>
<p><strong>注：浏览器对同一域名的并发连接数是有限的，通常为 6 个。</strong></p>
<p><strong>宏任务</strong></p>
<p>分为：</p>
<ul>
<li>同步任务：按照顺序执行，只有前一个任务完成后，才能执行后一个任务</li>
<li>异步任务：不直接执行，只有满足触发条件时，相关的线程将该异步任务推进任务队列中，等待 JS 引擎主线程上的任务执行完毕时才开始执行，例如异步 Ajax、DOM 事件，setTimeout 等。</li>
</ul>
<p><strong>微任务</strong></p>
<p>微任务是 ES6 和 Node 环境下的，主要 API 有：<code>Promise</code>，<code>process.nextTick</code>。</p>
<p>微任务的执行在宏任务的同步任务之后，在异步任务之前。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913094407.png" alt=""></p>
<p><strong>代码例子</strong></p>
<p>以上代码输出顺序为：1,3,5,4,2</p>
<h2 id="参考文档">参考文档</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/skyline75489/what-happens-when-zh_CN">what-happens-when-zh_CN (opens new window)</a></li>
<li><a target="_blank" rel="noopener" href="https://alistapart.com/article/tags-to-dom/">Tags to DOM (opens new window)</a></li>
<li><a target="_blank" rel="noopener" href="https://heyingye.github.io/2018/04/16/%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/">彻底理解浏览器的缓存机制 (opens new window)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#The_rendering_engine">浏览器的工作原理：新式网络浏览器幕后揭秘 (opens new window)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.fundebug.com/2019/01/03/understand-browser-rendering/">深入浅出浏览器渲染原理 (opens new window)</a></li>
<li><a target="_blank" rel="noopener" href="https://heyingye.github.io/2018/03/19/js%E5%BC%95%E6%93%8E%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89/#%E9%A2%84%E7%BC%96%E8%AF%91%E9%98%B6%E6%AE%B5">js 引擎的执行过程（一） (opens new window)</a></li>
<li>还有一些找不到了。。。。。</li>
</ul>
<p>From: <a target="_blank" rel="noopener" href="https://4ark.me/post/b6c7c0a2.html">4ark.me</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>web</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>http</tag>
      </tags>
  </entry>
  <entry>
    <title>[三万字教程]基于Hexo的matery主题搭建博客并深度优一站式完全教程</title>
    <url>/posts/40300608/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>All in one 一站式Hexo配置优化教程！</p>
<ul>
<li>如果你遇到了什么问题，搜索本文，你很可能有收获！ <code>CtRL + F</code></li>
<li>光临博主的博客 <a href="https://blog.17lai.site/">夜法之书</a></li>
<li>本文就教你搭建一个美观实用的博客系统，步骤极尽详细！</li>
<li>本文中提到的大量特性，已经被博主提交到<a target="_blank" rel="noopener" href="https://github.com/blinkfox/hexo-theme-matery">matery</a>主题develop分支，提交记录见<a target="_blank" rel="noopener" href="https://github.com/blinkfox/hexo-theme-matery/commits?author=appotry">Commit</a>。所以下面很多特性以及不用自己修改了，可以直接使用。</li>
</ul>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0520211105195951.jpg" alt="为什么写博客"></p>
<h2 id="Hexo入门">Hexo入门</h2>
<h3 id="Docker-版-hexo-环境一键部署">Docker 版 hexo 环境一键部署</h3>
<blockquote>
<p>博主开源定制，推荐使用！省去您大量环境配置时间。</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/hexo">docker-hub</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/appotry/docker-hexo">Github-hexo</a></li>
</ul>
<p>使用推荐Docker来搭配本文，阅读使用，将更省事，方便，快捷。hexo环境一键搞定！</p>
<h4 id="Docker一键安装">Docker一键安装</h4>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">docker create <span class="token punctuation">-</span><span class="token punctuation">-</span>name=hexo \
<span class="token punctuation">-</span>e HEXO_SERVER_PORT=4000 \
<span class="token punctuation">-</span>e GIT_USER="17lai" \
<span class="token punctuation">-</span>e GIT_EMAIL="17lai@domain.tld" \
<span class="token punctuation">-</span>v /mnt/blog.17lai.site<span class="token punctuation">:</span>/app \
<span class="token punctuation">-</span>p 4000<span class="token punctuation">:</span>4000 \
bloodstar/hexo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="ssh-key-部署">ssh key 部署</h4>
<p><strong>Docker会自动随机生成ssh key</strong> 在 /app/.ssh 目录下面。自动部署请把ssh key添加到github 等平台。</p>
<p><a target="_blank" rel="noopener" href="https://docs.github.com/cn/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account">Github详细教程</a></p>
<blockquote>
<ol>
<li>将<strong>SSH</strong> 公钥复制到剪贴板。 ...</li>
<li>在任何页面的右上角，单击您的个人资料照片，然后单击Settings（设置）。</li>
<li>在用户设置侧边栏中，单击<strong>SSH</strong> and GPG keys（<strong>SSH</strong> 和GPG 密钥）。</li>
<li>单击New <strong>SSH</strong> key（新<strong>SSH</strong> 密钥）或Add <strong>SSH</strong> key（添加<strong>SSH</strong> 密钥）。</li>
</ol>
</blockquote>
<h4 id="进入docker">进入docker</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it hexo <span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后就可以正常运行hexo的各种命令了，是不是非常简单？ 快来试试吧。</p>
<h4 id="用户自动运行脚本">用户自动运行脚本</h4>
<blockquote>
<p>用户可以在这里添加自动配置，自动安装插件，等各种启动docker运行的命令。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vi</span> /app/useRun.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="Hexo-通用简明教程">Hexo 通用简明教程</h3>
<p><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> 是一个快速、简洁且高效的博客框架。Hexo 使用 <a target="_blank" rel="noopener" href="http://daringfireball.net/projects/markdown/">Markdown</a>（或其他渲染引擎）解析文章，在几秒内，即可利用靓丽的主题生成静态网页。</p>
<h4 id="前提">前提</h4>
<p>安装 Hexo 相当简单，只需要先安装下列应用程序即可：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://nodejs.org/">Node.js</a> (Node.js 版本需不低于 8.10，建议使用 Node.js 10.0 及以上版本)</li>
<li><a target="_blank" rel="noopener" href="http://git-scm.com/">Git</a></li>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/">nmp</a></li>
</ul>
<h4 id="安装-3">安装</h4>
<p>所有必备的应用程序安装完成后，即可使用 npm 安装 Hexo。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> -g hexo-cli<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装以后，可以使用以下两种方式执行 Hexo：</p>
<ol>
<li><code>npx hexo</code></li>
<li>将 Hexo 所在的目录下的 <code>node_modules</code> 添加到环境变量之中即可直接使用： <code>hexo</code></li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'PATH="$PATH:./node_modules/.bin"'</span> <span class="token operator">&gt;&gt;</span> ~/.profile<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="安装淘宝镜像，-加NPM">安装淘宝镜像， 加NPM</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> config <span class="token builtin class-name">set</span> registry https://registry.npm.taobao.org<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="安装CNPM">安装CNPM</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> -g cnpm --registry<span class="token operator">=</span>https://registry.npm.taobao.org<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="升级">升级</h4>
<p>后期需要升级的化，进入 blog 目录，先检查更新:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> outdated
Package                  Current  Wanted  Latest  Location
hexo                       <span class="token number">3.9</span>.0   <span class="token number">3.9</span>.0   <span class="token number">4.2</span>.0  hexo-site
hexo-deployer-git          <span class="token number">1.0</span>.0   <span class="token number">1.0</span>.0   <span class="token number">2.1</span>.0  hexo-site
hexo-generator-archive     <span class="token number">0.1</span>.5   <span class="token number">0.1</span>.5   <span class="token number">1.0</span>.0  hexo-site
hexo-generator-category    <span class="token number">0.1</span>.3   <span class="token number">0.1</span>.3   <span class="token number">1.0</span>.0  hexo-site
hexo-generator-feed        <span class="token number">1.2</span>.2   <span class="token number">1.2</span>.2   <span class="token number">2.2</span>.0  hexo-site
hexo-generator-index       <span class="token number">0.2</span>.1   <span class="token number">0.2</span>.1   <span class="token number">1.0</span>.0  hexo-site
hexo-generator-tag         <span class="token number">0.2</span>.0   <span class="token number">0.2</span>.0   <span class="token number">1.0</span>.0  hexo-site
hexo-renderer-ejs          <span class="token number">0.3</span>.1   <span class="token number">0.3</span>.1   <span class="token number">1.0</span>.0  hexo-site
hexo-renderer-marked       <span class="token number">0.3</span>.2   <span class="token number">0.3</span>.2   <span class="token number">2.0</span>.0  hexo-site
hexo-renderer-stylus       <span class="token number">0.3</span>.3   <span class="token number">0.3</span>.3   <span class="token number">1.1</span>.0  hexo-site
hexo-server                <span class="token number">0.3</span>.3   <span class="token number">0.3</span>.3   <span class="token number">1.0</span>.0  hexo-site<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改 <code>package.json</code> 文件，基于 <code>Latest</code> 列内容更新版本号，然后更新并检查版本号：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save

<span class="token comment"># 检查版本号</span>
$ hexo -v
hexo: <span class="token number">4.2</span>.0
hexo-cli: <span class="token number">3.1</span>.0
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="建站">建站</h4>
<p>安装 Hexo 完成后，请执行下列命令，Hexo 将会在指定文件夹中新建所需要的文件。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo init <span class="token operator">&lt;</span>folder<span class="token operator">&gt;</span>
<span class="token builtin class-name">cd</span> <span class="token operator">&lt;</span>folder<span class="token operator">&gt;</span>
<span class="token function">npm</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="启动网页服务">启动网页服务</h4>
<p>此时，通过 <code>hexo s</code> 命令即可在本地启动您的博客站点了。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo s
INFO  Start processing
INFO  Hexo is running at http://localhost:4000 <span class="token builtin class-name">.</span> Press Ctrl+C to stop.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>接下来将安装主题，配置博客托管平台，实现一键发布并刷新 CDN 缓存。</p>
<h4 id="hexo目录结构说明">hexo目录结构说明</h4>
<p>在执行过<code>Hexo deploy</code>命令之后，目录结构新增了<code>.deploy_git</code>，<code>public</code>，<code>.gitignore</code>，如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"> $ tree -L <span class="token number">2</span>
<span class="token builtin class-name">.</span>
├── .deploy_git
├── node_modules
├── public
├── scaffolds
│   ├── draft.md
│   ├── page.md
│   └── post.md
├── <span class="token builtin class-name">source</span>
│   ├── _posts
│   ├── _drafts
├── themes
├── _config.yml
├── db.json
├── package.json
└── package-lock.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="config-yml">_config.yml</h5>
<p>用来配置博客相关的参数，初始化时自动创建。具体参数设置，可参照 <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/configuration">Hexo 配置</a> 文档。</p>
<h5 id="node-modules-和-package-json">node_modules 和 package.json</h5>
<p>都是在初始化时自动创建。</p>
<ul>
<li><code>node_modules</code>用来存储已安装的各类依赖包。</li>
<li><code>package.json</code>用来查看 Hexo 的版本以及相关依赖包的版本。</li>
</ul>
<p>Hexo 会默认安装：</p>
<ul>
<li>hexo：主程序</li>
<li>hexo-deployer-git：实现 git 部署方式</li>
<li>hexo-generator-archive：存档页面生成器</li>
<li>hexo-generator-category：分类页面生成器</li>
<li>hexo-generator-index：index 生成器</li>
<li>hexo-generator-tag：标签页面生成器</li>
<li>hexo-renderer-ejs：支持 EJS 渲染</li>
<li>hexo-renderer-marked：Markdown 引擎</li>
<li>hexo-renderer-stylus：支持 stylus 渲染</li>
<li>hexo-server：支持本地预览，默认地址 localhost:4000</li>
</ul>
<p>新安装的依赖包，也会保存在<code>node_module</code>文件夹下。</p>
<h5 id="scaffold">scaffold</h5>
<p>模板文件夹，初始化时自动创建。包含<code>page</code>，<code>post</code>，<code>draft</code>三种模板，分别对应 页面、要发布的文章、草稿。</p>
<h5 id="themes">themes</h5>
<p>主题文件夹，初始化时自动创建。每一个主题，都有一个单独的文件夹。默认主题为 <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo-theme-landscape">landscape</a>。</p>
<h5 id="source-，-public-和-deploy-git">source ， public 和 .deploy_git</h5>
<ul>
<li>source：资源文件夹。用来存放图片、Markdown 文档（文章、草稿）、各种页面（分类、关于页面等）。</li>
<li>public：将 source 文件夹里的 Markdown 文档，转换成 index.html。再结合主题进行渲染，就是我们最终看到的博客。</li>
<li>.deploy_git：将 public 文件夹的内容提交到 Github 后生成，内容与 public 文件夹基本一致。</li>
</ul>
<p>这三者的关系大致是：source -&gt; public -&gt; .deploy_git</p>
<ul>
<li>执行<code>hexo generate</code>，根据 source，更新 public。</li>
<li>执行<code>hexo deploy</code>，根据 public，更新 .deploy_git。</li>
</ul>
<h3 id="常用命令">常用命令</h3>
<h4 id="指令说明">指令说明</h4>
<ul>
<li>
<p><code>hexo server</code> #启动本地服务器，用于预览主题。Hexo 会监视文件变动并自动更新，除修改站点配置文件外,无须重启服务器,直接刷新网页即可生效。</p>
</li>
<li>
<p><code>hexo server -s</code> #以静态模式启动</p>
</li>
<li>
<p><code>hexo server -p 5000</code> #更改访问端口 (默认端口为 4000，’ctrl + c’关闭 server)</p>
</li>
<li>
<p><code>hexo server -i IP地址</code> #自定义 IP</p>
</li>
<li>
<p><code>hexo clean</code> #清除缓存 ,网页正常情况下可以忽略此条命令,执行该指令后,会删掉站点根目录下的 public 文件夹</p>
</li>
<li>
<p><code>hexo g</code> #生成静态网页 (执行 $ <code>hexo g</code>后会在站点根目录下生成 public 文件夹, hexo 会将”/blog/source/“ 下面的.md 后缀的文件编译为.html 后缀的文件,存放在”/blog/public/ “ 路径下)</p>
</li>
<li>
<p><code>hexo d</code> #自动生成网站静态文件，并将本地数据部署到设定的仓库(如 github)</p>
</li>
<li>
<p><code>hexo init</code> 文件夹名称 #初始化 XX 文件夹名称</p>
</li>
<li>
<p><code>npm update hexo -g</code>#升级</p>
</li>
<li>
<p><code>npm install hexo -g</code> #安装</p>
</li>
<li>
<p><code>node-v</code> #查看 node.js 版本号</p>
</li>
<li>
<p><code>npm -v</code> #查看 npm 版本号</p>
</li>
<li>
<p><code>git --version</code> #查看 git 版本号</p>
</li>
<li>
<p><code>hexo -v</code> #查看 hexo 版本号</p>
</li>
</ul>
<h4 id="简写指令">简写指令</h4>
<pre class="line-numbers language-none"><code class="language-none">hexo n "我的第一篇文章"` 等价于 `hexo new "我的第一篇文章"` 还等价于 `hexo new post "我的第一篇文章"
hexo p` 等价于 `hexo publish
hexo g` 等价于 `hexo generate
hexo s`等价于 `hexo server
hexo d` 等价于 `hexo deploy
hexo g -d`等价于`hexo generate --deploy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注: <code>hexo clean</code> 没有 简写, <code>git --version</code> 没有简写</p>
<h2 id="Hexo基础配置">Hexo基础配置</h2>
<h3 id="下载主题">下载主题</h3>
<p><a target="_blank" rel="noopener" href="https://github.com/blinkfox/hexo-theme-matery">hexo-theme-matery</a> 是一个采用 <code>Material Design</code> 和响应式设计的 Hexo 博客主题，点击 <a target="_blank" rel="noopener" href="https://www.lixl.cn/">这里</a> 可以查看示例效果。点击 <a target="_blank" rel="noopener" href="https://codeload.github.com/blinkfox/hexo-theme-matery/zip/master">这里</a> 下载 <code>master</code> 分支的最新稳定版的代码，解压缩后，将 <code>hexo-theme-matery</code> 的文件夹复制到 Hexo 的 <code>themes</code> 文件夹中即可。</p>
<p>Docker环境命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/blinkfox/hexo-theme-matery.git /app/themes/matery<span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="切换主题">切换主题</h3>
<p>修改 Hexo 根目录下的 <code>_config.yml</code> 的 <code>theme</code> 的值：<code>theme: hexo-theme-matery</code></p>
<h4 id="config-yml-文件的其它修改建议"><code>_config.yml</code> 文件的其它修改建议</h4>
<ul>
<li>请修改 <code>_config.yml</code> 的 <code>url</code> 的值为你的网站主 <code>URL</code>（如：<code>http://xxx.github.io</code>）。</li>
<li>建议修改两个 <code>per_page</code> 的分页条数值为 <code>6</code> 的倍数，如：<code>12</code>、<code>18</code> 等，这样文章列表在各个屏幕下都能较好的显示。</li>
<li>如果是中文用户，则建议修改 <code>language</code> 的值为 <code>zh-CN</code>。</li>
</ul>
<h3 id="新建主题必备about、tags、404等页面">新建主题必备about、tags、404等页面</h3>
<h4 id="新建分类-categories-页">新建分类 categories 页</h4>
<p><code>categories</code> 页是用来展示所有分类的页面，如果 <code>source</code> 目录下还没有 <code>categories/index.md</code> 文件，那么就需要新建一个，命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"categories"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>编辑你刚刚新建的页面文件 <code>/source/categories/index.md</code>，至少需要以下内容：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">title</span><span class="token punctuation">:</span> categories
<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2018-09-30 17:25:30</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"categories"</span>
<span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"categories"</span>
<span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="新建标签-tags-页">新建标签 tags 页</h4>
<p><code>tags</code> 页是用来展示所有标签的页面，如果 <code>source</code> 目录下还没有 <code>tags/index.md</code> 文件，那么就需要新建一个，命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"tags"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>编辑刚刚新建的页面文件 <code>/source/tags/index.md</code>，至少需要以下内容：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">title</span><span class="token punctuation">:</span> tags
<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2018-09-30 18:23:38</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"tags"</span>
<span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"tags"</span>
<span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="新建留言板-contact-页">新建留言板 contact 页</h4>
<p><code>contact</code> 页是用来展示<strong>留言板</strong>信息的页面，如果在你的博客 <code>source</code> 目录下还没有 <code>contact/index.md</code> 文件，那么你就需要新建一个，命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"contact"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>编辑你刚刚新建的页面文件 <code>/source/contact/index.md</code>，至少需要以下内容：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">title</span><span class="token punctuation">:</span> contact
<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2018-09-30 17:25:30</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"contact"</span>
<span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"contact"</span>
<span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注</strong>：本留言板功能依赖于第三方评论系统，请<strong>激活</strong>你的评论系统才有效果。并且在主题的 <code>_config.yml</code> 文件中，第 <code>19</code> 至 <code>21</code> 行的“<strong>菜单</strong>”配置，取消关于留言板的注释即可。</p>
</blockquote>
<h4 id="新建友情链接-friends-页">新建友情链接 friends 页</h4>
<p><code>friends</code> 页是用来展示<strong>友情链接</strong>信息的页面，如果在你的博客 <code>source</code> 目录下还没有 <code>friends/index.md</code> 文件，那么你就需要新建一个，命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"friends"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>编辑你刚刚新建的页面文件 <code>/source/friends/index.md</code>，至少需要以下内容：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">title</span><span class="token punctuation">:</span> friends
<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2018-12-12 21:25:30</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"friends"</span>
<span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"friends"</span>
<span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时，在你的博客 <code>source</code> 目录下新建 <code>_data</code> 目录，在 <code>_data</code> 目录中新建 <code>friends.json</code> 文件，文件内容如下所示：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token property">"avatar"</span><span class="token operator">:</span> <span class="token string">"https://blog.17lai.site/favicon.png"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"夜法之书的Blog"</span><span class="token punctuation">,</span>
    <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"嵌入式，Linux Kernel&amp;Driver, PT, Docker, Nas等等"</span><span class="token punctuation">,</span>
    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://blog.17lai.site"</span><span class="token punctuation">,</span>
    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"前去学习"</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token property">"avatar"</span><span class="token operator">:</span> <span class="token string">"http://image.luokangyuan.com/1_qq_27922023.jpg"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"码酱"</span><span class="token punctuation">,</span>
    <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"我不是大佬，只是在追寻大佬的脚步"</span><span class="token punctuation">,</span>
    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"http://luokangyuan.com/"</span><span class="token punctuation">,</span>
    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"前去学习"</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">"avatar"</span><span class="token operator">:</span> <span class="token string">"http://image.luokangyuan.com/4027734.jpeg"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"闪烁之狐"</span><span class="token punctuation">,</span>
    <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬"</span><span class="token punctuation">,</span>
    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://blinkfox.github.io/"</span><span class="token punctuation">,</span>
    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"前去学习"</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">"avatar"</span><span class="token operator">:</span> <span class="token string">"http://image.luokangyuan.com/avatar.jpg"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"ja_rome"</span><span class="token punctuation">,</span>
    <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"平凡的脚步也可以走出伟大的行程"</span><span class="token punctuation">,</span>
    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://me.csdn.net/jlh912008548"</span><span class="token punctuation">,</span>
    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"前去学习"</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="新建关于我-about-页">新建关于我 about 页</h4>
<p><code>about</code> 页是用来展示<strong>关于我和我的博客</strong>信息的页面，如果 <code>source</code> 目录下还没有 <code>about/index.md</code> 文件，那么就需要新建一个，命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"about"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>编辑刚刚新建的页面文件 <code>/source/about/index.md</code>，至少需要以下内容：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">title</span><span class="token punctuation">:</span> about
<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2018-09-30 17:25:30</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"about"</span>
<span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"about"</span>
<span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="新建404页">新建404页</h4>
<p>新建一个404.md文件</p>
<p>在hexo的souce文件夹下创建一个404.md，之后输入如下内容：</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token front-matter-block"><span class="token punctuation">---</span>
<span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token number">404</span>
<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2019-11-23 21:10:10</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"404"</span>
<span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"404"</span></span>
<span class="token punctuation">---</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913191101.png" alt="新建404.md"></p>
<p>然后<code>hexo g</code>生成页面中就有404。只是页面较丑。</p>
<h4 id="404页面美化">404页面美化</h4>
<blockquote>
<p>下载404特效</p>
<p>点击下载代码:<a target="_blank" rel="noopener" href="https://www.lanrenzhijia.com/js/4285.html">点我去代码出处</a></p>
</blockquote>
<h5 id="移植">移植</h5>
<h5 id="放入js文件到主题中">放入js文件到主题中</h5>
<p>将下载的压缩包解压，会发现里面有两个js文件和一个html页面，重要的就是js文件，将文件移植到主题的source文件的libs文件夹下，需要自己创建一个文件夹，我给文件夹取的名字叫做404。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913191716.png" alt=""></p>
<h5 id="导入404-js">导入404 js</h5>
<p>因为该主题的js文件都是写_config.yml文件里面的，为了规范，也需要将文件的路径写到该文件夹下</p>
<p>如下，之后导入js文件的时候就可以使用404bodymovin和404data来代替了</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1320210913192151.png" alt="修改主题_config.yml文件"></p>
<h5 id="编辑404-esj">编辑404.esj</h5>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token comment">/* don't remove. */</span>
    <span class="token selector">.page404-cover</span> <span class="token punctuation">{</span>
        <span class="token comment">/* height: 75vh; */</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 88vh<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token selector">#svgContainer</span> <span class="token punctuation">{</span>
      <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
      <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
      <span class="token property">background-color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
      <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
      <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
      <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
      <span class="token property">right</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
      <span class="token property">bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
      <span class="token property">margin</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
 
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;%- theme.libs.js.my404bodymovin %&gt;<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;%- theme.libs.js.my404data %&gt;<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bg-cover pd-header page404-cover<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>svgContainer<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token keyword">var</span> svgContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'svgContainer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> animItem <span class="token operator">=</span> bodymovin<span class="token punctuation">.</span><span class="token function">loadAnimation</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">wrapper</span><span class="token operator">:</span> svgContainer<span class="token punctuation">,</span>
          <span class="token literal-property property">animType</span><span class="token operator">:</span> <span class="token string">'svg'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">loop</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token literal-property property">animationData</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>animationData<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在就移植成功了，使用下面命令上传，之后输入一个错误的页面就可以查看到了</p>
<pre class="line-numbers language-none"><code class="language-none">hexo cl &amp;&amp; hexo g -d<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>Tips: 不要再本地试验，本地的时候输入错误的页面不会显示404页面的。</p>
</blockquote>
<h4 id="新建友情连接-friends-页（可选的）">新建友情连接 friends 页（可选的）</h4>
<p><code>friends</code> 页是用来展示<strong>友情连接</strong>信息的页面，如果 <code>source</code> 目录下还没有 <code>friends/index.md</code> 文件，那么就需要新建一个，命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"friends"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>编辑刚刚新建的页面文件 <code>/source/friends/index.md</code>，至少需要以下内容：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">title</span><span class="token punctuation">:</span> friends
<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2018-12-12 21:25:30</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"friends"</span>
<span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"friends"</span>
<span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时，在 <code>source</code> 目录下新建 <code>_data</code> 目录，在 <code>_data</code> 目录中新建 <code>friends.json</code> 文件，文件内容如下所示：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"avatar"</span><span class="token operator">:</span> <span class="token string">"https://www.lixl.cn/medias/avatar.jpg"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"悟尘记"</span><span class="token punctuation">,</span>
    <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"人生就是一场修行，上善若水，厚德载物。"</span><span class="token punctuation">,</span>
    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://www.lixl.cn/"</span><span class="token punctuation">,</span>
    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"前去参观"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"avatar"</span><span class="token operator">:</span> <span class="token string">"https://wiki.hyperledger.org/download/attachments/2392069/fabric?version=1&amp;modificationDate=1540928132000&amp;api=v2"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Fabric"</span><span class="token punctuation">,</span>
    <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"A Blockchain Platform for the Enterprise"</span><span class="token punctuation">,</span>
    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://hyperledger-fabric.readthedocs.io/en/master/"</span><span class="token punctuation">,</span>
    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"前去学习"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"avatar"</span><span class="token operator">:</span> <span class="token string">"https://www.bootcdn.cn/assets/img/maoyun.svg"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"BootCDN"</span><span class="token punctuation">,</span>
    <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"稳定、快速、免费的前端开源项目 CDN 加速服务。"</span><span class="token punctuation">,</span>
    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://www.bootcdn.cn/"</span><span class="token punctuation">,</span>
    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"前去加速"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="菜单导航配置">菜单导航配置</h3>
<h4 id="配置基本菜单导航的名称、路径url和图标icon">配置基本菜单导航的名称、路径url和图标icon.</h4>
<ul>
<li>1.菜单导航名称可以是中文也可以是英文(如：<code>Index</code>或<code>主页</code>)</li>
<li>2.图标icon 可以在<a target="_blank" rel="noopener" href="https://fontawesome.com/icons">Font Awesome</a> 中查找</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">menu</span><span class="token punctuation">:</span>
  <span class="token key atrule">Index</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> /
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>home
  <span class="token key atrule">Tags</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> /tags
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>tags
  <span class="token key atrule">Categories</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> /categories
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>bookmark
  <span class="token key atrule">Archives</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> /archives
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>archive
  <span class="token key atrule">About</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> /about
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>user<span class="token punctuation">-</span>circle
  <span class="token key atrule">Friends</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> /friends
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>address<span class="token punctuation">-</span>book<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="二级菜单配置方法">二级菜单配置方法</h4>
<p>如果你需要二级菜单则可以在原基本菜单导航的基础上如下操作</p>
<ol>
<li>在需要添加二级菜单的一级菜单下添加<code>children</code>关键字(如:<code>About</code>菜单下添加<code>children</code>)</li>
<li>在<code>children</code>下创建二级菜单的 名称name,路径url和图标icon.</li>
<li>注意每个二级菜单模块前要加 <code>-</code>.</li>
<li>注意缩进格式</li>
</ol>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">menu</span><span class="token punctuation">:</span>
  <span class="token key atrule">Index</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> /
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>home
  <span class="token key atrule">Tags</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> /tags
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>tags
  <span class="token key atrule">Categories</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> /categories
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>bookmark
  <span class="token key atrule">Archives</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> /archives
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>archive
  <span class="token key atrule">About</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> /about
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>user<span class="token punctuation">-</span>circle<span class="token punctuation">-</span>o
  <span class="token key atrule">Friends</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> /friends
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>address<span class="token punctuation">-</span>book
  <span class="token key atrule">Medias</span><span class="token punctuation">:</span>
    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>list
    <span class="token key atrule">children</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Music
        <span class="token key atrule">url</span><span class="token punctuation">:</span> /music
        <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>music
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Movies
        <span class="token key atrule">url</span><span class="token punctuation">:</span> /movies
        <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>film
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Books
        <span class="token key atrule">url</span><span class="token punctuation">:</span> /books
        <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>book
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Galleries
        <span class="token key atrule">url</span><span class="token punctuation">:</span> /galleries
        <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>image<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="文章-Front-matter-介绍">文章 Front-matter 介绍</h3>
<h3 id="Front-matter-选项详解">Front-matter 选项详解</h3>
<p><code>Front-matter</code> 选项中的所有内容均为<strong>非必填</strong>的。但仍然建议至少填写 <code>title</code> 和 <code>date</code> 的值。</p>
<table>
<thead>
<tr>
<th>配置选项</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>title</td>
<td><code>Markdown</code> 的文件标题</td>
<td>文章标题，强烈建议填写此选项</td>
</tr>
<tr>
<td>date</td>
<td>文件创建时的日期时间</td>
<td>发布时间，强烈建议填写此选项，且最好保证全局唯一</td>
</tr>
<tr>
<td>author</td>
<td>根 <code>_config.yml</code> 中的 <code>author</code></td>
<td>文章作者</td>
</tr>
<tr>
<td>img</td>
<td><code>featureImages</code> 中的某个值</td>
<td>文章特征图，推荐使用图床(腾讯云、七牛云、又拍云等)来做图片的路径.如: <code>http://xxx.com/xxx.jpg</code></td>
</tr>
<tr>
<td>top</td>
<td><code>true</code></td>
<td>推荐文章（文章是否置顶），如果 <code>top</code> 值为 <code>true</code>，则会作为首页推荐文章</td>
</tr>
<tr>
<td>hide</td>
<td><code>false</code></td>
<td>隐藏文章，如果<code>hide</code>值为<code>true</code>，则文章不会在首页显示</td>
</tr>
<tr>
<td>cover</td>
<td><code>false</code></td>
<td><code>v1.0.2</code>版本新增，表示该文章是否需要加入到首页轮播封面中</td>
</tr>
<tr>
<td>coverImg</td>
<td>无</td>
<td><code>v1.0.2</code>版本新增，表示该文章在首页轮播封面需要显示的图片路径，如果没有，则默认使用文章的特色图片</td>
</tr>
<tr>
<td>password</td>
<td>无</td>
<td>文章阅读密码，如果要对文章设置阅读验证密码的话，就可以设置 <code>password</code> 的值，该值必须是用 <code>SHA256</code> 加密后的密码，防止被他人识破。前提是在主题的 <code>config.yml</code> 中激活了 <code>verifyPassword</code> 选项</td>
</tr>
<tr>
<td>toc</td>
<td><code>true</code></td>
<td>是否开启 TOC，可以针对某篇文章单独关闭 TOC 的功能。前提是在主题的 <code>config.yml</code> 中激活了 <code>toc</code> 选项</td>
</tr>
<tr>
<td>mathjax</td>
<td><code>false</code></td>
<td>是否开启数学公式支持 ，本文章是否开启 <code>mathjax</code>，且需要在主题的 <code>_config.yml</code> 文件中也需要开启才行</td>
</tr>
<tr>
<td>summary</td>
<td>无</td>
<td>文章摘要，自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要</td>
</tr>
<tr>
<td>categories</td>
<td>无</td>
<td>文章分类，本主题的分类表示宏观上大的分类，只建议一篇文章一个分类</td>
</tr>
<tr>
<td>tags</td>
<td>无</td>
<td>文章标签，一篇文章可以多个标签</td>
</tr>
<tr>
<td>keywords</td>
<td>文章标题</td>
<td>文章关键字，SEO 时需要</td>
</tr>
<tr>
<td>reprintPolicy</td>
<td>cc_by</td>
<td>文章转载规则， 可以是 cc_by, cc_by_nd, cc_by_sa, cc_by_nc, cc_by_nc_nd, cc_by_nc_sa, cc0, noreprint 或 pay 中的一个</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>注意</strong>:</p>
<ol>
<li>如果 <code>img</code> 属性不填写的话，文章特色图会根据文章标题的 <code>hashcode</code> 的值取余，然后选取主题中对应的特色图片，从而达到让所有文章都的特色图<strong>各有特色</strong>。</li>
<li><code>date</code> 的值尽量保证每篇文章是唯一的，因为本主题中 <code>Gitalk</code> 和 <code>Gitment</code> 识别 <code>id</code> 是通过 <code>date</code> 的值来作为唯一标识的。</li>
<li>如果要对文章设置阅读验证密码的功能，不仅要在 Front-matter 中设置采用了 SHA256 加密的 password 的值，还需要在主题的 <code>_config.yml</code> 中激活了配置。有些在线的 SHA256 加密的地址，可供使用：<a target="_blank" rel="noopener" href="http://tool.oschina.net/encrypt?type=2">开源中国在线工具</a>、<a target="_blank" rel="noopener" href="http://encode.chahuo.com/">chahuo</a>、<a target="_blank" rel="noopener" href="http://tool.chinaz.com/tools/hash.aspx">站长工具</a>。</li>
</ol>
</blockquote>
<p>以下为文章的 <code>Front-matter</code> 示例。</p>
<h4 id="最简示例">最简示例</h4>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">title</span><span class="token punctuation">:</span> 基于Hexo的hexo<span class="token punctuation">-</span>theme<span class="token punctuation">-</span>matery主题搭建博客并优化
<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2019-10-03 14:25:00</span>
<span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="最全示例">最全示例</h4>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">title</span><span class="token punctuation">:</span> 基于Hexo的hexo<span class="token punctuation">-</span>theme<span class="token punctuation">-</span>matery主题搭建博客并优化
<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2019-12-30 09:25:00</span>
<span class="token key atrule">author</span><span class="token punctuation">:</span> 17lai.site
<span class="token key atrule">img</span><span class="token punctuation">:</span> /medias/cover/hexo.jpg
<span class="token key atrule">top</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">cover</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">coverImg</span><span class="token punctuation">:</span> /medias/cover/hexo.jpg
<span class="token key atrule">password</span><span class="token punctuation">:</span> 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92
<span class="token key atrule">toc</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">mathjax</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">summary</span><span class="token punctuation">:</span> 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要
<span class="token key atrule">categories</span><span class="token punctuation">:</span> Hexo
<span class="token key atrule">keywords</span><span class="token punctuation">:</span> Hexo GitHub blog
<span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Hexo
  <span class="token punctuation">-</span> Blog
  <span class="token punctuation">-</span> GitHub
<span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="新建文章模板修改">新建文章模板修改</h3>
<p>首先为了新建文章方便，我们可以修改一下文章模板，建议将<code>/scaffolds/post.md</code>修改为如下代码：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> title <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> date <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">author</span><span class="token punctuation">:</span> 
<span class="token key atrule">img</span><span class="token punctuation">:</span> 
<span class="token key atrule">coverImg</span><span class="token punctuation">:</span> 
<span class="token key atrule">top</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">cover</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">toc</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">mathjax</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">password</span><span class="token punctuation">:</span>
<span class="token key atrule">summary</span><span class="token punctuation">:</span>
<span class="token key atrule">tags</span><span class="token punctuation">:</span>
<span class="token key atrule">categories</span><span class="token punctuation">:</span>
<span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样新建文章后 一些<code>Front-matter</code>参数不用你自己补充了，修改对应信息就可以了。</p>
<h3 id="代码高亮">代码高亮</h3>
<p>由于 Hexo 自带的代码高亮主题显示不好看，所以主题中使用到了 <a target="_blank" rel="noopener" href="https://github.com/ele828/hexo-prism-plugin">hexo-prism-plugin</a> 的 Hexo 插件来做代码高亮，安装命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i -S hexo-prism-plugin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后，修改 Hexo 根目录下 <code>_config.yml</code> 文件中 <code>highlight.enable</code> 的值为 <code>false</code>，并新增 <code>prism</code> 插件相关的配置，主要配置如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">highlight</span><span class="token punctuation">:</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token key atrule">prism_plugin</span><span class="token punctuation">:</span>
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"preprocess"</span> <span class="token comment"># realtime/preprocess</span>
  <span class="token key atrule">theme</span><span class="token punctuation">:</span> <span class="token string">"tomorrow"</span>
  <span class="token key atrule">line_number</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># default false</span>
  custom_css<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="添加文章搜索功能">添加文章搜索功能</h3>
<p>本主题中还使用到了 <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search">hexo-generator-search</a> 的 Hexo 插件来做内容搜索，安装命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-generator-search --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在 Hexo 根目录下的 <code>_config.yml</code> 文件中，新增以下的配置项：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">search</span><span class="token punctuation">:</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> search.xml
  <span class="token key atrule">field</span><span class="token punctuation">:</span> post<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="修改页脚">修改页脚</h3>
<p>页脚信息可能需要做定制化修改，而且它不便于做成配置信息，所以可能需要你自己去再修改和加工。修改的地方在主题文件的 <code>/layout/_partial/footer.ejs</code> 文件中，包括站点、使用的主题、访问量等。</p>
<h3 id="修改社交链接">修改社交链接</h3>
<p>在主题的 <code>_config.yml</code> 文件中，默认支持 <code>QQ</code>、<code>GitHub</code> 和邮箱的配置，可以在主题文件的 <code>/layout/_partial/social-link.ejs</code> 文件中，新增、修改需要的社交链接地址，增加链接可参考如下代码：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span>
  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://github.com/blinkfox<span class="token punctuation">"</span></span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tooltipped<span class="token punctuation">"</span></span>
  <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span>
  <span class="token attr-name">data-tooltip</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>访问我的GitHub<span class="token punctuation">"</span></span>
  <span class="token attr-name">data-position</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>top<span class="token punctuation">"</span></span>
  <span class="token attr-name">data-delay</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span>
<span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fa fa-github<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中，社交图标（如：<code>fa-github</code>）可以在 <a target="_blank" rel="noopener" href="https://fontawesome.com/icons">Font Awesome</a> 中搜索找到。以下是常用社交图标的标识，供参考：</p>
<ul>
<li>Facebook: <code>fa-facebook</code></li>
<li>Twitter: <code>fa-twitter</code></li>
<li>Google-plus: <code>fa-google-plus</code></li>
<li>Linkedin: <code>fa-linkedin</code></li>
<li>Tumblr: <code>fa-tumblr</code></li>
<li>Medium: <code>fa-medium</code></li>
<li>Slack: <code>fa-slack</code></li>
<li>新浪微博: <code>fa-weibo</code></li>
<li>微信: <code>fa-wechat</code></li>
<li>QQ: <code>fa-qq</code></li>
</ul>
<h3 id="修改打赏的二维码图片">修改打赏的二维码图片</h3>
<p>在主题文件的 <code>source/medias/reward</code> 文件中，可以替换成你的的微信和支付宝的打赏二维码图片。</p>
<h3 id="配置文章基本信息">配置文章基本信息</h3>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">new_post_name</span><span class="token punctuation">:</span> <span class="token punctuation">:</span>title.md   <span class="token comment"># 新文章的文件名称</span>
<span class="token key atrule">default_layout</span><span class="token punctuation">:</span> post       <span class="token comment"># 预设布局</span>
<span class="token key atrule">auto_spacing</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>        <span class="token comment"># 在中文和英文之间加入空格</span>
<span class="token key atrule">titlecase</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>           <span class="token comment"># 把标题转换为 title case</span>
<span class="token key atrule">external_link</span><span class="token punctuation">:</span>             <span class="token comment"># 在新标签中打开链接</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>             <span class="token comment"># 在新标签中打开链接</span>
  <span class="token key atrule">field</span><span class="token punctuation">:</span>                   <span class="token comment"># 对整个网站（site）生效或仅对文章（post）生效</span>
  <span class="token key atrule">exclude</span><span class="token punctuation">:</span>                 <span class="token comment"># 需要排除的域名。主域名和子域名如 www 需分别配置	[]</span>
<span class="token key atrule">filename_case</span><span class="token punctuation">:</span> <span class="token number">0</span>           <span class="token comment"># 把文件名称转换为 (1) 小写或 (2) 大写</span>
<span class="token key atrule">render_drafts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>       <span class="token comment"># 显示草稿，默认为：false</span>
<span class="token key atrule">post_asset_folder</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token comment"># 启动 Asset 文件夹</span>
<span class="token key atrule">relative_link</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>       <span class="token comment"># 把链接改为与根目录的相对位址</span>
<span class="token key atrule">future</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>               <span class="token comment"># 显示未来的文章</span>
<span class="token key atrule">highlight</span><span class="token punctuation">:</span>                 <span class="token comment"># 代码块的设置</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>            <span class="token comment"># 开启代码块高亮</span>
  <span class="token key atrule">line_number</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>       <span class="token comment"># 显示行数</span>
  <span class="token key atrule">auto_detect</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>       <span class="token comment"># 如果未指定语言，则启用自动检测</span>
  <span class="token key atrule">tab_replace</span><span class="token punctuation">:</span>             <span class="token comment"># 用 n 个空格替换 tabs；如果值为空，则不会替换 tabs</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="配置代码高亮及样式">配置代码高亮及样式</h3>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">highlight</span><span class="token punctuation">:</span>                      <span class="token comment"># 代码块的设置</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>                 <span class="token comment"># 开启代码块高亮</span>
  <span class="token key atrule">line_number</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>             <span class="token comment"># 显示行数</span>
  <span class="token key atrule">auto_detect</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>            <span class="token comment"># 如果未指定语言，则启用自动检测</span>
  <span class="token key atrule">tab_replace</span><span class="token punctuation">:</span> <span class="token string">''</span>               <span class="token comment"># 用 n 个空格替换 tabs；如果值为空，则不会替换 tabs</span>
  <span class="token key atrule">wrap</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hljs</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">prismjs</span><span class="token punctuation">:</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">preprocess</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">line_number</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">tab_replace</span><span class="token punctuation">:</span> <span class="token string">''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置代码的样式</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">code</span><span class="token punctuation">:</span>
  <span class="token key atrule">lang</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>     <span class="token comment"># 代码块是否显示名称</span>
  <span class="token key atrule">copy</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>     <span class="token comment"># 代码块是否可复制</span>
  <span class="token key atrule">shrink</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 代码块是否可以收缩</span>
  <span class="token key atrule">break</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>   <span class="token comment"># 代码是否折行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="配置是否启用转载限制模块">配置是否启用转载限制模块</h3>
<pre class="line-numbers language-YAML" data-language="YAML"><code class="language-YAML">reprint:
  enable: false   #是否启用“转载规则限定模块”
  default: cc_by<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>文章转载规则，可以是 <code>cc_by</code>, <code>cc_by_nd</code>, <code>cc_by_sa</code>, <code>cc_by_nc</code>, <code>cc_by_nc_nd</code>, <code>cc_by_nc_sa</code>, <code>cc0</code>, <code>noreprint</code> 或 <code>pay</code> 中的一个</p>
<h3 id="配置文章阅读密码功能">配置文章阅读密码功能</h3>
<p>阅读文章的密码验证功能，如要使用此功能请激活该配置项，并在对应文章的 <code>Front-matter</code> 中写上 <code>password</code> 的键和加密后的密文即可。</p>
<blockquote>
<p>请注意：为了保证密码原文不会被泄露到网页中，文章的密码必须是通过 <code>SHA256</code> 加密的，这样就不会被破解。</p>
</blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">verifyPassword</span><span class="token punctuation">:</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">promptMessage</span><span class="token punctuation">:</span> 请输入访问本文章的密码
  <span class="token key atrule">errorMessage</span><span class="token punctuation">:</span>  密码错误，将返回主页！<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="如何一键部署hexo">如何一键部署hexo</h3>
<p>通过 <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo-deployer-git">hexo-deployer-git</a> 插件可以实现一键将博客同时部署到多个 git 仓库中。如同时发布到 github 及 gitee 提供的 pages 服务。安装：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-deployer-git --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>修改 Hexo 根目录下的 <code>_config.yml</code> 文件中的如下内容:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">## Docs: https://hexo.io/docs/deployment.html</span>
<span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> git
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/lxl80/blog.git
    <span class="token key atrule">branch</span><span class="token punctuation">:</span> gh<span class="token punctuation">-</span>pages
    <span class="token key atrule">ignore_hidden</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> git
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//gitee.com/lxl80/lxl80.git
    <span class="token key atrule">branch</span><span class="token punctuation">:</span> master
    <span class="token key atrule">ignore_hidden</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>也可以如本站一样，采用 <a target="_blank" rel="noopener" href="https://github.com/75k/hexo-deployer-cos-enhanced">hexo-deployer-cos-enhanced</a> 插件将静态内容部署到腾讯云对象存储服务中，在 DNS 配置中将境内线路解析到腾讯云 CDN 地址，实现加速。部署完成后会自动刷新被更新文件的 CDN 缓存。</p>
</blockquote>
<p>安装：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-deployer-cos-enhanced --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>_config.yml</code> 配置如下:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> git
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/lxl80/blog.git
    <span class="token key atrule">branch</span><span class="token punctuation">:</span> gh<span class="token punctuation">-</span>pages
    <span class="token key atrule">ignore_hidden</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> cos
    <span class="token key atrule">bucket</span><span class="token punctuation">:</span> lxl80<span class="token punctuation">-</span>130<span class="token important">****</span>
    <span class="token key atrule">region</span><span class="token punctuation">:</span> ap<span class="token punctuation">-</span>beijing
    <span class="token key atrule">secretId</span><span class="token punctuation">:</span> AKIDh9<span class="token important">****F8FvL</span>
    <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> Z3IGiur<span class="token important">****QZR3PgjXmlVg</span>
    <span class="token key atrule">cdnConfig</span><span class="token punctuation">:</span>
      <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">cdnUrl</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//static.lixl.cn
      <span class="token key atrule">bucket</span><span class="token punctuation">:</span> static<span class="token punctuation">-</span>130<span class="token important">****</span>
      <span class="token key atrule">region</span><span class="token punctuation">:</span> ap<span class="token punctuation">-</span>beijing
      <span class="token key atrule">folder</span><span class="token punctuation">:</span> static
      <span class="token key atrule">secretId</span><span class="token punctuation">:</span> AKIDh9<span class="token important">****F8FvL</span>
      <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> Z3IGiur<span class="token important">****QZR3PgjXmlVg</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后通过 <code>hexo g -d</code> 即可实现一键发布，并更新 CDN 缓存。</p>
<h3 id="文章链接转静态短地址（可选的）">文章链接转静态短地址（可选的）</h3>
<p>如果文章名称是中文的，那么 Hexo 默认生成的永久链接也会有中文，这样不利于 <code>SEO</code>，且 <code>gitment</code> 评论对中文链接也不支持。我们可以用 <a target="_blank" rel="noopener" href="https://github.com/viko16/hexo-permalink-pinyin">hexo-permalink-pinyin</a> Hexo 插件生成文章时生成中文拼音的永久链接，或者用<a target="_blank" rel="noopener" href="https://github.com/rozbo/hexo-abbrlink">hexo-abbrlink</a> 生成静态文章链接。以下结合 hexo-abbrlink 生成类似 <code>/yyyy/mmdd+随机数.html</code> 的文章链接地址。</p>
<p>安装命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-abbrlink --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在 Hexo 根目录下的 <code>_config.yml</code> 文件中，修改 <code>permalink:</code> ，并在文件末尾新增 <code>abbrlink:</code>配置项：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">permalink</span><span class="token punctuation">:</span> <span class="token punctuation">:</span>year/<span class="token punctuation">:</span>month<span class="token punctuation">:</span>day<span class="token punctuation">:</span>abbrlink.html

<span class="token key atrule">abbrlink</span><span class="token punctuation">:</span>
  <span class="token key atrule">alg</span><span class="token punctuation">:</span> crc16 <span class="token comment">#算法选项：crc16丨crc32</span>
  <span class="token key atrule">rep</span><span class="token punctuation">:</span> dec <span class="token comment">#输出进制：dec为十进制，hex为十六进制</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="添加-emoji-表情支持（可选的）">添加 emoji 表情支持（可选的）</h3>
<p>Matery主题新增了对 <code>emoji</code> 表情的支持，使用到了 <a target="_blank" rel="noopener" href="https://npm.taobao.org/package/hexo-filter-github-emojis">hexo-filter-github-emojis</a> 的 Hexo 插件来支持 <code>emoji</code> 表情的生成，把对应的 <code>markdown emoji</code> 语法（<code>::</code>, 例如：<code>:smile:</code>）转变成会跳跃的 <code>emoji</code> 表情，安装命令如下</p>
<pre class="line-numbers language-none"><code class="language-none">npm install hexo-filter-github-emojis --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在 博客根目录下的 <code>_config.yml</code> 文件中，新增以下的配置项：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">githubEmojis</span><span class="token punctuation">:</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">className</span><span class="token punctuation">:</span> github<span class="token punctuation">-</span>emoji
  <span class="token key atrule">inject</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">styles</span><span class="token punctuation">:</span>
  customEmojis<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行 <code>hexo clean &amp;&amp; hexo g</code> 重新生成博客文件，然后就可以在文章中对应位置看到你用 <code>emoji</code> 语法写的表情了。</p>
<h3 id="文章字数统计插件">文章字数统计插件</h3>
<p>如果你想要在文章中显示文章字数、阅读时长信息，可以安装 <a target="_blank" rel="noopener" href="https://github.com/willin/hexo-wordcount">hexo-wordcount</a>插件。</p>
<p>安装命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i --save hexo-wordcount<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后只需在本主题下的 <code>_config.yml</code> 文件中，激活以下配置项即可：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">wordCount</span><span class="token punctuation">:</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 将这个值设置为 true 即可.</span>
  <span class="token key atrule">postWordCount</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">min2read</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">totalCount</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="添加-RSS-订阅支持">添加 RSS 订阅支持</h3>
<p>本主题中还使用到了 <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo-generator-feed">hexo-generator-feed</a> 的 Hexo 插件来做 <code>RSS</code>，安装命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-generator-feed --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在 Hexo 根目录下的 <code>_config.yml</code> 文件中，新增以下的配置项：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feed</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> atom
  <span class="token key atrule">path</span><span class="token punctuation">:</span> atom.xml
  <span class="token key atrule">limit</span><span class="token punctuation">:</span> <span class="token number">20</span>
  <span class="token key atrule">hub</span><span class="token punctuation">:</span>
  <span class="token key atrule">content</span><span class="token punctuation">:</span>
  <span class="token key atrule">content_limit</span><span class="token punctuation">:</span> <span class="token number">140</span>
  <span class="token key atrule">content_limit_delim</span><span class="token punctuation">:</span> <span class="token string">" "</span>
  <span class="token key atrule">order_by</span><span class="token punctuation">:</span> <span class="token punctuation">-</span>date<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行 <code>hexo clean &amp;&amp; hexo g</code> 重新生成博客文件，然后在 <code>public</code> 文件夹中即可看到 <code>atom.xml</code> 文件，说明已经安装成功了。</p>
<h3 id="增加百度统计功能">增加百度统计功能</h3>
<p>首先注册<a target="_blank" rel="noopener" href="https://tongji.baidu.com/"><strong>百度统计站长版</strong></a>，登陆后点击 新增网站，然后直接输入你的博客地址例如： https://blog.17lai.site，网站域名 和 网站首页 都写这个，网站名称 可以填 我的博客，<br>
行业类别： 博客—空间周边。</p>
<p>然后点击左侧菜单的 代码获取，找到</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">hm<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">"https://hm.baidu.com/hm.js?……"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>问号后的这一段十六进制代码<br>
复制下来，粘贴到 主题配置文件 中的baidu_analytics:后面，注意冒号和值之间要有一个空格，然后将该字段前面的#号删除代表启用此功能。保存后即可</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Add baidu analytics configuration</span>
<span class="token comment"># 添加 baidu Analytics 配置</span>
<span class="token key atrule">baiduAnalytics</span><span class="token punctuation">:</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">id</span><span class="token punctuation">:</span> f614xxxxxxxxxxxxxxxx05d25e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Leancloud-Valine打造Hexo个人博客极简评论系统"><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Timesi/p/9556236.html">Leancloud+Valine打造Hexo个人博客极简评论系统</a></h3>
<h4 id="Leancloud配置">Leancloud配置</h4>
<p>首先访问Leancloud官网<code>https://leancloud.cn/</code><br>
有Github账号的小伙伴可以用Github账号进行登陆然后绑定邮箱就可以啦！<br>
进入之后点击创建应用<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1120210911134958.png" alt=""><br>
这样我们就创建好啦！<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1120210911135007.png" alt=""><br>
接着点击应用右上角的设置进入设置界面<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1120210911135013.png" alt=""><br>
选择应用key，这样就可以看到我们接下来需要使用到的key<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1120210911135020.png" alt=""><br>
接着进入应用中心绑定你的个人博客域名<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1120210911135027.png" alt=""></p>
<h4 id="Valine配置">Valine配置</h4>
<p>然后我们去主题配置文件中进行修改<br>
主题配置文件路径：<code>matery_config.yml</code><br>
找到以下参数进行修改</p>
<pre class="line-numbers language-none"><code class="language-none"># Valine.
# You can get your appid and appkey from https://leancloud.cn
# more info please open https://valine.js.org
valine:
  enable: true //打开valine评论功能
  appid: 你的leancloud appid 
  appkey: 你的leancloud appkey 
  notify: false //邮件提醒
  verify: true //评论时是否有验证码，需要在Leancloud 设置-&gt;安全中心 中打开
  placeholder: 说点什么吧！ //评论框默认显示
  avatar: hide //评论者的头像,我这里设置的不显示
  guest_info: nick # custom comment header
  pageSize: 10 # pagination size<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>PS：评论者头像可以进行如下设置<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1120210911135034.png" alt=""></p>
<p>到此，一个极简评论系统就完成啦！</p>
<h2 id="自定制修改">自定制修改</h2>
<p>在本主题的 <code>_config.yml</code> 中可以修改部分自定义信息，有以下几个部分：</p>
<ul>
<li>菜单</li>
<li>我的梦想</li>
<li>首页的音乐播放器和视频播放器配置</li>
<li>是否显示推荐文章名称和按钮配置</li>
<li><code>favicon</code> 和 <code>Logo</code></li>
<li>个人信息</li>
<li>TOC 目录</li>
<li>文章打赏信息</li>
<li>复制文章内容时追加版权信息</li>
<li>MathJax</li>
<li>文章字数统计、阅读时长</li>
<li>点击页面的’爱心’效果</li>
<li>我的项目</li>
<li>我的技能</li>
<li>我的相册</li>
<li><code>Gitalk</code>、<code>Gitment</code>、<code>Valine</code> 和 <code>disqus</code> 评论配置</li>
<li><a target="_blank" rel="noopener" href="https://busuanzi.ibruce.info/">不蒜子统计</a>和谷歌分析（<code>Google Analytics</code>）</li>
<li>默认特色图的集合。当文章没有设置特色图时，本主题会根据文章标题的 <code>hashcode</code> 值取余，来选择展示对应的特色图</li>
</ul>
<p>如果本主题中的诸多功能和主题色彩你不满意，可以在主题中自定义修改，很多更自由的功能和细节点的修改难以在主题的 <code>_config.yml</code> 中完成，需要修改源代码才来完成。以下列出了可能有用的地方：</p>
<h3 id="更换字体">更换字体</h3>
<p>一般网站的web字体都可以直接从<a target="_blank" rel="noopener" href="https://fonts.google.com/">Google-Font</a>获取资源，这样不用担心字体商业带来的法律问题。</p>
<p>常见的开源字体有：</p>
<p>思源黑体 、 文泉驿 、 文鼎开放字体 、 柳体 、 cwTeX中文字体 、 濑户字体、江西拙楷体等。</p>
<p>1）创建web字体引用</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token atrule"><span class="token rule">@font-face</span></span><span class="token punctuation">{</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'引用的字体名称'</span><span class="token punctuation">;</span>
    <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">'谷歌字体路径（或者其他什么字体引用）'</span><span class="token punctuation">)</span></span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）在网页合适的位置进行字体引用</p>
<p>①利用浏览器检查元素，获取需要定义字体的部分</p>
<p>②在主体的配置文件中(hexo-theme-matery/layout/…)找到对应的渲染(.ejs)文件，查找需要修改的部分</p>
<p>①演示一下利用浏览器获取定义字体的部分</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1720211017105637.jpeg" alt=""></p>
<p>对获取到的<code>id选择器：#artDetail</code>进行css渲染</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">#artDetail</span> <span class="token punctuation">{</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'引用的web字体'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>②利用主体的ejs渲染文件找出需要修饰的部分（加入自定义类）</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1720211017105631.jpeg" alt=""></p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/*使用我在文章内容详情定义的diyFnot类**/</span>
<span class="token selector">.diyfont</span> <span class="token punctuation">{</span>
   <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'引用的web字体'</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token comment">/*也可以使用自带的id*/</span>
<span class="token selector">#artDetail</span> <span class="token punctuation">{</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'引用的web字体'</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="网站全局化字体定义">网站全局化字体定义</h4>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token atrule"><span class="token rule">@font-face</span></span><span class="token punctuation">{</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'引用的字体名称'</span><span class="token punctuation">;</span>
    <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">'谷歌字体路径（或者其他什么字体引用）'</span><span class="token punctuation">)</span></span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>

<span class="token selector">body</span> <span class="token punctuation">{</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'引用的web字体名称'</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="引用本地的字体文件">引用本地的字体文件</h4>
<p>当然有时候那个谷歌字体的网站可能登录不上去，需要科学上网，很烦人！我们也可以直接下载下字体文件，将他放在本地，进行直接引用！看下面操作👇</p>
<p>①在本地的hexo根目录的source文件下创立diy-font文件夹:<code>/source/diy-font</code></p>
<p>在该文件下存放你的字体文件，比如：<code>/source/diy-font/IBMPlexMono-Italic.ttf</code></p>
<p>②引用本地字体（仍然是在my.css文件中书写代码）</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token atrule"><span class="token rule">@font-face</span></span><span class="token punctuation">{</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'hl'</span><span class="token punctuation">;</span>
    <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">'../diy-font/IBMPlexMono-Italic.ttf'</span><span class="token punctuation">)</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 表示全局使用，如果不想全局使用不要添加该段 */</span>
<span class="token selector">body</span><span class="token punctuation">{</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'hl'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/* 可以局部使用，建议添加 */</span>
<span class="token selector">.diyFont</span><span class="token punctuation">{</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'hl'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样我们就可以实现引用本地的字体了，并且在web有效！</p>
<p>在你想要使用的元素的 <code>class</code> 里面加上 <code>diyFont</code> 即可。</p>
<ul>
<li>
<p>直接使用</p>
<p>F12，找到对应的代码片段即可：</p>
</li>
</ul>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logo-span diyFont<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>测试字体<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>
<p>模板使用</p>
<p>找到对应的模板 <code>header.ejs</code>中的代码片段使用即可：</p>
</li>
</ul>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logo-span diyFont<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>&lt;%= config.title %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="修改主题颜色">修改主题颜色</h3>
<p>在主题文件的 <code>/source/css/matery.css</code> 文件中，搜索 <code>.bg-color</code> 来修改背景颜色：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* 整体背景颜色，包括导航、移动端的导航、页尾、标签页等的背景颜色. */</span>
<span class="token selector">.bg-color</span> <span class="token punctuation">{</span>
  <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">linear-gradient</span><span class="token punctuation">(</span>to right<span class="token punctuation">,</span> #4cbf30 0%<span class="token punctuation">,</span> #0f9d58 100%<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token atrule"><span class="token rule">@-webkit-keyframes</span> rainbow</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 动态切换背景颜色. */</span>
<span class="token punctuation">}</span>

<span class="token atrule"><span class="token rule">@keyframes</span> rainbow</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 动态切换背景颜色. */</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="修改-banner-图和文章特色图">修改 banner 图和文章特色图</h3>
<p>可以直接在 <code>/source/medias/banner</code> 文件夹中更换喜欢的 <code>banner</code> 图片，主题代码中是每天动态切换一张，只需 <code>7</code> 张即可。如果会 <code>JavaScript</code> 代码，可以修改成自己喜欢切换逻辑，如：随机切换等，<code>banner</code> 切换的代码位置在 <code>/layout/_partial/bg-cover-content.ejs</code> 文件的 <code>&lt;script&gt;&lt;/script&gt;</code> 代码中：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".bg-cover"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">"background-image"</span><span class="token punctuation">,</span> <span class="token string">"url(/medias/banner/"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".jpg)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在 <code>/source/medias/featureimages</code> 文件夹中默认有 24 张特色图片，你可以再增加或者减少，并需要在 <code>_config.yml</code> 做同步修改。</p>
<h3 id="Hexo-跳过渲染">Hexo 跳过渲染</h3>
<p>在Hexo部署时会默认渲染source下的所有html页面，但有时候想在Hexo博客上单独自定义html页面或README.md时，却不希望被Hexo渲染。因此对某个文件或者目录进行排除渲染是非常必要的。</p>
<h4 id="方法一：font-matter">方法一：font matter</h4>
<p><code>Hexo</code>新建网站页面，然后将你的代码直接写入 <code>index.md</code> 中</p>
<p>在 <code>Front matter</code> 中添加 <code>layout: false</code>，此方法适用于单一的纯<code>HTML</code><br>
<code>CSS</code> 页面。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">---
title: tools
date: <span class="token number">2020</span>-04-28 00:00:00
type: <span class="token string">"tools"</span>
layout: <span class="token boolean">false</span>
---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="0x003-方法二：skip-rende">0x003 方法二：skip rende</h4>
<p>在博客根目录下的 <code>_config.yml</code>，找到 <code>skip_render</code>，大概在32行左右，写入你想要的跳过渲染的路径，注意缩进和空格。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 指定目录跳过hexo渲染</span>
skip_render:
  - <span class="token string">'tools/*'</span>
  - <span class="token string">'tools/**'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>注释：<code>tools/*</code> 表示在目录 <code>source/fireworks</code> 下的文件全部跳过渲染，<code>tools/**</code> 表示在博客根目录 <code>source/tools/</code> 文件夹下的文件全部跳过渲染（例如页面的 js、css 在另一个文件夹中）。</p>
</blockquote>
<h3 id="hexo体积压缩">hexo体积压缩</h3>
<p>减小体积，加快加载速度</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> gulp -g
$ <span class="token function">npm</span> <span class="token function">install</span> gulp-minify-css gulp-uglify gulp-htmlmin gulp-htmlclean gulp --save
 
或者使用yarn 
 
<span class="token function">yarn</span> global <span class="token function">add</span> gulp
<span class="token function">yarn</span> <span class="token function">add</span> gulp-minify-css gulp-uglify gulp-htmlmin gulp-htmlclean gulp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，在根目录新增 <code>gulpfile.js</code> :</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"> 
var gulp = require('gulp');
var minifycss = require('gulp<span class="token punctuation">-</span>minify<span class="token punctuation">-</span>css');
var uglify = require('gulp<span class="token punctuation">-</span>uglify');
var htmlmin = require('gulp<span class="token punctuation">-</span>htmlmin');
var htmlclean = require('gulp<span class="token punctuation">-</span>htmlclean');
// 压缩 public 目录 css
gulp.task('minify<span class="token punctuation">-</span>css'<span class="token punctuation">,</span> function() <span class="token punctuation">{</span>
    return gulp.src('./public/<span class="token important">**/*.css')</span>
        .pipe(minifycss())
        .pipe(gulp.dest('./public'));
<span class="token punctuation">}</span>);
// 压缩 public 目录 html
gulp.task('minify<span class="token punctuation">-</span>html'<span class="token punctuation">,</span> function() <span class="token punctuation">{</span>
  return gulp.src('./public/<span class="token important">**/*.html')</span>
    .pipe(htmlclean())
    .pipe(htmlmin(<span class="token punctuation">{</span>
         <span class="token key atrule">removeComments</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
         <span class="token key atrule">minifyJS</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
         <span class="token key atrule">minifyCSS</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
         <span class="token key atrule">minifyURLs</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>))
    .pipe(gulp.dest('./public'))
<span class="token punctuation">}</span>);
// 压缩 public/js 目录 js
gulp.task('minify<span class="token punctuation">-</span>js'<span class="token punctuation">,</span> function() <span class="token punctuation">{</span>
    return gulp.src('./public/<span class="token important">**/*.js')</span>
        .pipe(uglify())
        .pipe(gulp.dest('./public'));
<span class="token punctuation">}</span>);
// 执行 gulp 命令时执行的任务
// gulp 3.x
// gulp.task('default'<span class="token punctuation">,</span> <span class="token punctuation">[</span>
//     'minify<span class="token punctuation">-</span>html'<span class="token punctuation">,</span><span class="token string">'minify-css'</span><span class="token punctuation">,</span><span class="token string">'minify-js'</span>
// <span class="token punctuation">]</span>);

// gulp 4.x
gulp.task('default'<span class="token punctuation">,</span> gulp.series('minify<span class="token punctuation">-</span>html'<span class="token punctuation">,</span> <span class="token string">'minify-css'</span><span class="token punctuation">,</span> <span class="token string">'minify-js'</span><span class="token punctuation">,</span> done =<span class="token punctuation">&gt;</span> done()));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo clean <span class="token operator">&amp;&amp;</span> hexo g <span class="token operator">&amp;&amp;</span> gulp <span class="token operator">&amp;&amp;</span>  hexo g<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="博客中插入音乐">博客中插入音乐</h3>
<h4 id="hexo-tag-aplayer">hexo-tag-aplayer</h4>
<p><a target="_blank" rel="noopener" href="https://github.com/MoePlayer/hexo-tag-aplayer">hexo-tag-aplayer</a><a target="_blank" rel="noopener" href="https://github.com/MoePlayer/APlayer">APlayer</a> 播放器的 Hexo 标签插件（现已支持 <a target="_blank" rel="noopener" href="https://github.com/metowolf/MetingJS">MetingJS</a>）。</p>
<h4 id="安装-4">安装</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save hexo-tag-aplayer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="使用方法——aplayer">使用方法——aplayer</h4>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% aplayer title author url [picture_url, narrow, autoplay, width:xxx, lrc:xxx] %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>title</code> : 曲目标题</li>
<li><code>author</code>: 曲目作者</li>
<li><code>url</code>: 音乐文件 URL 地址</li>
<li><code>picture_url</code>: (可选) 音乐对应的图片地址</li>
<li><code>narrow</code>: （可选）播放器袖珍风格</li>
<li><code>autoplay</code>: (可选) 自动播放，移动端浏览器暂时不支持此功能</li>
<li><code>width:xxx</code>: (可选) 播放器宽度 (默认: 100%)</li>
<li><code>lrc:xxx</code>: （可选）歌词文件 URL 地址<br>
<em><strong>例如：</strong></em></li>
</ul>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% aplayer "她的睫毛" "周杰伦" "http://home.ustc.edu.cn/<span class="token strike"><span class="token punctuation">~</span><span class="token content">mmmwhy/%d6%dc%bd%dc%c2%d7%20-%20%cb%fd%b5%c4%bd%de%c3%ab.mp3"  "http://home.ustc.edu.cn/</span><span class="token punctuation">~</span></span>mmmwhy/jay.jpg" %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果你觉得前面的方法不太好用，可以用下面的方法，使用MetingJS。</p>
<h4 id="使用方法——MetingJS">使用方法——MetingJS</h4>
<p>MetingJS 是基于Meting API 的 APlayer 衍生播放器，支持对于 QQ音乐、网易云音乐、虾米、酷狗、百度等平台的音乐播放。<br>
<strong>第一步：修改_config.yml配置</strong><br>
在hexo的配置文件_config.yml中添加：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">aplayer</span><span class="token punctuation">:</span>
	<span class="token key atrule">meting</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>第二步：使用MetingJS 播放器</strong></p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token comment">&lt;!-- 简单示例 (id, server, type)  --&gt;</span>
{% meting "571184509" "xiami" "playlist" %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>有关的选项列表如下:</p>
<table>
<thead>
<tr>
<th style="text-align:left">选项</th>
<th style="text-align:left">默认值</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">id</td>
<td style="text-align:left"><strong>必须值</strong></td>
<td style="text-align:left">歌曲 id / 播放列表 id / 相册 id / 搜索关键字</td>
</tr>
<tr>
<td style="text-align:left">server</td>
<td style="text-align:left"><strong>必须值</strong></td>
<td style="text-align:left">音乐平台: <code>netease</code>, <code>tencent</code>, <code>kugou</code>, <code>xiami</code>, <code>baidu</code></td>
</tr>
<tr>
<td style="text-align:left">type</td>
<td style="text-align:left"><strong>必须值</strong></td>
<td style="text-align:left"><code>song</code>, <code>playlist</code>, <code>album</code>, <code>search</code>, <code>artist</code></td>
</tr>
<tr>
<td style="text-align:left">fixed</td>
<td style="text-align:left"><code>false</code></td>
<td style="text-align:left">开启固定模式</td>
</tr>
<tr>
<td style="text-align:left">mini</td>
<td style="text-align:left"><code>false</code></td>
<td style="text-align:left">开启迷你模式</td>
</tr>
<tr>
<td style="text-align:left">loop</td>
<td style="text-align:left"><code>all</code></td>
<td style="text-align:left">列表循环模式：<code>all</code>, <code>one</code>,<code>none</code></td>
</tr>
<tr>
<td style="text-align:left">order</td>
<td style="text-align:left"><code>list</code></td>
<td style="text-align:left">列表播放模式： <code>list</code>, <code>random</code></td>
</tr>
<tr>
<td style="text-align:left">volume</td>
<td style="text-align:left">0.7</td>
<td style="text-align:left">播放器音量</td>
</tr>
<tr>
<td style="text-align:left">lrctype</td>
<td style="text-align:left">0</td>
<td style="text-align:left">歌词格式类型</td>
</tr>
<tr>
<td style="text-align:left">listfolded</td>
<td style="text-align:left"><code>false</code></td>
<td style="text-align:left">指定音乐播放列表是否折叠</td>
</tr>
<tr>
<td style="text-align:left">storagename</td>
<td style="text-align:left"><code>metingjs</code></td>
<td style="text-align:left">LocalStorage 中存储播放器设定的键名</td>
</tr>
<tr>
<td style="text-align:left">autoplay</td>
<td style="text-align:left"><code>true</code></td>
<td style="text-align:left">自动播放，移动端浏览器暂时不支持此功能</td>
</tr>
<tr>
<td style="text-align:left">mutex</td>
<td style="text-align:left"><code>true</code></td>
<td style="text-align:left">该选项开启时，如果同页面有其他 aplayer 播放，该播放器会暂停</td>
</tr>
<tr>
<td style="text-align:left">listmaxheight</td>
<td style="text-align:left"><code>340px</code></td>
<td style="text-align:left">播放列表的最大长度</td>
</tr>
<tr>
<td style="text-align:left">preload</td>
<td style="text-align:left"><code>auto</code></td>
<td style="text-align:left">音乐文件预载入模式，可选项： <code>none</code>, <code>metadata</code>, <code>auto</code></td>
</tr>
<tr>
<td style="text-align:left">theme</td>
<td style="text-align:left"><code>#ad7a86</code></td>
<td style="text-align:left">播放器风格色彩设置</td>
</tr>
</tbody>
</table>
<h3 id="博客中插入视频">博客中插入视频</h3>
<h4 id="hexo-tag-dplayer">hexo-tag-dplayer</h4>
<p><a target="_blank" rel="noopener" href="https://github.com/MoePlayer/hexo-tag-dplayer">hexo-tag-dplayer</a> 是 <a target="_blank" rel="noopener" href="https://github.com/MoePlayer/DPlayer">DPlayer</a> 播放器的 Hexo 标签插件</p>
<h4 id="安装-5">安装</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save hexo-tag-dplayer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="使用">使用</h4>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% dplayer key=value ... %}
例：
{% dplayer "url=http://www.nenu.edu.cn/_upload/article/videos/03/5f/7c999eed42e3aadc413d7f851f0e/0f50b3eb-9285-41d2-ac4d-6cc363651aad_B.mp4"  "autoplay=true" "preload=metadata" "hotkey=true" %} <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>有关的选项列表如下:</p>
<table>
<thead>
<tr>
<th style="text-align:left">选项</th>
<th style="text-align:left">默认值</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">url</td>
<td style="text-align:left"><strong>必须值</strong></td>
<td style="text-align:left">视频地址</td>
</tr>
<tr>
<td style="text-align:left">loop</td>
<td style="text-align:left"><code>false</code></td>
<td style="text-align:left">视频循环播放</td>
</tr>
<tr>
<td style="text-align:left">volume</td>
<td style="text-align:left"><code>0.7</code></td>
<td style="text-align:left">播放器音量</td>
</tr>
<tr>
<td style="text-align:left">hotkey</td>
<td style="text-align:left"><code>true</code></td>
<td style="text-align:left">开启热键</td>
</tr>
<tr>
<td style="text-align:left">autoplay</td>
<td style="text-align:left"><code>true</code></td>
<td style="text-align:left">自动播放，移动端浏览器暂时不支持此功能</td>
</tr>
<tr>
<td style="text-align:left">logo</td>
<td style="text-align:left"><code>-</code></td>
<td style="text-align:left">在左上角展示一个 logo，你可以通过 CSS 调整它的大小和位置</td>
</tr>
<tr>
<td style="text-align:left">mutex</td>
<td style="text-align:left"><code>true</code></td>
<td style="text-align:left">该选项开启时，如果同页面有其他播放，该播放器会暂停</td>
</tr>
<tr>
<td style="text-align:left">highlight</td>
<td style="text-align:left"><code>[]</code></td>
<td style="text-align:left">自定义进度条提示点</td>
</tr>
<tr>
<td style="text-align:left">preload</td>
<td style="text-align:left"><code>auto</code></td>
<td style="text-align:left">视频文件预载入模式，可选项： <code>none</code>, <code>metadata</code>, <code>auto</code></td>
</tr>
<tr>
<td style="text-align:left">theme</td>
<td style="text-align:left"><code>#ad7a86</code></td>
<td style="text-align:left">播放器风格色彩设置</td>
</tr>
</tbody>
</table>
<p>注：如果使用腾讯视频、优酷视频等在线视频网站的资源，需要先进行视频地址解析，如<a target="_blank" rel="noopener" href="http://old.flvurl.cn/">点量视频解析</a>，获取到实际的视频地址。</p>
<h4 id="其他使用方法">其他使用方法</h4>
<p>在使用优酷或者腾讯视频时可以直接复制分享代码到文章中，如：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;iframe height=498 width=510 src='https://player.youku.com/embed/XMjk4ODAyMzIyOA==' frameborder=0 'allowfullscreen'&gt;&lt;/iframe&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="参考文献">参考文献</h4>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/MoePlayer/hexo-tag-aplayer/blob/master/docs/README-zh_cn.md#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE30-%E6%96%B0%E5%8A%9F%E8%83%BD">hexo-tag-aplayer</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/MoePlayer/hexo-tag-dplayer">hexo-tag-dplayer</a></li>
</ul>
<h2 id="各种优化">各种优化</h2>
<h3 id="CDN-加速（强烈建议启用）">CDN 加速（强烈建议启用）</h3>
<ul>
<li><strong>为什么强烈建议启用CDN？</strong></li>
</ul>
<blockquote>
<p>研究表明，用户最满意的打开网页时间，是在 2 秒以下。用户能够忍受的最长等待时间在 6～8 秒之间。就是说，8 秒是一个临界值，如果你的网站打开速度在 8 秒以上，那么你将失去大部分用户。研究显示，如果等待 12 秒以后，网页还是没有载入，那么 99% 以上的用户会选择关闭网页。</p>
<p>Google 做过一个试验，10 条搜索结果的页面载入时间需要 0.4 秒，显示 30 条搜索结果的页面载入时间需要 0.9 秒，结果后者使得 Google 总的流量和收入减少了 20%。Google 地图上线的时候，首页大小有 100KB，后来下降到 70~80KB。结果，流量在第一个星期上升了 10%，接下来的 3 个星期又再上升了 25%。Amazon 的统计也显示了相近的结果，首页打开时间每增加 100 毫秒，网站销售量会减少 1%。</p>
<p>以上数据说明了一个非常重要的问题，如果你的网站速度如果超过 2s 以上，那么你的客户可能在流失和离你而去了。这一点对于电商网站尤其重要，打开速度慢，那么将造成转化率降低，损失将会大量增加。</p>
</blockquote>
<p>放在 Github 的资源在国内加载速度比较慢，因此需要使用 CDN 加速来优化网站打开速度，<a target="_blank" rel="noopener" href="https://www.jsdelivr.com/">jsDelivr</a> + Github 便是免费且好用的 CDN，非常适合博客网站使用。也可以选择主流云服务商提供的对象存储+CDN 来获得更快速及稳定的访问效果，费用低到几乎可忽略。</p>
<p><strong>用法：</strong></p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//cdn.jsdelivr.net/gh/你的用户名/你的仓库名@发布的版本号/文件路径</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>例如：</strong></p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//cdn.jsdelivr.net/gh/lxl80/blog@gh-pages/medias/banner/1.jpg</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意：版本号不是必需的，是为了区分新旧资源，如果不使用版本号，将会直接引用最新资源。</p>
<blockquote>
<p>还可以配合 <a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/PicGo">PicGo</a>图床上传工具的<strong>自定义域名前缀</strong>来上传图片，使用极其方便。具体使用方法可参见我的另一篇文章: <a target="_blank" rel="noopener" href="https://www.lixl.cn/2019/120114500.html">使用 Typora+iPic/PicGo 图床+CDN 实现高效 Markdown 创作</a></p>
</blockquote>
<h3 id="Cloudflare-CDN">Cloudflare CDN</h3>
<blockquote>
<p>配置最简单的CDN方式了。在github  raw链接地址前面加<code>https://images.weserv.nl/?url=</code>, 就会自动使用cloudflare cdn来加速图片访问。使用发现无法加速gif。</p>
</blockquote>
<p>本blog主要使用这个方法，如下所示。</p>
<ul>
<li>未加速图片地址</li>
</ul>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//raw.githubusercontent.com/appotry/cloudimg/main/data/2021/09/1020210910231815.png</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>Cloudflare加速图片地址</li>
</ul>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//cimg1.17lai.site/data/2021/09/1020210910231815.png</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="SEO-优化">SEO 优化</h3>
<blockquote>
<p>搜索引擎优化，又称为 SEO，即 Search Engine Optimization，它是一种通过分析搜索引擎的排名规律，了解各种搜索引擎怎样进行搜索、怎样抓取互联网页面、怎样确定特定关键词的搜索结果排名的技术。Google 自动收录效果还不错，百度就差得远了（<code>GitHub</code>不允许百度的<code>Spider</code>爬取<code>GitHub</code>上的内容）。</p>
</blockquote>
<h4 id="网域提交方式">网域提交方式</h4>
<ol>
<li>
<p>自动提交</p>
<p>（分三种）</p>
<ul>
<li>主动推送</li>
<li>自动推送</li>
<li>sitemap（站点地图）</li>
</ul>
</li>
<li>
<p>手动提交</p>
<ul>
<li>即手动地将链接一次性提交给百度</li>
</ul>
</li>
</ol>
<p>一般自动提交比手动提交效果好一点，自动提交又从效率上来说：</p>
<p><strong>主动推送&gt;自动推送&gt;sitemap</strong></p>
<p><strong>自动提交的三种方式</strong>：</p>
<ol>
<li><code>主动推送</code>：最为快速的提交方式。将站点当天新产出链接通过此方式推送给百度，以保证新链接可以及时被百度收录。</li>
<li><code>自动推送</code>：最为便捷的提交方式。将自动推送的JS代码部署在站点的每一个页面源代码中，当部署代码的页面在每次被浏览时，链接就会被自动推送给百度。可以与主动推送配合使用。</li>
<li><code>sitemap</code>：您可以定期将网站链接放到<code>sitemap文件</code>中，然后将<code>sitemap文件</code>提交给百度。百度会周期性的抓取检查您提交的<code>sitemap</code>，对其中的链接进行处理，但收录速度慢于主动推送。</li>
</ol>
<h4 id="使用sitemap方式推送">使用sitemap方式推送</h4>
<p>安装 sitemap 插件生成站点地图文件:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-generator-sitemap --save
<span class="token function">npm</span> <span class="token function">install</span> hexo-generator-baidu-sitemap --save  <span class="token comment">#百度专用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>安装后直接执行 <code>hexo cl&amp;&amp;hexo g -d</code> 命令，就会在网站根目录生成 <code>sitemap.xml</code> 及 <code>baidusitemap.xml</code> 文件。</p>
<ul>
<li>在博客目录的_config.yml中添加如下代码</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 通用站点地图</span>
<span class="token key atrule">sitemap</span><span class="token punctuation">:</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> sitemap.xml

<span class="token comment"># 百度站点地图</span>
<span class="token key atrule">baidusitemap</span><span class="token punctuation">:</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> baidusitemap.xml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="百度优化">百度优化</h5>
<p>登录<a target="_blank" rel="noopener" href="https://ziyuan.baidu.com/">百度搜索资源平台</a>， 登录成功之后在 用户中心 –&gt; 站点管理 页面中点击<a target="_blank" rel="noopener" href="https://ziyuan.baidu.com/site/siteadd">添加网站</a>，按提示操作。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910231752.png" alt="添加网站"></p>
<p><strong>添加网站</strong></p>
<blockquote>
<p>提示：由于百度的 spider 是爬取不到 GitHub 的内容的，所以在第三步验证网站的时候，建议选择<code>CNAME验证</code>的方式。</p>
</blockquote>
<p>经过以上步骤，百度已经知道有我们网站的存在了，但是百度还不知道我们的网站上有什么内容，所以要向百度推送我们的内容。点击 网站支持 –&gt; 数据引入 –&gt; 链接提交菜单，提交站点地图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910231758.png" alt="提交站点地图"></p>
<p><strong>提交站点地图</strong></p>
<p>另外，<code>hexo-theme-matery</code>主题已经内置了 <code>自动推送</code> 的功能， 检查 <code>themes/hexo-theme-matery/_config.yml</code> 文件中如下配置:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 百度搜索资源平台提交链接</span>
<span class="token key atrule">baiduPush</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>自动推送的 JS 代码部署在站点的每一个页面源代码中，当页面在每次被浏览时，链接就会被自动推送给百度。</p>
<h5 id="谷歌优化">谷歌优化</h5>
<p>登录 <a target="_blank" rel="noopener" href="https://search.google.com/search-console?hl=zh-CN">Google Search Console</a>，点击添加资源，输入自己的域名，按提示操作。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910231807.png" alt="添加资源"></p>
<p><strong>添加资源</strong></p>
<blockquote>
<p>提示：需要进行 DNS 验证，进入 DNS 域名解析设置页面，按提示增加 TXT 记录，如下图:</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910231808.png" alt="DNS验证内容填写示例"></p>
<p><strong>DNS验证内容填写示例</strong></p>
</blockquote>
<p>验证成功后，需要提交站点地图。参照下图提交，然后等待收录。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1020210910231815.png" alt="提交站点地图"></p>
<p><strong>提交站点地图</strong></p>
<blockquote>
<p>注意：hexo 配置文件中的 url 一定要输入正确的域名，插件是根据 url 生成站点地图的。</p>
</blockquote>
<h5 id="其它搜索引擎">其它搜索引擎</h5>
<blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.bing.com/webmasters/home">Bing提交</a></li>
<li><a target="_blank" rel="noopener" href="https://zhanzhang.sm.cn/open/detialPage">神马站长</a></li>
</ul>
</blockquote>
<h4 id="百度自动推送方式">百度自动推送方式</h4>
<p>只要每个需要被百度爬取的HTML页面中加入一段JS代码即可：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> bp <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> curProtocol <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curProtocol <span class="token operator">===</span> <span class="token string">'https'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bp<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'https://zz.bdstatic.com/linksubmit/push.js'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        bp<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://push.zhanzhang.baidu.com/push.js'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> s <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">"script"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>bp<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我所使用的matery主题可以自动给每个页面加上这段代码，只需在主题配置文件中配置：</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token comment"># 百度搜索资源平台提交链接</span>
<span class="token key atrule">baiduPush</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>即可！</p>
<p>其他主题一般都有这个功能的实现，如果没有的话，想办法在每个页面加入以上JS代码即可，原理是一样。</p>
<h4 id="百度主动推送SEO方式">百度主动推送SEO方式</h4>
<blockquote>
<ul>
<li>配置文章自动推送到百度蜘蛛</li>
</ul>
</blockquote>
<h5 id="获取百度推送密钥">获取百度推送密钥</h5>
<p>在 <a href="ziyuan.baidu.com/site">百度资源</a> 注册你的网址，验证完后可在<code>站点管理-&gt;资源提交-&gt;链接提交-&gt;主动推送(实时)</code> 中找到你的推送密钥，下面说明中的 token= 后的内容即为推送密钥。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">推送接口
接口调用地址：http://data.zz.baidu.com/urls?site<span class="token operator">=</span>https://ifibe.com<span class="token operator">&amp;</span><span class="token assign-left variable">token</span><span class="token operator">=</span>xxxxxxxxxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h5 id="安装主动推送插件：hexo-baidu-url-submit">安装主动推送插件：<a target="_blank" rel="noopener" href="https://github.com/huiwang/hexo-baidu-url-submit">hexo-baidu-url-submit</a></h5>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> hexo-baidu-url-submit --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="然后打开hexo配置文件，在末尾加入以下配置：">然后打开<code>hexo配置文件</code>，在末尾加入以下配置：</h5>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token comment"># hexo-baidu-url-submit  百度主动推送</span>
<span class="token key atrule">baidu_url_submit</span><span class="token punctuation">:</span>
  <span class="token key atrule">count</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># 提交最新的一个链接</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//blog.17lai.site <span class="token comment"># 在百度站长平台中注册的域名</span>
  <span class="token key atrule">token</span><span class="token punctuation">:</span> xxxxxxx <span class="token comment"># 请注意这是您的秘钥， 所以请不要把博客源代码发布在公众仓库里!</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> baidu_urls.txt <span class="token comment"># 文本文档的地址， 新链接会保存在此文本文档里</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>密匙的获取是在百度的自动提交的主动推送那里。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1120210911153349.png" alt=""></p>
<h5 id="再加入新的deploy：">再加入新的<code>deploy</code>：</h5>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> baidu_url_submitter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>如图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1120210911153357.png" alt=""></p>
<p>这样每次执行 <code>hexo d</code> 的时候，新的链接就会被推送了。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo clean
$ hexo g
$ hexo d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>推送成功时,会有如下终端提示!</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1820210918203209.png" alt="baidu_url_submitter"></p>
<p>各种不同的推送反馈字段说明<a target="_blank" rel="noopener" href="https://ziyuan.baidu.com/college/courseinfo?id=267&amp;page=2#h2_article_title12">点我</a>查看，一般来说，推送失败基本都是地址不相符造成的，我们只需对比<code>baidu_url_submit</code>在<code>public</code>中生成的<code>baidu_urls.txt</code>的地址,与自己填写在<code>host</code>字段中的地址对比看是否一样即可。</p>
<h4 id="Github-Action-自动提交SEO方式">Github Action 自动提交SEO方式</h4>
<h5 id="安装插件">安装插件</h5>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i hexo-seo-autopush --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="配置">配置</h5>
<p>在hexo 的config.yml里添加</p>
<p>hexo-seo-autopush配置</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># enable: 开启/关闭 推送</span>
<span class="token comment"># count: 每次提交最新的10篇文章</span>
<span class="token comment"># https://github.com/lete114/hexo-seo-autopush</span>
<span class="token key atrule">hexo_seo_autopush</span><span class="token punctuation">:</span>
  <span class="token key atrule">baidu</span><span class="token punctuation">:</span>
    <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">count</span><span class="token punctuation">:</span> <span class="token number">100</span>
  <span class="token key atrule">bing</span><span class="token punctuation">:</span>
    <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">count</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">google</span><span class="token punctuation">:</span>
    <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">count</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token key atrule">google_file</span><span class="token punctuation">:</span> google_service_account.json <span class="token comment"># 谷歌服务账户</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>添加<code>Google Push</code>配置和解决push后没有GitHub Actions <code>.github\workflows\AutoPush.yml</code>文件的问题</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Deployment</span>
<span class="token comment">## Docs: https://hexo.io/docs/one-command-deployment</span>
<span class="token key atrule">deploy</span><span class="token punctuation">:</span>
   <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> git
     <span class="token key atrule">repo</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/lete114/Test.git
     <span class="token key atrule">branch</span><span class="token punctuation">:</span> main
     <span class="token key atrule">ignore_hidden</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 忽略隐藏文件及文件夹(目录)</span>
   <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> GooglePush <span class="token comment"># 谷歌提交</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="获取站长平台密钥">获取站长平台密钥</h5>
<h5 id="Baidu-Key">Baidu Key</h5>
<ol>
<li>打开百度站长平台，点击左侧的普通收录https://ziyuan.baidu.com/<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/2120210921065417.png" alt=""></li>
</ol>
<h5 id="Bing-Key">Bing Key</h5>
<ol>
<li>打开Bing站长平台，https://www.bing.com/webmasters/home</li>
<li>点击右上角头像 旁边的齿轮，跟着下图操作<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/2120210921065427.png" alt=""></li>
</ol>
<h5 id="Google-Key">Google Key</h5>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://cloud.google.com/docs/authentication/production?hl=zh-cn">Google Wiki</a>， 使用参考。</p>
</blockquote>
<ol>
<li>
<p>打开Google indexing API<a target="_blank" rel="noopener" href="https://console.developers.google.com/flows/enableapi?apiid=indexing.googleapis.com&amp;credential=client_key">官网</a></p>
</li>
<li>
<p>选择创建项目，点击继续</p>
</li>
<li>
<p>点击转到凭据页面</p>
</li>
<li>
<p>跟着如下图片步骤</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/2120210921065438.png" alt="GoogleProof"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/2120210921065446.png" alt="GoogleAddProof"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/2120210921065512.png" alt="GoogleNone"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/2120210921065454.png" alt="GoogleKey"></p>
<p>json文件内的内容</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"service_account"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"project_id"</span><span class="token operator">:</span> <span class="token string">"elated-guild-298003"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"private_key_id"</span><span class="token operator">:</span> <span class="token string">"cf58d669c0e8c8e082b2c403ade5e2548078e384"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"private_key"</span><span class="token operator">:</span> <span class="token string">"-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDEAJw89yeylRrA\nB+bzOAfQQNgOCABIwEKCy5mMxWSaiXy2RktyCJWjMR2Pgz770NJgClQHPJjsFn0c\nukHufpnuiX3VPlimLANPCRFdU/qp+yiaw4quIhYF1UZJkhmhL30anghUcvi+r9hQ\nw+RwcKrgA4EUzqUJaPdvjtzSoo315PPGfR91ASD5S8gE02yVI8igtYMX7v2x1JYR\n7PwHJwOVemiM9lot8ilvoUbV4BU0vSlwFoxKMJAbEXTmJjEKQi9992rcMW0GzXO8\ncHldUUtURXkt3VFjYTH27KhHiTkTXw+uZRBu1rkubDJkS8lGIWN7Fc/r4HMMCVTu\nXPS6HbJ/AgMBAAECggEANSS7OBaFd3jRL3cVCiZLjA5A5pEJzq/+eKtOn2oYDISx\nwVRO+YTVWdGj47kg1zM4D11NikbGaeDxHFxuKwW9o/04lpyYebneTcw2Hpl6EiOs\nz0WssOlCEmPQ8nrAI0GWiKSHuqoPwtg37TIoGsqZsjKRCby759DDokZYnm3/0sc+\niEllT0ZyBZhGDzyguVLEdCIR2P02q/hQzLyd6ejWGGwZebImbGoILhmuOjVrco0p\nV0JbrrNskjM5Epe7w+CpGftEASJ7Dxa8oj0qIT6cyAipra2AZAGnG9jrLcWpJuhu\nvNeDIFnTfpNEac+khXZZE2++MIQfTX9wGJc8tox2vQKBgQD6yiNvAL7sxExiy6ER\ntLtFQ3bvmMpKRFGvFOyPOtMbmjZ3D1GEtNNKGH4v1TI+tncEy7Q5Dm7nWwpi8yvL\nbh8xKghelAc/CU1nw0xDEDCkMbAwpFg5A5ZDImy3LZsQh0kNXniIMy1vMSt5yLKS\n80gXQKGCxG8t3rP8Qd/2a55g1QKBgQDIExP1nG9sHJaigmitEUwr0Ow6Shqr56Me\nd7995gaV1oLWWCQzrXt/viWkb1W5ZGIxzcWNWz99m4CbvqfewRr598Eenald0csN\nVcIEk+0C+6KqA+jU9Tfs2zow/C7JuKULP2N++o0EoSz/ngokP7f1yLOYbr507v/R\n0cLElQBQAwKBgAbxDWYHKUG4dTzO0hiBXiWepm4fVooTtgcYlyunvywmapeFDwaT\nUr3cS7HbPtbJiiXR1Z02rw8sT+9JN88brzVXKoAjrMer5D6ZA0Vf71i8H1pZUi/R\nz5jwHP48/uvIMtdx4/gxInLPc5qdWYQDw90Q5ueNtF4aqfSzhhV2CR45AoGBAJN9\nPOF6iMjx6jmyWOf8MGK8iOgPaMoA4Ea9j/SHdaNPlvPb1hQid0AcNDObv14Dmj+M\nqW0jLxKxZ4VobufPAsvyz/J51zjKRx11cqldQwNH7QnYB/O1MZzxn1wtC3C5JTG9\ncONSYFJhXoKxRliigEI3ye089jnNVdifAS1ZiflxAoGBANTX1fEMEeNuYU0v3rtd\n5CkPZg4TNZ+y2MGl5xR1LdIgrJ8c9xKoW4rpp7SsOIvHpWX494f90D7o9uFEGSQ4\nyQK53jVzJ0ekGV5BdPF3n3/2j2VEqFLHi7LL4CJSxr6ci7OfBoHOGE8odhevQCCK\njnFzEin0QsBEgIC73fBh6XcH\n-----END PRIVATE KEY-----\n"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"client_email"</span><span class="token operator">:</span> <span class="token string">"googleindexing@elated-guild-298003.iam.gserviceaccount.com"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"client_id"</span><span class="token operator">:</span> <span class="token string">"103034240916368863393"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"auth_uri"</span><span class="token operator">:</span> <span class="token string">"https://accounts.google.com/o/oauth2/auth"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"token_uri"</span><span class="token operator">:</span> <span class="token string">"https://oauth2.googleapis.com/token"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"auth_provider_x509_cert_url"</span><span class="token operator">:</span> <span class="token string">"https://www.googleapis.com/oauth2/v1/certs"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"client_x509_cert_url"</span><span class="token operator">:</span> <span class="token string">"https://www.googleapis.com/robot/v1/metadata/x509/googleindexing%40elated-guild-298003.iam.gserviceaccount.com"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>打开<a target="_blank" rel="noopener" href="https://search.google.com/search-console">谷歌站长平台</a><br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/2120210921065520.png" alt="GoogleAddUser"><br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/2120210921065527.png" alt="GoogleAddEmail"></p>
</li>
</ol>
<h5 id="配置博客仓库">配置博客仓库</h5>
<ol>
<li>
<p>Name必须是<code>baidu_token</code>和<code>bing_apikey</code>(不区分大小写)</p>
</li>
<li>
<p>添加完成后<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/2120210921065607.png" alt="Secrets-token"></p>
</li>
</ol>
<h5 id="谷歌的一些问题">谷歌的一些问题</h5>
<p>触发谷歌提交的命令是<code>hexo d</code></p>
<p>由于谷歌需要配合Google indexing API平台提供的json进行提交，而这个json格式不能泄露<br>
为防止json泄露只能本地提交，将json放到hexo根目录可自定义重命名(必须对应插件的配置)<br>
<code>如果你的使用Github Actions自动部署的话请把仓库设置为私有</code><br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/2120210921065535.png" alt="GoogleConfig"></p>
<h5 id="提交成功返回状态码">提交成功返回状态码</h5>
<p>以上步骤完成后即可<code>hexo d</code>部署了</p>
<ol>
<li>
<p>看看Github仓库是否上传成功<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/2120210921065614.png" alt=""></p>
</li>
<li>
<p>点击<code>Actions</code>查看是否执行<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/2120210921065616.png" alt=""></p>
</li>
<li>
<p>点击 Auto Push—-&gt;build—–&gt;点击第2步 自动提交</p>
<p>如图43行</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/2120210921065543.png" alt=""></p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// baidu返回的结果</span>
<span class="token punctuation">{</span>
	<span class="token property">"remain"</span><span class="token operator">:</span> <span class="token number">2060</span><span class="token punctuation">,</span>  <span class="token comment">// 表示当天剩余的可推送url条数</span>
	<span class="token property">"success"</span><span class="token operator">:</span> <span class="token number">47</span>    <span class="token comment">// 成功推送的url条数</span>
<span class="token punctuation">}</span> 
<span class="token comment">// bing返回结果(错误)</span>
<span class="token punctuation">{</span>
	<span class="token property">"ErrorCode"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token comment">// 错误 </span>
	<span class="token property">"Message"</span><span class="token operator">:</span> <span class="token string">"ERROR!!! Quota remaining for today: 2, Submitted: 47"</span>
    <span class="token comment">// Message：表示 你目前只剩2个url推送，而你现在推送的是47条url</span>
    <span class="token comment">// bing新用户开始每日只有10个推送额，据我了解连续推送10天(这我也不确定)</span>
    <span class="token comment">// 如果出现这个错误的话，你就只能先手动添加等系统给你分配额了(分配9999)</span>
<span class="token punctuation">}</span>
<span class="token comment">// bing返回结果(成功)</span>
<span class="token punctuation">{</span><span class="token property">"d"</span><span class="token operator">:</span><span class="token null keyword">null</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>Google 返回状态码</p>
<p>成功返回</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">Google response<span class="token operator">:</span>  <span class="token punctuation">{</span>
  urlNotificationMetadata<span class="token operator">:</span> <span class="token punctuation">{</span>
    url<span class="token operator">:</span> 'https<span class="token operator">:</span><span class="token comment">//blog.lete114.top/article/hexo-seo-autopush.html',</span>
    latestUpdate<span class="token operator">:</span> <span class="token punctuation">{</span>
      url<span class="token operator">:</span> 'https<span class="token operator">:</span><span class="token comment">//blog.lete114.top/article/hexo-seo-autopush.html',</span>
      type<span class="token operator">:</span> 'URL_UPDATED'<span class="token punctuation">,</span>
      notifyTime<span class="token operator">:</span> '<span class="token number">2020</span><span class="token number">-12</span>-08T02<span class="token operator">:</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">32</span>.871417693Z'
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>出现此错误需要: 翻墙</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">FetchError: request to https://www.googleapis.com/oauth2/v4/token failed, reason: connect ETIMEDOUT <span class="token number">172.217</span>.27.138:443
    at ClientRequest.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>D:<span class="token punctuation">\</span>Lete<span class="token punctuation">\</span>GitHub<span class="token punctuation">\</span>Hexo-Butterfly<span class="token punctuation">\</span>node_modules<span class="token punctuation">\</span>node-fetch<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>index.js:1461:11<span class="token punctuation">)</span>
    at ClientRequest.emit <span class="token punctuation">(</span>events.js:321:20<span class="token punctuation">)</span>
    at TLSSocket.socketErrorListener <span class="token punctuation">(</span>_http_client.js:426:9<span class="token punctuation">)</span>
    at TLSSocket.emit <span class="token punctuation">(</span>events.js:321:20<span class="token punctuation">)</span>
    at emitErrorNT <span class="token punctuation">(</span>internal/streams/destroy.js:92:8<span class="token punctuation">)</span>
    at emitErrorAndCloseNT <span class="token punctuation">(</span>internal/streams/destroy.js:60:3<span class="token punctuation">)</span>
    at processTicksAndRejections <span class="token punctuation">(</span>internal/process/task_queues.js:84:21<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  message: <span class="token string">'request to https://www.googleapis.com/oauth2/v4/token failed, reason: connect ETIMEDOUT 172.217.27.138:443'</span>,
  type: <span class="token string">'system'</span>,
  errno: <span class="token string">'ETIMEDOUT'</span>,
  code: <span class="token string">'ETIMEDOUT'</span>,
  config: <span class="token punctuation">{</span>
    method: <span class="token string">'POST'</span>,
    url: <span class="token string">'https://www.googleapis.com/oauth2/v4/token'</span>,
    data: <span class="token punctuation">{</span>
      grant_type: <span class="token string">'urn:ietf:params:oauth:grant-type:jwt-bearer'</span>,
      assertion: 'eyJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJnb29nbGVpbmRleGluZ0BzdGF0ZWx5LXRyYW5zaXQtMjk3NzE1LmlhbS5nc2VydmljZWFjY291bnQuY29tIiwic2NvcGUiOiJodHRwczovL3d3d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<h4 id="本地主动提交SEO">本地主动提交SEO</h4>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/abnerwei/hexo-url-submission">hexo-url-submission</a></p>
<p><a target="_blank" rel="noopener" href="https://abnerwei.com/wiki/hexo/url-submission">Wiki</a></p>
</blockquote>
<h5 id="安装方法"><strong>安装方法</strong></h5>
<ol>
<li>在终端中输入：</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i hexo-url-submission<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol start="2">
<li>在 <code>blog/_config.yml</code> 文件中添加配置：</li>
</ol>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">url_submission</span><span class="token punctuation">:</span>
   <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
   <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">'latest'</span> <span class="token comment"># latest or all( latest: modified pages; all: posts &amp; pages)</span>
   <span class="token key atrule">channel</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'baidu'</span><span class="token punctuation">,</span> <span class="token string">'bing'</span><span class="token punctuation">,</span> <span class="token string">'google'</span><span class="token punctuation">,</span> <span class="token string">'shenma'</span><span class="token punctuation">]</span> <span class="token comment"># Included channels are `baidu`, `google`, `bing`, `shenma`</span>
   <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'/post'</span><span class="token punctuation">,</span> <span class="token string">'/wiki'</span><span class="token punctuation">]</span> <span class="token comment"># URL prefix</span>
   <span class="token key atrule">count</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token comment"># Submit limit</span>
   <span class="token key atrule">proxy</span><span class="token punctuation">:</span> <span class="token string">''</span> <span class="token comment"># Set the proxy used to submit urls to Google</span>
   <span class="token key atrule">urls_path</span><span class="token punctuation">:</span> <span class="token string">'submit_url.txt'</span> <span class="token comment"># URL list file path</span>
   <span class="token key atrule">baidu_token</span><span class="token punctuation">:</span> <span class="token string">''</span> <span class="token comment"># Baidu private key</span>
   <span class="token key atrule">bing_token</span><span class="token punctuation">:</span> <span class="token string">''</span> <span class="token comment"># Bing private key</span>
   <span class="token key atrule">google_key</span><span class="token punctuation">:</span> <span class="token string">''</span> <span class="token comment"># Google key path (e.g. `google_key.json` or `data/google_key.json`)</span>
   <span class="token key atrule">shenma_token</span><span class="token punctuation">:</span> <span class="token string">''</span> <span class="token comment"># ShenMa private key</span>
   <span class="token key atrule">shenma_user</span><span class="token punctuation">:</span> <span class="token string">''</span> <span class="token comment"># Username used when registering</span>
   <span class="token key atrule">sitemap</span><span class="token punctuation">:</span> <span class="token string">''</span> <span class="token comment"># Sitemap path(e.g. the url is like this https://abnerwei.com/baidusitemap.xml, you can fill in `baidusitemap.xml`)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="更新方法"><strong>更新方法</strong></h5>
<p>在站点根目录执行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> update hexo-url-submission<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="deploy">deploy</h5>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> us_baidu_deployer
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> us_bing_deployer
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> us_google_deployer
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> us_shenma_deployer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="good-job">good job</h5>
<p>Run:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo clean <span class="token operator">&amp;&amp;</span> hexo g <span class="token operator">&amp;&amp;</span> hexo d<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>enjoy it!</p>
<h3 id="提交-robots-txt">提交 robots.txt</h3>
<h4 id="robots-txt是干嘛的？">robots.txt是干嘛的？</h4>
<blockquote>
<p><code>robots.txt</code> 是一种存放于网站根目录下的 <code>ASCII</code> 编码的文本文件，它的作用是告诉搜索引擎此网站中哪些内容是可以被爬取的，哪些是禁止爬取的。<br>
<code>robots.txt</code> 要放在 <code>Hexo根目录</code> 下的 <code>source</code> 文件夹中。</p>
</blockquote>
<p>每个人站点目录可能不太一样，可以参考下我的 <code>robots.txt</code> 文件，内容如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">User-agent</span><span class="token punctuation">:</span> *
<span class="token key atrule">Allow</span><span class="token punctuation">:</span> /
<span class="token key atrule">Allow</span><span class="token punctuation">:</span> /posts/
<span class="token key atrule">Disallow</span><span class="token punctuation">:</span> /about/
<span class="token key atrule">Disallow</span><span class="token punctuation">:</span> /archives/
<span class="token key atrule">Disallow</span><span class="token punctuation">:</span> /js/
<span class="token key atrule">Disallow</span><span class="token punctuation">:</span> /css/
<span class="token key atrule">Disallow</span><span class="token punctuation">:</span> /contact/
<span class="token key atrule">Disallow</span><span class="token punctuation">:</span> /fonts/
<span class="token key atrule">Disallow</span><span class="token punctuation">:</span> /friends/
<span class="token key atrule">Disallow</span><span class="token punctuation">:</span> /libs/
<span class="token key atrule">Disallow</span><span class="token punctuation">:</span> /medias/
<span class="token key atrule">Disallow</span><span class="token punctuation">:</span> /page/
<span class="token key atrule">Disallow</span><span class="token punctuation">:</span> /tags/
<span class="token key atrule">Disallow</span><span class="token punctuation">:</span> /categories/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>更多关于 <code>robots.txt</code> 的写法参见 https://blog.csdn.net/fanghua_vip/article/details/79535639</p>
<p>编写完以上内容再重新部署一下，然后到百度资源平台的<code>数据监控</code>-&gt;<code>Robots</code>点击<code>检测并更新</code> 看能不能检测到。</p>
<h3 id="配置-Nofollow">配置 Nofollow</h3>
<ul>
<li>nofollow 是HTML页面中 <code>a标签</code> 的 属性值。</li>
<li>这个属性的作用是：告诉搜索引擎的爬虫不要追踪该链接，为了对抗博客垃圾留言信息</li>
</ul>
<h3 id="URL优化">URL优化</h3>
<p>一般来说，SEO搜索引擎优化认为，网站的最佳结构是 <strong>用户从首页点击三次就可以到达任何一个页面</strong>，但是我们使用<code>Hexo</code>编译的站点结构的<code>URL</code>是：<code>域名/年/月/日/文章标题</code>四层的结构，这样的<code>URL</code>结构很不利于<code>SEO</code>，爬虫就会经常爬不到我们的文章，于是，我们需要优化一下网站文章的<code>URL</code></p>
<p><strong>方案一</strong>：</p>
<p>直接改成<code>域名/文章标题</code>的形式，在<code>Hexo配置文件</code>中修改<code>permalink</code>如下：</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token comment"># URL</span>
<span class="token comment">## If your site is put in a subdirectory, set url as 'http://yoursite.com/child' and root as '/child/'</span>
<span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//blog.sky03.cn
<span class="token key atrule">root</span><span class="token punctuation">:</span> /
<span class="token key atrule">permalink</span><span class="token punctuation">:</span> <span class="token punctuation">:</span>title.html
permalink_defaults<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>这个方式有个不好的地方：</strong></p>
<p>直接以<code>文章的标题</code>作为URL，而我们所写的文章的标题一般都是中文，但是URL只能用字母数字和标点符号表示，所以中文的URL只能被转义成一堆符号，而且还特别长。</p>
<p><strong>方案二</strong>：</p>
<p>安装固定链接插件：<a target="_blank" rel="noopener" href="https://github.com/rozbo/hexo-abbrlink">hexo-abbrlink</a></p>
<p>插件作用：自动为每篇文章生成一串数字作每篇文章的URI地址。每篇文章的<code>Front-matter</code>中会自动增加一个配置项：<code>abbrlink: xxxxx</code>，该项的值就是当前文章的URI地址。</p>
<ol>
<li>
<p>Hexo根目录执行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-abbrlink --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p><code>Hexo配置文件</code>末尾加入以下配置：</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token comment"># hexo-abbrlink config 、固定文章地址插件</span>
<span class="token key atrule">abbrlink</span><span class="token punctuation">:</span>
  <span class="token key atrule">alg</span><span class="token punctuation">:</span> crc16  <span class="token comment">#算法选项：crc16、crc32，区别见之前的文章，这里默认为crc16丨crc32比crc16复杂一点，长一点</span>
  <span class="token key atrule">rep</span><span class="token punctuation">:</span> dec    <span class="token comment">#输出进制：十进制和十六进制，默认为10进制。丨dec为十进制，hex为十六进制</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p><code>Hexo配置文件</code>中修改<code>permalink</code>如下：</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token comment"># URL</span>
<span class="token comment">## If your site is put in a subdirectory, set url as 'http://yoursite.com/child' and root as '/child/'</span>
<span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//blog.17lai.site
<span class="token key atrule">root</span><span class="token punctuation">:</span> /
<span class="token key atrule">permalink</span><span class="token punctuation">:</span> posts/<span class="token punctuation">:</span>abbrlink.html
permalink_defaults<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<p>这样站点结构就变成了：<code>域名/posts/xxx.html</code></p>
<h3 id="异步加载JS">异步加载JS</h3>
<p><strong>方法</strong>：将JS文件的引入，放到HTML的body结束标签的上方</p>
<p><strong>例</strong>：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
        xxxxx....
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>xx/xx.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>原理</strong>：首先要明白，HTML的加载是从上往下一行一行解释执行的，把js文件的引入放到下面，这样就会先把HTML页面展示出来，然后再加载js。这样看起来的效果就是，大体的页面先出来，而js让它慢慢加载执行，如果你把js放到网页的上方，效果就是必须要加载完js才能继续展示网页，体验极差。</p>
<p><strong>注意</strong>：原主题的js文件尽量不要动，我们只需将自己增加的一些js按照异步加载的方式做即可，比如一些音乐js插件、实时在线聊天js插件等放到最后即可！因为这些文件要加载的东西很多。</p>
<h3 id="字蛛压缩字体">字蛛压缩字体</h3>
<blockquote>
<p>在上面我们介绍了如何在网站上引用自己喜欢的字体，但是这样会出现一个问题：字体文件太大！（尤其是中文，有时候为了几个字引入一个数十兆的字体文件，得不偿失），所有需要字体压缩！</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="http://font-spider.org/">官网</a> <a target="_blank" rel="noopener" href="https://github.com/aui/font-spider">GitHub</a></p>
<h4 id="使用场景">使用场景</h4>
<p>你的网站中需要自定义字体（额外添加一些普通电脑中没有的字体），但是一般字体是包含很多字符的，这就导致字体文件的体积很大</p>
<h4 id="字蛛作用">字蛛作用</h4>
<p>字蛛就是自动检测网站的 CSS 与 HTML 文件中的自定义字体（额外加的字体），并将网站中<strong>用到的文字</strong>重新打包成一个新的字体文件，并自动引入；</p>
<p>而<strong>没用到的文字</strong>就会删除，从而达到压缩字体文件体积的作用。</p>
<h4 id="安装-6">安装</h4>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">npm install font-spider -g<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="在-CSS-中使用-WebFont：">在 CSS 中使用 WebFont：</h4>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/*声明 WebFont*/</span>
<span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">{</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'pinghei'</span><span class="token punctuation">;</span>
  <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">'../font/pinghei.eot'</span><span class="token punctuation">)</span></span><span class="token punctuation">;</span>
  <span class="token property">src</span><span class="token punctuation">:</span>
    <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">'../font/pinghei.eot?#font-spider'</span><span class="token punctuation">)</span></span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'embedded-opentype'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">'../font/pinghei.woff'</span><span class="token punctuation">)</span></span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'woff'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">'../font/pinghei.ttf'</span><span class="token punctuation">)</span></span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'truetype'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">'../font/pinghei.svg'</span><span class="token punctuation">)</span></span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'svg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">font-weight</span><span class="token punctuation">:</span> normal<span class="token punctuation">;</span>
  <span class="token property">font-style</span><span class="token punctuation">:</span> normal<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*使用选择器指定字体*/</span>
<span class="token selector">.home h1, .demo &gt; .test</span> <span class="token punctuation">{</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'pinghei'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<ol>
<li>@font-face 中的 src 定义的 .ttf 文件必须存在，其余的格式将由工具自动生成</li>
<li>开发阶段请使用相对路径的 CSS 与 WebFont</li>
</ol>
</blockquote>
<h4 id="运行-font-spider-命令：">运行 font-spider 命令：</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">font-spider ./demo/*.html<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>页面依赖的字体将会自动压缩好，原 .ttf 字体会备份</p>
</blockquote>
<h3 id="webp图像大小优化">webp图像大小优化</h3>
<blockquote>
<p>把所有图像都转换为webp格式，可以极大减小图片体积，加快加载速度。</p>
</blockquote>
<h3 id="gulp-体积压缩">gulp 体积压缩</h3>
<h4 id="使用-gulp-图片html-js-ccs">使用 gulp 图片html, js, ccs</h4>
<p>减小体积，加快加载速度</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> gulp -g
$ <span class="token function">npm</span> <span class="token function">install</span> gulp-minify-css gulp-uglify gulp-htmlmin gulp-htmlclean gulp --save
 
或者使用yarn 
 
<span class="token function">yarn</span> global <span class="token function">add</span> gulp
<span class="token function">yarn</span> <span class="token function">add</span> gulp-minify-css gulp-uglify gulp-htmlmin gulp-htmlclean gulp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，在根目录新增 <code>gulpfile.js</code> :</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">var gulp = require('gulp');
var minifycss = require('gulp<span class="token punctuation">-</span>minify<span class="token punctuation">-</span>css');
var uglify = require('gulp<span class="token punctuation">-</span>uglify');
var htmlmin = require('gulp<span class="token punctuation">-</span>htmlmin');
var htmlclean = require('gulp<span class="token punctuation">-</span>htmlclean');
// 压缩 public 目录 css
gulp.task('minify<span class="token punctuation">-</span>css'<span class="token punctuation">,</span> function() <span class="token punctuation">{</span>
    return gulp.src('./public/<span class="token important">**/*.css')</span>
        .pipe(minifycss())
        .pipe(gulp.dest('./public'));
<span class="token punctuation">}</span>);
// 压缩 public 目录 html
gulp.task('minify<span class="token punctuation">-</span>html'<span class="token punctuation">,</span> function() <span class="token punctuation">{</span>
  return gulp.src('./public/<span class="token important">**/*.html')</span>
    .pipe(htmlclean())
    .pipe(htmlmin(<span class="token punctuation">{</span>
         <span class="token key atrule">removeComments</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
         <span class="token key atrule">minifyJS</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
         <span class="token key atrule">minifyCSS</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
         <span class="token key atrule">minifyURLs</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>))
    .pipe(gulp.dest('./public'))
<span class="token punctuation">}</span>);
// 压缩 public/js 目录 js
gulp.task('minify<span class="token punctuation">-</span>js'<span class="token punctuation">,</span> function() <span class="token punctuation">{</span>
    return gulp.src('./public/<span class="token important">**/*.js')</span>
        .pipe(uglify())
        .pipe(gulp.dest('./public'));
<span class="token punctuation">}</span>);
// 执行 gulp 命令时执行的任务
// gulp 3.x
// gulp.task('default'<span class="token punctuation">,</span> <span class="token punctuation">[</span>
//     'minify<span class="token punctuation">-</span>html'<span class="token punctuation">,</span><span class="token string">'minify-css'</span><span class="token punctuation">,</span><span class="token string">'minify-js'</span>
// <span class="token punctuation">]</span>);

// gulp 4.x
gulp.task('default'<span class="token punctuation">,</span> gulp.series('minify<span class="token punctuation">-</span>html'<span class="token punctuation">,</span> <span class="token string">'minify-css'</span><span class="token punctuation">,</span> <span class="token string">'minify-js'</span><span class="token punctuation">,</span> done =<span class="token punctuation">&gt;</span> done()));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo clean <span class="token operator">&amp;&amp;</span> hexo g <span class="token operator">&amp;&amp;</span> gulp <span class="token operator">&amp;&amp;</span>  hexo g<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="使用-gulp-图片压缩">使用 gulp 图片压缩</h4>
<p>压缩 图片文件可降低文件大小，提高图片加载速度。</p>
<p>找到规律转换为 gulp 代码</p>
<h5 id="规律">规律</h5>
<p>找到 <code>images/</code> 目录下的所有文件，压缩它们，将压缩后的文件存放在 <code>dist/images/</code> 目录下。</p>
<h5 id="一、安装-gulp-imagemin-模块"><strong>一、安装 gulp-imagemin</strong> 模块</h5>
<p>提示：你需要使用命令行的 <code>cd</code> 切换至对应目录再进行安装操作和 gulp 启动操作。</p>
<p><a target="_blank" rel="noopener" href="https://wiki.jikexueyuan.com/project/gulp-book/chapter1.html">学习使用命令行</a></p>
<p>在命令行输入</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> instal gulp-imagemin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装成功后你会看到如下信息：(安装时间可能会比较长)</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gulp-imagemin@2.2.1 node_modules/gulp-imagemin
├── object-assign@2.0.0
├── pretty-bytes@1.0.3 <span class="token punctuation">(</span>get-stdin@4.0.1<span class="token punctuation">)</span>
├── chalk@1.0.0 <span class="token punctuation">(</span>escape-string-regexp@1.0.3, ansi-styles@2.0.1, supports-color@1.3.1, has-ansi@1.0.3, strip-ansi@2.0.1<span class="token punctuation">)</span>
├── through2-concurrent@0.3.1 <span class="token punctuation">(</span>through2@0.6.3<span class="token punctuation">)</span>
├── gulp-util@3.0.4 <span class="token punctuation">(</span>array-differ@1.0.0, beeper@1.0.0, array-uniq@1.0.2, lodash._reevaluate@3.0.0, lodash._reescape@3.0.0, lodash._reinterpolate@3.0.0, replace-ext@0.0.1, minimist@1.1.1, vinyl@0.4.6, through2@0.6.3, multipipe@0.1.2, lodash.template@3.3.2, dateformat@1.0.11<span class="token punctuation">)</span>
└── imagemin@3.1.0 <span class="token punctuation">(</span>get-stdin@3.0.2, optional@0.1.3, vinyl@0.4.6, through2@0.6.3, stream-combiner@0.2.1, concat-stream@1.4.7, meow@2.1.0, vinyl-fs@0.3.13, imagemin-svgo@4.1.2, imagemin-optipng@4.2.0, imagemin-jpegtran@4.1.0, imagemin-pngquant@4.0.0, imagemin-gifsicle@4.1.0<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="二、创建-gulpfile-js-文件编写代码"><strong>二、创建 <code>gulpfile.js</code> 文件编写代码</strong></h5>
<p>在对应目录创建 <code>gulpfile.js</code> 文件并写入如下内容：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 获取 gulp</span>
<span class="token keyword">var</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取 gulp-imagemin 模块</span>
<span class="token keyword">var</span> imagemin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-imagemin'</span><span class="token punctuation">)</span>

<span class="token comment">// 压缩图片任务</span>
<span class="token comment">// 在命令行输入 gulp images 启动此任务</span>
gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'images'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 找到图片</span>
    gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'images/*.*'</span><span class="token punctuation">)</span>
    <span class="token comment">// 2. 压缩图片</span>
        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">progressive</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 3. 另存图片</span>
        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist/images'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在命令行使用 gulp auto 启动此任务</span>
gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'auto'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 监听文件修改，当文件被修改则执行 images 任务</span>
    gulp<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'images/*.*)'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'images'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用 gulp.task('default') 定义默认任务</span>
<span class="token comment">// 在命令行使用 gulp 启动 images 任务和 auto 任务</span>
gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'images'</span><span class="token punctuation">,</span> <span class="token string">'auto'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>你可以访问 <a target="_blank" rel="noopener" href="https://github.com/sindresorhus/gulp-imagemin">gulp-imagemin</a> 以查看更多用法。</p>
<h5 id="三、在-images-目录下存放图片"><strong>三、在 <code>images/</code> 目录下存放图片</strong></h5>
<p>在 <code>gulpfile.js</code> 对应目录创建 <code>images</code> 文件夹，并在 <code>images/</code> 目录下存放图片。</p>
<h5 id="四、运行-gulp-查看效果"><strong>四、运行 gulp 查看效果</strong></h5>
<p>在命令行输入 <code>gulp</code> +回车</p>
<p>你将看到命令行出现如下提示</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gulp
<span class="token punctuation">[</span><span class="token number">18</span>:10:42<span class="token punctuation">]</span> Using gulpfile ~/Documents/code/gulp-book/demo/chapter4/gulpfile.js
<span class="token punctuation">[</span><span class="token number">18</span>:10:42<span class="token punctuation">]</span> Starting <span class="token string">'images'</span><span class="token punctuation">..</span>.
<span class="token punctuation">[</span><span class="token number">18</span>:10:42<span class="token punctuation">]</span> Finished <span class="token string">'images'</span> after <span class="token number">5.72</span> ms
<span class="token punctuation">[</span><span class="token number">18</span>:10:42<span class="token punctuation">]</span> Starting <span class="token string">'auto'</span><span class="token punctuation">..</span>.
<span class="token punctuation">[</span><span class="token number">18</span>:10:42<span class="token punctuation">]</span> Finished <span class="token string">'auto'</span> after <span class="token number">6.39</span> ms
<span class="token punctuation">[</span><span class="token number">18</span>:10:42<span class="token punctuation">]</span> Starting <span class="token string">'default'</span><span class="token punctuation">..</span>.
<span class="token punctuation">[</span><span class="token number">18</span>:10:42<span class="token punctuation">]</span> Finished <span class="token string">'default'</span> after <span class="token number">5.91</span> μs
<span class="token punctuation">[</span><span class="token number">18</span>:10:42<span class="token punctuation">]</span> gulp-imagemin: Minified <span class="token number">3</span> images <span class="token punctuation">(</span>saved <span class="token number">25.83</span> kB - <span class="token number">5.2</span>%<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="hexo-部署">hexo 部署</h2>
<h3 id="将Hexo部署到vps，实现自动发布"><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luoshuitianyi/p/10333928.html" title="Hexo搭建(VPS)">将Hexo部署到vps，实现自动发布</a></h3>
<h4 id="搭建流程">搭建流程</h4>
<ol>
<li>服务器环境配置，安装Git、Nginx配置、创建git用户</li>
<li>本地hexo初始化</li>
<li>使用Git自动部署并发布博客</li>
</ol>
<h4 id="服务器环境搭建">服务器环境搭建</h4>
<ul>
<li><strong>安装Git和NodeJS(Centos环境)</strong></li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token function">git</span>
<span class="token comment"># 安装NodeJS </span>
<span class="token function">curl</span> --silent --location https://rpm.nodesource.com/setup_5.x <span class="token operator">|</span> <span class="token function">bash</span> -<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li><strong>创建git账号</strong></li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">adduser <span class="token function">git</span>
<span class="token function">chmod</span> <span class="token number">740</span> /etc/sudoers
<span class="token function">vim</span> /etc/sudoers<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>添加内容<br>
找到</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">## Allow root to run any commands anywhere</span>
root    <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>ALL<span class="token punctuation">)</span>     ALL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>添加以下内容</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span>     <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>ALL<span class="token punctuation">)</span>     ALL<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>保存退出并改回权限</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token number">400</span> /etc/sudoers<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>设置git账号密码</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">passwd</span> <span class="token function">git</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>使用<code>su git</code>切换到git用户，再执行下列操作：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 切换到git用户目录</span>
<span class="token builtin class-name">cd</span> /home/git
<span class="token comment"># 创建.ssh文件夹</span>
<span class="token function">mkdir</span> ~/.ssh
<span class="token comment"># 创建authorized_keys文件并编辑</span>
<span class="token function">vim</span> ~/.ssh/authorized_keys
<span class="token comment"># 如果你还没有生成公钥，那么首先在本地电脑中执行 cat ~/.ssh/id_rsa.pub | pbcopy生成公钥</span>
<span class="token comment"># 再将公钥复制粘贴到authorized_keys</span>
<span class="token comment"># 保存关闭authorized_keys后，修改相应权限</span>
<span class="token function">chmod</span> <span class="token number">600</span> ~/.ssh/authorized_keys
<span class="token function">chmod</span> <span class="token number">700</span> ~/.ssh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>然后可以通过本地Git Bash执行ssh命令测试是否可以免密登录</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> -v git@服务器ip地址<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这样git用户就添加好了。</p>
<blockquote>
<p>Tips: 将公钥拷贝到服务器的~/.ssh/authorized_keys文件中方法有如下几种：</p>
<ol>
<li>将公钥通过scp拷贝到服务器上，然后追加到~/.ssh/authorized_keys文件中，这种方式比较麻烦。scp -P 22 ~/.ssh/id_rsa.pub user@host:~/。</li>
<li>通过ssh-copy-id程序，就是我演示的方法，ssh-copyid user@host即可</li>
<li>可以通过cat ~/.ssh/id_rsa.pub | ssh -p 22 user@host ‘cat &gt;&gt; ~/.ssh/authorized_keys’，这个也是比较常用的方法，因为可以更改端口号。</li>
</ol>
</blockquote>
<ul>
<li><strong>安装Nginx</strong></li>
<li>准备工作<br>
首先由于nginx的一些模块依赖一些lib库，所以在安装nginx之前，必须先安装这些lib库，这些依赖库主要有g++、gcc、openssl-devel、pcre-devel和zlib-devel 所以执行如下命令安装</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> gcc-c++
yum <span class="token function">install</span> pcre pcre-devel
yum <span class="token function">install</span> zlib zlib-devel
yum <span class="token function">install</span> openssl openssl--devel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>Ubuntu系统安装命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libpcre3 libpcre3-dev
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> zlib1g-dev
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> openssl libssl-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>安装Nginx<br>
安装之前，最好检查一下是否已经安装有nginx</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> -name nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果系统已经安装了nginx，那么就先卸载</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum remove nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后开始安装<br>
首先进入<code>/usr/local</code>目录</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /usr/local<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>从官网下载最新版的nginx</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> -c https://nginx.org/download/nginx-1.14.2.tar.gz <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（注：版本号可更改，去官网查看最新版本号修改即可）</p>
<p>解压nginx压缩包</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> -zxvf nginx-1.14.2.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>会产生一个nginx-1.14.2 目录，这时进入nginx-1.14.2 目录</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span>  nginx-1.14.2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>接下来安装，使用–prefix参数指定nginx安装的目录,make、make install安装</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（默认安装在/usr/local/nginx，推荐使用默认设置）</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912163925.png" alt=""></p>
<pre class="line-numbers language-none"><code class="language-none">make<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912163918.png" alt=""></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912163522.png" alt=""></p>
<p>如果没有报错，顺利完成后，最好看一下nginx的安装目录</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">whereis</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（where和is要连这些，中间没有空格）</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912163515.png" alt=""></p>
<ul>
<li>启动和停止nginx</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /usr/local/nginx/sbin/
./nginx 
./nginx -s stop
./nginx -s quit
./nginx -s reload
./nginx -s quit: 此方式停止步骤是待nginx进程处理任务完毕进行停止。
./nginx -s stop: 此方式相当于先查出nginx进程id再使用kill命令强制杀掉进程。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询nginx进程：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912163454.png" alt=""></p>
<ul>
<li>重启 nginx</li>
</ul>
<ol>
<li>先停止再启动（推荐）：<br>
对 nginx 进行重启相当于先停止再启动，即先执行停止命令再执行启动命令。如下：</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./nginx -s quit
./nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol start="2">
<li>重新加载配置文件：<br>
当 nginx 的配置文件 nginx.conf 修改后，要想让配置生效需要重启 nginx，使用 -s reload 不用先停止 nginx 再启动 nginx 即可将配置信息在 nginx 中生效，如下：</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./nginx -s reload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>启动成功后，在浏览器可以看到如下页面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912163437.png" alt=""></p>
<ul>
<li>开机自启动</li>
</ul>
<p>即在rc.local增加启动代码就可以了。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/rc.local<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>增加一行</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/usr/local/nginx/sbin/nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>到这里，nginx安装完毕，启动、停止、重启操作也都完成。</p>
<h4 id="建立git裸库">建立git裸库</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 回到git目录</span>
<span class="token builtin class-name">cd</span> /home/git
<span class="token comment"># 使用git用户创建git裸仓库，以blog.git为例</span>
<span class="token function">git</span> init --bare blog.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="检查用户组权限">检查用户组权限</h4>
<p>我们的git裸仓库已经建立好了，离成功又近了一步。为了以防万一，我们要检查一下之前的blog.git、.ssh、blog目录的用户组权限是否都为<code>git:git</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 还记得/var/www/吗？这是之前配置nginx时，我们自己选定的网站根目录，请依据你自己的设置更改，如果没有的话自己</span>
ll -a /www/wwwroot/hexo
ll -a /home/git/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如果有哪个不是，执行下面相应的命令后再查看</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">chown</span> -R git:git /www/wwwroot/hexo
<span class="token function">sudo</span> <span class="token function">chmod</span> -R <span class="token number">755</span> /www/wwwroot/hexo
<span class="token function">sudo</span> <span class="token function">chown</span> git:git -R /home/git/blog.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="使用git-hooks同步网站根目录">使用git-hooks同步网站根目录</h4>
<p>简单来说，我们使用一个钩子文件：post-receive，每当git仓库接收到内容的时候，就会自动调用这个钩子，把内容同步到网站根目录。<br>
在git用户下执行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 新建一个post-receive文件并编辑</span>
<span class="token function">vim</span> ~/blog.git/hooks/post-receive<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在里面输入以下内容，注意修改为自己的设置：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">set</span> -e
<span class="token assign-left variable">GIT_REPO</span><span class="token operator">=</span>/home/git/blog.git
<span class="token assign-left variable">TMP_GIT_CLONE</span><span class="token operator">=</span>/tmp/blog
<span class="token assign-left variable">PUBLIC_WWW</span><span class="token operator">=</span>/www/wwwroot/hexo
<span class="token function">rm</span> -rf <span class="token variable">${TMP_GIT_CLONE}</span>
<span class="token function">git</span> clone -b main <span class="token variable">$GIT_REPO</span> <span class="token variable">$TMP_GIT_CLONE</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$TMP_GIT_CLONE</span>
<span class="token comment">#for b in `git branch -r | grep -v -- '-&gt;'`; do git branch --track ${b##origin/} $b; done</span>
<span class="token comment">#git checkout main</span>
<span class="token function">rm</span> -rf <span class="token variable">${PUBLIC_WWW}</span>/*
<span class="token function">cp</span> -rf <span class="token variable">${TMP_GIT_CLONE}</span>/* <span class="token variable">${PUBLIC_WWW}</span>
<span class="token builtin class-name">echo</span> <span class="token string">"update web done!"</span>
<span class="token comment">#ls -al ${PUBLIC_WWW}</span>
<span class="token function">rm</span> -rf <span class="token variable">${TMP_GIT_CLONE}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>保存退出后，执行以下赋予这个文件可执行权限。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chown</span> -R git:git ~/blog.git/hooks/post-receive
<span class="token function">chmod</span> +x ~/blog.git/hooks/post-receive<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>好了，以上就是服务器端需要配置的内容。我们还差最后一步就可以完成整个部署了！</p>
<h4 id="修改配置文件nginx-conf">修改配置文件nginx.conf</h4>
<p>修改上面的配置文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /usr/local/nginx/conf/nginx_config<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="然后修改其中两个部分，如下所示：">然后修改其中两个部分，如下所示：</h4>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912163900.jpeg" alt=""></p>
<p>然后<code>重启nginx</code>，方法见<code>nginx安装</code>部分。</p>
<h4 id="配置本地Hexo的-config-yml">配置本地Hexo的<code>_config.yml</code></h4>
<p>非常简单，只需要找到本地Hexo博客的站点配置文件<code>_config.yml</code>，找到以下内容并修改：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span> 
  <span class="token key atrule">type</span><span class="token punctuation">:</span> git
  <span class="token key atrule">repo</span><span class="token punctuation">:</span> git@你的服务器IP<span class="token punctuation">:</span>/home/git/blog.git
  <span class="token key atrule">branch</span><span class="token punctuation">:</span> master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>保存后，剩下的就是Hexo的日常操作了，这里就不赘述了，写完文章后，在你的本地博客根目录执行以下命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo c <span class="token operator">&amp;&amp;</span> hexo g -d<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>就可以实现线上博客的自动更新了！一切搞定！</p>
<h3 id="Rsync同步部署静态文件方法">Rsync同步部署静态文件方法</h3>
<blockquote>
<p>使用rsync同步</p>
</blockquote>
<p>本地生成静态文件后rsync同步到vps网页目录，lnap使用宝塔配置，这里只需要一个nginx。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># rsync [options] from_dir to_dir</span>
<span class="token comment"># 替换这里的ip为你的服务器ip</span>
<span class="token function">rsync</span> -avzP  /home/17lai.blog  root@8.8.8.8:/www/wwwroot/hexo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="Hexo-自动部署">Hexo 自动部署</h3>
<h4 id="准备">准备</h4>
<ol>
<li><code>Hexo</code> 博客源码的仓库，在 <code>GitHub</code> 上。</li>
<li><code>ssh</code> 密钥，参考文章：<a target="_blank" rel="noopener" href="https://sitoi.cn/posts/43508.html">Windows 下利用 Git 生成 SSH KEY 并配置到 GitHub</a></li>
</ol>
<h4 id="步骤">步骤</h4>
<ol>
<li>为需要部署的平台添加密钥</li>
<li>修改 <code>_config.yml</code> 中的 <code>deploy</code> 配置</li>
<li>在 GitHub 上设置 <code>Secrets</code></li>
<li>创建 GitHub Action</li>
</ol>
<h4 id="为需要部署的平台添加密钥">为需要部署的平台添加密钥</h4>
<p>按照之前的教程，只要你之前成功将 Hexo 的博客部署到 GitHub 上，那你电脑在 <code>~/.ssh</code> 目录下一定有以下三个文件：</p>
<ul>
<li><code>id_rsa</code>：私钥</li>
<li><code>id_rsa.pub</code>：公钥</li>
<li><code>known_hosts</code>：记录对所有用户都可信赖的远程主机的公钥</li>
</ul>
<p>将 <code>id_rsa.pub</code>（公钥）添加到不同平台中即可，参考文章：<a target="_blank" rel="noopener" href="https://sitoi.cn/posts/43508.html#%E6%9F%A5%E7%9C%8B-SSH-KEY">Windows 下利用 Git 生成 SSH KEY 并配置到 GitHub</a></p>
<p>下面是不同平台添加的地址：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/settings/ssh/new">GitHub</a></li>
<li><a target="_blank" rel="noopener" href="https://gitlab.com/profile/keys">GitLab</a></li>
<li><a target="_blank" rel="noopener" href="https://e.coding.net/">Coding</a></li>
<li><a target="_blank" rel="noopener" href="https://gitee.com/profile/sshkeys">Gitee</a></li>
</ul>
<h4 id="修改-config-yml-中的-deploy-配置">修改 <code>_config.yml</code> 中的 <code>deploy</code> 配置</h4>
<p>请使用 <code>ssh</code> (即以 <code>git@</code> 开头的 <code>clone</code> 链接) 的连接方式，根据直接的实际地址填写。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> git
    <span class="token key atrule">repo</span><span class="token punctuation">:</span>
      <span class="token key atrule">github</span><span class="token punctuation">:</span> git@github.com<span class="token punctuation">:</span>Sitoi/Sitoi.github.io.git
      <span class="token key atrule">coding</span><span class="token punctuation">:</span> git@e.coding.net<span class="token punctuation">:</span>Sitoi/Sitoi.git
      <span class="token key atrule">gitee</span><span class="token punctuation">:</span> git@gitee.com<span class="token punctuation">:</span>sitoi/sitoi.git
      <span class="token key atrule">gitlab</span><span class="token punctuation">:</span> git@gitlab.com<span class="token punctuation">:</span>Sitoi/sitoi.gitlab.io.git
    <span class="token key atrule">branch</span><span class="token punctuation">:</span> master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="在-GitHub-上设置-Secrets">在 GitHub 上设置 <code>Secrets</code></h4>
<ol>
<li>
<p>进入到你在 <code>GitHub</code> 上面的源码仓库</p>
</li>
<li>
<p>点击右上角的 <code>Settings</code></p>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012133009.png" alt="Settings"></p>
<p>Settings</p>
<ol start="3">
<li>
<p>点击左侧的 <code>Secrets</code></p>
</li>
<li>
<p>点击右上角的 <code>New secret</code></p>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012133002.png" alt="New secret"></p>
<p>New secret</p>
<ol start="5">
<li>在 <code>Name</code> 中输入 <code>HEXO_DEPLOY_PRI</code>，在 <code>Value</code> 中填入 <code>id_rsa</code>（私钥）的全部内容</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012132955.png" alt="Add secret"></p>
<p>Add secret</p>
<h4 id="创建-GitHub-Action">创建 GitHub Action</h4>
<ol>
<li>点击项目上方的 <code>Action</code> 按钮</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012132954.png" alt="Action"></p>
<p>Action</p>
<ol start="2">
<li>点击 <code>set up a workflow yourself</code> 创建 <code>Workflow</code></li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012132947.png" alt="Workflow"></p>
<p>Workflow</p>
<ol start="3">
<li>修改 <code>main.yaml</code> 的内容</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012132940.png" alt="Create Workflow"></p>
<p>Create Workflow</p>
<blockquote>
<p>根据实际情况修改成你自己的内容</p>
</blockquote>
<ul>
<li>Git 推送使用的用户名：git config –global user.name ‘sitoi’：</li>
<li>Git 推送使用的邮箱：git config –global user.email ‘<a href="mailto:133397418@qq.com">133397418@qq.com</a>‘</li>
<li>Hexo 的版本：npm i <a href="mailto:hexo@4.1.1">hexo@4.1.1</a> -g</li>
</ul>
   <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">name</span><span class="token punctuation">:</span> Hexo CI

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> butterfly

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">butterfly-build</span><span class="token punctuation">:</span>

    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest

    <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
      <span class="token key atrule">matrix</span><span class="token punctuation">:</span>
        <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.x<span class="token punctuation">]</span>

    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v1
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Use Node.js 10.x
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v1
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token string">'10.x'</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> env prepare
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">HEXO_DEPLOY_PRI</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.HEXO_DEPLOY_PRI <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          mkdir -p ~/.ssh/
          echo "$HEXO_DEPLOY_PRI" &gt; ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts
          ssh-keyscan gitlab.com &gt;&gt; ~/.ssh/known_hosts
          ssh-keyscan e.coding.net &gt;&gt; ~/.ssh/known_hosts
          ssh-keyscan gitee.com &gt;&gt; ~/.ssh/known_hosts
          git config --global user.name 'sito'
          git config --global user.email '133397418@qq.com'
          npm i
          npm i hexo@4.1.1 -g</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gen
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          hexo clean
          hexo generate
          hexo deploy</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li>将你的源码推送到 <code>GitHub</code> 上，你的博客一会就会自动更新了。</li>
</ol>
<h3 id="以-token-方式部署到-Github">以 token 方式部署到 Github</h3>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> git
  <span class="token key atrule">repo</span><span class="token punctuation">:</span>
    <span class="token key atrule">github</span><span class="token punctuation">:</span>
      <span class="token key atrule">url</span><span class="token punctuation">:</span> &lt;repository url<span class="token punctuation">&gt;</span>
      <span class="token key atrule">branch</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>branch<span class="token punctuation">]</span>
      <span class="token key atrule">token</span><span class="token punctuation">:</span> <span class="token string">''</span>
  <span class="token key atrule">message</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>message<span class="token punctuation">]</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>git user<span class="token punctuation">]</span>
  <span class="token key atrule">email</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>git email<span class="token punctuation">]</span>
  <span class="token key atrule">extend_dirs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>extend directory<span class="token punctuation">]</span>
  <span class="token key atrule">ignore_hidden</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># default is true</span>
  <span class="token key atrule">ignore_pattern</span><span class="token punctuation">:</span> regexp  <span class="token comment"># whatever file that matches the </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="利用-GitLab-实现-Hexo-博客的-CI-CD">利用 GitLab 实现 Hexo 博客的 CI/CD</h3>
<p>Portainer 提供了对服务在线更新的 WebHook，所以基于 GitLab 自带的 CI/CD 功能实现 Hexo 博客的持续部署，就非常轻松了。</p>
<p>CI/CD 其实本质上是一套流程，流程规则可以自行定义。在本文研究的主题下，流程分为三步：第一步是编译 Hexo 博客并生成静态文件；第二步是将静态文件打包成可提供 Web 服务的镜像；第三步则是通过 Portainer 的钩子触发服务更新。</p>
<p><code>.gitlab-ci.yml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> compile
  <span class="token punctuation">-</span> build
  <span class="token punctuation">-</span> deploy

<span class="token comment"># CONTAINER_RELEASE_IMAGE 根据自己的仓库名修改</span>
<span class="token key atrule">variables</span><span class="token punctuation">:</span>
  <span class="token key atrule">DOCKER_HOST</span><span class="token punctuation">:</span> tcp<span class="token punctuation">:</span>//docker<span class="token punctuation">:</span><span class="token number">2375</span>
  <span class="token key atrule">DOCKER_DRIVER</span><span class="token punctuation">:</span> overlay2
  <span class="token key atrule">CONTAINER_RELEASE_IMAGE</span><span class="token punctuation">:</span> registry.gitlab.com/xxx/xxx<span class="token punctuation">:</span>latest

<span class="token key atrule">compile</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> compile
  <span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span>lts<span class="token punctuation">-</span>alpine
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> npm install
    <span class="token punctuation">-</span> ./node_modules/hexo/bin/hexo generate
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> public/
    <span class="token key atrule">expire_in</span><span class="token punctuation">:</span> 20 minutes

<span class="token key atrule">build</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> build
  <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>stable
  <span class="token key atrule">services</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker<span class="token punctuation">:</span>dind
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker login <span class="token punctuation">-</span>u gitlab<span class="token punctuation">-</span>ci<span class="token punctuation">-</span>token <span class="token punctuation">-</span>p $CI_JOB_TOKEN registry.gitlab.com
    <span class="token punctuation">-</span> docker info
    <span class="token punctuation">-</span> docker build <span class="token punctuation">-</span>f ./Dockerfile <span class="token punctuation">-</span>t $CONTAINER_RELEASE_IMAGE public
    <span class="token punctuation">-</span> docker push $CONTAINER_RELEASE_IMAGE

<span class="token comment"># 根据自己的钩子修改下方的 URL</span>
<span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> curl https<span class="token punctuation">:</span>//xxx.xxx.xxx/api/webhooks/xxx <span class="token punctuation">-</span>X POST
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了保证服务更新的成功率，可以在 <code>deploy</code> 环节加个错误判断和重试次数，具体的看 GitLab 官方文档即可。</p>
<p>下面给出我的 Dockerfile 文件，供参考。</p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">FROM nginx:alpine

COPY . /usr/share/nginx/html

RUN chmod 777 /usr/share/nginx/html -R \
    &amp;&amp; sed -i 's/#error_page  404/error_page  404/' /etc/nginx/conf.d/default.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="一堆个性定制">一堆个性定制</h2>
<h3 id="个性美化">个性美化</h3>
<h4 id="修改主题颜色-2">修改主题颜色</h4>
<p>配色包括导航栏，底部栏，a标签等，主题配色是绿色。</p>
<p>修改themes\Matery\source\css\matery.css样式<br>
快捷键ctrl+F查找到#4cbf30（浅绿色）和#0f9d58（深绿色）还有首页字体颜色，修改为你喜欢的颜色</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* 整体背景颜色，包括导航、移动端的导航、页尾、标签页等的背景颜色. */</span> 
<span class="token selector">.bg-color</span> <span class="token punctuation">{</span> 
	<span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">linear-gradient</span><span class="token punctuation">(</span>to right<span class="token punctuation">,</span> #4cbf30 0%<span class="token punctuation">,</span> #0f9d58 100%<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
<span class="token comment">/*如果想去掉banner图的颜色渐变效果，请将以下的css属性注释掉或者删除掉即可*/</span> 
<span class="token atrule"><span class="token rule">@-webkit-keyframes</span> rainbow</span> <span class="token punctuation">{</span> 
	<span class="token comment">/* 动态切换背景颜色. */</span> 
<span class="token punctuation">}</span> 
<span class="token atrule"><span class="token rule">@keyframes</span> rainbow</span> <span class="token punctuation">{</span> 
	<span class="token comment">/* 动态切换背景颜色. */</span> 
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="背景樱花飘落效果">背景樱花飘落效果</h4>
<p>在<code>themes/matery/source/js</code>目录下新建<code>sakura.js</code>文件，打开这个网址<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/Yafine/cdn@3.3.1/source/js/sakura.js">传送门</a>，将内容复制粘贴到<code>sakura.js</code>即可。</p>
<p>然后在<code>themes/matery/layout/layout.ejs</code>文件内添加下面的内容：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/javascript"</span><span class="token operator">&gt;</span>
<span class="token comment">//只在桌面版网页启用特效</span>
<span class="token keyword">var</span> windowWidth <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>windowWidth <span class="token operator">&gt;</span> <span class="token number">768</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'&lt;script type="text/javascript" src="/js/sakura.js"&gt;&lt;\/script&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>修改花瓣的数量</strong></p>
<p>因为普遍在使用的樱花背景效果花瓣数太多了，一些人不太喜欢。</p>
<p>于是按不同花瓣数量做了几个新的 <code>js</code> ，并提供如下 <code>cdn</code> 形式的引用：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html">https://cdn.jsdelivr.net/gh/fz6m/Private-web@1.2/js/sakura/sakura-small.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>以上为少量樱花效果，另提供几个不同数量的文件引用名：</p>
<table>
<thead>
<tr>
<th style="text-align:left">文件名</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">sakura-small.js</td>
<td style="text-align:left">少量樱花</td>
</tr>
<tr>
<td style="text-align:left">sakura-half.js</td>
<td style="text-align:left">樱花相对原效果数量减半</td>
</tr>
<tr>
<td style="text-align:left">sakura-reduce.js</td>
<td style="text-align:left">樱花相对原效果减少1/4</td>
</tr>
<tr>
<td style="text-align:left">sakura-original.js</td>
<td style="text-align:left">樱花数量不变（原效果）</td>
</tr>
</tbody>
</table>
<h4 id="自定义鼠标样式">自定义鼠标样式</h4>
<p>首先将鼠标样式下载到本地，推荐大家一个网站：https://zhutix.com/ico/ori-cursors/</p>
<p>以我的为例，我将鼠标指针样式放在了主题文件夹下的medias目录下，然后打开<code>themes\matery\source\css</code>下的<strong>my.css</strong>文件，添加内容如下：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">*</span><span class="token punctuation">{</span>
    <span class="token property">cursor</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">"/medias/imgs/zhengchang.ico"</span><span class="token punctuation">)</span></span><span class="token punctuation">,</span>auto<span class="token important">!important</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">:active</span><span class="token punctuation">{</span>
    <span class="token property">cursor</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">"/medias/imgs/dianji.ico"</span><span class="token punctuation">)</span></span><span class="token punctuation">,</span>auto<span class="token important">!important</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="取消首页渐变颜色动画">取消首页渐变颜色动画</h4>
<p>在themes\Matery\source\css\matery.css，ctrl+F快捷键查找.bg-cover:after，注释掉即可。</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* .bg-cover:after {
    -webkit-animation: rainbow 60s infinite;
    animation: rainbow 60s infinite;
} */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="优化目录栏，透明化">优化目录栏，透明化</h4>
<p>目录样式竟然在：<code>themes\Matery\layout\_partial\post-detail-toc.ejs</code></p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.toc-widget</span> <span class="token punctuation">{</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 345px<span class="token punctuation">;</span>
    <span class="token property">padding-left</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">rgb</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 255<span class="token punctuation">,</span> 255<span class="token punctuation">,</span>0.7<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
    <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 10px 35px 2px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> .15<span class="token punctuation">)</span><span class="token punctuation">,</span> 0 5px 15px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> .07<span class="token punctuation">)</span><span class="token punctuation">,</span> 0 2px 5px -5px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> .1<span class="token punctuation">)</span> <span class="token important">!important</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="增加点击跳转评论按钮">增加点击跳转评论按钮</h4>
<p>新建文件<code>themes\Matery\layout\_partial\back-comment.ejs</code>,粘贴如下代码</p>
<p>我这里评论是valine，直接填写的valine的id——<code>href="#vcomments"</code>,如果是其他评论，对应修改即可。</p>
<pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs"><span class="token comment">&lt;!-- 直达评论 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>to_comment<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>comment-scroll<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn-floating btn-large waves-effect waves-light<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#vcomments<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>直达评论<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fas fa-comments<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在<code>themes\Matery\layout\_partial\valine.ejs</code>文末添加一条，引用第一步的内容；</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>%- partial<span class="token punctuation">(</span><span class="token string">'_partial/back-comment.ejs'</span><span class="token punctuation">)</span> %<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>则只在valine存在的页面才显示直达评论，防止首页其他地方也出现按钮。其实还可以优化为浮动出现，有一点麻烦，我这里没有设置。</p>
<p>增加样式在themes\Matery\source\css\matery.css添加内容如下：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/*直达评论按钮样式*/</span>
<span class="token selector">.comment-scroll</span> <span class="token punctuation">{</span>
    <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>
    <span class="token property">right</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>
    <span class="token property">bottom</span><span class="token punctuation">:</span> 135px<span class="token punctuation">;</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>
    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token property">z-index</span><span class="token punctuation">:</span> 998<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment-scroll .btn-floating</span> <span class="token punctuation">{</span>
    <span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">linear-gradient</span><span class="token punctuation">(</span>to bottom right<span class="token punctuation">,</span> #FF9999 0%<span class="token punctuation">,</span> #ff6666 100%<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 48px<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 48px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.comment-scroll .btn-floating i</span> <span class="token punctuation">{</span>
    <span class="token property">line-height</span><span class="token punctuation">:</span> 48px<span class="token punctuation">;</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 1.8rem<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>bottom: 135px;是距离底部的高度，看看你是否需要修改。</p>
<h4 id="修改滑动条">修改滑动条</h4>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* 滚动条 */</span>
<span class="token selector">::-webkit-scrollbar-thumb</span> <span class="token punctuation">{</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> #FF2A68<span class="token punctuation">;</span>
    <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">-webkit-linear-gradient</span><span class="token punctuation">(</span>45deg<span class="token punctuation">,</span><span class="token function">rgba</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span>255<span class="token punctuation">,</span>255<span class="token punctuation">,</span>.4<span class="token punctuation">)</span> 25%<span class="token punctuation">,</span>transparent 25%<span class="token punctuation">,</span>transparent 50%<span class="token punctuation">,</span><span class="token function">rgba</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span>255<span class="token punctuation">,</span>255<span class="token punctuation">,</span>.4<span class="token punctuation">)</span> 50%<span class="token punctuation">,</span><span class="token function">rgba</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span>255<span class="token punctuation">,</span>255<span class="token punctuation">,</span>.4<span class="token punctuation">)</span> 75%<span class="token punctuation">,</span>transparent 75%<span class="token punctuation">,</span>transparent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 3em<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">::-webkit-scrollbar-track</span> <span class="token punctuation">{</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> #ffcacaff<span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 3em<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">::-webkit-scrollbar</span> <span class="token punctuation">{</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="添加博客看板娘动漫人物挂件">添加博客看板娘	动漫人物挂件</h3>
<p>方法：</p>
<p>获取模型：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save hexo-helper-live2d<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装喜欢的模型：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> packagename<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>将packagename换成模型名字，如我使用的模型：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> live2d-widget-model-shizuku<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后打开博客根目录下的 _config.yml文件，添加如下代码：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Live2D</span>
<span class="token comment">## https://github.com/EYHN/hexo-helper-live2d</span>
<span class="token key atrule">live2d</span><span class="token punctuation">:</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token comment"># enable: false</span>
  <span class="token key atrule">pluginRootPath</span><span class="token punctuation">:</span> live2dw/ <span class="token comment"># Root path of plugin to be on the site (Relative)</span>
  <span class="token key atrule">pluginJsPath</span><span class="token punctuation">:</span> lib/ <span class="token comment"># JavaScript path related to plugin's root (Relative)</span>
  <span class="token key atrule">pluginModelPath</span><span class="token punctuation">:</span> assets/ <span class="token comment"># Relative model path related to plugin's root (Relative)</span>
  <span class="token key atrule">scriptFrom</span><span class="token punctuation">:</span> local <span class="token comment"># Default</span>
  <span class="token comment"># scriptFrom: jsdelivr # jsdelivr CDN</span>
  <span class="token comment"># scriptFrom: unpkg # unpkg CDN</span>
  <span class="token comment"># scriptFrom: https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js # Your custom url</span>
  <span class="token key atrule">tagMode</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># Whether only to replace live2d tag instead of inject to all pages</span>
  <span class="token key atrule">log</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># Whether to show logs in console</span>
  <span class="token key atrule">model</span><span class="token punctuation">:</span>
    <span class="token comment">#use: live2d-widget-model-lwet # npm-module package name</span>
    <span class="token comment"># use: wanko # folder name in (hexo base dir)/live2d_models/</span>
    <span class="token comment"># use: ./wives/wanko # folder path relative to hexo base dir</span>
    <span class="token comment"># 模型：https://huaji8.top/post/live2d-plugin-2.0/</span>
    <span class="token key atrule">use</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//cdn.jsdelivr.net/npm/live2d<span class="token punctuation">-</span>widget<span class="token punctuation">-</span>model<span class="token punctuation">-</span>wanko@1.0.5/assets/wanko.model.json <span class="token comment"># Your custom url</span>
  <span class="token key atrule">display</span><span class="token punctuation">:</span>
    <span class="token key atrule">position</span><span class="token punctuation">:</span> left
    <span class="token key atrule">width</span><span class="token punctuation">:</span> <span class="token number">300</span>
    <span class="token key atrule">height</span><span class="token punctuation">:</span> <span class="token number">400</span>
    <span class="token key atrule">hOffset</span><span class="token punctuation">:</span> <span class="token number">50</span>
    <span class="token key atrule">vOffset</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">mobile</span><span class="token punctuation">:</span>
    <span class="token key atrule">show</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>效果见本blog左下角</p>
<h3 id="Tag标签外挂使用方法">Tag标签外挂使用方法</h3>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">Tag标签外挂使用方法

{%r%}
紅色
{%endr%}
{%g%}
綠色
{%endg%}
{%y%}
黃色
{%endy%}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="图片懒加载">图片懒加载</h3>
<blockquote>
<p>图片懒加载是提升网站性能和用户体验的一个非常很好方式，并且几乎所有的大型网站都使用到了，比如微博，仅把用户可见的部分显示图片，其余的都暂时不加载，做法就是：让所有图片元素src指向一个小的站位图片比如loading，并新增一个属性(如data-original)存放真实图片地址。每当页面加载（或者滚动条滚动），使用JS脚本将可视区域内的图片src替换回真实地址，并做请求重新加载。</p>
</blockquote>
<p>那么，赶快用起来吧！</p>
<p>在站点根目录执行下面的命令：</p>
<pre class="line-numbers language-none"><code class="language-none">npm install hexo-lazyload-image --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>之后在站点配置文件下添加下面的代码</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">lazyload</span><span class="token punctuation">:</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 是否开启图片懒加载</span>
  <span class="token key atrule">onlypost</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 是否只对文章的图片做懒加载</span>
  <span class="token key atrule">loadingImg</span><span class="token punctuation">:</span> <span class="token comment"># eg ./images/loading.gif</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后执行 <code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo s</code> 就可以看到效果了。</p>
<h3 id="外链跳转插件">外链跳转插件</h3>
<p>使用 npm 或者 yarn 安装</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">## npm 安装</span>
<span class="token function">npm</span> <span class="token function">install</span> hexo-external-link --save
<span class="token comment">## yarn 安装</span>
<span class="token function">yarn</span> <span class="token function">add</span> hexo-external-link<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>之后在博客站点根目录下添加如下配置：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">hexo_external_link</span><span class="token punctuation">:</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">enable_base64_encode</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">url_param_name</span><span class="token punctuation">:</span> <span class="token string">'u'</span>
  <span class="token key atrule">html_file_name</span><span class="token punctuation">:</span> <span class="token string">'go.html'</span>
  <span class="token key atrule">target_blank</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">link_rel</span><span class="token punctuation">:</span> <span class="token string">'external nofollow noopener noreferrer'</span>
  <span class="token key atrule">domain</span><span class="token punctuation">:</span> <span class="token string">'your_domain'</span> <span class="token comment"># 如果开启了防盗链，填写你的域名</span>
  <span class="token key atrule">safety_chain</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="添加天气小插件">添加天气小插件</h3>
<p>首先去中国天气<a target="_blank" rel="noopener" href="https://cj.weather.com.cn/plugin/pc">官网：</a>，配置自己的插件，选择自定义插件—&gt;自定义样式——&gt;生成代码，然后会生成一段代码，复制粘贴到 <code>themes/matery/layout/layout.ejs</code> 即可。</p>
<h3 id="新增个人相册">新增个人相册</h3>
<h4 id="新建相册目录">新建相册目录</h4>
<p>执行下面的命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page galleries<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后到站点根目录的 source 目录下找名称为 <strong>galleries</strong> 的目录，打开目录下的 **index.md ** 文档，在原有基础上添加一下配置：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">type: <span class="token string">"galleries"</span>
layout: <span class="token string">"galleries"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>紧接着，在主题配置文件的 <code>menu</code> 属性添加关于相册的菜单</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">相册</span><span class="token punctuation">:</span>
  <span class="token key atrule">url</span><span class="token punctuation">:</span> /galleries 
  <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>image<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如果需要添加到二级菜单，添加格式为：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 相册
  <span class="token key atrule">url</span><span class="token punctuation">:</span> /galleries 
  <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>image<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="添加-ejs-文件和-css-文件">添加 ejs 文件和 css 文件</h4>
<p>首先新建 <code>gallery.css</code>，填写的代码内容如下：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.gallery-wrapper</span><span class="token punctuation">{</span>
  <span class="token property">padding-top</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.gallery-wrapper .gallery-box</span><span class="token punctuation">{</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 5px <span class="token important">!important</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.gallery-wrapper .gallery-item</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
  <span class="token property">padding-bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
  <span class="token property">-moz-box-shadow</span><span class="token punctuation">:</span> 0 1px 3px 0 <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.22<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">-webkit-box-shadow</span><span class="token punctuation">:</span> 0 1px 3px 0 <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.22<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 1px 3px 0 <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.22<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.gallery-cover-box</span><span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token property">padding-top</span><span class="token punctuation">:</span> 60%<span class="token punctuation">;</span>
  <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
  <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> center center no-repeat<span class="token punctuation">;</span>
  <span class="token property">-webkit-background-size</span><span class="token punctuation">:</span> cover<span class="token punctuation">;</span>
  <span class="token property">background-size</span><span class="token punctuation">:</span> cover<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.gallery-cover-box .gallery-cover-img</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
  <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">translate</span><span class="token punctuation">(</span>-50%<span class="token punctuation">,</span>-50%<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.gallery-item .gallery-name</span><span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
  <span class="token property">line-height</span><span class="token punctuation">:</span> 24px<span class="token punctuation">;</span>
  <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #666<span class="token punctuation">;</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.waterfall</span> <span class="token punctuation">{</span>
  <span class="token property">column-count</span><span class="token punctuation">:</span> 3<span class="token punctuation">;</span>
  <span class="token property">column-gap</span><span class="token punctuation">:</span> 1em<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.photo-wrapper</span><span class="token punctuation">{</span>
  <span class="token property">padding-top</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.photo-item</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
  <span class="token property">padding-bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">-moz-page-break-inside</span><span class="token punctuation">:</span> avoid<span class="token punctuation">;</span>
  <span class="token property">-webkit-column-break-inside</span><span class="token punctuation">:</span> avoid<span class="token punctuation">;</span>
  <span class="token property">break-inside</span><span class="token punctuation">:</span> avoid<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
  <span class="token property">-moz-box-shadow</span><span class="token punctuation">:</span> 0 1px 3px 0 <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.22<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">-webkit-box-shadow</span><span class="token punctuation">:</span> 0 1px 3px 0 <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.22<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 1px 3px 0 <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.22<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.photo-item img</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.photo-item .photo-name</span><span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
  <span class="token property">line-height</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
  <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">margin-top</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
  <span class="token property">border-top</span><span class="token punctuation">:</span> 1px solid #dddddd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*适配移动端布局*/</span>
<span class="token atrule"><span class="token rule">@media</span> <span class="token keyword">only</span> screen <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 601px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">.waterfall</span> <span class="token punctuation">{</span>
    <span class="token property">column-count</span><span class="token punctuation">:</span> 2<span class="token punctuation">;</span>
    <span class="token property">column-gap</span><span class="token punctuation">:</span> 1em<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后保存，将此文件放在主题目录下，路径为 <strong>matery/source/css</strong>。</p>
<p>紧接着，新建 <code>galleries.ejs</code> 文件，添加以下代码：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"/css/gallery.css"</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">-</span> <span class="token function">partial</span><span class="token punctuation">(</span><span class="token string">'_partial/bg-cover'</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>main <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"content"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"container"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>site<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span> site<span class="token punctuation">.</span>data<span class="token punctuation">.</span>galleries<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">var</span> galleries <span class="token operator">=</span> site<span class="token punctuation">.</span>data<span class="token punctuation">.</span>galleries<span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"gallery-wrapper row"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> galleries<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">var</span> gallery <span class="token operator">=</span> galleries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"col s6 m4 l4 xl3 gallery-box"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"./&lt;%- gallery.name %&gt;"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"gallery-item"</span> data<span class="token operator">-</span>aos<span class="token operator">=</span><span class="token string">"zoom-in-up"</span><span class="token operator">&gt;</span>
                     <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"gallery-cover-box"</span> style<span class="token operator">=</span><span class="token string">"background-image: url(&lt;%- theme.jsDelivr.url %&gt;&lt;%- gallery.cover%&gt;);"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"gallery-name"</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">-</span> gallery<span class="token punctuation">.</span>name <span class="token operator">%</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>main<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将此文件放在 <strong>matery/layout</strong> 目录下，同时再此目录下接着新建 <code>gallery.ejs</code> 文件，添加以下代码：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"/css/gallery.css"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>link type<span class="token operator">=</span><span class="token string">"text/css"</span> href<span class="token operator">=</span><span class="token string">"/libs/fancybox/jquery.fancybox.css"</span> rel<span class="token operator">=</span><span class="token string">"stylesheet"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>link type<span class="token operator">=</span><span class="token string">"text/css"</span> href<span class="token operator">=</span><span class="token string">"/libs/justifiedGallery/justifiedGallery.min.css"</span> rel<span class="token operator">=</span><span class="token string">"stylesheet"</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">-</span> <span class="token function">partial</span><span class="token punctuation">(</span><span class="token string">'_partial/post-cover'</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">%</span>
<span class="token keyword">let</span> galleries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>site<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span> site<span class="token punctuation">.</span>data<span class="token punctuation">.</span>galleries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    galleries <span class="token operator">=</span> site<span class="token punctuation">.</span>data<span class="token punctuation">.</span>galleries<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> pageTitle <span class="token operator">=</span> page<span class="token punctuation">.</span>title<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">getCurrentGallery</span><span class="token punctuation">(</span><span class="token parameter">galleries<span class="token punctuation">,</span> pageTitle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> galleries<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>galleries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">==</span> pageTitle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> galleries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> currentGallery <span class="token operator">=</span> <span class="token function">getCurrentGallery</span><span class="token punctuation">(</span>galleries<span class="token punctuation">,</span> pageTitle<span class="token punctuation">)</span>

<span class="token keyword">var</span> photos <span class="token operator">=</span> currentGallery<span class="token punctuation">.</span>photos<span class="token punctuation">;</span>
<span class="token keyword">var</span> galleryImageStr <span class="token operator">=</span> theme<span class="token punctuation">.</span>jsDelivr<span class="token punctuation">.</span>url <span class="token operator">?</span> theme<span class="token punctuation">.</span>jsDelivr<span class="token punctuation">.</span>url <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> imageStr <span class="token operator">=</span> <span class="token string">''</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> photos<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> photo <span class="token operator">=</span> photos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    imageStr <span class="token operator">+=</span> <span class="token string">"&lt;a href=\""</span> <span class="token operator">+</span> galleryImageStr <span class="token operator">+</span> photo <span class="token operator">+</span> <span class="token string">"\""</span> <span class="token operator">+</span>
            <span class="token string">"     class=\"photo-item\" rel=\"example_group\""</span> <span class="token operator">+</span>
            <span class="token string">"     data-fancybox=\"images\"&gt;"</span> <span class="token operator">+</span>
            <span class="token string">"      &lt;img src=\""</span> <span class="token operator">+</span> galleryImageStr <span class="token operator">+</span> photo <span class="token operator">+</span> <span class="token string">"\""</span> <span class="token operator">+</span>
            <span class="token string">"       alt="</span> <span class="token operator">+</span> photo <span class="token operator">+</span> <span class="token string">"&gt;\n"</span> <span class="token operator">+</span>
            <span class="token string">"    &lt;/a&gt;"</span>

<span class="token punctuation">}</span>
<span class="token operator">%</span><span class="token operator">&gt;</span>  

<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"container"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"photo-wrapper"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">.</span>password <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>

            <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"/js/crypto-js.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"/js/gallery-encrypt.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"hbe-security"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"hbe-input-container"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"password"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"hbe-form-control"</span> id<span class="token operator">=</span><span class="token string">"pass"</span>  placeholder<span class="token operator">=</span><span class="token string">"请输入密码查看内容"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"javascript:;"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn-decrypt"</span> id<span class="token operator">=</span><span class="token string">"btn_decrypt"</span><span class="token operator">&gt;</span>解密<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div  id<span class="token operator">=</span><span class="token string">"mygallery"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"waterfall"</span> id<span class="token operator">=</span><span class="token string">"encrypt-blog"</span> style<span class="token operator">=</span><span class="token string">"display:none"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">-</span> <span class="token function">aes</span><span class="token punctuation">(</span>imageStr<span class="token punctuation">,</span> page<span class="token punctuation">.</span>password<span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"waterfall"</span> id<span class="token operator">=</span><span class="token string">"encrypt-blog"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">-</span> imageStr <span class="token operator">%</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"/libs/fancybox/fancybox.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"/libs/justifiedGallery/justifiedGallery.min.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>

  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"a[rel=example_group]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fancybox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#encrypt-blog"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">justifiedGallery</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">margins</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token literal-property property">rowHeight</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>注意：</strong></p>
<ol>
<li>需要几个文件，我把文件地址放在下面，用浏览器打开链接，就会显示出代码，然后复制粘贴到文加中去就行。开头的是文件路径，如果没有的话，就新建一个就 OK 了。</li>
</ol>
<ul>
<li>
<p><strong>libs/fancybox/jquery.fancybox.css</strong>：</p>
<p>https://blog.17lai.site/libs/fancybox/jquery.fancybox.css</p>
</li>
<li>
<p>libs/justifiedGallery/justifiedGallery.min.css：</p>
<p>https://blog.17lai.site/libs/justifiedGallery/justifiedGallery.min.css</p>
</li>
<li>
<p><strong>matery/source/js/crypto-js.js：</strong></p>
<p>https://blog.17lai.site/js/crypto-js.js</p>
</li>
<li>
<p><strong>matery/source/js/gallery-encrypt.js：</strong></p>
<p>https://blog.17lai.site/js/gallery-encrypt.js</p>
</li>
<li>
<p><strong>libs/fancybox/fancybox.js：</strong></p>
<p>https://blog.17lai.site/libs/fancybox/fancybox.js</p>
</li>
<li>
<p>libs/justifiedGallery/justifiedGallery.min.js：</p>
<p>https://blog.17lai.site/libs/justifiedGallery/justifiedGallery.min.js</p>
</li>
</ul>
<h4 id="添加相册-json-配置文件">添加相册 json 配置文件</h4>
<p>在<code>站点</code>目录 <code>source/_data/</code> 下新建一个 <strong>galleries.json</strong> 的文件，<strong>json</strong> 代码如下：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"2020"</span><span class="token punctuation">,</span>
      <span class="token property">"cover"</span><span class="token operator">:</span> <span class="token string">"/medias/images/01.jpg"</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"我的图床"</span><span class="token punctuation">,</span>
      <span class="token property">"photos"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"/medias/images/01.jpg"</span><span class="token punctuation">,</span>
        <span class="token string">"/medias/images/02.jpg"</span><span class="token punctuation">,</span>
        <span class="token string">"/medias/images/03.jpg"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>字段含义：</p>
<ul>
<li><code>name</code> 是相册标题</li>
<li><code>cover</code> 是封面图片</li>
<li><code>description</code> 是相册介绍</li>
<li><code>photos</code> 是图片列表</li>
</ul>
<p>配置文件建好了之后还没完，只剩最后一个步骤了，在 <strong>galleries 目录</strong>下建立对应的相册名称目录和文件，比如我这个相册需要新建名称为 2020 目录，然后下面再分别新建 <code>index.md</code> 文件，文件内容为：</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token front-matter-block"><span class="token punctuation">---</span>
<span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token number">2020</span>
<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2021-10-13 10:51:50</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"gallery"</span>
<span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"gallery"</span></span>
<span class="token punctuation">---</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="查看效果">查看效果</h4>
<p>完成以上步骤，执行命令，在本地查看效果：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo clean <span class="token operator">&amp;&amp;</span> hexo g <span class="token operator">&amp;&amp;</span> hexo s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="我的效果">我的效果</h4>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1320211013084134.png" alt=""></p>
<h3 id="新增折叠功能">新增折叠功能</h3>
<blockquote>
<p>这里利用<code>hexo-sliding-spoiler</code>插件间接实现折叠功能，在matery主题中零修改源代码实现折叠功能。</p>
<p>另一种修改代码实现折叠效果，参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/woshimrf/p/hexo-fold-block.html">Hexo next博客添加折叠块功能添加折叠代码块</a>。</p>
</blockquote>
<h4 id="安装插件-2">安装插件</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-sliding-spoiler --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="配置插件">配置插件</h4>
<p>根目录配置文件<code>_config.yml</code>中添加</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">plugin</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> hexo<span class="token punctuation">-</span>sliding<span class="token punctuation">-</span>spoiler<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>到这里已经实现折叠功能了。</p>
<h4 id="进一步完善美化">进一步完善美化</h4>
<p>修改node_modules_hexo-sliding-spoiler@1.2.1@hexo-sliding-spoiler\assets\spoiler.css</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.spoiler</span> <span class="token punctuation">{</span>
    <span class="token property">margin</span><span class="token punctuation">:</span> 20px 0<span class="token punctuation">;</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>
    <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #E5E5E5<span class="token punctuation">;</span>
    <span class="token property">background</span><span class="token punctuation">:</span> #E5E5E5<span class="token punctuation">;</span>
    <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
    <span class="token property">clear</span><span class="token punctuation">:</span> both<span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 3px<span class="token punctuation">;</span>
    <span class="token property">transition</span><span class="token punctuation">:</span>all .6s
<span class="token punctuation">}</span>

<span class="token selector">.spoiler .spoiler-title</span> <span class="token punctuation">{</span>
    <span class="token property">margin</span><span class="token punctuation">:</span> 0 -15px<span class="token punctuation">;</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 5px 15px<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #353535<span class="token punctuation">;</span>
    <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 18px<span class="token punctuation">;</span>
    <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
    <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.spoiler.collapsed .spoiler-title:before</span> <span class="token punctuation">{</span>
    <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">"▶ "</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.spoiler.expanded .spoiler-title:before</span> <span class="token punctuation">{</span>
    <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">"▼ "</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用方法</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% spoiler title %}
content
{% endspoiler %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>实例</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% spoiler 点击显/隐内容 %}

内容测试

{% endspoiler %}

{% spoiler 点击显/隐内容 %}

内容测试

{% endspoiler %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012105432.png" alt=""></p>
<h3 id="让Hexo博客支持通知功能">让Hexo博客支持通知功能</h3>
<h4 id="安装插件-3">安装插件</h4>
<p>插件的 GitHub 仓库<a target="_blank" rel="noopener" href="https://github.com/glazec/hexo-web-push-notification"> hexo-web-push-notification</a></p>
<p>在你的博客站点目录执行下面的命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i hexo-web-push-notification --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果你安装了 <code>cnpm</code> 或者 <code>yarn</code> 等可执行下面的命令，安装依赖包的速度更快：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cnpm i hexo-web-push-notification --save <span class="token comment">#安装cnpm的执行这个命令</span>
<span class="token function">yarn</span> <span class="token function">add</span> hexo-web-push-notification <span class="token comment">#安装yarn的执行这个命令</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>紧接着再你的博客站点目录下的配置文件，而不是<em>主题配置文件</em>，添加以下配置：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">webPushNotification</span><span class="token punctuation">:</span>
  <span class="token key atrule">webpushrKey</span><span class="token punctuation">:</span> <span class="token string">"your webpushr rest api key"</span>
  <span class="token key atrule">webpushrAuthToken</span><span class="token punctuation">:</span> <span class="token string">"your webpushr authorize token"</span>
  <span class="token key atrule">trackingCode</span><span class="token punctuation">:</span> <span class="token string">"AEGlpbdgvBCWXqXI6PtsUzobY7TLV9gwJU8bzMktrwfrSERg_xnLVbjpCw8x2GmFmi1ZcLTz0ni6OnX5MAwoM88"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中 <code>webpushrKey</code>,<code>webpushrAuthToken</code> 和 <code>trackingCode</code> 的值在官网注册得到。</p>
<h4 id="官网注册">官网注册</h4>
<p>点击右边的图标即可进入👉 ： <a target="_blank" rel="noopener" href="https://app.webpushr.com/signup">传送门</a></p>
<p>注册完之后，然后会让你重新登录，登录之后，然后填写相关的信息即可。</p>
<ol>
<li>填写图中所显示的相关网站信息，填写完之后，点击下一步</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012112936.png" alt=""></p>
<blockquote>
<p><code>Web push notications</code> 仅支持 HTTPS 的网站，不支持 HTTP 的网站</p>
</blockquote>
<p>根据网站类型，并根据网站指引进行操作，以 <code>Hexo</code> 为例</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012114232.png" alt=""></p>
<blockquote>
<p>info， 其中将第二步中所指的代码复制粘贴到你的 <code>footer.ejs</code> 或者 <code>layout.ejs</code>，对于 hexo 用户，建议将其加入 <code>index.ejs</code> 即可。因为主题的不同，所以代码添加的位置不同，简单的说，就是放在网站的 <code>&lt;/body&gt;</code> 标签之前，根据你的主题而言，自己添加。</p>
</blockquote>
<p>接着将以下代码插入到网页中就可以了。确保每一个你想要询问用户接受通知的页面都要包含以下代码。</p>
<p>其中，上图步骤二中的代码有 <code>trackingCode</code> 的值，如下图中所标明的一长串字母。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012114333.png" alt=""></p>
<p>验证安装</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012114406.png" alt="安装成功"></p>
<p>部署之后可能会遇到无法正常发送通知的情况.</p>
<p>进入目录<code> node_modules/hexo-web-push-notification/index.js文件中第22行'summary': util.stripHTML(newPost.excerpt)</code>,这里取值取的是excerpt，改成summary即可。</p>
<p>修改前</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> JSONFeed <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string-property property">'title'</span><span class="token operator">:</span> newPost<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
        <span class="token string-property property">'id'</span><span class="token operator">:</span> newPost<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
        <span class="token string-property property">'date_published'</span><span class="token operator">:</span> newPost<span class="token punctuation">.</span>date<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'summary'</span><span class="token operator">:</span> util<span class="token punctuation">.</span><span class="token function">stripHTML</span><span class="token punctuation">(</span>newPost<span class="token punctuation">.</span>excerpt<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'url'</span><span class="token operator">:</span> newPost<span class="token punctuation">.</span>permalink<span class="token punctuation">,</span>
        <span class="token string-property property">'tags'</span><span class="token operator">:</span> newPost<span class="token punctuation">.</span>tags<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> v<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'categories'</span><span class="token operator">:</span> newPost<span class="token punctuation">.</span>categories<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> v<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> JSONFeed <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string-property property">'title'</span><span class="token operator">:</span> newPost<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
        <span class="token string-property property">'id'</span><span class="token operator">:</span> newPost<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
        <span class="token string-property property">'date_published'</span><span class="token operator">:</span> newPost<span class="token punctuation">.</span>date<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'summary'</span><span class="token operator">:</span> util<span class="token punctuation">.</span><span class="token function">stripHTML</span><span class="token punctuation">(</span>newPost<span class="token punctuation">.</span>summary<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'url'</span><span class="token operator">:</span> newPost<span class="token punctuation">.</span>permalink<span class="token punctuation">,</span>
        <span class="token string-property property">'tags'</span><span class="token operator">:</span> newPost<span class="token punctuation">.</span>tags<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> v<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'categories'</span><span class="token operator">:</span> newPost<span class="token punctuation">.</span>categories<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> v<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="客服聊天窗口">客服聊天窗口</h3>
<p>1、在官网注册账号</p>
<p>官网地址：<a target="_blank" rel="noopener" href="https://app.crisp.chat/initiate/signup/">点我去crisp官网注册</a></p>
<p>2、注册完成后设置</p>
<p>登录刚才注册的账户——设置——网站设置——添加网站。</p>
<p>添加完成之后就多了一行网站信息。点网站整合，就有不同的站的整合方式。</p>
<p>比如：html方式</p>
<p>就是复制JS代码片段到你的到<code>head</code>标签里。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/javascript"</span><span class="token operator">&gt;</span>window<span class="token punctuation">.</span>$crisp<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>window<span class="token punctuation">.</span><span class="token constant">CRISP_WEBSITE_ID</span><span class="token operator">=</span><span class="token string">"xxxxxxx-097e-402f-bb6b-xxxxxxx"</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>d<span class="token operator">=</span>document<span class="token punctuation">;</span>s<span class="token operator">=</span>d<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"script"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>s<span class="token punctuation">.</span>src<span class="token operator">=</span><span class="token string">"https://client.crisp.chat/l.js"</span><span class="token punctuation">;</span>s<span class="token punctuation">.</span>async<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>d<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">"head"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>3、其他的设置也<br>
登录刚才注册的账户——设置——网站设置。<br>
网站信息行——设置，自己根据需要设置即可，比如显示位置，颜色，自己的头像等。</p>
<p>整个使用非常简单的。</p>
<h3 id="使用Valine-Admin管理评论和评论提醒">使用Valine-Admin管理评论和评论提醒</h3>
<h4 id="使用-2">使用</h4>
<p>首先其他的不错说了，在阅读本篇文章之前你最好已经整合了<code>Valine</code>留言。</p>
<p>由于我已经整合过了所以前面几个步骤的图片来源自@Valine-Admin</p>
<p>首先登陆账号，找到云引擎在点击设置。</p>
<blockquote>
<p>复制仓库地址：<a target="_blank" rel="noopener" href="https://github.com/DesertsP/Valine-Admin">DesertsP/Valine-Admin</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1920211019004314.png" alt="img"></p>
<p>把git仓库地址房子代码库输入框中。</p>
<p>切换到部署标签页，分支使用 master，点击部署。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1920211019005041.png" alt="img"></p>
<p>接下来输入分支为<code>master</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1920211019005044.png" alt="img"></p>
<p>部署完成之后就是设置环境变量</p>
<h4 id="环境变量">环境变量</h4>
<p>点击设置，找到自定义环境变量点击新增变量</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1920211019005055.png" alt="img"></p>
<ul>
<li><code>SITE_NAME</code> : 网站名称。</li>
<li><code>SITE_URL</code> : 网站地址, <strong>最后不要加 <code>/</code> 。</strong></li>
<li><code>SMTP_USER</code> : SMTP 服务用户名，一般为邮箱地址。</li>
<li><code>SMTP_PASS</code> : SMTP 密码，一般为授权码，而不是邮箱的登陆密码，请自行查询对应邮件服务商的获取方式</li>
<li><code>SMTP_SERVICE</code> : 邮件服务提供商，支持 <code>QQ</code>、<code>163</code>、<code>126</code>、<code>Gmail</code>、<code>"Yahoo"</code>、<code>......</code> ，全部支持请参考 : <a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=rwjb6jO8Z6x5%2FZZ1q6w%2FaQ%3D%3D.c2CTXx8YrmrN3w%2BVCYtYe%2FsUgGzhUYn%2F%2BbjgGgV2S51GBFVQiTGaYl5o5UaNumJuwdhJ%2FnoFgOTGclNq8Noalw%3D%3D">Nodemailer Supported services</a>。 — <em>如这里没有你使用的邮件提供商，请查看<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=oVf5otkSfg0SdXBBeouLJA%3D%3D.0hcduHENfwuLs%2BpqYrgereNYPsZQ8kcfWmApG6UOpW2OmWOpqe8zkNwbXW9e7luhj6rGequwkCAxtpvF7Gyy9PwnwqwQ5vJrYfxsl%2FPocUV4bFVAFieliaIgGegSBiRXBRqzzewoxolE7zsPuIMxsNSs9EsJDNkovE4qn4Bk2Bv4KZs6ctloQUQGK0BxiN26">自定义邮件服务器</a></em></li>
<li><code>SENDER_NAME</code> : 寄件人名称。</li>
<li><code>TO_EMAIL</code>：这个是填收邮件提醒的邮箱地址，若没有这个字段，则将邮件发到<code>SMTP_USER</code>。</li>
<li><code>TEMPLATE_NAME</code>：设置提醒邮件的主题，目前内置了两款主题，分别为 <code>default</code> 与 <code>rainbow</code>。默认为 <code>default</code></li>
</ul>
<p>设置好以上变量之后 点击实例</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1920211019005407.png" alt="img"></p>
<p>然后重启项目，注意任何变动都要重启项目</p>
<p>然后看一下效果</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1920211019005102.png" alt="img"></p>
<p>还不错</p>
<h4 id="自定义后台">自定义后台</h4>
<blockquote>
<p>首先需要设置管理员信息。访问管理员注册页面<code>https://云引擎域名/sign-up</code>，注册管理员登录信息，如：https://deserts-io.avosapps.us/sign-up</p>
</blockquote>
<p>点击设置然后点击Web主机域名找到自己的后台地址</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1920211019005103.png" alt="img"></p>
<p>然后在Usee表中增加账号， 只需要填写 <code>email</code>、<code>password</code>、<code>username</code> 其中邮箱必须设置为你的上面环境变量的邮箱</p>
<p>设置完之后登录就能在你的后台管理评论</p>
<h4 id="更多设置">更多设置</h4>
<h5 id="邮件通知模板">邮件通知模板</h5>
<p>邮件通知模板在云引擎环境变量中设定，可自定义通知邮件标题及内容模板。</p>
<table>
<thead>
<tr>
<th style="text-align:left">环境变量</th>
<th style="text-align:left">示例</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">MAIL_SUBJECT</td>
<td style="text-align:left"><img src="https://math.now.sh/?inline=%7BPARENT_NICK%7D%EF%BC%8C%E6%82%A8%E5%9C%A8" alt="img">{SITE_NAME}上的评论收到了回复</td>
<td style="text-align:left">[可选]@通知邮件主题（标题）模板</td>
</tr>
<tr>
<td style="text-align:left">MAIL_TEMPLATE</td>
<td style="text-align:left">见下文</td>
<td style="text-align:left">[可选]@通知邮件内容模板</td>
</tr>
<tr>
<td style="text-align:left">MAIL_SUBJECT_ADMIN</td>
<td style="text-align:left">${SITE_NAME}上有新评论了</td>
<td style="text-align:left">[可选]博主邮件通知主题模板</td>
</tr>
<tr>
<td style="text-align:left">MAIL_TEMPLATE_ADMIN</td>
<td style="text-align:left">见下文</td>
<td style="text-align:left">[可选]博主邮件通知内容模板</td>
</tr>
</tbody>
</table>
<p>邮件通知包含两种，分别是被@通知和博主通知，这两种模板都可以完全自定义。默认使用经典的蓝色风格模板（样式来源未知）。</p>
<p>默认被@通知邮件内容模板如下：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">border-top</span><span class="token punctuation">:</span>2px solid #12ADDB<span class="token punctuation">;</span><span class="token property">box-shadow</span><span class="token punctuation">:</span>0 1px 3px #AAAAAA<span class="token punctuation">;</span><span class="token property">line-height</span><span class="token punctuation">:</span>180%<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span>0 15px 12px<span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>50px auto<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>12px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">border-bottom</span><span class="token punctuation">:</span>1px solid #DDD<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>14px<span class="token punctuation">;</span><span class="token property">font-weight</span><span class="token punctuation">:</span>normal<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span>13px 0 10px 8px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>您在<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span> #12ADDB<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${SITE_URL}<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            ${SITE_NAME}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>上的评论有了新的回复<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span> ${PARENT_NICK} 同学，您曾发表评论：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">padding</span><span class="token punctuation">:</span>0 12px 0 12px<span class="token punctuation">;</span><span class="token property">margin-top</span><span class="token punctuation">:</span>18px</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">background-color</span><span class="token punctuation">:</span> #f5f5f5<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span> 10px 15px<span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>18px 0<span class="token punctuation">;</span><span class="token property">word-wrap</span><span class="token punctuation">:</span>break-word<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>            ${PARENT_COMMENT}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>${NICK}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>回复说：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">background-color</span><span class="token punctuation">:</span> #f5f5f5<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span> 10px 15px<span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>18px 0<span class="token punctuation">;</span><span class="token property">word-wrap</span><span class="token punctuation">:</span>break-word<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span> ${COMMENT}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>您可以点击<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span>#12addb</span><span class="token punctuation">"</span></span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${POST_URL}<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>查看回复的完整內容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>，欢迎再次光临<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span>#12addb</span><span class="token punctuation">"</span></span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${SITE_URL}<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>${SITE_NAME}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>。<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>效果如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1920211019005650.png" alt="mail-blue-template"></p>
<p><strong>mail-blue-template</strong></p>
<p>@通知模板中的可用变量如下（注，这是邮件模板变量，是指嵌入到HTML邮件模板中的变量，请勿与云引擎环境变量混淆）：</p>
<table>
<thead>
<tr>
<th style="text-align:left">模板变量</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SITE_NAME</td>
<td style="text-align:left">博客名称</td>
</tr>
<tr>
<td style="text-align:left">SITE_URL</td>
<td style="text-align:left">博客首页地址</td>
</tr>
<tr>
<td style="text-align:left">POST_URL</td>
<td style="text-align:left">文章地址（完整路径）</td>
</tr>
<tr>
<td style="text-align:left">PARENT_NICK</td>
<td style="text-align:left">收件人昵称（被@者，父级评论人）</td>
</tr>
<tr>
<td style="text-align:left">PARENT_COMMENT</td>
<td style="text-align:left">父级评论内容</td>
</tr>
<tr>
<td style="text-align:left">NICK</td>
<td style="text-align:left">新评论者昵称</td>
</tr>
<tr>
<td style="text-align:left">COMMENT</td>
<td style="text-align:left">新评论内容</td>
</tr>
</tbody>
</table>
<p>默认博主通知邮件内容模板如下：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">border-top</span><span class="token punctuation">:</span>2px solid #12ADDB<span class="token punctuation">;</span><span class="token property">box-shadow</span><span class="token punctuation">:</span>0 1px 3px #AAAAAA<span class="token punctuation">;</span><span class="token property">line-height</span><span class="token punctuation">:</span>180%<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span>0 15px 12px<span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>50px auto<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>12px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">border-bottom</span><span class="token punctuation">:</span>1px solid #DDD<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>14px<span class="token punctuation">;</span><span class="token property">font-weight</span><span class="token punctuation">:</span>normal<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span>13px 0 10px 8px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>您在<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span> #12ADDB<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${SITE_URL}<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>${SITE_NAME}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>上的文章有了新的评论<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>${NICK}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>回复说：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">background-color</span><span class="token punctuation">:</span> #f5f5f5<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span> 10px 15px<span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>18px 0<span class="token punctuation">;</span><span class="token property">word-wrap</span><span class="token punctuation">:</span>break-word<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span> ${COMMENT}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>您可以点击<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span>#12addb</span><span class="token punctuation">"</span></span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${POST_URL}<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>查看回复的完整內容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>博主通知邮件模板中的可用变量与@通知中的基本一致，<strong><code>PARENT_NICK</code> 和 <code>PARENT_COMMENT</code> 变量不再可用。</strong></p>
<p>这里还提供一个彩虹风格的@通知邮件模板代码：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">border-radius</span><span class="token punctuation">:</span> 10px 10px 10px 10px<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>13px<span class="token punctuation">;</span>    <span class="token property">color</span><span class="token punctuation">:</span> #555555<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 666px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span><span class="token string">'Century Gothic'</span><span class="token punctuation">,</span><span class="token string">'Trebuchet MS'</span><span class="token punctuation">,</span><span class="token string">'Hiragino Sans GB'</span><span class="token punctuation">,</span>微软雅黑<span class="token punctuation">,</span><span class="token string">'Microsoft Yahei'</span><span class="token punctuation">,</span>Tahoma<span class="token punctuation">,</span>Helvetica<span class="token punctuation">,</span>Arial<span class="token punctuation">,</span><span class="token string">'SimSun'</span><span class="token punctuation">,</span>sans-serif<span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>50px auto<span class="token punctuation">;</span><span class="token property">border</span><span class="token punctuation">:</span>1px solid #eee<span class="token punctuation">;</span><span class="token property">max-width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">background</span><span class="token punctuation">:</span> #ffffff <span class="token function">repeating-linear-gradient</span><span class="token punctuation">(</span>-45deg<span class="token punctuation">,</span>#fff<span class="token punctuation">,</span>#fff 1.125rem<span class="token punctuation">,</span>transparent 1.125rem<span class="token punctuation">,</span>transparent 2.25rem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 1px 5px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.15<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">background</span><span class="token punctuation">:</span>#49BDAD<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>#ffffff<span class="token punctuation">;</span><span class="token property">border-radius</span><span class="token punctuation">:</span> 10px 10px 0 0<span class="token punctuation">;</span><span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">-moz-linear-gradient</span><span class="token punctuation">(</span>0deg<span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>67<span class="token punctuation">,</span> 198<span class="token punctuation">,</span> 184<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 209<span class="token punctuation">,</span> 244<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">-webkit-linear-gradient</span><span class="token punctuation">(</span>0deg<span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>67<span class="token punctuation">,</span> 198<span class="token punctuation">,</span> 184<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 209<span class="token punctuation">,</span> 244<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span> 66px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">font-size</span><span class="token punctuation">:</span>15px<span class="token punctuation">;</span><span class="token property">word-break</span><span class="token punctuation">:</span>break-all<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span> 23px 32px<span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span><span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">hsla</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span>0%<span class="token punctuation">,</span>100%<span class="token punctuation">,</span>.4<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">border-radius</span><span class="token punctuation">:</span> 10px 10px 0 0<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>您在<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span> #ffffff<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${SITE_URL}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> ${SITE_NAME}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>上的留言有新回复啦！<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">margin</span><span class="token punctuation">:</span>40px auto<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>90%</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>${PARENT_NICK} 同学，您曾在文章上发表评论：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">background</span><span class="token punctuation">:</span> #fafafa <span class="token function">repeating-linear-gradient</span><span class="token punctuation">(</span>-45deg<span class="token punctuation">,</span>#fff<span class="token punctuation">,</span>#fff 1.125rem<span class="token punctuation">,</span>transparent 1.125rem<span class="token punctuation">,</span>transparent 2.25rem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 2px 5px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.15<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>20px 0px<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span>15px<span class="token punctuation">;</span><span class="token property">border-radius</span><span class="token punctuation">:</span>5px<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>14px<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>#555555<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>${PARENT_COMMENT}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>${NICK} 给您的回复如下：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">background</span><span class="token punctuation">:</span> #fafafa <span class="token function">repeating-linear-gradient</span><span class="token punctuation">(</span>-45deg<span class="token punctuation">,</span>#fff<span class="token punctuation">,</span>#fff 1.125rem<span class="token punctuation">,</span>transparent 1.125rem<span class="token punctuation">,</span>transparent 2.25rem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 2px 5px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.15<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>20px 0px<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span>15px<span class="token punctuation">;</span><span class="token property">border-radius</span><span class="token punctuation">:</span>5px<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>14px<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>#555555<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>${COMMENT}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>您可以点击<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span>#12addb</span><span class="token punctuation">"</span></span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${POST_URL}#comments<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>查看回复的完整內容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>，欢迎再次光临<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span>#12addb</span><span class="token punctuation">"</span></span></span>                <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${SITE_URL}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> ${SITE_NAME}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>。<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css"><span class="token selector">a:link</span><span class="token punctuation">{</span><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">}</span><span class="token selector">a:visited</span><span class="token punctuation">{</span><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">}</span><span class="token selector">a:hover</span><span class="token punctuation">{</span><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">}</span><span class="token selector">a:active</span><span class="token punctuation">{</span><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>效果如图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1920211019005726.png" alt="彩虹模板"></p>
<p><strong>彩虹模板</strong></p>
<h4 id="垃圾评论检测">垃圾评论检测</h4>
<blockquote>
<p>Akismet (Automattic Kismet)是应用广泛的一个垃圾留言过滤系统，其作者是大名鼎鼎的WordPress 创始人 Matt Mullenweg，Akismet也是WordPress默认安装的插件，其使用非常广泛，设计目标便是帮助博客网站来过滤留言Spam。有了Akismet之后，基本上不用担心垃圾留言的烦恼了。 启用Akismet后，当博客再收到留言会自动将其提交到Akismet并与Akismet上的黑名单进行比对，如果名列该黑名单中，则该条留言会被标记为垃圾评论且不会发布。</p>
</blockquote>
<p>如果还没有Akismet Key，你可以去 <a target="_blank" rel="noopener" href="https://akismet.com/development/">AKISMET FOR DEVELOPERS 免费申请一个</a>； <strong>当AKISMET_KEY设为MANUAL_REVIEW时，开启人工审核模式；</strong> 如果你不需要反垃圾评论，Akismet Key 环境变量可以忽略。</p>
<p><strong>为了实现较为精准的垃圾评论识别，采集的判据除了评论内容、邮件地址和网站地址外，还包括评论者的IP地址、浏览器信息等，但仅在云引擎后台使用这些数据，确保隐私和安全。</strong></p>
<p><strong>如果使用了本站最新的Valine和Valine Admin，并设置了Akismet Key，可以有效地拦截垃圾评论。被标为垃圾的评论可以在管理页面取消标注。</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">环境变量</th>
<th style="text-align:left">示例</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">AKISMET_KEY</td>
<td style="text-align:left">xxxxxxxxxxxx</td>
<td style="text-align:left">[可选]Akismet Key 用于垃圾评论检测</td>
</tr>
</tbody>
</table>
<h4 id="手动配置邮件服务器">手动配置邮件服务器</h4>
<ul>
<li>自定义邮件服务器地址和端口信息，删除SMTP_SERVICE环境变量，新增以下变量：</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">变量</th>
<th style="text-align:left">示例</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SMTP_HOST</td>
<td style="text-align:left"><a target="_blank" rel="noopener" href="http://smtp.qq.com/">smtp.qq.com</a></td>
<td style="text-align:left">[可选]SMTP_SERVICE留空时，自定义SMTP服务器地址</td>
</tr>
<tr>
<td style="text-align:left">SMTP_PORT</td>
<td style="text-align:left">465</td>
<td style="text-align:left">[可选]SMTP_SERVICE留空时，自定义SMTP端口</td>
</tr>
<tr>
<td style="text-align:left">SMTP_SECURE</td>
<td style="text-align:left">true</td>
<td style="text-align:left">[可选]使用TLS</td>
</tr>
</tbody>
</table>
<h4 id="Troubleshooting">Troubleshooting</h4>
<ul>
<li>
<p>部署失败，请在评论中附图，或去Github发起Issue</p>
</li>
<li>
<p>邮件发送失败，确保环境变量都没问题后，重启云引擎</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1920211019005749.png" alt="重启云引擎"></p>
<p><strong>重启云引擎</strong></p>
</li>
<li>
<p>博主通知模板中不要出现<code>PARENT*</code>相关参数（请勿混用模板）</p>
</li>
<li>
<p>点击邮件中的链接跳转至相应评论，这一细节实现需要在Web前端添加一点额外的代码：</p>
</li>
</ul>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> checkExist <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'html, body'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">animate</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">scrollTop</span><span class="token operator">:</span> <span class="token function">$</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>top<span class="token operator">-</span><span class="token number">90</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">clearInterval</span><span class="token punctuation">(</span>checkExist<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>来自<a target="_blank" rel="noopener" href="https://small-rose.github.io/posts/358175a6.html">small-rose</a>的模板</p>
</blockquote>
<p>@邮件通知效果：</p>
<p>您在[ <img src="https://math.now.sh?inline=%7BSITE_NAME%7D%5D%28https%3A%2F%2Fblog.17lai.site%2Fposts%2F40300608%2F" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;">{SITE_URL})上的留言有新回复啦！</p>
<p>${PARENT_NICK} 同学，您曾在文章上发表评论：</p>
<p>${PARENT_COMMENT}</p>
<p>${NICK} 给您的回复如下：</p>
<p>${COMMENT}</p>
<p>您可以点击<a href="https://blog.17lai.site/posts/40300608/$%7BPOST_URL%7D#comments">查看回复的完整內容</a>，欢迎再次光临[ <img src="https://math.now.sh?inline=%7BSITE_NAME%7D%5D%28https%3A%2F%2Fblog.17lai.site%2Fposts%2F40300608%2F" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;">{SITE_URL})。</p>
<p>@邮件通知模板代码：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">border-radius</span><span class="token punctuation">:</span> 10px 10px 10px 10px<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>13px<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span> #555555<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 666px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span><span class="token string">'Century Gothic'</span><span class="token punctuation">,</span><span class="token string">'Trebuchet MS'</span><span class="token punctuation">,</span><span class="token string">'Hiragino Sans GB'</span><span class="token punctuation">,</span>微软雅黑<span class="token punctuation">,</span><span class="token string">'Microsoft Yahei'</span><span class="token punctuation">,</span>Tahoma<span class="token punctuation">,</span>Helvetica<span class="token punctuation">,</span>Arial<span class="token punctuation">,</span><span class="token string">'SimSun'</span><span class="token punctuation">,</span>sans-serif<span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>50px auto<span class="token punctuation">;</span><span class="token property">border</span><span class="token punctuation">:</span>1px solid #eee<span class="token punctuation">;</span><span class="token property">max-width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">background</span><span class="token punctuation">:</span> #ffffff <span class="token function">repeating-linear-gradient</span><span class="token punctuation">(</span>-45deg<span class="token punctuation">,</span>#fff<span class="token punctuation">,</span>#fff 1.125rem<span class="token punctuation">,</span>transparent 1.125rem<span class="token punctuation">,</span>transparent 2.25rem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 1px 5px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.15<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">background</span><span class="token punctuation">:</span>#49BDAD<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>#ffffff<span class="token punctuation">;</span><span class="token property">border-radius</span><span class="token punctuation">:</span> 10px 10px 0 0<span class="token punctuation">;</span><span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">-moz-linear-gradient</span><span class="token punctuation">(</span>0deg<span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>67<span class="token punctuation">,</span> 198<span class="token punctuation">,</span> 184<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 209<span class="token punctuation">,</span> 244<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">-webkit-linear-gradient</span><span class="token punctuation">(</span>0deg<span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>67<span class="token punctuation">,</span> 198<span class="token punctuation">,</span> 184<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 209<span class="token punctuation">,</span> 244<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span> 66px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">font-size</span><span class="token punctuation">:</span>15px<span class="token punctuation">;</span><span class="token property">word-break</span><span class="token punctuation">:</span>break-all<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span> 23px 32px<span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span><span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">hsla</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span>0%<span class="token punctuation">,</span>100%<span class="token punctuation">,</span>.4<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">border-radius</span><span class="token punctuation">:</span> 10px 10px 0 0<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>您在<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span> #ffffff<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${SITE_URL}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> ${SITE_NAME}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>上的留言有新回复啦！<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">margin</span><span class="token punctuation">:</span>40px auto<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>90%</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>${PARENT_NICK} 同学，您曾在文章上发表评论：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">background</span><span class="token punctuation">:</span> #fafafa <span class="token function">repeating-linear-gradient</span><span class="token punctuation">(</span>-45deg<span class="token punctuation">,</span>#fff<span class="token punctuation">,</span>#fff 1.125rem<span class="token punctuation">,</span>transparent 1.125rem<span class="token punctuation">,</span>transparent 2.25rem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 2px 5px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.15<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>20px 0px<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span>15px<span class="token punctuation">;</span><span class="token property">border-radius</span><span class="token punctuation">:</span>5px<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>14px<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>#555555<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>${PARENT_COMMENT}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>${NICK} 给您的回复如下：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">background</span><span class="token punctuation">:</span> #fafafa <span class="token function">repeating-linear-gradient</span><span class="token punctuation">(</span>-45deg<span class="token punctuation">,</span>#fff<span class="token punctuation">,</span>#fff 1.125rem<span class="token punctuation">,</span>transparent 1.125rem<span class="token punctuation">,</span>transparent 2.25rem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 2px 5px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.15<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>20px 0px<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span>15px<span class="token punctuation">;</span><span class="token property">border-radius</span><span class="token punctuation">:</span>5px<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>14px<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>#555555<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>${COMMENT}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>您可以点击<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span>#12addb</span><span class="token punctuation">"</span></span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${POST_URL}#comments<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>查看回复的完整內容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>，欢迎再次光临<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span>#12addb</span><span class="token punctuation">"</span></span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${SITE_URL}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> ${SITE_NAME}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>。<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css"><span class="token selector">a:link</span><span class="token punctuation">{</span><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">}</span><span class="token selector">a:visited</span><span class="token punctuation">{</span><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">}</span><span class="token selector">a:hover</span><span class="token punctuation">{</span><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">}</span><span class="token selector">a:active</span><span class="token punctuation">{</span><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">background</span><span class="token punctuation">:</span>#49BDAD<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>#ffffff<span class="token punctuation">;</span><span class="token property">border-radius</span><span class="token punctuation">:</span> 0 0 10px 10px<span class="token punctuation">;</span><span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">-moz-linear-gradient</span><span class="token punctuation">(</span>0deg<span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>67<span class="token punctuation">,</span> 198<span class="token punctuation">,</span> 184<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 209<span class="token punctuation">,</span> 244<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">-webkit-linear-gradient</span><span class="token punctuation">(</span>0deg<span class="token punctuation">,</span><span class="token function">rgb</span><span class="token punctuation">(</span>67<span class="token punctuation">,</span> 198<span class="token punctuation">,</span> 184<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 209<span class="token punctuation">,</span> 244<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span> 66px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>博主通知效果：</p>
<p>您在[ <img src="https://math.now.sh?inline=%7BSITE_NAME%7D%5D%28https%3A%2F%2Fblog.17lai.site%2Fposts%2F40300608%2F" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;">{SITE_URL})上的文章有了新的评论！</p>
<p><strong>${NICK}</strong> 同学，发表评论说：</p>
<p>${COMMENT}</p>
<p>您可以点击<a href="https://blog.17lai.site/posts/40300608/$%7BPOST_URL%7D#comments">查看回复的完整內容</a>。</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">border-radius</span><span class="token punctuation">:</span> 10px 10px 10px 10px<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>13px<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span> #555555<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 666px<span class="token punctuation">;</span><span class="token property">font-family</span><span class="token punctuation">:</span><span class="token string">'Century Gothic'</span><span class="token punctuation">,</span><span class="token string">'Trebuchet MS'</span><span class="token punctuation">,</span><span class="token string">'Hiragino Sans GB'</span><span class="token punctuation">,</span>微软雅黑<span class="token punctuation">,</span><span class="token string">'Microsoft Yahei'</span><span class="token punctuation">,</span>Tahoma<span class="token punctuation">,</span>Helvetica<span class="token punctuation">,</span>Arial<span class="token punctuation">,</span><span class="token string">'SimSun'</span><span class="token punctuation">,</span>sans-serif<span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>50px auto<span class="token punctuation">;</span><span class="token property">border</span><span class="token punctuation">:</span>1px solid #eee<span class="token punctuation">;</span><span class="token property">max-width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">background</span><span class="token punctuation">:</span> #ffffff <span class="token function">repeating-linear-gradient</span><span class="token punctuation">(</span>-45deg<span class="token punctuation">,</span>#fff<span class="token punctuation">,</span>#fff 1.125rem<span class="token punctuation">,</span>transparent 1.125rem<span class="token punctuation">,</span>transparent 2.25rem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 1px 5px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.15<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">background</span><span class="token punctuation">:</span>#49BDAD<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>#ffffff<span class="token punctuation">;</span><span class="token property">border-radius</span><span class="token punctuation">:</span> 10px 10px 0 0<span class="token punctuation">;</span><span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">-moz-linear-gradient</span><span class="token punctuation">(</span>0deg<span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>67<span class="token punctuation">,</span> 198<span class="token punctuation">,</span> 184<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 209<span class="token punctuation">,</span> 244<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">-webkit-linear-gradient</span><span class="token punctuation">(</span>0deg<span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>67<span class="token punctuation">,</span> 198<span class="token punctuation">,</span> 184<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 209<span class="token punctuation">,</span> 244<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span> 66px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">font-size</span><span class="token punctuation">:</span>15px<span class="token punctuation">;</span><span class="token property">word-break</span><span class="token punctuation">:</span>break-all<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span> 23px 32px<span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>0<span class="token punctuation">;</span><span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">hsla</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span>0%<span class="token punctuation">,</span>100%<span class="token punctuation">,</span>.4<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">border-radius</span><span class="token punctuation">:</span> 10px 10px 0 0<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>您在<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span> #ffffff<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${SITE_URL}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> ${SITE_NAME}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>上的文章有了新的评论！<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">margin</span><span class="token punctuation">:</span>40px auto<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>90%</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>${NICK}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span> 同学，发表评论说：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">background</span><span class="token punctuation">:</span> #fafafa <span class="token function">repeating-linear-gradient</span><span class="token punctuation">(</span>-45deg<span class="token punctuation">,</span>#fff<span class="token punctuation">,</span>#fff 1.125rem<span class="token punctuation">,</span>transparent 1.125rem<span class="token punctuation">,</span>transparent 2.25rem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 2px 5px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.15<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">margin</span><span class="token punctuation">:</span>20px 0px<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span>15px<span class="token punctuation">;</span><span class="token property">border-radius</span><span class="token punctuation">:</span>5px<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>14px<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>#555555<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>${COMMENT}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>您可以点击<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span>#12addb</span><span class="token punctuation">"</span></span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${POST_URL}#comments<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>查看回复的完整內容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>。<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css"><span class="token selector">a:link</span><span class="token punctuation">{</span><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">}</span><span class="token selector">a:visited</span><span class="token punctuation">{</span><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">}</span><span class="token selector">a:hover</span><span class="token punctuation">{</span><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">}</span><span class="token selector">a:active</span><span class="token punctuation">{</span><span class="token property">text-decoration</span><span class="token punctuation">:</span>none<span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span>100%<span class="token punctuation">;</span><span class="token property">background</span><span class="token punctuation">:</span>#49BDAD<span class="token punctuation">;</span><span class="token property">color</span><span class="token punctuation">:</span>#ffffff<span class="token punctuation">;</span><span class="token property">border-radius</span><span class="token punctuation">:</span> 0 0 10px 10px <span class="token punctuation">;</span><span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">-moz-linear-gradient</span><span class="token punctuation">(</span>0deg<span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>67<span class="token punctuation">,</span> 198<span class="token punctuation">,</span> 184<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 209<span class="token punctuation">,</span> 244<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">-webkit-linear-gradient</span><span class="token punctuation">(</span>0deg<span class="token punctuation">,</span><span class="token function">rgb</span><span class="token punctuation">(</span>67<span class="token punctuation">,</span> 198<span class="token punctuation">,</span> 184<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rgb</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 209<span class="token punctuation">,</span> 244<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span> 66px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="解决休眠">解决休眠</h4>
<p>免费版的 LeanCloud 容器，是有强制性休眠策略的，不能 24 小时运行：</p>
<ul>
<li>每天必须休眠 6 个小时</li>
<li>30 分钟内没有外部请求，则休眠。</li>
<li>休眠后如果有新的外部请求实例则马上启动（但激活时此次发送邮件会失败）。</li>
</ul>
<p>也就是如果服务器休眠了的话用户第一次评论是提醒不了的。</p>
<p>参考了Valine-Admin官网找到了解决办法。</p>
<p>首先在环境变量增加服务器地址，就是你的后台服务器地址</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1920211019005144.png" alt="img"></p>
<p>下面是你的服务器地址，可以自定义</p>
<p>同样登录后台</p>
<p>找到定时任务</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1920211019005147.png" alt="img"></p>
<p>然后点击创建任务，上面是我创建好的</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1920211019005153.png" alt="img"></p>
<p>选择self_wake函数，然后运行时间使用cron表达式</p>
<blockquote>
<p>0 0/30 7-23 ? 表示每天6点到11点 每30分钟叫醒服务器一次</p>
</blockquote>
<p>这样就完美的解决了服务器休眠的问题</p>
<p>那如果用户不在时间范围内发留言了怎么办？我们也可以创建一个捡漏的定时任务</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1920211019005159.png" alt="img"></p>
<p>创建捡漏定时任务</p>
<p>然后运行函数选择resend_mails,同样使用cron表达式</p>
<blockquote>
<p>0 0 8 ?</p>
</blockquote>
<p>表示每八个小时进行捡漏一次，这样如果有留言遗漏的话就能即使的提醒。</p>
<h4 id="WakeLeanCloud"><a target="_blank" rel="noopener" href="https://github.com/Ysnsn/WakeLeanCloud">WakeLeanCloud</a></h4>
<p>这个项目主要是用来解决LeanCloud通过定时任务唤醒机器时被流控的问题。</p>
<p><strong>如何使用</strong></p>
<ol>
<li>Fork此项目</li>
<li>添加一个名为<code>GITHUB_TOKEN</code>的Token，并为赋予<code>repo</code>，<code>admin:repo_hook</code> ， <code>workflow</code>的权限</li>
<li>添加名为<code>SITE</code>的Secrets，内容为自己管理后台地址。多个请用英文逗号分隔</li>
</ol>
<p>详细教程请参考<a target="_blank" rel="noopener" href="https://www.antmoe.com/posts/ff6aef7b/index.html#%E5%BC%80%E5%A7%8B%E5%B0%9D%E8%AF%95">优雅解决LeanCloud流控问题</a></p>
<h3 id="让hexo支持pwa">让hexo支持pwa</h3>
<blockquote>
<p>pwa中文叫渐进式网页应用，pwa网站可以直接添加网址站到桌面，就相当于在系统中直接安装了一个app，打开的效果也和app差不多，加载速度也很快，部分功能可以直接离线使用。Google的Workbox标准，目前来看需要Chrome支持</p>
<ul>
<li>hexo-pwa 很久没更新，看到资料都是支持4.x版本hexo。</li>
<li>hexo-offline 亲自验证，支持最新5.x的hexo。</li>
</ul>
</blockquote>
<h4 id="安装hexo-offline">安装hexo-offline</h4>
<pre class="line-numbers language-none"><code class="language-none">npm install hexo-offline --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>关于这个插件的详细使用方法可以看下面这里</p>
<pre class="line-numbers language-none"><code class="language-none">https://github.com/JLHwung/hexo-offline<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="配置hexo-offline">配置hexo-offline</h4>
<p>之后我们在站点根目录_config.yml如下配置</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># offline config passed to sw-precache.</span>
<span class="token key atrule">service_worker</span><span class="token punctuation">:</span>
  <span class="token key atrule">maximumFileSizeToCacheInBytes</span><span class="token punctuation">:</span> <span class="token number">5242880</span>
  <span class="token key atrule">staticFileGlobs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> /<span class="token important">**/*.</span><span class="token punctuation">{</span>js<span class="token punctuation">,</span>html<span class="token punctuation">,</span>css<span class="token punctuation">,</span>png<span class="token punctuation">,</span>jpg<span class="token punctuation">,</span>gif<span class="token punctuation">,</span>svg<span class="token punctuation">,</span>eot<span class="token punctuation">,</span>ttf<span class="token punctuation">,</span>woff<span class="token punctuation">,</span>woff2<span class="token punctuation">}</span>
  <span class="token punctuation">-</span> /lib/<span class="token important">**/*.js</span>
  <span class="token punctuation">-</span> /lib/<span class="token important">**/*.css</span>
  <span class="token punctuation">-</span> /images/*
  <span class="token punctuation">-</span> /js/src/<span class="token important">**/*.js</span>
  <span class="token key atrule">stripPrefix</span><span class="token punctuation">:</span> public
  <span class="token key atrule">verbose</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">runtimeCaching</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">urlPattern</span><span class="token punctuation">:</span> /*
      <span class="token key atrule">handler</span><span class="token punctuation">:</span> cacheFirst
      <span class="token key atrule">options</span><span class="token punctuation">:</span>
        <span class="token key atrule">origin</span><span class="token punctuation">:</span> cdn.bootcss.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意哦不是主题的_config.yml文件</p>
<p>之后生成manifest.json文件，可以在<a target="_blank" rel="noopener" href="https://app-manifest.firebaseapp.com/"><strong>这个网站</strong></a>在线生成。</p>
<p>填入相关的参数，如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1820210918204544.png" alt=""></p>
<blockquote>
<p>Tips: 一定需要一个512x512的icon！</p>
</blockquote>
<p>之后点击generate.zip 把配置都下载过来</p>
<p>把manifest.json和images文件夹直接复制到hexo下source文件夹中，最后我们编辑主题，在head里添加</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>manifest<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/manifest.json<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果使用的是hexo next主题，在</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">themes/next/layout/_partials/head/head.swig<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果使用的是hexo matery主题，在</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">themes<span class="token operator">/</span>matery<span class="token operator">/</span>layout<span class="token operator">/</span>_partial<span class="token operator">/</span>head<span class="token punctuation">.</span>ejs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1820210918220357.png" alt=""></p>
<p>这个文件中添加上面这句话即可，最后直接重新生成站点，部署即可</p>
<h4 id="验证和使用">验证和使用</h4>
<p>需要https访问，看到这个齿轮</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1820210918222354.png" alt="F12 sources"></p>
<p>然后在浏览器地址栏可以看到应用标志</p>
<blockquote>
<p>Tips: offline 需要https才能正常使用</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1820210918231523.png" alt="地址栏"></p>
<p>点击打开，会看到如下结果，试一下？</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1820210918231644.png" alt="离线博客"></p>
<h3 id="valine-的使用与升级到1-4">valine 的使用与升级到1.4</h3>
<h4 id="一、valine启用">一、valine启用</h4>
<h5 id="1、主要流程">1、主要流程</h5>
<p>valine和miniValine使用基本类似。</p>
<p>（1）去 <a target="_blank" rel="noopener" href="https://leancloud.cn/dashboard/login.html#/signup">Leancloud</a>注册。</p>
<p>注意事项：</p>
<p>节点选择：华东节点、华北节点、国际版。</p>
<p>如果你的域名没有备案，建议选择国际版。 因为华东或华北节点在安装评论系统之后访问要求域名备案。</p>
<p>（2）在“设置“，”应用 Keys”，找到你的<code>appid</code>和<code>appkey</code>，配置到主题中<code>valine</code>配置的地方，启用<code>valine</code>。</p>
<p>（3）在“设置“，”安全中心”，”Web 安全域名”，添加自己的域名。</p>
<p>（4）在“设置“，”安全中心”，”服务开关”，数据存储要打开。</p>
<p>（5）在“存储“，”用量统计”，”HTTP状态码”，启用，方便后续报错查错误码。</p>
<p>（6）重新编译部署<code>hexo clean &amp; hexo g &amp; hexo d</code></p>
<h5 id="2、遇到问题">2、遇到问题</h5>
<p>搞这个东西采坑不少，有些坑都是自己不小心造成的。我在网上查了，交流群里也咨询请教了，没有人能解决这个问题，毕竟这个坑是自己造成的。</p>
<p>常见Code 403问题：</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">Code 403: 访问被api域名白名单拒绝，请检查你的安全域名设置.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>网上多数的说法是在web安全域名中添加自己的域名。可是如果添加之后还是这个问题呢？</p>
<p>其实一般不会有这个问题，我有这个问题是我改了权限造成了。</p>
<p>官方给的解释：</p>
<blockquote>
<p>应用在控制台中的相关服务选项未打开，如 Class 关闭了权限，或是 User 缺失了 session 信息等情况下，云端会统一地返回 403 错误码及不同的错误信息，代表当前请求因权限不够而被拒。例如：</p>
<p>信息 - Forbidden to read/write by class permissions<br>
含义 - 操作被禁止，因为 Class 表没有打开「读」或者「写」的权限。进入 控制台 &gt; 存储，点击相应的 Class，从右侧选择 其他 下拉菜单，进入 权限管理 来调整。</p>
<p>信息 - The user cannot be altered by a client without the session.<br>
含义 - 用户没有登录，无法修改用户信息。</p>
</blockquote>
<p>解决：</p>
<p>（1）首次使用，添加一条评论，一般添加之后就会好了。</p>
<p>（2）后续使用，403，请检查<code>comment</code>表的add_fields/create/find权限开放。</p>
<p>（3）如果还是不行将<code>_use</code>表的add_fields/create/find权限开放。</p>
<p>（4）如果还是不行，到“存储“，”用量统计”，”HTTP状态码”处，检查你的错误码，然后去<a target="_blank" rel="noopener" href="https://leancloud.cn/docs/error_code.html#hash1392104">LeanCloud的错误</a>找应用的错误码，排查原因吧。</p>
<h4 id="二、valine升级">二、valine升级</h4>
<h5 id="1、引入1-4版的js文件">1、引入1.4版的js文件</h5>
<p>（1）修改主题配置文件</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">js</span><span class="token punctuation">:</span>
  <span class="token key atrule">valine</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//unpkg.com/valine/dist/Valine.min.js <span class="token comment">#/libs/valine/Valine.min.js </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>（2）将文件放你自己的仓库</p>
<p>下载我的 <code>Valine.min.js</code> 文件，直接替换你主题目录 <code>/source/libs/valine/</code> 下的 <code>Valine.min.js</code> 文件。</p>
<p>注意，如果你担心替换有问题，可以先备份一下你自己的 <code>Valine.min.js</code> 文件。</p>
<h5 id="2、增加valine的配置：">2、增加valine的配置：</h5>
<p>1.4的版本有些属性调整了，主题下的<code>_config.yml</code>valine属性如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">valine</span><span class="token punctuation">:</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">appId</span><span class="token punctuation">:</span> iTxfqh5e9IaRfiiVOTbIWoKa<span class="token punctuation">-</span>XXXXXX
  <span class="token key atrule">appKey</span><span class="token punctuation">:</span> C5s5xGFErD1EtXXXXXXXX
  <span class="token key atrule">verify</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 是否启用防垃圾验证</span>
  <span class="token key atrule">notify</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 是否开启邮件提醒(https://valine.js.org/notify.html)</span>
  <span class="token key atrule">visitor</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">avatar</span><span class="token punctuation">:</span> monsterid  <span class="token comment"># 头像样式(https://valine.js.org/avatar.html) </span>
  <span class="token key atrule">pageSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">placeholder</span><span class="token punctuation">:</span> <span class="token string">'ヾﾉ≧∀≦)o来啊，快活啊!'</span> <span class="token comment"># Comment Box placeholder</span>
  <span class="token key atrule">background</span><span class="token punctuation">:</span> /medias/comment_bg.png <span class="token comment">#背景图</span>
  <span class="token key atrule">count</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">enableQQ</span><span class="token punctuation">:</span> <span class="token number">970175021</span>
  <span class="token key atrule">recordIP</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">requiredFields</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> nick
    <span class="token punctuation">-</span> mail
  <span class="token key atrule">guest_info</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> nick
    <span class="token punctuation">-</span> mail
    <span class="token punctuation">-</span> link
  <span class="token key atrule">master</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> 123abc508165c8eba9a77f872xxxx046  <span class="token comment"># md5加密后的博主邮箱</span>
  <span class="token key atrule">metaPlaceholder</span><span class="token punctuation">:</span>  <span class="token comment"># 输入框的背景文字</span>
    <span class="token key atrule">nick</span><span class="token punctuation">:</span> 昵称/QQ号(必填)
    <span class="token key atrule">mail</span><span class="token punctuation">:</span> 邮箱(必填)
    <span class="token key atrule">link</span><span class="token punctuation">:</span> 网址(https<span class="token punctuation">:</span>//)
  <span class="token key atrule">lang</span><span class="token punctuation">:</span> zh<span class="token punctuation">-</span>CN
  <span class="token key atrule">tagMeta</span><span class="token punctuation">:</span> <span class="token comment"># The String Array of Words to show Flag.[Just Only xCss Style mode]</span>
    <span class="token punctuation">-</span> 博主
    <span class="token punctuation">-</span> 小伙伴
    <span class="token punctuation">-</span> 访客
  <span class="token key atrule">friends</span><span class="token punctuation">:</span> <span class="token comment"># The MD5 String Array of friends Email to show friends Flag.[Just Only xCss Style mode]</span>
    <span class="token punctuation">-</span> c08508165c8eba9a77f8c2853xxxx09e
    <span class="token punctuation">-</span> 901345d4c91ddfd8db0f175bbcfff0c8
    <span class="token punctuation">-</span> 1512958e18378c98b498d5effe3e76ff<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>复制代码注意缩进对齐，不对齐可能会报错，请自行检查对齐。</p>
<h5 id="3、修改valine-ejs：">3、修改<code>valine.ejs</code>：</h5>
<p>Matery 主题使用的<code>ejs</code>模板预编译，如果你使用了<code>pug</code>或者<code>swig</code>等其他的模板语言，请修改成对应语言语法即可。</p>
<p>原始的<code>valine.ejs</code></p>
<pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs">new Valine({
        el: '#vcomments',
        appId: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>appId </span><span class="token delimiter punctuation">%&gt;</span></span>',
        appKey: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>appKey </span><span class="token delimiter punctuation">%&gt;</span></span>',
        notify: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>notify </span><span class="token delimiter punctuation">%&gt;</span></span>' === 'true',
        verify: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>verify </span><span class="token delimiter punctuation">%&gt;</span></span>' === 'true',
        visitor: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>visitor </span><span class="token delimiter punctuation">%&gt;</span></span>' === 'true',
        avatar: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>avatar </span><span class="token delimiter punctuation">%&gt;</span></span>',
        pageSize: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>pageSize </span><span class="token delimiter punctuation">%&gt;</span></span>',
        lang: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%</span><span class="token language-javascript"> <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>language <span class="token operator">==</span> <span class="token string">"zh-CN"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span><span class="token delimiter punctuation">%&gt;</span></span>zh-cn<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%</span><span class="token language-javascript"> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> </span><span class="token delimiter punctuation">%&gt;</span></span>en<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%</span><span class="token language-javascript"> <span class="token punctuation">}</span> </span><span class="token delimiter punctuation">%&gt;</span></span>',
        placeholder: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>placeholder </span><span class="token delimiter punctuation">%&gt;</span></span>'
    });<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>升级后的<code>valine.ejs</code></p>
<pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs">let metaPlaceholder = <span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript">  <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>metaPlaceholder<span class="token punctuation">)</span> </span><span class="token delimiter punctuation">%&gt;</span></span> ;
//这里要换行
new Valine({
        el: '#vcomments',
        appId: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>appId </span><span class="token delimiter punctuation">%&gt;</span></span>',
        appKey: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>appKey </span><span class="token delimiter punctuation">%&gt;</span></span>',
        notify: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>notify </span><span class="token delimiter punctuation">%&gt;</span></span>' === 'true',
        verify: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>verify </span><span class="token delimiter punctuation">%&gt;</span></span>' === 'true',
        visitor: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>visitor </span><span class="token delimiter punctuation">%&gt;</span></span>' === 'true',
        avatar: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>avatar </span><span class="token delimiter punctuation">%&gt;</span></span>',
        pageSize: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>pageSize </span><span class="token delimiter punctuation">%&gt;</span></span>',
        lang: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>lang </span><span class="token delimiter punctuation">%&gt;</span></span>',
        placeholder: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>placeholder </span><span class="token delimiter punctuation">%&gt;</span></span>',
        meta: <span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> <span class="token string">'["'</span> <span class="token operator">+</span> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>guest_info<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'", "'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'"]'</span> </span><span class="token delimiter punctuation">%&gt;</span></span>,
        recordIP: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>recordIP </span><span class="token delimiter punctuation">%&gt;</span></span>' === 'true',
        enableQQ: '<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>avatar </span><span class="token delimiter punctuation">%&gt;</span></span>',
        requiredFields: <span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> <span class="token string">'["'</span> <span class="token operator">+</span> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>master<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'", "'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'"]'</span> </span><span class="token delimiter punctuation">%&gt;</span></span>,
        master: <span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> <span class="token string">'["'</span> <span class="token operator">+</span> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>master<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'", "'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'"]'</span> </span><span class="token delimiter punctuation">%&gt;</span></span>,
        friends: <span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> <span class="token string">'["'</span> <span class="token operator">+</span> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'", "'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'"]'</span> </span><span class="token delimiter punctuation">%&gt;</span></span>,
        tagMeta: <span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%-</span><span class="token language-javascript"> <span class="token string">'["'</span> <span class="token operator">+</span> theme<span class="token punctuation">.</span>valine<span class="token punctuation">.</span>tagMeta<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'", "'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'"]'</span> </span><span class="token delimiter punctuation">%&gt;</span></span>,
        metaPlaceholder: metaPlaceholder,

    });<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果需要验证昵称和邮箱可以加上以下代码：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html">document.body.addEventListener('click', function(e) {
    if (e.target.classList.contains('vsubmit')) {
        const email = document.querySelector('input[type=email]');
        const nick = document.querySelector('input[name=nick]');
        const reg = /^[A-Za-z0-9_-\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;
        if (!email.value || !nick.value || !reg.test(email.value)) {
            const str = `<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>valert txt-center<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vtext<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>请填写正确的昵称和邮箱！<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>`;
            const vmark = document.querySelector('.vmark');
            vmark.innerHTML = str;
            vmark.style.display = 'block';

            e.stopPropagation();

            setTimeout(function() {
                vmark.style.display = 'none';
                vmark.innerHTML = '';
            }, 2500);
        }
    }
    }, true);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：代码非原创，JS正则验证本身也不难。</p>
<p>好了可以部署之后自己测试一下。</p>
<p>顺便说一下，填写昵称邮箱和网址的地方如果折行了就按我的样式改一下就好：</p>
<p>在 <code>valine.ejs</code> 是上面对着改一下就好了：</p>
<pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs">.v[data-class="v"] .vwrap .vheader .vinput {
  width: 32%;
  border-bottom: 1px dashed #dedede;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="新建文章自动打开本地Markdown编辑器">新建文章自动打开本地Markdown编辑器</h3>
<blockquote>
<p>写新文章时，需要控制台执行hexo new “文章名字”生成一篇新文章，但需要手动打开，挺麻烦，我们可以设置在生成之后自动打开</p>
</blockquote>
<p>在站点根目录下新建scripts目录，然后在新建<code>auto_open.js</code>，在文件填入一下内容</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> spawn <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exec<span class="token punctuation">;</span>

<span class="token comment">// Hexo 2.x 用户复制这段</span>
<span class="token comment">//hexo.on('new', function(path){</span>
  <span class="token comment">//spawn('start  "markdown编辑器绝对路径.exe" ' + path);</span>
<span class="token comment">//});</span>

<span class="token comment">// Hexo 3 用户复制这段</span>
hexo<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'new'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'start  "D:\Program Files\Typora\Typora.exe" '</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>其中”D:\Program Files\Typora\Typora.exe”是我本地编辑器的路径，只需要改为你本地编辑器的路径即可，然后在执行<code>hexo cl &amp;&amp; hexo g -d</code>，部署到GitHub即可，以后在新建文章就会自动打开编辑器。</p>
</blockquote>
<h2 id="常见问题">常见问题</h2>
<h3 id="通过hexo-g-d部署时报Error-Spawn-failed错误">通过<code>hexo g -d</code>部署时报<code>Error: Spawn failed</code>错误:</h3>
<blockquote>
<p>这是由于 git 本地记录的提交版本号与 github 上不一致导致的，通过<code>git reset --hard commitCode</code>即可解决。</p>
</blockquote>
<ul>
<li>检查本地最近提交记录，获取最后一次提交记录的更新时间及标识，如<code>280a7fdd46fcfd7d34e652aec15523dcd247fac8</code></li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> .deploy_git
<span class="token function">cat</span> .git/logs/HEAD<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>获取 github pages 服务所关联分支的最近一次提交记录，获取更新时间及标识。地址一般为：<code>https://github.com/用户名/仓库名/commits/分支名</code>，如<code>https://github.com/lxl80/blog/commits/gh-pages</code></li>
<li>如果发现提交最新的提交时间/标识不一致，通过以下命令即可解决:</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> reset --hard f085038efdf79546c09641d37b2a2429c1ae8e60 <span class="token comment">#github上最新的提交标识</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="fsevents报错">fsevents报错</h3>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> ERR<span class="token operator">!</span> code EBADPLATFORM <span class="token function">npm</span> ERR<span class="token operator">!</span> notsup Unsupported platform <span class="token keyword">for</span>
fsevents@2.3.2: wanted <span class="token punctuation">{</span><span class="token string">"os"</span><span class="token builtin class-name">:</span><span class="token string">"darwin"</span>,<span class="token string">"arch"</span><span class="token builtin class-name">:</span><span class="token string">"any"</span><span class="token punctuation">}</span> <span class="token punctuation">(</span>current:
<span class="token punctuation">{</span><span class="token string">"os"</span><span class="token builtin class-name">:</span><span class="token string">"win32"</span>,<span class="token string">"arch"</span><span class="token builtin class-name">:</span><span class="token string">"x64"</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token function">npm</span> ERR<span class="token operator">!</span> notsup Valid OS:    darwin <span class="token function">npm</span>
ERR<span class="token operator">!</span> notsup Valid Arch:  any <span class="token function">npm</span> ERR<span class="token operator">!</span> notsup Actual OS:   win32 <span class="token function">npm</span>
ERR<span class="token operator">!</span> notsup Actual Arch: x64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解决方法：修改package.json</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token string-property property">"optionalDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token string-property property">"fsevents"</span><span class="token operator">:</span> <span class="token string">"^2.3.2"</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="关于百度无法爬取GitHub内容解决方案">关于百度无法爬取GitHub内容解决方案</h3>
<blockquote>
<ul>
<li>使用coding搭建一个可以被百度爬取到的代码托管平台</li>
<li>使用vps搭建一个hexo 镜像访问，专门针对搜索引擎。</li>
</ul>
</blockquote>
<blockquote>
<p>Tips: 博主用了第二种方法，2个域名，前端域名用dnspod，采用cloudflare parter cname接入。dnspos有选路选择，针对搜索引擎进入vps搭建的blog，对于其它线路到cloudflare parter 加速过的github pages  cname。后端域名用cloudflare parter 以及免费版cloudflare管理。</p>
</blockquote>
<p>既然百度无法爬取GitHub，那么我们只需要找个可以被百度爬取到的代码托管平台即可（并且还提供pages服务），基本只有国内的平台了：<code>Gitee</code>和<code>Coding</code>！Gitee自定义域名要花钱（九十多，都可以买服务器了），而Coding是可以免费自定义域名的。这里推介大家使用企业版的Coding，因为企业版的Coding仓库服务器是在香港的，而普通版的服务器是在新加坡。地理原因，理论上企业版的更快一些！</p>
<ol>
<li>
<p>将博客同时部署到两个仓库：GitHub和Coding</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> git
  <span class="token key atrule">repository</span><span class="token punctuation">:</span> git@github.com<span class="token punctuation">:</span>xxx/xxx.github.io.git
  <span class="token key atrule">branch</span><span class="token punctuation">:</span> master

<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> git
  <span class="token key atrule">repository</span><span class="token punctuation">:</span> git@e.coding.net<span class="token punctuation">:</span>xxx/xxx.git
  <span class="token key atrule">branch</span><span class="token punctuation">:</span> master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>在域名那里，配置两个解析</p>
<blockquote>
<p>线路类型作用：如果该值填“国内”，国内的IP就会去访问此项对应的<code>记录值地址</code></p>
<p>同理，如果该值填写“国外”，国外的IP就会去访问“国外”对应的<code>记录值地址</code></p>
</blockquote>
<ol>
<li><code>线路类型</code>为<code>百度</code>或者<code>国内</code>，记录值为<code>Coding仓库的地址</code></li>
<li><code>线路类型</code>为<code>默认</code>或者<code>国外</code>，记录值为<code>GitHub仓库地址</code></li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1120210911170615.png" alt=""></p>
</li>
<li>
<p>这样来自<code>百度的spider</code>就会去爬<code>国内Coding</code>的地址，而两个仓库的内容又都是一样的，如果请求IP来自国外，它又会去访问<code>国外的GitHub</code>，这样还有利于外国华侨和那些科学上网的用户访问，一石二鸟！（我真他妈天才！）</p>
</li>
<li>
<p>如果你只用Coding仓库，那就不需要这么麻烦了</p>
</li>
<li>
<p>测试百度Spider能不能爬你的域名</p>
<ol>
<li>
<p>在任意目录下执行以下命令（将“你的域名”换成你的域名）</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">curl -A "Mozilla/5.0 (compatible; Baiduspider/2.0; +http://www.baidu.com/search/spider.html)" -o example.html 你的域名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>执行完命令，在该目录下会生成一个文件：<code>example.html</code>，打开它，如果显示</p>
<ul>
<li>
<p><code>Moved Permanently</code>，说明301，被重定向了</p>
</li>
<li>
<p><code>Found</code>，也就是爬到了</p>
</li>
<li>
<p>如果打开是你的首页，说明爬取到的内容就是你的首页HTML内容。</p>
</li>
<li>
<p>如果显示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1120210911170621.png" alt=""></p>
<p>说明域名是解析到GitHub的，403Forbidden访问禁止。</p>
</li>
</ul>
</li>
</ol>
</li>
</ol>
<h3 id="busuanzi不蒜子计数显示异常，一闪就没">busuanzi不蒜子计数显示异常，一闪就没</h3>
<blockquote>
<ol>
<li>
<p>原因可能有两种live2d看板娘和busuanzi不蒜子计数冲突</p>
</li>
<li>
<p>busuanzi不蒜子网络访问异常。</p>
</li>
</ol>
<blockquote>
<ol>
<li>
<p>不在leancloud安全名单</p>
</li>
<li>
<p>不是正常域名访问</p>
</li>
<li>
<p>各种网络访问错误等等</p>
</li>
</ol>
</blockquote>
</blockquote>
<p>近日安装了live2d看板娘插件，<a target="_blank" rel="noopener" href="https://github.com/EYHN/hexo-helper-live2d">github项目地址</a>，安装后却意外发现busuanzi不蒜子计数失效了,在页面中不显示，但强制刷新后出现，再刷新又消失。经排查，未发现问题，但事实是网站源码出现了变化。</p>
<blockquote>
<p><em>正常时</em></p>
</blockquote>
<pre class="line-numbers language-HTML" data-language="HTML"><code class="language-HTML">&lt;div id="busuanzi_container_page_pv" class="info-break-policy" style="display: inline;"&gt;
    &lt;i class="far fa-eye fa-fw"&gt;&lt;/i&gt;阅读次数:&amp;nbsp;&amp;nbsp;
    &lt;span id="busuanzi_value_page_pv"&gt;433&lt;/span&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><em>异常时</em></p>
</blockquote>
<pre class="line-numbers language-HTML" data-language="HTML"><code class="language-HTML">&lt;div id="busuanzi_container_page_pv" class="info-break-policy" style="display: none;"&gt;
    &lt;i class="far fa-eye fa-fw"&gt;&lt;/i&gt;阅读次数:&amp;nbsp;&amp;nbsp;
    &lt;span id="busuanzi_value_page_pv"&gt;434&lt;/span&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>对比发现出现了多余的<code>style="display: none;</code>。<br>
经过搜索主题源码，发现这个文件<code>themes\matery\source\libs\others\busuanzi.pure.mini.js</code>控制显示。</p>
<p>可以直接下载下面这个地址的js替换，来自个人blog的js   <a href="https://blog.17lai.site/libs/others/busuanzi.pure.mini.js">busuanzi.pure.mini.js</a>，直接下载这个js替换即可。下面源码经过了展开美化，原始文件是压缩去空格版本的。<br>
<strong>注意</strong>： 这是一种破坏性修复，没有解决根本问题，临时修复方案。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> bszCaller<span class="token punctuation">,</span> bszTag<span class="token punctuation">;</span>
<span class="token operator">!</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">,</span> a <span class="token operator">=</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span>
        b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function-variable function">ready</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> a <span class="token operator">||</span> <span class="token string">"interactive"</span> <span class="token operator">===</span> document<span class="token punctuation">.</span>readyState <span class="token operator">||</span> <span class="token string">"complete"</span> <span class="token operator">===</span> document<span class="token punctuation">.</span>readyState <span class="token operator">?</span> <span class="token function">c</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span> <span class="token operator">:</span>
            b<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">c</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function-variable function">d</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> c <span class="token operator">=</span> b<span class="token punctuation">.</span>length<span class="token punctuation">;</span> c <span class="token operator">&gt;</span> a<span class="token punctuation">;</span> a<span class="token operator">++</span><span class="token punctuation">)</span> b<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>
        b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a <span class="token operator">||</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> <span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">d</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>removeEventListener <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>
            <span class="token string">"DOMContentLoaded"</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> document<span class="token punctuation">.</span>attachEvent <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">detachEvent</span><span class="token punctuation">(</span><span class="token string">"onreadystatechange"</span><span class="token punctuation">,</span>
            e<span class="token punctuation">)</span><span class="token punctuation">,</span> window <span class="token operator">==</span> window<span class="token punctuation">.</span>top <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">clearInterval</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>addEventListener <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"DOMContentLoaded"</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> document<span class="token punctuation">.</span>attachEvent <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
        document<span class="token punctuation">.</span><span class="token function">attachEvent</span><span class="token punctuation">(</span><span class="token string">"onreadystatechange"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">loaded|complete</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> window <span class="token operator">==</span> window<span class="token punctuation">.</span>top <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                a <span class="token operator">||</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span><span class="token function">doScroll</span><span class="token punctuation">(</span><span class="token string">"left"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bszCaller <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">fetch</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token string">"BusuanziCallback_"</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">1099511627776</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        window<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">evalCall</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> a <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"=BusuanziCallback"</span><span class="token punctuation">,</span> <span class="token string">"="</span> <span class="token operator">+</span> c<span class="token punctuation">)</span><span class="token punctuation">,</span> scriptTag <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
                <span class="token string">"SCRIPT"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> scriptTag<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">"text/javascript"</span><span class="token punctuation">,</span> scriptTag<span class="token punctuation">.</span>defer <span class="token operator">=</span> <span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">,</span> scriptTag<span class="token punctuation">.</span>src <span class="token operator">=</span> a<span class="token punctuation">,</span>
            document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">"HEAD"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>scriptTag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">evalCall</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">a</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> scriptTag<span class="token punctuation">.</span>parentElement<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>scriptTag<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    bszTag<span class="token punctuation">.</span><span class="token function">hides</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> bszCaller<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"//busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bszTag<span class="token punctuation">.</span><span class="token function">texts</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> bszTag<span class="token punctuation">.</span><span class="token function">shows</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bszTag <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bszs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"site_pv"</span><span class="token punctuation">,</span> <span class="token string">"page_pv"</span><span class="token punctuation">,</span> <span class="token string">"site_uv"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function-variable function">texts</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>bszs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> c <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"busuanzi_value_"</span> <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            c <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> a<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">hides</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>bszs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> b <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"busuanzi_container_"</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
            b <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">shows</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>bszs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> b <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"busuanzi_container_"</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
            b <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">"inline"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>替换的人请操作其实就是把其中的<code>b.style.display="none"</code>中<code>none</code>去掉。</p>
<h3 id="不蒜子-busuanzi-文章计数出错问题">不蒜子 (busuanzi) 文章计数出错问题</h3>
<p>出现这个原因，和 Chrome 85 版本 Referrer Policy 更改有关。什么是 Referrer，简单理解，就是请求 Web 服务器时，可以在 HTTP Request 的请求头 (header) 中加上当前页面的 URL，例如我们在浏览某个博客页面，需要加载一些图片，从服务器请求这些图片时，referrer 就是当前的博客页面 URL。从这里也可以看出，referrer 可能会暴露请求来源的某些信息或者隐私，有一定的隐私或安全风险。之前版本的 Chrome 浏览器，如果网站没有指定自己的 Referrer Policy，那么 Chrome 默认 policy 是 no-referrer-when-downgrade，在 Chrome 85 版本中，为了保护用户的隐私，默认的 Referrer Policy 则变成了 strict-origin-when-cross-origin。</p>
<ul>
<li>no-referrer-when-downgrade: 当两个网站的 http 协议安全等级相当，或者目的网站安全协议等级高于当前网站(HTTP –&gt; HTTP, HTTPS –&gt; HTTPS, HTTP –&gt; HTTPS)， referer 将会包含源网站的域名，路径，查询字符串；如果目的网站安全协议等级低于源网站 (HTTPS –&gt; HTTP)，将不会发送这些信息。</li>
<li>strict-origin-when-cross-origin： 只有当做同一域名请求时 (源网址和目标网址是同一域名），才发送域名，路径和请求字符串，当两个网站安全协议相当时，发送源网站的域名(没有具体路径信息和查询字符串)，如果目标网站安全协议等级低于源网站，不发送 header 信息。</li>
</ul>
<p>不蒜子统计博客文章访问量就是通过 referer 来计算的，通过上面的分析，如果 Referrer Policy 是 strict-origin-when-cross-origin，不蒜子接收到的只有博客的域名，没有文章的具体路径，所以具体某个文章的 PV 统计会出现错误。</p>
<p>修复方法：</p>
<p>在主题文件夹下/layout/_partial/head.ejs中添加</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>referrer<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>no-referrer-when-downgrade<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="如何多个域名映射同一个github-pages">如何多个域名映射同一个github pages</h3>
<p>可能由于某种原因，换了一个域名，之前又有一些被搜索引擎收录，但是又不想让原来的链接失效，就需要让两个域名都映射到github pages中。本文介绍几种当前可能的方法。欢迎提出更多有效方法。</p>
<h5 id="直接映射有什么问题？">直接映射有什么问题？</h5>
<p>你可能会想，两个域名都映射到github pages不就可以了？然而事实并非如此。首先当前github 的CNAME中只支持一个域名。因此CNAME文件中只能有一个域名，而如果在域名映射中将两个域名都映射到username.github.io，那么其中有一个会出现404错误。</p>
<h5 id="前提-2">前提</h5>
<p>以下方法的前提是你已经明白如何为自己的github pages添加自定义域名。</p>
<h5 id="需要注意什么？">需要注意什么？</h5>
<ul>
<li>需要给各大网站提交新的域名网址，重新被收录</li>
<li>域名变换前面网站的内容结构不能变，否则重定向也没有意义</li>
<li>当前单纯的域名没有办法进行备案</li>
<li>注意修改配置文件里的主域名为新的域名</li>
<li>由于更换了新的域名，导致原来leancloud统计的访问数据需要重新计算，也就是网站访问量被清零了，leancloud也需要更新域名</li>
<li>新的com域名可申请免费的SSL证书，保证https可访问，而不会提示不安全</li>
<li>301重定向会将旧地址的权重转义到新地址上</li>
<li>百度收录速度较慢</li>
</ul>
<h5 id="方法一：域名托管平台重定向">方法一：域名托管平台重定向</h5>
<p>有的域名服务商提供重定向功能，以阿里云为例，在域名映射添加记录的时候，可以选择显性URL或隐性URL。但是自己在尝试这种方法的时候，会提示我URL备案异常。可能是由于这个时候已经用新的域名映射了博客地址，但是新的域名实际上是没有备案的。更无奈的是，目前貌似没有办法单独对域名进行备案。因此本人放弃了该方法。</p>
<p>如果你的博客也是部署在github上的，那么这种方法就不用尝试了，如果你的博客是部署在自己的服务器上的，那么网上都很多方法，这里就不介绍了。</p>
<h5 id="方法二：部署两个仓库">方法二：部署两个仓库</h5>
<p>我们注意到，除了github pages，还有coding.net可用。它与github类似。原来的域名映射到这个地址就可以了。而在部署hexo的时候，是可以添加两个仓库地址的：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> git
  <span class="token key atrule">repository</span><span class="token punctuation">:</span> git@github.com<span class="token punctuation">:</span>username/username.github.io.git
  <span class="token key atrule">branch</span><span class="token punctuation">:</span> master
<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> git
  <span class="token key atrule">repository</span><span class="token punctuation">:</span> git@git.coding.net<span class="token punctuation">:</span>username/username.git
  <span class="token key atrule">branch</span><span class="token punctuation">:</span> coding<span class="token punctuation">-</span>pages<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这两个仓库内容唯一的差别就是域名不一样，即CNAME中的记录值不一样。这样当访问两个不同的域名的时候，是访问不同的两个平台仓库。但是原来域名的权重不会转到新的域名中去。</p>
<h5 id="方法三：新增项目重定向">方法三：新增项目重定向</h5>
<p>假如你已经有username.github.io项目，新建一个名为blog(名字自定义)的项目，在项目的setting中，开启github pages服务，并且将旧的域名映射到username.github.io。</p>
<p>实际上，github pages并不是只能有一个，例如，你新创建的仓库访问地址为：username.github.io/blog。<br>
由于旧的域名映射会导致404错误，那么在我们的新项目中增加一个404.html，在页面中进行跳转即可：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">language</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>javascript<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">var</span> domain <span class="token operator">=</span> <span class="token string">"换成你自己的新域名"</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> src <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">;</span>
<span class="token keyword">var</span> prtc <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> src<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> target <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> src<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> prtc <span class="token operator">+</span> <span class="token string">"://"</span> <span class="token operator">+</span> domain <span class="token operator">+</span> target<span class="token punctuation">;</span>
location<span class="token punctuation">.</span>href<span class="token operator">=</span>prtc <span class="token operator">+</span> <span class="token string">"://"</span> <span class="token operator">+</span> domain <span class="token operator">+</span> target<span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>另外，需要利用google的地址更改功能，使得旧网址的权重往新网址转移。<br>
找到search console中的地址更改工具（设置按钮中找到）。</p>
<p>除了增加404页面外，还需要增加CNAME文件，里面的内容是你原先的域名。</p>
<h2 id="参照">参照</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.lixl.cn/2019/092856736.html">基于Hexo的matery主题搭建博客并深度优化-悟尘记</a></li>
<li><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/">hexo 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://blinkfox.github.io/2018/09/28/qian-duan/hexo-bo-ke-zhu-ti-zhi-hexo-theme-matery-de-jie-shao/">闪烁之狐</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/blinkfox/hexo-theme-matery/blob/develop/README_CN.md">hexo-theme-matery</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.sky03.cn/posts/42790.html#toc-heading-1">Hexo 进阶之各种优化</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Timesi/p/9556236.html">Leancloud+Valine打造Hexo个人博客极简评论系统</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.sky03.cn/posts/42790.html">Hexo进阶之各种优化</a></li>
<li><a target="_blank" rel="noopener" href="https://sitoi.cn/posts/15908.html">自动部署篇</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luoshuitianyi/p/10333928.html">Hexo搭建(VPS)</a></li>
<li><a target="_blank" rel="noopener" href="https://boyinthesun.cn/post/error-live2d-busuanzi/">解决live2d看板娘和busuanzi不蒜子计数冲突</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2019/03/29/25951.html">多个域名映射同一个github pages</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000016286007">hexo博客简单支持PWA</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.imlete.cn/article/hexo-seo-autopush.html">Hexo 每天自动提交网站url到搜索引擎</a></li>
<li><a target="_blank" rel="noopener" href="https://yafine-blog.cn/posts/ebb2.html">Hexo 博客订阅文章通知功能</a></li>
<li><a target="_blank" rel="noopener" href="https://yafine-blog.cn/posts/3b98.html">修改 matery 原有主题相册</a></li>
<li><a target="_blank" rel="noopener" href="https://small-rose.github.io/posts/a53a9069.html">Matery主题新手常见问题</a></li>
<li><a target="_blank" rel="noopener" href="https://hunterx.xyz/hexo-gitlab-cicd-conf.html">hexo-gitlab-cicd-conf</a></li>
<li><a target="_blank" rel="noopener" href="https://jxyblog.top/article/2da64065.html">更改hexo的主题为Matery,并进行初步的优化</a></li>
<li><a target="_blank" rel="noopener" href="http://luckyzmj.cn/posts/17fd92ae.html">Hexo之渲染绕过</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.jikexueyuan.com/project/gulp-book/chapter4.html">使用 gulp 压缩图片</a></li>
<li><a target="_blank" rel="noopener" href="https://sunhwee.com/posts/6e8839eb.html">Hexo+Github博客搭建完全教程</a> <a target="_blank" rel="noopener" href="https://github.com/shw2018/hexo-blog-fly">博客开源</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000021474516">Hexo主题使用Valine-Admin管理评论和评论提醒</a></li>
<li><a target="_blank" rel="noopener" href="https://m3df.xyz/2021/06/20/edd7462d/">Hexo博客进阶：图片懒加载与代码压缩</a></li>
<li><a target="_blank" rel="noopener" href="https://qvchuang.top/archives/d3c10307.html">matery主题个性化定制</a></li>
<li><a target="_blank" rel="noopener" href="http://www.luckyzmj.cn/posts/e3e08109.html">个人博客搭建</a> <a target="_blank" rel="noopener" href="https://github.com/LuckyZmj/LuckyBlog">博客开源</a></li>
<li><a target="_blank" rel="noopener" href="https://tellyouwhat.cn/p/pwa-your-blog-can-also-be-accessed-offline/">PWA踩坑记-从零到一让你的博客也能离线访问</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>Github</tag>
        <tag>hexo</tag>
        <tag>matery</tag>
        <tag>cdn</tag>
        <tag>seo</tag>
      </tags>
  </entry>
  <entry>
    <title>自动曝光原理</title>
    <url>/posts/509c7bd3/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="自动曝光的原理">自动曝光的原理</h2>
<p>曝光是摄影中十分重要的一个环节，它决定了一张图片的明暗，如下图所示，第一张图片太暗，而第三种图片太亮。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914131959.jpeg" alt=""></p>
<h2 id="曝光由什么来决定"><strong>曝光由什么来决定</strong></h2>
<p>使用过数码相机的人都知道曝光由光圈、曝光时间、ISO三者共同决定，详细的关系就不赘述。</p>
<h3 id="光圈：控制进光量；"><strong>光圈</strong>：控制进光量；</h3>
<h3 id="曝光时间：光到达的时间长度；"><strong>曝光时间</strong>：光到达的时间长度；</h3>
<h3 id="ISO：增益；"><strong>ISO</strong>：增益；</h3>
<p>但是对于手机以及其他电子产品使用的微型摄像头，光圈大小是固定的，所以手机拍照的曝光由<strong>曝光时间</strong>和**增益(ISO)**来控制。</p>
<h2 id="什么是自动曝光"><strong>什么是自动曝光</strong></h2>
<p>数码相机中有一种手动模式，可手动设置光圈、曝光时间、ISO来控制曝光，该模式的使用对摄影师的要求会比较高。另外 数码相机的全自动模式、光圈优先模式、快门优先模式以及手机等电子产品的曝光都属于自动曝光。</p>
<p>自动曝光就是相机代替人的操作，自动调节曝光时间、光圈、ISO进行曝光，使得所摄物体亮度正常。这句话解释起来很简单，但是存在两个难点问题：第一，相机不如人眼这样可以直观的分辨图像明暗，如何判断这幅图像是否亮度合适；第二，如何调整曝光时间、光圈、ISO,这三者调节的比例。</p>
<h2 id="自动曝光的标准"><strong>自动曝光的标准</strong></h2>
<p>在此之前需要了解物体的亮度与色彩是由物体对光线的反射率来决定的。例如纯黑色的放射率是0，纯白色的反射率是100%，处于中间的灰度的反射率是18%，这就是18%中间灰度。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914132002.png" alt=""></p>
<p>具有一定反射率的物体在最终的图像中被还原到了其相应的灰度级，这就意味着达到了正确的曝光。例如摄影师们通常在拍摄之前使用中性灰卡测试曝光是否正常。</p>
<p>但是相机在各种场景下无法识别物体的反射率，因此采用了一个简单粗暴而又行之有效的方法，统一将图像整体平均亮度设置为中性灰的亮度。该方法基于**科学家认为自然界的平均反射率是18%**这一理论。当然，这个方法也不是走遍天下都不怕，比如拍摄雪景时需要增加曝光补偿，不然会偏暗，因为雪景的亮度远远大于中性灰度。这也就是摄影中的一句口诀的由来“白增黑减”。</p>
<h2 id="自动曝光算法"><strong>自动曝光算法</strong></h2>
<p>上面已经讲了自动曝光的标准，也就确立了曝光目标，要达到这一目标还要自动曝光算法来实现。</p>
<p>目前比较常见的算法有平均亮度法、权重均值法、亮度直方图等。其中最普遍的就是平均亮度法。<strong>平均亮度法</strong>就是对图像所以像素亮度求平均值，通过不断调整曝光参数最终达到目标亮度。而<strong>权重均值法</strong>是对图像不同区域设置不同权重来计算图像亮度，例如相机中的各种测光模式的选择就是改变不同区域的权重。<strong>亮度直方图法</strong>是通过为直方图中峰值分配不同权重来计算图像亮度。</p>
<p>自动曝光实现的过程：</p>
<p>第一步：对当前图像进行亮度统计；</p>
<p>第二步：根据当前图像亮度确定曝光值；</p>
<p>第三步：计算新的曝光参数，曝光时间、光圈、增益；</p>
<p>第四步：将新的曝光参数应用到相机；</p>
<p>第五步：重复步骤一到四，直到亮度满足要求。</p>
<h2 id="曝光参数调整-曝光表"><strong>曝光参数调整_曝光表</strong></h2>
<p>前面留下两个问题：“第一，相机不如人眼这样可以直观的分辨图像明暗，如何判断这幅图像是否亮度合适；第二，如何调整曝光时间、光圈、ISO,这三者调节的比例。” 第一个问题在前面有过解释，第二个问题也就是自动曝光实现步骤的第三步，曝光值由光圈、曝光时间、增益沟通决定，当计算出一个曝光量，曝光三要素有很多种组合方式。一般情况下有曝光曲线，每个曝光量对应一组参数。手机中曝光曲线可以通过Tuning调整。</p>
<p>From: <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/33462189">积极的悲观主义者</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>image</category>
      </categories>
      <tags>
        <tag>3a</tag>
        <tag>ae</tag>
        <tag>image</tag>
      </tags>
  </entry>
  <entry>
    <title>深度学习之视频人脸识别系列</title>
    <url>/posts/a0f3c838/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="系列1-简介">系列1 简介</h2>
<p>出品 | 磐创AI技术团队</p>
<p>【磐创AI导读】本文是深度学习之视频<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/facerecognition?from=10680">人脸识别</a>系列的第一篇文章，介绍了人脸识别领域的一些基本概念，分析了深度学习在人脸识别的基本流程，并总结了近年来科研领域的研究进展，最后分析了静态数据与视频动态数据在人脸识别技术上的差异。欢迎大家点击上方篮子关注我们的公众号：磐创AI。</p>
<h2 id="一、基本概念"><strong>一、基本概念</strong></h2>
<h3 id="1-人脸识别（face-identification）"><strong>1. 人脸识别（face identification）</strong></h3>
<p>人脸识别是1对n的比对，给定一张人脸图片，如何在n张人脸图片中找到同一张人脸图片，相对于一个分类问题，将一张人脸划分到n张人脸中的一张。类似于管理人员进行的人脸识别门禁系统。</p>
<h3 id="2-人脸验证（face-verification）"><strong>2.人脸验证（face verification）</strong></h3>
<p>人脸验证的1对1的比对，给定两张人脸图片，判断这两张人脸是否为同一人，类似于手机的人脸解锁系统，事先在手机在录入自己的脸部信息，然后在开锁时比对摄像头捕捉到的人脸是否与手机上录入的人脸为同一个人。</p>
<h3 id="3-人脸检测（face-detection）"><strong>3.人脸检测（face detection）</strong></h3>
<p>人脸检测是在一张图片中把人脸检测出来，即在图片上把人脸用矩形框出来，并得到矩形的坐标，如下图所示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140027.png" alt=""></p>
<h3 id="4-人脸关键点检测"><strong>4. 人脸关键点检测</strong></h3>
<p>根据输入的人脸图像，识别出面部关键特征点，如眼睛、鼻尖、嘴角点、眉毛以及人脸各部件轮廓点的坐标，如下图所示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140105.png" alt=""></p>
<h3 id="5-人脸矫正（人脸对齐）"><strong>5. 人脸矫正（人脸对齐）</strong></h3>
<p>通过人脸关键点检测得到人脸的关键点坐标，然后根据人脸的关键点坐标调整人脸的角度，使人脸对齐，由于输入图像的尺寸是大小不一的，人脸区域大小也不相同，角度不一样，所以要通过坐标变换，对人脸图像进行归一化操作，如下图所示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140120.png" alt=""></p>
<h2 id="二、基于深度学习的人脸识别算法基本流程"><strong>二、基于深度学习的人脸识别算法基本流程</strong></h2>
<p>随着神经网络的迅速发展和其对图像数据的强大的特征提取，深度学习运用于人脸识别也成为热点研究方向；2014年的开山之作DeepFace，第一个真正将<a target="_blank" rel="noopener" href="https://cloud.tencent.com/solution/bigdata?from=10680">大数据</a>和深度学习结合应用于人脸识别与验证，确立人脸识别的常规流程：图片-&gt;人脸与关键点检测-&gt;人脸对齐-&gt;人脸表征（representation）-&gt;分类。首先将图片中的人脸检测处理并通过关键点进行对齐，如何输入到神经网络，得到特征向量，通过分类训练过程，该向量即为人脸的特征向量。要求出两张人脸的相似度即计算两个特征的向量度量之差，方法包括：SVM、SiameseNetwork、JointBayesian、L1距离、L2距离、cos距离等。</p>
<h2 id="三、科研领域近期进展"><strong>三、科研领域近期进展</strong></h2>
<p>科研领域近期进展主要集中于loss函数的研究，包括DeepId2（Contrastive Loss）、FaceNet（Triplet loss）、L-Softmax、SphereFace（A-Softmax）、Center Loss、L2-Softmax、NormFace、CosFace（AM-Softmax）、ArcFace（AA-Softmax）等。</p>
<h2 id="四、基于视频人脸识别和图片人脸识别的区别"><strong>四、基于视频人脸识别和图片人脸识别的区别</strong></h2>
<p><strong>（<em>该小结部分参考于博客园 - 米罗西http://www.cnblogs.com/zhehan54/p/6727631.html</em>）</strong></p>
<p>相对于图片数据，目前视频人脸识别有很多挑战，包括：（1）视频数据一般为户外，视频图像质量比较差；（2）人脸图像比较小且模糊；（3）视频人脸识别对实时性要求更高。</p>
<p>但是视频数据也有一些优越性，视频数据同时具有空间信息和时间信息，在时间和空间的联合空间中描述人脸和识别人脸会具有一定提升空间。在视频数据中人脸跟踪是一个提高识别的方法，首先检测出人脸，然后跟踪人脸特征随时间的变化。当捕捉到一帧比较好的图像时，再使用图片人脸识别算法进行识别。这类方法中跟踪和识别是单独进行的，时间信息只在跟踪阶段用到。</p>
<p>【总结】：本期文章主要介绍了基于深度学习的人脸识别算法的一些基本入门知识，下一期我给大家介绍人脸识别中获取神经网络输入的算法，即关于人脸检测、人脸关键点检测与人脸对齐的一些重要算法和相关论文解析。</p>
<h2 id="系列2-人脸检测与对齐">系列2 人脸检测与对齐</h2>
<h2 id="一、人脸检测与关键点检测"><strong>一、人脸检测与关键点检测</strong></h2>
<h3 id="1-问题描述："><strong>1. 问题描述：</strong></h3>
<p>人脸检测解决的问题为给定一张图片，输出图片中人脸的位置，即使用方框框住人脸，输出方框的左上角坐标和右下角坐标或者左上角坐标和长宽。算法难点包括：人脸大小差异、人脸遮挡、图片模糊、角度与姿态差异、表情差异等。而关键检测则是输出人脸关键点的坐标，如左眼（x1，y1）、右眼（x2，y2）、鼻子（x3，y3）、嘴巴左上角（x4，y4）、嘴巴右上角（x5，y5）等。</p>
<h3 id="2-深度学习相关算法："><strong>2. 深度学习相关算法：</strong></h3>
<h4 id="（1）Cascade-CNN"><strong>（1）Cascade CNN</strong></h4>
<p>Cascade CNN源于发表于2015年CVPR上的一篇论文A Convolutional Neural Network Cascade for Face Detection【2】，作者提出了一种级连的CNN网络结构用于人脸检测。算法主体框架是基于V-J的瀑布流思想【1】，是传统技术和深度网络相结合的一个代表，Cascade CNN包含了多个分类器，这些分类器使用级联结构进行组织，与V-J不同的地方在于Cascade CNN采用卷积网络作为每一级的分类器。整个网络的处理流程如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140330.png" alt=""></p>
<p>整个处理流程里包含了六个网络：12-net、12-calibration-net、24-net、24-calibration-net、48-net、48-calibration-net，其中三个二分类网络用于分类其是否为人脸，另外三个calibration网络用于矫正人脸框边界。其中第二个网络之后、第四个网络之后、第五个网络之后使用NMS算法过滤掉冗余的框。</p>
<p>12-net，24-net和48-net的网络结构如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140401.png" alt=""></p>
<p>13-12-calibration-net，24-calibration-net，48-calibration-net的结构如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140426.png" alt=""></p>
<p>该算法结合了V-J框架构造了级连的CNN网络结构并设计边界矫正网络用来专门矫正人脸框边界，在AFW数据集上准确率达到97.97%。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140457.png" alt=""></p>
<h4 id="（2）Faceness-Net"><strong>（2）Faceness-Net</strong></h4>
<p>Faceness-Net源于论文A convolutional neural network cascade for face detection【3】，该算法基于DCNN网络【5】的人脸局部特征分类器，算法首先进行人脸局部特征的检测，使用多个基于DCNN网络的facial parts分类器对人脸进行评估，然后根据每个部件的得分进行规则分析得到Proposal的人脸区域，然后从局部到整体得到人脸候选区域，再对人脸候选区域进行<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/facerecognition?from=10680">人脸识别</a>和矩形框坐标回归，该过程分为两个步骤。</p>
<p>第一个步骤：每个人脸局部特征使用attribute-aware网络检测并生成人脸局部图，其中一共五个特征属性： 头发、眼睛、鼻子、嘴巴、胡子。然后通过人脸局部图根据评分构建人脸候选区域，具体如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140529.png" alt=""></p>
<p>第二个步骤：训练一个多任务的卷积网络来完成人脸二分类和矩形框坐标回归，进一步提升其效果，具体如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140548.png" alt=""></p>
<p>Faceness从脸部特征的角度来解决人脸检测中的遮挡和姿态角度问题，其整体性能在当时是非常好的，在AFW数据集上准确率可以达到98.05%。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140611.png" alt=""></p>
<h4 id="（3）MTCNN"><strong>（3）MTCNN</strong></h4>
<p>MTCNN源于论文Joint Face Detection and Alignment using Multi-task Cascaded Convolutional Networks【6】，是基于多任务级联卷积神经网络来解决人脸检测和对齐问题，同时输出图片的人脸矩阵框和关键点坐标（左眼、右眼、鼻子、嘴巴左上角、嘴巴右上角）。MTCNN为三阶的级联卷积神经网络，整体框架如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140644.png" alt=""></p>
<p>输入阶段：为应对目标多尺度问题，将原始图像resize到不同尺寸，构建图像金字塔，作为三阶级联架构的输入，这样处理可以更好地检测大小不一的人脸。</p>
<p>第一阶段：通过一个全部由卷积层组成的CNN，取名P-Net，获取候选人脸框、关键点坐标和人脸分类（是人脸或不是），之后采用NMS过滤掉高重叠率的候选窗口。如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140717.png" alt=""></p>
<p>第二阶段：第一阶段输出的候选人脸框作为更为复杂的R-Net网络的输入，R-Net进一步筛除大量错误的候选人脸框，同样也通过NMS过滤掉高重叠率的候选窗口。如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140741.png" alt=""></p>
<p>第三阶段：与第二阶段类似，最终网络输出人脸框坐标、关键点坐标和人脸分类（是人脸或不是）。如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140801.png" alt=""></p>
<p>MTCNN通过三级的级联卷积神经网络对任务进行从粗到细的处理，还提出在线困难样本生成策略（online hard sample mining ）可以进一步提升性能。兼并了速度与准确率，速度在<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/gpu?from=10680">GPU</a>上可以达到99FPS，在 FDDB数据集上可以达到95.04准确率，具体如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140818.png" alt=""></p>
<h2 id="二、人脸对齐（部分参考于GraceDD的博客文章）"><strong>二、人脸对齐（部分参考于GraceDD的博客文章）</strong></h2>
<p>人脸对齐通过人脸关键点检测得到人脸的关键点坐标，然后根据人脸的关键点坐标调整人脸的角度，使人脸对齐，由于输入图像的尺寸是大小不一的，人脸区域大小也不相同，角度不一样，所以要通过坐标变换，对人脸图像进行归一化操作。人脸关键点检测有很多算法可以使用包括：ASM、AAM、DCNN 、TCDCN 、MTCNN 、TCNN、TCNN等，这里就不详细介绍，主要说一下得到人脸关键点之后如何进行人脸对齐，是所有人脸达到归一化效果，该过程如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140841.png" alt=""></p>
<p>该过程涉及到图像的仿射变换，简单来说，“仿射变换”就是：“线性变换”+“平移”，即坐标的变换。假如我们希望人脸图片归一化为尺寸大小600<em>600，左眼位置在（180，200），右眼位置在（420，200）。 这样人脸中心在图像高度的1/3位置，并且两个眼睛保持水平，所以我们选择左眼角位置为( 0.3</em>width, height / 3 )，右眼角位置为（0.7*width , height / 3） 。</p>
<p>利用这两个点计算图像的变换矩阵（similarity transform），该矩阵是一个2*3的矩阵，如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652.png" alt=""></p>
<p>如果我们想对一个矩形进行变换，其中x、y方向的缩放因为分别为sx，sy，同时旋转一个角度 ，然后再在x方向平移tx, 在y方向平移ty</p>
<p>利用opencv的estimateRigidTransform方法，可以获得这样的变换矩阵，但遗憾的是，estimateRigidTransform至少需要三个点，所以我们需要构选第三个点，构造方法是用第三个点与已有的两个点构成等边三角形，这样第三个点的坐标为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140918.png" alt=""></p>
<p>代码如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914140938.png" alt=""></p>
<p>经过上一步的处理之后，所有的图像都变成一样大小，并且又三个关键点的位置是保持一致的，但因为除了三个点对齐了之外，其他点并没有对齐。所以根据得到的变换矩阵对剩下所有的点进行仿射变换，opencv代码如下所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914141001.png" alt=""></p>
<p>img为输入图像;</p>
<p>warped为变换后图像，类型与src一致;</p>
<p>M为变换矩阵，需要通过其它函数获得，当然也可以手动输入;</p>
<p>Image_size为输出图像的大小;</p>
<h2 id="三、-总结"><strong>三、 总结</strong></h2>
<p>本期文章主要介绍了人脸检测与对齐的相关算法，下一期我给大家介绍一下人脸表征的相关算法，即通过深度学习提取人脸特征，通过比较人脸特征进行人脸识别与验证。</p>
<h3 id="参考文献：-2"><strong>参考文献：</strong></h3>
<ul>
<li>【1】 S.Z.Li, L.Zhu, Z.Q.Zhang, A.Blake, H.J.Zhang, H.Y.Shum. Statistical learning of multi-view face detection. In: Proceedings of the 7-th European Conference on Computer Vision. Copenhagen, Denmark: Springer, 2002.67-81.</li>
<li>【2】Li H, Lin Z, Shen X, et al. A convolutional neural network cascade for face detection[C]//Proceedings of the IEEE Conference on Computer Vision and Pattern Recognition. 2015: 5325-5334.</li>
<li>【3】Yang S, Luo P, Loy C C, et al. Faceness-Net: Face detection through deep facial part responses[J]. IEEE transactions on pattern analysis and machine intelligence, 2017.</li>
<li>【4】Yang S, Luo P, Loy C C, et al. From facial parts responses to face detection: A deep learning approach[C]//Proceedings of the IEEE International Conference on Computer Vision. 2015: 3676-3684.</li>
<li>【5】Sun Y, Wang X, Tang X. Deep convolutional network cascade for facial point detection[C]//Proceedings of the IEEE conference on computer vision and pattern recognition. 2013: 3476-3483.</li>
<li>【6】Zhang K, Zhang Z, Li Z, et al. Joint face detection and alignment using multitask cascaded convolutional networks[J]. IEEE Signal Processing Letters, 2016, 23(10): 1499-1503.</li>
</ul>
<h2 id="系列3：人脸表征">系列3：人脸表征</h2>
<h2 id="一、人脸表征"><strong>一、人脸表征</strong></h2>
<p>把人脸图像通过神经网络，得到一个特定维数的特征向量，该向量可以很好地表征人脸数据，使得不同人脸的两个特征向量距离尽可能大，同一张人脸的两个特征向量尽可能小，这样就可以通过特征向量来进行人脸识别。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914141235.png" alt=""></p>
<h2 id="二、论文综述"><strong>二、论文综述</strong></h2>
<h3 id="1-DeepFace："><strong>1.</strong> <strong>DeepFace：</strong></h3>
<p>2014年论文DeepFace: Closing the Gap toHuman-Level Performance in Face Verification提出了DeepFace算法，第一个真正将<a target="_blank" rel="noopener" href="https://cloud.tencent.com/solution/bigdata?from=10680">大数据</a>和深度学习神经网络结合应用于人脸识别与验证。在该人脸识别模型中分为四个阶段：人脸检测 =&gt; 人脸对齐 =&gt; 人脸表征 =&gt; 人脸分类，在LFW数据集中可以达到97.00%的准确率。</p>
<p>（1）人脸检测与对齐：该模型使用3D模型来将人脸对齐，该方法过于繁琐，在实际应用中很少使用，经过3D对齐以后，形成的图像都是152×152的图像，具体步骤如下图。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-1.png" alt=""></p>
<p>分为如下几步：</p>
<p>a. 人脸检测，使用6个基点  b. 二维剪切，将人脸部分裁剪出来  c. 67个基点，然后Delaunay三角化，在轮廓处添加三角形来避免不连续  d. 将三角化后的人脸转换成3D形状  e. 三角化后的人脸变为有深度的3D三角网  f. 将三角网做偏转，使人脸的正面朝前。  g. 最后放正的人脸  h. 一个新角度的人脸（在论文中没有用到）</p>
<p>（2）人脸表征：人脸表征使用了5个卷积层和1个最大池化层、1个全连接层，如下图所示。前三层的目的在于提取低层次的特征,为了网络保留更多图像信息只使用了一层池化层；后面三层都是使用参数不共享的卷积核，因为主要是因为人脸不同的区域的特征是不一样的，具有很大的区分性，比如鼻子和眼睛所表示的特征是不一样的，但是使用参数不共享的卷积核也增加了模型计算量以及需要更多的训练数据。最后输出的4096维向量进行L2归一化。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914141316.png" alt=""></p>
<p>a. Conv：32个11×11×3的卷积核</p>
<p>b. max-pooling: 3×3， stride=2</p>
<p>c. Conv: 16个9×9的卷积核</p>
<p>d. Local-Conv: 16个9×9的卷积核，Local的意思是卷积核的参数不共享</p>
<p>e. Local-Conv: 16个7×7的卷积核，参数不共享</p>
<p>f. Local-Conv: 16个5×5的卷积核，参数不共享</p>
<p>g. Fully-connected: 4096维</p>
<p>h. Softmax: 4030维</p>
<p>（3）分类：论文介绍了两种方法进行分类，加权的卡方距离和使用Siamese网络结构，设f1和f2为特征向量，上一个步骤的输出，则有：</p>
<p>①加权卡方距离：计算公式如下，加权参数由线性SVM计算得到：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-2.png" alt=""></p>
<p>②Siamese网络：网络结构是成对进行训练，得到的特征表示再使用如下公式进行计算距离：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-3.png" alt=""></p>
<h3 id="2-DeepID1："><strong>2.</strong> <strong>DeepID1：</strong></h3>
<p>DeepID1 是2014年Deep LearningFace Representation from Predicting 10,000 Classes一文提出的，是DeepID三部曲的第一篇。DeepID1 使用softmax多分类训练，主要思想第一个是数据集的增大，包括训练集使用celebface，包含87628张图片，5436个人脸，增大了训练集；使用多尺寸输入，通过5个landmarks将每张人脸划分成10regions，每张图片提取60patches=10regions<em>3scales</em>2(RGB orgray)，第二个是网络结构，DeepID提取的人脸特征就是一个由连接第三层与第四层组成的全连接层特征，如下图所示，每个patches经过这个cnn网络，第四层的特征更加全局化（global），第三层的特征更加细节，因此DeepID连接了两者，以求同时包含全局，细节信息。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-4.png" alt=""></p>
<p>60个patches使用60个CNN,每个CNN提取2*160=320维特征（与水平翻转一起输入），总网络模型如下图所示，最后分别使用联合贝叶斯算法与神经网络进行分类，并比较结果。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-5.png" alt=""></p>
<p>模型最终以CelebFaces+中202,599图像作为训练集， patch数提升为100（10r<em>10s</em>2） ，特征数提升为100<em>160</em>2=32000 然后使用PCA降为150维 ，使用联合贝叶斯算法进行验证， 最终在LFW上达到97.20%的验证准确率。</p>
<h3 id="3-DeepID2："><strong>3.</strong> <strong>DeepID2：</strong></h3>
<p>DeepID2是Deep Learning Face Representationby Joint Identification-Verification一文提出的，对DeepID1进行了进一步的改进，提出了contrastive loss，在分类任务，我们需要的是减少类内差距（同一人脸），增加类间差距（不同人脸），softmax loss分类的监督信号可以增大类间差距，但是却对类内差距影响不大，所以DeepID2加入了另一个loss，contrastive loss，从而增加验证的监督信号，就可以减少类内差距。</p>
<p>网络结构类似DeepID1,不同之处在于使用了两种不同的损失函数，网络结构如下图所示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-6.png" alt=""></p>
<p>损失函数：</p>
<p>①分类信号，Softmax loss。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-7.png" alt=""></p>
<p>②验证信号，contrastiveloss，使用l2范数距离表示，m为阈值不参与训练，括号内的θve={m}，该损失函数可以让类间的距离给定一个限制margin，即m大小的距离。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-8.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-9.png" alt=""></p>
<p>两loss的组合方式： 首先使用2个输入，计算Softmax loss和contrastive loss,总损失为二者通过λ加权求和，通过总损失来执行梯度下降更新卷积参数，通过Softmax loss来更新softmax层的参数。</p>
<p>整个模型使用celebrate+数据集训练，每张图片使用了21 facial landmarks，分成200patches（20regions<em>5scales</em>2RGB&amp;Gray)，水平翻转后变为400patches，使用了200个卷积神经网络，提取400（200<em>2）个Deepid2特征，使用贪婪算法降为25个Deepid2特征，使用PCA将25</em>160Deepid2特征降为180维，最后使用联合贝叶斯算法进行验证，最终在LFW上得到的最终准确率是98.97%，使用7组25个Deepid2特征，SVM融合可得到准确率为99.15% 。DeepID2在2014 年是人脸领域非常有影响力的工作，也掀起了在人脸领域引进 MetricLearning 的浪潮。</p>
<h3 id="4-DeepID2-："><strong>4.</strong> <strong>DeepID2+：</strong></h3>
<p>DeepID2+源于论文Deeply learned facerepresentations are sparse, selective, and robust，DeepID2+是对DeepID2的改进。①卷积层在原来基础上再增加128维，第四层全连接层从160增加到512，训练数据增加了CelebFaces+ dataset，WDRef等，有12000个人脸的大约290,000张图片； ②每个卷积层的后面都加了一个512为的全连接层，并添加contrastive loss监督信号，而不仅在第四层全连接层上有 。网络结构如下图所示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-10.png" alt=""></p>
<p>最终在LFW数据集上准确率为99.47%。</p>
<h3 id="5-DeepID3："><strong>5.</strong> <strong>DeepID3：</strong></h3>
<p>DeepID3源于2015年的Deepid3:Face recognition with very deep neural networks论文，该论文探究了复杂神经网络对人脸识别的作用。论文研究VGG与GoogleNet用于人脸识别的效果，论文在VGG和GooLeNet的基础上进行构建合适的结构，使得方便人脸识别。结果发现DeepID3的结果和DeepID2+相当，可能是由于数据集的瓶颈，需要更大的数据才能有更好的提升，两个网络结构如下图所示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-11.png" alt=""></p>
<p>网络输出使用PCA降维到300维的向量，使用联合贝叶斯算法进行验证，最终在LFW上得到的最终准确率是99.53%。</p>
<h3 id="6-FaceNet："><strong>6.</strong> <strong>FaceNet：</strong></h3>
<p>FaceNet由论文Facenet: A unified embedding forface recognition and clustering提出，这篇 2015 年来自 Google 的 论文同样具有非常大的影响力，不仅仅成功应用了 TripletLoss 在 benchmark 上取得state-of-art 的结果，更因为他们提出了一个绝大部分人脸问题的统一解决框架，即：识别、验证、搜索等问题都可以放到特征空间里做，需要专注解决的仅仅是如何将人脸更好的映射到特征空间。FaceNet在DeepID的基础上，将 ContrastiveLoss 改进为 Triplet Loss，去掉softmaxloss。FaceNet实验了ZFNet类型网络和Inception类型网络，最终Inception类型网络效果更好，网络结构如下图所示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-12.png" alt=""></p>
<p>FaceNet没有使用PCA降维，而是在网络中直接训练输出128维的向量，用全连接层来完成降维，最后的128维的向量经过Triplet Loss。</p>
<p>Triplet Loss输入不再是 Image Pair，而是三张图片（Triplet），分别为 Anchor Face（xa），Negative Face（xn）和 Positive Face（xp）。Anchor 与 Positive Face 为同一人，与 Negative Face 为不同人，在特征空间里 Anchor 与 Positive 的距离要小于 Anchor 与 Negative 的距离，且相差超过一个 Margin Alpha。</p>
<p>loss的目标为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-13.png" alt=""></p>
<p>总loss公式为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-14.png" alt=""></p>
<p>Contrastive Loss与Triplet Loss的比较， Contrastive Loss目标是减少类内差距（两个蓝点），增加类间差距（蓝点与红点）；Triplet Loss则是输入三张图片，Anchor 与 Positive 的距离要小于 Anchor 与 Negative 的距离，且相差超过一个 Margin Alpha，即Triplet Loss同时约束了两个距离。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-15.png" alt=""></p>
<p>最后FaceNet在LFW数据集上达到了99.63%的准确率。</p>
<p>基于 ContrastiveLoss 和 Triplet Loss 的 MetricLearning 符合人的认知规律，在实际应用中也取得了不错的效果，但同时也有很多问题，由于ContrastiveLoss 和 Triplet Loss 的训练样本都基于pair 或者 triplet 的，可能的样本数是 O(N2) 或者 O (N3) 的，所以模型需要很久的计算才能拟合并且训练集需要足够大。</p>
<h2 id="三、总结"><strong>三、总结</strong></h2>
<p>本期文章主要介绍人脸表征相关算法和论文综述，主要是2014年到2016年的研究成果， ContrastiveLoss 和 Triplet Loss在实际应用中也取得了很好的效果，但是也有很多问题，由于Contrastive Loss 和 Triplet Loss 的训练样本都基于 pair 或者 triplet 的，可能的样本数是 O (N2) 或者 O (N3) 的，所以模型需要很久的计算才能拟合并且训练集要足够大，所以在之后的人脸识别研究中，大部分在于loss函数的研究，这部分将会在下一期给大家介绍。</p>
<h3 id="参考文献：-3"><strong>参考文献：</strong></h3>
<ul>
<li>【1】 Taigman Y, Yang M, Ranzato M A, et al.Deepface: Closing the gap to human-level performance in faceverification[C]//Proceedings of the IEEE conference on computer vision andpattern recognition. 2014: 1701-1708.</li>
<li>【2】Sun Y, Wang X, Tang X. Deep learning facerepresentation from predicting 10,000 classes[C]//Proceedings of the IEEEconference on computer vision and pattern recognition. 2014: 1891-1898.</li>
<li>【3】Sun Y, Chen Y, Wang X, et al. Deeplearning face representation by joint identification-verification[C]//Advancesin neural information processing systems. 2014: 1988-1996.</li>
<li>【4】Sun Y, Liang D, Wang X, et al. Deepid3:Face recognition with very deep neural networks[J]. arXiv preprintarXiv:1502.00873, 2015.</li>
<li>【5】Simonyan K, Zisserman A. Very deepconvolutional networks for large-scale image recognition[J]. arXiv preprintarXiv:1409.1556, 2014.</li>
<li>【6】Szegedy C, Liu W, Jia Y, et al. Goingdeeper with convolutions[C]//Proceedings of the IEEE conference on computervision and pattern recognition. 2015: 1-9.</li>
<li>【7】Sun Y, Wang X, Tang X. Deeply learned facerepresentations are sparse, selective, and robust[C]//Proceedings of the IEEEconference on computer vision and pattern recognition. 2015: 2892-2900.</li>
<li>【8】Schroff F, Kalenichenko D, Philbin J.Facenet: A unified embedding for face recognition andclustering[C]//Proceedings of the IEEE conference on computer vision andpattern recognition. 2015: 815-823.</li>
</ul>
<h2 id="系列4：人脸表征-续">系列4：人脸表征-续</h2>
<h2 id="一、人脸表征-2"><strong>一、人脸表征</strong></h2>
<p>把人脸图像通过神经网络，得到一个特定维数的特征向量，该向量可以很好地表征人脸数据，使得不同人脸的两个特征向量距离尽可能大，同一张人脸的两个特征向量尽可能小，这样就可以通过特征向量来进行人脸识别。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-16.png" alt=""></p>
<h2 id="二、论文综述-2"><strong>二、论文综述</strong></h2>
<h3 id="1-L-Softmax："><strong>1.</strong> <strong>L-Softmax：</strong></h3>
<p>Softmax Loss函数被广泛应用于深度学习，较为简单实用，但是它并不能够明确引导神经网络学习区分性较高的特征。L-Softmax能够有效地引导网络学习使得样本类内距离较小、类间距离较大的特征，L-Softmax不但能够调节类间距离的间隔（margin）大小，而且能够防止过拟合。</p>
<p>L-Softmax是对softmax loss的改进，softmax loss公式如下所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-17.png" alt=""></p>
<p>其中 fj 表示最终全连接层的类别输出向量 f的第 j个元素, N为训练样本的个数，则 fyi可以表示为 fyi=WTyi xi，其中 0≤θj≤π，最终的损失函数可得：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-18.png" alt=""></p>
<p>softmax的目的是使得WT1x&gt;WT2x，即 ∥W1∥∥x∥cos(θ1)&gt;∥W2∥∥x∥cos(θ2)，从而得到输入x（来自类别1）输出正确的分类结果。L-Softmax通过增加一个正整数变量m，从而产生一个决策余量，能够更加严格地约束上述不等式，即：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-19.png" alt=""></p>
<p>其中0≤θ1&lt;π/m。如果W1和W2能够满足∥W1∥∥x∥cos(mθ1)&gt;∥W2∥∥x∥cos(θ2)，那么就必然满足∥W1∥∥x∥cos(θ1)&gt;∥W2∥∥x∥cos(θ2)，这样的约束对学习W1和W2的过程提出了更高的要求，在训练学习过程中，类间要比之前多了一个m的间隔，从而使得1类和2类有了更宽的分类决策边界。这种Margin Based Classification使得学习更加的困难，从而使类间距离增加了一个margin距离，L-Softmax loss的总公式如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-20.png" alt=""></p>
<p>当m越大时，分类的边界越大，学习难度当然就越高。</p>
<p>论文仅使用了WebFace数据集作为训练集和一个简单的卷积网络，就在LFW上达到了98.71%的正确率，证明了L-Softmax loss取得了比softmax loss更好的结果。</p>
<h3 id="2-SphereFace"><strong>2.</strong> <strong>SphereFace :</strong></h3>
<p>SphereFace在MegaFace数据集上识别率在2017年排名第一，提出A-Softmax Loss使人脸识别达到不错的效果。A-Softmax Loss基于softmax loss和L-Softmax loss，在二分类模型中，softmax loss为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-21.png" alt=""></p>
<p>如果x为类别一，则希望p1&gt;p2,则二分类的划分函数为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-22.png" alt=""></p>
<p>权重归一化||w||为1，b为0，此时特征上的点映射到单位超球面上，则二分类的划分函数为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-23.png" alt=""></p>
<p>然后使用与L-Softmax loss相同的原理，使</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-24.png" alt=""></p>
<p>则A-Softmax Loss最终为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-25.png" alt=""></p>
<p>因此A-Softmax Loss是样本类别之间产生了角度距离，让决策函数更加严格并且更加具有可区分性。当m增大，角度距离也会增加。</p>
<p>A-Softmax与L-Softmax的最大区别在于A-Softmax的权重归一化了，而L-Softmax则没有。A-Softmax权重的归一化导致特征上的点映射到单位超球面上，A-Softmax仅仅能从角度上划分类别，而L-Softmax是在角度与长度方向进行考量，两个方向如果划分不一就会收到干扰，导致精度下降。</p>
<p>SphereFace使用的模型如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-26.png" alt=""></p>
<p>训练与测试过程如下图所示，在测试过程中使用余弦计算相似度：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-27.png" alt=""></p>
<p>最终SphereFace在训练集较小的情况下，LFW数据集上准确率为99.42%。Sphereface效果很好，但是它不优美。在测试阶段，Sphereface通过特征间的余弦值来衡量相似性，即以角度为相似性的度量，在训练阶段，其实Sphereface的损失函数并不是在直接优化特征与类中心的角度，而是优化特征与类中心的角度在乘上一个特征的长度，这就造成了训练跟测试之间目标不一致。</p>
<h3 id="3-Normface"><strong>3.</strong> <strong>Normface :</strong></h3>
<p>在优化人脸识别任务时，softmax本身优化的是没有归一化的内积结果，但是最后在预测的时候使用的一般是cosine距离或者欧式距离，这会导致优化目标和最终的距离度量其实并不一致。 Normface的核心思想是既然最后在特征对比的时候使用归一化的cosine距离，那么在训练的过程中把特征也做归一化处理，做了归一化之后，softmax的优化就变成了直接优化cosine距离了，归一化过程如下，其中e是为了防止除0的较小正数：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-28.png" alt=""></p>
<p>相应的损失函数如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-29.png" alt=""></p>
<p>其中 W 是归一化的权重，f_i 是归一化的特征，参数 s 的引入是因为保证梯度大小的合理性，去掉bias是因为softmax之前的fc有bias的情况下会使得有些类别在角度上没有区分性但是通过bias可以区分，在这种情况下如果对feature做normalize，会使得中间的那个小类别的feature变成一个单位球形并与其他的feature重叠在一起，所以在feature normalize的时候是不能加bias的。</p>
<p>Normface使用了较小的模型使用多种loss训练，然后在LFW数据集上测试，证明了feature normalize的效果，结果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142413.png" alt=""></p>
<h3 id="4-CosFace"><strong>4.</strong> <strong>CosFace :</strong></h3>
<p>Normface用特征归一化解决了Sphereface训练和测试不一致的问题。但是却没有了margin的惩罚，腾讯AI Lab的CosFace或者AM-softmax是在Normface的基础上引入了margin，损失函数为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-30.png" alt=""></p>
<p>其中特征与权值都做了归一化：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-31.png" alt=""></p>
<p>分类决策为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-32.png" alt=""></p>
<p>，比之前增加了m的margin，m 是一个超参数，控制惩罚的力度，m 越大，惩罚越强。</p>
<p>CosFace使用mtcnn进行人脸检测与对齐，人脸表征训练模型使用基于residual units 64层卷积网络的Sphere Face，在5M的训练集上训练，在LFW数据集上测试，精度达到99.73%。</p>
<h3 id="5-ArcFace"><strong>5.</strong> <strong>ArcFace :</strong></h3>
<p>ArcFace源于论文Additive angular margin lossfor deep face recognition，也叫做InsightFace，论文基本介绍了近期较为流行的人脸识别模型，loss变化从softmax到AM-softmax，然后提出ArcFace，可以说起到了很好的综述作用，论文从三个方面探讨影响人脸识别模型精度的主要因素。</p>
<p>（1）数据：数据方面，论文探讨了各个数据集的数据质量和优缺点，并对MS-Celeb-1M，MegaFace FaceScrub做了清洗，清洗后的数据公开。</p>
<p>（2）网络：详细对比了不同的主流网络结构的性能，包括输入层尺寸大小、最后输出几层的不同结构、基本网络单元残差网络的不同结构、主干网络的不同模型。经过实验的证明，最后的网络结构：输入图片大小112x112；第一层convLayer 卷积核为3<em>3 stride 1时，网络输出7</em>7；主干网络使用ResNet100，并使用改进后的改进的残差网络结构，如下图；最后的几层输出层为最后一个卷积层后+BN-Dropout-FC-BN的结构。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-33.png" alt=""></p>
<p>（3）损失函数：与 AM-softmax相比，区别在于Arcface引入margin的方式不同，损失函数为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914142652-34.png" alt=""></p>
<p>Arcface的m是在余弦里面，AM-softmax的在外面，ArcFace更为直观并且在超球面维度上有更清晰的解释。Arcface在VGG2和MS-Celeb-1M数据集上训练，在LFW数据集上精度达到99.83%。</p>
<h2 id="三、总结-2"><strong>三、总结</strong></h2>
<p>本期文章主要介绍人脸表征相关算法和论文综述，人脸检测、对齐、特征提取等这些操作都可以在静态数据中完成，下一期将给大家介绍在视频数据中进行人脸识别的另一个重要的算法，视频人脸跟踪的概念与方法。</p>
<h3 id="参考文献：-4"><strong>参考文献：</strong></h3>
<ul>
<li>【1】 Liu W, Wen Y, Yu Z, et al. Large-MarginSoftmax Loss for Convolutional Neural Networks[C]//ICML. 2016: 507-516.1708.</li>
<li>【2】Liu W, Wen Y, Yu Z, et al. Sphereface:Deep hypersphere embedding for face recognition[C]//The IEEE Conference onComputer Vision and Pattern Recognition (CVPR). 2017, 1: 1.</li>
<li>【3】Wang F, Xiang X, Cheng J, et al. Normface:l 2 hypersphere embedding for face verification[C]//Proceedings of the 2017 ACMon Multimedia Conference. ACM, 2017: 1041-1049.</li>
<li>【4】Wang F, Cheng J, Liu W, et al. Additivemargin softmax for face verification[J]. IEEE Signal Processing Letters, 2018,25(7): 926-930.</li>
<li>【5】Wang H, Wang Y, Zhou Z, et al. CosFace:Large margin cosine loss for deep face recognition[J]. arXiv preprintarXiv:1801.09414, 2018.</li>
<li>【6】Deng J, Guo J, Zafeiriou S. Arcface:Additive angular margin loss for deep face recognition[J]. arXiv preprintarXiv:1801.07698, 2018.</li>
</ul>
<p>From： https://cloud.tencent.com/developer/article/1160037?from=article.detail.1344438</p>
<p>出品 | 磐创AI技术团队</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>ai</category>
      </categories>
      <tags>
        <tag>ai</tag>
        <tag>face</tag>
      </tags>
  </entry>
  <entry>
    <title>1.5 万字 CSS 基础拾遗（核心知识、常见需求）</title>
    <url>/posts/448f849b/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-5-万字-CSS-基础拾遗（核心知识、常见需求）">1.5 万字 CSS 基础拾遗（核心知识、常见需求）</h2>
<p>本篇文章围绕了 CSS 的核心知识点和项目中常见的需求来展开。虽然行文偏长，但偏基础，适合初级中级前端阅读，阅读的时候请适当跳过已经掌握的部分。</p>
<p>这篇文章断断续续写了比较久，也参考了许多优秀的文章，但或许文章里还是存在不好或不对的地方，请多多指教，可以评论里直接提出来哈。</p>
<p>小tip：后续内容更精彩哦。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912192327.png" alt=""></p>
<h2 id="核心概念和知识点">核心概念和知识点</h2>
<h3 id="语法">语法</h3>
<p>CSS 的核心功能是将 CSS 属性设定为特定的值。一个属性与值的键值对被称为<strong>声明</strong>（declaration）。</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>而如果将一个或者多个声明用 <code>{}</code> 包裹起来后，那就组成了一个<strong>声明块</strong>（declaration block）。</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token punctuation">{</span>  
    <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>  
    <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>声明块如果需要作用到对应的 HTML 元素，那还需要加上<strong>选择器</strong>。选择器和声明块组成了<strong>CSS 规则集</strong>（CSS ruleset），常简称为 CSS 规则。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914005346.png" alt=""></p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">span</span> <span class="token punctuation">{</span>  
    <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>  
    <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>“</p>
<p>规则集中最后一条声明可以省略分号，但是并不建议这么做，因为容易出错。</p>
</blockquote>
<p>CSS 中的<strong>注释</strong>：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* 单行注释 */</span>

<span class="token comment">/*  
    多行  
    注释  
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 CSS 文件中，除了注释、CSS 规则集以及 @规则 外，定义的一些别的东西都将被浏览器忽略。</p>
<h3 id="规则">@规则</h3>
<p>CSS 规则是样式表的主体，通常样式表会包括大量的规则列表。但有时候也需要在样式表中包括其他的一些信息，比如字符集，导入其它的外部样式表，字体等，这些需要专门的语句表示。</p>
<p>而 @规则 就是这样的语句。CSS 里包含了以下 @规则：</p>
<ul>
<li>
<p>@namespace 告诉 CSS 引擎必须考虑XML命名空间。</p>
</li>
<li>
<p>@media, 如果满足媒体查询的条件则条件规则组里的规则生效。</p>
</li>
<li>
<p>@page, 描述打印文档时布局的变化.</p>
</li>
<li>
<p>@font-face, 描述将下载的外部的字体。</p>
</li>
<li>
<p>@keyframes, 描述 CSS 动画的关键帧。</p>
</li>
<li>
<p>@document, 如果文档样式表满足给定条件则条件规则组里的规则生效。 (推延至 CSS Level 4 规范)</p>
</li>
</ul>
<p>除了以上这几个之外，下面还将对几个比较生涩的 @规则 进行介绍。</p>
<h4 id="charset">@charset</h4>
<p>@charset[1] 用于定义样式表使用的字符集。它必须是样式表中的第一个元素。如果有多个 <code>@charset</code> 被声明，只有第一个会被使用，而且不能在HTML元素或HTML页面的 <code>&lt;style&gt;</code> 元素内使用。</p>
<p>注意：值必须是双引号包裹，且和</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token atrule"><span class="token rule">@charset</span> <span class="token string">"UTF-8"</span><span class="token punctuation">;</span></span>  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>平时写样式文件都没写 @charset 规则，那这个 CSS 文件到底是用的什么字符编码的呢？</p>
<p>某个样式表文件到底用的是什么字符编码，浏览器有一套识别顺序（优先级由高到低）：</p>
<ul>
<li>
<p>文件开头的 Byte order mark[2] 字符值，不过一般编辑器并不能看到文件头里的 BOM 值；</p>
</li>
<li>
<p>HTTP 响应头里的 <code>content-type</code> 字段包含的 <code>charset</code> 所指定的值，比如：</p>
<p><code>Content-Type: text/css; charset=utf-8  </code><br>
`</p>
</li>
<li>
<p>CSS 文件头里定义的 @charset 规则里指定的字符编码；</p>
</li>
<li>
<p><code>&lt;link&gt;</code> 标签里的 charset 属性，该条已在 HTML5 中废除；</p>
</li>
<li>
<p>默认是 <code>UTF-8</code>。</p>
</li>
</ul>
<h4 id="import">@import</h4>
<p>@import[3] 用于告诉 CSS 引擎引入一个外部样式表。</p>
<p>link 和 @import 都能导入一个样式文件，它们有什么区别嘛？</p>
<ul>
<li>
<p>link 是 HTML 标签，除了能导入 CSS 外，还能导入别的资源，比如图片、脚本和字体等；而 @import 是 CSS 的语法，只能用来导入 CSS；</p>
</li>
<li>
<p>link 导入的样式会在页面加载时同时加载，@import 导入的样式需等页面加载完成后再加载；</p>
</li>
<li>
<p>link 没有兼容性问题，@import 不兼容 ie5 以下；</p>
</li>
<li>
<p>link 可以通过 JS 操作 DOM 动态引入样式表改变样式，而@import不可以。</p>
</li>
</ul>
<h4 id="supports">@supports</h4>
<p>@supports[4] 用于查询特定的 CSS 是否生效，可以结合 not、and 和 or 操作符进行后续的操作。</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* 如果支持自定义属性，则把 body 颜色设置为变量 varName 指定的颜色 */</span>  
<span class="token atrule"><span class="token rule">@supports</span> <span class="token punctuation">(</span><span class="token property">--foo</span><span class="token punctuation">:</span> green<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>  
    <span class="token selector">body</span> <span class="token punctuation">{</span>  
        <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--varName<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="层叠性">层叠性</h3>
<p>层叠样式表，这里的层叠怎么理解呢？其实它是 CSS 中的核心特性之一，用于合并来自多个源的属性值的算法。比如说针对某个 HTML 标签，有许多的 CSS 声明都能作用到的时候，那最后谁应该起作用呢？层叠性说的大概就是这个。</p>
<p>针对不同源的样式，将按照如下的顺序进行层叠，越往下优先级越高：</p>
<ul>
<li>
<p>用户代理样式表中的声明(例如，浏览器的默认样式，在没有设置其他样式时使用)。</p>
</li>
<li>
<p>用户样式表中的常规声明(由用户设置的自定义样式。由于 Chrome 在很早的时候就放弃了用户样式表的功能，所以这里将不再考虑它的排序。)。</p>
</li>
<li>
<p>作者样式表中的常规声明(这些是我们 Web 开发人员设置的样式)。</p>
</li>
<li>
<p>作者样式表中的 !important 声明。</p>
</li>
<li>
<p>用户样式表中的 !important 声明S。</p>
</li>
</ul>
<p>理解层叠性的时候需要结合 CSS 选择器的优先级以及继承性来理解。比如针对同一个选择器，定义在后面的声明会覆盖前面的；作者定义的样式会比默认继承的样式优先级更高。</p>
<h3 id="选择器">选择器</h3>
<p>CSS 选择器无疑是其核心之一，对于基础选择器以及一些常用伪类必须掌握。下面列出了常用的选择器。 想要获取更多选择器的用法可以看 MDN CSS Selectors[5]。</p>
<h4 id="基础选择器">基础选择器</h4>
<ul>
<li>
<p>标签选择器：<code>h1</code></p>
</li>
<li>
<p>类选择器：<code>.checked</code></p>
</li>
<li>
<p>ID 选择器：<code>#picker</code></p>
</li>
<li>
<p>通配选择器：<code>*</code></p>
</li>
</ul>
<p><strong>属性选择器</strong></p>
<ul>
<li>
<p><code>[attr]</code>：指定属性的元素；</p>
</li>
<li>
<p><code>[attr=val]</code>：属性等于指定值的元素；</p>
</li>
<li>
<p><code>[attr*=val]</code>：属性包含指定值的元素；</p>
</li>
<li>
<p><code>[attr^=val]</code> ：属性以指定值开头的元素；</p>
</li>
<li>
<p><code>[attr$=val]</code>：属性以指定值结尾的元素；</p>
</li>
<li>
<p><code>[attr~=val]</code>：属性包含指定值(完整单词)的元素(不推荐使用)；</p>
</li>
<li>
<p><code>[attr|=val]</code>：属性以指定值(完整单词)开头的元素(不推荐使用)；</p>
</li>
</ul>
<h4 id="组合选择器">组合选择器</h4>
<ul>
<li>
<p>相邻兄弟选择器：<code>A + B</code></p>
</li>
<li>
<p>普通兄弟选择器：<code>A ~ B</code></p>
</li>
<li>
<p>子选择器：<code>A &gt; B</code></p>
</li>
<li>
<p>后代选择器：<code>A B</code></p>
</li>
</ul>
<h4 id="伪类">伪类</h4>
<p><strong>条件伪类</strong></p>
<ul>
<li>
<p><code>:lang()</code>：基于元素语言来匹配页面元素；</p>
</li>
<li>
<p><code>:dir()</code>：匹配特定文字书写方向的元素；</p>
</li>
<li>
<p><code>:has()</code>：匹配包含指定元素的元素；</p>
</li>
<li>
<p><code>:is()</code>：匹配指定选择器列表里的元素；</p>
</li>
<li>
<p><code>:not()</code>：用来匹配不符合一组选择器的元素；</p>
</li>
</ul>
<p><strong>行为伪类</strong></p>
<ul>
<li>
<p><code>:active</code>：鼠标激活的元素；</p>
</li>
<li>
<p><code>:hover</code>： 鼠标悬浮的元素；</p>
</li>
<li>
<p><code>::selection</code>：鼠标选中的元素；</p>
</li>
</ul>
<p><strong>状态伪类</strong></p>
<ul>
<li>
<p><code>:target</code>：当前锚点的元素；</p>
</li>
<li>
<p><code>:link</code>：未访问的链接元素；</p>
</li>
<li>
<p><code>:visited</code>：已访问的链接元素；</p>
</li>
<li>
<p><code>:focus</code>：输入聚焦的表单元素；</p>
</li>
<li>
<p><code>:required</code>：输入必填的表单元素；</p>
</li>
<li>
<p><code>:valid</code>：输入合法的表单元素；</p>
</li>
<li>
<p><code>:invalid</code>：输入非法的表单元素；</p>
</li>
<li>
<p><code>:in-range</code>：输入范围以内的表单元素；</p>
</li>
<li>
<p><code>:out-of-range</code>：输入范围以外的表单元素；</p>
</li>
<li>
<p><code>:checked</code>：选项选中的表单元素；</p>
</li>
<li>
<p><code>:optional</code>：选项可选的表单元素；</p>
</li>
<li>
<p><code>:enabled</code>：事件启用的表单元素；</p>
</li>
<li>
<p><code>:disabled</code>：事件禁用的表单元素；</p>
</li>
<li>
<p><code>:read-only</code>：只读的表单元素；</p>
</li>
<li>
<p><code>:read-write</code>：可读可写的表单元素；</p>
</li>
<li>
<p><code>:blank</code>：输入为空的表单元素；</p>
</li>
<li>
<p><code>:current()</code>：浏览中的元素；</p>
</li>
<li>
<p><code>:past()</code>：已浏览的元素；</p>
</li>
<li>
<p><code>:future()</code>：未浏览的元素；</p>
</li>
</ul>
<p><strong>结构伪类</strong></p>
<ul>
<li>
<p><code>:root</code>：文档的根元素；</p>
</li>
<li>
<p><code>:empty</code>：无子元素的元素；</p>
</li>
<li>
<p><code>:first-letter</code>：元素的首字母；</p>
</li>
<li>
<p><code>:first-line</code>：元素的首行；</p>
</li>
<li>
<p><code>:nth-child(n)</code>：元素中指定顺序索引的元素；</p>
</li>
<li>
<p><code>:nth-last-child(n)</code>：元素中指定逆序索引的元素；；</p>
</li>
<li>
<p><code>:first-child</code>：元素中为首的元素；</p>
</li>
<li>
<p><code>:last-child</code> ：元素中为尾的元素；</p>
</li>
<li>
<p><code>:only-child</code>：父元素仅有该元素的元素；</p>
</li>
<li>
<p><code>:nth-of-type(n)</code>：标签中指定顺序索引的标签；</p>
</li>
<li>
<p><code>:nth-last-of-type(n)</code>：标签中指定逆序索引的标签；</p>
</li>
<li>
<p><code>:first-of-type</code> ：标签中为首的标签；</p>
</li>
<li>
<p><code>:last-of-type</code>：标签中为尾标签；</p>
</li>
<li>
<p><code>:only-of-type</code>：父元素仅有该标签的标签；</p>
</li>
</ul>
<h4 id="伪元素">伪元素</h4>
<ul>
<li>
<p><code>::before</code>：在元素前插入内容；</p>
</li>
<li>
<p><code>::after</code>：在元素后插入内容；</p>
</li>
</ul>
<h3 id="优先级">优先级</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912192225.png" alt=""></p>
<p>优先级就是分配给指定的 CSS 声明的一个权重，它由匹配的选择器中的每一种选择器类型的数值决定。为了记忆，可以把权重分成如下几个等级，数值越大的权重越高：</p>
<ul>
<li>
<p>10000：!important；</p>
</li>
<li>
<p>01000：内联样式；</p>
</li>
<li>
<p>00100：ID 选择器；</p>
</li>
<li>
<p>00010：类选择器、伪类选择器、属性选择器；</p>
</li>
<li>
<p>00001：元素选择器、伪元素选择器；</p>
</li>
<li>
<p>00000：通配选择器、后代选择器、兄弟选择器；</p>
</li>
</ul>
<p>可以看到内联样式（通过元素中 style 属性定义的样式）的优先级大于任何选择器；而给属性值加上 <code>!important</code> 又可以把优先级提至最高，就是因为它的优先级最高，所以需要谨慎使用它，以下有些使用注意事项：</p>
<ul>
<li>
<p>一定要优先考虑使用样式规则的优先级来解决问题而不是 !important；</p>
</li>
<li>
<p>只有在需要覆盖全站或外部 CSS 的特定页面中使用 !important；</p>
</li>
<li>
<p>永远不要在你的插件中使用 !important；</p>
</li>
<li>
<p>永远不要在全站范围的 CSS 代码中使用 !important；</p>
</li>
</ul>
<h3 id="继承性">继承性</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912192218.jpeg" alt=""></p>
<p>在 CSS 中有一个很重要的特性就是子元素会继承父元素对应属性计算后的值。比如页面根元素 html 的文本颜色默认是黑色的，页面中的所有其他元素都将继承这个颜色，当申明了如下样式后，H1 文本将变成橙色。</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">{</span>  
    <span class="token property">color</span><span class="token punctuation">:</span> orange<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token selector">h1</span> <span class="token punctuation">{</span>  
    <span class="token property">color</span><span class="token punctuation">:</span> inherit<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>设想一下，如果 CSS 中不存在继承性，那么我们就需要为不同文本的标签都设置一下 color，这样一来的后果就是 CSS 的文件大小就会无限增大。</p>
<p>CSS 属性很多，但并不是所有的属性默认都是能继承父元素对应属性的，那哪些属性存在默认继承的行为呢？一定是那些不会影响到页面布局的属性，可以分为如下几类：</p>
<ul>
<li>
<p>字体相关：<code>font-family</code>、<code>font-style</code>、<code>font-size</code>、<code>font-weight</code> 等；</p>
</li>
<li>
<p>文本相关：<code>text-align</code>、<code>text-indent</code>、<code>text-decoration</code>、<code>text-shadow</code>、<code>letter-spacing</code>、<code>word-spacing</code>、<code>white-space</code>、<code>line-height</code>、<code>color</code> 等；</p>
</li>
<li>
<p>列表相关：<code>list-style</code>、<code>list-style-image</code>、<code>list-style-type</code>、<code>list-style-position</code> 等；</p>
</li>
<li>
<p>其他属性：<code>visibility</code>、<code>cursor</code> 等；</p>
</li>
</ul>
<p>对于其他默认不继承的属性也可以通过以下几个属性值来控制继承行为：</p>
<ul>
<li>
<p><code>inherit</code>：继承父元素对应属性的计算值；</p>
</li>
<li>
<p><code>initial</code>：应用该属性的默认值，比如 color 的默认值是 <code>#000</code>；</p>
</li>
<li>
<p><code>unset</code>：如果属性是默认可以继承的，则取 <code>inherit</code> 的效果，否则同 <code>initial</code>；</p>
</li>
<li>
<p><code>revert</code>：效果等同于 <code>unset</code>，兼容性差。</p>
</li>
</ul>
<h3 id="文档流">文档流</h3>
<p>在 CSS 的世界中，会把内容按照从左到右、从上到下的顺序进行排列显示。正常情况下会把页面分割成一行一行的显示，而每行又可能由多列组成，所以从视觉上看起来就是从上到下从左到右，而这就是 CSS 中的流式布局，又叫文档流。文档流就像水一样，能够自适应所在的容器，一般它有如下几个特性：</p>
<ul>
<li>
<p>块级元素默认会占满整行，所以多个块级盒子之间是从上到下排列的；</p>
</li>
<li>
<p>内联元素默认会在一行里一列一列的排布，当一行放不下的时候，会自动切换到下一行继续按照列排布；</p>
</li>
</ul>
<p><strong>如何脱离文档流呢？</strong></p>
<p>脱流文档流指节点脱流正常文档流后，在正常文档流中的其他节点将忽略该节点并填补其原先空间。文档一旦脱流，计算其父节点高度时不会将其高度纳入，脱流节点不占据空间。有两种方式可以让元素脱离文档流：浮动和定位。</p>
<ul>
<li>
<p>使用浮动（float）会将元素脱离文档流，移动到容器左/右侧边界或者是另一个浮动元素旁边，该浮动元素之前占用的空间将被别的元素填补，另外浮动之后所占用的区域不会和别的元素之间发生重叠；</p>
</li>
<li>
<p>使用绝对定位（<code>position: absolute;</code>）或者固定定位（<code>position: fixed;</code>）也会使得元素脱离文档流，且空出来的位置将自动被后续节点填补。</p>
</li>
</ul>
<h3 id="盒模型">盒模型</h3>
<p>在 CSS 中任何元素都可以看成是一个盒子，而一个盒子是由 4 部分组成的：内容（content）、内边距（padding）、边框（border）和外边距（margin）。</p>
<p>盒模型有 2 种：标准盒模型和 IE 盒模型，本别是由 W3C 和 IExplore 制定的标准。</p>
<p>如果给某个元素设置如下样式：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.box</span> <span class="token punctuation">{</span>  
    <span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>  
    <span class="token property">height</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>  
    <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>  
    <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #eee<span class="token punctuation">;</span>  
    <span class="token property">margin</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>标准盒模型认为：盒子的实际尺寸 = 内容（设置的宽/高） + 内边距 + 边框</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912192143.png" alt=""></p>
<p>所以 <code>.box</code> 元素内容的宽度就为 <code>200px</code>，而实际的宽度则是 <code>width</code> + <code>padding-left</code> + <code>padding-right</code> + <code>border-left-width</code> + <code>border-right-width</code> = 200 + 10 + 10 + 1 + 1 = 222。</p>
<p>IE 盒模型认为：盒子的实际尺寸 = 设置的宽/高 = 内容 + 内边距 + 边框</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912192137.png" alt=""></p>
<p><code>.box</code> 元素所占用的实际宽度为 <code>200px</code>，而内容的真实宽度则是 <code>width</code> - <code>padding-left</code> - <code>padding-right</code> - <code>border-left-width</code> - <code>border-right-width</code> = 200 - 10 - 10 - 1 - 1 = 178。</p>
<p>现在高版本的浏览器基本上默认都是使用标准盒模型，而像 IE6 这种老古董才是默认使用 IE 盒模型的。</p>
<p>在  CSS3 中新增了一个属性 <code>box-sizing</code>，允许开发者来指定盒子使用什么标准，它有 2 个值：</p>
<ul>
<li>
<p><code>content-box</code>：标准盒模型；</p>
</li>
<li>
<p><code>border-box</code>：IE 盒模型；</p>
</li>
</ul>
<h3 id="视觉格式化模型">视觉格式化模型</h3>
<p>视觉格式化模型（Visual formatting model）是用来处理和在视觉媒体上显示文档时使用的计算规则。CSS 中一切皆盒子，而视觉格式化模型简单来理解就是规定这些盒子应该怎么样放置到页面中去，这个模型在计算的时候会依赖到很多的因素，比如：盒子尺寸、盒子类型、定位方案（是浮动还是定位）、兄弟元素或者子元素以及一些别的因素。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912192137.jpeg" alt=""></p>
<p>Visual formatting model</p>
<p>从上图中可以看到视觉格式化模型涉及到的内容很多，有兴趣深入研究的可以结合上图看这个 W3C 的文档 Visual formatting model[6]。所以这里就简单介绍下盒子类型。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912192129.png" alt=""></p>
<p>盒子类型由 display 决定，同时给一个元素设置 display 后，将会决定这个盒子的 2 个显示类型（display type）：</p>
<ul>
<li>
<p>outer display type（对外显示）：决定了该元素本身是如何布局的，即参与何种格式化上下文；</p>
</li>
<li>
<p>inner display type（对内显示）：其实就相当于把该元素当成了容器，规定了其内部子元素是如何布局的，参与何种格式化上下文；</p>
</li>
</ul>
<h4 id="outer-display-type">outer display type</h4>
<p>对外显示方面，盒子类型可以分成 2 类：block-level box（块级盒子） 和 inline-level box（行内级盒子）。</p>
<p>依据上图可以列出都有哪些块级和行内级盒子：</p>
<ul>
<li>
<p>块级盒子：display 为 block、list-item、table、flex、grid、flow-root 等；</p>
</li>
<li>
<p>行内级盒子：display 为 inline、inline-block、inline-table 等；</p>
</li>
</ul>
<p>所有块级盒子都会参与 BFC，呈现垂直排列；而所有行内级盒子都参会 IFC，呈现水平排列。</p>
<p>除此之外，block、inline 和 inline-block 还有什么更具体的区别呢？</p>
<p><strong>block</strong></p>
<ul>
<li>
<p>占满一行，默认继承父元素的宽度；多个块元素将从上到下进行排列；</p>
</li>
<li>
<p>设置 width/height 将会生效；</p>
</li>
<li>
<p>设置 padding 和 margin 将会生效；</p>
</li>
</ul>
<p><strong>inline</strong></p>
<ul>
<li>
<p>不会占满一行，宽度随着内容而变化；多个 inline 元素将按照从左到右的顺序在一行里排列显示，如果一行显示不下，则自动换行；</p>
</li>
<li>
<p>设置 width/height 将不会生效；</p>
</li>
<li>
<p>设置竖直方向上的 padding 和 margin 将不会生效；</p>
</li>
</ul>
<p><strong>inline-block</strong></p>
<ul>
<li>
<p>是行内块元素，不单独占满一行，可以看成是能够在一行里进行左右排列的块元素；</p>
</li>
<li>
<p>设置 width/height 将会生效；</p>
</li>
<li>
<p>设置 padding 和 margin 将会生效；</p>
</li>
</ul>
<h4 id="inner-display-type">inner display type</h4>
<p>对内方面，其实就是把元素当成了容器，里面包裹着文本或者其他子元素。container box 的类型依据 display 的值不同，分为 4 种：</p>
<ul>
<li>
<p>block container：建立 BFC 或者 IFC；</p>
</li>
<li>
<p>flex container：建立 FFC；</p>
</li>
<li>
<p>grid container：建立 GFC;</p>
</li>
<li>
<p>ruby container：接触不多，不做介绍。</p>
</li>
</ul>
<p>值得一提的是如果把 img 这种替换元素（replaced element）申明为 block 是不会产生 container box 的，因为替换元素比如 img 设计的初衷就仅仅是通过 src 把内容替换成图片，完全没考虑过会把它当成容器。</p>
<p>参考：</p>
<ul>
<li>
<p>CSS 原理 - 你所不知道的 display[7]</p>
</li>
<li>
<p>格式化上下文[8]</p>
</li>
</ul>
<h3 id="格式化上下文">格式化上下文</h3>
<p>格式化上下文（Formatting Context）是 CSS2.1 规范中的一个概念，大概说的是页面中的一块渲染区域，规定了渲染区域内部的子元素是如何排版以及相互作用的。</p>
<p>不同类型的盒子有不同格式化上下文，大概有这 4 类：</p>
<ul>
<li>
<p>BFC (Block Formatting Context) 块级格式化上下文；</p>
</li>
<li>
<p>IFC (Inline Formatting Context) 行内格式化上下文；</p>
</li>
<li>
<p>FFC (Flex Formatting Context) 弹性格式化上下文；</p>
</li>
<li>
<p>GFC (Grid Formatting Context) 格栅格式化上下文；</p>
</li>
</ul>
<p>其中 BFC 和 IFC 在 CSS 中扮演着非常重要的角色，因为它们直接影响了网页布局，所以需要深入理解其原理。</p>
<h4 id="BFC">BFC</h4>
<p>块格式化上下文，它是一个独立的渲染区域，只有块级盒子参与，它规定了内部的块级盒子如何布局，并且与这个区域外部毫不相干。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912192122.png" alt=""></p>
<p>图来源于 yachen168</p>
<p><strong>BFC 渲染规则</strong></p>
<ul>
<li>
<p>内部的盒子会在垂直方向，一个接一个地放置；</p>
</li>
<li>
<p>盒子垂直方向的距离由 margin 决定，属于同一个 BFC 的两个相邻盒子的 margin 会发生重叠；</p>
</li>
<li>
<p>每个元素的 margin 的左边，与包含块 border 的左边相接触(对于从左往右的格式化，否则相反)，即使存在浮动也是如此；</p>
</li>
<li>
<p>BFC 的区域不会与 float 盒子重叠；</p>
</li>
<li>
<p>BFC 就是页面上的一个隔离的独立容器，容器里面的子元素不会影响到外面的元素。反之也如此。</p>
</li>
<li>
<p>计算 BFC 的高度时，浮动元素也参与计算。</p>
</li>
</ul>
<p><strong>如何创建 BFC？</strong></p>
<ul>
<li>
<p>根元素：html</p>
</li>
<li>
<p>非溢出的可见元素：overflow 不为 visible</p>
</li>
<li>
<p>设置浮动：float 属性不为 none</p>
</li>
<li>
<p>设置定位：position 为 absolute 或 fixed</p>
</li>
<li>
<p>定义成块级的非块级元素：display: inline-block/table-cell/table-caption/flex/inline-flex/grid/inline-grid</p>
</li>
</ul>
<p><strong>BFC 应用场景</strong></p>
<p>1、 自适应两栏布局</p>
<p>应用原理：BFC 的区域不会和浮动区域重叠，所以就可以把侧边栏固定宽度且左浮动，而对右侧内容触发 BFC，使得它的宽度自适应该行剩余宽度。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912192107.gif" alt=""></p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css">&lt;div class=<span class="token string">"layout"</span>&gt;  
    &lt;div class=<span class="token string">"aside"</span>&gt;aside&lt;/div&gt;  
    &lt;div class=<span class="token string">"main"</span>&gt;main&lt;/div&gt;  
&lt;/div&gt;  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.aside</span> <span class="token punctuation">{</span>  
    <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>  
    <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token selector">.main</span> <span class="token punctuation">{</span>  
    &lt;!-- 触发 BFC --&gt;  
    <span class="token property">overflow</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2、清除内部浮动</p>
<p>浮动造成的问题就是父元素高度坍塌，所以清除浮动需要解决的问题就是让父元素的高度恢复正常。而用     BFC 清除浮动的原理就是：计算 BFC 的高度时，浮动元素也参与计算。只要触发父元素的 BFC 即可。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912192102.png" alt=""></p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.parent</span> <span class="token punctuation">{</span>
    <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>3、 防止垂直 margin 合并</p>
<p>BFC 渲染原理之一：同一个 BFC 下的垂直 margin 会发生合并。所以如果让 2 个元素不在同一个 BFC 中即可阻止垂直 margin 合并。那如何让 2 个相邻的兄弟元素不在同一个 BFC 中呢？可以给其中一个元素外面包裹一层，然后触发其包裹层的 BFC，这样一来 2 个元素就不会在同一个 BFC 中了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912192012.png" alt=""></p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css">&lt;div class=<span class="token string">"layout"</span>&gt;  
	&lt;div class=<span class="token string">"a"</span>&gt;a&lt;/div&gt;  
    &lt;div class=<span class="token string">"contain-b"</span>&gt;  
        &lt;div class=<span class="token string">"b"</span>&gt;b&lt;/div&gt;  
    &lt;/div&gt;  
&lt;/div&gt;  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.demo3 .a,  
.demo3 .b</span> <span class="token punctuation">{</span>  
    <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #999<span class="token punctuation">;</span>  
    <span class="token property">margin</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token selector">.contain-b</span> <span class="token punctuation">{</span>  
    <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>针对以上 3 个 示例 ，可以结合这个 BFC 应用示例 配合观看更佳。</p>
<p>参考：CSS 原理 - Formatting Context[9]</p>
<h4 id="IFC">IFC</h4>
<p>IFC 的形成条件非常简单，块级元素中仅包含内联级别元素，需要注意的是当IFC中有块级元素插入时，会产生两个匿名块将父元素分割开来，产生两个 IFC。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912160820.png" alt=""></p>
<p><strong>IFC 渲染规则</strong></p>
<ul>
<li>
<p>子元素在水平方向上一个接一个排列，在垂直方向上将以容器顶部开始向下排列；</p>
</li>
<li>
<p>节点无法声明宽高，其中 margin 和 padding 在水平方向有效在垂直方向无效；</p>
</li>
<li>
<p>节点在垂直方向上以不同形式对齐；</p>
</li>
<li>
<p>能把在一行上的框都完全包含进去的一个矩形区域，被称为该行的线盒（line box）。线盒的宽度是由包含块（containing box）和与其中的浮动来决定；</p>
</li>
<li>
<p>IFC 中的 line box 一般左右边贴紧其包含块，但 float 元素会优先排列。</p>
</li>
<li>
<p>IFC 中的 line box 高度由 line-height 计算规则来确定，同个 IFC 下的多个 line box 高度可能会不同；</p>
</li>
<li>
<p>当内联级盒子的总宽度少于包含它们的 line box 时，其水平渲染规则由 text-align 属性值来决定；</p>
</li>
<li>
<p>当一个内联盒子超过父元素的宽度时，它会被分割成多盒子，这些盒子分布在多个 line box 中。如果子元素未设置强制换行的情况下，inline box 将不可被分割，将会溢出父元素。</p>
</li>
</ul>
<p>针对如上的 IFC 渲染规则，你是不是可以分析下下面这段代码的 IFC 环境是怎么样的呢？</p>
<p><code>&lt;p&gt;It can get &lt;strong&gt;very complicated&lt;/storng&gt; once you start looking into it.&lt;/p&gt;   </code></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912160815.jpeg" alt=""></p>
<p>对应上面这样一串 HTML 分析如下：</p>
<ul>
<li>
<p>p 标签是一个 block container，对内将产生一个 IFC；</p>
</li>
<li>
<p>由于一行没办法显示完全，所以产生了 2 个线盒（line box）；线盒的宽度就继承了 p 的宽度；高度是由里面的内联盒子的 line-height 决定；</p>
</li>
<li>
<p>It can get：匿名的内联盒子；</p>
</li>
<li>
<p>very complicated：strong 标签产生的内联盒子；</p>
</li>
<li>
<p>once you start：匿名的内联盒子；</p>
</li>
<li>
<p>looking into it.：匿名的内联盒子。</p>
</li>
</ul>
<p>参考：Inline formatting contexts[10]</p>
<p><strong>IFC 应用场景</strong></p>
<ul>
<li>
<p>水平居中：当一个块要在环境中水平居中时，设置其为 inline-block 则会在外层产生 IFC，通过 text-align 则可以使其水平居中。</p>
</li>
<li>
<p>垂直居中：创建一个 IFC，用其中一个元素撑开父元素的高度，然后设置其 vertical-align: middle，其他行内元素则可以在此父元素下垂直居中。</p>
</li>
</ul>
<p>偷个懒，demo 和图我就不做了。</p>
<h3 id="层叠上下文">层叠上下文</h3>
<p>在电脑显示屏幕上的显示的页面其实是一个三维的空间，水平方向是 X 轴，竖直方向是 Y 轴，而屏幕到眼睛的方向可以看成是 Z 轴。众 HTML 元素依据自己定义的属性的优先级在 Z 轴上按照一定的顺序排开，而这其实就是层叠上下文所要描述的东西。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912160813.png" alt=""></p>
<p>-w566</p>
<p>我们对层叠上下文的第一印象可能要来源于 z-index，认为它的值越大，距离屏幕观察者就越近，那么层叠等级就越高，事实确实是这样的，但层叠上下文的内容远非仅仅如此：</p>
<ul>
<li>
<p>z-index 能够在层叠上下文中对元素的堆叠顺序其作用是必须配合定位才可以；</p>
</li>
<li>
<p>除了 z-index 之外，一个元素在 Z 轴上的显示顺序还受层叠等级和层叠顺序影响；</p>
</li>
</ul>
<p>在看层叠等级和层叠顺序之前，我们先来看下如何产生一个层叠上下文，特定的 HTML 元素或者 CSS 属性产生层叠上下文，MDN 中给出了这么一个列表，符合以下任一条件的元素都会产生层叠上下文：</p>
<ul>
<li>
<p>html 文档根元素</p>
</li>
<li>
<p>声明 position: absolute/relative 且 z-index 值不为 auto 的元素；</p>
</li>
<li>
<p>声明 position: fixed/sticky 的元素；</p>
</li>
<li>
<p>flex 容器的子元素，且 z-index 值不为 auto；</p>
</li>
<li>
<p>grid 容器的子元素，且 z-index 值不为 auto；</p>
</li>
<li>
<p>opacity 属性值小于 1 的元素；</p>
</li>
<li>
<p>mix-blend-mode 属性值不为 normal 的元素；</p>
</li>
<li>
<p>以下任意属性值不为 none 的元素：</p>
</li>
<li>
<p>transform</p>
</li>
<li>
<p>filter</p>
</li>
<li>
<p>perspective</p>
</li>
<li>
<p>clip-path</p>
</li>
<li>
<p>mask / mask-image / mask-border</p>
</li>
<li>
<p>isolation 属性值为 isolate 的元素；</p>
</li>
<li>
<p>-webkit-overflow-scrolling 属性值为 touch 的元素；</p>
</li>
<li>
<p>will-change 值设定了任一属性而该属性在 non-initial 值时会创建层叠上下文的元素；</p>
</li>
<li>
<p>contain 属性值为 layout、paint 或包含它们其中之一的合成值（比如 contain: strict、contain: content）的元素。</p>
</li>
</ul>
<p><strong>层叠等级</strong></p>
<p>层叠等级指节点在三维空间 Z 轴上的上下顺序。它分两种情况：</p>
<ul>
<li>
<p>在同一个层叠上下文中，它描述定义的是该层叠上下文中的层叠上下文元素在 Z 轴上的上下顺序；</p>
</li>
<li>
<p>在其他普通元素中，它描述定义的是这些普通元素在 Z 轴上的上下顺序；</p>
</li>
</ul>
<p>普通节点的层叠等级优先由其所在的层叠上下文决定，层叠等级的比较只有在当前层叠上下文中才有意义，脱离当前层叠上下文的比较就变得无意义了。</p>
<p><strong>层叠顺序</strong></p>
<p>在同一个层叠上下文中如果有多个元素，那么他们之间的层叠顺序是怎么样的呢？</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912160807.png" alt=""></p>
<p>以下这个列表越往下层叠优先级越高，视觉上的效果就是越容易被用户看到（不会被其他元素覆盖）：</p>
<ul>
<li>
<p>层叠上下文的 border 和 background</p>
</li>
<li>
<p>z-index &lt; 0 的子节点</p>
</li>
<li>
<p>标准流内块级非定位的子节点</p>
</li>
<li>
<p>浮动非定位的子节点</p>
</li>
<li>
<p>标准流内行内非定位的子节点</p>
</li>
<li>
<p>z-index: auto/0 的子节点</p>
</li>
<li>
<p>z-index &gt; 0的子节点</p>
</li>
</ul>
<p><strong>如何比较两个元素的层叠等级？</strong></p>
<ul>
<li>
<p>在同一个层叠上下文中，比较两个元素就是按照上图的介绍的层叠顺序进行比较。</p>
</li>
<li>
<p>如果不在同一个层叠上下文中的时候，那就需要比较两个元素分别所处的层叠上下文的等级。</p>
</li>
<li>
<p>如果两个元素都在同一个层叠上下文，且层叠顺序相同，则在 HTML 中定义越后面的层叠等级越高。</p>
</li>
</ul>
<p>参考：彻底搞懂CSS层叠上下文、层叠等级、层叠顺序、z-index[11]</p>
<h3 id="值和单位">值和单位</h3>
<p>CSS 的声明是由属性和值组成的，而值的类型有许多种：</p>
<ul>
<li>
<p>数值：长度值 ，用于指定例如元素 width、border-width、font-size 等属性的值；</p>
</li>
<li>
<p>百分比：可以用于指定尺寸或长度，例如取决于父容器的 width、height 或默认的 font-size；</p>
</li>
<li>
<p>颜色：用于指定 background-color、color 等；</p>
</li>
<li>
<p>坐标位置：以屏幕的左上角为坐标原点定位元素的位置，比如常见的 background-position、top、right、bottom 和 left 等属性；</p>
</li>
<li>
<p>函数：用于指定资源路径或背景图片的渐变，比如 url()、linear-gradient() 等；</p>
</li>
</ul>
<p>而还有些值是需要带单位的，比如 width: 100px，这里的 px 就是表示长度的单位，长度单位除了 px 外，比较常用的还有 em、rem、vw/vh 等。那他们有什么区别呢？又应该在什么时候使用它们呢？</p>
<h4 id="px">px</h4>
<p>屏幕分辨率是指在屏幕的横纵方向上的像素点数量，比如分辨率 1920×1080 意味着水平方向含有 1920 个像素数，垂直方向含有 1080 个像素数。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912160800.png" alt=""></p>
<p>而 px 表示的是 CSS 中的像素，在 CSS 中它是绝对的长度单位，也是最基础的单位，其他长度单位会自动被浏览器换算成 px。但是对于设备而言，它其实又是相对的长度单位，比如宽高都为 2px，在正常的屏幕下，其实就是 4 个像素点，而在设备像素比(devicePixelRatio) 为 2 的 Retina 屏幕下，它就有 16 个像素点。所以屏幕尺寸一致的情况下，屏幕分辨率越高，显示效果就越细腻。</p>
<p>讲到这里，还有一些相关的概念需要理清下：</p>
<p><strong>设备像素（Device pixels）</strong></p>
<p>设备屏幕的物理像素，表示的是屏幕的横纵有多少像素点；和屏幕分辨率是差不多的意思。</p>
<p><strong>设备像素比（DPR）</strong></p>
<p>设备像素比表示 1 个 CSS 像素等于几个物理像素。</p>
<p>计算公式：DPR = 物理像素数 / 逻辑像素数；</p>
<p>在浏览器中可以通过 window.devicePixelRatio 来获取当前屏幕的 DPR。</p>
<p><strong>像素密度（DPI/PPI）</strong></p>
<p>像素密度也叫显示密度或者屏幕密度，缩写为 DPI(Dots Per Inch) 或者 PPI(Pixel Per Inch)。从技术角度说，PPI 只存在于计算机显示领域，而 DPI 只出现于打印或印刷领域。</p>
<p>计算公式：像素密度 = 屏幕对角线的像素尺寸 / 物理尺寸</p>
<p>比如，对于分辨率为 750 * 1334 的 iPhone 6 来说，它的像素密度为：</p>
<p><code>Math.sqrt(750 * 750 + 1334 * 1334) / 4.7 = 326ppi   </code></p>
<p><strong>设备独立像素（DIP）</strong></p>
<p>DIP 是特别针对 Android设备而衍生出来的，原因是安卓屏幕的尺寸繁多，因此为了显示能尽量和设备无关，而提出的这个概念。它是基于屏幕密度而计算的，认为当屏幕密度是 160 的时候，px = DIP。</p>
<p>计算公式：dip = px * 160 / dpi</p>
<h4 id="em">em</h4>
<p>em 是 CSS 中的相对长度单位中的一个。居然是相对的，那它到底是相对的谁呢？它有 2 层意思：</p>
<ul>
<li>
<p>在 font-size 中使用是相对于<strong>父元素</strong>的 font-size 大小，比如父元素 font-size: 16px，当给子元素指定 font-size: 2em 的时候，经过计算后它的字体大小会是 32px；</p>
</li>
<li>
<p>在其他属性中使用是相对于自身的字体大小，如 width/height/padding/margin 等；</p>
</li>
</ul>
<p>我们都知道每个浏览器都会给 HTML 根元素 html 设置一个默认的 font-size，而这个值通常是 16px。这也就是为什么 1em = 16px 的原因所在了。</p>
<p>em 在计算的时候是会层层计算的，比如：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css">&lt;div&gt;  
    &lt;p&gt;&lt;/p&gt;  
&lt;/div&gt;  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">div</span> <span class="token punctuation">{</span> <span class="token property">font-size</span><span class="token punctuation">:</span> 2em<span class="token punctuation">;</span> <span class="token punctuation">}</span>  
<span class="token selector">p</span> <span class="token punctuation">{</span> <span class="token property">font-size</span><span class="token punctuation">:</span> 2em<span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>对于如上一个结构的 HTML，由于根元素 html 的字体大小是 16px，所以 p 标签最终计算出来后的字体大小会是 16 * 2 * 2 = 64px</p>
<h4 id="rem">rem</h4>
<p>rem(root em) 和 em 一样，也是一个相对长度单位，不过 rem 相对的是 HTML 的根元素 html。</p>
<p>rem 由于是基于 html 的 font-size 来计算，所以通常用于自适应网站或者 H5 中。</p>
<p>比如在做 H5 的时候，前端通常会让 UI 给 750px 宽的设计图，而在开发的时候可以基于 iPhone X 的尺寸 375px * 812px 来写页面，这样一来的话，就可以用下面的 JS 依据当前页面的视口宽度自动计算出根元素 html 的基准 font-size 是多少。</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">(function (doc, win)</span> <span class="token punctuation">{</span>  
    <span class="token selector">var docEl = doc.documentElement,  
        resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',  
        psdWidth = 750,  // 设计图宽度  
        recalc = function ()</span> <span class="token punctuation">{</span>  
            var clientWidth = docEl.clientWidth<span class="token punctuation">;</span>  
            if <span class="token punctuation">(</span> !clientWidth <span class="token punctuation">)</span> return<span class="token punctuation">;</span>  
            <span class="token selector">if ( clientWidth &gt;= 640 )</span> <span class="token punctuation">{</span>  
                docEl.style.fontSize = 200 * <span class="token punctuation">(</span> 640 / psdWidth <span class="token punctuation">)</span> + <span class="token string">'px'</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span> <span class="token selector">else</span> <span class="token punctuation">{</span>  
                docEl.style.fontSize = 200 * <span class="token punctuation">(</span> clientWidth / psdWidth <span class="token punctuation">)</span> + <span class="token string">'px'</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

    if <span class="token punctuation">(</span> !doc.addEventListener <span class="token punctuation">)</span> return<span class="token punctuation">;</span>  
    // 绑定事件的时候最好配合防抖函数  
    win.<span class="token function">addEventListener</span><span class="token punctuation">(</span> resizeEvt<span class="token punctuation">,</span> <span class="token function">debounce</span><span class="token punctuation">(</span>recalc<span class="token punctuation">,</span> 1000<span class="token punctuation">)</span><span class="token punctuation">,</span> false <span class="token punctuation">)</span><span class="token punctuation">;</span>  
    doc.<span class="token function">addEventListener</span><span class="token punctuation">(</span> <span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> recalc<span class="token punctuation">,</span> false <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token selector">function debounce(func, wait)</span> <span class="token punctuation">{</span>  
        var timeout<span class="token punctuation">;</span>  
        <span class="token selector">return function ()</span> <span class="token punctuation">{</span>  
            var context = this<span class="token punctuation">;</span>  
            var args = arguments<span class="token punctuation">;</span>  
            <span class="token selector">clearTimeout(timeout)  
            timeout = setTimeout(function()</span><span class="token punctuation">{</span>  
                func.<span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span>  
            <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>比如当视口是 375px 的时候，经过计算 html 的 font-size 会是 100px，这样有什么好处呢？好处就是方便写样式，比如从设计图量出来的 header 高度是 50px 的，那我们写样式的时候就可以直接写：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">header</span> <span class="token punctuation">{</span>  
    <span class="token property">height</span><span class="token punctuation">:</span> 0.5rem<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912160740.png" alt=""></p>
<p>每个从设计图量出来的尺寸只要除于 100 即可得到当前元素的 rem 值，都不用经过计算，非常方便。偷偷告诉你，如果你把上面那串计算 html 标签 font-size 的 JS 代码中的 200 替换成 2，那在计算 rem 的时候就不需要除于 100 了，从设计图量出多大 px，就直接写多少个 rem。</p>
<h4 id="vw-vh">vw/vh</h4>
<p>vw 和 vh 分别是相对于屏幕视口宽度和高度而言的长度单位：</p>
<ul>
<li>
<p>1vw = 视口宽度均分成 100 份中 1 份的长度；</p>
</li>
<li>
<p>1vh = 视口高度均分成 100 份中 1 份的长度；</p>
</li>
</ul>
<p>在 JS 中 100vw = window.innerWidth，100vh = window.innerHeight。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912160734.jpeg" alt=""></p>
<p>vw/vh 的出现使得多了一种写自适应布局的方案，开发者不再局限于 rem 了。</p>
<p>相对视口的单位，除了 vw/vh 外，还有 vmin 和 vmax：</p>
<ul>
<li>
<p>vmin：取 vw 和 vh 中值较小的；</p>
</li>
<li>
<p>vmax：取 vw 和 vh 中值较大的；</p>
</li>
</ul>
<h3 id="颜色体系">颜色体系</h3>
<p>CSS 中用于表示颜色的值种类繁多，足够构成一个体系，所以这里就专门拿出一个小节来讲解它。</p>
<p>根据 CSS 颜色草案[12] 中提到的颜色值类型，大概可以把它们分为这几类：</p>
<ul>
<li>
<p>颜色关键字</p>
</li>
<li>
<p>transparent 关键字</p>
</li>
<li>
<p>currentColor 关键字</p>
</li>
<li>
<p>RGB 颜色</p>
</li>
<li>
<p>HSL 颜色</p>
</li>
</ul>
<h4 id="颜色关键字">颜色关键字</h4>
<p>颜色关键字（color keywords）是不区分大小写的标识符，它表示一个具体的颜色，比如 white（白），黑（black）等；</p>
<p>可接受的关键字列表在CSS的演变过程中发生了改变：</p>
<ul>
<li>
<p>CSS 标准 1 只接受 16 个基本颜色，称为 VGA 颜色，因为它们来源于 VGA 显卡所显示的颜色集合而被称为 VGA colors （视频图形阵列色彩）。</p>
</li>
<li>
<p>CSS 标准 2 增加了 orange 关键字。</p>
</li>
<li>
<p>从一开始，浏览器接受其它的颜色，由于一些早期浏览器是 X11 应用程序，这些颜色大多数是 X11 命名的颜色列表，虽然有一点不同。SVG 1.0 是首个正式定义这些关键字的标准；CSS 色彩标准 3 也正式定义了这些关键字。它们经常被称作扩展的颜色关键字， X11 颜色或 SVG 颜色 。</p>
</li>
<li>
<p>CSS 颜色标准 4 添加可 rebeccapurple 关键字来纪念 web 先锋 Eric Meyer。</p>
</li>
</ul>
<p>如下这张图是 16 个基础色，又叫 VGA 颜色。截止到目前为止 CSS 颜色关键字总共有 146 个，这里可以查看 完整的色彩关键字列表[13]。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912160733.png" alt=""></p>
<p>VGA 颜色</p>
<p>需要注意的是如果声明的时候的颜色关键字是错误的，浏览器会忽略它。</p>
<h4 id="transparent-关键字">transparent 关键字</h4>
<p>transparent 关键字表示一个完全透明的颜色，即该颜色看上去将是背景色。从技术上说，它是带有 alpha 通道为最小值的黑色，是 rgba(0,0,0,0) 的简写。</p>
<p>透明关键字有什么应用场景呢？</p>
<p><strong>实现三角形</strong></p>
<p>下面这个图是用 4 条边框填充的正方形，看懂了它你大概就知道该如何用 CSS 写三角形了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912160726.png" alt=""></p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">div</span> <span class="token punctuation">{</span>  
    <span class="token property">border-top-color</span><span class="token punctuation">:</span> #ffc107<span class="token punctuation">;</span>  
    <span class="token property">border-right-color</span><span class="token punctuation">:</span> #00bcd4<span class="token punctuation">;</span>  
    <span class="token property">border-bottom-color</span><span class="token punctuation">:</span> #e26b6b<span class="token punctuation">;</span>  
    <span class="token property">border-left-color</span><span class="token punctuation">:</span> #cc7cda<span class="token punctuation">;</span>  
    <span class="token property">border-width</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>  
    <span class="token property">border-style</span><span class="token punctuation">:</span> solid<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>用 transparent 实现三角形的原理：</p>
<ul>
<li>
<p>首先宽高必须是 0px，通过边框的粗细来填充内容；</p>
</li>
<li>
<p>那条边需要就要加上颜色，而不需要的边则用 transparent；</p>
</li>
<li>
<p>想要什么样姿势的三角形，完全由上下左右 4 条边的中有颜色的边和透明的边的位置决定；</p>
</li>
<li>
<p>等腰三角形：设置一条边有颜色，然后紧挨着的 2 边是透明，且宽度是有颜色边的一半；直角三角形：设置一条边有颜色，然后紧挨着的任何一边透明即可。</p>
</li>
</ul>
<p>看下示例：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912160719.png" alt=""></p>
<p><strong>增大点击区域</strong></p>
<p>常常在移动端的时候点击的按钮的区域特别小，但是由于现实效果又不太好把它做大，所以常用的一个手段就是通过透明的边框来增大按钮的点击区域：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.btn</span> <span class="token punctuation">{</span>  
    <span class="token property">border</span><span class="token punctuation">:</span> 5px solid transparent<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="currentColor-关键字">currentColor 关键字</h4>
<p>currentColor 会取当前元素继承父级元素的文本颜色值或声明的文本颜色值，即 computed 后的 color 值。</p>
<p>比如，对于如下 CSS，该元素的边框颜色会是 red：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.btn</span> <span class="token punctuation">{</span>  
    <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>  
    <span class="token property">border</span><span class="token punctuation">:</span> 1px solid currentColor<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="RGB-A-颜色">RGB[A] 颜色</h4>
<p>RGB[A] 颜色是由 R(red)-G(green)-B(blue)-A(alpha) 组成的色彩空间。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912160707.png" alt=""></p>
<p>在 CSS 中，它有两种表示形式：</p>
<ul>
<li>
<p>十六进制符号；</p>
</li>
<li>
<p>函数符；</p>
</li>
</ul>
<p><strong>十六进制符号</strong></p>
<p>RGB 中的每种颜色的值范围是 00~ff，值越大表示颜色越深。所以一个颜色正常是 6 个十六进制字符加上 # 组成，比如红色就是 #ff0000。</p>
<p>如果 RGB 颜色需要加上不透明度，那就需要加上 alpha 通道的值，它的范围也是 00~ff，比如一个带不透明度为 67% 的红色可以这样写 #ff0000aa。</p>
<p>使用十六进制符号表示颜色的时候，都是用 2 个十六进制表示一个颜色，如果这 2 个字符相同，还可以缩减成只写 1 个，比如，红色 #f00；带 67% 不透明度的红色 #f00a。</p>
<p><strong>函数符</strong></p>
<p>当 RGB 用函数表示的时候，每个值的范围是 0~255 或者 0%~100%，所以红色是 rgb(255, 0, 0)， 或者 rgb(100%, 0, 0)。</p>
<p>如果需要使用函数来表示带不透明度的颜色值，值的范围是 0~1 及其之间的小数或者 0%~100%，比如带 67% 不透明度的红色是 rgba(255, 0, 0, 0.67) 或者 rgba(100%, 0%, 0%, 67%)</p>
<blockquote>
<p>“</p>
<p>需要注意的是 RGB 这 3 个颜色值需要保持一致的写法，要嘛用数字要嘛用百分比，而不透明度的值的可以不用和 RGB 保持一致写法。比如 rgb(100%, 0, 0) 这个写法是无效的；而 rgb(100%, 0%, 0%, 0.67) 是有效的。</p>
</blockquote>
<p>在第 4 代 CSS 颜色标准中，新增了一种新的函数写法，即可以把 RGB 中值的分隔逗号改成空格，而把 RGB 和 alpha 中的逗号改成 /，比如带 67% 不透明度的红色可以这样写 rgba(255 0 0 / 0.67)。另外还把 rgba 的写法合并到 rgb 函数中了，即 rgb 可以直接写带不透明度的颜色。</p>
<h4 id="HSL-A-颜色">HSL[A] 颜色</h4>
<p>HSL[A] 颜色是由色相(hue)-饱和度(saturation)-亮度(lightness)-不透明度组成的颜色体系。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912160701.png" alt=""></p>
<ul>
<li>
<p>色相（H）是色彩的基本属性，值范围是 0~360 或者 0deg~360deg， 0 (或 360) 为红色, 120 为绿色, 240 为蓝色；</p>
</li>
<li>
<p>饱和度（S）是指色彩的纯度，越高色彩越纯，低则逐渐变灰，取 0~100% 的数值；0% 为灰色， 100% 全色；</p>
</li>
<li>
<p>亮度（L），取 0~100%，0% 为暗，100% 为白；</p>
</li>
<li>
<p>不透明度（A），取 0<sub>100%，或者0</sub>1及之间的小数；</p>
</li>
</ul>
<p>写法上可以参考 RGB 的写法，只是参数的值不一样。</p>
<p>给一个按钮设置不透明度为 67% 的红色的 color 的写法，以下全部写法效果一致：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span>  
    <span class="token property">color</span><span class="token punctuation">:</span> #ff0000aa<span class="token punctuation">;</span>  
    <span class="token property">color</span><span class="token punctuation">:</span> #f00a<span class="token punctuation">;</span>  
    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.67<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">rgb</span><span class="token punctuation">(</span>100% 0% 0% / 67%<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">hsla</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 100%<span class="token punctuation">,</span> 50%<span class="token punctuation">,</span> 67%<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">hsl</span><span class="token punctuation">(</span>0deg 100% 50% / 67%<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>小提示：在 Chrome DevTools 中可以按住 shift + 鼠标左键可以切换颜色的表示方式。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912160642.gif" alt=""></p>
<h3 id="媒体查询">媒体查询</h3>
<p>媒体查询是指针对不同的设备、特定的设备特征或者参数进行定制化的修改网站的样式。</p>
<p>你可以通过给 <code>&lt;link&gt;</code> 加上 media 属性来指定该样式文件只能对什么设备生效，不指定的话默认是 all，即对所有设备都生效：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css">&lt;link rel=<span class="token string">"stylesheet"</span> src=<span class="token string">"styles.css"</span> media=<span class="token string">"screen"</span> /&gt;  
&lt;link rel=<span class="token string">"stylesheet"</span> src=<span class="token string">"styles.css"</span> media=<span class="token string">"print"</span> /&gt;  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>都支持哪些设备类型？</p>
<ul>
<li>
<p>all：适用于所有设备；</p>
</li>
<li>
<p>print：适用于在打印预览模式下在屏幕上查看的分页材料和文档；</p>
</li>
<li>
<p>screen：主要用于屏幕；</p>
</li>
<li>
<p>speech：主要用于语音合成器。</p>
</li>
</ul>
<blockquote>
<p>需要注意的是：通过 media 指定的  资源尽管不匹配它的设备类型，但是浏览器依然会加载它。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155838.png" alt=""></p>
<p>除了通过 <code>&lt;link&gt;</code> 让指定设备生效外，还可以通过 <code>@media</code> 让 CSS 规则在特定的条件下才能生效。响应式页面就是使用了 @media 才让一个页面能够同时适配 PC、Pad 和手机端。</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token atrule"><span class="token rule">@media</span> <span class="token punctuation">(</span><span class="token property">min-width</span><span class="token punctuation">:</span> 1000px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>媒体查询支持逻辑操作符：</p>
<ul>
<li>
<p>and：查询条件都满足的时候才生效；</p>
</li>
<li>
<p>not：查询条件取反；</p>
</li>
<li>
<p>only：整个查询匹配的时候才生效，常用语兼容旧浏览器，使用时候必须指定媒体类型；</p>
</li>
<li>
<p>逗号或者 or：查询条件满足一项即可匹配；</p>
</li>
</ul>
<p>媒体查询还支持众多的媒体特性[14]，使得它可以写出很复杂的查询条件：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* 用户设备的最小高度为680px或为纵向模式的屏幕设备 */</span>  
<span class="token atrule"><span class="token rule">@media</span> <span class="token punctuation">(</span><span class="token property">min-height</span><span class="token punctuation">:</span> 680px<span class="token punctuation">)</span><span class="token punctuation">,</span> screen <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token property">orientation</span><span class="token punctuation">:</span> portrait<span class="token punctuation">)</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="常见需求">常见需求</h2>
<h3 id="自定义属性">自定义属性</h3>
<p>之前我们通常是在预处理器里才可以使用变量，而现在 CSS 里也支持了变量的用法。通过自定义属性就可以在想要使用的地方引用它。</p>
<p>自定义属性也和普通属性一样具有级联性，申明在 :root 下的时候，在全文档范围内可用，而如果是在某个元素下申明自定义属性，则只能在它及它的子元素下才可以使用。</p>
<p>自定义属性必须通过 <code>--x</code> 的格式申明，比如：--theme-color: red; 使用自定义属性的时候，需要用 var 函数。比如：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">&lt;!-- 定义自定义属性 --&gt;  
:root</span> <span class="token punctuation">{</span>  
    <span class="token property">--theme-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

<span class="token selector">&lt;!-- 使用变量 --&gt;  
h1</span> <span class="token punctuation">{</span>  
    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--theme-color<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155818.png" alt=""></p>
<p>上图这个是使用 CSS 自定义属性配合 JS 实现的动态调整元素的 box-shadow，具体可以看这个 codepen demo。</p>
<h3 id="1px-边框解决方案">1px 边框解决方案</h3>
<p>Retina 显示屏比普通的屏幕有着更高的分辨率，所以在移动端的 1px 边框就会看起来比较粗，为了美观通常需要把这个线条细化处理。这里有篇文章列举了 7 中方案可以参考一下：7种方法解决移动端Retina屏幕1px边框问题[15]</p>
<p>而这里附上最后一种通过伪类和 transform 实现的相对完美的解决方案：</p>
<p>只设置单条底部边框：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.scale-1px-bottom</span> <span class="token punctuation">{</span>  
    <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>  
    <span class="token property">border</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token selector">.scale-1px-bottom::after</span> <span class="token punctuation">{</span>  
    <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">;</span>  
    <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>  
    <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>  
    <span class="token property">bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>  
    <span class="token property">background</span><span class="token punctuation">:</span> #000<span class="token punctuation">;</span>  
    <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>  
    <span class="token property">height</span><span class="token punctuation">:</span> 1px<span class="token punctuation">;</span>  
    <span class="token property">-webkit-transform</span><span class="token punctuation">:</span> <span class="token function">scaleY</span><span class="token punctuation">(</span>0.5<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">scaleY</span><span class="token punctuation">(</span>0.5<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token property">-webkit-transform-origin</span><span class="token punctuation">:</span> 0 0<span class="token punctuation">;</span>  
    <span class="token property">transform-origin</span><span class="token punctuation">:</span> 0 0<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时设置 4 条边框：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.scale-1px</span> <span class="token punctuation">{</span>  
    <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>  
    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>  
    <span class="token property">border</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token selector">.scale-1px::after</span> <span class="token punctuation">{</span>  
    <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">;</span>  
    <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>  
    <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>  
    <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>  
    <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #000<span class="token punctuation">;</span>  
    <span class="token property">-webkit-box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>  
    <span class="token property">box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>  
    <span class="token property">width</span><span class="token punctuation">:</span> 200%<span class="token punctuation">;</span>  
    <span class="token property">height</span><span class="token punctuation">:</span> 200%<span class="token punctuation">;</span>  
    <span class="token property">-webkit-transform</span><span class="token punctuation">:</span> <span class="token function">scale</span><span class="token punctuation">(</span>0.5<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">scale</span><span class="token punctuation">(</span>0.5<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token property">-webkit-transform-origin</span><span class="token punctuation">:</span> left top<span class="token punctuation">;</span>  
    <span class="token property">transform-origin</span><span class="token punctuation">:</span> left top<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="清除浮动">清除浮动</h3>
<p>什么是浮动：浮动元素会脱离文档流并向左/向右浮动，直到碰到父元素或者另一个浮动元素。</p>
<p>为什么要清楚浮动，它造成了什么问题？</p>
<p>因为浮动元素会脱离正常的文档流，并不会占据文档流的位置，所以如果一个父元素下面都是浮动元素，那么这个父元素就无法被浮动元素所撑开，这样一来父元素就丢失了高度，这就是所谓的浮动造成的父元素高度坍塌问题。</p>
<p>父元素高度一旦坍塌将对后面的元素布局造成影响，为了解决这个问题，所以需要清除浮动，让父元素恢复高度，那该如何做呢？</p>
<p>这里介绍两种方法：通过 BFC 来清除、通过 clear 来清除。</p>
<h4 id="BFC-清除浮动">BFC 清除浮动</h4>
<p>前面介绍 BFC 的时候提到过，计算 BFC 高度的时候浮动子元素的高度也将计算在内，利用这条规则就可以清楚浮动。</p>
<p>假设一个父元素 parent 内部只有 2 个子元素 child，且它们都是左浮动的，这个时候 parent 如果没有设置高度的话，因为浮动造成了高度坍塌，所以 parent 的高度会是 0，此时只要给 parent 创造一个 BFC，那它的高度就能恢复了。</p>
<p>而产生 BFC 的方式很多，我们可以给父元素设置overflow: auto 来简单的实现 BFC 清除浮动，但是为了兼容 IE 最好用 overflow: hidden。</p>
<pre class="line-numbers language-none"><code class="language-none">.parent {  
    overflow: hidden;  
}  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>通过 overflow: hidden 来清除浮动并不完美，当元素有阴影或存在下拉菜单的时候会被截断，所以该方法使用比较局限。</p>
<h4 id="通过-clear-清除浮动">通过 clear 清除浮动</h4>
<p>我先把结论贴出来：</p>
<pre class="line-numbers language-none"><code class="language-none">.clearfix {  
    zoom: 1;  
}  
.clearfix::after {  
    content: "";  
    display: block;  
    clear: both;  
}  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这种写法的核心原理就是通过 ::after 伪元素为在父元素的最后一个子元素后面生成一个内容为空的块级元素，然后通过 clear 将这个伪元素移动到所有它之前的浮动元素的后面，画个图来理解一下。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155806.png" alt=""></p>
<p>可以结合这个 codepen demo 一起理解上图的 clear 清楚浮动原理。</p>
<p>上面这个 demo 或者图里为了展示需要所以给伪元素的内容设置为了 ::after，实际使用的时候需要设置为空字符串，让它的高度为 0，从而父元素的高度都是由实际的子元素撑开。</p>
<p>该方式基本上是现在人人都在用的清除浮动的方案，非常通用。</p>
<p>参考：CSS中的浮动和清除浮动，梳理一下[16]</p>
<h3 id="消除浏览器默认样式">消除浏览器默认样式</h3>
<p>针对同一个类型的 HTML 标签，不同的浏览器往往有不同的表现，所以在网站制作的时候，开发者通常都是需要将这些浏览器的默认样式清除，让网页在不同的浏览器上能够保持一致。</p>
<p>针对清除浏览器默认样式这件事，在很早之前 CSS 大师 Eric A. Meyer 就干过。它就是写一堆通用的样式用来重置浏览器默认样式，这些样式通常会放到一个命名为 reset.css 文件中。比如大师的 reset.css[17] 是这么写的：</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">html, body, div, span, applet, object, iframe,  
h1, h2, h3, h4, h5, h6, p, blockquote, pre,  
a, abbr, acronym, address, big, cite, code,  
del, dfn, em, img, ins, kbd, q, s, samp,  
small, strike, strong, sub, sup, tt, var,  
b, u, i, center,  
dl, dt, dd, ol, ul, li,  
fieldset, form, label, legend,  
table, caption, tbody, tfoot, thead, tr, th, td,  
article, aside, canvas, details, embed,   
figure, figcaption, footer, header, hgroup,   
menu, nav, output, ruby, section, summary,  
time, mark, audio, video</span> <span class="token punctuation">{</span>  
    <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>  
    <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>  
    <span class="token property">border</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>  
    <span class="token property">font-size</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>  
    <span class="token property">font</span><span class="token punctuation">:</span> inherit<span class="token punctuation">;</span>  
    <span class="token property">vertical-align</span><span class="token punctuation">:</span> baseline<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token comment">/* HTML5 display-role reset for older browsers */</span>  
<span class="token selector">article, aside, details, figcaption, figure,   
footer, header, hgroup, menu, nav, section</span> <span class="token punctuation">{</span>  
    <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token selector">body</span> <span class="token punctuation">{</span>  
    <span class="token property">line-height</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token selector">ol, ul</span> <span class="token punctuation">{</span>  
    <span class="token property">list-style</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token selector">blockquote, q</span> <span class="token punctuation">{</span>  
    <span class="token property">quotes</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token selector">blockquote:before, blockquote:after,  
q:before, q:after</span> <span class="token punctuation">{</span>  
    <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">;</span>  
    <span class="token property">content</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token selector">table</span> <span class="token punctuation">{</span>  
    <span class="token property">border-collapse</span><span class="token punctuation">:</span> collapse<span class="token punctuation">;</span>  
    <span class="token property">border-spacing</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>他的这份 reset.css 据说是被使用最广泛的重设样式的方案了。</p>
<p>除了 reset.css 外，后来又出现了 Normalize.css[18] 。关于 Normalize.css, 其作者 necolas 专门写了一篇文章介绍了它，并谈到了它和 reset.css 的区别。这个是他写那篇文章的翻译版：让我们谈一谈 Normalize.css[19]。</p>
<p>文章介绍到：Normalize.css 只是一个很小的CSS文件，但它在默认的 HTML 元素样式上提供了跨浏览器的高度一致性。相比于传统的 CSS reset，Normalize.css 是一种现代的、为 HTML5 准备的优质替代方案，现在已经有很多知名的框架和网站在使用它了。</p>
<p>Normalize.css 的具体样式可以看这里 Normalize.css</p>
<p>区别于 reset.css，Normalize.css 有如下特点：</p>
<ul>
<li>
<p>reset.css 几乎为所有标签都设置了默认样式，而 Normalize.css 则是有选择性的保护了部分有价值的默认值；</p>
</li>
<li>
<p>修复了很多浏览器的 bug，而这是 reset.css 没做到的；</p>
</li>
<li>
<p>不会让你的调试工具变的杂乱，相反 reset.css 由于设置了很多默认值，所以在浏览器调试工具中往往会看到一大堆的继承样式，显得很杂乱；</p>
</li>
<li>
<p>Normalize.css 是模块化的，所以可以选择性的去掉永远不会用到的部分，比如表单的一般化；</p>
</li>
<li>
<p>Normalize.css 有详细的说明文档；</p>
</li>
</ul>
<h3 id="长文本处理">长文本处理</h3>
<p><strong>默认：字符太长溢出了容器</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155744.png" alt=""></p>
<p><strong>字符超出部分换行</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914005529.png" alt=""></p>
<p><strong>字符超出位置使用连字符</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155738.png" alt=""></p>
<p><strong>单行文本超出省略</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914005537.png" alt=""></p>
<p><strong>多行文本超出省略</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914005552.png" alt=""></p>
<p>查看以上这些方案的示例： codepen demo</p>
<p>有意思的是刚好前两天看到 chokcoco 针对文本溢出也写了一篇文章，主要突出的是对整块的文本溢出处理。啥叫整块文本？比如，下面这种技术标签就是属于整块文本：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155731.png" alt=""></p>
<p>另外他还对 iOS/Safari 做了兼容处理，感兴趣的可以去阅读下：CSS 整块文本溢出省略特性探究[20]。</p>
<h3 id="水平垂直居中">水平垂直居中</h3>
<p>让元素在父元素中呈现出水平垂直居中的形态，无非就 2 种情况：</p>
<ul>
<li>
<p>单行的文本、inline 或者 inline-block 元素；</p>
</li>
<li>
<p>固定宽高的块级盒子；</p>
</li>
<li>
<p>不固定宽高的块级盒子；</p>
</li>
</ul>
<p>以下列到的所有水平垂直居中方案这里写了个 codepen demo，配合示例阅读效果更佳。</p>
<h4 id="单行的文本、inline-或-inline-block-元素">单行的文本、inline 或 inline-block 元素</h4>
<p><strong>水平居中</strong></p>
<p>此类元素需要水平居中，则父级元素必须是块级元素(<code>block level</code>)，且父级元素上需要这样设置样式：</p>
<pre class="line-numbers language-none"><code class="language-none">.parent {  
    text-align: center;  
}  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>垂直居中</strong></p>
<p>方法一：通过设置上下内间距一致达到垂直居中的效果：</p>
<pre class="line-numbers language-none"><code class="language-none">.single-line {  
    padding-top: 10px;  
    padding-bottom: 10px;  
}  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>方法二：通过设置 <code>height</code> 和 <code>line-height</code> 一致达到垂直居中：</p>
<pre class="line-numbers language-none"><code class="language-none">.single-line {  
    height: 100px;  
    line-height: 100px;  
}  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="固定宽高的块级盒子">固定宽高的块级盒子</h4>
<p><strong>方法一：absolute + 负 margin</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914005614.png" alt=""></p>
<p><strong>方法二：absolute + margin auto</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155724.png" alt=""></p>
<p><strong>方法三：absolute + calc</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914005620.png" alt=""></p>
<h4 id="不固定宽高的块级盒子">不固定宽高的块级盒子</h4>
<p>这里列了 6 种方法，参考了颜海镜 写的文章 ，其中的两种 line-height 和 writing-mode 方案看后让我惊呼：还有这种操作？学到了学到了。</p>
<p><strong>方法一：absolute + transform</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155717.png" alt=""></p>
<p><strong>方法二：line-height + vertical-align</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914005627.png" alt=""></p>
<p><strong>方法三：writing-mode</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914005633.png" alt=""></p>
<p><strong>方法四：table-cell</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914005634.png" alt=""></p>
<p><strong>方法五：flex</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155710.png" alt=""></p>
<p><strong>方法六：grid</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155704.png" alt=""></p>
<h3 id="常用布局">常用布局</h3>
<h4 id="两栏布局（边栏定宽主栏自适应）">两栏布局（边栏定宽主栏自适应）</h4>
<p>针对以下这些方案写了几个示例： codepen demo</p>
<p><strong>方法一：float + overflow（BFC 原理）</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914005646.png" alt=""></p>
<p><strong>方法二：float + margin</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155657.png" alt=""></p>
<p><strong>方法三：flex</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914005701.png" alt=""></p>
<p><strong>方法四：grid</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155650.png" alt=""></p>
<h4 id="三栏布局（两侧栏定宽主栏自适应）">三栏布局（两侧栏定宽主栏自适应）</h4>
<p>针对以下这些方案写了几个示例： codepen demo</p>
<p><strong>方法一：圣杯布局</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155616.png" alt=""></p>
<p><strong>方法二：双飞翼布局</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155643.png" alt=""></p>
<p><strong>方法三：float + overflow（BFC 原理）</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155556.png" alt=""></p>
<p><strong>方法四：flex</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155633.png" alt=""></p>
<p><strong>方法五：grid</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155549.png" alt=""></p>
<h4 id="多列等高布局">多列等高布局</h4>
<p>结合示例阅读更佳：codepen demo</p>
<p><strong>方法一：padding + 负margin</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1420210914005719.png" alt=""></p>
<p><strong>方法二：设置父级背景图片</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155542.png" alt=""></p>
<h4 id="三行布局（头尾定高主栏自适应）">三行布局（头尾定高主栏自适应）</h4>
<p>列了 4 种方法，都是基于如下的 HTML 和 CSS 的，结合示例阅读效果更佳：codepen demo</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css">&lt;div class=<span class="token string">"layout"</span>&gt;  
    &lt;header&gt;&lt;/header&gt;  
    &lt;main&gt;  
        &lt;div class=<span class="token string">"inner"</span>&gt;&lt;/div&gt;  
    &lt;/main&gt;  
    &lt;footer&gt;&lt;/footer&gt;  
&lt;/div&gt;  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">html,  
body,  
.layout</span> <span class="token punctuation">{</span>  
    <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token selector">body</span> <span class="token punctuation">{</span>  
    <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token selector">header,   
footer</span> <span class="token punctuation">{</span>  
    <span class="token property">height</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token selector">main</span> <span class="token punctuation">{</span>  
    <span class="token property">overflow-y</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>方法一：calc</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155519.png" alt=""></p>
<p><strong>方法二：absolute</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155509.png" alt=""></p>
<p><strong>方法三：flex</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155502.png" alt=""></p>
<p><strong>方法四：grid</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1220210912155500.png" alt=""></p>
<h2 id="结了个尾">结了个尾</h2>
<p>这是我断断续续写了 2 周完成的文章，算是自己对 CSS 的一个总结，虽然写得很长，但不足以覆盖所有 CSS 的知识，比如动画和一些 CSS3 的新特性就完全没涉及，因为这要写下来估计得有大几万字（其实就是懒 😝 ）。</p>
<p>码字作图不易，如果喜欢或者对你有丝毫帮助的话，帮忙点个👍 哈，点赞就是我的动力。同时也希望自己能坚持认真的写下去，因为在总结提升自己的同时如果也能帮助更多的前端er，那将会让我感觉很开心。</p>
<h3 id="参考资料">参考资料</h3>
<p>[1]@charset: <em>https://developer.mozilla.org/zh-CN/docs/Web/CSS/@charset</em></p>
<p>[2]Byte order mark: <em>https://en.wikipedia.org/wiki/Byte_order_mark</em></p>
<p>[3]@import: <em>https://developer.mozilla.org/zh-CN/docs/Web/CSS/@import</em></p>
<p>[4]@supports: <em>https://developer.mozilla.org/zh-CN/docs/Web/CSS/@supports</em></p>
<p>[5]MDN CSS Selectors: <em>https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_Selectors</em></p>
<p>[6]Visual formatting model: <em>https://www.w3.org/TR/CSS2/visuren.html</em></p>
<p>[7]CSS 原理 - 你所不知道的 display: <em>https://yachen168.github.io/article/display.html</em></p>
<p>[8]格式化上下文: <em>https://ithelp.ithome.com.tw/articles/10223896?sc=pt</em></p>
<p>[9]CSS 原理 - Formatting Context: <em>https://yachen168.github.io/article/Formatting-context.html</em></p>
<p>[10]Inline formatting contexts: <em>https://www.w3.org/TR/CSS2/visuren.html#inline-formatting</em></p>
<p>[11]彻底搞懂CSS层叠上下文、层叠等级、层叠顺序、z-index: <em>https://juejin.cn/post/6844903667175260174</em></p>
<p>[12]CSS 颜色草案: <em>https://drafts.csswg.org/css-color-3/</em></p>
<p>[13]完整的色彩关键字列表: <em>https://codepen.io/bulandent/pen/gOLovwL</em></p>
<p>[14]众多的媒体特性: <em>https://developer.mozilla.org/zh-CN/docs/Web/Guide/CSS/Media_queries#%E5%AA%92%E4%BD%93%E7%89%B9%E6%80%A7</em></p>
<p>[15]7种方法解决移动端Retina屏幕1px边框问题: <em>https://www.jianshu.com/p/7e63f5a32636</em></p>
<p>[16]CSS中的浮动和清除浮动，梳理一下: <em>https://www.jianshu.com/p/09bd5873bed4</em></p>
<p>[17]reset.css: <em>https://meyerweb.com/eric/tools/css/reset/</em></p>
<p>[18]Normalize.css: <em>https://github.com/necolas/normalize.css</em></p>
<p>[19]让我们谈一谈 Normalize.css: <em>https://jerryzou.com/posts/aboutNormalizeCss/</em></p>
<p>[20]CSS 整块文本溢出省略特性探究: <em>https://juejin.cn/post/6938583040469762055</em></p>
<p>From <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/UtYENocSsl0R10h8fww7Iw">https://mp.weixin.qq.com/s/UtYENocSsl0R10h8fww7Iw</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>web</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>http</tag>
        <tag>ccs</tag>
      </tags>
  </entry>
  <entry>
    <title>Vim IDE Docker 以及中文指南</title>
    <url>/posts/647e6265/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>Docker Vim IDE 由博主定制，加入中文环境配置，支持CJK。并升级到最新版本！</p>
</blockquote>
<h2 id="Vim-Docker"><a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/vim">Vim Docker</a></h2>
<p><img src="https://i.imgur.com/G6KybVM.png" alt="Vim Docker"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> pull bloodstar/vim<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">edit</span><span class="token operator">=</span><span class="token string">'docker run -ti --rm -v $(pwd):/home/developer/workspace bloodstar/vim'</span> 
edit some.file 
<span class="token builtin class-name">alias</span> <span class="token assign-left variable">edit_update</span><span class="token operator">=</span><span class="token string">"docker pull bloodstar/vim:latest"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="Vim-IDE-Docker"><a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/drop-in">Vim IDE Docker</a></h2>
<p><img src="https://i.imgur.com/RVTlBBO.png" alt="drop-in"></p>
<h4 id="What-s-inside">What's inside:</h4>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.alpinelinux.org/"><code>Alpine Linux</code></a></li>
<li><a target="_blank" rel="noopener" href="http://www.vim.org/"><code>Vim</code></a> + a ton of awesome plugins <em>see <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/vim/"><code>bloodstar/vim:latest</code></a></em></li>
<li>Good support of <a target="_blank" rel="noopener" href="https://golang.org/"><code>Golang</code></a> development with <a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/go-tools/"><code>bloodstar/go-tools</code></a> container</li>
<li><a target="_blank" rel="noopener" href="https://tmux.github.io/"><code>tmux</code></a></li>
<li><a target="_blank" rel="noopener" href="https://powerline.readthedocs.io/"><code>powerline</code></a></li>
<li><a target="_blank" rel="noopener" href="https://mosh.mit.edu/"><code>Mosh</code></a></li>
<li>OpenSSH, Bash, OMF, Python, etc.</li>
</ul>
<h4 id="how-to-start-the-daemon-and-all-containers">how to start the daemon(and all containers)</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> create -v <span class="token string">'/usr/lib/go'</span> --name go-tools <span class="token punctuation">\</span>
<span class="token string">'bloodstar/go-tools'</span> <span class="token string">'/bin/true'</span>

<span class="token function">docker</span> run -v <span class="token variable"><span class="token variable">$(</span>'pwd'<span class="token variable">)</span></span>:/home/developer/workspace <span class="token punctuation">\</span>
--volumes-from go-tools <span class="token punctuation">\</span>
-v ~/.ssh/pub_rsa:/etc/ssh_keys:ro <span class="token punctuation">\</span>
-v /etc/localtime:/etc/localtime:ro <span class="token punctuation">\</span>
-d -p <span class="token number">80</span>:80 -p <span class="token number">8080</span>:8080 -p <span class="token number">62222</span>:62222 -p <span class="token number">60001</span>:60001/udp <span class="token punctuation">\</span>
--name drop-in bloodstar/drop-in<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em><code>-v /etc/localtime:/etc/localtime:ro</code> - makes tmux display local time</em></p>
<h4 id="how-to-connect">how to connect:</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mosh --ssh<span class="token operator">=</span><span class="token string">"ssh -p 62222"</span> -- developer@$<span class="token operator">&lt;</span>ip<span class="token operator">&gt;</span> tmux -u<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="or-without-host-identity-check">or without host identity check:</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mosh --ssh<span class="token operator">=</span><span class="token string">"ssh -o StrictHostKeyChecking=no -p 62222"</span> -- developer@$<span class="token operator">&lt;</span>ip<span class="token operator">&gt;</span> tmux -u<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="Useful-Bash-scripts">Useful Bash scripts</h4>
<h6 id="Connect"><strong>Connect</strong></h6>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">ip</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> inspect --format <span class="token string">'{{ .NetworkSettings.IPAddress }}'</span> drop-in<span class="token variable">)</span></span>
mosh --ssh<span class="token operator">=</span><span class="token string">"ssh -p 62222"</span> -- developer@<span class="token variable">$ip</span> tmux -u<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h6 id="start-the-daemon-and-all-containers"><strong>start the daemon(and all containers)</strong></h6>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">dtc_id</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> -a -q --filter <span class="token string">'name=vim-go-tools'</span><span class="token variable">)</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token string">"<span class="token variable">${dtc_id}</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
 <span class="token builtin class-name">echo</span> <span class="token string">'vim-go-tools container not found. Creating...'</span>
 <span class="token function">docker</span> create -v <span class="token string">'/usr/lib/go'</span> --name <span class="token string">'vim-go-tools'</span> <span class="token punctuation">\</span>
   <span class="token string">'bloodstar/go-tools'</span> <span class="token string">'/bin/true'</span>
 <span class="token builtin class-name">echo</span> <span class="token string">'Done!'</span>
<span class="token keyword">fi</span>
<span class="token builtin class-name">echo</span> <span class="token string">'starting daemon...'</span>
<span class="token function">docker</span> run -v <span class="token variable"><span class="token variable">$(</span>'pwd'<span class="token variable">)</span></span>:/home/developer/workspace <span class="token punctuation">\</span>
  --volumes-from vim-go-tools <span class="token punctuation">\</span>
  -v ~/.ssh/pub_rsa:/etc/ssh_keys:ro <span class="token punctuation">\</span>
  -v /etc/localtime:/etc/localtime:ro <span class="token punctuation">\</span>
  -e <span class="token string">"GEMAIL=&lt;github email&gt;"</span> <span class="token punctuation">\</span>
  -e <span class="token string">"GNAME=&lt;github name&gt;"</span> <span class="token punctuation">\</span>
  -d -p <span class="token number">80</span>:80 -p <span class="token number">8080</span>:8080 -p <span class="token number">62222</span>:62222 -p <span class="token number">60001</span>:60001/udp <span class="token punctuation">\</span>
  --name drop-in bloodstar/drop-in
<span class="token builtin class-name">echo</span> <span class="token string">'Done!'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Vim-中文快查表-戳这里"><a href="https://blog.17lai.site/cheatsheets/Vim_CN.docset/Contents/Resources/Documents/">Vim 中文快查表</a>   &lt;= 戳这里</h2>
<blockquote>
<p>Tips: 在网页上端导航栏，[快查] =&gt; [更多快查表]，有更多快查表！<br>
快去看看吧。</p>
</blockquote>
<h2 id="Vim">Vim</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/09/1520210915150901.png" alt="vim速查"></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>ide</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>vim</tag>
        <tag>ide</tag>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>解决Thinkpad笔记本喇叭破音问题！</title>
    <url>/posts/c945eae1/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="问题">问题</h2>
<p>主力笔记本笔记本播放音乐再次出现破音，换了几首音乐后问题依旧，前后对比强烈。</p>
<h2 id="分析">分析</h2>
<p>从几年前上一次维修经验来看，应该是喇叭老化破裂了！拆机查看，发现的确事喇叭破裂。</p>
<h2 id="解决方案">解决方案</h2>
<p>如是，网购了一个新喇叭，拆机，换上，完美解决问题！</p>
<p>喇叭施压后，能明显看到断裂痕迹。这样的喇叭音色就会出现明显的破音！如下图所示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/0520211005175831.jpg" alt="喇叭破裂施压图"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/0520211005175843.jpg" alt="喇叭破裂未施压图"></p>
<blockquote>
<p>这已经是这台笔记本第二次出现喇叭破裂问题了！  感觉喇叭材料或者工艺有问题。</p>
<p>型号：Thinkpad T4X0S</p>
</blockquote>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>notebook</category>
      </categories>
      <tags>
        <tag>thinkpad</tag>
        <tag>sound</tag>
        <tag>speaker</tag>
      </tags>
  </entry>
  <entry>
    <title>从文学的角度，分析韩红的《天亮了》</title>
    <url>/posts/cb623532/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="现场MV">现场MV</h2>
<style>.bbplayer{width: 100%; max-width: 850px; margin: auto}</style><div class="bbplayer"><iframe class="bbplayer" id="mmedia-IFJoEbZgMWQUxgAM" src="https://player.bilibili.com/player.html?bvid=BV1B7411p7aD&amp;page=1&amp;high_quality=1&amp;danmaku=true" allowfullscreen="allowfullscreen" scrolling="no" border="0" frameborder="0" framespacing="0" sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts allow-popups"></iframe></div><script> document.getElementById("mmedia-IFJoEbZgMWQUxgAM").style.height=document.getElementById("mmedia-IFJoEbZgMWQUxgAM").scrollWidth*0.76+"px";
    window.onresize = function(){
      document.getElementById("mmedia-IFJoEbZgMWQUxgAM").style.height=document.getElementById("mmedia-IFJoEbZgMWQUxgAM").scrollWidth*0.76+"px";
    }; </script>
<blockquote>
<p>精品分析： 原作：石晶兰 <a target="_blank" rel="noopener" href="https://tieba.baidu.com/p/5313070309?red_tag=2537504175">短文吧</a></p>
<p>再做个传送门： <a target="_blank" rel="noopener" href="https://www.baidu.com/s?ie=UTF-8&amp;wd=%E9%9F%A9%E7%BA%A2%20%E5%A4%A9%E4%BA%AE%E4%BA%86">天亮了</a>，听歌时，关灯，准备纸巾。</p>
</blockquote>
<h2 id="先分析结构。">先分析结构。</h2>
<p>看歌词。</p>
<p>那是一个秋天，风儿那么缠绵，<br>
让我想起他们那双无助的眼。<br>
就在那美丽风景相伴的地方，<br>
我听到一声巨响震彻山谷。<br>
就是那个秋天，再看不到爸爸的脸。<br>
他用他的双肩，托起我重生的起点。<br>
黑暗中泪水沾满了双眼，<br>
不要离开不要伤害。</p>
<p>共八行，等于两个四行。<br>
两个四行一一对应，前三行，旋律基本是相同的。只有最后一行，为了与后面衔接，所以不同。<br>
两个四行的布置，等于是一种重复。<br>
这样的重要，在文学结构上，常见于起承。<br>
但歌，相当于诗。囿于篇幅，在结构上，通常会有所缺失。起承两者，一般缺失的，都是起。那样的做法，也就是直接叙事，存在让受众猝不及防的弊病。<br>
然后，《天亮了》并不是。<br>
“那是一个秋天，风儿那么缠绵”和“就是那个秋天”分明是起。<br>
所以，《天亮了》并没有进行文学结构上的省略。<br>
“那是一个秋天，风儿那么缠绵”是起，接紧着的三行歌词，自然就是承了。<br>
那么，第五行“就是那个秋天”怎么又来一个起呢？<br>
自然是因为篇幅太短，叙事不够（前面承得不够），所以，还需要再承一下。<br>
不能够不要第五行的起，直接往下写吗？<br>
真要说的话，其实也能。不过，再加四行承，真的就能把事情说清楚吗？<br>
显然，韩红想要表达的东西很多，她认为，不能。<br>
仅靠精练语言，明显是不够的，还需要换角度陈述。<br>
第五行的再起，实际上，就是为后面的换角度承，打基础的。<br>
这种写法，也是有先例的。请看邓丽君《相见在明天》歌词：<br>
记得我俩初相见，<br>
风吹花儿飞满天。<br>
你说我的笑容像花朵，<br>
比那花儿更娇艳。<br>
我还记得那一天，<br>
送你送到小河边。<br>
手牵着手呀心里有千言，<br>
相对却无言。<br>
跟《天亮了》一样，《相见在明天》也是两个四行，也是起承起承。<br>
并且，两起两承，还跟诗词的押韵一样，其重复，不仅有加深印象的作用，更有共鸣回旋的作用，正是唐陈子昂所说的“音情顿挫”的顿挫，极大的提升了作品的美感，让受众的接受度大大提高，</p>
<h2 id="继续看《天亮了》歌词：">继续看《天亮了》歌词：</h2>
<p>我看到爸爸妈妈就这么走远，<br>
留下我在这陌生的人世间。<br>
不知道未来还会有什么风险。<br>
我想要紧紧抓住他的手。<br>
妈妈告诉我希望还会有。<br>
看到太阳出来妈妈笑了。<br>
天亮了。</p>
<p>六行都是转。具体在这里，自然不是转折，而是高那个潮。</p>
<p>此处值得一说的是合，只有三个字“天亮了”。<br>
这三个字，正好也是这首歌的歌名。<br>
但是这三个字表达的，到底是什么意思、什么情感呢？</p>
<p>题都城南庄/唐/崔护<br>
去年今日此门中，人面桃花相映红。<br>
人面不知何处去，桃花依旧笑春风。</p>
<p>不难看出，最后一句“桃花依旧笑春风”跟前面三句的叙述，是接不上的。<br>
去年这儿，有人面有桃花。今年这儿人面没有了，接下来说的通常是：还真是让人怀念啊。<br>
俗吗？的确俗。并且，还不仅仅是俗，还存在因为什么而怀念那个姑娘的严重问题。<br>
动机不纯的话，写出来就会玷污那个姑娘。动机纯粹，只是单纯的对美好事物的欣赏，写出来的话，又有自夸之嫌。<br>
还真是不好写啊。<br>
不好写，干脆就不写，另起一笔：“桃花依旧笑春风”。究竟表达的是什么样的滋味，让受众自己去想。</p>
<p>《天亮了》末尾的合“天亮了”，就是“桃花依旧笑春风”这种表现手法。太多的感情，千言万语，加总在一起，实在难以挽上疙瘩。于是，就另起一行，来了句看似关系不大的“天亮了”，让一切，尽在无言中。<br>
不同的受众，会有不同的感受。因而这种让受众自己去想的结尾，总是余味无穷。</p>
<p>文学结构分析，就到这儿。第二段的结构跟第一段相同，就不讲了。</p>
<h2 id="下面进行逐句评讲。">下面进行逐句评讲。</h2>
<p>“那是一个秋天，风儿那么缠绵，”没毛病。“那是”开头，虽然不出彩，但是很自然，容易被人接受，接着往下听。<br>
“让我想起他们那双无助的眼。”这里，“他们”是两个人；“那双”眼睛虽然是复数，但落实到人，却是单数。因此，这是一个小错误。<br>
很显然，用相同性质的词语直接替换是不行的，譬如“四只”。四，数量较多，会分散受众的注意力，让受众去思考为什么是四。因而，如果硬要改的话，只能用其它性质的词语去替换，譬如“彷徨”。<br>
但“彷徨无助”，又稍显生僻，会影响听者的接受速度，形成不怎么大的接受障碍。而如果也用“无”的话，无什么呢？无神？听上去，岂不是比“彷徨无助”更不容易分辨。<br>
所以，实在要改，就只能把“他们”二字挪到这儿。<br>
那样一来，“让我想起”就要掺进两个水字了，譬如“风儿让我想起”。<br>
是不是太水了？<br>
于是，我最终感觉，还是不改为好。<br>
小错误嘛，存在也无妨。这就像文豪写书法一样，多一点少一点，多一笔少一笑，根本不算错误，关键是，那个字不能被错认为是别的字。<br>
“那双无助的眼”也一样，虽然存在小错误，但由于不影响表达内容，听者一听，就知道是怎么回事。由于没有影响信息传递，所以不改也是行的。</p>
<p>“就在那美丽风景相伴的地方，我听到一声巨响震彻山谷。”这两小句，没有基础毛病。<br>
值得注意的是，这两小句，存在一个对比：一个美丽的地方，一件悲惨的事。颇有一种把美好的事情撕烂了给读者看的悲剧色彩。</p>
<p>“就是那个秋天，再看不到爸爸的脸。”<br>
为什么提到爸爸没提到妈妈？爸爸妈妈，可以一起提，也可以先后提。这里，实际上是先后提。先提爸爸，后面会提到妈妈。<br>
先提爸爸，又比先提妈妈要好。这是因为，时至今日，最不令人怀疑的，是父女情。虽然背景事件中，那是个儿子，但韩红是女的，唱出来的声音又带有明显的女性特征。女声，提到爸爸，无形中，就相当于女儿提到爸爸。其中的感情，就往父女情的方向靠近了那么一点，让听者一下就能接受，丝毫没有怀疑。<br>
“他用他的双肩，托起我重生的起点。”<br>
背景事件的具体经过，可能生还的当事人都已经记不清楚了。这一句，属于带有归纳性、比拟性的描述。因而不需要因为“用”“双肩托起”，去询问是不是父亲从洪水中救起了儿子那样的细节。<br>
“黑暗中泪水沾满了双眼，”<br>
“黑暗中”很妙。只描述了环境，没有指明时间。那其实表达的是，若干个“黑暗中”。包括当时，也包括事后。并且，“黑暗”有天然的，也有人为的。天然的，譬如天黑加停电；人为的，譬如钻进被窝里。这些，都被包括了进去。<br>
“不要离开、不要伤害。”这句，就有些难度了。<br>
“不要离开”好理解。可以是儿子对父母的呼唤。但“不要伤害”呢？<br>
“不要伤害”，到底是谁对谁发出的呐喊，后面再讲。</p>
<p>“我看到爸爸妈妈就这么走远，留下我在这陌生的人世间。不知道未来还会有什么风险。”<br>
三小句，基础上没毛病。直接看上去，字面意思表达能力似乎稍弱。真是不是，后面再说。<br>
“我想要紧紧抓住他的手”中的“他”，指父亲，也可以指母亲。<br>
“妈妈告诉我希望还会有。看到太阳出来妈妈笑了。”这是绝望中的回忆。这一家人，以前也是经受过苦难的。在曾经难熬的岁月中，妈妈曾经多次鼓励过儿子。鼓励的时候，有直述“告诉我希望还会有”，也有以身作则“看到太阳出来，妈妈笑了”。</p>
<p>“天亮了。”尽在不言中，就不再讲了。</p>
<p>“这是一个夜晚天上宿星点点，我在梦里看见我的妈妈。”<br>
继“那是”之后，此处出现了“这是”。表示已经是事后，灾难之后。<br>
“一个人在世上要学会坚强”，很明显，这不是儿子对父母能够说出的话。<br>
结合前一小句“我在梦里看见我的妈妈”，可以发现，这是妈妈对儿子说的话。并且还是死去之后的妈妈对儿子所说的话。<br>
“我在梦里看见我的妈妈。一个人在世上要学会坚强”紧接着的两句，主语变了。前一句是“我”，后一句是“妈妈”。同时，又因为死去的人继续说话这一违反科学常理的设定，使得后一句主语“妈妈”变得有些难以理解。<br>
其实，受众的心，也是强大的。多听两遍，也还是能够理解的。<br>
这两句主语的变化，从玄学的角度看，简单。但从文学的角度看，跳跃就非常大了。</p>
<p>唐/李白有句：“千里江陵一日还”。“千里江陵”说的是千里之外的江陵。站在什么地方能够说出此话，自然是白帝城。“还”，指回来，站在什么地方能够说“还”，当然只能是江陵。就这么一句，视角就从白帝城跳到了江陵。<br>
《天亮了》中，这两句紧挨着的歌词的主语跳跃，其实跟“千里江陵一日还”的视角跳跃，是相似的类型。</p>
<p>“你不要离开不要伤害”上一段出现过，就不讲了。</p>
<p>“我看到爸爸妈妈就这么走远，留下我在这陌生的人世间。我愿为他建造一个美丽的花园。”<br>
比较上一段，区别的，是第三小句。此处的第三小句，从陈述中跳脱出来了，相当于插入了一个事后的心愿。</p>
<p>“我想要紧紧抓住他的手。妈妈告诉我希望还会有，看到太阳出来、天亮了。”<br>
比较上一段，区别的仍然是第三小句。“妈妈笑了”变成“天亮了”。但此处的“天亮了”，跟前面不一样，并不是起承转合的合，不是收尾，而就是一个简单的陈述，其实质，就相当于“妈妈笑了”。</p>
<p>“我看到爸爸妈妈就这么走远，留下我在这陌生的人世间。我愿为他建造一个美丽的花园。<br>
“我想要紧紧抓住他的手。妈妈告诉我希望还会有。看到太阳出来，他们笑了。”<br>
重复，强调，加倍。略有不同的，就是“妈妈笑了”变成“他们笑了”。由“妈妈”变成“他们”，实际上也在告诉受众，马上就要收尾了。<br>
以什么收尾，收到哪里呢？依然还是“天亮了”，尽在不言中，让受众自己去想，</p>
<p>不知道是哪年哪天了，无意中，我就这么偶然听到了这首歌。<br>
一听，就感受很好听。<br>
一听，就听出来了，里面讲述了一场事故。因为有“我听到一声巨响震彻山谷”、“再看不到爸爸的脸”。<br>
另外，还听出了事故中，父母对孩子的救助。因为有“他用他的双肩托起我重生的起点”。<br>
很明显，事故是悲惨的，事故中的父母是可歌可泣的，事故之后的儿子或女儿（从歌词中听不出孩子的性别）是可怜的。<br>
但是，就这么算了么？<br>
这么好听的歌，最后一句“天亮了”到底表述的是怎样的感情？<br>
没弄清楚，怎么能算完。</p>
<p>生活中，有各种各样的事故。最常见的，恐怕应该是车祸。<br>
车祸事故，几乎每天都能够在地方新闻上看到。<br>
看到车祸事故的新闻，心中有什么感受？<br>
悲伤么？自然没有。<br>
一般来说，亲人，才会悲伤。陌生人，通常只是略带同情、怜悯。<br>
此处说的是，同样的事，因为自身角度的不同，感受大不相同。<br>
那么，《天亮了》应该站在什么样的角度去欣赏呢？</p>
<p>最容易想到的角度，有两个。<br>
一是生还的儿子或女儿。但是，站在这个角度欣赏，“我看到爸爸妈妈就这么走远，留下我在这陌生的人世间，不知道未来还会有什么风险。”真的弱爆了。<br>
另一个角度，则是富有同情心的旁观善良人士。这个角度的存在，是因为韩红。因为，就这么看过去，韩红，对于此次事故，似乎就是富有同情心的旁观善良人士。<br>
但这个角度还是不行。“黑暗中泪水沾满了双眼”，没什么感觉。<br>
于是乎，就剩下了不常见的角度——死去父母的角度！<br>
我试着想象了这样的角度，再听《天亮了》，眼泪一下子就出来了。<br>
我是在这之后，才搜索得知了《天亮了》的创作背景。</p>
<p>是的，韩红，把自己当作那个孩子的父母，并且还把自己当作了孩子死去的父母。《天亮了》这首歌，表达的是死者对生者的寄托！<br>
重新再看歌词。“黑暗中泪水沾满了双眼”，所指的，就不仅仅是事后孩子多次在被窝里痛哭，并且还指死去的父母在地狱中带泪含悲。<br>
“不要离开”，只是孩子对父母的呼唤么？已然不是。以父母为参照物，生存的孩子，又何尝不是一种离开。<br>
当然不是说想要孩子一起死，否则就不会用双肩托起重生的起点了。<br>
“不要伤害”的答案，此时就出来了。那就是死去的父母发出的呐喊。呐喊的对象是天地——老天爷，不要伤害我们的孩子！<br>
“一个人在世上要学会坚强”不再是父母对自己的叮嘱，而是自己，对自己幸存的子女的叮嘱。<br>
于是乎，最后一句合中的“天亮了”，就表达了深深的无奈。<br>
天亮了，通常指清晨，代表的是希望。但是，对于死者来说，天亮了，就代表魂魄状态的死者必须离开。<br>
这是自然规律，死者必须离开。不想离开，也必须离开。因为——天亮了。<br>
难怪韩红唱这三个字的时候，泣不成声。</p>
<p>题外话又冒出来了。<br>
我曾经进行过无数次评论。有那么一个人，曾经对于我的少部分评论非常不服。那就是，关于李白的诗的评论。<br>
他认为，一件事物，可以从好坏两方面去说。他认为，李白的诗，就像打油诗，水平并不高。只是因为我的评论，才变得水平绝高了。<br>
具体的说法就是，我先假定李诗水平绝高，然后往去往绝高的方向分析。<br>
我的确也是这样做的。<br>
但是，别人的诗，也可以假定为水平绝高啊，难道说真的就能分析出水平绝高来吗？<br>
譬如杜甫的“三顾频烦天下计”。“顾频烦”三字的“页”旁，看不见吗？不擅书法，才会视而不见，所以杜甫不擅书法。是“频烦天下计”么？明明就只烦了一次。次数相对较多的，反而是“顾”，顾了三次。于是这句应该读成“三顾频、烦天下计”。这水平还怎么绝高呢？<br>
相似的例子还有很多。无论是谁的作品，都能事先假定为水平绝高。但只有李白的诗，才会真的分析出水平绝高的答案出来。<br>
所以，李诗的水平，是真的绝高。</p>
<p>这番题外话，表达的是，前面关于《天亮了》的评论，或许韩红自己并没那么想，或者韩红没想那么多，或许《天亮了》就仅仅是韩红的偶然之得。<br>
我要说的是，《天亮了》既然已经成为作品，那么它就脱离了作者韩红，变成了一种独立的存在。不能因为韩红的文学水平不够高，而去否认《天亮了》的文学成就。<br>
我的确是抱着欣赏的态度，先假定《天亮了》文学水平很高，然后真往极高文学水平的方向去分析的。但是很幸运，我得出了《天亮了》文学水平果然很高的结论。<br>
换首别的歌，行吗？<br>
谁说行，谁上。</p>
<p>最后，我还要说的是，文学水平，所指的，并不仅仅是文字方面的能力。<br>
在打基础的时候，在斟酌字词句，在训练表达力、说服力的阶段，的确单指文字方面。<br>
但是，在跨入感染力阶段之后，就不是了。<br>
更多的，是提高心性。<br>
心性高了，视角就不同了，感受也随之不同了，不管是写出来的作品，还是唱出来的歌，那都是不同的。<br>
很多人说邓丽君的演唱水平并不高，那是不对的。应该说，邓丽君的演唱水平，其实很多人都达到过。个别的，譬如韩红，偶尔还超越过。<br>
但是，为什么邓丽君流传下来的歌曲就那么多呢？其他歌者流传下来的歌就那么少呢？<br>
就是因为心性。<br>
心性与感染力关系，最容易明白的例子，就是翻唱。<br>
《何日君在来》、《船歌》在邓丽君翻唱之前，并不好听，结果邓丽君一唱，就化腐朽为神奇了。<br>
恰好，韩红也有过化腐朽为神奇的表现，譬如《妹妹找哥泪花流》、《天之大》（可搜）。<br>
心性如此之高的韩红，偶得《天亮了》极高文学水准的作品，就是正常的了。</p>
<p>（全文完）</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>music</category>
      </categories>
      <tags>
        <tag>music</tag>
        <tag>韩红</tag>
      </tags>
  </entry>
  <entry>
    <title>http 错误代码表</title>
    <url>/posts/80906b88/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>所有 HTTP 状态代码及其定义。<br>
　代码&nbsp;&nbsp;指示&nbsp;&nbsp;<br>
2xx&nbsp;&nbsp;成功&nbsp;&nbsp;<br>
200&nbsp;&nbsp;正常；请求已完成。&nbsp;&nbsp;<br>
201&nbsp;&nbsp;正常；紧接 POST 命令。&nbsp;&nbsp;<br>
202&nbsp;&nbsp;正常；已接受用于处理，但处理尚未完成。&nbsp;&nbsp;<br>
203&nbsp;&nbsp;正常；部分信息 — 返回的信息只是一部分。&nbsp;&nbsp;<br>
204&nbsp;&nbsp;正常；无响应 — 已接收请求，但不存在要回送的信息。&nbsp;&nbsp;<br>
3xx&nbsp;&nbsp;重定向&nbsp;&nbsp;<br>
301&nbsp;&nbsp;已移动 — 请求的数据具有新的位置且更改是永久的。&nbsp;&nbsp;<br>
302&nbsp;&nbsp;已找到 — 请求的数据临时具有不同 URI。&nbsp;&nbsp;<br>
303&nbsp;&nbsp;请参阅其它 — 可在另一 URI 下找到对请求的响应，且应使用 GET 方法检索此响应。&nbsp;&nbsp;<br>
304&nbsp;&nbsp;未修改 — 未按预期修改文档。&nbsp;&nbsp;<br>
305&nbsp;&nbsp;使用代理 — 必须通过位置字段中提供的代理来访问请求的资源。&nbsp;&nbsp;<br>
306&nbsp;&nbsp;未使用 — 不再使用；保留此代码以便将来使用。&nbsp;&nbsp;<br>
4xx&nbsp;&nbsp;客户机中出现的错误&nbsp;&nbsp;<br>
400&nbsp;&nbsp;错误请求 — 请求中有语法问题，或不能满足请求。&nbsp;&nbsp;<br>
401&nbsp;&nbsp;未授权 — 未授权客户机访问数据。&nbsp;&nbsp;<br>
402&nbsp;&nbsp;需要付款 — 表示计费系统已有效。&nbsp;&nbsp;<br>
403&nbsp;&nbsp;禁止 — 即使有授权也不需要访问。&nbsp;&nbsp;<br>
404&nbsp;&nbsp;找不到 — 服务器找不到给定的资源；文档不存在。&nbsp;&nbsp;<br>
407&nbsp;&nbsp;代理认证请求 — 客户机首先必须使用代理认证自身。&nbsp;&nbsp;<br>
415&nbsp;&nbsp;介质类型不受支持 — 服务器拒绝服务请求，因为不支持请求实体的格式。&nbsp;&nbsp;<br>
5xx&nbsp;&nbsp;服务器中出现的错误&nbsp;&nbsp;<br>
500&nbsp;&nbsp;内部错误 — 因为意外情况，服务器不能完成请求。&nbsp;&nbsp;<br>
501&nbsp;&nbsp;未执行 — 服务器不支持请求的工具。&nbsp;&nbsp;<br>
502&nbsp;&nbsp;错误网关 — 服务器接收到来自上游服务器的无效响应。&nbsp;&nbsp;<br>
503&nbsp;&nbsp;无法获得服务 — 由于临时过载或维护，服务器无法处理请求。</p>
<hr>
<p>HTTP&nbsp;400&nbsp;-&nbsp;请求无效&nbsp;<br>
HTTP&nbsp;401.1&nbsp;-&nbsp;未授权：登录失败&nbsp;<br>
HTTP&nbsp;401.2&nbsp;-&nbsp;未授权：服务器配置问题导致登录失败&nbsp;<br>
HTTP&nbsp;401.3&nbsp;-&nbsp;ACL&nbsp;禁止访问资源&nbsp;<br>
HTTP&nbsp;401.4&nbsp;-&nbsp;未授权：授权被筛选器拒绝&nbsp;<br>
HTTP&nbsp;401.5&nbsp;-&nbsp;未授权：ISAPI&nbsp;或&nbsp;CGI&nbsp;授权失败&nbsp;&nbsp;<br>
HTTP&nbsp;403&nbsp;-&nbsp;禁止访问&nbsp;<br>
HTTP&nbsp;403&nbsp;-&nbsp;对&nbsp;Internet&nbsp;服务管理器&nbsp;(HTML)&nbsp;的访问仅限于&nbsp;Localhost&nbsp;<br>
HTTP&nbsp;403.1&nbsp;禁止访问：禁止可执行访问&nbsp;<br>
HTTP&nbsp;403.2&nbsp;-&nbsp;禁止访问：禁止读访问&nbsp;<br>
HTTP&nbsp;403.3&nbsp;-&nbsp;禁止访问：禁止写访问&nbsp;<br>
HTTP&nbsp;403.4&nbsp;-&nbsp;禁止访问：要求&nbsp;SSL&nbsp;<br>
HTTP&nbsp;403.5&nbsp;-&nbsp;禁止访问：要求&nbsp;SSL&nbsp;128&nbsp;<br>
HTTP&nbsp;403.6&nbsp;-&nbsp;禁止访问：IP&nbsp;地址被拒绝&nbsp;<br>
HTTP&nbsp;403.7&nbsp;-&nbsp;禁止访问：要求客户证书&nbsp;<br>
HTTP&nbsp;403.8&nbsp;-&nbsp;禁止访问：禁止站点访问&nbsp;<br>
HTTP&nbsp;403.9&nbsp;-&nbsp;禁止访问：连接的用户过多&nbsp;<br>
HTTP&nbsp;403.10&nbsp;-&nbsp;禁止访问：配置无效&nbsp;<br>
HTTP&nbsp;403.11&nbsp;-&nbsp;禁止访问：密码更改&nbsp;<br>
HTTP&nbsp;403.12&nbsp;-&nbsp;禁止访问：映射器拒绝访问&nbsp;<br>
HTTP&nbsp;403.13&nbsp;-&nbsp;禁止访问：客户证书已被吊销&nbsp;<br>
HTTP&nbsp;403.15&nbsp;-&nbsp;禁止访问：客户访问许可过多&nbsp;<br>
HTTP&nbsp;403.16&nbsp;-&nbsp;禁止访问：客户证书不可信或者无效&nbsp;<br>
HTTP&nbsp;403.17&nbsp;-&nbsp;禁止访问：客户证书已经到期或者尚未生效&nbsp;<br>
HTTP&nbsp;404.1&nbsp;-&nbsp;无法找到&nbsp;Web&nbsp;站点&nbsp;<br>
HTTP&nbsp;404&nbsp;-&nbsp;无法找到文件&nbsp;<br>
HTTP&nbsp;405&nbsp;-&nbsp;资源被禁止&nbsp;<br>
HTTP&nbsp;406&nbsp;-&nbsp;无法接受&nbsp;<br>
HTTP&nbsp;407&nbsp;-&nbsp;要求代理身份验证&nbsp;<br>
HTTP&nbsp;410&nbsp;-&nbsp;永远不可用&nbsp;<br>
HTTP&nbsp;412&nbsp;-&nbsp;先决条件失败&nbsp;<br>
HTTP&nbsp;414&nbsp;-&nbsp;请求&nbsp;-&nbsp;URI&nbsp;太长&nbsp;<br>
HTTP&nbsp;500&nbsp;-&nbsp;内部服务器错误&nbsp;<br>
HTTP&nbsp;500.100&nbsp;-&nbsp;内部服务器错误&nbsp;-&nbsp;ASP&nbsp;错误&nbsp;<br>
HTTP&nbsp;500-11&nbsp;服务器关闭&nbsp;<br>
HTTP&nbsp;500-12&nbsp;应用程序重新启动&nbsp;<br>
HTTP&nbsp;500-13&nbsp;-&nbsp;服务器太忙&nbsp;<br>
HTTP&nbsp;500-14&nbsp;-&nbsp;应用程序无效&nbsp;<br>
HTTP&nbsp;500-15&nbsp;-&nbsp;不允许请求&nbsp;global.asa&nbsp;<br>
Error&nbsp;501&nbsp;-&nbsp;未实现&nbsp;<br>
HTTP&nbsp;502&nbsp;-&nbsp;网关错误</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>web</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>http</tag>
      </tags>
  </entry>
  <entry>
    <title>如何使用media Go,MusicBrainz,Mp3tag工具刮削音乐 整理音乐资料库</title>
    <url>/posts/3847ad58/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="背景">背景</h2>
<p>动画、电影、剧集可使用TinyMediaManager生成nfo元数据文件，多媒体软件解析生成海报墙展示丰富的影片信息。</p>
<p>而音乐文件则是将歌名、歌手、专辑、发行时间、歌词、封面图等信息写入文件标签，称为ID3 Tag 。桌面软件、多媒体管理软件（Foobar2000/Plex/Emby/Jellyfin等）都能解析展现歌曲信息。ID3标签是MP3音乐档案中的歌曲附加讯息，它能够在MP3中附加曲子的演出者、作者以及其它类别资讯，方便众多乐曲的管理。缺少ID3标签并不会影响 MP3的播放，但若没有的话，管理音乐文件也会相当的麻烦。</p>
<h2 id="刮削效果">刮削效果</h2>
<h3 id="Foobar2000读取效果：">Foobar2000读取效果：</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011173843.jpeg" alt=""></p>
<h3 id="Jellyfin读取效果：">Jellyfin读取效果：</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011173846.jpeg" alt=""></p>
<h2 id="Mp3tag">Mp3tag</h2>
<blockquote>
<p>纯手工修改，开源工具。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011174402.png" alt="Mp3tag"></p>
<h2 id="Media-Go">Media Go</h2>
<blockquote>
<p>不要使用最新版！老版本才有我们最需要的功能。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011174641.png" alt="Media Go"></p>
<h3 id="添加媒体库">添加媒体库</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011175356.png" alt="Media Go"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011175429.png" alt=""></p>
<h3 id="自动获取属性">自动获取属性</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011175852.png" alt=""></p>
<h3 id="歌曲属性修改">歌曲属性修改</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011175602.png" alt=""></p>
<h2 id="MusicBrainz">MusicBrainz</h2>
<blockquote>
<ul>
<li>MusicBrainz官网：<a target="_blank" rel="noopener" href="https://musicbrainz.org/">https://musicbrainz.org/</a></li>
<li>MusicBrainz Picard下载地址：<a target="_blank" rel="noopener" href="https://picard.musicbrainz.org/">https://picard.musicbrainz.org/</a></li>
</ul>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011173854.jpeg" alt="MusicBrainz"><br>
MusicBrainz Picard可以修改音乐的Tag标签信息，根据标签重命名文件。它的数据来源于非营利互联网音乐专辑数据库MusicBrainz项目，歌曲资源非常丰富。尤其它能根据声纹（音频指纹）识别Mp3文件进行匹配取信息，匹配率极高。不管是英文、中文歌曲，还是录音室版本、演唱会版本，都能很好地匹配出来。<br>
支持MP3、FLAC、OGG、M4A、WMA、WAV等主流的音频格式，wav,ape格式不支持，需要要转换成支持的格式。<br>
写入前后对比：<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011173901.jpeg" alt=""></p>
<p><strong>MusicBrainz Picard使用教程：</strong><br>
将音乐文件/文件夹拖入左侧窗口，点上方“查询“按钮，在MusicBrainz数据库里搜索对应音乐。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011173901.png" alt=""><br>
如果搜索不到，点击”扫描“，使用声纹匹配，准确度更高。<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011173907.png" alt=""><br>
如果以上两种方法都搜索不到，或者添加的文件名变成乱码，右击”查找相似的音轨“<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011173942.png" alt=""><br>
手动输入歌曲名字，搜索，选择正确的歌曲信息，载入Picard。<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011173914.png" alt=""></p>
<p>右侧窗口载入专辑信息。展开列表，绿色方块的就是匹配成功的音乐。底部窗口展示文件原始标签信息和MusicBrainz网站上的信息对照。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011173948.png" alt=""><br>
如果匹配的不是正确的专辑信息，右击”查找相似的音轨“，选择正确的专辑信息载入Picard。<br>
如果搜索出了多张专辑，可点击错误的专辑拖动到目标专辑上完成匹配，省的一个一个文件的修改。<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011173955.png" alt=""></p>
<p>最后点“保存”，将标签信息写入音乐文件。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011174018.png" alt=""></p>
<p><strong>如何重命名文件：</strong><br>
菜单栏-选项-勾选“重命名文件”，保存的时候会同时写入信息+重命名。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011174002.png" alt=""><br>
默认设置是：序号 歌名.mp3，适合一个专辑一个文件夹使用。<br>
如果是单文件的话要去创建命名规则，选项-正在重命名文件-保存时重命名文件，填写命名规则。<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011173929.jpeg" alt=""></p>
<h2 id="参考：-2">参考：</h2>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.92nas.com/forum.php?mod=viewthread&amp;tid=115">使用MusicBrainz Picard刮削音乐 整理音乐资料库</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>music</category>
      </categories>
      <tags>
        <tag>music</tag>
        <tag>刮削</tag>
        <tag>MusicBrainz</tag>
        <tag>mp3tag</tag>
      </tags>
  </entry>
  <entry>
    <title>如何使用tinyMediaManager刮削电影和电视剧，动画，并自动下载字幕</title>
    <url>/posts/e6d40157/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>注意使用V3版本，V4版本收费！</p>
<p>所以升级V3版本即可，不要升级到V4版本！不要升级到V4版本！不要升级到V4版本！</p>
</blockquote>
<ul>
<li><strong>Plex</strong>是一款很好用的个人媒体中心软件，但是因为国内网络的原因，使用默认的TMDB刮削器挂出来的效果并不好，要么就是影片信息不正确，要么就是海报不正常显示，实在让人头疼。</li>
<li><strong>tinyMediaManager</strong>是一款电影信息刮削和整理的软件，正好可以和plex配合，完美的解决这一问题。tinyMediaManager在刮削影片的过程中会把影片的海报、演员表、背景图片等等都保存到影片所在文件夹，自动生成电影的nfo信息文件，并对文件和文件夹进行重新命名的操作。在plex设置刮削代理的时候，需要用一款插件可以直接读取nfo的信息，完成刮削，下面把使用方法分享给大家，</li>
</ul>
<h2 id="下载和安装tinyMediaManager"><strong>下载和安装tinyMediaManager</strong></h2>
<p><strong>官网下载地址：<a href="www.tinymediamanager.org/download/">https://www.tinymediamanager.org/download/</a></strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181048.jpeg" alt=""></p>
<h3 id="tmm下载">tmm下载</h3>
<p><strong>下载后直接解压文件夹</strong></p>
<p>客户端需要java支持，先在电脑安装java</p>
<p>客户端下载后是一个压缩包，解压之后就可以用</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181054.jpeg" alt=""></p>
<p><strong>解压之后打开tinyMediaManager.exe</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181101.png" alt="tmm目录"></p>
<h2 id="TMM设置">TMM设置</h2>
<h3 id="TMM代理设置">TMM代理设置</h3>
<blockquote>
<p>重要：很多源都需要代理才能访问。这里正确的配置才能正确的刮削！</p>
<p>可以调整这里使用的内存，大内存可以极大加速刮削速度。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011211402.png" alt=""></p>
<h2 id="电影刮削设置">电影刮削设置</h2>
<p><strong>进行相关设置。Tmm可以对电影和电视剧的刮削进行分别设置，打开设置后选择电影选项，可以选择分级标准、自动重命名等选项。</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181337.png" alt=""></p>
<p>电影信息选项</p>
<p><strong>点击侧边栏媒体库目录，添加电影目录</strong></p>
<p><strong>刮削器设置</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181107.jpeg" alt=""></p>
<p>选择电影刮削器</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181107.png" alt=""></p>
<p>刮削器选项</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181114.png" alt=""></p>
<p>nfo选项，建议选择生成两种命名放视的nfo</p>
<p><strong>图片刮削器选择全选，图片文件名建议两边都选上，会分别生成两组命名格式不同的图片，为了保证plex能读取</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181331.png" alt=""></p>
<p>图片命名选项</p>
<p>Tmm还可以自动下载预告片，字幕。字幕下载时可以输入opensubtitles账户</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181115.png" alt=""></p>
<p>字幕下载选项</p>
<p><strong>重命名规则</strong></p>
<p>这里重点讲一下重命名规则，刮削完后可以选择对电影文件和文件夹进行重命名，可能对于pt用户重命名可能会影响资源上传，可以不进行重命名操作。</p>
<p>一般情况下电影刮削出来的信息，title是电影的中文标题名称，originaltitle是电影的原标题名称，一般是英文名称。软件默认的设置是文件和文件夹都命名成title，也就是中文标题，但是我发现这样在后期使用的时候有弊端。英文电影在检索字幕时会用文件名来检索，而用中文名称很多情况下检索不出来，所以这里把文件的命名规则改一下，改成originaltitle，并去掉年份信息的括号，中间连接符改成点，文件名设置成<img src="https://math.now.sh?inline=%7Boriginaltitle%7D" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;">{- ,edition,}.<img src="https://math.now.sh?inline=%7Byear%7D." style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;">{videoFormat}.${audioCodec}的格式。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181121.png" alt=""></p>
<p>电影文件重命名选项</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181127.png" alt=""></p>
<p>刮削完的文件夹内文件信息</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181323.png" alt=""></p>
<p>刮削完的电影文件夹目录</p>
<p><strong>电视节目刮削设置类似，如果挂不出来可以用the tvdb来刮削。</strong></p>
<p><strong>tmm有时候会出现网络不稳定，刮不到的情况，可以修改host解决</strong></p>
<p>改host 在host文件最后加一行13.224.161.90 <a href="https://link.zhihu.com/?target=http%3A//api.themoviedb.org">http://api.themoviedb.org</a></p>
<p><strong>退出设置，开始刮削</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181317.png" alt=""></p>
<p>更新电影源</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181128.jpeg" alt=""></p>
<p>选中要刮削的电影自动匹配</p>
<h3 id="电影手动刮削">电影手动刮削</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011183942.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011184131.png" alt=""></p>
<h2 id="电视剧-动画手动刮削">电视剧&amp;动画手动刮削</h2>
<h3 id="电视剧元数据刮削">电视剧元数据刮削</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011184909.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011185747.png" alt=""></p>
<h3 id="季和集元数据刮削前整理">季和集元数据刮削前整理</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011185049.png" alt=""></p>
<h3 id="刮削季元素">刮削季元素</h3>
<p>整理好正确的季和集之后，才能正确的刮削季元素</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011185146.png" alt=""></p>
<h3 id="TMM整理完效果">TMM整理完效果</h3>
<blockquote>
<p>这里用海贼王做展示，一个季和集都特别多的剧。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011185448.png" alt=""></p>
<h2 id="TMM目录重命名整理">TMM目录重命名整理</h2>
<blockquote>
<p>刮削完后，可以重命名视频文件，并进行目录整理。</p>
</blockquote>
<p>方法1</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181133.jpeg" alt=""></p>
<p>方法2</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011184315.png" alt=""></p>
<p>等所有电影的信息刮削完后，选择重命名和清理，这样就完成了刮削的操作。以后下载了新电影，直接打开tmm,更新源之后直接选择搜索未刮削过的电影完成刮削。刮削出来的信息kodi，emby等软件也都能用。</p>
<h2 id="Plex设置">Plex设置</h2>
<h3 id="plex插件的安装和设置"><strong>plex插件的安装和设置</strong></h3>
<p><strong>下载plex的插件</strong></p>
<p>插件XBMCnfoMoviesImporter和XBMCnfoTVImporter分别是刮削电影和电视剧的插件</p>
<p>下载地址：<a href="https%3A//github.com/gboudreau/XBMCnfoMoviesImporter.bundle">https://github.com/gboudreau/XBMCnfoMoviesImporter.bundle</a></p>
<p>如果不能下载的话可以联系我获取，还有几个很好用的plex插件</p>
<p>下载完插件后就需要把插件解压到plex的插件目录：C:\Users\用户名\AppData\Local\Plex Media Server\Plug-ins</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181134.png" alt=""></p>
<p>plex插件目录</p>
<p>注意解压后要把文件夹名后边的master去掉。</p>
<p><strong>plex代理设置</strong></p>
<p>Plex的代理设置就是选择刮削电影所用的刮削器及优先级。</p>
<p>装好插件后重启plex，进行plex的设置。在代理设置中选择XBMCnfoMoviesImporter，把它的优先级调到最高，第二个可以设置成字幕插件。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181140.jpeg" alt=""></p>
<p><strong>设置电影资料库的刮削器代理</strong></p>
<p>点击设置界面下方管理里边的资料库，选择电影资料夹的高级设置，设置如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181140.png" alt=""><br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181146.png" alt=""></p>
<p>plex代理设置</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181152.png" alt=""></p>
<p><strong>刷新电影源数据资料</strong></p>
<p>设置完成后就可以在plex主页对电影文件夹刷新元数据了。等待刷新完后就可以载入所有的电影信息了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181152.jpeg" alt=""></p>
<p>管理资料库-刷新电影元数据</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181153.jpeg" alt=""></p>
<p>更新后的电影信息</p>
<p>采用类似的设置，电视剧信息也能刮削。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181159.jpeg" alt=""></p>
<p>电视剧更新后的信息</p>
<h2 id="Emby设置">Emby设置</h2>
<blockquote>
<p>Emby内置刮削工具，但是速度较慢。下面设置基于外部刮削工具TMM，所以没有勾选Emby刮削源！</p>
</blockquote>
<p>最终效果演示</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011190035.png" alt="最终效果"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011190347.png" alt=""></p>
<h3 id="开始设置">开始设置</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011181946.png" alt=""></p>
<h3 id="新增媒体库">新增媒体库</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011182142.png" alt=""></p>
<h3 id="已有媒体库属性设置">已有媒体库属性设置</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011182244.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011182350.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011183115.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011183157.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011183336.png" alt=""></p>
<h3 id="Emby字幕设置">Emby字幕设置</h3>
<p>字幕下载设置，字幕下载工具见后面的[字幕下载]章节</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1120211011182554.png" alt=""></p>
<h2 id="字幕下载-2"><strong>字幕下载</strong></h2>
<p>想要较好的自动下载字幕，最好用前面介绍的tmm刮削改名之后再使用下面工具。</p>
<h3 id="subfinder-自动下载字幕-2">subfinder 自动下载字幕</h3>
<ul>
<li>Docker： <a target="_blank" rel="noopener" href="https://hub.docker.com/r/superng6/subfinder">superng6/subfinder</a></li>
</ul>
<p>下载完成，刮削后的目录，挂载到subfinder的media目录，就会自动下载字幕。</p>
<p>字幕下载对电影，英文剧集支持较好。对于一些tv，动画手动下载字幕会更好一些。</p>
<p>注意：官方的配置文件有问题，时效问题。修改URL到最新即可。</p>
<h3 id="chinesesubfinder-2">chinesesubfinder</h3>
<ul>
<li>Docker： <a target="_blank" rel="noopener" href="https://hub.docker.com/r/allanpk716/chinesesubfinder">allanpk716/chinesesubfinder</a></li>
<li>新开发的中文字幕查找工具，上面那个很久没更新了，这个刚出来。使用nfo里面刮削出来的文件名来匹配字幕。所以就原理来说，这个字幕匹配更准确。</li>
</ul>
<h3 id="bazarr-2">bazarr</h3>
<ul>
<li>Docker：<a target="_blank" rel="noopener" href="https://hub.docker.com/r/linuxserver/bazarr">linuxserver/bazarr</a></li>
<li>字幕下载管理，配合sonarr, radarr 使用效果更好。对于英文剧集命名规范的支持较好，比如<code>[name]S01E01</code></li>
</ul>
<h2 id="参考-3">参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/112167546?from_voters_page=true">利用tinyMediaManager刮削影片，解决家用nas软件plex电影墙的问题</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>video</category>
      </categories>
      <tags>
        <tag>刮削</tag>
        <tag>tmm</tag>
        <tag>字幕</tag>
        <tag>emby</tag>
        <tag>plex</tag>
      </tags>
  </entry>
  <entry>
    <title>通过IPV6访问Qnap NAS中Docker的服务</title>
    <url>/posts/462f1e5c/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="环境">环境</h2>
<p>系统：QTS 4.3.6<br>
网络：IPV4 &amp; IPV6<br>
Docker: 由Container Station提供</p>
<h2 id="问题-2">问题</h2>
<p>通过ipv6地址可以打开NAS的管理页面，但是无法访问Docker对应端口的服务。</p>
<h2 id="排查">排查</h2>
<p>QTS中Docker使用的虚拟交换机网络没有启动IPV6，且无法在虚拟交换机设置中手动启动。<br>
这样一来，Docker只监听了tcp4的端口，对于主机上tcp6的端口的访问无法映射到docker容器上。</p>
<h2 id="解决方案-2">解决方案</h2>
<p>在主机上开一个tcp6的端口，将其转发到主机上与docker关联的tcp4端口。<br>
即：<br>
docker(tcp4)–&gt;host(tcp4)–&gt;host(tcp6)</p>
<ul>
<li>在qts上安装包管理器：Entware. https://github.com/Entware/Entware/wiki/Install-on-QNAP-NAS</li>
<li>执行opkg update,更新</li>
<li>安装端口转发工具，这里使用socat：opkg install socat</li>
<li>设置转发host(tcp6)–&gt;host(tcp4):(socat TCP6-LISTEN:6880,reuseaddr,fork TCP4:127.0.0.1:7880 &amp;)</li>
<li>大功告成</li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>nas</category>
      </categories>
      <tags>
        <tag>nas</tag>
        <tag>docker</tag>
        <tag>qnap</tag>
        <tag>ipv6</tag>
      </tags>
  </entry>
  <entry>
    <title>CMake快速入门教程</title>
    <url>/posts/495db4d3/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-cmake简介">1.cmake简介</h2>
<p>cmake是跨平台的makefile文件生成工具,是为了解决各个平台下面make工具不同造成的makefile文件格式不同的问题.也就是cmake是用来解决跨平台编译问题的.常见的还有autotool工具集，该工具集用于GNU软件协议的makefile文件生成，方便GNU包的编译和安装。</p>
<h2 id="2-cmake文件编辑规则">2.cmake文件编辑规则</h2>
<ul>
<li>1)<strong>命令不区分大小写，但是变量区分大小写</strong>。</li>
<li>2)<strong>注释</strong>使用#符号</li>
<li>3)命令如果有多个参数，互相之间用空格隔开</li>
</ul>
<h2 id="3-cmake保留变量">3.cmake保留变量</h2>
<p>cmake里面有很多的预定义变量,是程序环境固有的,比如CUDA_NVCC_FLAGS,不同的变量有固定的作用,比如CUDA_NVCC_FLAGS是nvcc的参数list,变量可以使用set命令和list命令进行赋值和追加值,要注意的是变量可能可以有多个值,值与值之间用分号分开,可以使用set(var a b c)给var赋值a b c,还可以使用list命令给var追加删除插入值等,不同的变量有不同的值域,需要查阅<a target="_blank" rel="noopener" href="https://cmake.org/documentation/">手册</a></p>
<h2 id="4-cmake变量引用">4.cmake变量引用</h2>
<p>cmake里面变量的取值引用要使用${var}的形式,但是在赋值的时候是不需要的,和shell命令有点相似.</p>
<h2 id="5-cmake指定Debug和Release版本">5.cmake指定Debug和Release版本</h2>
<p>指定Debug和Release一共有三种方法：</p>
<p>1.使用ADD_COMPILE_OPTIONS()加入-g指定Debug版本.</p>
<p>2.使用SET( CMAKE_BUILD_TYPE Debug/Rrelease)指定Debug<br>
在下面加入：</p>
<pre class="line-numbers language-cmake" data-language="cmake"><code class="language-cmake"><span class="token function">SET</span><span class="token punctuation">(</span><span class="token variable">CMAKE_CXX_FLAGS_DEBUG</span> <span class="token string">"$ENV{CXXFLAGS} -O0 -Wall -g2 -ggdb"</span><span class="token punctuation">)</span>
<span class="token function">SET</span><span class="token punctuation">(</span><span class="token variable">CMAKE_CXX_FLAGS_RELEASE</span> <span class="token string">"$ENV{CXXFLAGS} -O3 -Wall"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>上面的设置C++编译选项，对于C语言，设置CMAKE_C_FLAGS_DEBUG、CMAKE_._FLAGS_RELEASE变量，一般来说最好两个都设置原因是CMake 中有一个变量 CMAKE_BUILD_TYPE ,可以的取值是 Debug Release等.当这个变量值为 Debug 的时候,CMake 会使用变量 CMAKE_CXX_FLAGS_DEBUG 和 CMAKE_C_FLAGS_DEBUG 中的字符串作为编译选项生成 Makefile</p>
<p>编译动态库or静态库时，最好通过修改CXXFLAGS和CFLAGS，以支持-fPIC，这个选项有时是默认开启，有时默认关闭，但为了以后的应用，库文件最好都使用-fPIC编译</p>
<ol start="3">
<li>在使用cmake命令时加上-DCMAKE_BUILD_TYPE=Debug/Release</li>
</ol>
<h2 id="5-cmake指定生成文件">5.cmake指定生成文件</h2>
<p>CUDA_ADD_LIBRARY()指明目标文件是库文件,CUDA_ADD_EXECUTABLE()指明生成的文件为可执行文件</p>
<h2 id="6-配置模板">6.配置模板</h2>
<p>通常我们要在工程目录下面创建include、src文件夹，include文件夹里面存放头文件，src文件夹里面存放源代码，注意这时候的源代码里面包含头文件的路径应该是“../include/xx.h”，然后在工程根目录下面创建CMakeLists.txt文件，里面写入命令.在编译的时候为了不搞乱工程目录，在工程根目录下面创建build文件夹，在里面使用“cmake ..”命令创建CMakefile,再make即可。</p>
<pre class="line-numbers language-cmake" data-language="cmake"><code class="language-cmake"><span class="token comment">#指定cmake最低版本号</span>
<span class="token keyword">cmake_minimum_required</span><span class="token punctuation">(</span><span class="token property">VERSION</span> <span class="token number">3.2</span><span class="token punctuation">)</span>

<span class="token comment">#指定项目名称</span>
<span class="token function">PROJECT</span><span class="token punctuation">(</span>Liner_Struct<span class="token punctuation">)</span>

<span class="token comment">#指定头文件目录，不同目录用空格隔开,目录中有空格可用引号</span>
<span class="token comment">#如果是相对路径，相对于CMakeLists.txt文件</span>
<span class="token property">INCLUDE_DIRECTORIES</span><span class="token punctuation">(</span>include<span class="token punctuation">)</span>

<span class="token comment">#指定源文件目录，DIR_SRCS值自定义变量，下面的命令对其进行了赋值</span>
<span class="token function">AUX_SOURCE_DIRECTORY</span><span class="token punctuation">(</span>src DIR_SRCS<span class="token punctuation">)</span>

<span class="token comment">#设置变量用于存放所有的编译文件，</span>
<span class="token comment">#TEST_LINER_STRUCT是自定义变量，使用SET给其赋值</span>
<span class="token function">SET</span><span class="token punctuation">(</span>TEST_LINER_STRUCT <span class="token punctuation">${</span>DIR_SRCS<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">#增加编译选项</span>
<span class="token comment">#判断是否为gcc编译器，如果是，增加编译选项</span>
<span class="token comment">#c99是c语言的标准，常用的还有c++标准c++11</span>
<span class="token comment">#下面的命令判断是否编译器是gcc</span>
<span class="token comment">#message命令是输出信息,例如下面的输出“optional:-std=c99”</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">CMAKE_COMPILER_IS_GNUCXX</span><span class="token punctuation">)</span>
    <span class="token function">ADD_COMPILE_OPTIONS</span><span class="token punctuation">(</span>-std=c99<span class="token punctuation">)</span>
    <span class="token keyword">message</span><span class="token punctuation">(</span>STATUS <span class="token string">"optional:-std=c99"</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token variable">CMAKE_COMPILER_IS_GNUCXX</span><span class="token punctuation">)</span>

<span class="token comment">#配置生成文件</span>
<span class="token comment">#${PROJECT_NAME}是cmake自带变量，其值和PROJECT()命令指定的一样</span>
<span class="token comment">#${TEST_LINER_STRUCT}是自定义变量，上文赋值的</span>
<span class="token function">ADD_EXECUTABLE</span><span class="token punctuation">(</span><span class="token punctuation">${</span><span class="token variable">PROJECT_NAME</span><span class="token punctuation">}</span> <span class="token punctuation">${</span>TEST_LINER_STRUCT<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="7-if-else语句">7.<a target="_blank" rel="noopener" href="https://cmake.org/cmake/help/v3.0/command/if.html">if-else</a>语句</h2>
<p>cmake中的if-else语句</p>
<pre class="line-numbers language-cmake" data-language="cmake"><code class="language-cmake"><span class="token keyword">if</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
     cmdA
     cmdB
<span class="token keyword">elseif</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
      cmdC
<span class="token keyword">endif</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最简单得到一个应用</p>
<pre class="line-numbers language-cmake" data-language="cmake"><code class="language-cmake"><span class="token keyword">if</span><span class="token punctuation">(</span>ARM<span class="token punctuation">)</span>
   <span class="token comment">#ARM平台</span>
<span class="token keyword">else</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">#非ARM平台 </span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用cmake -DARM=1 .. 时编译ARM代码，使用cmake -DAMR=0 ..编译非ARM代码</p>
<h2 id="8-与平台编译器的结合">8.与平台编译器的结合</h2>
<h3 id="8-1windows">8.1windows</h3>
<p>在windows上运行cmake可以生成对应的VS的工程文件，然后使用相应的VS打开工程就可以进行编译。要注意的是如果使用VS2010及其以前的版本，C不支持C99，也就是变量的命名必须放在函数或者域的最前面，不能放在中间，特别麻烦。VS2015在安装后可能还需要打开VS，新建工程时选择VC<ins>可能相关组件还没有安装，如果这时候使用cmake会提示找不到C、C</ins>编译器（类似yuNo CMAKE_CXX_COMPILER could be found）的错误。安装了相关的组件后cmake即不会有错误。</p>
<h3 id="8-2-为VS2015生成的项目">8.2 为VS2015生成的项目</h3>
<p>打开工程文件后可以看到有3个项目，其中只有一个和我们有直接关系，就是我们在CMakeLists.txt里面定义的PROJECT_NAME,剩下的两个是ALL_BUILD和ZERO_CHECK.</p>
<p><strong>ZERO_CHECK</strong><br>
该目标会检查生成工程的 CMake 配置文件（ CMakeLists.txt ）是否更新。如更新，将运行 CMake 重新生成工程文件。</p>
<p>如果确信 CMakeLists.txt 不会被更新，或者希望手工运行 CMake 重新生成工程文件，可以在 CMakeLists.txt 配置文件中添加 set(CMAKE_SUPPRESS_REGENERATION FALSE) 命令， ZERO_CHECK 目标将不会生成。</p>
<p><strong>ALL_BUILD</strong><br>
该目标会导致工程中所有项目被构建，类似 Visual Studio 的 Build All 或者 make 的 make all命令。</p>
<p>转载 <a target="_blank" rel="noopener" href="https://lightzhan.xyz/index.php/2020/03/11/cmake-quick-tutorial/">CMake快速入门教程</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>cmake</tag>
        <tag>develop</tag>
      </tags>
  </entry>
  <entry>
    <title>如何使用Traefik V2 在Ubuntu20.04 上面来做 Dockers Containers 的反向代理</title>
    <url>/posts/465d2738/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>How To Use Traefik v2 as a Reverse Proxy for Docker Containers on Ubuntu 20.04</p>
<blockquote>
<p>Traefik 适合配合Dockers swarm 做服务， Dockers portainer 做管理，ELK集群做监控日志。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1420211014200800.png" alt="Traefik"></p>
<p><code>traefik</code> 与 <code>nginx</code> 一样，是一款优秀的反向代理工具，或者叫 <code>Edge Router</code>。至于使用它的原因则基于以下几点</p>
<ul>
<li>无须重启即可更新配置</li>
<li>自动的服务发现与负载均衡</li>
<li>与 <code>docker</code> 完美集成，基于 <code>container label</code> 的配置</li>
<li>漂亮的 <code>dashboard</code> 界面</li>
<li><code>metrics</code> 的支持，支持对 <code>prometheus</code> 和 <code>k8s</code> 集成</li>
</ul>
<h3 id="Introduction">Introduction</h3>
<p><a target="_blank" rel="noopener" href="https://www.docker.com/">Docker</a> can be an efficient way to run web applications in production, but you may want to run multiple applications on the same Docker host. In this situation, you’ll need to set up a reverse proxy. This is because you only want to expose ports <code>80</code> and <code>443</code> to the rest of the world.</p>
<p><a target="_blank" rel="noopener" href="https://traefik.io/">Traefik</a> is a Docker-aware reverse proxy that includes a monitoring dashboard. Traefik v1 has been widely used for a while, and <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-use-traefik-as-a-reverse-proxy-for-docker-containers-on-ubuntu-20-04">you can follow this earlier tutorial to install Traefik v1</a>). But in this tutorial, you’ll install and configure Traefik v2, which includes quite a few differences.</p>
<p>The biggest difference between Traefik v1 and v2 is that <em>frontends</em> and <em>backends</em> were removed and their combined functionality spread out across <em>routers</em>, <em>middlewares</em>, and <em>services</em>. Previously a backend did the job of making modifications to requests and getting that request to whatever was supposed to handle it. Traefik v2 provides more separation of concerns by introducing middlewares that can modify requests before sending them to a service. Middlewares make it easier to specify a single modification step that might be used by a lot of different routes so that they can be reused (such as HTTP Basic Auth, which you’ll see later). A router can also use many different middlewares.</p>
<p>In this tutorial you’ll configure Traefik v2 to route requests to two different web application containers: a <a target="_blank" rel="noopener" href="http://wordpress.org/">Wordpress</a> container and an <a target="_blank" rel="noopener" href="https://www.adminer.org/">Adminer</a> container, each talking to a <a target="_blank" rel="noopener" href="https://www.mysql.com/">MySQL</a> database. You’ll configure Traefik to serve everything over HTTPS using <a target="_blank" rel="noopener" href="https://letsencrypt.org/">Let’s Encrypt</a>.</p>
<h2 id="Prerequisites">Prerequisites</h2>
<p>To complete this tutorial, you will need the following:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.digitalocean.com/products/linux-distribution/ubuntu/">One Ubuntu 20.04 server</a> with a sudo non-root user and a firewall. You can set this up by following our <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-20-04">Ubuntu 20.04 initial server setup guide</a>.</li>
<li>Docker installed on your server, which you can accomplish by following <strong>Steps 1 and 2</strong> of <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-20-04">How to Install and Use Docker on Ubuntu 20.04</a>.</li>
<li>Docker Compose installed using the instructions from <strong>Step 1</strong> of <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-compose-on-ubuntu-20-04">How to Install Docker Compose on Ubuntu 20.04</a>.</li>
<li>A domain and three A records, <code>db-admin.your_domain</code>, <code>blog.your_domain</code> and <code>monitor.your_domain</code>. Each should point to the IP address of your server. You can learn how to point domains to DigitalOcean Droplets by reading through <a target="_blank" rel="noopener" href="https://www.digitalocean.com/docs/networking/dns/">DigitalOcean’s Domains and DNS documentation</a>. Throughout this tutorial, substitute your domain for <code>your_domain</code> in the configuration files and examples.</li>
</ul>
<h2 id="Step-1-—-Configuring-and-Running-Traefik">Step 1 — Configuring and Running Traefik</h2>
<p>The Traefik project has an <a target="_blank" rel="noopener" href="https://hub.docker.com/_/traefik">official Docker image</a>, so you will use that to run Traefik in a Docker container.</p>
<p>But before you get your Traefik container up and running, you need to create a configuration file and set up an encrypted password so you can access the monitoring dashboard.</p>
<p>You’ll use the <code>htpasswd</code> utility to create this encrypted password. First, install the utility, which is included in the <code>apache2-utils</code> package:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> apache2-utils<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Then generate the password with <code>htpasswd</code>. Substitute <code>secure_password</code> with the password you’d like to use for the Traefik admin user:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">htpasswd -nb admin secure_password<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>The output from the program will look like this:</p>
<pre class="line-numbers language-none"><code class="language-none">Outputadmin:$apr1$ruca84Hq$mbjdMZBAG.KWn7vfN/SNK/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>You’ll use this output in the Traefik configuration file to set up HTTP Basic Authentication for the Traefik health check and monitoring dashboard. Copy the entire output line so you can paste it later.</p>
<p>To configure the Traefik server, you’ll create two new configuration files called <code>traefik.toml</code> and <code>traefik_dynamic.toml</code> using the TOML format. <a target="_blank" rel="noopener" href="https://github.com/toml-lang/toml">TOML</a> is a configuration language similar to INI files, but standardized. <a target="_blank" rel="noopener" href="https://docs.traefik.io/providers/overview/">These files let us configure the Traefik server and various integrations</a>, or <code>providers</code>, that you want to use. In this tutorial, you will use three of Traefik’s available providers: <code>api</code>, <code>docker</code>, and <code>acme</code>. The last of these, <code>acme</code>, supports TLS certificates using Let’s Encrypt.</p>
<p>Create and open <code>traefik.toml</code> using <code>nano</code> or your preferred text editor:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nano</span> traefik.toml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>First, you want to specify the ports that Traefik should listen on using the <code>entryPoints</code> section of your config file. You want two because you want to listen on port <code>80</code> and <code>443</code>. Let’s call these <code>web</code> (port <code>80</code>) and <code>websecure</code> (port <code>443</code>).</p>
<p>Add the following configurations:</p>
<p>traefik.toml</p>
<pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">entryPoints</span><span class="token punctuation">]</span>
  <span class="token punctuation">[</span><span class="token table class-name">entryPoints.web</span><span class="token punctuation">]</span>
    <span class="token key property">address</span> <span class="token punctuation">=</span> <span class="token string">":80"</span>
    <span class="token punctuation">[</span><span class="token table class-name">entryPoints.web.http.redirections.entryPoint</span><span class="token punctuation">]</span>
      <span class="token key property">to</span> <span class="token punctuation">=</span> <span class="token string">"websecure"</span>
      <span class="token key property">scheme</span> <span class="token punctuation">=</span> <span class="token string">"https"</span>

  <span class="token punctuation">[</span><span class="token table class-name">entryPoints.websecure</span><span class="token punctuation">]</span>
    <span class="token key property">address</span> <span class="token punctuation">=</span> <span class="token string">":443"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Note that you are also automatically redirecting traffic to be handled over TLS.</p>
<p>Next, configure the Traefik <code>api</code>, which gives you access to both the API and your dashboard interface. The heading of <code>[api]</code> is all that you need because the dashboard is then enabled by default, but you’ll be explicit for the time being.</p>
<p>Add the following code:</p>
<p>traefik.toml</p>
<pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token table class-name">api</span><span class="token punctuation">]</span>
  <span class="token key property">dashboard</span> <span class="token punctuation">=</span> <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>To finish securing your web requests you want to use Let’s Encrypt to generate valid TLS certificates. Traefik v2 supports Let’s Encrypt out of the box and you can configure it by creating a <em>certificates resolver</em> of the type <code>acme</code>.</p>
<p>Let’s configure your certificates resolver now using the name <code>lets-encrypt</code>:</p>
<p>traefik.toml</p>
<pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token table class-name">certificatesResolvers.lets-encrypt.acme</span><span class="token punctuation">]</span>
  <span class="token key property">email</span> <span class="token punctuation">=</span> <span class="token string">"your_email@your_domain"</span>
  <span class="token key property">storage</span> <span class="token punctuation">=</span> <span class="token string">"acme.json"</span>
  <span class="token punctuation">[</span><span class="token table class-name">certificatesResolvers.lets-encrypt.acme.tlsChallenge</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>This section is called <code>acme</code> because <a target="_blank" rel="noopener" href="https://github.com/ietf-wg-acme/acme/">ACME</a> is the name of the protocol used to communicate with Let’s Encrypt to manage certificates. The Let’s Encrypt service requires registration with a valid email address, so to have Traefik generate certificates for your hosts, set the <code>email</code> key to your email address. You then specify that you will store the information that you will receive from Let’s Encrypt in a JSON file called <code>acme.json</code>.</p>
<p>The <code>acme.tlsChallenge</code> section allows us to specify how Let’s Encrypt can verify that the certificate. You’re configuring it to serve a file as part of the challenge over port <code>443</code>.</p>
<p>Finally, you need to configure Traefik to work with Docker.</p>
<p>Add the following configurations:</p>
<p>traefik.toml</p>
<pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token table class-name">providers.docker</span><span class="token punctuation">]</span>
  <span class="token key property">watch</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token key property">network</span> <span class="token punctuation">=</span> <span class="token string">"web"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>The <code>docker</code> provider enables Traefik to act as a proxy in front of Docker containers. You’ve configured the provider to <code>watch</code> for new containers on the <code>web</code> network, which you’ll create soon.</p>
<p>Our final configuration uses the <code>file</code> provider. With Traefik v2, static and dynamic configurations can’t be mixed and matched. To get around this, you will use <code>traefik.toml</code> to define your static configurations and then keep your dynamic configurations in another file, which you will call <code>traefik_dynamic.toml</code>. Here you are using the <code>file</code> provider to tell Traefik that it should read in dynamic configurations from a different file.</p>
<p>Add the following <code>file</code> provider:</p>
<p>traefik.toml</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>providers.file<span class="token punctuation">]</span>
  filename <span class="token operator">=</span> <span class="token string">"traefik_dynamic.toml"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Your completed <code>traefik.toml</code> will look like this:</p>
<p>traefik.toml</p>
<pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">entryPoints</span><span class="token punctuation">]</span>
  <span class="token punctuation">[</span><span class="token table class-name">entryPoints.web</span><span class="token punctuation">]</span>
    <span class="token key property">address</span> <span class="token punctuation">=</span> <span class="token string">":80"</span>
    <span class="token punctuation">[</span><span class="token table class-name">entryPoints.web.http.redirections.entryPoint</span><span class="token punctuation">]</span>
      <span class="token key property">to</span> <span class="token punctuation">=</span> <span class="token string">"websecure"</span>
      <span class="token key property">scheme</span> <span class="token punctuation">=</span> <span class="token string">"https"</span>

  <span class="token punctuation">[</span><span class="token table class-name">entryPoints.websecure</span><span class="token punctuation">]</span>
    <span class="token key property">address</span> <span class="token punctuation">=</span> <span class="token string">":443"</span>

<span class="token punctuation">[</span><span class="token table class-name">api</span><span class="token punctuation">]</span>
  <span class="token key property">dashboard</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>

<span class="token punctuation">[</span><span class="token table class-name">certificatesResolvers.lets-encrypt.acme</span><span class="token punctuation">]</span>
  <span class="token key property">email</span> <span class="token punctuation">=</span> <span class="token string">"your_email@your_domain"</span>
  <span class="token key property">storage</span> <span class="token punctuation">=</span> <span class="token string">"acme.json"</span>
  <span class="token punctuation">[</span><span class="token table class-name">certificatesResolvers.lets-encrypt.acme.tlsChallenge</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span><span class="token table class-name">providers.docker</span><span class="token punctuation">]</span>
  <span class="token key property">watch</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token key property">network</span> <span class="token punctuation">=</span> <span class="token string">"web"</span>

<span class="token punctuation">[</span><span class="token table class-name">providers.file</span><span class="token punctuation">]</span>
  <span class="token key property">filename</span> <span class="token punctuation">=</span> <span class="token string">"traefik_dynamic.toml"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Save and close the file.</p>
<p>Now let’s create <code>traefik_dynamic.toml</code>.</p>
<p>The dynamic configuration values that you need to keep in their own file are the <em>middlewares</em> and the <em>routers</em>. To put your dashboard behind a password you need to customize the API’s <em>router</em> and configure a <em>middleware</em> to handle HTTP basic authentication. Let’s start by setting up the middleware.</p>
<p>The middleware is configured on a per-protocol basis and since you’re working with HTTP you’ll specify it as a section chained off of <code>http.middlewares</code>. Next comes the name of your middleware so that you can reference it later, followed by the type of middleware that it is, which will be <code>basicAuth</code> in this case. Let’s call your middleware <code>simpleAuth</code>.</p>
<p>Create and open a new file called <code>traefik_dynamic.toml</code>:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nano</span> traefik_dynamic.toml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Add the following code. This is where you’ll paste the output from the <code>htpasswd</code> command:</p>
<p>traefik_dynamic.toml</p>
<pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">http.middlewares.simpleAuth.basicAuth</span><span class="token punctuation">]</span>
  <span class="token key property">users</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>
    <span class="token string">"admin:$apr1$ruca84Hq$mbjdMZBAG.KWn7vfN/SNK/"</span>
  <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>To configure the router for the api you’ll once again be chaining off of the protocol name, but instead of using <code>http.middlewares</code>, you’ll use <code>http.routers</code> followed by the name of the router. In this case, the <code>api</code> provides its own named router that you can configure by using the <code>[http.routers.api]</code> section. You’ll configure the domain that you plan on using with your dashboard also by setting the <code>rule</code> key using a host match, the entrypoint to use <code>websecure</code>, and the middlewares to include <code>simpleAuth</code>.</p>
<p>Add the following configurations:</p>
<p>traefik_dynamic.toml</p>
<pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token table class-name">http.routers.api</span><span class="token punctuation">]</span>
  <span class="token key property">rule</span> <span class="token punctuation">=</span> <span class="token string">"Host(`monitor.your_domain`)"</span>
  <span class="token key property">entrypoints</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"websecure"</span><span class="token punctuation">]</span>
  <span class="token key property">middlewares</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"simpleAuth"</span><span class="token punctuation">]</span>
  <span class="token key property">service</span> <span class="token punctuation">=</span> <span class="token string">"api@internal"</span>
  <span class="token punctuation">[</span><span class="token table class-name">http.routers.api.tls</span><span class="token punctuation">]</span>
    <span class="token key property">certResolver</span> <span class="token punctuation">=</span> <span class="token string">"lets-encrypt"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The <code>web</code> entry point handles port <code>80</code>, while the <code>websecure</code> entry point uses port <code>443</code> for TLS/SSL. You automatically redirect all of the traffic on port <code>80</code> to the <code>websecure</code> entry point to force secure connections for all requests.</p>
<p>Notice the last three lines here configure a <em>service</em>, enable tls, and configure <code>certResolver</code> to <code>"lets-encrypt"</code>. Services are the final step to determining where a request is finally handled. The <code>api@internal</code> service is a built-in service that sits behind the API that you expose. Just like routers and middlewares, services can be configured in this file, but you won’t need to do that to achieve your desired result.</p>
<p>Your completed <code>traefik_dynamic.toml</code> file will look like this:</p>
<p>traefik_dynamic.toml</p>
<pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">http.middlewares.simpleAuth.basicAuth</span><span class="token punctuation">]</span>
  <span class="token key property">users</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>
    <span class="token string">"admin:$apr1$ruca84Hq$mbjdMZBAG.KWn7vfN/SNK/"</span>
  <span class="token punctuation">]</span>

<span class="token punctuation">[</span><span class="token table class-name">http.routers.api</span><span class="token punctuation">]</span>
  <span class="token key property">rule</span> <span class="token punctuation">=</span> <span class="token string">"Host(`monitor.your_domain`)"</span>
  <span class="token key property">entrypoints</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"websecure"</span><span class="token punctuation">]</span>
  <span class="token key property">middlewares</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"simpleAuth"</span><span class="token punctuation">]</span>
  <span class="token key property">service</span> <span class="token punctuation">=</span> <span class="token string">"api@internal"</span>
  <span class="token punctuation">[</span><span class="token table class-name">http.routers.api.tls</span><span class="token punctuation">]</span>
    <span class="token key property">certResolver</span> <span class="token punctuation">=</span> <span class="token string">"lets-encrypt"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Save the file and exit the editor.</p>
<p>With these configurations in place, you will now start Traefik.</p>
<h2 id="Step-2-–-Running-the-Traefik-Container">Step 2 – Running the Traefik Container</h2>
<p>In this step you will create a Docker network for the proxy to share with containers. You will then access the Traefik dashboard. The Docker network is necessary so that you can use it with applications that are run using Docker Compose.</p>
<p>Create a new Docker network called <code>web</code>:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> network create web<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>When the Traefik container starts, you will add it to this network. Then you can add additional containers to this network later for Traefik to proxy to.</p>
<p>Next, create an empty file that will hold your Let’s Encrypt information. You’ll share this into the container so Traefik can use it:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">touch</span> acme.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Traefik will only be able to use this file if the root user inside of the container has unique read and write access to it. To do this, lock down the permissions on <code>acme.json</code> so that only the owner of the file has read and write permission.</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token number">600</span> acme.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Once the file gets passed to Docker, the owner will automatically change to the <strong>root</strong> user inside the container.</p>
<p>Finally, create the Traefik container with this command:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run -d <span class="token punctuation">\</span>
  -v /var/run/docker.sock:/var/run/docker.sock <span class="token punctuation">\</span>
  -v <span class="token environment constant">$PWD</span>/traefik.toml:/traefik.toml <span class="token punctuation">\</span>
  -v <span class="token environment constant">$PWD</span>/traefik_dynamic.toml:/traefik_dynamic.toml <span class="token punctuation">\</span>
  -v <span class="token environment constant">$PWD</span>/acme.json:/acme.json <span class="token punctuation">\</span>
  -p <span class="token number">80</span>:80 <span class="token punctuation">\</span>
  -p <span class="token number">443</span>:443 <span class="token punctuation">\</span>
  --network web <span class="token punctuation">\</span>
  --name traefik <span class="token punctuation">\</span>
  traefik:v2.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>This command is a little long. Let’s break it down.</p>
<p>You use the <code>-d</code> flag to run the container in the background as a daemon. You then share your <code>docker.sock</code> file into the container so that the Traefik process can listen for changes to containers. You also share the <code>traefik.toml</code> and <code>traefik_dynamic.toml</code> configuration files into the container, as well as <code>acme.json</code>.</p>
<p>Next, you map ports <code>:80</code> and <code>:443</code> of your Docker host to the same ports in the Traefik container so Traefik receives all HTTP and HTTPS traffic to the server.</p>
<p>You set the network of the container to <code>web</code>, and you name the container <code>traefik</code>.</p>
<p>Finally, you use the <code>traefik:v2.2</code> image for this container so that you can guarantee that you’re not running a completely different version than this tutorial is written for.</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/#entrypoint">A Docker image’s <code>ENTRYPOINT</code> is a command that always runs when a container is created from the image</a>. In this case, the command is the <code>traefik</code> binary within the container. You can pass additional arguments to that command when you launch the container, but you’ve configured all of your settings in the <code>traefik.toml</code> file.</p>
<p>With the container started, you now have a dashboard you can access to see the health of your containers. You can also use this dashboard to visualize the routers, services, and middlewares that Traefik has registered. You can try to access the monitoring dashboard by pointing your browser to <code>https://monitor.your_domain/dashboard/</code> (the trailing <code>/</code> is required).</p>
<p>You will be prompted for your username and password, which are <strong>admin</strong> and the password you configured in Step 1.</p>
<p>Once logged in, you’ll see the Traefik interface:</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1420211014200207.png" alt="Empty Traefik dashboard"></p>
<p>You will notice that there are already some routers and services registered, but those are the ones that come with Traefik and the router configuration that you wrote for the API.</p>
<p>You now have your Traefik proxy running, and you’ve configured it to work with Docker and monitor other containers. In the next step you will start some containers for Traefik to proxy.</p>
<h2 id="Step-3-—-Registering-Containers-with-Traefik">Step 3 — Registering Containers with Traefik</h2>
<p>With the Traefik container running, you’re ready to run applications behind it. Let’s launch the following containers behind Traefik:</p>
<ol>
<li>A blog using the <a target="_blank" rel="noopener" href="https://hub.docker.com/_/wordpress/">official WordPress image</a>.</li>
<li>A database management server using the <a target="_blank" rel="noopener" href="https://hub.docker.com/_/adminer/">official Adminer image</a>.</li>
</ol>
<p>You’ll manage both of these applications with Docker Compose using a <code>docker-compose.yml</code> file.</p>
<p>Create and open the <code>docker-compose.yml</code> file in your editor:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nano</span> docker-compose.yml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Add the following lines to the file to specify the version and the networks you’ll use:</p>
<p>docker-compose.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3"</span>

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">web</span><span class="token punctuation">:</span>
    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">internal</span><span class="token punctuation">:</span>
    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>You use Docker Compose version <code>3</code> because it’s the newest major version of the Compose file format.</p>
<p>For Traefik to recognize your applications, they must be part of the same network, and since you created the network manually, you pull it in by specifying the network name of <code>web</code> and setting <code>external</code> to <code>true</code>. Then you define another network so that you can connect your exposed containers to a database container that you won’t expose through Traefik. You’ll call this network <code>internal</code>.</p>
<p>Next, you’ll define each of your <code>services</code>, one at a time. Let’s start with the <code>blog</code> container, which you’ll base on the official WordPress image. Add this configuration to the bottom of the file:</p>
<p>docker-compose.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">...</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">blog</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">:</span>4.9.8<span class="token punctuation">-</span>apache
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">WORDPRESS_DB_PASSWORD</span><span class="token punctuation">:</span>
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> traefik.http.routers.blog.rule=Host(`blog.your_domain`)
      <span class="token punctuation">-</span> traefik.http.routers.blog.tls=true
      <span class="token punctuation">-</span> traefik.http.routers.blog.tls.certresolver=lets<span class="token punctuation">-</span>encrypt
      <span class="token punctuation">-</span> traefik.port=80
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> internal
      <span class="token punctuation">-</span> web
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mysql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The <code>environment</code> key lets you specify environment variables that will be set inside of the container. By not setting a value for <code>WORDPRESS_DB_PASSWORD</code>, you’re telling Docker Compose to get the value from your shell and pass it through when you create the container. You will define this environment variable in your shell before starting the containers. This way you don’t hard-code passwords into the configuration file.</p>
<p>The <code>labels</code> section is where you specify configuration values for Traefik. Docker labels don’t do anything by themselves, but Traefik reads these so it knows how to treat containers. Here’s what each of these labels does:</p>
<ul>
<li><code>traefik.http.routers.adminer.rule=Host(`````blog.your_domain`````)</code> creates a new <em>router</em> for your container and then specifies the routing rule used to determine if a request matches this container.</li>
<li><code>traefik.routers.custom_name.tls=true</code> specifies that this router should use TLS.</li>
<li><code>traefik.routers.custom_name.tls.certResolver=lets-encrypt</code> specifies that the certificates resolver that you created earlier called <code>lets-encrypt</code> should be used to get a certificate for this route.</li>
<li><code>traefik.port</code> specifies the exposed port that Traefik should use to route traffic to this container.</li>
</ul>
<p>With this configuration, all traffic sent to your Docker host on port <code>80</code> or <code>443</code> with the domain of <code>blog.your_domain</code> will be routed to the <code>blog</code> container.</p>
<p>You assign this container to two different networks so that Traefik can find it via the <code>web</code> network and it can communicate with the database container through the <code>internal</code> network.</p>
<p>Lastly, the <code>depends_on</code> key tells Docker Compose that this container needs to start <em>after</em> its dependencies are running. Since WordPress needs a database to run, you must run your <code>mysql</code> container before starting your <code>blog</code> container.</p>
<p>Next, configure the MySQL service:</p>
<p>docker-compose.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span>
<span class="token punctuation">...</span>
  <span class="token key atrule">mysql</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> internal
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> traefik.enable=false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>You’re using the official MySQL 5.7 image for this container. You’ll notice that you’re once again using an <code>environment</code> item without a value. The <code>MYSQL_ROOT_PASSWORD</code> and <code>WORDPRESS_DB_PASSWORD</code> variables will need to be set to the same value to make sure that your WordPress container can communicate with the MySQL. You don’t want to expose the <code>mysql</code> container to Traefik or the outside world, so you’re only assigning this container to the <code>internal</code> network. Since Traefik has access to the Docker socket, the process will still expose a router for the <code>mysql</code> container by default, so you’ll add the label <code>traefik.enable=false</code> to specify that Traefik should not expose this container.</p>
<p>Finally, define the Adminer container:</p>
<p>docker-compose.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span>
<span class="token punctuation">...</span>
  <span class="token key atrule">adminer</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> adminer<span class="token punctuation">:</span>4.6.3<span class="token punctuation">-</span>standalone
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> traefik.http.routers.adminer.rule=Host(`db<span class="token punctuation">-</span>admin.your_domain`)
      <span class="token punctuation">-</span> traefik.http.routers.adminer.tls=true
      <span class="token punctuation">-</span> traefik.http.routers.adminer.tls.certresolver=lets<span class="token punctuation">-</span>encrypt
      <span class="token punctuation">-</span> traefik.port=8080
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> internal
      <span class="token punctuation">-</span> web
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mysql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>This container is based on the official Adminer image. The <code>network</code> and <code>depends_on</code> configuration for this container exactly match what you’re using for the <code>blog</code> container.</p>
<p>The line <code>traefik.http.routers.adminer.rule=Host(`````db-admin.your_domain`````)</code> tells Traefik to examine the host requested. If it matches the pattern of <code>db-admin.your_domain</code>, Traefik will route the traffic to the <code>adminer</code> container over port <code>8080</code>.</p>
<p>Your completed <code>docker-compose.yml</code> file will look like this:</p>
<p>docker-compose.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3"</span>

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">web</span><span class="token punctuation">:</span>
    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">internal</span><span class="token punctuation">:</span>
    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">blog</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">:</span>4.9.8<span class="token punctuation">-</span>apache
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">WORDPRESS_DB_PASSWORD</span><span class="token punctuation">:</span>
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> traefik.http.routers.blog.rule=Host(`blog.your_domain`)
      <span class="token punctuation">-</span> traefik.http.routers.blog.tls=true
      <span class="token punctuation">-</span> traefik.http.routers.blog.tls.certresolver=lets<span class="token punctuation">-</span>encrypt
      <span class="token punctuation">-</span> traefik.port=80
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> internal
      <span class="token punctuation">-</span> web
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mysql

  <span class="token key atrule">mysql</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> internal
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> traefik.enable=false

  <span class="token key atrule">adminer</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> adminer<span class="token punctuation">:</span>4.6.3<span class="token punctuation">-</span>standalone
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> traefik.http.routers.adminer.rule=Host(`db<span class="token punctuation">-</span>admin.your_domain`)
      <span class="token punctuation">-</span> traefik.http.routers.adminer.tls=true
      <span class="token punctuation">-</span> traefik.http.routers.adminer.tls.certresolver=lets<span class="token punctuation">-</span>encrypt
      <span class="token punctuation">-</span> traefik.port=8080
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> internal
      <span class="token punctuation">-</span> web
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mysql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Save the file and exit the text editor.</p>
<p>Next, set values in your shell for the <code>WORDPRESS_DB_PASSWORD</code> and <code>MYSQL_ROOT_PASSWORD</code> variables:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">WORDPRESS_DB_PASSWORD</span><span class="token operator">=</span>secure_database_password
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>secure_database_password<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Substitute <code>secure_database_password</code> with your desired database password. Remember to use the same password for both <code>WORDPRESS_DB_PASSWORD</code> and <code>MYSQL_ROOT_PASSWORD</code>.</p>
<p>With these variables set, run the containers using <code>docker-compose</code>:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker-compose</span> up -d<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Now watch the Traefik admin dashboard while it populates.</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1420211014200110.png" alt="Populated Traefik dashboard"></p>
<p>If you explore the <strong>Routers</strong> section you will find routers for <code>adminer</code> and <code>blog</code> configured with TLS:</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1420211014200142.png" alt="HTTP Routers w/ TLS"></p>
<p>Navigate to <code>blog.your_domain</code>, substituting <code>your_domain</code> with your domain. You’ll be redirected to a TLS connection and you can now complete the WordPress setup:</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1420211014200114.png" alt="WordPress setup screen"></p>
<p>Now access Adminer by visiting <code>db-admin.your_domain</code> in your browser, again substituting <code>your_domain</code> with your domain. The <code>mysql</code> container isn’t exposed to the outside world, but the <code>adminer</code> container has access to it through the <code>internal</code> Docker network that they share using the <code>mysql</code> container name as a hostname.</p>
<p>On the Adminer login screen, enter <code>root</code> for <strong>Username</strong>, enter <code>mysql</code> for <strong>Server</strong>, and enter the value you set for <code>MYSQL_ROOT_PASSWORD</code> for the <strong>Password</strong>. Leave <strong>Database</strong> empty. Now press <strong>Login</strong>.</p>
<p>Once logged in, you’ll see the Adminer user interface.</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1420211014200132.png" alt="Adminer connected to the MySQL database"></p>
<p>Both sites are now working, and you can use the dashboard at <code>monitor.your_domain</code> to keep an eye on your applications.</p>
<h2 id="Conclusion">Conclusion</h2>
<p>In this tutorial, you configured Traefik v2 to proxy requests to other applications in Docker containers.</p>
<p>Traefik’s declarative configuration at the application container level makes it easy to configure more services, and there’s no need to restart the <code>traefik</code> container when you add new applications to proxy traffic to since Traefik notices the changes immediately through the Docker socket file it’s monitoring.</p>
<p>To learn more about what you can do with Traefik v2, head over to <a target="_blank" rel="noopener" href="https://doc.traefik.io/traefik/">the official Traefik documentation</a>.</p>
<h2 id="服务集群">服务集群</h2>
<blockquote>
<p>k8s 太重了,虽然也有 k3s 之类的轻量级 k8s 解决方案，不过我还是选择了原生的 docker swarm。VPS 安装好 Docker 之后，不需要额外安装软件，就可以马上建立集群。</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 集群初始化，节点成为 manager 节点</span>
<span class="token function">docker</span> swarm init --advertise-addr<span class="token operator">=</span>x.x.x.x

<span class="token comment"># 集群丢失 Leader 时，强制重建集群</span>
<span class="token function">docker</span> swarm init --advertise-addr<span class="token operator">=</span>x.x.x.x --force-new-cluster

<span class="token comment"># 获取作为 worker 节点加入集群的命令</span>
<span class="token function">docker</span> swarm join-token worker

<span class="token comment"># 获取作为 manager 节点加入集群的命令</span>
<span class="token function">docker</span> swarm join-token manager

<span class="token comment"># 加入集群</span>
<span class="token function">docker</span> swarm <span class="token function">join</span> --token xxx x.x.x.x:xxx --advertise-addr<span class="token operator">=</span>x.x.x.x
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="参考：-3">参考：</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-use-traefik-v2-as-a-reverse-proxy-for-docker-containers-on-ubuntu-20-04">digitalocean</a></li>
<li><a target="_blank" rel="noopener" href="https://shanyue.tech/op/traefik.html">shanyue</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>web</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>traefik</tag>
        <tag>proxy</tag>
        <tag>swarm</tag>
        <tag>ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title>第一次使用VS CODE时你应该指导的一切配置</title>
    <url>/posts/44557ab0/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="前言-2">前言</h2>
<blockquote>
<p>文章标题：《第一次使用 VS Code 时你应该知道的一切配置》。本文的最新内容，更新于 2021-10-09。大家完全不用担心这篇文章会过时，因为随着 VS Code 的版本更新和插件更新，本文也会随之更新。</p>
</blockquote>
<blockquote>
<p>本文的最新内容，也会在<a target="_blank" rel="noopener" href="https://github.com/qianguyihao/Web/blob/master/00-%E5%89%8D%E7%AB%AF%E5%B7%A5%E5%85%B7/01-VS%20Code%E7%9A%84%E4%BD%BF%E7%94%A8.md">GitHub</a>上同步更新，欢迎 star。</p>
</blockquote>
<p>VS Code 软件实在是太酷、太好用了，越来越多的新生代互联网民工正在使用它。</p>
<p>前端男神<strong>尤雨溪</strong>大大这样评价 VS Code：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201152.png" alt=""></p>
<p>有一点你可能会感到惊讶：VS Code 这款软件本身，是用 JavaScript 语言编写的（具体请自行查阅基于 JS 的 PC 客户端开发框架 <code>Electron</code>）。Jeff Atwood 在 2007 年提出了著名的 Atwood 定律：</p>
<blockquote>
<p><strong>任何能够用 JavaScript 实现的应用系统，最终都必将用 JavaScript 实现</strong>。</p>
</blockquote>
<p>Jeff Atwood 这个人是谁不重要（他是 Stack Overflow 网站的联合创始人），重要的是这条定律。</p>
<p>前端目前是处在春秋战国时代，各路英雄豪杰成为后浪，各种框架工具层出不穷，VS Code 软件无疑是大前端时代最骄傲的工具。</p>
<p>如果你是做前端开发（JavaScript 编程语言为主），则完全可以将 VS Code 作为「<strong>主力开发工具</strong>」。这款软件是为前端同学量身定制的，开箱即用。</p>
<p>如果你是做其他语言方向的开发，并且不需要太复杂的集成开发环境，那么，你可以把 VS Code 作为「<strong>代码编辑器</strong>」来使用，纵享丝滑。</p>
<p>甚至是一些写文档、写作的同学，也经常把 VS Code 作为 markdown <strong>写作工具</strong>，毫无违和感。</p>
<p>退而求其次，即便你不属于以上任何范畴，你还可以把 VS Code 当作最简单的<strong>文本编辑器</strong>来使用，完胜 Windows 系统自带的记事本。</p>
<p>写下这篇文章，是顺势而为。</p>
<h2 id="一、惊艳登场：VS-Code-的介绍">一、惊艳登场：VS Code 的介绍</h2>
<p>VS Code 的全称是 Visual Studio Code，是一款开源的、免费的、跨平台的、高性能的、轻量级的代码编辑器。它在性能、语言支持、开源社区方面，都做得很不错。</p>
<p>微软有两种软件：一种是 VS Code，一种是其他软件。</p>
<p>在2015年4月29日的微软Build开发者大会上，微软宣布推出 VS Code之后，这个轻量级的编辑器成为全球无数开发者们最喜爱的开发工具。VS Code基于开源且跨平台的理念，每月都会进行迭代，并提供每天发布的 insider 版本（insider是微软的一种公测计划，类似于国内软件所说的内测版）。它拥有至少几万个插件，生态极为活跃和丰富。</p>
<h3 id="IDE-与-编辑器的对比">IDE 与 编辑器的对比</h3>
<p>IDE 和编辑器是有区别的：</p>
<ul>
<li>
<p><strong>IDE</strong>（Integrated Development Environment，集成开发环境）：对代码有较好的智能提示和相互跳转，同时侧重于工程项目，对项目的开发、调试工作有较好的图像化界面的支持，因此比较笨重。比如 Eclipse 的定位就是 IDE。</p>
</li>
<li>
<p><strong>编辑器</strong>：要相对轻量许多，侧重于文本的编辑。比如 Sublime Text 的定位就是编辑器。再比如 Windows 系统自带的「记事本」就是最简单的编辑器。</p>
</li>
</ul>
<p>需要注意的是，VS Code 的定位是<strong>编辑器</strong>，而非 IDE ，但 VS Code 又比一般的编辑器的功能要丰富许多。可以这样理解：VS Code 的体量是介于编辑器和 IDE 之间。VS Code 的使命，是让开发者在编辑器里拥有 IDE 那样的开发体验。</p>
<p>VS Code流行起来之后，使用 Sublime Text、Atom 这类编辑器软件的人，自然就越来越少了。</p>
<h3 id="VS-Code-的特点">VS Code 的特点</h3>
<ul>
<li>跨平台：支持 MacOS、Windows 和 Linux 等多个平台。在这多种平台下，拥有一致的用户界面和开发体验。</li>
<li>开源：VS Code 的源代码以 MIT 协议开源。不仅代码开源，而且整个产品的开发计划和发布管理也都是开源的。VS Code团队每年都会在 GitHub 的Wiki上发布 <a target="_blank" rel="noopener" href="https://github.com/microsoft/vscode/wiki/Roadmap">Roadmap</a>，列出一整年的规划图。VS Code 软件的官方文档也托管在了 <a target="_blank" rel="noopener" href="https://github.com/Microsoft/vscode-docs">GitHub</a> 上。</li>
<li>自带终端、图形化的调试工具、Git 版本控制。</li>
<li>插件扩展：支持第三方插件，功能强大。既有中心化的插件市场，也可以直接在 VS Code里搜索你想要的插件。</li>
<li>生态：社区生态活跃且丰富，社区氛围浓厚。</li>
<li>自带  emmet：支持代码自动补全，快速生成简单的语法结构。要知道，这个功能在 Sublime Text中，得先安装插件才行。</li>
<li>语法支持：VS Code 自带了 JavaScript、TypeScript 和 Node.js 的<strong>语法支持</strong>，包括：<strong>语法高亮、代码智能提示和补全、括号匹配、颜色区分、代码片段提示</strong>等。也就是说，你在书写 JS 和 TS 时，这些语法支持都是自带的。其他的一些语言，你需要先安装相应的<strong>扩展包</strong>插件，就出现语法支持。</li>
<li>在修改配置方面，既有图形化的配置界面，也有 基于 JSON 文件的配置方式，满足不同人群的使用习惯。</li>
</ul>
<h3 id="前端利器之争：-VS-Code-与-WebStorm">前端利器之争： VS Code 与 WebStorm</h3>
<p>前端小白最喜欢问的一个问题是：哪个编辑器/IDE 好用？是 VS Code 还是 WebStorm （WebStorm 其实是 IntelliJ IDEA 的定制版）？我来做个对比：</p>
<ul>
<li>
<p><strong>哪个更酷</strong>：显然 VS Code 更酷。</p>
</li>
<li>
<p><strong>内存占用情况</strong>：根据我的观察，VS Code 是很占内存的（尤其是当你打开多个窗口的时候），但如果你的内存条够用，使用起来是不会有任何卡顿的感觉的。相比之下，IntelliJ IDEA 不仅非常占内存，而且还非常卡顿。如果你想换个既轻量级、又不占内存的编辑器，最好还是使用「Sublime Text」编辑器。</p>
</li>
<li>
<p><strong>使用比例</strong>：当然是 VS Code 更胜一筹。先不说别的，我就拿数据说话，我目前所在的研发团队有 200 人左右（120个后台、80个前端），他们绝大部分人都在用 VS Code 编码，妥妥的。</p>
</li>
</ul>
<p>所以，如果你以后还问这个问题，那就真有些掉底了。</p>
<h3 id="VS-Code-的技术栈、核心组件">VS Code 的技术栈、核心组件</h3>
<p>了解 VS Code的技术栈和核心组件，可以让我们对 VS Code 有更深入的认识。此小段，了解即可。</p>
<ul>
<li>开发框架：Electron。Electron可以使用 Node.js + JS这样的技术栈开发桌面GUI应用程序。</li>
<li>编辑器：Monaco Editor。Monaco Editor 是一款开源的在线代码编辑器，是 <strong>VS Code 浏览器版本</strong>的最核心组件。<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/88828576">#</a></li>
<li>编程语言：TypeScript。TypeScript 是  JavaScript的严格超集。TS 在JS的基础上添加了许多功能，引入了声明文件，而且支持类型扩展。TS 适合长期的、多人开发的大型项目开发。</li>
<li>让编辑器支持语言功能：Language Server Protocol （LSP） 语言服务协议。LSP是编辑器/IDE 与语言服务器之间的一种协议，通过 JSON-PRC 传输消息，可以让编辑器嵌入并支持各种编程语言。开发者可以在编辑器中使用各种语言来编写程序。</li>
<li>让编辑器支持调试功能：Debug Adapter Protocol（DAP）。DAP 是基于 JSON的协议，它抽象了开发工具与调试工具质检的通信。</li>
<li>集成终端：Xterm.js。VS Code的集成终端是基于开源项目 <a target="_blank" rel="noopener" href="https://github.com/xtermjs/xterm.js/">Xterm.js</a> 进行开发的。Xterm.js 是一个使用 TS 开发的终端组件。另外，Xterm.js 并不是直接下来下来就能用的终端应用，它只是一个前端组件，可以与 bash这样的进程进行连接，然后让用户通过  Xterm.js 进行交互。</li>
</ul>
<h3 id="VS-Code-的安装">VS Code 的安装</h3>
<ul>
<li>VS Code 官网：<a target="_blank" rel="noopener" href="https://code.visualstudio.com">https://code.visualstudio.com</a></li>
</ul>
<p>VS Code 的安装很简单，直接去官网下载安装包，然后双击安装即可。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201230.png" alt=""></p>
<p>上图中，直接点击 download，一键下载安装即可。</p>
<p>VS Code支持以下平台：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201146.png" alt=""></p>
<p>安装完成后的界面如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201237.png" alt=""></p>
<p>VS  Code被分为以下五个区域：</p>
<ul>
<li>编辑器</li>
<li>侧边栏</li>
<li>状态栏</li>
<li>活动栏</li>
<li>面板</li>
</ul>
<p>VS Code在功能上非常克制，只包含了大多数开发流程中所需要的基础模块，包括：编辑器、文件管理、窗口管理、首选项设置、终端等。</p>
<p>你需要根据具体需要安装额外的组件或者插件。比如说，如果开发TS项目，则需要安装 TS编译器、ESLint、TSLint等编译工具。如果开发C语言项目，则需要安装gcc、Clang等编辑工具。</p>
<h2 id="二、崭露锋芒：VS-Code-快捷键">二、崭露锋芒：VS Code 快捷键</h2>
<p>VS Code 用得熟不熟，首先就看你是否会用快捷键。以下列出的内容，都是常用快捷键，而加粗部分的快捷键，使用频率则非常高。</p>
<p>任何工具，掌握 20%的技能，足矣应对 80% 的工作。既然如此，你可能会问：那就只保留 20% 的特性，不久可以满足 80%的用户了吗？</p>
<p>但我想说的是：<strong>那从来都不是同样的 20%</strong>，每个人都会用到不同的功能。</p>
<p>掌握下面这些高频核心快捷键，你和你的工具，足矣露出锋芒。</p>
<h3 id="1、工作区快捷键">1、工作区快捷键</h3>
<table>
<thead>
<tr>
<th style="text-align:left">Mac 快捷键</th>
<th style="text-align:left">Win 快捷键</th>
<th style="text-align:left">作用</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>Cmd + Shift + P</strong></td>
<td style="text-align:left"><strong>Ctrl + Shift + P</strong>，F1</td>
<td style="text-align:left">显示命令面板</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><strong>Cmd + B</strong></td>
<td style="text-align:left"><strong>Ctrl + B</strong></td>
<td style="text-align:left">显示/隐藏侧边栏</td>
<td style="text-align:left">很实用</td>
</tr>
<tr>
<td style="text-align:left"><code>Cmd + \</code></td>
<td style="text-align:left"><code>Ctrl + \</code></td>
<td style="text-align:left"><strong>拆分为多个编辑器</strong></td>
<td style="text-align:left">【重要】抄代码利器</td>
</tr>
<tr>
<td style="text-align:left"><strong>Cmd + 1、2</strong></td>
<td style="text-align:left"><strong>Ctrl + 1、2</strong></td>
<td style="text-align:left">聚焦到第 1、第 2 个编辑器</td>
<td style="text-align:left">同上重要</td>
</tr>
<tr>
<td style="text-align:left"><strong>Cmd + +、Cmd + -</strong></td>
<td style="text-align:left"><strong>ctrl + +、ctrl + -</strong></td>
<td style="text-align:left">将工作区放大/缩小（包括代码字体、左侧导航栏）</td>
<td style="text-align:left">在投影仪场景经常用到</td>
</tr>
<tr>
<td style="text-align:left">Cmd + J</td>
<td style="text-align:left">Ctrl + J</td>
<td style="text-align:left">显示/隐藏控制台</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><strong>Cmd + Shift + N</strong></td>
<td style="text-align:left"><strong>Ctrl + Shift + N</strong></td>
<td style="text-align:left">重新开一个软件的窗口</td>
<td style="text-align:left">很常用</td>
</tr>
<tr>
<td style="text-align:left">Cmd + Shift + W</td>
<td style="text-align:left">Ctrl + Shift + W</td>
<td style="text-align:left">关闭软件的当前窗口</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Cmd + N</td>
<td style="text-align:left">Ctrl + N</td>
<td style="text-align:left">新建文件</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Cmd + W</td>
<td style="text-align:left">Ctrl + W</td>
<td style="text-align:left">关闭当前文件</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h3 id="2、跳转操作">2、跳转操作</h3>
<table>
<thead>
<tr>
<th style="text-align:left">Mac 快捷键</th>
<th style="text-align:left">Win 快捷键</th>
<th style="text-align:left">作用</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Cmd + `</td>
<td style="text-align:left">没有</td>
<td style="text-align:left">在同一个软件的<strong>多个工作区</strong>之间切换</td>
<td style="text-align:left">使用很频繁</td>
</tr>
<tr>
<td style="text-align:left"><strong>Cmd + Option + 左右方向键</strong></td>
<td style="text-align:left">Ctrl + Pagedown/Pageup</td>
<td style="text-align:left">在已经打开的<strong>多个文件</strong>之间进行切换</td>
<td style="text-align:left">非常实用</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Tab</td>
<td style="text-align:left">Ctrl + Tab</td>
<td style="text-align:left">在已经打开的多个文件之间进行跳转</td>
<td style="text-align:left">不如上面的快捷键快</td>
</tr>
<tr>
<td style="text-align:left">Cmd + Shift + O</td>
<td style="text-align:left">Ctrl + shift + O</td>
<td style="text-align:left">在当前文件的各种<strong>方法之间</strong>（符号：Symbol）进行跳转</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Cmd + T</td>
<td style="text-align:left">Ctrl + T</td>
<td style="text-align:left">在当前<strong>工作区</strong>的各种方法之间（符号：Symbol）进行跳转</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Ctrl + G</td>
<td style="text-align:left">Ctrl + G</td>
<td style="text-align:left">跳转到指定行</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><code>Cmd+Shift+\</code></td>
<td style="text-align:left"><code>Ctrl+Shift+\</code></td>
<td style="text-align:left">跳转到匹配的括号</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h3 id="3、移动光标">3、移动光标</h3>
<table>
<thead>
<tr>
<th style="text-align:left">Mac 快捷键</th>
<th style="text-align:left">Win 快捷键</th>
<th style="text-align:left">作用</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">方向键</td>
<td style="text-align:left">方向键</td>
<td style="text-align:left">在<strong>单个字符</strong>之间移动光标</td>
<td style="text-align:left">大家都知道</td>
</tr>
<tr>
<td style="text-align:left"><strong>option + 左右方向键</strong></td>
<td style="text-align:left"><strong>Ctrl + 左右方向键</strong></td>
<td style="text-align:left">在<strong>单词</strong>之间移动光标</td>
<td style="text-align:left">很常用</td>
</tr>
<tr>
<td style="text-align:left"><strong>Cmd + 左右方向键</strong></td>
<td style="text-align:left"><strong>Fn + 左右方向键</strong>（或 Win + 左右方向键）</td>
<td style="text-align:left">将光标定位到当前行的最左侧、最右侧（在<strong>整行</strong>之间移动光标）</td>
<td style="text-align:left">很常用</td>
</tr>
<tr>
<td style="text-align:left"><strong>Option + Alt + 左右方向键</strong></td>
<td style="text-align:left"><strong>Alt + Shift + 左右方向键</strong></td>
<td style="text-align:left">左右扩大/缩小选中的范围</td>
<td style="text-align:left">很酷，极为高效</td>
</tr>
<tr>
<td style="text-align:left">Cmd + ↑</td>
<td style="text-align:left">Ctrl + Home</td>
<td style="text-align:left">将光标定位到文件的第一行</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Cmd + ↓</td>
<td style="text-align:left">Ctrl + End</td>
<td style="text-align:left">将光标定位到文件的最后一行</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Cmd + Shift + \</td>
<td style="text-align:left"></td>
<td style="text-align:left">在<strong>代码块</strong>之间移动光标</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h3 id="4、编辑操作">4、编辑操作</h3>
<table>
<thead>
<tr>
<th style="text-align:left">Mac 快捷键</th>
<th style="text-align:left">Win 快捷键</th>
<th style="text-align:left">作用</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Cmd + C</td>
<td style="text-align:left">Ctrl + C</td>
<td style="text-align:left">复制</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Cmd + X</td>
<td style="text-align:left">Ctrl + X</td>
<td style="text-align:left">剪切</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Cmd + C</td>
<td style="text-align:left">Ctrl + V</td>
<td style="text-align:left">粘贴</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><strong>Cmd + Enter</strong></td>
<td style="text-align:left"><strong>Ctrl + Enter</strong></td>
<td style="text-align:left">在当前行的下方新增一行，然后跳至该行</td>
<td style="text-align:left">即使光标不在行尾，也能快速向下插入一行</td>
</tr>
<tr>
<td style="text-align:left">Cmd+Shift+Enter</td>
<td style="text-align:left">Ctrl+Shift+Enter</td>
<td style="text-align:left">在当前行的上方新增一行，然后跳至该行</td>
<td style="text-align:left">即使光标不在行尾，也能快速向上插入一行</td>
</tr>
<tr>
<td style="text-align:left"><strong>Option + ↑</strong></td>
<td style="text-align:left"><strong>Alt + ↑</strong></td>
<td style="text-align:left">将代码向上移动</td>
<td style="text-align:left">很常用</td>
</tr>
<tr>
<td style="text-align:left"><strong>Option + ↓</strong></td>
<td style="text-align:left"><strong>Alt + ↓</strong></td>
<td style="text-align:left">将代码向下移动</td>
<td style="text-align:left">很常用</td>
</tr>
<tr>
<td style="text-align:left">Option + Shift + ↑</td>
<td style="text-align:left">Alt + Shift + ↑</td>
<td style="text-align:left">将代码向上复制一行</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><strong>Option + Shift + ↓</strong></td>
<td style="text-align:left"><strong>Alt + Shift + ↓</strong></td>
<td style="text-align:left">将代码向下复制一行</td>
<td style="text-align:left">写重复代码的利器</td>
</tr>
</tbody>
</table>
<p>另外再补充一点：将光标点击到某一行的任意位置时，默认就已经是<strong>选中全行</strong>了，此时可以直接<strong>复制</strong>或<strong>剪切</strong>，无需点击鼠标。这个非常实用，是所有的编辑操作中，使用得最频繁的。它可以有以下使用场景：</p>
<ul>
<li>场景1：假设光标现在处于第5行的<strong>任意位置</strong>，那么，直接依次按下 <code>Cmd + C</code> 和 <code>Cmd + V</code>，就会把这行代码复制到第6行。继续按 <code>Cmd + C</code> 和 <code>Cmd + V</code>，就会把这行代码复制到第7行。copy代码so easy。</li>
<li>场景2：假设光标现在处于第5行，那么，先按下 <code>Cmd + C</code>，然后按两下<code>↑</code> 方向键，此时光标处于第3行；紧接着，继续按下<code>Cmd + V</code>，就会把刚刚那行代码复制到第3行，原本处于第3行的代码会整体<strong>下移</strong>。</li>
</ul>
<p>你看到了没？上面的两个场景，我全程没有使用鼠标，只通过简单的复制粘贴和方向键，就做到了如此迅速的copy代码。你说是不是很高效？</p>
<h3 id="5、删除操作">5、删除操作</h3>
<table>
<thead>
<tr>
<th style="text-align:left">Mac 快捷键</th>
<th style="text-align:left">Win 快捷键</th>
<th style="text-align:left">作用</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Cmd + shift + K</td>
<td style="text-align:left">Ctrl + Shift + K</td>
<td style="text-align:left">删除整行</td>
<td style="text-align:left">「Cmd + X」的作用是剪切，但也可以删除整行</td>
</tr>
<tr>
<td style="text-align:left"><strong>option + Backspace</strong></td>
<td style="text-align:left"><strong>Ctrl + Backspace</strong></td>
<td style="text-align:left">删除光标之前的一个单词</td>
<td style="text-align:left">英文有效，很常用</td>
</tr>
<tr>
<td style="text-align:left">option + delete</td>
<td style="text-align:left">Ctrl + delete</td>
<td style="text-align:left">删除光标之后的一个单词</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><strong>Cmd + Backspace</strong></td>
<td style="text-align:left"></td>
<td style="text-align:left">删除光标之前的整行内容</td>
<td style="text-align:left">很常用</td>
</tr>
<tr>
<td style="text-align:left">Cmd + delete</td>
<td style="text-align:left"></td>
<td style="text-align:left">删除光标之后的整行内容</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<p>备注：上面所讲到的移动光标、编辑操作、删除操作的快捷键，在其他编辑器里，大部分都适用。</p>
<h3 id="6、多光标选择-多光标编辑">6、多光标选择/多光标编辑</h3>
<p>多光标选择在编程的<strong>提效</strong>方面可谓立下了汗马功劳。因为比较难记住，所以你要时不时回来复习这一段。</p>
<table>
<thead>
<tr>
<th>Mac 快捷键</th>
<th>Win 快捷键</th>
<th>作用</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Option + 鼠标连续点击任意位置</strong></td>
<td><strong>Alt + 鼠标连续点击任意位置</strong></td>
<td>在任意位置，同时出现多个光标</td>
<td>很容易记住</td>
</tr>
<tr>
<td>Cmd + D</td>
<td>Ctrl + D</td>
<td>将光标放在某个单词的位置（或者先选中某个单词），然后反复按下「 <strong>Cmd + D</strong> 」键， 即可将下一个相同的词逐一加入选择。</td>
<td>较常用</td>
</tr>
<tr>
<td><strong>Cmd + Shift + L</strong></td>
<td><strong>Ctrl + Shift + L</strong></td>
<td>将光标放在某个单词的位置（或者先选中某个单词），然后按下快捷键，则所有的相同内容处，都会出现光标。</td>
<td>很常用。比如变量重命名的时候，就经常用到</td>
</tr>
</tbody>
</table>
<h3 id="7、多列选择-多列编辑">7、多列选择/多列编辑</h3>
<p>多列选择是更高效的多光标选择，所以单独列成一小段。</p>
<table>
<thead>
<tr>
<th>Mac 快捷键</th>
<th>Win 快捷键</th>
<th>作用</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cmd + Option + 上下键</td>
<td>Ctrl + Alt + 上下键</td>
<td>在连续的多列上，同时出现多个光标</td>
<td>较常用</td>
</tr>
<tr>
<td>Option + Shift + 鼠标拖动</td>
<td>Alt + Shift + 鼠标拖动</td>
<td>按住快捷键，然后把鼠标从区域的左上角拖至右下角，即可在选中区域的每一行末尾，出现光标。</td>
<td>很神奇的操作，较常用</td>
</tr>
<tr>
<td><strong>Option + Shift + i</strong></td>
<td><strong>Alt + Shift + I</strong></td>
<td>选中一堆文本后，按下快捷键，既可在<strong>每一行的末尾</strong>都出现一个光标。</td>
<td>很常用</td>
</tr>
</tbody>
</table>
<h3 id="8、编程语言相关">8、编程语言相关</h3>
<table>
<thead>
<tr>
<th style="text-align:left">Mac 快捷键</th>
<th style="text-align:left">Win 快捷键</th>
<th style="text-align:left">作用</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Cmd + /</td>
<td style="text-align:left">Ctrl + /</td>
<td style="text-align:left">添加单行注释</td>
<td style="text-align:left">很常用</td>
</tr>
<tr>
<td style="text-align:left"><strong>Option + Shift + F</strong></td>
<td style="text-align:left">Alt + shift + F</td>
<td style="text-align:left">代码格式化</td>
<td style="text-align:left">很常用</td>
</tr>
<tr>
<td style="text-align:left">F2</td>
<td style="text-align:left">F2</td>
<td style="text-align:left">以重构的方式进行<strong>重命名</strong></td>
<td style="text-align:left">改代码备</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + J</td>
<td style="text-align:left"></td>
<td style="text-align:left">将多行代码合并为一行</td>
<td style="text-align:left">Win 用户可在命令面板搜索”合并行“</td>
</tr>
<tr>
<td style="text-align:left">Cmd +</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Cmd + U</td>
<td style="text-align:left">Ctrl + U</td>
<td style="text-align:left">将光标的移动回退到上一个位置</td>
<td style="text-align:left">撤销光标的移动和选择</td>
</tr>
</tbody>
</table>
<h3 id="9、搜索相关">9、搜索相关</h3>
<table>
<thead>
<tr>
<th style="text-align:left">Mac 快捷键</th>
<th style="text-align:left">Win 快捷键</th>
<th style="text-align:left">作用</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>Cmd + Shift + F</strong></td>
<td style="text-align:left"><strong>Ctrl + Shift +F</strong></td>
<td style="text-align:left">全局搜索代码</td>
<td style="text-align:left">很常用</td>
</tr>
<tr>
<td style="text-align:left"><strong>Cmd + P</strong></td>
<td style="text-align:left"><strong>Ctrl + P</strong></td>
<td style="text-align:left">在当前的项目工程里，<strong>全局</strong>搜索文件名</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Cmd + F</td>
<td style="text-align:left">Ctrl + F</td>
<td style="text-align:left">在当前文件中搜索代码，光标在搜索框里</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><strong>Cmd + G</strong></td>
<td style="text-align:left"><strong>F3</strong></td>
<td style="text-align:left">在当前文件中搜索代码，光标仍停留在编辑器里</td>
<td style="text-align:left">很巧妙</td>
</tr>
</tbody>
</table>
<h3 id="10、自定义快捷键">10、自定义快捷键</h3>
<p>按住快捷键「Cmd + Shift + P」，弹出命令面板，在命令面板中输入“快捷键”，可以进入快捷键的设置。</p>
<p>当然，你也可以选择菜单栏「偏好设置 --&gt; 键盘快捷方式」，进入快捷键的设置：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201244.png" alt=""></p>
<h3 id="11、快捷键列表">11、快捷键列表</h3>
<p>你可以点击 VS Code 左下角的齿轮按钮，效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201139.png" alt=""></p>
<p>上图中，在展开的菜单中选择「键盘快捷方式」，就可以查看和修改所有的快捷键列表了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201333.png" alt=""></p>
<h3 id="快捷键参考表（官方）">快捷键参考表（官方）</h3>
<p>VS Code官网提供了 PDF版本的键盘快捷键参考表，转需：</p>
<ul>
<li>Windows版本：https://code.visualstudio.com/shortcuts/keyboard-shortcuts-windows.pdf</li>
<li>Mac 版本：https://code.visualstudio.com/shortcuts/keyboard-shortcuts-macos.pdf</li>
<li>Linux版本：https://code.visualstudio.com/shortcuts/keyboard-shortcuts-linux.pdf</li>
</ul>
<p>我们在 VS  Code软件里通过菜单栏「帮助--&gt;键盘快捷方式参考」也可以打开相应平台的快捷键大全（PDF版本）。</p>
<h2 id="三、高端访问：命令面板的使用">三、高端访问：命令面板的使用</h2>
<p>Mac 用户按住快捷键 <code>Cmd+Shift+P</code> （Windows 用户按住快捷键<code>Ctrl+Shift+P</code>），可以打开快速命令面板。效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201339.png" alt=""></p>
<p>命令面板的作用是<strong>希望解放开发者的鼠标，让一些操作和配置可以直接通过键盘进行</strong>。如果让开发者记住所有的配置项在菜单的哪个位置是不现实的，而且有些命令并不在菜单中。</p>
<p>有了命令面板之后，如果你需要修改一些设置项，或者进行一些快捷操作，则可以通过「命令面板」来操作，效率会更高。接下来列举一些。</p>
<h3 id="1、VS-Code-设置为中文语言">1、VS Code 设置为中文语言</h3>
<p>Mac 用户按住快捷键 <code>Cmd+Shift+P</code> （Windows 用户按住快捷键<code>Ctrl+Shift+P</code>），打开命令面板。</p>
<p>在命令面板中，输入<code>Configure Display Language</code>，选择<code>Install additional languages</code>，然后安装插件<code>Chinese (Simplified) Language Pack for Visual Studio Code</code>即可。</p>
<p>或者，我们可以直接安装插件<code>Chinese (Simplified) Language Pack for Visual Studio Code</code>，是一样的。</p>
<p>安装完成后，重启 VS Code。</p>
<h3 id="2、设置字体大小">2、设置字体大小</h3>
<p>在命令面板输入“字体”，可以进行字体的设置，效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201251.png" alt=""></p>
<p>当然，你也可以在菜单栏，选择「首选项-设置-常用设置」，在这个设置项里修改字体大小。</p>
<h3 id="3、快捷键设置">3、快捷键设置</h3>
<p>在命令面板输入“快捷键”，就可以进入快捷键的设置。</p>
<h3 id="4、大小写转换">4、大小写转换</h3>
<p>选中文本后，在命令面板中输入<code>transfrom</code>，就可以修改文本的大小写了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201132.png" alt=""></p>
<h3 id="5、使用命令行启动-VS-Code">5、使用命令行启动 VS Code</h3>
<p>（1）输入快捷键「Cmd + Shift + P 」，选择<code>install code command</code>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201258.png" alt=""></p>
<p>（2）使用命令行：</p>
<ul>
<li><code>code</code>命令：启动 VS Code 软件</li>
<li><code>code pathName/fileName</code>命令：通过 VS Code 软件打开指定目录/指定文件。</li>
</ul>
<p>备注：这种方法快捷简单，但是在电脑重启之后就失效了。稍后在第五段，我会介绍更常见的方法。</p>
<h3 id="6、修改特定编程语言的设置项">6、修改特定编程语言的设置项</h3>
<p>输入快捷键「Cmd + Shift + P 」打开命令面板，然后输入并执行 <code>Configure Language Specific Settings</code>即可。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201304.png" alt=""></p>
<h2 id="四、私人订制：VS-Code-的常见配置">四、私人订制：VS Code 的常见配置</h2>
<h3 id="0、设置项介绍">0、设置项介绍</h3>
<p>在修改 VS Code配置之前，我们需要知道，在哪里可以找到设置项的入口。</p>
<p><strong>方式1</strong>：Mac用户选择菜单栏「Code--&gt; 首选项--&gt;设置」，即可打开配置项：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201346.png" alt=""></p>
<p><strong>方式2</strong>：点击软件右下角的设置图标：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201347.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201125.png" alt=""></p>
<p>如上图所示，VS Code提供两种不同范围的设置：</p>
<ul>
<li><strong>用户</strong>设置：全局生效。</li>
<li><strong>工作区</strong>设置：只针对当前项目生效。工作区设置会覆盖用户设置。适用于团队协作场景。工作区的设置文件是保存在当前项目根目录的<code>.vscode/settings.json</code>中，可以被提交到Git仓库，方便共享给项目组的其他成员。</li>
</ul>
<p>操作技巧：</p>
<p>（1）我们可以在设置面板的顶部搜索框，输入关键词，就能迅速定位到你想要的设置项。</p>
<p>（2）上图中，点击右上角的icon，可以通过 json文件的形式修改设置项。</p>
<h3 id="1、修改主题">1、修改主题</h3>
<p>1）修改颜色主题：</p>
<p>选择菜单栏「Code --&gt; 首选项 --&gt; 颜色主题」：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201353.png" alt=""></p>
<p>在弹出的对话框中，挑选你一个你喜欢的的颜色主题吧，或者安装其他颜色的主题：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201119.png" alt="20211013_1018"></p>
<p>或者在设置项里搜索<code>Workbench: Color Theme</code>，进行修改。</p>
<p>2）修改文件图标的主题：</p>
<p>选择菜单栏「Code --&gt; 首选项 --&gt; 文件图标主题」：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201113.png" alt="20211013_1015"></p>
<p>在弹出的对话框中，挑选你一个你喜欢的的主题吧，或者安装其他的主题：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201112.png" alt="20211013_1019"></p>
<p>或者在设置项里搜索<code>Workbench: Icon Theme</code>，进行修改。</p>
<h3 id="2、面包屑（Breadcrumb）导航">2、面包屑（Breadcrumb）导航</h3>
<p>打开 VS Code 的设置项，选择「用户设置 -&gt; 工作台 -&gt; 导航路径」，如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201400.png" alt=""></p>
<p>上图中，将红框部分打钩即可。</p>
<p>设置成功后，我们就可以查看到当前文件的「层级结构」，非常方便。如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201106.png" alt=""></p>
<p>有了这个面包屑导航，我们可以点击它，在任意目录、任意文件之间随意跳转。使用频繁非常高。</p>
<h3 id="3、是否显示代码的行号">3、是否显示代码的行号</h3>
<p>VS Code 默认显示代码的行号。你可以在设置项里搜索 <code>editor.lineNumbers</code>修改设置，配置项如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201105.png" alt=""></p>
<p>我建议保留这个设置项，无需修改。</p>
<h3 id="4、右侧是否显示代码的缩略图">4、右侧是否显示代码的缩略图</h3>
<p>如果某个文件的代码量很大，缩略图就很有用了，可以预览全局，并在当前文件中快速跳转。</p>
<p>VS Code 会在代码的右侧，默认显示缩略图。你可以在设置项里搜索 <code>editor.minimap</code> 进行设置，配置项如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201407.png" alt=""></p>
<p>上面这张图，你仔细琢磨下会发现，中文翻译十分精准。</p>
<h3 id="5、将当前行代码高亮显示（更改光标所在行的背景色）">5、将当前行代码高亮显示（更改光标所在行的背景色）</h3>
<p>当我们把光标放在某一行时，这一行的背景色并没有发生变化。如果想<strong>高亮显示</strong>当前行的代码，需要设置两步：</p>
<p>（1）在设置项里搜索<code>editor.renderLineHighlight</code>，将选项值设置为<code>all</code>或者<code>line</code>。</p>
<p>（2）在设置项里增加如下内容：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"workbench.colorCustomizations"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"editor.lineHighlightBackground"</span><span class="token operator">:</span> <span class="token string">"#00000090"</span><span class="token punctuation">,</span>
    <span class="token property">"editor.lineHighlightBorder"</span><span class="token operator">:</span> <span class="token string">"#ffffff30"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>上方代码，第一行代码的意思是：修改光标所在行的背景色（背景色设置为全黑，不透明度 90%）；第二行代码的意思是：修改光标所在行的边框色。</p>
<h3 id="6、改完代码后立即自动保存">6、改完代码后立即自动保存</h3>
<p><strong>方式一</strong>：</p>
<p>改完代码后，默认不会自动保存。你可以在设置项里搜索<code>files.autoSave</code>，修改参数值为<code>afterDelay</code>  ，即可自动保存。如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201514.png" alt=""></p>
<p>files.autoSave的参数值有以下几种：</p>
<ul>
<li>off（默认值）：不自动保存。</li>
<li>afterDelay（建议配置）：文件修改超过一定时间（默认1秒）后，就自动保存。</li>
<li>onFocusChange：当前编辑器失去焦点时，则自动保存。如果我们将配置项修改为<code>onFocusChange</code>之后，那么，当光标离开该文件后，这个文件就会自动保存了。</li>
<li>onWindowChange：VS  Code软件失去焦点时，则自动保存。</li>
</ul>
<p><strong>方式二</strong>：</p>
<p>当然，你也可以直接在菜单栏选择「文件-自动保存」。勾选后，当你写完代码后，文件会立即实时保存。</p>
<h3 id="7、热退出">7、热退出</h3>
<p>当VS Code退出后，它可以记住未保存的文件。如果你希望达到这种效果，那么，你需要先将设置项<code>files.hotExit</code>的值改为 <code>onExitAndWindowClose</code>。这个配置项要不要改，看你个人需要。比如我自己平时设置的值是<code>onExit</code>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201413.png" alt="20211012_2014"></p>
<h3 id="8、保存代码后，是否立即格式化">8、保存代码后，是否立即格式化</h3>
<p>保存代码后，默认<strong>不会立即</strong>进行代码的格式化。你可以在设置项里搜索<code>editor.formatOnSave</code>查看该配置项：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201058.png" alt=""></p>
<p>我觉得这个配置项保持默认就好，不用打钩。</p>
<h3 id="9、自动格式化粘贴的内容">9、自动格式化粘贴的内容</h3>
<p>在设置项里搜索 <code>editor.formatOnPaste</code>，将设置项改为<code>true</code>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201059.png" alt="20211012_1049"></p>
<h3 id="10、设置字体大小">10、设置字体大小</h3>
<p>在设置项里搜索<code>fontSize</code>，然后根据需要设置各种模块的字体大小：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201420.png" alt="20211012_1053"></p>
<h3 id="11、空格-or-制表符">11、空格 or 制表符</h3>
<p>VS Code 会根据你所打开的文件来决定该使用空格还是制表。也就是说，如果你的项目中使用的都是制表符，那么，当你在写新的代码时，按下 tab 键后，编辑器就会识别成制表符。</p>
<p>（1）建议的设置项如下：</p>
<ul>
<li><strong>editor.detectIndentation</strong>：自动检测（默认开启）。建议把这个配置项修改为 false，截图如下：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201052.png" alt="20211012_1139"></p>
<p>这样做，是为了取消系统的自动缩进，建议自己手动格式化比较好。 参考链接：https://www.yisu.com/zixun/327399.html</p>
<ul>
<li><strong>editor.insertSpaces</strong>：按 Tab 键时插入空格（默认值为true）。截图如下：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201523.png" alt=""></p>
<ul>
<li><strong>editor.tabSize</strong>：一个制表符默认等于四个空格。截图如下：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201530.png" alt=""></p>
<p>（2）状态栏也会显示当前的缩进值。点击状态栏，可以直接修改 tabSize 缩进值：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201045.png" alt=""></p>
<p>（3）另外，我们还可以安装 prettier 插件，设置代码在格式化时默认缩进值。prettier 是做代码格式化的最常见工具。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201536.png" alt=""></p>
<p>（4）去掉每一行末尾的空格。在设置项里搜索<code>空格</code>或者<code>"files.trimTrailingWhitespace"</code>，将值设置为 true：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201858.png" alt="20211012_1231"></p>
<p>一般来说，每一行代码末尾的空格是多余的，所以建议去掉。</p>
<h3 id="12、直观地显示代码里的空格和缩进-✨">12、直观地显示代码里的空格和缩进 ✨</h3>
<p>代码里如果有缩进或者空格，肉眼是看不出来的，但是我们可以修改配置项，把它揪出来。</p>
<p>在配置项里搜索<code>editor.renderWhitespace</code>，修改为<code>all</code>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201039.png" alt="20211012_1150"></p>
<p>修改之后，代码里的空格、缩进的展示效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201905.png" alt="20211012_1258"></p>
<p>看到了没？哪里有空格、哪里是缩进，全都一目了然。</p>
<h3 id="13、新建文件后的默认文件类型">13、新建文件后的默认文件类型</h3>
<p>当我们按下快捷键「Cmd + N」新建文件时，VS Code 默认无法识别这个文件到底是什么类型的，因此也就无法识别相应的语法高亮。</p>
<p>如果你想修改默认的文件类型，可以在设置项里搜索<code>files.defaultLanguage</code>，设置项如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201542.png" alt=""></p>
<p>上图中的红框部分，填入你期望的默认文件类型。我填的是<code>html</code>类型，你也可以填写成 <code>javascript</code> 或者 <code>markdown</code>，或者其他的语言类型。</p>
<h3 id="14、删除文件时，是否弹出确认框">14、删除文件时，是否弹出确认框</h3>
<p>当我们在 VS Code 中删除文件时，默认会弹出确认框。如果你想修改设置，可以在设置项里搜索<code>xplorer.confirmDelete</code>。截图如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201032.png" alt=""></p>
<p>我建议这个设置项保持默认的打钩就好，不用修改。删除文件前的弹窗提示，也是为了安全考虑，万一手贱不小心删了呢？</p>
<h3 id="15、在新窗口打开文件-文件夹">15、在新窗口打开文件/文件夹</h3>
<p>通过 <code>window.openFoldersInNewWindow</code>（默认值为off）和<code>window.openFilesInNewWindow</code>（默认值为default），可以配置在打开文件夹、打开文件时，是否开启一个新的窗口。我个人建议，把这两个配置项都设置为 on，避免旧的窗口被覆盖：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201549.png" alt=""></p>
<p>补充知识—— <code>window.restoreWindows</code>可以用来配置 如何恢复之前的会话窗口。涉及到的场景是：你把 VS Code 关闭了，然后又打开了，是否要展示之前打开过的文件、文件夹？参数值有以下几种：</p>
<ul>
<li>one（默认配置）：只会重新打开上一次回话中最后操作的那一个窗口。</li>
<li>none：打开一个空的窗口，不包含任何文件、文件夹。</li>
<li>all（建议配置）：恢复上一次会话中的所有窗口。</li>
<li>folders：恢复上一次会话中包含文件夹的窗口。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201026.png" alt="20211012_1704"></p>
<blockquote>
<p>接下来，我们来讲一些更高级的操作。</p>
</blockquote>
<h2 id="五、纵享丝滑：常见操作和使用技巧">五、纵享丝滑：常见操作和使用技巧</h2>
<h3 id="1、快速生成HTML骨架">1、快速生成HTML骨架</h3>
<p>先新建一个空的html文件，然后通过以下方式，可以快速生成html骨架。</p>
<p><strong>方式1</strong>：输入<code>!</code>，然后按下<code>enter</code>键，即可生成html骨架。如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201555.gif" alt=""></p>
<p><strong>方式2</strong>：输入<code>html:5</code>，然后按住 <code>Tab</code>键，即可生成html骨架。</p>
<p>生成的骨架，内容如下：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>有了上面的html骨架之后，我们就可以快乐地在里面插入CSS 代码和 JS 代码。</p>
<h3 id="2、并排编辑：左右（上下）显示多个编辑器窗口（copy代码利器）">2、并排编辑：左右（上下）显示多个编辑器窗口（copy代码利器）</h3>
<blockquote>
<p>并排编辑是所有的编辑操作中最常用的一个技巧，十分有用。比如我们在开发一个项目时，可能需要同时打开 HTML 文件和 CSS 文件，很常见。</p>
</blockquote>
<p>Mac 用户按住快捷键 <code>Cmd + \</code>， Windows 用户按住快捷键<code>Ctrl + \</code>，即可同时打开多个编辑器窗口，进行并排编辑。效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201020.gif" alt=""></p>
<p>按快捷键「Cmd + 1 」切换到左边的窗口，按快捷键「Cmd + 2 」切换到右边的窗口，以此类推。随时随地，想切就切。</p>
<p>学会了这一招，以后 copy 代码的时候，leader 再也不用担心我抄得慢了，一天工资到手。</p>
<hr>
<p>当然，使用快捷键<code>Cmd + \</code>只是其中一种方式，我们还有很多种方式打开并行编辑。我们来做一个汇总。</p>
<p>如果你已经打开了一个编辑器，那么可以通过以下几种方式在另一侧打开另一个编辑器：（按照使用频率，从高到低排序）</p>
<ul>
<li>使用快捷键<code>Cmd + \</code>将编辑器一分为二。</li>
<li>使用快捷键<code>Cmd + P</code>调出文件列表，选择要打开的文件，然后按下 <code>Cmd + Enter</code>快捷键。【重要】</li>
<li>按住 Option 键的同时，单击资源管理器的文件（Windows 用户是按 Alt 键）。</li>
<li>点击编辑器右上角的 <code>Split Editor</code>按钮。</li>
<li>选择菜单栏「查看--&gt; 编辑器布局」，然后选择你具体想要的布局，如下图所示：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201602.png" alt="20211012_1451"></p>
<ul>
<li>通过拖拽，把当前文件移动到任意一侧。</li>
</ul>
<p>补充知识：通过配置项<code>worbench.editor.OpenSideBySideDirection</code>可以控制编辑器在并排打开时出现的默认位置（默认值为right，你也可以根据需要改为 down）。如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201019.png" alt="20211012_1455"></p>
<h3 id="3、从终端-code-命令启动-VS-Code（Mac电脑）">3、从终端 code 命令启动 VS Code（Mac电脑）</h3>
<p>在终端输入<code>code</code>或者输入 <code>code + 指定项目的目录</code>，就可以启动 VS  Code，十分便捷。即：</p>
<ul>
<li><code>code</code> 命令：启动 VS Code 软件。</li>
<li><code>code pathName/fileName</code> 命令：通过 VS Code 软件打开指定目录/指定文件。</li>
</ul>
<p>为了达到目的，我们需要先将 VS Code的软件安装路径添加到环境变量，一劳永逸。具体操作如下：</p>
<p>（1）打开 <code>bash_profile</code>文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~
<span class="token function">vim</span> ./bash_profile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>（2）在 bash_profile 中添加如下内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 从终端启动VS Code，并设置vscode启动的命令别名</span>
<span class="token builtin class-name">alias</span> <span class="token assign-left variable">code</span><span class="token operator">=</span><span class="token string">"/Applications/Visual\ Studio\ Code.app/Contents/Resources/app/bin/code"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>注意，由于<code>Visual Studio Code.app</code>这个路径里有空格，所以需要在空格前面加上反斜杠<code>\</code>。</p>
<p>（3）重启环境变量的配置：</p>
<pre class="line-numbers language-none"><code class="language-none"># 重启
source ~/.bash_profile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>大功告成。</p>
<p>改完之后，如果没生效，那你把  <code>bash_profile</code>文件 换成 <code>zshrc</code>文件试试。</p>
<p>参考链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/logan_LG/article/details/106800904">mac通过终端code 命令打开vscode</a></li>
</ul>
<h3 id="3、从终端-code-命令启动-VS-Code（Windows电脑）">3、从终端 code 命令启动 VS Code（Windows电脑）</h3>
<p>在终端输入<code>code</code>或者输入 <code>code + 指定项目的目录</code>，就可以启动 VS  Code，十分便捷。即：</p>
<ul>
<li><code>code</code> 命令：启动 VS Code 软件。</li>
<li><code>code pathName/fileName</code> 命令：通过 VS Code 软件打开指定目录/指定文件。</li>
</ul>
<p>为了达到目的，我们需要先将 VS Code的软件安装路径添加到环境变量，一劳永逸。具体操作如下：</p>
<p>（1）打开 VS Code 的安装位置，进入bin文件夹，复制路径。比如：<code>D:\Microsoft VS Code\bin</code>。</p>
<p>（2）回到桌面，右键我的电脑--&gt;高级系统设置--&gt;环境变量--&gt;编辑path值，在原来的path后面，追加内容<code>;D:\Microsoft VS Code\bin</code>（即英文的分号+VS  Code 的 bin 路径)</p>
<p>（3）重启电脑，大功告成。</p>
<p>改完之后，如果没生效，那八成是因为你填的 path 值有问题。</p>
<p>参考链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zyl-Tara/p/10642704.html">windows使用 code . 命令打开vscode</a></li>
</ul>
<h3 id="4、在当前文件中搜索">4、在当前文件中搜索</h3>
<p>在上面的快捷键列表中，我们已经知道如下快捷键：</p>
<ul>
<li>
<p>Cmd + F（Win 用户是 Ctrl + F）：在当前文件中搜索，光标在搜索框里</p>
</li>
<li>
<p>Cmd + G（Win 用户是 F3）：在当前文件中搜索，光标仍停留在编辑器里</p>
</li>
</ul>
<p>多个搜索结果出来之后，按下 Enter 键之后跳转到下一个搜索结果，按下 Shift + Enter 键之后跳转到上一个搜索结果。</p>
<p>另外，你可能会注意到，搜索框里有很多按钮，每个按钮都对应着不同的功能，如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201012.png" alt=""></p>
<p>上图中，你可以通过「Tab」键和「Shift + Tab」键在输入框和替换框之间进行切换。</p>
<p>「在选定内容中查找」这个功能还是比较实用的。你也可以在设置项里搜索 <code>editor.find.autoFindInSelection</code>，勾选该设置项后，那么，当你选中指定内容后，然后按住「Cmd + F」，就可以<strong>自动</strong>只在这些内容里进行查找。该设置项如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201608.png" alt=""></p>
<h3 id="5、全局搜索">5、全局搜索</h3>
<p>在上面的快捷键列表中，我们已经知道如下快捷键：</p>
<ul>
<li>Cmd + Shift + F（Win 用户是 Ctrl + Shift +F）：在全局的文件夹中进行搜索。效果如下：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201013.png" alt="20211012_1548"></p>
<p>上图中，你可以点击<strong>红框</strong>部分，展开更多的配置项。然后点击<strong>红圈</strong>部分，进行过滤搜索。注意，第二个红圈那里会经常用到，它可以在搜索时过滤掉  <code>.git</code>、<code>.node_modules</code>等忽略文件。</p>
<p>上图中，我们还可以点击“在编辑器中打开”，在一个单独的文件中聚合展示搜索结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201615.png" alt=""></p>
<h3 id="6、文件名-文件夹的搜索">6、文件名/文件夹的搜索</h3>
<p>前面的快捷键那一段我们讲过，通过 「Cmd + P」可以快速搜索并打开<strong>文件</strong>/文件夹。这种方式，一般用于快速打开最近编辑过的文件。</p>
<p>其实还有一种很巧妙的方式，可以在整个项目里，既能搜到文件，也能搜到<strong>文件夹</strong>。这种方式，常用于<strong>过滤项目的目录</strong>。操作方法很简单：</p>
<blockquote>
<p>直接在文件资源管理器输入关键字就行。搜索结果会自动出现；使用方向键进行上下移动，可以在搜索的文件和文件夹之间进行跳转。</p>
<p>另外，右上角会看到一个过滤器，点击下图中的红圈部分，则只显示匹配的文件和文件夹。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201006.png" alt="20211012_1616"></p>
<p>当然，这招也有一点不足：不能搜中文。</p>
<h3 id="7、大纲视图">7、大纲视图</h3>
<p>如下图所示，大纲视图可以展示当前代码的方法结构、文件的目录结构：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201621.png" alt="20211012_1628"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201929.png" alt="20211012_1636"></p>
<h3 id="8、文件对比">8、文件对比</h3>
<p>VS Code 默认支持<strong>对比两个文件的内容</strong>。选中两个文件，然后右键选择「将已选项进行比较」即可，效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200959.png" alt=""></p>
<p>VS Code 自带的对比功能并不够强大，我们可以安装插件<code>compareit</code>，进行更丰富的对比。比如说，安装完插件<code>compareit</code>之后，我们可以将「当前文件」与「剪切板」里的内容进行对比：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201628.png" alt=""></p>
<p>如果你安装了 GitLens 插件，还可以将两个git分支的代码进行比对，非常完美。</p>
<h3 id="9、查找某个函数在哪些地方被调用了">9、查找某个函数在哪些地方被调用了</h3>
<p>比如我已经在<code>a.js</code>文件里调用了 <code>foo()</code>函数。那么，如果我想知道<code>foo()</code>函数在其他文件中是否也被调用了，该怎么做呢？</p>
<p>做法如下：在 <code>a.js</code> 文件里，选中<code>foo()</code>函数（或者将光标放置在<code>foo()</code>函数上），然后按住快捷键「Shift + F12」，就能看到 <code>foo()</code>函数在哪些地方被调用了，比较实用。</p>
<h3 id="10、鼠标操作">10、鼠标操作</h3>
<ul>
<li>
<p>在当前行的位置，鼠标三击，可以选中当前行。</p>
</li>
<li>
<p>用鼠标单击文件的<strong>行号</strong>，可以选中当前行。</p>
</li>
<li>
<p>在某个<strong>行号</strong>的位置，<strong>上下移动鼠标，可以选中多行</strong>。</p>
</li>
</ul>
<h3 id="11、重构">11、重构</h3>
<p>重构分很多种，我们来举几个例子。</p>
<p><strong>命名重构</strong>：</p>
<p>当我们尝试去修改某个函数（或者变量名）时，我们可以把光标放在上面，然后按下「F2」键，那么，这个函数（或者变量名）出现的地方都会被修改。</p>
<p><strong>方法重构</strong>：</p>
<p>选中某一段代码，这个时候，代码的左侧会出现一个「灯泡图标」，点击这个图标，就可以把这段代码提取为一个单独的函数。</p>
<h3 id="12：终端配置">12：终端配置</h3>
<p>VS Code软件自带了终端，但我个人认为不是很好用，而且VS Code 软件关了之后，终端也没了。建议大家使用其他的终端软件，专业的事情交给专业的人做。</p>
<ul>
<li>Windows平台的终端：推荐 PowerShell 软件。远程终端推荐 xshell 软件。</li>
<li>Mac平台的终端：推荐 <a target="_blank" rel="noopener" href="https://iterm2.com/">iTerm2 </a>。 iTerm2 是Mac平台最好用的终端软件，没有之一。</li>
</ul>
<p><strong>右键行为</strong>：</p>
<blockquote>
<p>在终端上，单击右键所产生的行为在不同的系统里是不同的。</p>
</blockquote>
<ul>
<li>Windows：如果有<strong>选定</strong>文本，则复制当前文本；如果没有选定文本，则粘贴。</li>
<li>macOS：选中光标所在位置的单词，并显示右键菜单。</li>
<li>Linux：显示右键菜单。</li>
</ul>
<h3 id="13、Git-版本管理">13、Git 版本管理</h3>
<p>在 VS Code中使用Git之前，需要你先安装 Git 环境。</p>
<p>VS Code 自带了 Git 版本管理的功能，如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200958.png" alt=""></p>
<p>上图中，我们可以在这里进行常见的 git 命令操作。如果你还不熟悉 <strong>Git 版本管理</strong>，可以先去补补课。</p>
<p>我自己用的最多的功能是<strong>diff 代码</strong>和<strong>合并冲突</strong>，自从用上了  VS Code 的这两个功能，简直离不开它。</p>
<p>我们先来看看 diff 代码的效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201634.png" alt="20211013_1411"></p>
<p>上图中，点击右上角的<code>...</code>，然后点击<code>内联视图</code>，则可以换一种视图 diff 代码：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201937.png" alt=""></p>
<p><strong>Git状态栏</strong>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200952.png" alt="20211013_1421"></p>
<p>在VS Code的左下角会显示Git状态栏。如果当前代码仓库配置了远程仓库，那么“同步更改”会显示以下信息：</p>
<ul>
<li>左边的数字：表示远程分支比本地分支多了XX个 Git commit。</li>
<li>右边的数字：表示本地分支比远程分支多了XX个 Git commit。</li>
</ul>
<p>点击“同步更改”按钮，会拉取（pull）远程分支到本地分支，并推送（push）本地的Git commit到远程分支。</p>
<p>如果当前代码仓库没有配置远程仓库，则会显示“发布更改”的按钮。点击“发布更改”按钮，会把当前分支push到远程仓库。</p>
<hr>
<p>另外，我建议安装插件<code>GitLens</code>搭配使用，它是 VS Code 中我最推荐的一个插件，简直是 Git 神器，码农必备。</p>
<p>我还要补充一句：</p>
<p>有人说，高手都是直接用命令行操作Git。然而，根据我多年的经验来看，如果你的代码仓库需要管理的分支特别多，与团队的其他成员需要经常协作，那么，我建议你<strong>优先使用</strong> GUI 图形化工具来操作Git，避免出错。</p>
<p>我推荐的GUI版的Git工具有：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.git-tower.com/">Tower</a></li>
<li><a target="_blank" rel="noopener" href="https://www.sourcetreeapp.com/">Sourcetree</a></li>
<li><a target="_blank" rel="noopener" href="https://www.gitkraken.com/">GitKraken</a></li>
</ul>
<h3 id="14、将工作区放大-缩小">14、将工作区放大/缩小</h3>
<p>我们在上面的设置项里修改字体大小后，仅仅只是修改了代码的字体大小。</p>
<p>如果你想要缩放整个工作区（包括代码的字体、左侧导航栏的字体等），可以按下快捷键「<strong>cmd +/-</strong>」。windows 用户是按下「ctrl +/-」</p>
<p><strong>当我们在投影仪上给别人演示代码的时候，这一招十分管用</strong>。</p>
<p>如果你想恢复默认的工作区大小，可以在命令面板输入<code>重置缩放</code>（英文是<code>reset zoom</code>）</p>
<p>f### 11、创建多层子文件夹</p>
<p>我们可以在新建文件夹的时候，如果直接输入<code>aa/bb/cc</code>，比如：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201641.png" alt=""></p>
<p>那么，就可以创建多层子文件夹，效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200945.png" alt=""></p>
<h3 id="15、-vscode-文件夹的作用">15、<code>.vscode</code> 文件夹的作用</h3>
<p>为了统一团队的 vscode 配置，我们可以在项目的根目录下建立<code>.vscode</code>目录，在里面放置一些配置内容，比如：</p>
<ul>
<li>
<p><code>settings.json</code>：工作空间设置、代码格式化配置、插件配置。</p>
</li>
<li>
<p><code>sftp.json</code>：ftp 文件传输的配置。</p>
</li>
</ul>
<p><code>.vscode</code>目录里的配置只针对当前项目范围内生效。将<code>.vscode</code>提交到代码仓库，大家统一配置时，会非常方便。</p>
<h3 id="16、自带终端">16、自带终端</h3>
<p>我们可以按下「Ctrl + `」打开 VS Code 自带的终端。我认为内置终端并没有那么好用，我更建议你使用第三方的终端 <strong>item2</strong>。</p>
<h3 id="17、markdown-语法支持">17、markdown 语法支持</h3>
<p>VS Code 自带 markdown 语法高亮。也就是说，如果你是用 markdown 格式写文章，则完全可以用 VS Code 进行写作。</p>
<p>写完 md 文件之后，你可以点击右上角的按钮进行预览，如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201648.png" alt=""></p>
<p>我一般是安装「Markdown Preview Github Styling」插件，以 GitHub 风格预览 Markdown 样式。样式十分简洁美观。</p>
<p>你也可以在控制面板输入<code>Markdown: 打开预览</code>，直接全屏预览 markdown 文件。</p>
<h3 id="18、Emmet-in-VS-Code">18、Emmet in VS Code</h3>
<p><code>Emmet</code>可以极大的提高 html 和 css 的编写效率，它提供了一种非常简练的语法规则。</p>
<p>举个例子，我们在编辑器中输入缩写代码：<code>ul&gt;li*6</code> ，然后按下 Tab 键，即可得到如下代码片段：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>VS Code 默认支持 Emmet。更多 Emmet 语法规则，可以自行查阅。</p>
<h3 id="19、修改字体，使用「Fira-Code」字体">19、修改字体，使用「Fira Code」字体</h3>
<p>这款字体很漂亮，很适合用来写代码：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201655.png" alt=""></p>
<p>安装步骤如下：</p>
<p>（1）进入 <a target="_blank" rel="noopener" href="https://github.com/tonsky/FiraCode">https://github.com/tonsky/FiraCode</a> 网站，下载并安装「Fira Code」字体。</p>
<p>（2）打开 VS Code 的「设置」，搜索<code>font</code>，修改相关配置为如下内容：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"editor.fontFamily"</span><span class="token operator">:</span> <span class="token string">"'Fira Code',Menlo, Monaco, 'Courier New', monospace"</span><span class="token punctuation">,</span> <span class="token comment">// 设置字体显示</span>
<span class="token property">"editor.fontLigatures"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token comment">//控制是否启用字体连字，true启用，false不启用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>上方的第二行配置，取决于个人习惯，我是直接设置为<code>"editor.fontLigatures": null</code>，因为我不太习惯连字。</p>
<h3 id="20、代码格式化">20、代码格式化</h3>
<p>VS Code 默认对 JavaScript、TypeScript、JSON、HTML 提供了开箱即用的代码格式化支持。其他语言则需要先安装相应的插件才能支持。</p>
<p>另外，我们还可以安装 Prettier 插件进行<strong>更精细</strong>的代码格式化。下一段将插件的时候，会讲解。</p>
<h3 id="21、智能提示-IntelliSense">21、智能提示 IntelliSense</h3>
<p>VS Code 默认对 JavaScript、TypeScript、JSON、HTML、CSS、SCSS、Less这7种语言（文件）提供了<strong>智能提示</strong>的支持。其他编程语言则需要先安装相应的插件才能支持。</p>
<p>在 VS Code插件职场中，下图是最受欢迎的8种<a href="https://marketplace.visualstudio.com/search?target=VSCode&amp;category=Programming%20Languages&amp;sortBy=Installs">编程语言插件</a>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201656.png" alt="20211013_1120"></p>
<p>智能提示的功能很强大， 包括函数介绍、代码自动补全等等。</p>
<h3 id="22、调试与运行">22、调试与运行</h3>
<p>VS Code <strong>内置</strong>了对 Node.js 运行时的调试支持，可以直接调试  JavaScript 和 TypeScript。其他编程语言的调试，则需要先安装相应的插件才能支持。</p>
<p>在 VS Code插件市场中，下图是最受欢迎的几种调试插件：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200938.png" alt=""></p>
<h3 id="23、文件传输：sftp">23、文件传输：sftp</h3>
<p>如果你需要将本地文件通过 ftp 的形式上传到局域网的服务器（需要先把服务端的配置搭建好），可以安装<code>sftp</code>这个插件，很好用。在公司会经常用到。</p>
<p>步骤如下：</p>
<p>（1）安装插件<code>sftp</code>。</p>
<p>（2）配置 <code>sftp.json</code>文件。 插件安装完成后，输入快捷键「cmd+shift+P」弹出命令面板，然后输入<code>sftp:config</code>，回车，当前工程的<code>.vscode</code>文件夹下就会自动生成一个<code>sftp.json</code>文件，我们需要在这个文件里配置的内容可以是：</p>
<ul>
<li>
<p><code>host</code>：服务器的 IP 地址</p>
</li>
<li>
<p><code>username</code>：用户名</p>
</li>
<li>
<p><code>privateKeyPath</code>：存放在本地的已配置好的用于登录工作站的密钥文件（也可以是 ppk 文件）</p>
</li>
<li>
<p><code>remotePath</code>：工作站上与本地工程同步的文件夹路径，需要和本地工程文件根目录同名，且在使用 sftp 上传文件之前，要手动在工作站上 mkdir 生成这个根目录</p>
</li>
<li>
<p><code>ignore</code>：指定在使用 sftp: sync to remote 的时候忽略的文件及文件夹，注意每一行后面有逗号，最后一行没有逗号</p>
</li>
</ul>
<p>举例如下：(注意，其中的注释需要去掉)</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"192.168.xxx.xxx"</span><span class="token punctuation">,</span> <span class="token comment">//服务器ip</span>
  <span class="token property">"port"</span><span class="token operator">:</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token comment">//端口，sftp模式是22</span>
  <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token comment">//用户名</span>
  <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token comment">//密码</span>
  <span class="token property">"protocol"</span><span class="token operator">:</span> <span class="token string">"sftp"</span><span class="token punctuation">,</span> <span class="token comment">//模式</span>
  <span class="token property">"agent"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"privateKeyPath"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"passphrase"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"passive"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">"interactiveAuth"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">"remotePath"</span><span class="token operator">:</span> <span class="token string">"/root/node/build/"</span><span class="token punctuation">,</span> <span class="token comment">//服务器上的文件地址</span>
  <span class="token property">"context"</span><span class="token operator">:</span> <span class="token string">"./server/build"</span><span class="token punctuation">,</span> <span class="token comment">//本地的文件地址</span>

  <span class="token property">"uploadOnSave"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//监听保存并上传</span>
  <span class="token property">"syncMode"</span><span class="token operator">:</span> <span class="token string">"update"</span><span class="token punctuation">,</span>
  <span class="token property">"watcher"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">//监听外部文件</span>
    <span class="token property">"files"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">//外部文件的绝对路径</span>
    <span class="token property">"autoUpload"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"autoDelete"</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"ignore"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">//忽略项</span>
    <span class="token string">"**/.vscode/**"</span><span class="token punctuation">,</span>
    <span class="token string">"**/.git/**"</span><span class="token punctuation">,</span>
    <span class="token string">"**/.DS_Store"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>（3）在 VS Code 的当前文件里，选择「右键 -&gt; upload」，就可以将本地的代码上传到 指定的 ftp 服务器上（也就是在上方 <code>host</code> 中配置的服务器 ip）。</p>
<p>我们还可以选择「右键 -&gt; Diff with Remote」，就可以将本地的代码和 ftp 服务器上的代码做对比，非常方便。</p>
<h3 id="24、沉浸模式-禅模式">24、沉浸模式/禅模式</h3>
<p>程序员写代码需要专注，有时需要进入一种心流。VS Code给我们提供了一种全屏下的沉浸模式，周围的面板都会被隐藏起来，只显示编辑器部分。</p>
<p>操作方法：菜单栏选择「查看-外观-禅模式」即可；或者按下快捷键<code>Cmd + K</code>，放手，再按<code>Z</code>也可以达到目的。</p>
<h3 id="正则表达式批量删除字符串">正则表达式批量删除字符串</h3>
<p><strong>需求</strong>：将文本中的字符串<code>axxxxb</code>，批量替换为<code>ab</code>。其中，开头字符 a 和 结尾字符 b 固定，中间xxx长度不确定。</p>
<p><strong>解决</strong>：传统查找替换无法胜任。可以使用VScode正则表达式功能，查找<code>a.*?b</code>替换为<code>ab</code>即可。其中<code>?</code>是禁止贪婪匹配，否则会误删很多内容。</p>
<hr>
<p><strong>拓展需求</strong>：需求——将文本中的字符串<code>axxxx</code>，批量替换为<code>a</code>。其中，开头字符 a 固定，后面的xxx长度不确定。</p>
<p><strong>解决</strong>：传统查找替换无法胜任。可以使用VScode正则表达式功能，查找<code>a.*?\n</code>替换为<code>a\n</code>即可。</p>
<h2 id="六、三头六臂：VS-Code-插件介绍-插件推荐">六、三头六臂：VS Code 插件介绍 &amp; 插件推荐</h2>
<p>VS Code 有一个很强大的功能就是支持插件扩展，让你的编辑器仿佛拥有了三头六臂。</p>
<h3 id="安装插件-4">安装插件</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201702.png" alt=""></p>
<p>上图中，点击红框部分，即可在顶部输入框里，查找你想要的插件名，然后进行安装。</p>
<p>插件安装完成后，记得重启软件（或者点击插件位置的“重新加载”），插件才会生效。</p>
<p>另外，我们还可以访问官网的插件市场来安装插件：</p>
<ul>
<li>VS Code插件市场（官方）：https://marketplace.visualstudio.com/vscode</li>
</ul>
<p><strong>插件的安装目录</strong>：</p>
<ul>
<li>Windows：：<code>%USERPROFILE%\.vscode\extensions</code></li>
<li>macOS：<code>~/.vscode/extensions</code></li>
<li>macOS：<code>~/.vscode/extensions</code></li>
</ul>
<h3 id="插件的类型">插件的类型</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201709.png" alt="20211013_1757_2"></p>
<p>插件市场的首页有四个模块，可以作为重要的信息来源：</p>
<ul>
<li>Featured：由  VS Code团队精心推荐的插件。</li>
<li>Trending：近期热门插件。</li>
<li>Most Popular：按总安装量排序的插件。</li>
<li>Recently Added：最新发布的插件。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200932.png" alt="20211013_1758"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200925.png" alt="20211013_1955"></p>
<p>插件市场至少有17种类型的插件：（按照数量排序）</p>
<ul>
<li>Themes：主题插件</li>
<li>Programming Languages：编程语言插件</li>
<li>Snippets：代码片段</li>
<li>Extension Packs：插件包，里面包括多个插件</li>
<li>Formatters：代码格式化</li>
<li>Linters：静态检查</li>
<li>Debuggers：调试器</li>
<li>Keymaps：快捷键映射</li>
<li>Visualization：可视化</li>
<li>Language Packs：各国的语言插件</li>
<li>Azure：Azure 云计算</li>
<li>Data Science：数据科学</li>
<li>SCM Providers：源代码控制管理器（source control manager）</li>
<li>Notebooks</li>
<li>Education：教育</li>
<li>Testing：测试相关</li>
<li>Machine Learning：机器学习</li>
<li>Others：其他</li>
</ul>
<h3 id="插件的过滤显示">插件的过滤显示</h3>
<p>在 VS  Code中打开插件管理视图，可以针对已安装的插件，进行过滤展示。</p>
<p>1）点击插件视图右上角的<code>...</code>按钮，可以展示不同状态的插件：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201958.png" alt="20211013_2011"></p>
<p>2）在搜索框输入字符<code>@</code>，会展示出不同类型的过滤器：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201716.png" alt="20211013_2015"></p>
<p><strong>常见的过滤器如下</strong>：</p>
<p>1）按大类搜：</p>
<ul>
<li><code>@builtin</code>：显示 VS Code内置的插件</li>
<li><code>@disabled</code>：显示被禁用的插件</li>
<li><code>@enabled</code>：显示已启用的插件</li>
<li><code>@installed</code>：显示已安装的插件</li>
<li><code>@outdated</code>：显示待更新的插件</li>
</ul>
<p>2）精准搜索：</p>
<ul>
<li><code>@id</code>：按id显示插件</li>
<li><code>@tag</code>：根据标签显示插件。</li>
</ul>
<p>3）对插件进行排序：</p>
<ul>
<li><code>@sort:installs</code>：根据插件的安装量排序</li>
<li><code>@sourt:rating</code>：根据插件的评分排序</li>
<li><code>@sort:name</code>：根据插件名字的字母顺序排序</li>
</ul>
<p>4）组合搜索：（举例）</p>
<ul>
<li><code>@installed @category:themes</code>：显示已安装的主题插件。</li>
<li><code>@sort:installs java</code>：对 Java 相关的插件按照安装量排序。</li>
</ul>
<p>下面的内容，我来列举一些常见的插件，这些插件都很实用，小伙伴们可以按需安装。注意：每一类插件里，<strong>顺序越靠前，越实用</strong>。</p>
<h3 id="1、基本插件">1、基本插件</h3>
<h4 id="Chinese-Simplified-Language-Pack-for-Visual-Studio-Code">Chinese (Simplified) Language Pack for Visual Studio Code</h4>
<p>让软件显示为简体中文语言。</p>
<h3 id="2、Git-相关插件">2、Git 相关插件</h3>
<h4 id="GitLens-【荐】">GitLens 【荐】</h4>
<p>我强烈建议你安装插件<code>GitLens</code>，它是 VS Code 中我最推荐的一个插件，简直是 Git 神器，码农必备。如果你不知道，那真是 out 了。</p>
<p>GitLens 在 Git 管理上有很多强大的功能，比如：</p>
<ul>
<li>将光标放置在代码的当前行，可以看到这样代码的提交者是谁，以及提交时间。这一点，是 GitLens 最便捷的功能。</li>
<li>查看某个 commit 的代码改动记录</li>
<li>查看不同的分支</li>
<li>可以将两个 commit 进行代码对比</li>
<li>甚至可以将两个 branch 分支进行整体的代码对比。这一点，简直是 GitLens 最强大的功能。当我们在不同分支 review 代码的时候，就可以用到这一招。</li>
</ul>
<p>打开你的 Git仓库，未安装  GitLens 时是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200918.png" alt=""></p>
<p>安装了  GitLens 之后是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201723.png" alt=""></p>
<p>上图中，红框部分就是  GitLens 的功能，诸君可以自由发挥。</p>
<p>补充一个有意思的趣事：Python插件、Ruby插件、GitLens插件、Vetur插件，这四个插件的开发者先后加入了微软。</p>
<h4 id="Git-History">Git History</h4>
<p>有些同学习惯使用编辑器中的 Git 管理工具，而不太喜欢要打开另外一个 Git UI 工具的同学，这一款插件满足你查询所有 Git 记录的需求。</p>
<h4 id="Local-History-【荐】">Local History 【荐】</h4>
<p>维护文件的本地历史记录。代码意外丢失时，有时可以救命。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201729.png" alt=""></p>
<h3 id="3、代码智能提示插件">3、代码智能提示插件</h3>
<h4 id="Vetur">Vetur</h4>
<p>Vue 多功能集成插件，包括：语法高亮，智能提示，emmet，错误提示，格式化，自动补全，debugger。VS Code 官方钦定 Vue 插件，Vue 开发者必备。</p>
<h4 id="ES7-React-Redux-GraphQL-React-Native-snippets">ES7 React/Redux/GraphQL/React-Native snippets</h4>
<p>React/Redux/react-router 的语法智能提示。</p>
<h4 id="JavaScript-ES6-code-snippets">JavaScript(ES6) code snippets</h4>
<p>ES6 语法智能提示，支持快速输入。</p>
<h4 id="javascript-console-utils：快速打印-log-日志【荐】">javascript console utils：快速打印 log 日志【荐】</h4>
<p>安装这个插件后，当我们按住快捷键「Cmd + Shift + L」后，即可自动出现日志 <code>console.log()</code>。简直是日志党福音。</p>
<p>当我们选中某个变量 <code>name</code>，然后按住快捷键「Cmd + Shift + L」，即可自动出现这个变量的日志 <code>console.log(name)</code>。</p>
<p>其他的同类插件还有：Turbo Console Log。</p>
<p>不过，生产环境的代码，还是尽量少打日志比较好，避免出现一些异常。</p>
<p>编程有三等境界：</p>
<ul>
<li>
<p>第三等境界是打日志，这是最简单、便捷的方式，略显低级，一般新手或资深程序员偷懒时会用。</p>
</li>
<li>
<p>第二等境界是断点调试，在前端、Java、PHP、iOS 开发时非常常用，通过断点调试可以很直观地跟踪代码执行逻辑、调用栈、变量等，是非常实用的技巧。</p>
</li>
<li>
<p>第一等境界是测试驱动开发，在写代码之前先写测试。与第二等的断点调试刚好相反，大部分人不是很习惯这种方式，但在国外开发者或者敏捷爱好者看来，这是最高效的开发方式，在保证代码质量、重构等方面非常有帮助，是现代编程开发必不可少的一部分。</p>
</li>
</ul>
<h4 id="Code-Spell-Checker：单词拼写错误检查">Code Spell Checker：单词拼写错误检查</h4>
<p>这个拼写检查程序的目标是帮助捕获常见的单词拼写错误，可以检测驼峰命名。从此告别 Chinglish.</p>
<h4 id="Auto-Close-Tag、Auto-Rename-Tag">Auto Close Tag、Auto Rename Tag</h4>
<p>自动闭合配对的标签、自动重命名配对的标签。</p>
<h3 id="4、代码显示增强插件">4、代码显示增强插件</h3>
<h4 id="Bracket-Pair-Colorizer-2：突出显示成对的括号【荐】">Bracket Pair Colorizer 2：突出显示成对的括号【荐】</h4>
<p><code>Bracket Pair Colorizer 2</code>插件：以不同颜色显示成对的括号，并用连线标注括号范围。简称<strong>彩虹括号</strong>。</p>
<p>另外，还有个<code>Rainbow Brackets</code>插件，也可以突出显示成对的括号。</p>
<h4 id="highlight-icemode：选中相同的代码时，让高亮显示更加明显【荐】">highlight-icemode：选中相同的代码时，让高亮显示更加明显【荐】</h4>
<p>VSCode 自带的高亮显示，实在是不够显眼。用插件支持一下吧。</p>
<p>所用了这个插件之后，VS Code 自带的高亮就可以关掉了：</p>
<p>在用户设置里添加<code>"editor.selectionHighlight": false</code>即可。</p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/palmer_kai/article/details/79548164">vscode 选中后相同内容高亮插件推荐</a></p>
<h4 id="vscode-icons">vscode-icons</h4>
<p>vscode-icons 会根据文件的后缀名来显示不同的图标，让你更直观地知道每种文件是什么类型的。</p>
<h4 id="indent-rainbow：突出显示代码缩进">indent-rainbow：突出显示代码缩进</h4>
<p><code>indent-rainbow</code>插件：突出显示代码缩进。</p>
<p>安装完成后，效果如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200911.png" alt=""></p>
<h4 id="TODO-Highlight">TODO Highlight</h4>
<p>写代码过程中，突然发现一个 Bug，但是又不想停下来手中的活，以免打断思路，怎么办？按照代码规范，我们一般是在代码中加个 TODO 注释。比如：（注意，一定要写成大写<code>TODO</code>，而不是小写的<code>todo</code>）</p>
<pre class="line-numbers language-none"><code class="language-none">//TODO:这里有个bug，我一会儿再收拾你<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>或者：</p>
<pre class="line-numbers language-none"><code class="language-none">//FIXME:我也不知道为啥， but it works only that way.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装了插件 <code>TODO Highlight</code>之后，按住「Cmd + Shift + P」打开命令面板，输入「Todohighlist」，选择相关的命令，我们就可以看到一个 todoList 的清单。</p>
<h4 id="Better-Comments">Better Comments</h4>
<p>为注释添加更醒目、带分类的色彩。</p>
<h3 id="5、代码格式化插件">5、代码格式化插件</h3>
<h4 id="Prettier：代码格式化">Prettier：代码格式化</h4>
<p>Prettier 是一个代码格式化工具，<strong>只关注格式化，但不具备校验功能</strong>。在一个多人协同开发的团队中，统一的代码编写规范非常重要。一套规范可以让我们编写的代码达到一致的风格，提高代码的可读性和统一性。自然维护性也会有所提高，代码的展示也会更加美观。</p>
<p>步骤如下：</p>
<p>（1）安装插件 <code>Prettier</code>。</p>
<p>（2）在项目的根路径下，新建文件<code>.prettierrc</code>，并在文件中添加如下内容：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"printWidth"</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
  <span class="token property">"tabWidth"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token property">"semi"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"singleQuote"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"trailingComma"</span><span class="token operator">:</span> <span class="token string">"es5"</span><span class="token punctuation">,</span>
  <span class="token property">"tslintIntegration"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"insertSpaceBeforeFunctionParenthesis"</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的内容，是我自己的配置，你可以参考。更多配置，可见官方文档：<a target="_blank" rel="noopener" href="https://prettier.io/docs/en/options.html">https://prettier.io/docs/en/options.html</a></p>
<p>（3）Mac用户按快捷键「Option + Shift + F」，Win 用户按快捷键「Alt + shift + F」，即可完成代码的格式化。如果你的VS Code 设置的是自动格式化代码，那么这一步可以忽略。</p>
<h4 id="ESLint：代码格式的校验">ESLint：代码格式的校验</h4>
<p>日常开发中，建议用 Prettier 做<strong>代码格式化</strong>，然后用 eslint 做<strong>格式校验</strong>。很多人把这两个插件的功能弄混了。</p>
<p>一般做法是：格式化建议是由程序员手动触发，格式校验由系统强制校验。通过 Prettier <strong>手动</strong>触发格式化，是为了让用户有感知；通过eslint 做<strong>强制</strong>校验之后，如果代码的格式不符合要求，系统就禁止你提交代码。</p>
<h4 id="Beautify">Beautify</h4>
<p>代码格式化工具。</p>
<p>备注：相比之下，Prettier 是当前最流行的代码格式化工具，比 Beautify 用得更多。</p>
<h4 id="Paste-JSON-as-Code">Paste JSON as Code</h4>
<p>此插件可以将剪贴板中的 JSON 字符串转换成工作代码。支持多种语言。</p>
<h4 id="JS-CSS-HTML-Formatter【荐】">JS-CSS-HTML Formatter【荐】</h4>
<p>保存文件时，自动格式化 HTML、CSS、JS代码。</p>
<h3 id="6、图片相关插件">6、图片相关插件</h3>
<h4 id="Polacode-2020：生成代码截图-【荐】">Polacode-2020：生成代码截图 【荐】</h4>
<p>可以把代码片段保存成美观的图片，主题不同，代码的配色方案也不同，也也可以自定义设置图片的边框颜色、大小、阴影。</p>
<p>尤其是在我们做 PPT 分享时需要用到代码片段时，或者需要在网络上优雅地分享代码片段时，这一招很有用。</p>
<p>生成的效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200904.png" alt=""></p>
<p>其他同类插件：<code>CodeSnap</code>。我们也可以通过 <a target="_blank" rel="noopener" href="https://carbon.now.sh/">https://carbon.now.sh/</a>这个网站生成代码图片</p>
<p>有人可能会说：直接用 QQ 截图不行吗？可以是可以，但不够美观、不够干净。</p>
<h4 id="Image-Preview-【荐】">Image Preview 【荐】</h4>
<p>图片预览。鼠标移动到图片 url 上的时候，会自动显示图片的预览和图片尺寸。</p>
<h3 id="7、CSS相关插件">7、CSS相关插件</h3>
<h4 id="CSS-Peek">CSS Peek</h4>
<p>增强 HTML 和 CSS 之间的关联，快速查看该元素上的 CSS 样式。</p>
<h4 id="Vue-CSS-Peek">Vue CSS Peek</h4>
<p>CSS Peek 对 Vue 没有支持，该插件提供了对 Vue 文件的支持。</p>
<h4 id="Color-Info">Color Info</h4>
<p>这个便捷的插件，将为你提供你在 CSS 中使用颜色的相关信息。你只需在颜色上悬停光标，就可以预览色块中色彩模型的（HEX、 RGB、HSL 和 CMYK）相关信息了。</p>
<h3 id="8、Mardown-相关插件">8、Mardown 相关插件</h3>
<h4 id="Markdown-Preview-Github-Styling-【荐】">Markdown Preview Github Styling 【荐】</h4>
<p>以 GitHub 风格预览 Markdown 样式，十分简洁优雅。就像下面这样，左侧书写 Markdown 文本，右侧预览 Markdown 的渲染效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201736.png" alt=""></p>
<h4 id="Markdown-Preview-Enhanced">Markdown Preview Enhanced</h4>
<p>预览 Markdown 样式。</p>
<h4 id="Markdown-All-in-One">Markdown All in One</h4>
<p>这个插件将帮助你更高效地在 Markdown 中编写文档。</p>
<h3 id="9、通用工具类插件">9、通用工具类插件</h3>
<h4 id="sftp：文件传输-【荐】">sftp：文件传输 【荐】</h4>
<p>如果你需要将本地文件通过 ftp 的形式上传到局域网的服务器，可以安装<code>sftp</code>这个插件，很好用。在公司会经常用到。</p>
<p>详细配置已经在上面讲过。</p>
<h4 id="Live-Server-【荐】">Live Server 【荐】</h4>
<p>在本地启动一个服务器，代码写完后可以实现「热更新」，实时地在网页中看到运行效果。就不需要每次都得手动刷新页面了。</p>
<p>使用方式：安装插件后，开始写代码；代码写完后，右键选择「Open with Live Server」。</p>
<h4 id="open-in-browser">open in browser</h4>
<p>安装<code>open in browser</code>插件后，在 HTML 文件中「右键选择 --&gt; Open in Default Browser」，即可在浏览器中预览网页。</p>
<h4 id="Project-Manager">Project Manager</h4>
<p>工作中，我们经常会来回切换多个项目，每次都要找到对应项目的目录再打开，比较麻烦。Project Manager 插件可以解决这样的烦恼，它提供了专门的视图来展示你的项目，我们可以把常用的项目保存在这里，需要时一键切换，十分方便。</p>
<h4 id="WakaTime-【荐】">WakaTime 【荐】</h4>
<p>统计在 VS Code 里写代码的时间。统计效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200858.png" alt=""></p>
<h4 id="Code-Time">Code Time</h4>
<p><code>Code Time</code>插件：记录编程时间，统计代码行数。</p>
<p>安装该插件后，VS Code 底部的状态栏右下角可以看到时间统计。点击那个位置之后，选择「Code Time Dashboard」，即可查看统计结果。</p>
<p>备注：团长试了一下这个 code time 插件，发现统计结果不是很准。</p>
<h4 id="File-Tree-to-Text-Generator：快速生成文件的目录树">File Tree to Text Generator：快速生成文件的目录树</h4>
<p>如题。</p>
<h4 id="Settings-Sync">Settings Sync</h4>
<ul>
<li>
<p>地址：<a target="_blank" rel="noopener" href="https://github.com/shanalikhan/code-settings-sync">https://github.com/shanalikhan/code-settings-sync</a></p>
</li>
<li>
<p>作用：多台设备之间，同步 VS Code 配置。通过登录 GitHub 账号来使用这个同步工具。</p>
</li>
</ul>
<p>同步的详细操作，下一段会讲。</p>
<p>另外，北京时间的<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/184868336">2020年8月14日</a>，微软发布 Visual Studio Code 1.48 稳定版。此版本<strong>原生</strong>支持用户同步 VS Code的配置，只需要登录微软账号或者 GitHub账号即可。</p>
<h4 id="vscode-syncing">vscode-syncing</h4>
<ul>
<li>
<p>地址：<a target="_blank" rel="noopener" href="https://github.com/nonoroazoro/vscode-syncing">https://github.com/nonoroazoro/vscode-syncing</a></p>
</li>
<li>
<p>作用：多台设备之间，同步 VS Code 配置。</p>
</li>
</ul>
<h4 id="minapp：小程序支持">minapp：小程序支持</h4>
<p>小程序开发必备插件。</p>
<h4 id="Search-node-modules">Search node_modules</h4>
<p><code>node_modules</code>模块里面的文件夹和模块实在是太多了，根本不好找。好在安装 <code>Search node_modules</code> 这个插件后，输入快捷键「Cmd + Shift + P」，然后输入 <code>node_modules</code>，在弹出的选项中选择 <code>Search node_modules</code>，即可搜索 node_modules 里的模块。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200857.jpeg" alt=""></p>
<h4 id="RemoteHub">RemoteHub</h4>
<p>不要惊讶，RemoteHub 和 GitLens 是同一个作者开发出来的。</p>
<p><code>RemoteHub</code>插件的作用是：可以在本地查看 GitHub 网站上的代码，而不需要将代码下载到本地。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200857.png" alt=""></p>
<p>这个插件目前使用的人还不多，赶紧安装起来尝尝鲜吧。</p>
<h4 id="Live-Share：实时编码分享">Live Share：实时编码分享</h4>
<p><code>Live Share</code>这个神奇的插件是由微软官方出品，它的作用是：<strong>实时编码分享</strong>。也就是说，它可以实现你和你的同伴一起写代码。这绝对就是<strong>结对编程</strong>的神器啊。</p>
<p>安装方式：</p>
<p>打开插件管理，搜索“live share”，安装。安装后重启 VS Code，在左侧会多出一个按钮：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201743.png" alt=""></p>
<p>上图中，点击红框部分，登录后就可以分享你的工作空间了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200850.png" alt=""></p>
<h4 id="Import-Cost">Import Cost</h4>
<p>在项目开发过程中，我们会引入很多 npm 包，有时候可能只用到了某个包里的一个方法，却引入了整个包，导致代码体积增大很多。<code>Import Cost</code>插件可以在代码中友好的提示我们，当前引入的包会增加多少体积，这很有助于帮我们优化代码的体积。</p>
<h3 id="10、主题插件">10、主题插件</h3>
<p>给你的 VS Code 换个皮肤吧，免费的那种。</p>
<ul>
<li>
<p>Dracula Theme</p>
</li>
<li>
<p>Material Theme</p>
</li>
<li>
<p>Nebula Theme</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=zhuangtongfa.Material-theme">One Dark Pro</a></p>
</li>
<li>
<p>One Monokai Theme</p>
</li>
<li>
<p>Monokai Pro</p>
</li>
<li>
<p>Ayu</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=akarlsten.vscode-snazzy-akarlsten">Snazzy Plus</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=alexanderte.dainty-vscode">Dainty</a></p>
</li>
<li>
<p><code>SynthWave '84</code></p>
</li>
<li>
<p>GitHub Plus Theme：白色主题</p>
</li>
<li>
<p>Horizon Theme：红色主题</p>
</li>
</ul>
<h2 id="七、无缝切换：VS-Code-配置云同步">七、无缝切换：VS Code 配置云同步</h2>
<p>我们可以将配置云同步，这样的话，当我们换个电脑时，即可将配置一键同步到本地，就不需要重新安装插件了，也不需要重新配置软件。</p>
<p>下面讲的两个同步方法，都可以，看你自己需要。方法1是 VS Code自带的同步功能，操作简单。方法2 需要安装插件，支持更多的自定义配置。</p>
<h3 id="方法1：使用-VS-Code-自带的同步功能">方法1：使用 VS Code 自带的同步功能</h3>
<p>1、<strong>配置同步</strong>：</p>
<p>（1）在菜单栏选择「 Code --&gt; 首选项 --&gt; 打开设置同步」：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201750.png" alt=""></p>
<p>（2）选择需要同步的配置：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200843.png" alt=""></p>
<p>（3）通过Microsoft或者GitHub账号登录。 上图中，点击“登录并打开”，然后弹出如下界面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201757.png" alt=""></p>
<p>上图中，使用  微软账号或者 GitHub账号登录：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312201803.png" alt=""></p>
<p>（4）同步完成后，菜单栏会显示“首先项同步已打开”，最左侧也会多出一个同步图标，如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312202032.png" alt=""></p>
<p>2、<strong>管理同步</strong>：</p>
<p>（1）点击菜单栏「Code --&gt; 首选项 --&gt; 设置同步已打开」，会弹出如下界面，进行相应的同步管理即可：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200836.png" alt=""></p>
<p>（2）换另外一个电脑时，登录相同的账号，即可完成同步。</p>
<p>参考链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/baidu_33340703/article/details/106967884">VS Code原生的配置同步功能——Settings Sync</a></li>
</ul>
<h3 id="方法2：使用插件-settings-sync">方法2：使用插件 <code>settings-sync</code></h3>
<p>使用方法2，我们还可以把配置分享其他用户，也可以把其他用户的配置给自己用。</p>
<p>1、<strong>配置同步</strong>：（将自己本地的配置云同步到 GitHub）</p>
<p>（1）安装插件 <code>settings-sync</code>。</p>
<p>（2）安装完插件后，在插件里使用 GitHub 账号登录。</p>
<p>（3）登录后在 vscode 的界面中，可以选择一个别人的 gist；也可以忽略掉，然后创建一个属于自己的 gist。</p>
<p>（4）使用快捷键 「Command + Shift + P」，在弹出的命令框中输入 sync，并选择「更新/上传配置」，这样就可以把最新的配置上传到 GitHub。</p>
<p>2、<strong>管理同步</strong>：（换另外一个电脑时，从云端同步配置到本地）</p>
<p>（1）当我们换另外一台电脑时，可以先在 VS Code 中安装 <code>settings-sync</code> 插件。</p>
<p>（2）安装完插件后，在插件里使用 GitHub 账号登录。</p>
<p>（3）登录之后，插件的界面上，会自动出现之前的同步记录：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200829.png" alt=""></p>
<p>上图中，我们点击最新的那条记录，就可将云端的最新配置同步到本地：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1220220312200825.png" alt=""></p>
<p>如果你远程的配置没有成功同步到本地，那可能是网络的问题，此时，可以使用快捷键 「Command + Shift + P」，在弹出的命令框中输入 sync，并选择「下载配置」，多试几次。</p>
<p><strong>使用其他人的配置</strong>：</p>
<p>如果我们想使用别人的配置，首先需要对方提供给你 gist。具体步骤如下：</p>
<p>（1）安装插件 <code>settings-sync</code>。</p>
<p>（2）使用快捷键 「Command + Shift + P」，在弹出的命令框中输入 sync，并选择「下载配置」</p>
<p>（3）在弹出的界面中，选择「Download Public Gist」，然后输入别人分享给你的 gist。注意，这一步不需要登录 GitHub 账号。</p>
<h2 id="最后一段">最后一段</h2>
<p>如果你还有什么推荐的 VS Code 插件，欢迎留言。</p>
<p>大家完全不用担心这篇文章会过时，随着 VS Code 的版本更新和插件更新，本文也会随之更新。关于 VS Code 内容的后续更新，你可以关注我在 GitHub 上的前端入门项目，项目地址是：</p>
<blockquote>
<p>https://github.com/qianguyihao/Web</p>
</blockquote>
<p>一个超级详细和真诚的前端入门项目。</p>
<h2 id="todo">todo</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/qianguyihao/Web/issues/84">issues 84</a></li>
</ul>
<h2 id="参考链接">参考链接</h2>
<h3 id="2021年">2021年</h3>
<ul>
<li>中文版 Awesome VS Code：https://github.com/formulahendry/awesome-vscode-cn</li>
</ul>
<h3 id="2020年">2020年</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5ea40c6751882573b219777d">VSCode 插件大全｜ VSCode 高级玩家之第二篇</a></li>
<li><a target="_blank" rel="noopener" href="http://www.supuwoerc.xyz/tools/vscode/plugins.html">http://www.supuwoerc.xyz/tools/vscode/plugins.html</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/99462672">如何让 VS Code 更好用 10 倍？这里有一份 VS Code 新手指南</a></li>
<li><a target="_blank" rel="noopener" href="https://lyreal666.com/%E9%82%A3%E4%BA%9B%E4%BD%A0%E5%BA%94%E8%AF%A5%E8%80%83%E8%99%91%E5%8D%B8%E8%BD%BD%E7%9A%84-VSCode-%E6%89%A9%E5%B1%95/#more">那些你应该考虑卸载的 VSCode 扩展</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5d74eb5c51882525017787d9">VS Code 折腾记 - (16) 推荐一波实用的插件集</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5db66672f265da4d0e009aad">VSCode 前端必备插件，有可能你装了却不知道如何使用？</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5a08d1d6f265da430f31950e">能让你开发效率翻倍的 VSCode 插件配置（上）</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000012811886">https://segmentfault.com/a/1190000012811886</a></li>
<li><a target="_blank" rel="noopener" href="https://idoubi.cc/2019/07/08/vscode-sublime-theme/">「Vscode」打造类 sublime 的高颜值编辑器</a></li>
<li><a target="_blank" rel="noopener" href="https://lsqy.tech/2020/03/14/20200314Mac-Vscode%E5%BF%AB%E6%8D%B7%E9%94%AE/">Mac Vscode 快捷键</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?src=11&amp;timestamp=1591581536&amp;ver=2387&amp;signature=i4xLZlLe1Gkl7OiBIhPO*VSeNB5lzFgTY-dgNW9E9ZbtIAv4bnJ1RdAAZdhvDw*cg-DmMcUa-V8NSUdV-tthmXZCq3ht4edCweq6v0QxKjnh8IuAxyyh5qymdRui*8iE&amp;new=1">使用 VSCode 的一些技巧</a></li>
<li>转载来源，[GitHub](https://github.com/qianguyihao/Web/blob/master/00-前端工具/01-VS Code的使用.md) 推荐关注star！</li>
</ul>
<hr>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>tools</category>
      </categories>
      <tags>
        <tag>vscode</tag>
        <tag>插件</tag>
        <tag>编码</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo Markdown以及各种插件功能测试</title>
    <url>/posts/cf0f47fd/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="Markdown-插件">Markdown 插件</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/markdown-it/markdown-it-abbr">markdown-it-abbr</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/markdown-it/markdown-it-container">markdown-it-container</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/markdown-it/markdown-it-deflist">markdown-it-deflist</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/markdown-it/markdown-it-emoji">markdown-it-emoji</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/markdown-it/markdown-it-footnote">markdown-it-footnote</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/tatsy/markdown-it-imsize">markdown-it-imsize</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/markdown-it/markdown-it-ins">markdown-it-ins</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/markdown-it/markdown-it-mark">markdown-it-mark</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/rlidwka/markdown-it-regexp">markdown-it-regexp</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/markdown-it/markdown-it-sub">markdown-it-sub</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/markdown-it/markdown-it-sup">markdown-it-sup</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/linsir/markdown-it-task-checkbox">markdown-it-task-checkbox</a></li>
</ul>
<h3 id="常用标记">常用标记</h3>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">-</span> 29^th^ =&gt; <span class="token code-snippet code keyword">`29&lt;sup&gt;th&lt;/sup&gt;`</span>
<span class="token list punctuation">-</span> H<span class="token strike"><span class="token punctuation">~</span><span class="token content">2</span><span class="token punctuation">~</span></span>0 =&gt; <span class="token code-snippet code keyword">`H&lt;sub&gt;2&lt;/sub&gt;O`</span>
<span class="token list punctuation">-</span> ==marked== =&gt; <span class="token code-snippet code keyword">`&lt;mark&gt;inserted&lt;/mark&gt;`</span>
<span class="token list punctuation">-</span> ++inserted++ =&gt; <span class="token code-snippet code keyword">`&lt;ins&gt;inserted&lt;/ins&gt;`</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>29<sup>th</sup> =&gt; <code>29&lt;sup&gt;th&lt;/sup&gt;</code></li>
<li>H<sub>2</sub>0 =&gt; <code>H&lt;sub&gt;2&lt;/sub&gt;O</code></li>
<li><mark>marked</mark> =&gt; <code>&lt;mark&gt;inserted&lt;/mark&gt;</code></li>
<li><ins>inserted</ins> =&gt; <code>&lt;ins&gt;inserted&lt;/ins&gt;</code></li>
</ul>
<h3 id="markdown-it-task-checkbox"><a target="_blank" rel="noopener" href="https://github.com/linsir/markdown-it-task-checkbox">markdown-it-task-checkbox</a></h3>
<blockquote>
<p>和主题某些css冲突，停用</p>
</blockquote>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">-</span> [x] item 1
    <span class="token list punctuation">-</span> [x] item 1-1
    <span class="token list punctuation">-</span> [ ] item 1-2
    <span class="token list punctuation">-</span> [ ] item 1-3
    <span class="token list punctuation">-</span> [ ] item 1-4
<span class="token list punctuation">-</span> [ ] item 2
    <span class="token list punctuation">-</span> [ ] item 2-1
    <span class="token list punctuation">-</span> [ ] item 2-2
    <span class="token list punctuation">-</span> [ ] item 2-3
    <span class="token list punctuation">-</span> [ ] item 2-4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>[x] item 1
<ul>
<li>[x] item 1-1</li>
<li>[ ] item 1-2</li>
<li>[ ] item 1-3</li>
<li>[ ] item 1-4</li>
</ul>
</li>
<li>[ ] item 2
<ul>
<li>[ ] item 2-1</li>
<li>[ ] item 2-2</li>
<li>[ ] item 2-3</li>
<li>[ ] item 2-4</li>
</ul>
</li>
</ul>
<h3 id="markdown-it-multimd-table"><a target="_blank" rel="noopener" href="https://github.com/RedBug312/markdown-it-multimd-table">markdown-it-multimd-table</a></h3>
<blockquote>
<p>目前仅支持多列合并</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">| 标题1        | 标题2        |
| ------------ | ------------ |
| 合并第一行                ||
| 第二行第一列 | 第二行第二列 |<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<table>
<thead>
<tr>
<th style="text-align:left">标题1</th>
<th style="text-align:left">标题2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">合并第一行</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">第二行第一列</td>
<td style="text-align:left">第二行第二列</td>
</tr>
</tbody>
</table>
<p>colspan <code>&gt;</code> or <code>empty cell</code>:</p>
<table>
<thead>
<tr>
<th style="text-align:left">a</th>
<th style="text-align:left">b</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">&gt;</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<p>rowspan ‘^’</p>
<table>
<thead>
<tr>
<th style="text-align:left">a</th>
<th style="text-align:left">b</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">2</td>
</tr>
<tr>
<td style="text-align:left">^^</td>
<td style="text-align:left">4</td>
</tr>
</tbody>
</table>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token table"><span class="token table-header-row"><span class="token punctuation">|</span><span class="token table-header important">   Markdown   </span><span class="token punctuation">|</span><span class="token table-header important"> Rendered HTML </span><span class="token punctuation">|</span>
</span><span class="token table-line"><span class="token punctuation">|</span><span class="token punctuation">--------------</span><span class="token punctuation">|</span><span class="token punctuation">---------------</span><span class="token punctuation">|</span>
</span><span class="token table-data-rows"></span></span>|    <span class="token italic"><span class="token punctuation">*</span><span class="token content">Italic</span><span class="token punctuation">*</span></span>  | <span class="token italic"><span class="token punctuation">*</span><span class="token content">Italic</span><span class="token punctuation">*</span></span>      | \
|              |               |
|    - Item 1  | - Item 1      | \
|    - Item 2  | - Item 2      |
|    ```python | ```python       \
|    .1 + .2   | .1 + .2         \
|    ```       | ```           |<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<table>
<thead>
<tr>
<th style="text-align:left">Markdown</th>
<th style="text-align:left">Rendered <abbr title="Hyper Text Markup Language">HTML</abbr></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><em>Italic</em></td>
<td style="text-align:left"><em>Italic</em></td>
<td>\</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">- Item 1</td>
<td style="text-align:left">- Item 1</td>
<td>\</td>
</tr>
<tr>
<td style="text-align:left">- Item 2</td>
<td style="text-align:left">- Item 2</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">```python</td>
<td style="text-align:left">```python \</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">.1 + .2</td>
<td style="text-align:left">.1 + .2 \</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">```</td>
<td style="text-align:left">```</td>
<td></td>
</tr>
</tbody>
</table>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token table"><span class="token table-header-row"><span class="token punctuation">|</span><span class="token table-header important"> Task           </span><span class="token punctuation">|</span><span class="token table-header important"> Time required </span><span class="token punctuation">|</span><span class="token table-header important"> Assigned to   </span><span class="token punctuation">|</span><span class="token table-header important"> Current Status </span><span class="token punctuation">|</span><span class="token table-header important"> Finished </span><span class="token punctuation">|</span><span class="token table-header important"> </span>
</span><span class="token table-line"><span class="token punctuation">|</span><span class="token punctuation">----------------</span><span class="token punctuation">|</span><span class="token punctuation">---------------</span><span class="token punctuation">|</span><span class="token punctuation">---------------</span><span class="token punctuation">|</span><span class="token punctuation">----------------</span><span class="token punctuation">|</span><span class="token punctuation">-----------</span><span class="token punctuation">|</span>
</span><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> Calendar Cache </span><span class="token punctuation">|</span><span class="token table-data"> &gt; 5 hours  </span><span class="token punctuation">|</span><span class="token table-data"> @georgehrke </span><span class="token punctuation">|</span><span class="token table-data"> in progress </span><span class="token punctuation">|</span><span class="token table-data"> <span class="token list punctuation">-</span> [x] ok?</span>
<span class="token punctuation">|</span><span class="token table-data"> Object Cache   </span><span class="token punctuation">|</span><span class="token table-data"> &gt; 5 hours  </span><span class="token punctuation">|</span><span class="token table-data"> @georgehrke </span><span class="token punctuation">|</span><span class="token table-data"> in progress </span><span class="token punctuation">|</span><span class="token table-data"> [x] item1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>[ ] item2</span>
<span class="token punctuation">|</span><span class="token table-data"> Object Cache   </span><span class="token punctuation">|</span><span class="token table-data"> &gt; 5 hours  </span><span class="token punctuation">|</span><span class="token table-data"> @georgehrke </span><span class="token punctuation">|</span><span class="token table-data"> in progress </span><span class="token punctuation">|</span><span class="token table-data"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>- [x] item1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>- [ ] item2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">|</span><span class="token table-data"> Object Cache   </span><span class="token punctuation">|</span><span class="token table-data"> &gt; 5 hours  </span><span class="token punctuation">|</span><span class="token table-data"> @georgehrke </span><span class="token punctuation">|</span><span class="token table-data"> in progress </span><span class="token punctuation">|</span><span class="token table-data"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>[x] item1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>[ ] item2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span></span>
</span></span>

<span class="token list punctuation">-</span> [x] works
<span class="token list punctuation">-</span> [x] works too<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<table>
<thead>
<tr>
<th style="text-align:left">Task</th>
<th style="text-align:left">Time required</th>
<th style="text-align:left">Assigned to</th>
<th style="text-align:left">Current Status</th>
<th style="text-align:left">Finished</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Calendar Cache</td>
<td style="text-align:left">&gt; 5 hours</td>
<td style="text-align:left">@georgehrke</td>
<td style="text-align:left">in progress</td>
<td style="text-align:left">- [x] ok?</td>
</tr>
<tr>
<td style="text-align:left">Object Cache</td>
<td style="text-align:left">&gt; 5 hours</td>
<td style="text-align:left">@georgehrke</td>
<td style="text-align:left">in progress</td>
<td style="text-align:left">[x] item1 [ ] item2</td>
</tr>
<tr>
<td style="text-align:left">Object Cache</td>
<td style="text-align:left">&gt; 5 hours</td>
<td style="text-align:left">@georgehrke</td>
<td style="text-align:left">in progress</td>
<td style="text-align:left">- [x] item1- [ ] item2</td>
</tr>
<tr>
<td style="text-align:left">Object Cache</td>
<td style="text-align:left">&gt; 5 hours</td>
<td style="text-align:left">@georgehrke</td>
<td style="text-align:left">in progress</td>
<td style="text-align:left">[x] item1[ ] item2</td>
</tr>
</tbody>
</table>
<ul>
<li>[x] works</li>
<li>[x] works too</li>
</ul>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token table"><span class="token table-header-row"><span class="token table-header important">Function </span><span class="token punctuation">|</span><span class="token table-header important"> MySQL / MariaDB </span><span class="token punctuation">|</span><span class="token table-header important"> PostgreSQL </span><span class="token punctuation">|</span><span class="token table-header important"> SQLite</span>
</span><span class="token table-line"><span class="token punctuation">:------------</span> <span class="token punctuation">|</span> <span class="token punctuation">:-------------</span><span class="token punctuation">|</span> <span class="token punctuation">:-------------</span><span class="token punctuation">|</span> <span class="token punctuation">:-------------</span>
</span><span class="token table-data-rows"><span class="token table-data">substr </span><span class="token punctuation">|</span><span class="token table-data"> :heavy_check_mark: </span><span class="token punctuation">|</span><span class="token table-data">  :white_check_mark: </span><span class="token punctuation">|</span><span class="token table-data"> :heavy_check_mark:</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<table>
<thead>
<tr>
<th style="text-align:left">Function</th>
<th style="text-align:left">MySQL / MariaDB</th>
<th style="text-align:left">PostgreSQL</th>
<th style="text-align:left">SQLite</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">substr</td>
<td style="text-align:left">✔️</td>
<td style="text-align:left">✅</td>
<td style="text-align:left">✔️</td>
</tr>
</tbody>
</table>
<h3 id="emoji"><a target="_blank" rel="noopener" href="https://www.webfx.com/tools/emoji-cheat-sheet/">emoji</a></h3>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">:smile::smirk::sunny:<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>😄😏☀️</p>
<h3 id="markdown-it-abbr"><a target="_blank" rel="noopener" href="https://github.com/markdown-it/markdown-it-abbr">markdown-it-abbr</a></h3>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token italic"><span class="token punctuation">*</span><span class="token content">[HTML]: Hyper Text Markup Language
</span><span class="token punctuation">*</span></span><span class="token url-reference url"><span class="token punctuation">[</span><span class="token variable">W3C</span><span class="token punctuation">]</span><span class="token punctuation">:</span>  World</span> Wide Web Consortium
The HTML specification
is maintained by the W3C.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>The <abbr title="Hyper Text Markup Language">HTML</abbr> specification<br>
is maintained by the <abbr title="World Wide Web Consortium">W3C</abbr>.</p>
<h3 id="markdown-it-container"><a target="_blank" rel="noopener" href="https://github.com/markdown-it/markdown-it-container">markdown-it-container</a></h3>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">::: warning
<span class="token italic"><span class="token punctuation">*</span><span class="token content">here be dragons</span><span class="token punctuation">*</span></span>
:::<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><em>here be dragons</em></p>
<h3 id="footnote">footnote</h3>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">Here is a footnote reference,[^1] and another.[^longnote]

<span class="token url-reference url"><span class="token punctuation">[</span><span class="token variable">^1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Here</span> is the footnote.

<span class="token url-reference url"><span class="token punctuation">[</span><span class="token variable">^longnote</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Here's</span> one with multiple blocks.

<span class="token code keyword">    Subsequent paragraphs are indented to show that they</span>
belong to the previous footnote.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Here is a footnote reference,<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup> and another.<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></p>
<p>belong to the previous footnote.</p>
<h3 id="markdown-it-imsize"><a target="_blank" rel="noopener" href="https://github.com/tatsy/markdown-it-imsize">markdown-it-imsize</a></h3>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token url"><span class="token operator">!</span>[<span class="token content">test</span>](<span class="token url">https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012022352.png</span>)</span>
![test](https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012022352.png =100x200)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012022352.png" alt="test"><br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012022352.png" alt="test" width="100" height="200"></p>
<h2 id="公式测试">公式测试</h2>
<blockquote>
<p>采用**<a target="_blank" rel="noopener" href="https://github.com/MakerGYT/markdown-it-latex2img">markdown-it-latex2img</a>**</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://makergyt.github.io/markdown-it-latex2img/">Demo</a></p>
<h3 id="1-数学公式">1 数学公式</h3>
<h4 id="1-1-内联公式">1.1 内联公式</h4>
<p><strong>开头的<code>$</code>必须在其右边紧跟一个非空格字符，而结尾的<code>$</code>必须在其左边紧接一个非空格字符，并且不能紧跟一个数字。</strong></p>
<ul>
<li>勾股定理: <img src="https://math.now.sh?inline=a%5E2%2Bb%5E2%3Dc%5E2" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;"></li>
<li>等差数列求和公式: <img src="https://math.now.sh?inline=S_%7Bn%7D%3Dn%20a_%7B1%7D%2B%5Cfrac%7Bn%28n-1%29%7D%7B2%7D%20d%2C%20n%20%5Cin%20N%5E%7B*%7D" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;"></li>
<li>牛顿-莱布尼茨公式: <img src="https://math.now.sh?inline=%5Cint_%7Ba%7D%5E%7Bb%7D%20f%28x%29%20d%20x%3DF(b)-F(a)%3D%5Cleft.F(x)%5Cright%7C_%7Ba%7D%20%5E%7Bb%7D" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;"></li>
<li>二项分布: <img src="https://math.now.sh?inline=P_%7Bn%7D%28k%29%3DC_%7Bn%7D%5E%7Bk%7D%20p%5E%7Bk%7D%20q%5E%7Bn-k%7D%20%5Cquad%20k%3D0%2C1%2C2%20%5Cldots%20%5Cldots%2C%20n" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;"></li>
</ul>
<h4 id="1-2-块公式">1.2 块公式</h4>
<p>正态分布<img src="https://math.now.sh?inline=X%20%5Csim%20N%28%5Cmu%2C%5Csigma%5E2%29" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;">:</p>
<p style="filter: opacity(90%);transform:scale(0.85);text-align:center;"><img src="https://math.now.sh?from=f%28x%29%20%3D%20%5Cfrac%7B1%7D%7B%5Csqrt%7B2%5Cpi%7D%5Csigma%7De%5E%7B-%5Cfrac%7B(x-%5Cmu)%5E2%7D%7B2%5Csigma%5E2%7D%7D%0A"></p><p>斐波那契数列<img src="https://math.now.sh?inline=A_n%3DA_%7Bn-1%7D%2BA_%7Bn-2%7D" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;">,前后两项的比值逐渐收敛到黄金分割比例</p>
<p style="filter: opacity(90%);transform:scale(0.85);text-align:center;"><img src="https://math.now.sh?from=%5Clim_%7Bn%5Cto%20%5Cinfty%7D%5Cfrac%7BA_%7Bn-1%7D%7D%7BA_n%7D%3D%5Cfrac%7B%5Csqrt%7B5%7D-1%7D%7B2%7D.%0A"></p><p>因式分解</p>
<p style="filter: opacity(90%);transform:scale(0.85);text-align:center;"><img src="https://math.now.sh?from=%5Cbegin%7Bsplit%7D%28x%E2%88%921%29(x%E2%88%923)%26%3Dx%5E2%E2%88%924x%2B3%20%5C%5C%20%0A%26%3Dx%5E2%E2%88%924x%2B4%E2%88%921%20%5C%5C%20%0A%26%3D(x%E2%88%922)%5E2%E2%88%921%0A%5Cend%7Bsplit%7D%0A"></p><p>狄利克雷函数</p>
<p style="filter: opacity(90%);transform:scale(0.85);text-align:center;"><img src="https://math.now.sh?from=D%28x%29%3D%0A%5Cbegin%7Bcases%7D%0A1%2C%26%20x%20%5Cin%20Q%20%5C%5C%0A0%2C%26%20x%20%5Cnotin%20Q%0A%5Cend%7Bcases%7D%0A"></p><p>高斯公式</p>
<p style="filter: opacity(90%);transform:scale(0.85);text-align:center;"><img src="https://math.now.sh?from=%5Ciiint_%7B%5COmega%7D%5Cleft%28%5Cfrac%7B%5Cpartial%20P%7D%7B%5Cpartial%20x%7D%2B%5Cfrac%7B%5Cpartial%20Q%7D%7B%5Cpartial%20y%7D%2B%5Cfrac%7B%5Cpartial%20R%7D%7B%5Cpartial%20z%7D%5Cright%29%20d%20v%3D%5Ciint_%7B%5CSigma%7D%20P%20d%20y%20d%20z%2BQ%20d%20z%20d%20x%2BR%20d%20x%20d%20y%0A"></p><p>范德蒙行列式</p>
<p style="filter: opacity(90%);transform:scale(0.85);text-align:center;"><img src="https://math.now.sh?from=D_%7Bn-1%7D%3D%5Cleft%7C%5Cbegin%7Barray%7D%7Bcccc%7D%0A1%20%26%201%20%26%20%5Cdots%20%26%201%20%5C%5C%0Ax_%7B2%7D%20%26%20x_%7B3%7D%20%26%20%5Cdots%20%26%20x_%7Bn%7D%20%5C%5C%0A%5Cvdots%20%26%20%5Cvdots%20%26%20%26%20%5Cvdots%20%5C%5C%0Ax_%7B2%7D%5E%7Bn-2%7D%20%26%20x_%7B3%7D%5E%7Bn-2%7D%20%26%20%5Cdots%20%26%20x_%7Bn%7D%5E%7Bn-2%7D%0A%5Cend%7Barray%7D%5Cright%7C%3D%5Cprod_%7B2%20%5Cleq%20j%3Ci%20%5Cleq%20n%7D%5Cleft%28x_%7Bi%7D-x_%7Bj%7D%5Cright%29"></p><p>线性方程组</p>
<p style="filter: opacity(90%);transform:scale(0.85);text-align:center;"><img src="https://math.now.sh?from=%5Cleft%5C%7B%5Cbegin%7Baligned%7D%0Aa_%7B11%7D%20x_%7B1%7D%2Ba_%7B12%7D%20x_%7B2%7D%2B%5Ccdots%2Ba_%7B1%20n%7D%20x_%7Bn%7D%20%26%3Db_%7B1%7D%20%5C%5C%0Aa_%7B21%7D%20x_%7B1%7D%2Ba_%7B22%7D%20x_%7B2%7D%2B%5Ccdots%2Ba_%7B2%20n%7D%20x_%7Bn%7D%20%26%3Db_%7B2%7D%20%5C%5C%0A%5Ccdots%20%5Ccdots%20%5Ccdots%20%5C%5C%0Aa_%7Bm%201%7D%20x_%7B1%7D%2Ba_%7Bm%202%7D%20x_%7B2%7D%2B%5Ccdots%2Ba_%7Bm%20n%7D%20x_%7Bn%7D%20%26%3Db_%7Bm%7D%0A%5Cend%7Baligned%7D%5Cright."></p><h3 id="2-物理公式">2 物理公式</h3>
<ul>
<li>牛顿第一定律: <img src="https://math.now.sh?inline=%5Csum%20%5Cvec%7BF%7D_%7Bi%7D%3D%5Cfrac%7B%5Cmathrm%7Bd%7D%20%5Cvec%7Bv%7D%7D%7B%5Cmathrm%7Bd%7D%20t%7D%3D0" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;"></li>
<li>牛顿第二定律: <img src="https://math.now.sh?inline=%5Cvec%7BF%7D%3D%5Cfrac%7B%5Cmathrm%7Bd%7D%20m%7D%7B%5Cmathrm%7Bd%7D%20t%7D%20%5Cvec%7Bv%7D%2Bm%20%5Cfrac%7B%5Cmathrm%7Bd%7D%20%5Cvec%7Bv%7D%7D%7B%5Cmathrm%7Bd%7D%20t%7D%3D%5Cfrac%7B%5Cmathrm%7Bd%7D%20m%7D%7B%5Cmathrm%7Bd%7D%20t%7D%20%5Cvec%7Bv%7D%2Bm%20%5Cvec%7Ba%7D%3D%5Cfrac%7B%5Cmathrm%7Bd%7D%20m%7D%7B%5Cmathrm%7Bd%7D%20t%7D%20%5Cvec%7Bv%7D%2Bm%20%5Cfrac%7B%5Cmathrm%7Bd%7D%5E%7B2%7D%20%5Cvec%7Br%7D%7D%7B%5Cmathrm%7Bd%7D%20t%5E%7B2%7D%7D" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;"></li>
<li>牛顿第三定律: <img src="https://math.now.sh?inline=%5Coverrightarrow%7BF_%7B12%7D%7D%3D-%5Coverrightarrow%7BF_%7B21%7D%7D" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;"></li>
<li>质能守恒: <img src="https://math.now.sh?inline=E%3Dmc%5E2" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;"></li>
</ul>
<p>万有引力定律: <img src="https://math.now.sh?inline=F%3D%5Cfrac%7BG%20M%20m%7D%7Br%5E%7B2%7D%7D" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;"></p>
<p style="filter: opacity(90%);transform:scale(0.85);text-align:center;"><img src="https://math.now.sh?from=G%20%5Cfrac%7Bm%20M%7D%7B%28r%2Bh%29%5E%7B2%7D%7D%3Dm%20%5Cfrac%7B%5Cnu%5E%7B2%7D%7D%7B(r%2Bh)%7D%0A"></p><p>基尔霍夫定律</p>
<p style="filter: opacity(90%);transform:scale(0.85);text-align:center;"><img src="https://math.now.sh?from=%5Cleft%5B%5Cfrac%7B%5Cpartial%5Cleft%28%5CDelta_%7Br%7D%20H_%7Bm%7D%5Cright%29%7D%7B%5Cpartial%20T%7D%5Cright%5D_%7Bp%7D%3D%5Csum_%7BB%7D%20v_%7BB%7D%20C_%7Bp%2C%20m%7D(B)%0A"></p><p>热力学第二定律</p>
<p style="filter: opacity(90%);transform:scale(0.85);text-align:center;"><img src="https://math.now.sh?from=d%20S%20%5Cgeq%20%5Cfrac%7B%5Cdelta%20Q%7D%7BT%7D%0A"></p><h3 id="3-化学公式">3 化学公式</h3>
<p>离子反应与沉淀: <img src="https://math.now.sh?inline=%5Cce%7BSO4%5E2-%20%2B%20Ba%5E2%2B%20-%3E%20BaSO4%20v%7D" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;"></p>
<p>氮气氢气合成氨</p>
<p style="filter: opacity(90%);transform:scale(0.85);text-align:center;"><img src="https://math.now.sh?from=%5Cce%7BN2%20%2B%203H2%20%3C%3D%3ET%5B%E9%AB%98%E6%B8%A9%E3%80%81%E5%8A%A0%E5%8E%8B%5D%5B%E5%82%AC%E5%8C%96%E5%89%82%5D%202NH3%7D%0A"></p><p>化学平衡常数:<img src="https://math.now.sh?inline=%5Cmathrm%7BZn%7D%2B2%20%5Cmathrm%7BHCl%7D%28%5Cmathrm%7Baq%7D%29%3D%5Cmathrm%7BH%7D_%7B2%7D%2B%5Cmathrm%7BZnCl%7D_%7B2%7D%20%5Cquad(%5Cmathrm%7Baq%7D)" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;"></p>
<p style="filter: opacity(90%);transform:scale(0.85);text-align:center;"><img src="https://math.now.sh?from=K%5E%7B%5Ctheta%7D%3D%5Cfrac%7B%5Cleft%5Bp%5Cleft%28%5Cmathrm%7BH%7D_%7B2%7D%5Cright%29%20%2F%20p%5E%7B%5Ctheta%7D%5Cright%5D%5Cleft%5Bc%5Cleft(%5Cmathrm%7BZnCl%7D_%7B2%7D%5Cright)%5Cright%5D%7D%7Bc%5E%7B2%7D(%5Cmathrm%7BHC%7D)%7D%0A"></p><h3 id="4-生物公式">4 生物公式</h3>
<p>光合作用</p>
<p style="filter: opacity(90%);transform:scale(0.85);text-align:center;"><img src="https://math.now.sh?from=%5Cce%3C!--swig%EF%BF%BC75--%3E%0A"></p><h3 id="5-语法参考">5 语法参考</h3>
<p><a target="_blank" rel="noopener" href="https://math.meta.stackexchange.com/questions/5020/mathjax-basic-tutorial-and-quick-reference">MathJax basic tutorial and quick reference</a></p>
<h4 id="长公式">长公式</h4>
<p><img src="https://math.now.sh/?from=%5Cdef%20%5Clowercase%20%7B%5Calpha%20%5Cbeta%20%5Cgamma%20%5Cdelta%20%5Cepsilon%20%5Czeta%20%5Ceta%20%5Ctheta%20%5Ciota%20%5Ckappa%20%5Clambda%20%5Cmu%20%5Cnu%20%5Comicron%20%5Cpi%20%5Crho%20%5Csigma%20%5Ctau%20%5Cupsilon%20%5Cphi%20%5Cchi%20%5Cpsi%20%5Comega%7D%0A%5Cdef%20%5Cuppercase%20%7BA%20B%20%5CGamma%20%5CDelta%20E%20Z%20E%20%5CTheta%20I%20K%20%5CLambda%20M%20N%20O%20%5CPi%20R%20%5CSigma%20T%20%5CUpsilon%20%5CPhi%20X%20%5CPsi%20%5COmega%7D%0A%5Cdef%20%5Clong%20%7B%5Cuppercase%20%5CLeftrightarrow%20%5Clowercase%7D%0A" alt="img"></p>
<p><img src="https://math.now.sh/?inline=%5Ctext%7Blong%20inline%20mathjax%3A%7D%5Cquad%20%5Clong%20%5Cquad%20%5Clong%20%5Cquad%20%5Clong" alt="img"></p>
<p><img src="https://math.now.sh/?from=%5Ctext%7B%3C-%20long%20displayed%20mathjax%20example%20-%3E%7D%20%5C%5C%0A%5Cbegin%7Bsplit%7D%0A%5Clong%20%5Cquad%20%26%5Clong%20%5C%5C%0A%26%5Clong%20%5Cquad%20%5Clong%0A%5Cend%7Bsplit%7D%0A" alt="img"></p>
<h4 id="小括号测试">小括号测试</h4>
<pre class="line-numbers language-none"><code class="language-none">$\alpha\beta$

$\alpha_\beta$

$\alpha_\beta = \gamma_\delta$

(abctest)

\(abctest\)

\\(abctest\\)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://math.now.sh?inline=%5Calpha%5Cbeta" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;"></p>
<p><img src="https://math.now.sh?inline=%5Calpha_%5Cbeta" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;"></p>
<p><img src="https://math.now.sh?inline=%5Calpha_%5Cbeta%20%3D%20%5Cgamma_%5Cdelta" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;"></p>
<p>(abctest)</p>
<p>(abctest)</p>
<p>\(abctest\)</p>
<h4 id="下划线测试">下划线测试</h4>
<pre class="line-numbers language-none"><code class="language-none">w^{(l)}*{ij} = w^{(l)}*{ij} - \eta\frac{\partial E(W, b)}{\partial w^{(l)}_{ij}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://math.now.sh/?from=w%5E%7B%28l%29%7D*%7Bij%7D%20%3D%20w%5E%7B(l)%7D*%7Bij%7D%20-%20%5Ceta%5Cfrac%7B%5Cpartial%20E(W%2C%20b)%7D%7B%5Cpartial%20w%5E%7B(l)%7D_%7Bij%7D%7D%0A" alt="img"></p>
<h2 id="CSS测试">CSS测试</h2>
<p>文字增加背景色块 <span id="inline-blue">站点配置文件</span>,<br>
<span id="inline-purple">主题配置文件</span></p>
<pre class="line-numbers language-none"><code class="language-none">&lt;span id="inline-blue"&gt;站点配置文件&lt;/span&gt;, 
&lt;span id="inline-purple"&gt;主题配置文件&lt;/span&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="引用边框变色">引用边框变色</h3>
<p id="div-border-left-red">如果没有安装成功, 那可能就是墙的原因. 建议下载 `Node.js` 直接安装. </p>
<p id="div-border-top-blue">关于更多基本操作和基础知识, 请查阅 [Hexo](https://hexo.io/zh-cn/) 与 [NexT](http://theme-next.iissnan.com/) 官方文档.</p>  
<pre class="line-numbers language-none"><code class="language-none">&lt;p id="div-border-left-red"&gt;如果没有安装成功, 那可能就是墙的原因. 建议下载 `Node.js` 直接安装. &lt;/p&gt;
&lt;p id="div-border-top-blue"&gt;关于更多基本操作和基础知识, 请查阅 [Hexo](https://hexo.io/zh-cn/) 与 [NexT](http://theme-next.iissnan.com/) 官方文档.&lt;/p&gt;  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="图形边框效果">图形边框效果</h3>
<p><a id="download" target="_blank" rel="noopener" href="https://git-scm.com/download/win"><i class="fa fa-download"></i><span> Download Now</span><br>
</a></p>
<pre class="line-numbers language-none"><code class="language-none">&lt;a id="download" href="https://git-scm.com/download/win"&gt;&lt;i class="fa fa-download"&gt;&lt;/i&gt;&lt;span&gt; Download Now&lt;/span&gt;
&lt;/a&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>更多tips可参考 <a target="_blank" rel="noopener" href="https://yangbingdong.com/2017/build-blog-hexo-advanced">blog</a></p>
<h3 id="在文档中增加图标">在文档中增加图标</h3>
<ul>
<li><i class="fa fa-pencil"></i>支持Markdown<br>
<i>Hexo 支持 GitHub Flavored Markdown 的所有功能, 甚至可以整合 Octopress 的大多数插件. </i></li>
<li><i class="fa fa-cloud-upload"></i>一件部署<br>
<i>只需一条指令即可部署到Github Pages, 或其他网站</i></li>
<li><i class="fa fa-cog"></i>丰富的插件<br>
<i>Hexo 拥有强大的插件系统, 安装插件可以让 Hexo 支持 Jade, CoffeeScript. </i></li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">- &lt;i class="fa fa-pencil"&gt;&lt;/i&gt;支持Markdown
&lt;i&gt;Hexo 支持 GitHub Flavored Markdown 的所有功能, 甚至可以整合 Octopress 的大多数插件. &lt;/i&gt;
- &lt;i class="fa fa-cloud-upload"&gt;&lt;/i&gt;一件部署
&lt;i&gt;只需一条指令即可部署到Github Pages, 或其他网站&lt;/i&gt;
- &lt;i class="fa fa-cog"&gt;&lt;/i&gt;丰富的插件
&lt;i&gt;Hexo 拥有强大的插件系统, 安装插件可以让 Hexo 支持 Jade, CoffeeScript. &lt;/i&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><i class="fa fa-github"></i><br>
<i class="fa fa-github fa-lg"></i><br>
<i class="fa fa-github fa-2x"></i></p>
<pre class="line-numbers language-none"><code class="language-none">`&lt;i class="fa fa-github"&gt;&lt;/i&gt;`
`&lt;i class="fa fa-github fa-lg"&gt;&lt;/i&gt;`
`&lt;i class="fa fa-github fa-2x"&gt;&lt;/i&gt;`<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="图表绘制">图表绘制</h2>
<ul>
<li>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/JameChou/hexo-tag-mermaid">hexo-tag-mermaid</a></strong></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=hOwQoD6fIIIe7W28woagTQ%3D%3D.VHuPUTxtKKrWqD9OwRmRWowEiRhfZtrRRPW0tAHaUnugQA9ofUIFaPqb38gbAsyx"><strong>hexo-tag-plantuml</strong></a></p>
<blockquote>
<p>hexo-tag-plantuml is a tag plugin for Hexo. It can work with plantuml to draw uml.</p>
</blockquote>
<p>在Hexo中绘制uml图。</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=7CVDHj4WMnK6vHwS3JXOAQ%3D%3D.VqG%2BdxXCAb%2FdHLPgRnzrtjEUBUuK1EhF%2Fo7ev0Banu7ADAa3cS1GF4ROLNNWkriO"><strong>hexo-filter-flowchart</strong></a></p>
<blockquote>
<p>Generate flowchart diagrams for Hexo.</p>
</blockquote>
</li>
</ul>
<h2 id="Mermaid">Mermaid</h2>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/horsee/category_10772579.html">Markdown mermaid教程</a></p>
</blockquote>
<h3 id="mermaid"><a target="_blank" rel="noopener" href="https://github.com/mermaid-js/mermaid">mermaid</a></h3>
<p><a target="_blank" rel="noopener" href="https://github.com/JameChou/hexo-tag-mermaid">hexo-tag-mermaid</a><a target="_blank" rel="noopener" href="https://github.com/two/hexo-tag-plantuml">hexo-tag-plantuml</a></p>
<blockquote>
<p><strong>需要用下面块包裹</strong></p>
</blockquote>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% mermaid %}
[内容]
{% endmermaid %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>先来几个演示</p>
<div class="mermaid">
  graph LR 
	source(*.java) --javac--&gt; bytecode(*.class) 
	bytecode --java--&gt; result(程序输出)
</div>

<div class="mermaid">
  graph LR 
	type(type) -.-&gt; type 
	type -.-&gt; object(object) 
	type -.-&gt; A(A) 
	type -.-&gt; int(int) 
	A -.-&gt; a((a)) 
	int -.-&gt; i((i)) 
	object --&gt; type 
	object --&gt; A
</div>

<h3 id="flowchart">flowchart</h3>
<p>[<a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid/#/flowchart">docs</a> - <a target="_blank" rel="noopener" href="https://mermaidjs.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiZ3JhcGggVERcbiAgICBBW0hhcmRdIC0tPnxUZXh0fCBCKFJvdW5kKVxuICAgIEIgLS0-IEN7RGVjaXNpb259XG4gICAgQyAtLT58T25lfCBEW1Jlc3VsdCAxXVxuICAgIEMgLS0-fFR3b3wgRVtSZXN1bHQgMl0iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9fQ">live editor</a>]</p>
<pre class="line-numbers language-none"><code class="language-none">{% mermaid %}
graph TD
    A[Christmas] --&gt;|Get money| B(Go shopping)
    B --&gt; C{Let me think}
    C --&gt;|One| D[Laptop]
    C --&gt;|Two| E[iPhone]
    C --&gt;|Three| F[Car]
{% endmermaid %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<div class="mermaid">
  graph TD
    A[Christmas] --&gt;|Get money| B(Go shopping)
    B --&gt; C{Let me think}
    C --&gt;|One| D[Laptop]
    C --&gt;|Two| E[iPhone]
    C --&gt;|Three| F[Car]
</div>

<h3 id="Sequence-diagram">Sequence <strong>diagram</strong></h3>
<p>[<a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid/#/sequenceDiagram">docs</a> - <a target="_blank" rel="noopener" href="https://mermaidjs.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5BbGljZS0-PkpvaG46IEhlbGxvIEpvaG4sIGhvdyBhcmUgeW91P1xubG9vcCBIZWFsdGhjaGVja1xuICAgIEpvaG4tPj5Kb2huOiBGaWdodCBhZ2FpbnN0IGh5cG9jaG9uZHJpYVxuZW5kXG5Ob3RlIHJpZ2h0IG9mIEpvaG46IFJhdGlvbmFsIHRob3VnaHRzIVxuSm9obi0tPj5BbGljZTogR3JlYXQhXG5Kb2huLT4-Qm9iOiBIb3cgYWJvdXQgeW91P1xuQm9iLS0-PkpvaG46IEpvbGx5IGdvb2QhIiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQifX0">live editor</a>]</p>
<pre class="line-numbers language-none"><code class="language-none">{% mermaid %}
sequenceDiagram
    loop every day
        Alice-&gt;&gt;John: Hello John, how are you?
        John--&gt;&gt;Alice: Great!
    end
{% endmermaid %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<div class="mermaid">
  sequenceDiagram
    loop every day
        Alice-&gt;&gt;John: Hello John, how are you?
        John--&gt;&gt;Alice: Great!
    end
</div>

<h3 id="Gantt-diagram">Gantt <strong>diagram</strong></h3>
<p>[<a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid/#/gantt">docs</a> - <a target="_blank" rel="noopener" href="https://mermaidjs.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiZ2FudHRcbnNlY3Rpb24gU2VjdGlvblxuQ29tcGxldGVkIDpkb25lLCAgICBkZXMxLCAyMDE0LTAxLTA2LDIwMTQtMDEtMDhcbkFjdGl2ZSAgICAgICAgOmFjdGl2ZSwgIGRlczIsIDIwMTQtMDEtMDcsIDNkXG5QYXJhbGxlbCAxICAgOiAgICAgICAgIGRlczMsIGFmdGVyIGRlczEsIDFkXG5QYXJhbGxlbCAyICAgOiAgICAgICAgIGRlczQsIGFmdGVyIGRlczEsIDFkXG5QYXJhbGxlbCAzICAgOiAgICAgICAgIGRlczUsIGFmdGVyIGRlczMsIDFkXG5QYXJhbGxlbCA0ICAgOiAgICAgICAgIGRlczYsIGFmdGVyIGRlczQsIDFkIiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQifX0">live editor</a>]</p>
<pre class="line-numbers language-none"><code class="language-none">{% mermaid %}
gantt
    dateFormat  YYYY-MM-DD
    title Adding GANTT diagram functionality to mermaid

    section A section
    Completed task            :done,    des1, 2014-01-06,2014-01-08
    Active task               :active,  des2, 2014-01-09, 3d
    Future task               :         des3, after des2, 5d
    Future task2               :         des4, after des3, 5d

    section Critical tasks
    Completed task in the critical line :crit, done, 2014-01-06,24h
    Implement parser and jison          :crit, done, after des1, 2d
    Create tests for parser             :crit, active, 3d
    Future task in critical line        :crit, 5d
    Create tests for renderer           :2d
    Add to mermaid                      :1d

    section Documentation
    Describe gantt syntax               :active, a1, after des1, 3d
    Add gantt diagram to demo page      :after a1  , 20h
    Add another diagram to demo page    :doc1, after a1  , 48h

    section Last section
    Describe gantt syntax               :after doc1, 3d
    Add gantt diagram to demo page      : 20h
    Add another diagram to demo page    : 48h
{% endmermaid %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<div class="mermaid">
  gantt
    dateFormat  YYYY-MM-DD
    title Adding GANTT diagram functionality to mermaid

    section A section
    Completed task            :done,    des1, 2014-01-06,2014-01-08
    Active task               :active,  des2, 2014-01-09, 3d
    Future task               :         des3, after des2, 5d
    Future task2               :         des4, after des3, 5d
    
    section Critical tasks
    Completed task in the critical line :crit, done, 2014-01-06,24h
    Implement parser and jison          :crit, done, after des1, 2d
    Create tests for parser             :crit, active, 3d
    Future task in critical line        :crit, 5d
    Create tests for renderer           :2d
    Add to mermaid                      :1d
    
    section Documentation
    Describe gantt syntax               :active, a1, after des1, 3d
    Add gantt diagram to demo page      :after a1  , 20h
    Add another diagram to demo page    :doc1, after a1  , 48h
    
    section Last section
    Describe gantt syntax               :after doc1, 3d
    Add gantt diagram to demo page      : 20h
    Add another diagram to demo page    : 48h
</div>

<h3 id="ER图">ER图</h3>
<div class="mermaid">
  erDiagram
    CUSTOMER ||--o{ ORDER : places
    CUSTOMER {
        string name
        string custNumber
        string sector
    }
    ORDER ||--|{ LINE-ITEM : contains
    ORDER {
        int orderNumber
        string deliveryAddress
    }
    LINE-ITEM {
        string productCode
        int quantity
        float pricePerUnit
    }
</div>

<pre class="line-numbers language-none"><code class="language-none">erDiagram
    CUSTOMER ||--o{ ORDER : places
    CUSTOMER {
        string name
        string custNumber
        string sector
    }
    ORDER ||--|{ LINE-ITEM : contains
    ORDER {
        int orderNumber
        string deliveryAddress
    }
    LINE-ITEM {
        string productCode
        int quantity
        float pricePerUnit
    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="class"><strong>class</strong></h3>
<p>[<a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid/#/classDiagram">docs</a> - <a target="_blank" rel="noopener" href="https://mermaidjs.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiY2xhc3NEaWFncmFtXG5DbGFzczAxIDx8LS0gQXZlcnlMb25nQ2xhc3MgOiBDb29sXG48PGludGVyZmFjZT4-IENsYXNzMDFcbkNsYXNzMDkgLS0-IEMyIDogV2hlcmUgYW0gaT9cbkNsYXNzMDkgLS0qIEMzXG5DbGFzczA5IC0tfD4gQ2xhc3MwN1xuQ2xhc3MwNyA6IGVxdWFscygpXG5DbGFzczA3IDogT2JqZWN0W10gZWxlbWVudERhdGFcbkNsYXNzMDEgOiBzaXplKClcbkNsYXNzMDEgOiBpbnQgY2hpbXBcbkNsYXNzMDEgOiBpbnQgZ29yaWxsYVxuY2xhc3MgQ2xhc3MxMCB7XG4gID4-c2VydmljZT4-XG4gIGludCBpZFxuICBzaXplKClcbn0iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9fQ">live editor</a>]</p>
<pre class="line-numbers language-none"><code class="language-none">classDiagram
class Shape{
    &lt;&lt;interface&gt;&gt;
    noOfVertices
    draw()
}
class Color{
    &lt;&lt;enumeration&gt;&gt;
    RED
    BLUE
    GREEN
    WHITE
    BLACK
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<div class="mermaid">
  classDiagram
class Shape{
    &lt;<interface>&gt;
    noOfVertices
    draw()
}
class Color{
    &lt;<enumeration>&gt;
    RED
    BLUE
    GREEN
    WHITE
    BLACK
}
</enumeration></interface></div>

<h3 id="State"><strong>State</strong></h3>
<p>[<a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid/#/stateDiagram">docs</a> - <a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic3RhdGVEaWFncmFtLXYyXG4gICAgWypdIC0tPiBTdGlsbFxuICAgIFN0aWxsIC0tPiBbKl1cbiAgICBTdGlsbCAtLT4gTW92aW5nXG4gICAgTW92aW5nIC0tPiBTdGlsbFxuICAgIE1vdmluZyAtLT4gQ3Jhc2hcbiAgICBDcmFzaCAtLT4gWypdIiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQiLCJ0aGVtZVZhcmlhYmxlcyI6eyJiYWNrZ3JvdW5kIjoid2hpdGUiLCJwcmltYXJ5Q29sb3IiOiIjRUNFQ0ZGIiwic2Vjb25kYXJ5Q29sb3IiOiIjZmZmZmRlIiwidGVydGlhcnlDb2xvciI6ImhzbCg4MCwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpIiwicHJpbWFyeUJvcmRlckNvbG9yIjoiaHNsKDI0MCwgNjAlLCA4Ni4yNzQ1MDk4MDM5JSkiLCJzZWNvbmRhcnlCb3JkZXJDb2xvciI6ImhzbCg2MCwgNjAlLCA4My41Mjk0MTE3NjQ3JSkiLCJ0ZXJ0aWFyeUJvcmRlckNvbG9yIjoiaHNsKDgwLCA2MCUsIDg2LjI3NDUwOTgwMzklKSIsInByaW1hcnlUZXh0Q29sb3IiOiIjMTMxMzAwIiwic2Vjb25kYXJ5VGV4dENvbG9yIjoiIzAwMDAyMSIsInRlcnRpYXJ5VGV4dENvbG9yIjoicmdiKDkuNTAwMDAwMDAwMSwgOS41MDAwMDAwMDAxLCA5LjUwMDAwMDAwMDEpIiwibGluZUNvbG9yIjoiIzMzMzMzMyIsInRleHRDb2xvciI6IiMzMzMiLCJtYWluQmtnIjoiI0VDRUNGRiIsInNlY29uZEJrZyI6IiNmZmZmZGUiLCJib3JkZXIxIjoiIzkzNzBEQiIsImJvcmRlcjIiOiIjYWFhYTMzIiwiYXJyb3doZWFkQ29sb3IiOiIjMzMzMzMzIiwiZm9udEZhbWlseSI6IlwidHJlYnVjaGV0IG1zXCIsIHZlcmRhbmEsIGFyaWFsIiwiZm9udFNpemUiOiIxNnB4IiwibGFiZWxCYWNrZ3JvdW5kIjoiI2U4ZThlOCIsIm5vZGVCa2ciOiIjRUNFQ0ZGIiwibm9kZUJvcmRlciI6IiM5MzcwREIiLCJjbHVzdGVyQmtnIjoiI2ZmZmZkZSIsImNsdXN0ZXJCb3JkZXIiOiIjYWFhYTMzIiwiZGVmYXVsdExpbmtDb2xvciI6IiMzMzMzMzMiLCJ0aXRsZUNvbG9yIjoiIzMzMyIsImVkZ2VMYWJlbEJhY2tncm91bmQiOiIjZThlOGU4IiwiYWN0b3JCb3JkZXIiOiJoc2woMjU5LjYyNjE2ODIyNDMsIDU5Ljc3NjUzNjMxMjglLCA4Ny45MDE5NjA3ODQzJSkiLCJhY3RvckJrZyI6IiNFQ0VDRkYiLCJhY3RvclRleHRDb2xvciI6ImJsYWNrIiwiYWN0b3JMaW5lQ29sb3IiOiJncmV5Iiwic2lnbmFsQ29sb3IiOiIjMzMzIiwic2lnbmFsVGV4dENvbG9yIjoiIzMzMyIsImxhYmVsQm94QmtnQ29sb3IiOiIjRUNFQ0ZGIiwibGFiZWxCb3hCb3JkZXJDb2xvciI6ImhzbCgyNTkuNjI2MTY4MjI0MywgNTkuNzc2NTM2MzEyOCUsIDg3LjkwMTk2MDc4NDMlKSIsImxhYmVsVGV4dENvbG9yIjoiYmxhY2siLCJsb29wVGV4dENvbG9yIjoiYmxhY2siLCJub3RlQm9yZGVyQ29sb3IiOiIjYWFhYTMzIiwibm90ZUJrZ0NvbG9yIjoiI2ZmZjVhZCIsIm5vdGVUZXh0Q29sb3IiOiJibGFjayIsImFjdGl2YXRpb25Cb3JkZXJDb2xvciI6IiM2NjYiLCJhY3RpdmF0aW9uQmtnQ29sb3IiOiIjZjRmNGY0Iiwic2VxdWVuY2VOdW1iZXJDb2xvciI6IndoaXRlIiwic2VjdGlvbkJrZ0NvbG9yIjoicmdiYSgxMDIsIDEwMiwgMjU1LCAwLjQ5KSIsImFsdFNlY3Rpb25Ca2dDb2xvciI6IndoaXRlIiwic2VjdGlvbkJrZ0NvbG9yMiI6IiNmZmY0MDAiLCJ0YXNrQm9yZGVyQ29sb3IiOiIjNTM0ZmJjIiwidGFza0JrZ0NvbG9yIjoiIzhhOTBkZCIsInRhc2tUZXh0TGlnaHRDb2xvciI6IndoaXRlIiwidGFza1RleHRDb2xvciI6IndoaXRlIiwidGFza1RleHREYXJrQ29sb3IiOiJibGFjayIsInRhc2tUZXh0T3V0c2lkZUNvbG9yIjoiYmxhY2siLCJ0YXNrVGV4dENsaWNrYWJsZUNvbG9yIjoiIzAwMzE2MyIsImFjdGl2ZVRhc2tCb3JkZXJDb2xvciI6IiM1MzRmYmMiLCJhY3RpdmVUYXNrQmtnQ29sb3IiOiIjYmZjN2ZmIiwiZ3JpZENvbG9yIjoibGlnaHRncmV5IiwiZG9uZVRhc2tCa2dDb2xvciI6ImxpZ2h0Z3JleSIsImRvbmVUYXNrQm9yZGVyQ29sb3IiOiJncmV5IiwiY3JpdEJvcmRlckNvbG9yIjoiI2ZmODg4OCIsImNyaXRCa2dDb2xvciI6InJlZCIsInRvZGF5TGluZUNvbG9yIjoicmVkIiwibGFiZWxDb2xvciI6ImJsYWNrIiwiZXJyb3JCa2dDb2xvciI6IiM1NTIyMjIiLCJlcnJvclRleHRDb2xvciI6IiM1NTIyMjIiLCJjbGFzc1RleHQiOiIjMTMxMzAwIiwiZmlsbFR5cGUwIjoiI0VDRUNGRiIsImZpbGxUeXBlMSI6IiNmZmZmZGUiLCJmaWxsVHlwZTIiOiJoc2woMzA0LCAxMDAlLCA5Ni4yNzQ1MDk4MDM5JSkiLCJmaWxsVHlwZTMiOiJoc2woMTI0LCAxMDAlLCA5My41Mjk0MTE3NjQ3JSkiLCJmaWxsVHlwZTQiOiJoc2woMTc2LCAxMDAlLCA5Ni4yNzQ1MDk4MDM5JSkiLCJmaWxsVHlwZTUiOiJoc2woLTQsIDEwMCUsIDkzLjUyOTQxMTc2NDclKSIsImZpbGxUeXBlNiI6ImhzbCg4LCAxMDAlLCA5Ni4yNzQ1MDk4MDM5JSkiLCJmaWxsVHlwZTciOiJoc2woMTg4LCAxMDAlLCA5My41Mjk0MTE3NjQ3JSkifX0sInVwZGF0ZUVkaXRvciI6ZmFsc2V9">live editor</a>]</p>
<pre class="line-numbers language-none"><code class="language-none">{% mermaid %}
stateDiagram-v2
    [*] --&gt; Still
    Still --&gt; [*]
    Still --&gt; Moving
    Moving --&gt; Still
    Moving --&gt; Crash
    Crash --&gt; [*]
{% endmermaid %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<div class="mermaid">
  stateDiagram-v2
    [*] --&gt; Still
    Still --&gt; [*]
    Still --&gt; Moving
    Moving --&gt; Still
    Moving --&gt; Crash
    Crash --&gt; [*]
</div>

<h3 id="Pie"><strong>Pie</strong></h3>
<p>[<a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid/#/pie">docs</a> - <a target="_blank" rel="noopener" href="https://mermaidjs.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoicGllXG5cIkRvZ3NcIiA6IDQyLjk2XG5cIkNhdHNcIiA6IDUwLjA1XG5cIlJhdHNcIiA6IDEwLjAxIiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQifX0">live editor</a>]</p>
<pre class="line-numbers language-none"><code class="language-none">{% mermaid %}
pie
"Dogs" : 386
"Cats" : 85
"Rats" : 15
{% endmermaid %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<div class="mermaid">
  pie
"Dogs" : 386
"Cats" : 85
"Rats" : 15
</div>

<h3 id="User-Journey"><strong>User Journey</strong></h3>
<p>[<a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid/#/user-journey">docs</a> - <a target="_blank" rel="noopener" href="https://mermaidjs.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic3RhdGVEaWFncmFtXG4gICAgWypdIC0tPiBTdGlsbFxuICAgIFN0aWxsIC0tPiBbKl1cbiAgICBTdGlsbCAtLT4gTW92aW5nXG4gICAgTW92aW5nIC0tPiBTdGlsbFxuICAgIE1vdmluZyAtLT4gQ3Jhc2hcbiAgICBDcmFzaCAtLT4gWypdIiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQifX0">live editor</a>]</p>
<pre class="line-numbers language-none"><code class="language-none">{% mermaid %}
	  journey
    title My working day
    section Go to work
      Make tea: 5: Me
      Go upstairs: 3: Me
      Do work: 1: Me, Cat
    section Go home
      Go downstairs: 5: Me
      Sit down: 3: Me
{% endmermaid %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<div class="mermaid">
  journey
 title My working day
 section Go to work
   Make tea: 5: Me
   Go upstairs: 3: Me
   Do work: 1: Me, Cat
 section Go home
   Go downstairs: 5: Me
   Sit down: 3: Me
</div>

<h2 id="plant-uml">plant uml</h2>
<p><a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=ZnkRBa%2Fre3TQCl7KNJg2Sg%3D%3D.ZEjsSgGk0F1LOYjRqQLWGcsHdjIHjXJJNCwT20OKlas%3D"><strong>PlantUML</strong> </a>是一个允许你快速编写一下图表的组件 :</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=WnNQQpbhwLLtOvy0iZznAw%3D%3D.ufDzIrmSHLTJOvU%2B%2BrCbHKX7i%2BXDfiAs43p47%2Brd6CPQPzmoRjTx9Yjer2eCPMIx">Sequence diagram</a>（时序图）</li>
<li><a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=swyHFudu0Dv1kgG36K6uKQ%3D%3D.%2F3OTiCZ42cJb5Qx7sx3T0xkD8UzUl2QpmT5nScfRShRBbDCjvTAYmIjQBdcndh5P">Usecase diagram</a></li>
<li><a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=y2iylEjbyP1BkiOoSD3aBQ%3D%3D.Uk3N50fH52eqKvi5pR9V2dCwZ2t88GyGCkB56t0bi51SDzK3TAm8q%2F%2BknYaMp6gq">Class diagram</a>（类图）</li>
<li><a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=ZPF3Fm60rmWHTd6iqgefYw%3D%3D.hetxaEZitHOTlwF26EQHW1ze%2BqQe28tO5Zan9A6PQD7tELizzdVt2LCwJ7Wqni8N">Activity diagram</a> (here is <a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=G1AlcTWhXkwCzalwXO04Tw%3D%3D.RKEPVfhovignZnpee9bltjlVeAZ25VKK5bSbzmo2G225h2cQ3wEKM8LyC23GxRLL">the legacy syntax)</a></li>
<li><a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=Vxtv5M%2FcCgkpBtyWH8mDCA%3D%3D.xTXdTliRpsnQ8OniXrs1V6YfjTy0nSFbS7l7wqvn0uACpHlTJNL9BlF0xb7vfM4Z">Component diagram</a></li>
<li><a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=asRZoWO7I5UQ3wuP84r8hg%3D%3D.vyIPg7GpNKjSjf7e2IS4KO%2Bg6SnD1DLe9DYb9T1CuW2U41s72PgDFuT0hbkp2BO9">State diagram</a></li>
<li><a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=WMWDuC4PoXS%2BUq8UK%2B6m6Q%3D%3D.UaRzixgD%2B8x%2BRoBPDjArHXZEVWCpjnRwzoBn9HZDWAgyM2iggTjoxPJrpjuH5nZL">Object diagram</a></li>
<li><a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=4QYG%2FOLv5kpCA0Wur4JTBg%3D%3D.Ci3AIvz1ie0I6BCUt8a%2BaklDx8hJvKPujkVdWDGw%2BzDTkfdnBBhY5GhX9mIITaMb">Deployment diagram</a>(BETA)</li>
<li><a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=%2Bi9ecBhjJV%2Fo6bPpIo6zEw%3D%3D.b0HW%2B0h7iKI3LibmVdbEmi77twGMobstSrkBWn2n6AucZmIcrNRI7QEhpDEMrUTR">Timing diagram</a>(BETA)</li>
</ul>
<p>Hexo安装hexo-tag-plantuml插件，便能使其绘制的图表在博客上展示，其原理其实使用的是 PlantUML 提供的在线服务, 只是简单地将标签包裹的代码传给服务器, 获取生成的链接, 生成 img标签替换原来的代码区域.</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=Om2tsztpVQpl48NLQP8wPg%3D%3D.lA5QuvRnDCcbundLA81sGH8MG3E6QjnIJQ6%2BgojZWH8%3D">plantUML在线编辑网站</a></p>
</blockquote>
<p>可使用HTML标签将其嵌套</p>
<pre class="line-numbers language-none"><code class="language-none">{% plantuml %}
title Relationships - Class Diagram

class Dwelling {
  +Int Windows
  +void LockTheDoor()
}

class Apartment
class House
class Commune
class Window
class Door

Dwelling &lt;|-down- Apartment: Inheritance
Dwelling &lt;|-down- Commune: Inheritance
Dwelling &lt;|-down- House: Inheritance
Dwelling "1" *-up- "many" Window: Composition
Dwelling "1" *-up- "many" Door: Composition
{% endplantuml %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="http://www.plantuml.com/plantuml/svg/XP0z2y8m48Rt_8gZanzaS2qkKWSBJY8uXpQqXybTQ5ABgF_TrhQAuCUMbpptt4V0O3Jij541cNo9peE4n2ZlOOsgg9GL8kjZeur1Ak0Y0EOf1JWWvTpuBfuOSzXoTjoNUirSJQRYDXQkdAg2rHI6lE7Qw-6TiBKrZQaNZlrQZH3FhikhRFz8ldGnf5Jg2eEYJ7y01_S_x37E5oXQH32JjPCGMKNdQ9WmxjoEFNP7-q5tAxonTm00">
<pre class="line-numbers language-none"><code class="language-none">{% plantuml %}
[内容]
{% endplantuml %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="时序图"><a target="_blank" rel="noopener" href="https://plantuml.com/zh/timing-diagram">时序图</a></h3>
<pre class="line-numbers language-none"><code class="language-none">{% plantuml %}
    Bob-&gt;Alice : hello
{% endplantuml %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<img src="http://www.plantuml.com/plantuml/svg/SyfFqhLppCbCJbMmKiX8pSd91m00">
<pre class="line-numbers language-none"><code class="language-none">Alice -&gt; Bob: Authentication Request
Bob --&gt; Alice: Authentication Response

Alice -&gt; Bob: Another authentication Request
Alice &lt;-- Bob: Another authentication Response<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="http://www.plantuml.com/plantuml/svg/Syp9J4vLqBLJSCfFib9mB2t9ICqhoKnEBCdCprC8IYqiJIqkuGBAAUW2rJY256DHLLoGdrUSoiNbY6fONZvGNP528dP38OfjT7K9g8OO3W00">
<h3 id="用例图"><a target="_blank" rel="noopener" href="https://plantuml.com/zh/use-case-diagram">用例图</a></h3>
<pre class="line-numbers language-none"><code class="language-none">{% plantuml %}
User -&gt; (Start)
User --&gt; (Use the application) : A small label

:Main Admin: ---&gt; (Use the application) : This is\nyet another\nlabel
{% endplantuml %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="类图"><a target="_blank" rel="noopener" href="https://plantuml.com/zh/class-diagram">类图</a></h3>
<pre class="line-numbers language-none"><code class="language-none">{% plantuml %}
class Object &lt;&lt; general &gt;&gt;
Object &lt;|--- ArrayList

note top of Object : In java, every class\nextends this one.

note "This is a floating note" as N1
note "This note is connected\nto several objects." as N2
Object .. N2
N2 .. ArrayList

class Foo
note left: On last defined class
{% endplantuml %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="活动图"><a target="_blank" rel="noopener" href="https://plantuml.com/zh/activity-diagram-beta">活动图</a></h3>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% plantuml %}
@startuml
start

if (Graphviz 已安装?) then (yes)
  :处理所有\n绘制任务;
else (no)
  :仅处理
  <span class="token bold"><span class="token punctuation">__</span><span class="token content">时序图</span><span class="token punctuation">__</span></span> 和 <span class="token bold"><span class="token punctuation">__</span><span class="token content">活动</span><span class="token punctuation">__</span></span> 图;
endif

stop
@enduml
{% endplantuml %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="http://www.plantuml.com/plantuml/svg/SoWkIImgAStDuG8pkBWoqnGqt8iI2pBACgiKdcxVz7HTvul5hVQQ2YKPgNaA6fMfnPfS2WfMJvUqF9_GzgopuTcSpfYyvxjdFEtOzcJtxgTT2wsvKdEAKnKqylB12f_iReMe1NBYuvzDt_PqL__JsVlYunMUJke1YMm1Qbe1uixU1zIQbvAPnWLqItu1bmEG0tGO0000">
<h3 id="组件图"><a target="_blank" rel="noopener" href="https://plantuml.com/zh/component-diagram">组件图</a></h3>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% plantuml %}
@startuml

[First component]
[Another component] as Comp2
component Comp3
component [Last\ncomponent] as Comp4

@enduml
{% endplantuml %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="http://www.plantuml.com/plantuml/svg/SoWkIImgAStDuUAATiiiAYvHICxFBSZFIyqhYUMATipBByb8BK8IKqWiLd06yeouu69WlZ4IFzediRWa9WzJamaNbqDgNWhGDW00">
<h3 id="状态图"><a target="_blank" rel="noopener" href="https://plantuml.com/zh/state-diagram">状态图</a></h3>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% plantuml %}
@startuml

[<span class="token italic"><span class="token punctuation">*</span><span class="token content">] --&gt; State1
State1 --&gt; [</span><span class="token punctuation">*</span></span>]
State1 : this is a string
State1 : this is another string

State1 -&gt; State2
State2 --&gt; [*]

@enduml
{% endplantuml %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="http://www.plantuml.com/plantuml/svg/SoWkIImgAStDuUAArefLqDMrKmWkIIn9DUI2K60He0oCQwLGaf5Ph014YGh59KMPUUbOPFBoIp9IYs3oS9EWHXj118pWHdCvfEQb09q00000">
<h3 id="对象图"><a target="_blank" rel="noopener" href="https://plantuml.com/zh/object-diagram">对象图</a></h3>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% plantuml %}
@startuml PERT
left to right direction
' Horizontal lines: --&gt;, <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>--,</span> <span class="token attr-name">&lt;--</span><span class="token punctuation">&gt;</span></span>
' Vertical lines: -&gt;, <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>-,</span> <span class="token attr-name">&lt;-</span><span class="token punctuation">&gt;</span></span>
title PERT: Project Name

map Kick.Off {
}
map task.1 {
    Start =&gt; End
}
map task.2 {
    Start =&gt; End
}
map task.3 {
    Start =&gt; End
}
map task.4 {
    Start =&gt; End
}
map task.5 {
    Start =&gt; End
}
Kick.Off --&gt; task.1 : Label 1
Kick.Off --&gt; task.2 : Label 2
Kick.Off --&gt; task.3 : Label 3
task.1 --&gt; task.4
task.2 --&gt; task.4
task.3 --&gt; task.4
task.4 --&gt; task.5 : Label 4
@enduml
{% endplantuml %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="http://www.plantuml.com/plantuml/svg/XP7DQiCm48Jl-nHpwoKEn3yNqvfS0e64r3IbTyMM4oMo5EJjfQNl7iMaIcWD5gn0yosp8tRUiN3ysMgKYxTtqh9Xi8LJ-mEZLavMhAoX9oojKr_MiD3GoiWkHnGL4pn7KNyLlkL3EbRLGqFFhrKGAzQodv6ZTFReVR4HhIHgnHahLPschqs3R_hf1HRTQJhpJ_YplKR4Iu65gHzvFCAJ4PwEy6oOXx3-rxz1Swp5JchC1cWSQ3n0aq0Jkfa5bjBDuA-I_5FIkv85nvJcqjH-kHS0">
<h3 id="部署图"><a target="_blank" rel="noopener" href="https://plantuml.com/zh/deployment-diagram">部署图</a></h3>
<pre class="line-numbers language-none"><code class="language-none">{% plantuml %}
@startuml
actor actor
agent agent
artifact artifact
boundary boundary
card card
cloud cloud
component component
control control
database database
entity entity
file file
folder folder
frame frame
interface  interface
node node
package package
queue queue
stack stack
rectangle rectangle
storage storage
usecase usecase
@enduml
{% endplantuml %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="http://www.plantuml.com/plantuml/svg/FP1B4eGm24JtVGgEubKmGSio1WV9mjiFyRTv_Gho8HaEP_Es5N1oDRe8dgKwNKIqbodAz0f6RJMpdVGA4bkc3gIYBRGJIRTTQp_fiwXLDotq938xZtm8lO9OjVX9Ts1QYb079YrPZEx0PBn5enDBTR6OJ8W-HTKir86TqnfFeIVnQzA4BY9UdrQw29FaNEUuxxFeg_MzJw8TalgqJsAGckFp_W00">
<h2 id="URL-卡片"><a target="_blank" rel="noopener" href="https://github.com/toastsgithub/hexo-valkyr-url">URL 卡片</a></h2>
<div class="vkr-url-wrapper">
<style>
.vkr-url-wrapper {
    padding: 10px;
    border-radius: 5px;
    border: 1px solid;
    border-color: #eee #ddd #bbb;
    box-shadow: rgba(0,0,0,.14) 0 1px 3px;
    margin-bottom: 10px;
    display: flex;
}
.vkr-url-wrapper .desc-wrapper > hr {
    margin: 10px 0;
    height: 1px;
}
.vkr-url-wrapper .avatar {
    width: 100px;
    height: 100px;
    border: solid 1px #eee;
    box-shadow: none!important;
    margin: 0;
    margin-right: 10px;
}
.vkr-url-wrapper h2 {
    border: none;
    margin: 0;
    padding: 0;
}
.vkr-url-wrapper .desc-wrapper {
    flex: 1;
}
.vkr-url-wrapper .desc-wrapper a {
    font-size: 22px;
    font-weight: 700;
}
</style>
    
        <a target="_blank" rel="noopener" href="https://github.com/toastsgithub/valkyr-ssh"><img class="avatar" src="http://images2.dzmtoast.top/post-cover/github-logo_hub2899c31b6ca7aed8d6a218f0e752fe4_46649_1200x1200_fill_box_center_2.png"></a>
    
    <div class="desc-wrapper">
        <a target="_blank" rel="noopener" href="https://github.com/toastsgithub/valkyr-ssh">valkyr ssh manager</a>
        <hr>
        <div class="desc">valkyr-ssh, a simple commandline tool to help you store ssh login address</div>
    </div>
</div>
<pre class="line-numbers language-none"><code class="language-none">{% valkyrurl
[url=https://github.com/toastsgithub/valkyr-ssh]
[title="valkyr ssh manager"]
[avatar=http://images2.dzmtoast.top/post-cover/github-logo_hub2899c31b6ca7aed8d6a218f0e752fe4_46649_1200x1200_fill_box_center_2.png]
[desc="valkyr-ssh, a simple commandline tool to help you store ssh login address"]
%}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">{% valkyrurl [url=http://example.com] [otherOpt=value] %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>avatar</code> image that describe your link (optional)</li>
<li><code>title</code> title</li>
<li><code>desc</code> description</li>
<li><code>url</code> destination when you click image url or title</li>
<li>空格要用引号包裹起来！</li>
</ul>
<h2 id="BILIBILI卡片"><a target="_blank" rel="noopener" href="https://github.com/MaxChang3/hexo-bilibili-card">BILIBILI卡片</a></h2>
<div class="bvideo">
    <a href="//www.bilibili.com/video/BV1sr4y1K7Be" target="_blank">
        <div class="bvideo-box">
            <div class="bvideo-cover">
                <div class="cover-default"></div>
                <div class="bvideo-cover-layer" style="background-image:url(https://images.weserv.nl/?url=http://i1.hdslb.com/bfs/archive/ee23c0ab56c3e29838f1081a76cf55c5a6199bf0.jpg)">
                    <i class="icon-video"></i>
                </div>
                <span class="duration">52:09:00</span>
            </div>
            <div class="bvideo-info">
                <p class="title">【PKU】高等数学（全60讲)</p>
                <p class="card-status">
                    <span class="play-num">
                        <i class="fa fa-youtube-play"></i>
                        <span>26.5万</span></span>
                    <span>
                        <i class="fa fa-list-alt"></i>
                        <span>148</span></span></p>
                <div class="partition">
                    <label class="card-label">视频</label>
                    <label class="up-label"></label>
                    <label class="up-name">沉迷学习的PickleFermi</label>
                </div>
                <div class="actions hide"></div>
            </div>
        </div>
    </a>
</div>
<pre class="line-numbers language-none"><code class="language-none">{% bilicard your_video_id %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="hexo-github-card"><strong><a target="_blank" rel="noopener" href="https://github.com/Gisonrg/hexo-github-card">hexo-github-card</a></strong></h2>
<pre class="line-numbers language-none"><code class="language-none">{% githubCard user:your_user [repo:your_repo] [width:400] [height:200] [theme:default] [client_id:your_client_id] [client_secret:your_client_secret] [align:text-align_position] %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% githubCard user:appotry %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% githubCard user:appotry repo:hexo-github-card %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<div style="text-align: center">
  <div class="github-card" data-user="appotry" data-repo="" data-height="200" data-width="400" data-theme="default" data-target="" data-client-id="" data-client-secret=""></div>
</div>
<script src="/github-card-lib/githubcard.js"></script>

<div style="text-align: center">
  <div class="github-card" data-user="appotry" data-repo="docker-hexo" data-height="200" data-width="400" data-theme="default" data-target="" data-client-id="" data-client-secret=""></div>
</div>
<script src="/github-card-lib/githubcard.js"></script>

<div style="text-align: center">
  <div class="github-card" data-user="appotry" data-repo="PTtool" data-height="200" data-width="400" data-theme="default" data-target="" data-client-id="" data-client-secret=""></div>
</div>
<script src="/github-card-lib/githubcard.js"></script>

<h2 id="hexo-douban-card"><a target="_blank" rel="noopener" href="https://github.com/TankNee/hexo-douban-card">hexo-douban-card</a></h2>
<div class="douban-card-block">
    <a class="douban-card" target="_blank" rel="noopener" href="https://movie.douban.com/subject/24745500">
        <div class="douban-card-bgimg" style="background-image: url('https://images.weserv.nl/?url=https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2194066391.jpg');"></div>
        <div class="douban-card-left">
            <div class="douban-card-img" style="background-image: url('https://images.weserv.nl/?url=https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2194066391.jpg');"></div>
            <div class="douban-card-status">灯影绰约</div>
        </div>
        <div class="douban-card-right">
            <div class="douban-card-item"><span>电影名: </span><strong>绣春刀(2014)</strong></div>
            <div class="douban-card-item"><span>导演: </span><span>路阳</span></div>
            <div class="douban-card-item"><span>主演: </span><span>张震/刘诗诗</span></div>
            <div class="douban-card-item"><span>上映时间: </span><span>2014-08-07(中国大陆)</span></div>
            <div class="douban-card-item"><span>评分: </span><span>7.6</span></div>
        </div>
    </a>
</div>
<style>
    .douban-card-block {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    max-height: 400px;
}

.douban-card {
    display: flex;
    margin: 30px 10px;
    padding: 15px;
    border-radius: 15px;
    position: relative;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    color: antiquewhite;
    text-decoration: none;
}

.douban-card:hover {
    text-decoration: none;
}

.douban-card-bgimg {
    position: absolute;
    width: 115%;
    height: 115%;
    filter: blur(15px) brightness(0.6);
    background-size: 100%;
    background-position: center;
    background-repeat: no-repeat;
}

.douban-card-img {
    position: relative;
    height: 130px;
    width: 80px;
    background-size: 100%;
    background-position: center;
    background-repeat: no-repeat;
}

.douban-card-left:hover .douban-card-img {
    filter: blur(5px) brightness(0.6);
    transform: perspective(800px) rotateX(180deg);
}

.douban-card-left .douban-card-img {
    transition: all 500ms ease;
}

.douban-card-left {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.douban-card-left .douban-card-status {
    height: 130px;
    width: 80px;
    text-align: center;
    font-weight: bold;
    position: absolute;
    left: 0;
    top: 30%;
    transform: rotateX(180deg);
    backface-visibility: hidden;
    transition: all 500ms ease;
}

.douban-card-left:hover .douban-card-status {
    transform: perspective(800px) rotateX(0deg);
}

.douban-card-right {
    position: relative;
    display: flex;
    flex-direction: column;
    margin-left: 12px;
    font-size: 16px;
    font-family: "Courier New", Courier, monospace;
    line-height: 1.3;
    color: antiquewhite;
}

.douban-card-item {
    margin-top: 4px;
}

</style>
<div class="douban-card-block">
    <a class="douban-card" target="_blank" rel="noopener" href="https://book.douban.com/subject/30376420">
        <div class="douban-card-bgimg" style="background-image: url('https://images.weserv.nl/?url=https://img1.doubanio.com/view/subject/s/public/s30015279.jpg');">
        </div>
        <div class="douban-card-left">
            <div class="douban-card-img" style="background-image: url('https://images.weserv.nl/?url=https://img1.doubanio.com/view/subject/s/public/s30015279.jpg');">
            </div>
            <div class="douban-card-status">见字如晤</div>
        </div>
        <div class="douban-card-right" style="line-height: 1.7;">
            <div class="douban-card-item"><span>书名: </span><strong>一个人生活</strong></div>
            <div class="douban-card-item"><span>作者: </span><span>[日]谷川俊太郎</span></div>
            <div class="douban-card-item"><span>出版年份: </span><span>2019-3</span></div>
            <div class="douban-card-item"><span>评分: </span><span>7.1</span></div>
        </div>
    </a>
</div>
<style>
    .douban-card-block {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    max-height: 400px;
}

.douban-card {
    display: flex;
    margin: 30px 10px;
    padding: 15px;
    border-radius: 15px;
    position: relative;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    color: antiquewhite;
    text-decoration: none;
}

.douban-card:hover {
    text-decoration: none;
}

.douban-card-bgimg {
    position: absolute;
    width: 115%;
    height: 115%;
    filter: blur(15px) brightness(0.6);
    background-size: 100%;
    background-position: center;
    background-repeat: no-repeat;
}

.douban-card-img {
    position: relative;
    height: 130px;
    width: 80px;
    background-size: 100%;
    background-position: center;
    background-repeat: no-repeat;
}

.douban-card-left:hover .douban-card-img {
    filter: blur(5px) brightness(0.6);
    transform: perspective(800px) rotateX(180deg);
}

.douban-card-left .douban-card-img {
    transition: all 500ms ease;
}

.douban-card-left {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.douban-card-left .douban-card-status {
    height: 130px;
    width: 80px;
    text-align: center;
    font-weight: bold;
    position: absolute;
    left: 0;
    top: 30%;
    transform: rotateX(180deg);
    backface-visibility: hidden;
    transition: all 500ms ease;
}

.douban-card-left:hover .douban-card-status {
    transform: perspective(800px) rotateX(0deg);
}

.douban-card-right {
    position: relative;
    display: flex;
    flex-direction: column;
    margin-left: 12px;
    font-size: 16px;
    font-family: "Courier New", Courier, monospace;
    line-height: 1.3;
    color: antiquewhite;
}

.douban-card-item {
    margin-top: 4px;
}

</style>
<div class="douban-card-block">
	<a class="douban-card" target="_blank" rel="noopener" href="https://music.douban.com/subject/35099703">
		<div class="douban-card-bgimg" style="background-image: url('https://images.weserv.nl/?url=https://img1.doubanio.com/view/subject/m/public/s33667479.jpg');"></div>
		<div class="douban-card-left">
			<div class="douban-card-img" style="background-image: url('https://images.weserv.nl/?url=https://img1.doubanio.com/view/subject/m/public/s33667479.jpg');"></div>
            <div class="douban-card-status">余音绕梁</div>
        </div>
		<div class="douban-card-right">
			<div class="douban-card-item"><span>音乐名: </span><strong>María</strong></div>
			<div class="douban-card-item"><span>表演者: </span><span>화사/华莎</span></div>
			<div class="douban-card-item"><span>发行时间: </span><span>2020-06-30</span></div>
			<div class="douban-card-item"><span>评分: </span><span>8.3</span></div>
		</div>
	</a>
</div>
<style>
    .douban-card-block {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    max-height: 400px;
}

.douban-card {
    display: flex;
    margin: 30px 10px;
    padding: 15px;
    border-radius: 15px;
    position: relative;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    color: antiquewhite;
    text-decoration: none;
}

.douban-card:hover {
    text-decoration: none;
}

.douban-card-bgimg {
    position: absolute;
    width: 115%;
    height: 115%;
    filter: blur(15px) brightness(0.6);
    background-size: 100%;
    background-position: center;
    background-repeat: no-repeat;
}

.douban-card-img {
    position: relative;
    height: 130px;
    width: 80px;
    background-size: 100%;
    background-position: center;
    background-repeat: no-repeat;
}

.douban-card-left:hover .douban-card-img {
    filter: blur(5px) brightness(0.6);
    transform: perspective(800px) rotateX(180deg);
}

.douban-card-left .douban-card-img {
    transition: all 500ms ease;
}

.douban-card-left {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.douban-card-left .douban-card-status {
    height: 130px;
    width: 80px;
    text-align: center;
    font-weight: bold;
    position: absolute;
    left: 0;
    top: 30%;
    transform: rotateX(180deg);
    backface-visibility: hidden;
    transition: all 500ms ease;
}

.douban-card-left:hover .douban-card-status {
    transform: perspective(800px) rotateX(0deg);
}

.douban-card-right {
    position: relative;
    display: flex;
    flex-direction: column;
    margin-left: 12px;
    font-size: 16px;
    font-family: "Courier New", Courier, monospace;
    line-height: 1.3;
    color: antiquewhite;
}

.douban-card-item {
    margin-top: 4px;
}

</style>

<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% douban movie 24745500 %}

{% douban book 30376420 %}

{% douban music 35099703 %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="插入音乐和视频">插入音乐和视频</h2>
<blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/MoePlayer/hexo-tag-aplayer">hexo-tag-aplayer</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/MoePlayer/hexo-tag-dplayer">hexo-tag-dplayer</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/u2sb/hexo-tag-mmedia">hexo-tag-mmedia</a> 推荐使用</li>
</ul>
</blockquote>
<h3 id="插入音乐">插入音乐</h3>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/MoePlayer/hexo-tag-aplayer/blob/master/docs/README-zh_cn.md">官方教程</a></p>
</blockquote>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% aplayer title author url [picture_url, narrow, autoplay, width:xxx, lrc:xxx] %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>title</code> : 曲目标题</li>
<li><code>author</code>: 曲目作者</li>
<li><code>url</code>: 音乐文件 URL 地址</li>
<li><code>picture_url</code>: (可选) 音乐对应的图片地址</li>
<li><code>narrow</code>: （可选）播放器袖珍风格</li>
<li><code>autoplay</code>: (可选) 自动播放，移动端浏览器暂时不支持此能</li>
<li><code>width:xxx</code>: (可选) 播放器宽度 (默认: 100%)</li>
<li><code>lrc:xxx</code>: （可选）歌词文件 URL #### <em><strong>单曲附带歌词显示</strong></em></li>
</ul>

        <div id="aplayer-IxagNxOA" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;">
            <pre class="aplayer-lrc-content"></pre>
        </div>
        <script>
          var ap = new APlayer({
            element: document.getElementById("aplayer-IxagNxOA"),
            narrow: false,
            autoplay: false,
            showlrc: 3,
            music: {
              title: "Hotel California",
              author: "Camille and Kennerly",
              url: "https://cdn.17lai.site/media/music/Hotel%20California/01%20Hotel%20California.mp3",
              pic: "https://cdn.17lai.site/media/music/Hotel%20California/Hotel%20California.webp",
              lrc: "https://cdn.17lai.site/media/music/Hotel%20California/01%20Hotel%20California.lrc"
            }
          });
          window.aplayers || (window.aplayers = []);
          window.aplayers.push(ap);
        </script>

#### **音乐播放列表**


<pre class="line-numbers language-none"><code class="language-none">{% aplayerlist %}
{
    "narrow": false,                          // （可选）播放器袖珍风格
    "autoplay": true,                         // （可选) 自动播放，移动端浏览器暂时不支持此功能
    "mode": "random",                         // （可选）曲目循环类型，有 'random'（随机播放）, 'single' (单曲播放), 'circulation' (循环播放), 'order' (列表播放)， 默认：'circulation' 
    "showlrc": 3,                             // （可选）歌词显示配置项，可选项有：1,2,3
    "mutex": true,                            // （可选）该选项开启时，如果同页面有其他 aplayer 播放，该播放器会暂停
    "theme": "#e6d0b2",	                      // （可选）播放器风格色彩设置，默认：#b7daff
    "preload": "metadata",                    // （可选）音乐文件预载入模式，可选项： 'none' 'metadata' 'auto', 默认: 'auto'
    "listmaxheight": "513px",                 // (可选) 该播放列表的最大长度
    "music": [
        {
            "title": "CoCo",
            "author": "Jeff Williams",
            "url": "caffeine.mp3",
            "pic": "caffeine.jpeg",
            "lrc": "caffeine.txt"
        },
        {
            "title": "アイロニ",
            "author": "鹿乃",
            "url": "irony.mp3",
            "pic": "irony.jpg"
        }
    ]
}
{% endaplayerlist %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


        <div id="aplayer-ZFRqWiuj" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;"></div>
			  <script>
				  var options = {"narrow":false,"autoplay":true,"showlrc":3,"mode":"random","mutex":true,"theme":"#e6d0b2","preload":"metadata","listmaxheight":"513px","music":[{"title":"Hotel California","author":"Camille and Kennerly","url":"https://cdn.17lai.site/media/music/Hotel%20California/01%20Hotel%20California.mp3","pic":"https://cdn.17lai.site/media/music/Hotel%20California/Hotel%20California.webp","lrc":"https://cdn.17lai.site/media/music/Hotel%20California/01%20Hotel%20California.lrc"},{"title":"Sold Out","author":"Diamonds","url":"https://cdn.17lai.site/media/music/Diamonds/05%20Sold%20Out.flac","pic":"https://cdn.17lai.site/media/music/Diamonds/Diamonds.jpg"}]};
				  options.element = document.getElementById("aplayer-ZFRqWiuj");
				  var ap = new APlayer(options);
			    window.aplayers || (window.aplayers = []);
				  window.aplayers.push(ap);
			  </script>
<h3 id="插入视频">插入视频</h3>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://dplayer.js.org/guide.html">官方教程</a></p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">{% dplayer key=value ... %}
例：
{% dplayer "url=http://www.nenu.edu.cn/_upload/article/videos/03/5f/7c999eed42e3aadc413d7f851f0e/0f50b3eb-9285-41d2-ac4d-6cc363651aad_B.mp4"  "autoplay=true" "preload=metadata" "hotkey=true" %} <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>有关的选项列表如下:</p>
<table>
<thead>
<tr>
<th style="text-align:left">选项</th>
<th style="text-align:left">默认值</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">url</td>
<td style="text-align:left"><strong>必须值</strong></td>
<td style="text-align:left">视频地址</td>
</tr>
<tr>
<td style="text-align:left">loop</td>
<td style="text-align:left"><code>false</code></td>
<td style="text-align:left">视频循环播放</td>
</tr>
<tr>
<td style="text-align:left">volume</td>
<td style="text-align:left"><code>0.7</code></td>
<td style="text-align:left">播放器音量</td>
</tr>
<tr>
<td style="text-align:left">hotkey</td>
<td style="text-align:left"><code>true</code></td>
<td style="text-align:left">开启热键</td>
</tr>
<tr>
<td style="text-align:left">autoplay</td>
<td style="text-align:left"><code>true</code></td>
<td style="text-align:left">自动播放，移动端浏览器暂时不支持此功能</td>
</tr>
<tr>
<td style="text-align:left">logo</td>
<td style="text-align:left"><code>-</code></td>
<td style="text-align:left">在左上角展示一个 logo，你可以通过 CSS 调整它的大小和位置</td>
</tr>
<tr>
<td style="text-align:left">mutex</td>
<td style="text-align:left"><code>true</code></td>
<td style="text-align:left">该选项开启时，如果同页面有其他播放，该播放器会暂停</td>
</tr>
<tr>
<td style="text-align:left">highlight</td>
<td style="text-align:left"><code>[]</code></td>
<td style="text-align:left">自定义进度条提示点</td>
</tr>
<tr>
<td style="text-align:left">preload</td>
<td style="text-align:left"><code>auto</code></td>
<td style="text-align:left">视频文件预载入模式，可选项： <code>none</code>, <code>metadata</code>, <code>auto</code></td>
</tr>
<tr>
<td style="text-align:left">theme</td>
<td style="text-align:left"><code>#ad7a86</code></td>
<td style="text-align:left">播放器风格色彩设置</td>
</tr>
</tbody>
</table>
<p>注：如果使用腾讯视频、优酷视频等在线视频网站的资源，需要先进行视频地址解析，如<a target="_blank" rel="noopener" href="http://old.flvurl.cn/">点量视频解析</a>，获取到实际的视频地址。</p>
<p>在使用优酷或者腾讯视频时可以直接复制分享代码到文章中，如：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;iframe height=498 width=510 src='https://player.youku.com/embed/XMjk4ODAyMzIyOA==' frameborder=0 'allowfullscreen'&gt;&lt;/iframe&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><strong>dplayer</strong></li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">{% dplayer "url=http://www.nenu.edu.cn/_upload/article/videos/03/5f/7c999eed42e3aadc413d7f851f0e/0f50b3eb-9285-41d2-ac4d-6cc363651aad_B.mp4"  "autoplay=false" "preload=metadata" "hotkey=true" %} <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><strong>iframe</strong></li>
</ul>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>498</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>510</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>https://player.youku.com/embed/XMjk4ODAyMzIyOA==<span class="token punctuation">'</span></span> <span class="token attr-name">frameborder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>0</span> <span class="token attr-name">'allowfullscreen'</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="hexo-tag-mmedia使用"><a target="_blank" rel="noopener" href="https://github.com/u2sb/hexo-tag-mmedia">hexo-tag-mmedia</a>使用</h3>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.u2sb.com/pages/7c33e5/">官方教程</a></p>
</blockquote>
<h4 id="audio"><strong>audio</strong></h4>
<blockquote>
<p>此部分请熟读 <a target="_blank" rel="noopener" href="https://www.w3.org/TR/2014/REC-html5-20141028/embedded-content-0.html#the-audio-element">Audio 相关介绍</a></p>
<p>目前主题中不可用</p>
</blockquote>
<ul>
<li>使用 <code>:</code> 或 <code>=</code> 分割。</li>
<li>所有 <code>&lt;audio&gt;</code> 标签的原生参数均可添加，只要能写进去就可以。</li>
<li>具体能否实现相关标准，取决于客户端浏览器。</li>
</ul>
<pre class="line-numbers language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">mmedia</span> <span class="token string"><span class="token punctuation">"</span>audio<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>src:a.mp3<span class="token punctuation">"</span></span> <span class="token delimiter punctuation">%}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">mmedia</span> <span class="token string"><span class="token punctuation">"</span>audio<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>src:https://baidu.com/a.mp3<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>autoplay:true<span class="token punctuation">"</span></span> <span class="token delimiter punctuation">%}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="video">video</h4>
<blockquote>
<p>此部分请熟读 <a target="_blank" rel="noopener" href="https://www.w3.org/TR/2014/REC-html5-20141028/embedded-content-0.html#the-video-element">Video 相关介绍</a></p>
<p>目前主题中不可用</p>
</blockquote>
<ul>
<li>使用 <code>:</code> 或 <code>=</code> 分割。</li>
<li>所有 <code>&lt;video&gt;</code> 标签的原生参数均可添加，只要能写进去就可以。</li>
<li>具体能否实现相关标准，取决于客户端浏览器。</li>
</ul>
<pre class="line-numbers language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">mmedia</span> <span class="token string"><span class="token punctuation">"</span>video<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>src:a.mp4<span class="token punctuation">"</span></span> <span class="token delimiter punctuation">%}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">mmedia</span> <span class="token string"><span class="token punctuation">"</span>video<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>src:https://baidu.com/a.mp4<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>autoplay:true<span class="token punctuation">"</span></span> <span class="token delimiter punctuation">%}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="MetingJS"><strong>MetingJS</strong></h4>
<blockquote>
<p>此部分请熟读 <a target="_blank" rel="noopener" href="https://github.com/metowolf/MetingJS#option">MetingJS 文档</a></p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">option</th>
<th style="text-align:center">default</th>
<th style="text-align:left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">id</td>
<td style="text-align:center"><strong>require</strong></td>
<td style="text-align:left">song id / playlist id / album id / search keyword</td>
</tr>
<tr>
<td style="text-align:left">server</td>
<td style="text-align:center"><strong>require</strong></td>
<td style="text-align:left">music platform: <code>netease</code>, <code>tencent</code>, <code>kugou</code>, <code>xiami</code>, <code>baidu</code></td>
</tr>
<tr>
<td style="text-align:left">type</td>
<td style="text-align:center"><strong>require</strong></td>
<td style="text-align:left"><code>song</code>, <code>playlist</code>, <code>album</code>, <code>search</code>, <code>artist</code></td>
</tr>
<tr>
<td style="text-align:left">auto</td>
<td style="text-align:center">options</td>
<td style="text-align:left">music link, support: <code>netease</code>, <code>tencent</code>, <code>xiami</code></td>
</tr>
<tr>
<td style="text-align:left">fixed</td>
<td style="text-align:center"><code>false</code></td>
<td style="text-align:left">enable fixed mode</td>
</tr>
<tr>
<td style="text-align:left">mini</td>
<td style="text-align:center"><code>false</code></td>
<td style="text-align:left">enable mini mode</td>
</tr>
<tr>
<td style="text-align:left">autoplay</td>
<td style="text-align:center"><code>false</code></td>
<td style="text-align:left">audio autoplay</td>
</tr>
<tr>
<td style="text-align:left">theme</td>
<td style="text-align:center"><code>#2980b9</code></td>
<td style="text-align:left">main color</td>
</tr>
<tr>
<td style="text-align:left">loop</td>
<td style="text-align:center"><code>all</code></td>
<td style="text-align:left">player loop play, values: ‘all’, ‘one’, ‘none’</td>
</tr>
<tr>
<td style="text-align:left">order</td>
<td style="text-align:center"><code>list</code></td>
<td style="text-align:left">player play order, values: ‘list’, ‘random’</td>
</tr>
<tr>
<td style="text-align:left">preload</td>
<td style="text-align:center"><code>auto</code></td>
<td style="text-align:left">values: ‘none’, ‘metadata’, ‘auto’</td>
</tr>
<tr>
<td style="text-align:left">volume</td>
<td style="text-align:center"><code>0.7</code></td>
<td style="text-align:left">default volume, notice that player will remember user setting, default volume will not work after user set volume themselves</td>
</tr>
<tr>
<td style="text-align:left">mutex</td>
<td style="text-align:center"><code>true</code></td>
<td style="text-align:left">prevent to play multiple player at the same time, pause other players when this player start play</td>
</tr>
<tr>
<td style="text-align:left">lrc-type</td>
<td style="text-align:center"><code>0</code></td>
<td style="text-align:left">lyric type</td>
</tr>
<tr>
<td style="text-align:left">list-folded</td>
<td style="text-align:center"><code>false</code></td>
<td style="text-align:left">indicate whether list should folded at first</td>
</tr>
<tr>
<td style="text-align:left">list-max-height</td>
<td style="text-align:center"><code>340px</code></td>
<td style="text-align:left">list max height</td>
</tr>
<tr>
<td style="text-align:left">storage-name</td>
<td style="text-align:center"><code>metingjs</code></td>
<td style="text-align:left">localStorage key that store player setting</td>
</tr>
</tbody>
</table>
<p>Documentation for APlayer can be found at https://aplayer.js.org/#/home?id=options</p>
<p><strong>单曲</strong></p>
<pre class="line-numbers language-none"><code class="language-none">{% mmedia "meting" "auto=https://y.qq.com/n/ryqq/songDetail/0005RQAO3FqG5K" %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js metin="meting" auto="https://y.qq.com/n/ryqq/songDetail/0005RQAO3FqG5K"></meting-js>

<pre class="line-numbers language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">mmedia</span> <span class="token string"><span class="token punctuation">"</span>meting<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>auto=https://y.qq.com/n/yqq/song/001RGrEX3ija5X.html<span class="token punctuation">"</span></span> <span class="token delimiter punctuation">%}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">mmedia</span> <span class="token string"><span class="token punctuation">"</span>meting<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>server=netease<span class="token punctuation">"</span></span>	<span class="token string"><span class="token punctuation">"</span>type=playlist<span class="token punctuation">"</span></span>	<span class="token string"><span class="token punctuation">"</span>id=60198<span class="token punctuation">"</span></span> <span class="token delimiter punctuation">%}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

#### **Aplayer**

详细参数表：

| 参数           | 默认   | 解释                                           |
| :------------- | :----- | :--------------------------------------------- |
| name           | -      | audio name                                     |
| artist         | -      | audio artist                                   |
| url            | -      | audio url                                      |
| cover          | -      | audio cover                                    |
| lrc            | -      | audio lrc                                      |
| theme          | -      | audio theme                                    |
| type           | auto   | audio type 可选 ‘auto’, ‘hls’, ‘normal’        |
| autoplay       | false  | autoplay                                       |
| loop           | ‘all’  | player loop play, values: ‘all’, ‘one’, ‘none’ |
| order          | ‘list’ | player play order, values: ‘list’, ‘random’    |
| volume         | 0.7    | default volume,                                |
| tlistMaxHeight | -      | list max height                                |

不在表格内的参数请使用下面 JSON 类型的参数。

mmedia 插件允许在 contents 部分使用 JSON 编写配置，由于允许使用 JSON5，此项配置几乎与 APlayer 完全一致。

- **单曲**

<pre class="line-numbers language-none"><code class="language-none">{% mmedia "aplayer" "name:Hotel California" "artist:Camille and Kennerly" "url:https://cdn.17lai.site/media/music/Hotel%20California/01%20Hotel%20California.mp3" "lrc:https://cdn.17lai.site/media/music/Hotel%20California/01%20Hotel%20California.lrc" "cover:https://cdn.17lai.site/media/music/Hotel%20California/Hotel%20California.webp" "volume:0.66" %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><div id="mmedia-hqgGvyYniuxKMBWp"></div><script> var hqgGvyYniuxKMBWp_options = JSON.parse('{\"lrcType\":3,\"volume\":0.66,\"autoplay\":false,\"audio\":[{\"name\":\"Hotel California\",\"artist\":\"Camille and Kennerly\",\"url\":\"https://cdn.17lai.site/media/music/Hotel%20California/01%20Hotel%20California.mp3\",\"lrc\":\"https://cdn.17lai.site/media/music/Hotel%20California/01%20Hotel%20California.lrc\",\"cover\":\"https://cdn.17lai.site/media/music/Hotel%20California/Hotel%20California.webp\"}]}'); hqgGvyYniuxKMBWp_options.container = document.getElementById("mmedia-hqgGvyYniuxKMBWp"); const ap_hqgGvyYniuxKMBWp = new APlayer(hqgGvyYniuxKMBWp_options); </script>

- **列表**

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><div id="mmedia-uCsxvBnLQMNUXhdP"></div><script> var uCsxvBnLQMNUXhdP_options = JSON.parse('{\"lrcType\":3,\"volume\":0.8,\"autoplay\":false,\"audio\":[{\"name\":\"Hotel California\",\"artist\":\"Camille and Kennerly\",\"url\":\"https://cdn.17lai.site/media/music/Hotel%20California/01%20Hotel%20California.mp3\",\"cover\":\"https://cdn.17lai.site/media/music/Hotel%20California/Hotel%20California.webp\",\"lrc\":\"https://cdn.17lai.site/media/music/Hotel%20California/01%20Hotel%20California.lrc\",\"theme\":\"#ebd0c2\"},{\"name\":\"Sold Out\",\"artist\":\"Diamonds\",\"url\":\"https://cdn.17lai.site/media/music/Diamonds/05%20Sold%20Out.flac\",\"cover\":\"https://cdn.17lai.site/media/music/Diamonds/Diamonds.jpg\",\"theme\":\"#ebd0c2\"},{\"name\":\"The Final Bell\",\"artist\":\"Rocky_Original Motion Picture Score\",\"url\":\"https://cdn.17lai.site/media/music/Rocky_%20Original%20Motion%20Picture%20Score/12%20Bill%20Conti%20-%20The%20Final%20Bell.mp3\",\"cover\":\"https://cdn.17lai.site/media/music/Rocky_%20Original%20Motion%20Picture%20Score/Rocky_%20Original%20Motion%20Picture%20Score.jpg\",\"theme\":\"#ebd0c2\"},{\"name\":\" Croatian Rhapsody\",\"artist\":\"The Piano Player\",\"url\":\"https://cdn.17lai.site/media/music/The%20Piano%20Player/11%20Croatian%20Rhapsody.mp3\",\"cover\":\"https://cdn.17lai.site/media/music/The%20Piano%20Player/The%20Piano%20Player.jpg\",\"theme\":\"#ebd0c2\"}]}'); uCsxvBnLQMNUXhdP_options.container = document.getElementById("mmedia-uCsxvBnLQMNUXhdP"); const ap_uCsxvBnLQMNUXhdP = new APlayer(uCsxvBnLQMNUXhdP_options); </script>
<p><strong>例子</strong></p>
<pre class="line-numbers language-none"><code class="language-none">{% mmedias "aplayer" "autoplay:false" %}
{
  "volume": 0.8,
  "audio":
  [
    {
      "name": "name1",
      "artist": "artist1",
      "url": "url1.mp3",
      "cover": "cover1.jpg",
      "lrc": "lrc1.lrc",
      "theme": "#ebd0c2"
    },
    {
      "name": "name2",
      "artist": "artist2",
      "url": "url2.mp3",
      "cover": "cover2.jpg",
      "lrc": "lrc2.lrc",
      "theme": "#46718b"
    }
  ]
}
{% endmmedias %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Dplayer">Dplayer</h4>
<blockquote>
<p>此部分请熟读 <a target="_blank" rel="noopener" href="http://dplayer.js.org/">DPlayer 文档</a></p>
</blockquote>
<pre class="line-numbers language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">mmedia</span> <span class="token string"><span class="token punctuation">"</span>dplayer<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>url:a.mp4<span class="token punctuation">"</span></span> <span class="token delimiter punctuation">%}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">mmedias</span> <span class="token string"><span class="token punctuation">"</span>dplayer<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>flv:<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>url:https://dandoc.u2sb.com/video/%E5%AE%89%E8%A3%85/1-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E8%A3%85.mp4<span class="token punctuation">"</span></span> <span class="token delimiter punctuation">%}</span></span>
{
  "contextmenu":
  [
    {
      text: "custom1",
      link: "https://github.com/DIYgod/DPlayer"
    }
  ]
}
<span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">endmmedias</span> <span class="token delimiter punctuation">%}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">{% mmedia "dplayer" "url:https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4" %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<script src="https://cdn.jsdelivr.net/npm/dplayer@1/dist/DPlayer.min.js"></script><div id="mmedia-goafUElPvlovwebJ"></div><script> var goafUElPvlovwebJ_options = JSON.parse('{\"video\":{\"url\":\"https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4\"}}'); goafUElPvlovwebJ_options.container = document.getElementById("mmedia-goafUElPvlovwebJ"); const dp_goafUElPvlovwebJ = new DPlayer(goafUElPvlovwebJ_options); </script>

<pre class="line-numbers language-none"><code class="language-none">{% mmedias "dplayer" %}
{
  video: 
  {
    url: "https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4"
  }
}
{% endmmedias %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

#### 哔哩哔哩

详细参数表：

| 参数            | 默认                                               | 解释                                                    |
| :-------------- | :------------------------------------------------- | :------------------------------------------------------ |
| aid             | -                                                  | aid                                                     |
| bvid            | -                                                  | bvid，与 aid 同时出现时以 bvid 为准                     |
| page            | 1                                                  | page                                                    |
| danmaku         | true                                               | 是否有弹幕 ture or false                                |
| allowfullscreen | allowfullscreen                                    | 允许全屏， allowfullscreen 或 true 允许，其他选项不允许 |
| sandbox         | 见 [配置](https://www.u2sb.com/pages/19d343/#配置) | iframe sandbox                                          |
| width           | 100%                                               | css 属性                                                |
| max_width       | 850px                                              | css 属性                                                |
| margin          | auto                                               | css 属性                                                |

mmedia 插件允许在 contents 部分使用 JSON 编写配置，使用 JSON5 标准。

<style>.bbplayer{width: 100%; max-width: 850px; margin: auto}</style><div class="bbplayer"><iframe class="bbplayer" id="mmedia-eiNvzvTdfJskfkmT" src="https://player.bilibili.com/player.html?bvid=BV1fs411S7u7&amp;page=1&amp;high_quality=1&amp;danmaku=true" allowfullscreen="allowfullscreen" scrolling="no" border="0" frameborder="0" framespacing="0" sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts allow-popups"></iframe></div><script> document.getElementById("mmedia-eiNvzvTdfJskfkmT").style.height=document.getElementById("mmedia-eiNvzvTdfJskfkmT").scrollWidth*0.76+"px";
    window.onresize = function(){
      document.getElementById("mmedia-eiNvzvTdfJskfkmT").style.height=document.getElementById("mmedia-eiNvzvTdfJskfkmT").scrollWidth*0.76+"px";
    }; </script>

<pre class="line-numbers language-none"><code class="language-none">{% mmedia "bilibili" "bvid:BV1fs411S7u7" %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

#### 西瓜视频

<pre class="line-numbers language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">mmedia</span> <span class="token string"><span class="token punctuation">"</span>xigua<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>xid=6925997698269053453<span class="token punctuation">"</span></span> <span class="token delimiter punctuation">%}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">mmedia</span> <span class="token string"><span class="token punctuation">"</span>xigua<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>xid:6925997698269053453<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>autoplay:true<span class="token punctuation">"</span></span> <span class="token delimiter punctuation">%}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

详细参数表：

| 参数            | 默认                                               | 解释                                                    |
| :-------------- | :------------------------------------------------- | :------------------------------------------------------ |
| xid             | -                                                  | 西瓜视频的 ID，就是那一串数字                           |
| id              | -                                                  | 一般情况下不需要填写                                    |
| autoplay        | false                                              | autoplay                                                |
| startTime       | 0                                                  | 开始时间，秒                                            |
| allowfullscreen | allowfullscreen                                    | 允许全屏， allowfullscreen 或 true 允许，其他选项不允许 |
| sandbox         | 见 [配置](https://www.u2sb.com/pages/a0c4a7/#配置) | iframe sandbox                                          |
| width           | 100%                                               | css 属性                                                |
| max_width       | 850px                                              | css 属性                                                |
| margin          | auto                                               | css 属性                                                |

<style>.xgplayer{width: 100%; max-width: 850px; margin: auto}</style><div class="xgplayer"><iframe class="xgplayer" id="mmedia-kWNGPvpsdQkTdzcC" src="https://www.ixigua.com/iframe/6925997698269053453?autoplay=0&amp;startTime=undefined" allowfullscreen="allowfullscreen" scrolling="no" border="0" frameborder="0" framespacing="0" sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts allow-popups"></iframe></div><script> document.getElementById("mmedia-kWNGPvpsdQkTdzcC").style.height=document.getElementById("mmedia-kWNGPvpsdQkTdzcC").scrollWidth*0.7+"px";
    window.onresize = function(){
      document.getElementById("mmedia-kWNGPvpsdQkTdzcC").style.height=document.getElementById("mmedia-kWNGPvpsdQkTdzcC").scrollWidth*0.7+"px";
    }; </script>

<pre class="line-numbers language-none"><code class="language-none">{% mmedia "xigua" "xid=6925997698269053453" %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

#### ArtPlayer

&gt; 此部分请熟读 [ArtPlayer 文档](https://artplayer.org/document/#/options)

- 使用 `:` 或 `=` 分割。

详细参数表：

| 参数     | 默认  | 解释           |
| :------- | :---- | :------------- |
| url      | -     | url            |
| title    | -     | title          |
| poster   | -     | poster         |
| type     | -     | type           |
| autoplay | false | video autoplay |
| loop     | false | video loop     |
| volume   | 0.7   | default volume |
| style    | -     | style          |

上面有一个比较特殊的参数 flv，这里单独解释一下，这个参数是用于引入其他 js 文件的，目前支持的有： `hls` `dash` `shaka_dash` `flv` `webtorrent` ，上述参数可多个一起使用，如果后面带有 js 地址，将直接使用，否则将使用 `_config.yml` 配置或插件默认配置，如：

<pre class="line-numbers language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">mmedia</span> <span class="token string"><span class="token punctuation">"</span>artplayer<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>flv:<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>url:a.flv<span class="token punctuation">"</span></span> <span class="token delimiter punctuation">%}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">mmedias</span> <span class="token string"><span class="token punctuation">"</span>artplayer<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>flv:<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>hls:https://cdn.jsdelivr.net/npm/hls.js/dist/hls.min.js<span class="token punctuation">"</span></span> <span class="token delimiter punctuation">%}</span></span>
{
  ...
}
<span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">endmmedias</span> <span class="token delimiter punctuation">%}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">mmedia</span> <span class="token string"><span class="token punctuation">"</span>artplayer<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>url:https://dandoc.u2sb.com/video/%E5%AE%89%E8%A3%85/1-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E8%A3%85.mp4<span class="token punctuation">"</span></span> <span class="token delimiter punctuation">%}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">mmedias</span> <span class="token string"><span class="token punctuation">"</span>artplayer<span class="token punctuation">"</span></span> <span class="token string"><span class="token punctuation">"</span>flv:<span class="token punctuation">"</span></span>  <span class="token delimiter punctuation">%}</span></span>
{
  url: "https://dandoc.u2sb.com/video/%E5%AE%89%E8%A3%85/1-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E8%A3%85.mp4"
}
<span class="token twig language-twig"><span class="token delimiter punctuation">{%</span> <span class="token tag-name keyword">endmmedias</span> <span class="token delimiter punctuation">%}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">{% mmedia "artplayer" "url:https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_2mb.mp4" %}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<script src="https://cdn.jsdelivr.net/npm/artplayer@3/dist/artplayer.js"></script><div id="mmedia-SQJVbMIXLtnhNhoC" style="width:100%;height:650px;max-width:1200px;center"></div><script> var SQJVbMIXLtnhNhoC_options = JSON.parse('{\"style\":\"width:100%;height:650px;max-width:1200px;center\",\"autoSize\":true,\"autoMini\":true,\"fullscreen\":true,\"fullscreenWeb\":true,\"url\":\"https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_2mb.mp4\"}'); SQJVbMIXLtnhNhoC_options.container = "#mmedia-SQJVbMIXLtnhNhoC"; const art_SQJVbMIXLtnhNhoC = new Artplayer(SQJVbMIXLtnhNhoC_options); </script>
<pre class="line-numbers language-none"><code class="language-none">{% mmedias "artplayer" %}
{
  url: "https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_2mb.mp4"
}
{% endmmedias %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="脑图"><a target="_blank" rel="noopener" href="https://github.com/MaxChang3/hexo-markmap">脑图</a></h2>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://zhangmaimai.com/2021/02/23/hexo-mindmap-plugin/">原作者记录</a></p>
</blockquote>

    <div class="markmap-container" style="height:250px">
      <svg data="{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:1,&quot;p&quot;:{&quot;lines&quot;:[0,1]},&quot;v&quot;:&quot;思维导图？&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[1,2]},&quot;v&quot;:&quot;使用现有的插件或组件？&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:3,&quot;p&quot;:{&quot;lines&quot;:[2,3]},&quot;v&quot;:&quot;Mermaid：更偏向流程图&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:3,&quot;p&quot;:{&quot;lines&quot;:[3,4]},&quot;v&quot;:&quot;Kityminder&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[4,5]},&quot;v&quot;:&quot;现成hexo插件有些小问题。&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[5,6]},&quot;v&quot;:&quot;二次开发，失败&quot;}]}]},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[6,7]},&quot;v&quot;:&quot;找寻相关项目？&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:3,&quot;p&quot;:{&quot;lines&quot;:[8,9]},&quot;v&quot;:&quot;Markmap大法！&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[9,10]},&quot;v&quot;:&quot;直接弄，失败&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[10,11]},&quot;v&quot;:&quot;使用jsdom，失败&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[11,12]},&quot;v&quot;:&quot;寻找现成库，成功&quot;}]}]},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[12,13]},&quot;v&quot;:&quot;咕咕咕咕咕咕咕咕咕咕咕咕&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[13,14]},&quot;v&quot;:&quot;凑一下行数让版面好看点&quot;}]}"></svg>
    </div>
  
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">{% markmap 250px %}
<span class="token title important"><span class="token punctuation">#</span> 思维导图？</span>
<span class="token title important"><span class="token punctuation">##</span> 使用现有的插件或组件？</span>
<span class="token title important"><span class="token punctuation">###</span> Mermaid：更偏向流程图</span>
<span class="token title important"><span class="token punctuation">###</span> Kityminder</span>
<span class="token title important"><span class="token punctuation">####</span> 现成hexo插件有些小问题。</span>
<span class="token title important"><span class="token punctuation">####</span> 二次开发，失败</span>
<span class="token title important"><span class="token punctuation">##</span> 找寻相关项目？</span>
<span class="token title important"><span class="token punctuation">###</span> Markmap大法！</span>
<span class="token title important"><span class="token punctuation">####</span> 直接弄，失败</span>
<span class="token title important"><span class="token punctuation">####</span> 使用jsdom，失败</span>
<span class="token title important"><span class="token punctuation">####</span> 寻找现成库，成功</span>
<span class="token title important"><span class="token punctuation">##</span> 咕咕咕咕咕咕咕咕咕咕咕咕</span>
<span class="token title important"><span class="token punctuation">##</span> 凑一下行数让版面好看点</span>
{% endmarkmap %}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>Here is the footnote. <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>Here's one with multiple blocks.</p>
<p>Subsequent paragraphs are indented to show that they <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">
    <style>.markmap-container{display:flex;justify-content:center;margin:0 auto;width:90%;height:500px}.markmap-container svg{width:100%;height:100%}@media(max-width:768px){.markmap-container{height:400px}}</style>
    <script src="https://cdn.jsdelivr.net/npm/d3@6"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view"></script>
    <script> document.querySelectorAll('.markmap-container>svg').forEach(mindmap => markmap.Markmap.create(mindmap, null, JSON.parse(mindmap.getAttribute('data'))))</script>
  ]]></content>
      <categories>
        <category>web</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>mermaid</tag>
        <tag>plantuml</tag>
        <tag>mathjax</tag>
      </tags>
  </entry>
  <entry>
    <title>CI/CD与Git Flow与GitLab</title>
    <url>/posts/1879721e/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>CI/CD + Git Flow + GitLab 的整体工作流程记录。主要介绍一下 GitLab CI 相关功能，并通过 GitLab CI 实现自动化构建项目。项目中所用的示例项目已经上传到了 <a target="_blank" rel="noopener" href="https://github.com/mritd/GitLabCI-TestProject">GitHub</a></p>
</blockquote>
<h3 id="一、Git-Flow-简介">一、Git Flow 简介</h3>
<p>Git Flow 定义了一个围绕项目开发发布的严格 git 分支模型，用于管理多人协作的大型项目中实现高效的协作开发；Git Flow 分支模型最早起源于 <a target="_blank" rel="noopener" href="http://nvie.com/about/">Vincent Driessen</a> 的 <a target="_blank" rel="noopener" href="http://nvie.com/posts/a-successful-git-branching-model/">A successful Git branching model</a> 文章；随着时间发展，Git Flow 大致分为三种:</p>
<ul>
<li>Git Flow: 最原始的 Git Flow 分支模型</li>
<li>Github Flow: Git Flow 的简化版，专门配合持续发布</li>
<li>GitLab Flow: Git Flow 与 Github Flow 的结合版</li>
</ul>
<p>关于三种 Git Flow 区别详情可参考 <a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2015/12/git-workflow.html">Git 工作流程</a></p>
<h3 id="二、-Git-Flow-流程">二、 Git Flow 流程</h3>
<p>Github Flow 和 GitLab Flow 对于持续发布支持比较好，但是原始版本的 Git Flow 对于传统的按照版本发布更加友好一些，所以以下主要说明以下 Git Flow 的工作流程；Git Flow 主要分支模型如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220215.jpg" alt="git flow"></p>
<p>在整个分支模型中 <strong>存在两个长期分支: develop 和 master</strong>，其中 develop 分支为开发分支，master 为生产分支；<strong>master 代码始终保持随时可以部署到线上的状态；develop 分支用于合并最新提交的功能性代码</strong>；具体的分支定义如下</p>
<ul>
<li>master: 生产代码，始终保持可以直接部署生产的状态</li>
<li>develop: 开发分支，每次合并最新功能代码到此分支</li>
<li>feature: 新功能分支，所有新开发的功能将采用 <code>feature/xxxx</code> 形式命名分支</li>
<li>hotfixes: 紧急修复补丁分支，当新功能部署到了线上出现了严重 bug 需要紧急修复时，则创建 <code>hotfixes/xxxx</code> 形式命名的分支</li>
<li>release: 稳定版分支，当完成大版本变动后，应该创建 <code>release/xxxx</code> 分支</li>
</ul>
<p>在整个分支模型中，develop 分支为最上游分支，会不断有新的 feature 合并入 develop 分支，当功能开发达到完成所有版本需求时，则从 develop 分支创建 release 分支，release 后如没有发现其他问题，最终 release 会被合并到 master 分支以完成线上部署</p>
<h3 id="三、Git-Flow-工具">三、Git Flow 工具</h3>
<p>针对于 Git Flow，其手动操作 git 命令可能过于繁琐，所以后来有了 git-flow 工具；git-flow 是一个 git 扩展集，按 Vincent Driessen 的分支模型提供高层次的库操作；使用 git-flow 工具可以以更加简单的命令完成对 Vincent Driessen 分支模型的实践；<br>
git-flow 安装以及使用具体请参考 <a target="_blank" rel="noopener" href="https://danielkummer.github.io/git-flow-cheatsheet/index.zh_CN.html">git-flow 备忘清单</a>，该文章详细描述了 git-flow 工具的使用方式</p>
<p>还有另一个工具是 <a target="_blank" rel="noopener" href="https://github.com/tj/git-extras">git-extras</a>，该工具没有 git-flow 那么简单化，不过其提供更加强大的命令支持</p>
<h3 id="四、Git-Commit-Message">四、Git Commit Message</h3>
<p>在整个 Git Flow 中，commit message 也是必不可少的一部分；一个良好且统一的 commit message 有助于代码审计以及 review 等；目前使用最广泛的写法是 <a target="_blank" rel="noopener" href="https://docs.google.com/document/d/1QrDFcIiPjSLDn3EL15IJygNPiHORgU1_OOAqWjiDU5Y/edit#heading=h.greljkmo14y0">Angular 社区规范</a>，该规范大中 commit message 格式大致如下:</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>(<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>): <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>subject</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BLANK</span> <span class="token attr-name">LINE</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BLANK</span> <span class="token attr-name">LINE</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>footer</span><span class="token punctuation">&gt;</span></span>Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>总体格式大致分为 3 部分，首行主要 3 个组成部分:</p>
<ul>
<li>type: 本次提交类型</li>
<li>scope: 本次提交影响范围，一般标明影响版本号或者具体的范围如 <code>$browser, $compile, $rootScope, ngHref, ngClick, ngView, etc...</code></li>
<li>subject: 本次提交简短说明</li>
</ul>
<p>关于 type 提交类型，有如下几种值:</p>
<ul>
<li>feat：新功能(feature)</li>
<li>fix：修补 bug</li>
<li>docs：文档(documentation)</li>
<li>style： 格式(不影响代码运行的变动)</li>
<li>refactor：重构(即不是新增功能，也不是修改 bug 的代码变动)</li>
<li>test：增加测试</li>
<li>chore：构建过程或辅助工具的变动</li>
</ul>
<p>中间的 body 部分是对本次提交的详细描述信息，底部的 footer 部分一般分为两种情况:</p>
<ul>
<li>不兼容变动: 如果出现不兼容变动，则以 <code>BREAKING CHANGE:</code> 开头，后面跟上不兼容变动的具体描述和解决办法</li>
<li>关闭 issue: 如果该 commit 针对某个 issue，并且可以将其关闭，则可以在其中指定关闭的 issue，如 <code>Close #9527,#9528</code></li>
</ul>
<p>不过 footer 部分也有特殊情况，如回滚某次提交，则以 <code>revert:</code> 开头，后面紧跟 commit 信息和具体描述；还有时某些 commit 只是解决了 某个 issue 的一部分问题，这是可以使用 <code>refs ISSUE</code> 的方式来引用该 issue</p>
<h3 id="五、Git-Commit-Message-工具">五、Git Commit Message 工具</h3>
<p>针对 Git 的 commit message 目前已经有了成熟的生成工具，比较有名的为 <a target="_blank" rel="noopener" href="https://github.com/commitizen/cz-cli">commitizen-cli</a> 工具，其采用 node.js 编写，执行 <code>git cz</code> 命令能够自动生成符合 Angular 社区规范的 commit message；不过由于其使用 node.js 编写，所以安装前需要安装 node.js，因此可能不适合其他非 node.js 的项目使用；这里推荐一个基于 shell 编写的 <a target="_blank" rel="noopener" href="https://cimhealth.github.io/git-toolkit">Git-toolkit</a>，安装此工具后执行 <code>git ci</code> 命令进行提交将会产生交互式生成 Angular git commit message 格式的提交说明，截图如下:</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220233.jpg" alt="git ci"></p>
<h3 id="六、GitLab-整合">六、GitLab 整合</h3>
<p>以上 Git Flow 所有操作介绍的都是在本地操作，而正常我们在工作中都是基于 GitLab 搭建私有 Git 仓库来进行协同开发的，以下简述以下 Git Flow 配合 GitLab 的流程</p>
<h4 id="6-1、开发-features">6.1、开发 features</h4>
<p>当开发一个新功能时流程如下:</p>
<ul>
<li>本地 <code>git flow feature start xxxx</code> 开启一个 feature 新分支</li>
<li><code>git flow feature publish xxxx</code> 将此分支推送到远端以便他人获取</li>
<li>完成开发后 GitLab 上向 <code>develop</code> 分支发起合并请求</li>
<li>CI sonar 等质量检测工具扫描，其他用户 review 代码</li>
<li>确认无误后 <code>master</code> 权限用户合并其到 <code>develop</code> 分支</li>
<li>部署到测试环境以便测试组测试</li>
<li>如果测试不通过，则继续基于此分支开发，直到该功能开发完成</li>
</ul>
<h4 id="6-2、创建-release">6.2、创建 release</h4>
<p>当一定量的 feature 开发完成并合并到 develop 后，如所有 feature 都测试通过并满足版本需求，则可以创建 release 版本分支；release 分支流程如下</p>
<ul>
<li>本地 <code>git flow release start xxxx</code> 开启 release 分支</li>
<li><code>git flow release publish xxxx</code> 将其推送到远端以便他人获取</li>
<li>继续进行完整性测试，出现问题继续修复，直到 release 完全稳定</li>
<li>从 release 分支向 master、develop 分支分别发起合并请求</li>
<li>master 合并后创建对应的 release 标签，并部署生产环境</li>
<li>develop 合并 release 的后期修改</li>
</ul>
<h4 id="6-3、紧急修复">6.3、紧急修复</h4>
<p>当 master 某个 tag 部署到生产环境后，也可能出现不符合预期的问题出现；此时应该基于 master 创建 hotfix 分支进行修复，流程如下</p>
<ul>
<li>本地 <code>git flow hotfix start xxxx</code> 创建紧急修复分支</li>
<li>修改代码后将其推送到远端，并像 master、develop 分支发起合并</li>
<li>develop 合并紧急修复补丁，如果必要最好再做一下测试</li>
<li>master 合并紧急修复补丁，创建紧急修复 tag，并部署生产环境</li>
</ul>
<h3 id="七、环境准备">七、环境准备</h3>
<p>首先需要有一台 GitLab 服务器，然后需要有个项目；这里示例项目以 Spring Boot 项目为例，然后最好有一台专门用来 Build 的机器，实际生产中如果 Build 任务不频繁可适当用一些业务机器进行 Build；本文示例所有组件将采用 Docker 启动， GitLab HA 等不在本文阐述范围内</p>
<ul>
<li>Docker Version : 1.13.1</li>
<li>GitLab Version : 10.1.4-ce.0</li>
<li>GitLab Runner Version : 10.1.0</li>
<li>GitLab IP : 172.16.0.37</li>
<li>GitLab Runner IP : 172.16.0.36</li>
</ul>
<h3 id="八、GitLab-CI-简介">八、GitLab CI 简介</h3>
<p>GitLab CI 是 GitLab 默认集成的 CI 功能，GitLab CI 通过在项目内 <code>.gitlab-ci.yaml</code> 配置文件读取 CI 任务并进行相应处理；GitLab CI 通过其称为 GitLab Runner 的 Agent 端进行 build 操作；Runner 本身可以使用多种方式安装，比如使用 Docker 镜像启动等；Runner 在进行 build 操作时也可以选择多种 build 环境提供者；比如直接在 Runner 所在宿主机 build、通过新创建虚拟机(vmware、virtualbox)进行 build等；同时 Runner 支持 Docker 作为 build 提供者，即每次 build 新启动容器进行 build；GitLab CI 其大致架构如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220236.png" alt="GitLab"></p>
<h3 id="九、搭建-GitLab-服务器">九、搭建 GitLab 服务器</h3>
<h4 id="9-1、GitLab-搭建">9.1、GitLab 搭建</h4>
<p>GitLab 搭建这里直接使用 docker compose 启动，compose 配置如下</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">gitlab</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'gitlab/gitlab-ce:10.1.4-ce.0'</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> gitlab
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> <span class="token string">'git.mritd.me'</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">GITLAB_OMNIBUS_CONFIG</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        external_url 'http://git.mritd.me'
        # Add any other gitlab.rb configuration here, each on its own line</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'80:80'</span>
      <span class="token punctuation">-</span> <span class="token string">'443:443'</span>
      <span class="token punctuation">-</span> <span class="token string">'8022:22'</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'./data/gitlab/config:/etc/gitlab'</span>
      <span class="token punctuation">-</span> <span class="token string">'./data/gitlab/logs:/var/log/gitlab'</span>
      <span class="token punctuation">-</span> './data/gitlab/data<span class="token punctuation">:</span>/var/opt/gitlab'Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>直接启动后，首次登陆需要设置初始密码如下，默认用户为 <code>root</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220240.png" alt="gitkab init"></p>
<p>登陆成功后创建一个用户(该用户最好给予 Admin 权限，以后操作以该用户为例)，并且创建一个测试 Group 和 Project，如下所示</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220427.png" alt="Create User"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220432.png" alt="Test Project"></p>
<h4 id="9-2、增加示例项目">9.2、增加示例项目</h4>
<p>这里示例项目采用 Java 的 SpringBoot 项目，并采用 Gradle 构建，其他语言原理一样；<strong>如果不熟悉 Java 的没必要死磕此步配置，任意语言(最好 Java)整一个能用的 Web 项目就行，并不强求一定 Java 并且使用 Gradle 构建，以下只是一个样例项目</strong>；SpringBoot 可以采用 <a target="_blank" rel="noopener" href="https://start.spring.io/">Spring Initializr</a> 直接生成(依赖要加入 WEB)，如下所示</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220246.png" alt="Spring Initializr"></p>
<p>将项目导入 IDEA，然后创建一个 index 示例页面，主要修改如下</p>
<ul>
<li>build.gradle</li>
</ul>
<pre class="line-numbers language-jade" data-language="jade"><code class="language-jade">buildscript {
    ext {
        springBootVersion = '1.5.8.RELEASE'
    }
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")
    }
}

apply plugin: 'java'
apply plugin: 'eclipse'
apply plugin: 'idea'
apply plugin: 'org.springframework.boot'

group = 'me.mritd'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = 1.8

repositories {
    mavenCentral()
}


dependencies {
    compile('org.springframework.boot:spring-boot-starter')
    compile('org.springframework.boot:spring-boot-starter-web')
    compile('org.springframework.boot:spring-boot-starter-thymeleaf')
    testCompile('org.springframework.boot:spring-boot-starter-test')
}Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>新建一个 HomeController</li>
</ul>
<pre class="line-numbers language-jade" data-language="jade"><code class="language-jade">package me.mritd.TestProject;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;

/*******************************************************************************
 * Copyright (c) 2005-2017 Mritd, Inc.
 * TestProject
 * me.mritd.TestProject
 * Created by mritd on 2017/11/24 下午12:23.
 * Description: 
 *******************************************************************************/
@Controller
public class HomeController {

    @RequestMapping("/")
    public String home(){
        return "index";
    }
}Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>templates 下新建 index.html</li>
</ul>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Test...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后项目整体结构如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220249.png" alt="TestProject"></p>
<p>执行 <code>assemble</code> Task 打包出可执行 jar 包，并运行 <code>java -jar TestProject-0.0.1-SNAPSHOT.jar</code> 测试下能启动访问页面即可</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220251.png" alt="TestProject assemble"></p>
<p>最后将项目提交到 GitLab 后如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220304.png" alt="init Project"></p>
<h3 id="十、GitLab-CI-配置">十、GitLab CI 配置</h3>
<blockquote>
<p>针对这一章节创建基础镜像以及项目镜像，这里仅以 Java 项目为例；其他语言原理相通，按照其他语言对应的运行环境修改即可</p>
</blockquote>
<h4 id="10-1、增加-Runner">10.1、增加 Runner</h4>
<p>GitLab CI 在进行构建时会将任务下发给 Runner，让 Runner 去执行；所以先要添加一个 Runner，Runner 这里采用 Docker Compose 启动，build 方式也使用 Docker 方式 Build；compose 文件如下</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">gitlab-runner</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>runner
    <span class="token key atrule">image</span><span class="token punctuation">:</span> gitlab/gitlab<span class="token punctuation">-</span>runner<span class="token punctuation">:</span>alpine<span class="token punctuation">-</span>v10.1.0
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"host"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/var/run/docker.sock
      <span class="token punctuation">-</span> ./config.toml<span class="token punctuation">:</span>/etc/gitlab<span class="token punctuation">-</span>runner/config.toml
    <span class="token key atrule">extra_hosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> "git.mritd.me<span class="token punctuation">:</span>172.16.0.37"Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>在启动前，我们需要先 touch 一下这个 config.toml 配置文件</strong>；该文件是 Runner 的运行配置，此后 Runner 所有配置都会写入这个文件(不 touch 出来 docker-compose 发现不存在会挂载一个目录进去，导致 Runner 启动失败)；启动 docker-compose 后，<strong>需要进入容器执行注册，让 Runner 主动去连接 GitLab 服务器</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 生成 Runner 配置文件</span>
<span class="token function">touch</span> config.toml
<span class="token comment"># 启动 Runner</span>
<span class="token function">docker-compose</span> up -d
<span class="token comment"># 激活 Runner</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it gitlab-runner gitlab-runner registerCopy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在执行上一条激活命令后，会按照提示让你输入一些信息；<strong>首先输入 GitLab 地址，然后是 Runner Token，Runner Token 可以从 GitLab 设置中查看</strong>，如下所示</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220624.png" alt="Runner Token"></p>
<p>整体注册流程如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220312.png" alt="Runner registry"></p>
<p>注册完成后，在 GitLab Runner 设置中就可以看到刚刚注册的 Runner，如下所示</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220628.png" alt="Runner List"></p>
<p><strong>Runner 注册成功后会将配置写入到 config.toml 配置文件；由于两个测试宿主机都没有配置内网 DNS，所以为了保证 runner 在使用 docker build 时能正确的找到 GitLab 仓库地址，还需要增加一个 docker 的 host 映射( <code>extra_hosts</code> )；同时为了能调用 宿主机 Docker 和持久化 build 的一些缓存还挂载了一些文件和目录；完整的 配置如下(配置文件可以做一些更高级的配置，具体参考 <a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/configuration/advanced-configuration.html">官方文档</a> )</strong></p>
<ul>
<li>config.toml</li>
</ul>
<pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token key property">concurrent</span> <span class="token punctuation">=</span> <span class="token number">1</span>
<span class="token key property">check_interval</span> <span class="token punctuation">=</span> <span class="token number">0</span>

<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token table class-name">runners</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"Test Runner"</span>
  <span class="token key property">url</span> <span class="token punctuation">=</span> <span class="token string">"http://git.mritd.me"</span>
  <span class="token key property">token</span> <span class="token punctuation">=</span> <span class="token string">"c279ec1ac08aec98c7141c7cf2d474"</span>
  <span class="token key property">executor</span> <span class="token punctuation">=</span> <span class="token string">"docker"</span>
  <span class="token key property">builds_dir</span> <span class="token punctuation">=</span> <span class="token string">"/gitlab/runner-builds"</span>
  <span class="token key property">cache_dir</span> <span class="token punctuation">=</span> <span class="token string">"/gitlab/runner-cache"</span>
  <span class="token punctuation">[</span><span class="token table class-name">runners.docker</span><span class="token punctuation">]</span>
    <span class="token key property">tls_verify</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
    <span class="token key property">image</span> <span class="token punctuation">=</span> <span class="token string">"debian"</span>
    <span class="token key property">privileged</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
    <span class="token key property">disable_cache</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
    <span class="token key property">shm_size</span> <span class="token punctuation">=</span> <span class="token number">0</span>
    <span class="token key property">volumes</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"/data/gitlab-runner:/gitlab"</span><span class="token punctuation">,</span><span class="token string">"/var/run/docker.sock:/var/run/docker.sock"</span><span class="token punctuation">,</span><span class="token string">"/data/maven_repo:/data/repo"</span><span class="token punctuation">,</span><span class="token string">"/data/maven_repo:/data/maven"</span><span class="token punctuation">,</span><span class="token string">"/data/gradle:/data/gradle"</span><span class="token punctuation">,</span><span class="token string">"/data/sonar_cache:/root/.sonar"</span><span class="token punctuation">,</span><span class="token string">"/data/androidsdk:/usr/local/android"</span><span class="token punctuation">,</span><span class="token string">"/data/node_modules:/data/node_modules"</span><span class="token punctuation">]</span>
    <span class="token key property">extra_hosts</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"git.mritd.me:172.16.0.37"</span><span class="token punctuation">]</span>
  <span class="token punctuation">[</span><span class="token table class-name">runners.cache</span><span class="token punctuation">]</span>Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>注意，这里声明的 Volumes 会在每个运行的容器中都生效；也就是说 build 时新开启的每个容器都会被挂载这些目录</strong>；修改完成后重启 runner 容器即可，由于 runner 中没啥可保存的东西，所以可以直接 <code>docker-compose down &amp;&amp; docker-compose up -d</code> 重启</p>
<h4 id="10-2、创建基础镜像">10.2、创建基础镜像</h4>
<p>由于示例项目是一个 Java 项目，而且是采用 Spring Boot 的，所以该项目想要运行起来只需要一个 java 环境即可，中间件已经被打包到了 jar 包中；以下是一个作为基础运行环境的 openjdk 镜像的 Dockerfile</p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">FROM alpine:edge 

LABEL maintainer="mritd &lt;mritd1234@gmail.com&gt;"

ENV JAVA_HOME /usr/lib/jvm/java-1.8-openjdk
ENV PATH $PATH:/usr/lib/jvm/java-1.8-openjdk/jre/bin:/usr/lib/jvm/java-1.8-openjdk/bin

RUN apk add --update bash curl tar wget ca-certificates unzip \
        openjdk8 font-adobe-100dpi ttf-dejavu fontconfig \
    &amp;&amp; rm -rf /var/cache/apk/* \

CMD ["bash"]Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>这个 openjdk Dockerfile 升级到了 8.151 版本，并且集成了一些字体相关的软件，以解决在 Java 中某些验证码库无法运行问题，详见 <a target="_blank" rel="noopener" href="https://mritd.me/2017/09/27/alpine-3.6-openjdk-8-bug/">Alpine 3.6 OpenJDK 8 Bug</a></strong>；使用这个 Dockerfile，在当前目录执行 <code>docker build -t mritd/openjdk:8 .</code> build 一个 openjdk8 的基础镜像，然后将其推送到私服，或者 Docker Hub 即可</p>
<h4 id="10-3、创建项目镜像">10.3、创建项目镜像</h4>
<p>有了基本的 openjdk 的 docker 镜像后，针对于项目每次 build 都应该生成一个包含发布物的 docker 镜像，所以对于项目来说还需要一个项目本身的 Dockerfile；<strong>项目的 Dockerfile 有两种使用方式；一种是动态生成 Dockerfile，然后每次使用新生成的 Dockerfile 去 build；还有一种是写一个通用的 Dockerfile，build 时利用 ARG 参数传入变量</strong>；这里采用第二种方式，以下为一个可以反复使用的 Dockerfile</p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">FROM mritd/openjdk:8-144-01

MAINTAINER mritd &lt;mritd1234@gmail.com&gt;

ARG PROJECT_BUILD_FINALNAME

ENV TZ 'Asia/Shanghai'
ENV PROJECT_BUILD_FINALNAME ${PROJECT_BUILD_FINALNAME}


COPY build/libs/${PROJECT_BUILD_FINALNAME}.jar /${PROJECT_BUILD_FINALNAME}.jar

CMD ["bash","-c","java -jar /${PROJECT_BUILD_FINALNAME}.jar"]Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>该 Dockerfile 通过声明一个 <code>PROJECT_BUILD_FINALNAME</code> 变量来表示项目的发布物名称；然后将其复制到根目录下，最终利用 java 执行这个 jar 包；所以每次 build 之前只要能拿到项目发布物的名称即可</strong></p>
<h4 id="10-4、Gradle-修改">10.4、Gradle 修改</h4>
<p>上面已经创建了一个标准的通用型 Dockerfile，每次 build 镜像只要传入 <code>PROJECT_BUILD_FINALNAME</code> 这个最终发布物名称即可；对于发布物名称来说，最好不要固定死；当然不论是 Java 还是其他语言的项目我们都能将最终发布物变成一个固定名字，最不济可以写脚本重命名一下；但是不建议那么干，最好保留版本号信息，以便于异常情况下进入容器能够分辨；对于当前 Java 项目来说，想要拿到 <code>PROJECT_BUILD_FINALNAME</code> 很简单，我们只需要略微修改一下 Gradle 的 build 脚本，让其每次打包 jar 包时将项目的名称及版本号导出到文件中即可；同时这里也加入了镜像版本号的处理，Gradle 脚本修改如下</p>
<ul>
<li>build.gradle 最后面增加如下</li>
</ul>
<pre class="line-numbers language-jade" data-language="jade"><code class="language-jade">bootRepackage {

    mainClass = 'me.mritd.TestProject.TestProjectApplication'
    executable = true

    doLast {
        File envFile = new File("build/tmp/PROJECT_ENV")

        println("Create ${archivesBaseName} ENV File ===&gt; " + envFile.createNewFile())
        println("Export ${archivesBaseName} Build Version ===&gt; ${version}")
        envFile.write("export PROJECT_BUILD_FINALNAME=${archivesBaseName}-${version}\n")

        println("Generate Docker image tag...")
        envFile.append("export BUILD_DATE=`date +%Y%m%d%H%M%S`\n")
        envFile.append("export IMAGE_NAME=mritd/test:`echo \${CI_BUILD_REF_NAME} | tr '/' '-'`-`echo \${CI_COMMIT_SHA} | cut -c1-8`-\${BUILD_DATE}\n")
        envFile.append("export LATEST_IMAGE_NAME=mritd/test:latest\n")
    }
}Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>这一步操作实际上是修改了 <code>bootRepackage</code> 这个 Task(不了解 Gradle 或者不是 Java 项目的请忽略)，在其结束后创建了一个叫 <code>PROJECT_ENV</code> 的文件，里面实际上就是写入了一些 bash 环境变量声明，以方便后面 source 一下这个文件拿到一些变量，然后用户 build 镜像使用</strong>，<code>PROJECT_ENV</code> 最终生成如下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">PROJECT_BUILD_FINALNAME</span><span class="token operator">=</span>TestProject-0.0.1-SNAPSHOT
<span class="token builtin class-name">export</span> <span class="token assign-left variable">BUILD_DATE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%Y%m%d%H%M%S<span class="token variable">`</span></span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">IMAGE_NAME</span><span class="token operator">=</span>mritd/test:<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">echo</span> $<span class="token punctuation">{</span>CI_BUILD_REF_NAME<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">'/'</span> <span class="token string">'-'</span><span class="token variable">`</span></span>-<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">echo</span> $<span class="token punctuation">{</span>CI_COMMIT_SHA<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">cut</span> -c1-8<span class="token variable">`</span></span>-<span class="token variable">${BUILD_DATE}</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">LATEST_IMAGE_NAME</span><span class="token operator">=</span>mritd/test:latestCopy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220738.png" alt="PROJECT_ENV"></p>
<h4 id="10-5、创建-CI-配置文件">10.5、创建 CI 配置文件</h4>
<p>一切准备就绪以后，就可以编写 CI 脚本了；GitLab 依靠读取项目根目录下的 <code>.gitlab-ci.yml</code> 文件来执行相应的 CI 操作；以下为测试项目的 <code>.gitlab-ci.yml</code> 配置</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 调试开启</span>
<span class="token comment">#before_script:</span>
<span class="token comment">#  - pwd</span>
<span class="token comment">#  - env</span>

<span class="token key atrule">cache</span><span class="token punctuation">:</span>
  <span class="token key atrule">key</span><span class="token punctuation">:</span> $CI_PROJECT_NAME/$CI_COMMIT_REF_NAME<span class="token punctuation">-</span>$CI_COMMIT_SHA
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> build

<span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> build
  <span class="token punctuation">-</span> deploy

<span class="token key atrule">auto-build</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> mritd/build<span class="token punctuation">:</span>2.1.1
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> build
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> gradle <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>daemon clean assemble
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> test

<span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> mritd/docker<span class="token punctuation">-</span>kubectl<span class="token punctuation">:</span>v1.7.4
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> source build/tmp/PROJECT_ENV
    <span class="token punctuation">-</span> echo "Build Docker Image ==<span class="token punctuation">&gt;</span> $<span class="token punctuation">{</span>IMAGE_NAME<span class="token punctuation">}</span>"
    <span class="token punctuation">-</span> docker build <span class="token punctuation">-</span>t $<span class="token punctuation">{</span>IMAGE_NAME<span class="token punctuation">}</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>build<span class="token punctuation">-</span>arg PROJECT_BUILD_FINALNAME=$<span class="token punctuation">{</span>PROJECT_BUILD_FINALNAME<span class="token punctuation">}</span> .
<span class="token comment">#    - docker push ${IMAGE_NAME}</span>
    <span class="token punctuation">-</span> docker tag $<span class="token punctuation">{</span>IMAGE_NAME<span class="token punctuation">}</span> $<span class="token punctuation">{</span>LATEST_IMAGE_NAME<span class="token punctuation">}</span>
<span class="token comment">#    - docker push ${LATEST_IMAGE_NAME}</span>
<span class="token comment">#    - docker rmi ${IMAGE_NAME} ${LATEST_IMAGE_NAME}</span>
<span class="token comment">#    - kubectl --kubeconfig ${KUBE_CONFIG} set image deployment/test test=$IMAGE_NAME</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> test
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> master
    <span class="token punctuation">-</span> develop
    <span class="token punctuation">-</span> /^chore.<span class="token important">*$/Copy</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><strong>关于 CI 配置的一些简要说明如下</strong></li>
</ul>
<h5 id="stages">stages</h5>
<p>stages 字段定义了整个 CI 一共有哪些阶段流程，以上的 CI 配置中，定义了该项目的 CI 总共分为 <code>build</code>、<code>deploy</code> 两个阶段；GitLab CI 会根据其顺序执行对应阶段下的所有任务；<strong>在正常生产环境流程可以定义很多个，比如可以有 <code>test</code>、<code>publish</code>，甚至可能有代码扫描的 <code>sonar</code> 阶段等；这些阶段没有任何限制，完全是自定义的</strong>，上面的阶段定义好后在 CI 中表现如下图</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220327.png" alt="stages"></p>
<h5 id="task">task</h5>
<p>task 隶属于 stages 之下；也就是说一个阶段可以有多个任务，任务执行顺序默认不指定会并发执行；对于上面的 CI 配置来说 <code>auto-build</code> 和 <code>deploy</code> 都是 task，他们通过 <code>stage: xxxx</code> 这个标签来指定他们隶属于哪个 stage；当 Runner 使用 Docker 作为 build 提供者时，我们可以在 task 的 <code>image</code> 标签下声明该 task 要使用哪个镜像运行，不指定则默认为 Runner 注册时的镜像(这里是 debian)；<strong>同时 task 还有一个 <code>tags</code> 的标签，该标签指明了这个任务将可以在哪些 Runner 上运行；这个标签可以从 Runner 页面看到，实际上就是 Runner 注册时输入的哪个 tag；对于某些特殊的项目，比如 IOS 项目，则必须在特定机器上执行，所以此时指定 tags 标签很有用</strong>，当 task 运行后如下图所示</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101221014.png" alt="Task"></p>
<p>除此之外 task 还能指定 <code>only</code> 标签用于限定那些分支才能触发这个 task，如果分支名字不满足则不会触发；<strong>默认情况下，这些 task 都是自动执行的，如果感觉某些任务太过危险，则可以通过增加 <code>when: manual</code> 改为手动执行；注意: 手动执行被 GitLab 认为是高权限的写操作，所以只有项目管理员才能手动运行一个 task，直白的说就是管理员才能点击</strong>；手动执行如下图所示</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220759.png" alt="manual task"></p>
<h5 id="cache">cache</h5>
<p>cache 这个参数用于定义全局那些文件将被 cache；<strong>在 GitLab CI 中，跨 stage 是不能保存东西的；也就是说在第一步 build 的操作生成的 jar 包，到第二部打包 docker image 时就会被删除；GitLab 会保证每个 stage 中任务在执行时都将工作目录(Docker 容器 中)还原到跟 GitLab 代码仓库中一模一样，多余文件及变更都会被删除</strong>；正常情况下，第一步 build 生成 jar 包应当立即推送到 nexus 私服；但是这里测试没有搭建，所以只能放到本地；但是放到本地下一个 task 就会删除它，所以利用 <code>cache</code> 这个参数将 <code>build</code> 目录 cache 住，保证其跨 stage 也能存在</p>
<p><strong>关于 <code>.gitlab-ci.yml</code> 具体配置更完整的请参考 <a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/yaml/">官方文档</a></strong></p>
<h3 id="十一、其他相关">十一、其他相关</h3>
<h4 id="11-1、GitLab-内置环境变量">11.1、GitLab 内置环境变量</h4>
<p>上面已经基本搞定了一个项目的 CI，但是有些变量可能并未说清楚；比如在创建的 <code>PROJECT_ENV</code> 文件中引用了 <code>${CI_COMMIT_SHA}</code> 变量；这种变量其实是 GitLab CI 的内置隐藏变量，这些变量在每次 CI 调用 Runner 运行某个任务时都会传递到对应的 Runner 的执行环境中；<strong>也就是说这些变量在每次的任务容器 SHELL 环境中都会存在，可以直接引用</strong>，具体的完整环境变量列表可以从 <a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/variables/">官方文档</a> 中获取；如果想知道环境变量具体的值，实际上可以通过在任务执行前用 <code>env</code> 指令打印出来，如下所示</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220338.png" alt="env"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220800.png" alt="env task"></p>
<h4 id="11-2、GitLab-自定义环境变量">11.2、GitLab 自定义环境变量</h4>
<p>在某些情况下，我们希望 CI 能自动的发布或者修改一些东西；比如将 jar 包上传到 nexus、将 docker 镜像 push 到私服；这些动作往往需要一个高权限或者说有可写入对应仓库权限的账户来支持，但是这些账户又不想写到项目的 CI 配置里；因为这样很不安全，谁都能看到；此时我们可以将这些敏感变量写入到 GitLab 自定义环境变量中，GitLab 会像对待内置变量一样将其传送到 Runner 端，以供我们使用；GitLab 中自定义的环境变量可以有两种，一种是项目级别的，只能够在当前项目使用，如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220803.png" alt="project env"></p>
<p>另一种是组级别的，可以在整个组内的所有项目中使用，如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220805.png" alt="group env"></p>
<p>这两种变量添加后都可以在 CI 的脚本中直接引用</p>
<h4 id="11-3、Kubernetes-集成">11.3、Kubernetes 集成</h4>
<p>对于 Kubernetes 集成实际上有两种方案，一种是对接 Kubernetes 的 api，纯代码实现；另一种取巧的方案是调用 kubectl 工具，用 kubectl 工具来实现滚动升级；这里采用后一种取巧的方式，将 kubectl 二进制文件封装到镜像中，然后在 deploy 阶段使用这个镜像直接部署就可以</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101220345.png" alt="kubectl"></p>
<p>其中 <code>mritd/docker-kubectl:v1.7.4</code> 这个镜像的 Dockerfile 如下</p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">FROM docker:dind 

LABEL maintainer="mritd &lt;mritd1234@gmail.com&gt;"

ARG TZ="Asia/Shanghai"

ENV TZ ${TZ}

ENV KUBE_VERSION v1.8.0

RUN apk upgrade --update \
    &amp;&amp; apk add bash tzdata wget ca-certificates \
    &amp;&amp; wget https://storage.googleapis.com/kubernetes-release/release/${KUBE_VERSION}/bin/linux/amd64/kubectl -O /usr/local/bin/kubectl \
    &amp;&amp; chmod +x /usr/local/bin/kubectl \
    &amp;&amp; ln -sf /usr/share/zoneinfo/${TZ} /etc/localtime \
    &amp;&amp; echo ${TZ} &gt; /etc/timezone \
    &amp;&amp; rm -rf /var/cache/apk/*

CMD ["/bin/bash"]Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面的 <code>${KUBE_CONFIG}</code> 是一个自定义的环境变量，对于测试环境我将配置文件直接挂载入了容器中，然后 <code>${KUBE_CONFIG}</code> 只是指定了一个配置文件位置，实际生产环境中可以选择将配置文件变成自定义环境变量使用</p>
<h4 id="11-4、GitLab-CI-总结">11.4、GitLab CI 总结</h4>
<p>关于 GitLab CI 上面已经讲了很多，但是并不全面，也不算太细致；因为这东西说起来实际太多了，现在目测已经 1W 多字了；以下总结一下 GitLab CI 的总体思想，当思路清晰了以后，我想后面的只是查查文档自己试一试就行了</p>
<ul>
<li><strong>CS 架构</strong></li>
</ul>
<p>GitLab 作为 Server 端，控制 Runner 端执行一系列的 CI 任务；代码 clone 等无需关心，GitLab 会自动处理好一切；Runner 每次都会启动新的容器执行 CI 任务</p>
<ul>
<li><strong>容器即环境</strong></li>
</ul>
<p>在 Runner 使用 Docker build 的前提下；<strong>所有依赖切换、环境切换应当由切换不同镜像实现，即 build 那就使用 build 的镜像，deploy 就用带有 deploy 功能的镜像；通过不同镜像容器实现完整的环境隔离</strong></p>
<ul>
<li><strong>CI即脚本</strong></li>
</ul>
<p>不同的 CI 任务实际上就是在使用不同镜像的容器中执行 SHELL 命令，自动化 CI 就是执行预先写好的一些小脚本</p>
<ul>
<li><strong>敏感信息走环境变量</strong></li>
</ul>
<p>一切重要的敏感信息，如账户密码等，不要写到 CI 配置中，直接放到 GitLab 的环境变量中；GitLab 会保证将其推送到远端 Runner 的 SHELL 变量中</p>
<p>转载整理From：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://mritd.com/2017/09/05/git-flow-note/">git-flow-note</a></li>
<li><a target="_blank" rel="noopener" href="https://mritd.com/2017/11/28/ci-cd-gitlab-ci/">ci-cd-gitlab-ci</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Gitlab</category>
      </categories>
      <tags>
        <tag>Gitlab</tag>
        <tag>Git</tag>
        <tag>CI/CD</tag>
      </tags>
  </entry>
  <entry>
    <title>Earthly 一个更加强大的镜像构建工具</title>
    <url>/posts/593cc323/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="一、Earthly-介绍">一、Earthly 介绍</h2>
<blockquote>
<p>开局一张图，功能全靠吹。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101210057.png" alt="img"></p>
<p>Earthly 是一个更加高级的 Docker 镜像构建工具，Earthly 通过自己定义的 Earthfile 来代替传统的 Dockerfile 完成镜像构建；Earthfile 就如同 Earthly 官方所描述:</p>
<pre class="line-numbers language-none"><code class="language-none">**Makefile + Dockerfile = Earthfile**<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在使用 Earthly 进行构建镜像时目前强依赖于 buildkit，Earthly 通过 buildkit 支持了一些 Dockerfile 的扩展语法，同时将 Dockerfile 与 Makefile 整合，使得多平台构建和代码化 Dockerfile 变得更加简单；使用 Earthly 可以更加方便的完成 Dockerfile 的代码复用以及更加友好的 CI 自动集成。</p>
<h2 id="二、快速开始">二、快速开始</h2>
<h3 id="2-1、安装依赖">2.1、安装依赖</h3>
<p>Earthly 目前依赖于 Docker 和 Git，所以安装 Earthly 前请确保机器已经安装了 Docker 和 Git。</p>
<h3 id="2-2、安装-Earthly">2.2、安装 Earthly</h3>
<p>Earthly 采用 Go 编写，所以主要就一个二进制文件，Linux 下安装可以直接参考官方的安装脚本:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> /bin/sh -c <span class="token string">'wget https://github.com/earthly/earthly/releases/latest/download/earthly-linux-amd64 -O /usr/local/bin/earthly &amp;&amp; chmod +x /usr/local/bin/earthly &amp;&amp; /usr/local/bin/earthly bootstrap --with-autocomplete'</span>Copy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装完成后 Earthly 将会启动一个 buildkitd 容器: <code>earthly-buildkitd</code>。</p>
<h3 id="2-3、语法高亮">2.3、语法高亮</h3>
<p>目前 Earthly 官方支持 VS Code、VIM 以及 Sublime Text 三种编辑器的语法高亮，具体如何安装请参考 <a target="_blank" rel="noopener" href="https://earthly.dev/get-earthly">官方文档</a>。</p>
<h3 id="2-4、基本使用">2.4、基本使用</h3>
<p>本示例源于官方 Basic 教程，以下示例以编译 Go 项目为样例:</p>
<p>首先创建一个任意名称的目录，目录中存在项目源码文件以及一个 <code>Earthfile</code> 文件；</p>
<p><strong>main.go</strong></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Earthfile</strong></p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">FROM golang:1.17-alpine
WORKDIR /go-example

build:
    COPY main.go .
    RUN go build -o build/go-example main.go
    SAVE ARTIFACT build/go-example /go-example AS LOCAL build/go-example

docker:
    COPY +build/go-example .
    ENTRYPOINT ["/go-example/go-example"]
    SAVE IMAGE go-example:latestCopy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>有了 <code>Earthfile</code> 以后我们就可以使用 <code>Earthly</code> 将其打包为镜像；</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 目录结构</span>
~/t/earthlytest ❯❯❯ tree
<span class="token builtin class-name">.</span>
├── Earthfile
└── main.go

<span class="token number">0</span> directories, <span class="token number">2</span> files

<span class="token comment"># 通过 earthly 进行构建</span>
~/t/earthlytest ❯❯❯ earthly +dockerCopy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101210338.png" alt="img"></p>
<p>构建完成后我们就可以直接从 docker 的 images 列表中查看刚刚构建的镜像，并运行:</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101212129.png" alt="img"></p>
<h2 id="三、进阶使用">三、进阶使用</h2>
<h3 id="3-1、多阶段构建">3.1、多阶段构建</h3>
<p>Earthfile 中包含类似 Makefile 一样的 <code>target</code>，不同的 <code>target</code> 之间还可以通过特定语法进行引用，每个 <code>target</code> 都可以被单独执行，执行过程中 earthly 会自动解析这些依赖关系。</p>
<p>这种多阶段构建时语法很弹性，我们可以在每个阶段运行独立的命令以及使用不同的基础镜像；从快速开始中可以看到，我们始终使用了一个基础镜像(<code>golang:1.17-alpine</code>)，对于 Go 这种编译后自带运行时不依赖其语言 SDK 的应用，我们事实上可以将 “发布物” 仅放在简单的运行时系统镜像内，从而减少最终镜像体积:</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101210338-2.png" alt="img"></p>
<p>由于使用了多个 target，所以我们可以单独的运行 <code>build</code> 这个 target 来验证我们的编译流程，<strong>这种多 target 的设计方便我们构建应用时对编译、打包步骤的细化拆分，同时也方便我们进行单独的验证。</strong> 例如我们单独执行 <code>build</code> 这个 target 来验证我们的编译流程是否正确:</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101210338-3.png" alt="img"></p>
<p>在其他阶段验证完成后，我们可以直接运行最终的 target，earthly 会自动识别到这种依赖关系从而自动运行其依赖的 target:</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101210338-4.png" alt="img"></p>
<h3 id="3-2、扩展指令">3.2、扩展指令</h3>
<h4 id="3-2-1、SAVE">3.2.1、SAVE</h4>
<p>SAVE 指令是 Earthly 自己的一个扩展指令，实际上分为 <code>SAVE ARTIFACT</code> 和 <code>SAVE IMAGE</code>；其中 <code>SAVE ARTIFACT</code> 指令格式如下:</p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">SAVE ARTIFACT [--keep-ts] [--keep-own] [--if-exists] [--force] &lt;src&gt; [&lt;artifact-dest-path&gt;] [AS LOCAL &lt;local-path&gt;]Copy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>SAVE ARTIFACT</code> 指令用于将文件或目录从 build 运行时环境保存到 target 的 artifact 环境；当保存到 artifact 环境后，可以通过 <code>COPY</code> 等命令在其他位置进行引用，类似于 Dockerfile 的 <code>COPY --from...</code> 语法；不同的是 <code>SAVE ARTIFACT</code> 支持 <code>AS LOCAL &lt;local-path&gt;</code> 附加参数，一但指定此参数后，earthly 会同时将文件或目录在宿主机复制一份，一般用于调试等目的。<code>SAVE ARTIFACT</code> 命令在上面的样例中已经展示了，在运行完 <code>earthly +build</code> 命令后实际上会在本地看到被 SAVE 出来的 ARTIFACT:</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101210338-5.png" alt="img"></p>
<p>而另一个 <code>SAVE IMAGE</code> 指令则主要用于将当前的 build 环境 SAVE 为一个 IMAGE，<strong>如果指定了 <code>--push</code> 选项，同时在执行 <code>earthly +target</code> 命令时也加入 <code>--push</code> 选项，该镜像将会自动被推送到目标 Registry 上。</strong><code>SAVE IMAGE</code> 指令格式如下:</p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">SAVE IMAGE [--cache-from=&lt;cache-image&gt;] [--push] &lt;image-name&gt;...Copy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101210338-6.png" alt="img"></p>
<h4 id="3-2-2、GIT-CLONE">3.2.2、GIT CLONE</h4>
<p><code>GIT CLONE</code> 指令用于将指定 git 仓库 clone 到 build 环境中；与 <code>RUN git clone...</code> 命令不同的是，<strong><code>GIT CLONE</code> 通过宿主机的 git 命令运行，它不依赖于容器内的 git 命令，同时还可以直接为 earthly 配置 git 认证，从而避免将这些安全信息泄漏到 build 环境中；</strong> 关于如何配置 earthly 的 git 认证请参考 <a target="_blank" rel="noopener" href="https://docs.earthly.dev/docs/guides/auth">官方文档</a>；下面是 <code>GIT CLONE</code> 指令的样例</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101213746.png" alt="img"></p>
<h4 id="3-2-3、COPY">3.2.3、COPY</h4>
<p><code>COPY</code> 指令与标准的 Dockerfile COPY 指令类似，除了支持 Dockerfile 标准的 COPY 功能以外，<strong>earthly 中的 <code>COPY</code> 指令可以引用其他 target 环节产生的 artifact，在引用时会自动声明依赖关系；即当在 <code>B</code> target 中存在 <code>COPY +A/xxxxx /path/to/copy</code> 类似的指令时，如果只单纯的执行 <code>earthly +B</code>，那么 earthly 根据依赖分析会得出在 COPY 之前需要执行 target A。</strong><code>COPY</code> 指令的语法格式如下:</p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile"># 与 Dockerfile 相同的使用方式，从上下文复制
COPY [options...] &lt;src&gt;... &lt;dest&gt;

# 扩展支持的从 target 复制方式
COPY [options...] &lt;src-artifact&gt;... &lt;dest&gt;Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="3-2-4、RUN">3.2.4、RUN</h4>
<p><code>RUN</code> 指令在标准使用上与 Dockerfile 里保持一致，除此之外增加了更多的扩展选项，其指令格式如下:</p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile"># shell 方式运行(/bin/sh -c)
RUN [--push] [--entrypoint] [--privileged] [--secret &lt;env-var&gt;=&lt;secret-ref&gt;] [--ssh] [--mount &lt;mount-spec&gt;] [--] &lt;command&gt;

# exec 方式运行
RUN [[&lt;flags&gt;...], "&lt;executable&gt;", "&lt;arg1&gt;", "&lt;arg2&gt;", ...]Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中 <code>--privileged</code> 选项允许运行的命令使用 <code>privileged capabilities</code>，但是需要 earthly 在运行 target 时增加 <code>--allow-privileged</code> 选项；<code>--interactive / --interactive-keep</code> 选项用于交互式执行一些命令，在完成交互后 build 继续进行，<strong>在交互过程中进行的操作都会被持久化到 镜像中:</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101210338-8.png" alt="img"></p>
<p>限于篇幅原因，其他的具体指令请查阅官方文档 <a target="_blank" rel="noopener" href="https://docs.earthly.dev/docs/earthfile">Earthfile reference</a>。</p>
<h3 id="3-3、UDCS">3.3、UDCS</h3>
<p>UDCs 全称 “User-defined commands”，即用户定义指令；通过 UDCs 我们可以将 Earthfile 中特定的命令剥离出来，从而实现更加通用和统一的代码复用；下面是一个定义 UDCs 指令的样例:</p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile"># 定义一个 Command
# ⚠️ 注意: 语法必须满足以下规则
# 1、名称全大写
# 2、名称下划线分割
# 3、首个命令必须为 COMMAND(后面没有冒号)
MY_COPY:
    COMMAND
    ARG src
    ARG dest=./
    ARG recursive=false
    RUN cp $(if $recursive =  "true"; then printf -- -r; fi) "$src" "$dest"

# target 中引用
build:
    FROM alpine:3.13
    WORKDIR /udc-example
    RUN echo "hello" &gt;./foo
    # 通过 DO 关键字引用 UDCs
    DO +MY_COPY --src=./foo --dest=./bar
    RUN cat ./bar # prints "hello"Copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>UDCs 不光可以定义在一个 Earthfile 中，UDCs 可以跨文件、跨目录引用:</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101212525.png" alt="img"></p>
<p>有了 UDCs 以后，我们可以通过这种方式将对基础镜像的版本统一控制、对特殊镜像的通用处理等操作全部抽象出来，然后每个 Earthfile 根据需要进行引用；关于 UDCs 的使用样例可以参考我的 <a target="_blank" rel="noopener" href="https://github.com/mritd/autobuild">autobuild</a> 项目，其中的 <a target="_blank" rel="noopener" href="https://github.com/mritd/autobuild/tree/main/earthfiles/udcs">udcs</a> 目录定义了大量的通用 UDCs，这些 UDCs 被其他目标镜的 Earthfile 批量引用。</p>
<h3 id="3-4、多平台构建">3.4、多平台构建</h3>
<p>在以前使用 Dockerfile 的时候，我们需要自己配置然后开启 buildkit 来实现多平台构建；在配置过程中可能会很繁琐，现在使用 earthly 可以默认帮我们实现多平台的交叉编译，我们需要做的仅仅是在 Earthfile 中声明需要支持哪些平台而已:</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101210338-10.png" alt="img"></p>
<p>以上 Earthfile 在执行 <code>earthly --push +all</code> 构建时，将会自动构建四个平台的镜像，并保持单个 tag，同时由于使用了 <code>--push</code> 选项还会自动推送到 Docker Hub 上:</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0120211101210338-11.png" alt="img"></p>
<h2 id="四、总结">四、总结</h2>
<p>Earthly 弥补了 Dockerfile 的很多不足，解决了很多痛点问题；但同样可能需要一些学习成本，但是如果已经熟悉了 Dockerfile 其实学习成本不高；所以目前还是比较推荐将 Dockerfile 切换为 Earthfile 进行统一和版本化管理的。本文由于篇幅所限(懒)很多地方没有讲，比如共享缓存等，所以关于 Earthly 更多的详细使用等最好还是仔细阅读一下<a target="_blank" rel="noopener" href="https://docs.earthly.dev/docs/guides">官方文档</a>。</p>
<blockquote>
<p>整理转载：<a target="_blank" rel="noopener" href="https://mritd.com/2021/10/27/the-best-image-build-tool-earthly/">the-best-image-build-tool-earthly</a></p>
</blockquote>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>Earthly</tag>
      </tags>
  </entry>
  <entry>
    <title>自己动手制作电子书的最佳方式（支持PDF、ePub、mobi等格式）</title>
    <url>/posts/d6bad1e5/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="前言-3">前言</h2>
<p>对于经常阅读的人来说，制作本地电子书，算是刚需了。网上的很多教程都不太好用，所以我特地整理出一个详细的教程。亲测有效，一劳永逸。</p>
<p>当你意外发现某个宝藏公众号时，想要集中阅读上面的每一篇文章，恨不得一口气看完，你会怎么做呢？你可能会把它添加到“微信读书”App 的书架上：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0220211102223600.jpeg" alt="img"></p>
<p>但上面这种曲线救国的方式并非最佳，仍然不尽人意，存在不少问题。</p>
<p>我知道，现在有很多的第三方服务，可以将任意公众号的文章制作成电子书，我试过很多次，但都是付费的。一听说要钱，你又不干了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0220211102223603.jpeg" alt="img"></p>
<p>再列举一种场景：当你在 GitHub 上发现一个很全面很丰富的项目文档时，仿佛发现了新大陆。可 GitHub 网站的服务器在国外，国内的访问速度实在感人，你想要把它下载到本地查看，会怎么做呢？你估计会选择<code>git clone</code>或者直接选择“Download ZIP”，然后用 Typora 或者 VS Code 软件打开这个项目文档，在本地查看：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0220211102223605.jpeg" alt="img"></p>
<p>总之，你能想到的方式，我都想到了，而且都尝试过。</p>
<p>现在的需求就是，如果你经常阅读网上的资料，肯定会有这样一个需求：<strong>怎么把这些几百页、甚至几千页的内容整理成 PDF、ePub、mobi等格式的电子书呢</strong>？</p>
<p>要么花钱请别人做，要么自己做。</p>
<p>今天这篇文章，就是来告诉你”<strong>自己动手制作 PDF、ePub、mobi 等格式电子书</strong>“的最佳方式。如果你是码农出身，下面讲的这些步骤，根本难不倒你。如果你不是码农出身，也没关系，只要你有一台电脑，跟着我讲的教程研究下去，肯定能搞定。</p>
<p>问题的关键不在于难不难、会不会，而是在于你是不是<strong>爱折腾</strong>。</p>
<h2 id="工具篇">工具篇</h2>
<h3 id="bloodstar-gitbook-builder"><a target="_blank" rel="noopener" href="https://hub.docker.com/r/bloodstar/gitbook-builder">bloodstar/gitbook-builder</a></h3>
<blockquote>
<p>Gitbook Docker 集成开发环境。支持CJK，附带常用工具。使用它，下面一些列环境配置都可以省略了。开箱即用。</p>
</blockquote>
<h3 id="Usage">Usage</h3>
<p>Read the official <a target="_blank" rel="noopener" href="https://toolchain.gitbook.com/">GitBook Toolchain Documentation</a> documentation <a target="_blank" rel="noopener" href="https://github.com/GitbookIO/gitbook#how-to-use-it">GitbookIO/gitbook</a> first.</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># init</span>
<span class="token function">docker</span> run --rm -v <span class="token string">"<span class="token environment constant">$PWD</span>:/gitbook"</span> -p <span class="token number">4000</span>:4000 bloodstar/gitbook-builder gitbook init
<span class="token comment"># serve</span>
<span class="token function">docker</span> run --rm -v <span class="token string">"<span class="token environment constant">$PWD</span>:/gitbook"</span> -p <span class="token number">4000</span>:4000 bloodstar/gitbook-builder gitbook serve
<span class="token comment"># build</span>
<span class="token function">docker</span> run --rm -v <span class="token string">"<span class="token environment constant">$PWD</span>:/gitbook"</span> -p <span class="token number">4000</span>:4000 bloodstar/gitbook-builder gitbook build<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>For short, you can use alias for the long command line text. Place the alias statement in your <code>.bashrc</code> or <code>.zshrc</code>.</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">gitbook</span><span class="token operator">=</span><span class="token string">'docker run --rm -v "$PWD":/gitbook -p 4000:4000 bloodstar/gitbook-builder gitbook'</span>
<span class="token comment"># init</span>
gitbook init
<span class="token comment"># serve</span>
gitbook serve
<span class="token comment"># build</span>
gitbook build
<span class="token comment"># pdf output</span>
gitbook pdf <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Integrate-with-Gitlab-CI">Integrate with Gitlab CI</h3>
<p>This docker image is originally designed for generating ebook with <a target="_blank" rel="noopener" href="https://about.gitlab.com/gitlab-ci/">Gitlab CI</a>. You could configure your Gitlab CI as following:</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">before_script</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> env
  <span class="token punctuation">-</span> export LC_ALL=zh_TW.UTF<span class="token punctuation">-</span><span class="token number">8</span>

<span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> build

<span class="token key atrule">ebook</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> build
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> gitbook pdf
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> book.pdf
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> master
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> gitbook
  <span class="token key atrule">image</span><span class="token punctuation">:</span> bloodstar/gitbook<span class="token punctuation">-</span>builder<span class="token punctuation">:</span>latest
  <span class="token key atrule">allow_failure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="制作电子书的具体步骤">制作电子书的具体步骤</h2>
<h3 id="整体流程">整体流程</h3>
<p>先说一下整体步骤：</p>
<p>（1）安装 gitbook 工具。</p>
<p>（2）安装 calibre 软件，配置 <code>ebook-convert</code>工具。</p>
<p>（3）将<code>md</code>格式的多个文件素材导出为电子书（支持 PDF、ePub、mobi 等格式）。</p>
<p>（4）高级进阶：配置电子书的目录、封面、页眉页脚等。</p>
<p>整理流程如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0220211102223611.jpeg" alt="img"></p>
<p>接下来我们看看详细的完整步骤。</p>
<h3 id="步骤-1：通过-npm-安装-gitbook-cli">步骤 1：通过 npm 安装 gitbook-cli</h3>
<p>安装命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> -g gitbook-cli<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装成功之后，再执行<code>gitbook -V</code>命令确认是否安装成功：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitbook -V
CLI version: <span class="token number">2.3</span>.2
GitBook version: <span class="token number">3.2</span>.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>备注：如果你不知道 <code>npm</code> 是什么，可以自行查阅<strong>如何安装 Node.js 和 npm 环境</strong>。</p>
<h3 id="步骤-2：安装-ebook-convert（针对-Windows-用户）">步骤 2：安装 ebook-convert（针对 Windows 用户）</h3>
<p>ebook-convert 是能够自由转化格式的一个命令行工具，已经包含在 calibre 软件里面了。</p>
<p>（1）安装 <code>calibre</code> 软件。calibre 的官网如下：（我们可以去官网下载安装）</p>
<blockquote>
<p>https://calibre-ebook.com/</p>
</blockquote>
<p>（2）在终端输入如下命令，验证 <code>ebook-convert</code> 是否能正常使用：</p>
<p>如果输入上面的命令后提示错误，说明你还需要将 calibre 的安装目录添加到系统的环境变量中。</p>
<h3 id="步骤-2：安装-ebook-convert（针对-Mac-用户）">步骤 2：安装 ebook-convert（针对 Mac 用户）</h3>
<p>ebook-convert 是能够自由转化格式的一个命令行工具，已经包含在 calibre 软件里面了。</p>
<p>（1）安装 <code>calibre</code> 软件。calibre 的官网如下：（我们可以去官网下载安装）</p>
<blockquote>
<p>https://calibre-ebook.com/</p>
</blockquote>
<p>（2）配置 <code>ebook-convert</code>。针对 Mac 系统，需要执行如下命令，把 <code>ebook-convert</code> 软链接到 <code>bin</code> 目录：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">ln</span> -s /Applications/calibre.app/Contents/MacOS/ebook-convert /usr/bin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>执行上面的命令后，如果出现<code>Operation not permitted</code>异常，说明系统权限限制，此时需要<strong>配置环境变量</strong>。</p>
<p>（3）环境变量配置：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> ~/.bash_profile

<span class="token comment"># 将下面这两行配置，添加到 .bash_profile 文件中</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">EBOOK_PATH</span><span class="token operator">=</span>/Applications/calibre.app/Contents/MacOS
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$EBOOK_PATH</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>备注：可以自行研究下，在命令行环境，如何通过 vim 编辑文件。</p>
<p>然后刷新一下刚刚的配置：</p>
<p>验证<code>ebook-convert</code>是否能正常使用：</p>
<h3 id="步骤-3：配置电子书的目录">步骤 3：配置电子书的目录</h3>
<p>本地新建一个空的文件夹，作为我们的电子书项目。文件夹的名字随便起，但建议用英文命名。</p>
<p>（1）项目初始化。</p>
<p>在当前项目下，执行如下命令，进行初始化：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitbook init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>此时，项目下会自动生成如下两个文件：（<strong>非常重要，必不可少</strong>）</p>
<ul>
<li><code>README.md</code>：书籍的简介放在这个文件里。</li>
<li><code>SUMMARY.md</code>：书籍的<strong>目录结构</strong>在这里配置。</li>
</ul>
<p>这两个文件创建后，内容为空白，可使用 Markdown 语言自定义内容。</p>
<p>（2）配置电子书的目录。</p>
<p>我们先把本地的 markdown 文件（也就是我们的<strong>电子书素材</strong>）放到项目中，然后在<code>SUMMARY.md</code>文件中配置电子书的目录。</p>
<p>比如说， 我的项目中有下面这些文件：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0220211102223644.jpeg" alt="img"></p>
<p>那么，我在<code>SUMMARY.md</code>文件中就要这样配置：</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> 目录</span>

<span class="token list punctuation">*</span> <span class="token url">[<span class="token content">README</span>](<span class="token url">./README.md</span>)</span>
<span class="token list punctuation">*</span> <span class="token url">[<span class="token content">00-前端工具</span>](<span class="token url">00-前端工具/0-README.md</span>)</span>
  <span class="token list punctuation">*</span> [01-VS Code的使用](00-前端工具/01-VS Code的使用.md)
  <span class="token list punctuation">*</span> <span class="token url">[<span class="token content">02-Git的使用</span>](<span class="token url">00-前端工具/02-Git的使用.md</span>)</span>
<span class="token list punctuation">*</span> <span class="token url">[<span class="token content">01-HTML</span>](<span class="token url">01-HTML/0-README.md</span>)</span>
  <span class="token list punctuation">*</span> <span class="token url">[<span class="token content">01-认识Web和Web标准</span>](<span class="token url">01-HTML/01-认识Web和Web标准.md</span>)</span>
  <span class="token list punctuation">*</span> <span class="token url">[<span class="token content">02-浏览器的介绍</span>](<span class="token url">01-HTML/02-浏览器的介绍.md</span>)</span>
  <span class="token list punctuation">*</span> <span class="token url">[<span class="token content">03-初识HTML</span>](<span class="token url">01-HTML/03-初识HTML.md</span>)</span>
<span class="token list punctuation">*</span> <span class="token url">[<span class="token content">02-CSS基础</span>](<span class="token url">02-CSS基础/0-README.md</span>)</span>
  <span class="token list punctuation">*</span> <span class="token url">[<span class="token content">01-CSS属性：字体属性和文本属性</span>](<span class="token url">02-CSS基础/01-CSS属性：字体属性和文本属性.md</span>)</span>
  <span class="token list punctuation">*</span> <span class="token url">[<span class="token content">02-CSS属性：背景属性</span>](<span class="token url">02-CSS基础/02-CSS属性：背景属性.md</span>)</span>
  <span class="token list punctuation">*</span> <span class="token url">[<span class="token content">03-CSS样式表和选择器</span>](<span class="token url">02-CSS基础/03-CSS样式表和选择器.md</span>)</span>
<span class="token list punctuation">*</span> <span class="token url">[<span class="token content">03-JavaScript基础</span>](<span class="token url">03-JavaScript基础/0-README.md</span>)</span>
  <span class="token list punctuation">*</span> <span class="token url">[<span class="token content">00-编程语言</span>](<span class="token url">03-JavaScript基础/00-编程语言.md</span>)</span>
  <span class="token list punctuation">*</span> <span class="token url">[<span class="token content">01-JS简介</span>](<span class="token url">03-JavaScript基础/01-JS简介.md</span>)</span>
  <span class="token list punctuation">*</span> <span class="token url">[<span class="token content">02-变量</span>](<span class="token url">03-JavaScript基础/02-变量.md</span>)</span>
  <span class="token list punctuation">*</span> <span class="token url">[<span class="token content">03-变量的数据类型：基本数据类型和引用数据类型</span>](<span class="token url">03-JavaScript基础/03-变量的数据类型：基本数据类型和引用数据类型.md</span>)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>制作成的目录，将会是下面这种效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0220211102223613.jpeg" alt="img"></p>
<h3 id="步骤-4：导出电子书">步骤 4：导出电子书</h3>
<p>（1）本地预览电子书：</p>
<p>执行上方命令后，工具会对项目里的 Markdown 格式的文件进行转换，默认转换为 html 格式，最后提示 <code>Serving book on http://localhost:4000</code>。</p>
<p>我们打开浏览器输入<code>http://localhost:4000</code>，预览一下电子书的效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0220211102223620.jpeg" alt="img"></p>
<p>（2）制作并导出电子书。<strong>接下来就是见证奇迹的时刻</strong>。</p>
<p>生成 PDF 格式的电子书：（PDF 是最常见的文档格式）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitbook pdf ./ ./mybook.pdf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>生成 epub 格式的电子书：（epub 是最常见、最通用的电子书格式）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitbook epub ./ ./mybook.epub<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>生成 mobi 格式的电子书：（mobi 格式可以在 kindle 中打开）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gitbook mobi ./ ./mybook.mobi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>上面这三种格式的电子书生成之后，项目里会看到这三个新增的文件：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0220211102223652.jpeg" alt="img"></p>
<p>我们把电子书打开，验收一下成果。</p>
<p>打开 pdf 电子书看看效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0220211102223700.jpeg" alt="img"></p>
<p>打开 epub 电子书看看效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0220211102223622.jpeg" alt="img"></p>
<p>怎么样，自制电子书就这样做好了，是不是很有成就感？</p>
<blockquote>
<p>更详细参考教程： <a target="_blank" rel="noopener" href="https://blog.17lai.fun/posts/7fe86002/">GitBook+GitLab撰写发布技术文档-Part1:GitBook篇</a></p>
</blockquote>
<h2 id="制作电子书的高级配置">制作电子书的高级配置</h2>
<p>电子书做好之后，我猜你肯定想进一步做<strong>个性化配置</strong>，比如：怎么加封面？怎么修改页眉页脚？还有其他的一些配置。</p>
<p>我们来看看亲手制作的电子书，有哪些常见的高级配置。</p>
<h3 id="制作书籍封面">制作书籍封面</h3>
<p>为了让书籍显示得更加优雅，我们可以指定一个自定义的封面。操作如下：</p>
<p>在项目的根目录下准备好 <code>cover.jpg</code> （大封面）和 <code>cover_small.jpg</code> （小封面）这两种封面图片。注意，图片的文件名和后缀名必须严格按照这句话来。</p>
<p>GitBook 的官方文档建议： <code>cover.jpg</code> （大封面）的尺寸为 1800x2360 像素，<code>cover_small.jpg</code>（小封面）的尺寸为 200x262 像素。图片的制作，建议遵循如下规范：</p>
<ul>
<li>没有边框</li>
<li>清晰可见的书本标题</li>
<li>任何重要的文字在小封面中应该清晰可见</li>
</ul>
<h3 id="book-json-：电子书的各种配置">book.json ：电子书的各种配置</h3>
<p>我们可以在项目的根目录下新建一个文件<code>book.json</code>（注意，文件名是<code>book</code>，后缀名是<code>json</code>），这个<code>book.json</code>就是电子书的配置文件，可以在里面填一些常见的配置。</p>
<p>关于 book.json 的配置项有很多，我们可以在网上搜索“GitBook book.json”找到。这里大致列举一些。</p>
<p>1、<strong>常规配置</strong>如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0220211102223624.jpeg" alt="img"></p>
<p>配置 book.json 的示例如下：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"前端入门和进阶图文教程"</span><span class="token punctuation">,</span>
    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"前端入门到进阶图文教程，超详细的Web前端学习笔记。从零开始学前端，做一名精致优雅的前端工程师。公众号「千古壹号」作者。"</span><span class="token punctuation">,</span>
    <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">"千古壹号"</span><span class="token punctuation">,</span>
    <span class="token property">"language"</span><span class="token operator">:</span> <span class="token string">"zh-hans"</span><span class="token punctuation">,</span>
    <span class="token property">"gitbook"</span><span class="token operator">:</span> <span class="token string">"3.2.3"</span><span class="token punctuation">,</span>
    <span class="token property">"root"</span><span class="token operator">:</span> <span class="token string">"."</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>备注：上面的<code>root</code>根目录为当前目录，使用默认的就好，此项可以删掉，这里仅做演示。</p>
<p>2、<strong>pdf</strong> 的配置如下：（使用 <code>book.json</code> 中的一组选项来定制 PDF 输出）</p>
<p>| 配置项 | 描述 | | ----------------- | ------------------------------------------------------------ | | pdf.pageNumbers | 将页码添加到每个页面的底部（默认为 true） | | pdf.fontSize | 基本字体大小（默认是 12） | | pdf.fontFamily | 基本字体样式（默认是 Arial） | | pdf.paperSize | 页面尺寸，选项有： a0、a1、 a2、 a3、a4、a5、a6、b0、b1、b2、b3、b4、b5、b6、legal、letter （默认值是 a4） | | pdf.margin.top | 上边距（默认值是 56） | | pdf.margin.bottom | 下边距（默认值是 56） | | pdf.margin.left | 左边距（默认值是 62） | | pdf.margin.right | 右边距（默认值是 62） |</p>
<p>定制 PDF 文档输出格式的示例代码如下：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"pdf"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"pageNumbers"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">"fontSize"</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
        <span class="token property">"paperSize"</span><span class="token operator">:</span> <span class="token string">"a4"</span><span class="token punctuation">,</span>
        <span class="token property">"margin"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"top"</span><span class="token operator">:</span> <span class="token number">36</span><span class="token punctuation">,</span>
            <span class="token property">"bottom"</span><span class="token operator">:</span> <span class="token number">36</span><span class="token punctuation">,</span>
            <span class="token property">"left"</span><span class="token operator">:</span> <span class="token number">62</span><span class="token punctuation">,</span>
            <span class="token property">"right"</span><span class="token operator">:</span> <span class="token number">62</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>备注：如果你不需要对输出的 pdf 做任何特定的配置，则不需要添加上面的内容，让 pdf 的输出格式保持默认就好。</p>
<p>3、<strong>plugins</strong> 插件：</p>
<p>插件及其配置在 <code>book.json</code> 中指定，让电子书的配置能力更加强大。</p>
<p>通过插件，我们可以做很多事情，比如：修改页眉页脚、自动生成并显示图片的标题等。</p>
<p>另外，针对<strong>在线版</strong>的GitBook电子书，也有很多插件，这里列举几个：</p>
<ul>
<li>自带的search插件不支持中文搜索，使用起来非常不方便，还好<code>search-pro</code>插件横空出世，让搜索功能焕发出新的生机。插件地址：https://github.com/gitbook-plugins/gitbook-plugin-search-pro</li>
<li>默认侧边栏宽度是不能够调节的，如果想通过拖拽的方式自由调节侧边栏宽度，可以使用插件<code>splitter</code>。插件地址：https://github.com/yoshidax/gitbook-plugin-splitter</li>
<li>donate插件支持定义和显示支付宝和微信打赏。插件地址：<a target="_blank" rel="noopener" href="https://github.com/willin/gitbook-plugin-donate">http://github.com/willin/gitbook-plugin-donate</a></li>
</ul>
<p>关于插件的具体配置，感兴趣的同学可以自行研究下。</p>
<h3 id="自动生成目录（重要）">自动生成目录（重要）</h3>
<p>如果你的电子书素材里有很多 markdown 文件，那么，如何将多个 markdown 文件的文件名，在<code>SUMMARY.md</code>里快速生成对应的目录？</p>
<p>难道要一个一个地手动 copy 吗？这不可能。</p>
<p>说白了，这个需求就是：<strong>如何自动生成电子书的目录</strong>？改变世界的程序员用「脚本」就能搞定，一键执行。</p>
<p>网上有很多好用的脚本，我给你推荐一个亲测好用的脚本：</p>
<blockquote>
<p>GitBook 自动生成目录的脚本：https://github.com/fushenghua/gitbook-plugin-summary</p>
</blockquote>
<p>操作方法很简单，把上面这个链接中的项目下载下来，进入到这个项目的目录，执行 <code>$ python gitbook-plugin-summary.py dirPath</code> 即可自动生成电子书的目录，亲测有效。备注：这里的<code>dirPath</code>指的是你的电子书目录的绝对路径。</p>
<p>对了，在执行上面这个脚本之前，记得先安装 <code>Python</code> 环境。</p>
<h2 id="电子书用什么软件打开">电子书用什么软件打开</h2>
<h3 id="用什么软件打开-PDF">用什么软件打开 PDF</h3>
<p>Windows 平台：可以用「福昕阅读器」或者「Acrobat Reader DC」。「福昕阅读器」既有 Windows 平台，也有 Mac 平台。</p>
<p>Mac 平台：可以用自带的「预览」打开。</p>
<p>其实，不管你用的是 Windows 电脑还是 Mac 电脑，你都可以用 Chrome 浏览器打开 PDF。</p>
<p>iPhone 或 iPad平台：可以用自带的「iBooks」打开，或者用「WPS Office」打开。也可以用第三方软件「GoodReader」，不过需要 40 人民币。</p>
<p>Android 手机：可以用「WPS Office」等第三方办公软件打开。</p>
<h3 id="用什么软件阅读-ePub-电子书">用什么软件阅读 ePub 电子书</h3>
<p>Windows 平台：可以用「calibre」软件阅读 epub 电子书。</p>
<p>Mac &amp; iPhone &amp; iPad 平台：用自带的「iBooks」阅读即可。iBooks 可以非常方便地对电子书进行标注和搜索，无疑是体验最好的 ePub 电子书阅读软件。</p>
<p>Android 手机：可以用「多看阅读」App 来阅读 epub 格式电子书。</p>
<h3 id="用什么方式阅读-mobi-电子书">用什么方式阅读 mobi 电子书</h3>
<p>kindle 电子书有两种常见的电子书格式：「mobi」格式和「azw3」格式。</p>
<ul>
<li>针对 mobi 格式的电子书，你既可以通过邮件的形式将其发送到 kindle 阅读器（可以自行网上查一下相关教程），也可以将其拷贝到 kindle 阅读器（是连接 usb 进行拷贝）。</li>
<li>针对 azw3 格式的电子书，就只能通过拷贝的形式（是连接 usb 拷贝）传输到 kindle 阅读器。</li>
</ul>
<h3 id="小结">小结</h3>
<p>我在 2017 年 1 月写过一篇电子书科普的文章，快三年过去了，如今回过头来看，那篇文章一点也不过时，不妨看看：《<a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/-FsT_GQtBQ0-q_ndO5X6sQ">电子书有哪些常见格式？以及该怎样阅读它</a>》</p>
<h2 id="最后一段-2">最后一段</h2>
<p>如果你一时半会儿找不到可用的素材来制作电子书，可以拿我的项目练练手。项目地址：</p>
<blockquote>
<p>https://github.com/qianguyihao/web</p>
</blockquote>
<p>不瞒你说，这篇文章，我在一年多以前就写好了初稿并放在了 GitHub 上，当时专门折腾过一次。</p>
<p>最近几天，我突然又有了制作电子书的需求。一年多过去了，我还以为有啥新的方法可以试试，然而我在网上找了一圈，好用的方法还是没变。所以，我今天整理一下发出来，希望让更多人看到。</p>
<p>其他的各种自制电子书的方法我都试过了，都不太好使，唯独 <strong>GitBook + calibre</strong> 是最佳选择，信我没错！</p>
<h2 id="参考链接-2">参考链接</h2>
<ul>
<li>GITBOOK 使用：https://kuang.netlify.app/blog/gitbook.htmlbook.html</li>
<li>GitBook 制作 Kindle 电子书详细教程：https://github.com/fushenghua/gitbook-plugin-summary/blob/master/gitbook-guide.md</li>
<li>gitbook-plugin-summary 工具（自动生成目录）：https://github.com/fushenghua/gitbook-plugin-summary</li>
<li>gitbook-plugin-atoc（自动生成目录的插件）：https://github.com/willin/gitbook-plugin-atoc</li>
<li>自动生成目录：https://github.com/mofhu/GitBook-auto-summary</li>
<li>使用 Gitbook 打造你的电子书：https://juejin.im/post/6844903793033740302</li>
<li>书籍《了不起的 Markdown》的第 8 章：自由地写作——GitBook</li>
<li>gitbook 的 book.json 配置示例：https://blog.ujwd.cn/archives/349</li>
<li>关于更加详细的 book.json 文件配置：https://zhousiwei.gitee.io/mybook/notes/gitbook_config.html</li>
<li>GitBook 简明使用教程：https://www.phpjieshuo.com/archives/153/</li>
<li>gitbook 入门教程之导出电子书：https://juejin.im/post/5caa0fb46fb9a05e5a2e53b3</li>
<li>GitBook 插件整理 - book.json 配置：https://www.cnblogs.com/mingyue5826/p/10307051.html</li>
<li>如何把 Markdown 文件批量转换为 PDF（不好用）：https://sspai.com/post/47110</li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/245763905">自己动手制作电子书的最佳方式</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>gitbook</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>gitbook</tag>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>私人在线音乐服务器搭建与使用介绍</title>
    <url>/posts/2b9325d0/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p><strong>多种音乐播放实现方式</strong></p>
<ol>
<li>页面内插入音乐列表。Aplayer实现</li>
<li>单独页面音乐列表。Aplayer实现</li>
<li>音乐Docker。在线云音乐</li>
</ol>
<blockquote>
<ul>
<li>原作者DMCA原因不再维护，如果你想自己部署，需要修改原作者docker内部代码。</li>
</ul>
</blockquote>
<ol>
<li>音乐Docker <a target="_blank" rel="noopener" href="https://github.com/linuxserver/docker-mstream">Mstream docker</a>。</li>
<li>音乐Docker <a target="_blank" rel="noopener" href="https://hub.docker.com/r/apnar/logitech-media-server">Logitech Media Server</a>。<a target="_blank" rel="noopener" href="https://github.com/Logitech/slimserver">Github</a></li>
</ol>
<blockquote>
<ul>
<li>多用户音乐分享、播放，在线，分类等功能。</li>
</ul>
</blockquote>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0720211107003631.jpg" alt="img"></p>
<h2 id="Aplayer-在线音乐">Aplayer 在线音乐</h2>
<blockquote>
<p>博文页面内插入音乐列表</p>
</blockquote>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><div id="mmedia-scsbSGNfXTnVXyAq"></div><script> var scsbSGNfXTnVXyAq_options = JSON.parse('{\"lrcType\":3,\"volume\":0.66,\"audio\":[{\"name\":\"Hotel California\",\"artist\":\"Camille and Kennerly\",\"url\":\"https://cdn.17lai.site/media/music/Hotel%20California/01%20Hotel%20California.mp3\",\"lrc\":\"https://cdn.17lai.site/media/music/Hotel%20California/01%20Hotel%20California.lrc\",\"cover\":\"https://cdn.17lai.site/media/music/Hotel%20California/Hotel%20California.webp\"}]}'); scsbSGNfXTnVXyAq_options.container = document.getElementById("mmedia-scsbSGNfXTnVXyAq"); const ap_scsbSGNfXTnVXyAq = new APlayer(scsbSGNfXTnVXyAq_options); </script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><div id="mmedia-aKEImjDcuxIQxHdM"></div><script> var aKEImjDcuxIQxHdM_options = JSON.parse('{\"lrcType\":3,\"volume\":0.8,\"autoplay\":false,\"audio\":[{\"name\":\"Hotel California\",\"artist\":\"Camille and Kennerly\",\"url\":\"https://cdn.17lai.site/media/music/Hotel%20California/01%20Hotel%20California.mp3\",\"cover\":\"https://cdn.17lai.site/media/music/Hotel%20California/Hotel%20California.webp\",\"lrc\":\"https://cdn.17lai.site/media/music/Hotel%20California/01%20Hotel%20California.lrc\",\"theme\":\"#ebd0c2\"},{\"name\":\"Sold Out\",\"artist\":\"Diamonds\",\"url\":\"https://cdn.17lai.site/media/music/Diamonds/05%20Sold%20Out.flac\",\"cover\":\"https://cdn.17lai.site/media/music/Diamonds/Diamonds.jpg\",\"theme\":\"#ebd0c2\"},{\"name\":\"The Final Bell\",\"artist\":\"Rocky_ Original Motion Picture Score\",\"url\":\"https://cdn.17lai.site/media/music/Rocky_%20Original%20Motion%20Picture%20Score/12%20Bill%20Conti%20-%20The%20Final%20Bell.mp3\",\"cover\":\"https://cdn.17lai.site/media/music/Rocky_%20Original%20Motion%20Picture%20Score/Rocky_%20Original%20Motion%20Picture%20Score.jpg\",\"theme\":\"#ebd0c2\"},{\"name\":\" Croatian Rhapsody\",\"artist\":\"The Piano Player\",\"url\":\"https://cdn.17lai.site/media/music/The%20Piano%20Player/11%20Croatian%20Rhapsody.mp3\",\"cover\":\"https://cdn.17lai.site/media/music/The%20Piano%20Player/The%20Piano%20Player.jpg\",\"theme\":\"#ebd0c2\"}]}'); aKEImjDcuxIQxHdM_options.container = document.getElementById("mmedia-aKEImjDcuxIQxHdM"); const ap_aKEImjDcuxIQxHdM = new APlayer(aKEImjDcuxIQxHdM_options); </script>
<h2 id="单独Aplayer音乐页面">单独Aplayer音乐页面</h2>
<blockquote>
<p><strong>直接戳这里 -&gt;</strong> <a href="https://blog.17lai.site/musics/">Musics</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0720211107002935.jpg" alt="img"></p>
<h2 id="在线云音乐">在线云音乐</h2>
<p>私人云音乐</p>
<div class="admonition note"><p class="admonition-title">研究学习使用
</p><p>不对外公开发布，研究学习用。</p>
</div>
<p>用户名密码base64编码</p>
<pre class="line-numbers language-base64" data-language="base64"><code class="language-base64">55So5oi35ZCN5a+G56CB6YO95pivMTdsYWk=<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>base64解密: <a target="_blank" rel="noopener" href="http://encode.chahuo.com/">在线加密解密</a></p>
<p><a target="_blank" rel="noopener" href="https://musicplayer.17lai.site/"><strong>入口</strong></a></p>
<blockquote>
<ul>
<li>公开在线云音乐服务网页版。</li>
<li>可以与网易云音乐UID同步！</li>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/r/oldiy/music-player-docker">DockerHub</a></li>
</ul>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/0920211009174442.png" alt="在线云音乐入口"></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/1220211012022352.png" alt="播放界面"></p>
<p>与网易云同步</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/0920211009174557.png" alt=""></p>
<p>网易云UID在登陆 https://music.163.com/ 后 点击右上角图标的我的主页 https://music.163.com/#/user/home?id=617xxxxx0</p>
<p>home?id= 后面的数字就是你的UID。登录后，可以同步个人列表！</p>
<h2 id="私人音乐服务器">私人音乐服务器</h2>
<p><a target="_blank" rel="noopener" href="https://music.17lai.site/"><strong>入口</strong></a></p>
<blockquote>
<ul>
<li>所有音乐作者，专辑，演唱者元数据刮削。</li>
<li>rclone挂载webdav网盘存储音乐文件。</li>
<li>cloudflare parterner加速。</li>
<li>私人使用，不对外公开。</li>
</ul>
</blockquote>
<h2 id="在线音乐播放">在线音乐播放</h2>
<blockquote>
<ul>
<li>SelfHost 支持。Docker 部署！</li>
<li>Github: <a target="_blank" rel="noopener" href="https://github.com/linuxserver/docker-mstream">Mstream docker</a>。</li>
<li>浏览器界面支持。</li>
</ul>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/0620211006015739.png" alt="私人音乐服务"></p>
<h3 id="支持DJ模式">支持DJ模式</h3>
<blockquote>
<ul>
<li>在音乐库中随机选择音乐播放。</li>
<li>选择症患者救星。</li>
</ul>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/0620211006020713.png" alt="DJ模式"></p>
<h3 id="Android支持">Android支持</h3>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/10/0620211006020403.png" alt="Android支持"></p>
<h3 id="其它特性">其它特性</h3>
<blockquote>
<ul>
<li>转码支持</li>
<li>遥控器支持</li>
<li>播放列表</li>
<li>等等</li>
</ul>
</blockquote>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>music</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>music</tag>
        <tag>mstream</tag>
        <tag>selfhost</tag>
      </tags>
  </entry>
  <entry>
    <title>音乐推荐-曾经我也想过一了百了</title>
    <url>/posts/8b7d3a9a/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="现场MV-2">现场MV</h2>
<style>.bbplayer{width: 100%; max-width: 850px; margin: auto}</style><div class="bbplayer"><iframe class="bbplayer" id="mmedia-JJUZLSFdscHJJwQr" src="https://player.bilibili.com/player.html?bvid=BV1b64y1d7pw&amp;page=1&amp;high_quality=1&amp;danmaku=true" allowfullscreen="allowfullscreen" scrolling="no" border="0" frameborder="0" framespacing="0" sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts allow-popups"></iframe></div><script> document.getElementById("mmedia-JJUZLSFdscHJJwQr").style.height=document.getElementById("mmedia-JJUZLSFdscHJJwQr").scrollWidth*0.76+"px";
    window.onresize = function(){
      document.getElementById("mmedia-JJUZLSFdscHJJwQr").style.height=document.getElementById("mmedia-JJUZLSFdscHJJwQr").scrollWidth*0.76+"px";
    }; </script>
<h2 id="背景介绍">背景介绍</h2>
<p>《曾经我也想过一了百了》是日本歌手中岛美嘉演唱的歌曲，由秋田弘填词和谱曲、出羽良彰编曲，于2013年8月28日发行，收录在中岛美嘉个人专辑《TOUGH 为爱勇敢》中。该歌曲勾勒出向死而生、努力活着的人，让人感到温暖和希望，让因为压力迷茫无助而有轻生想法的人，开始积极拥抱生活。 《曾经我也想过一了百了》由日本摇滚乐队amazarashi的主唱秋田弘创作，创作理念为“为了描写浓烈的希望，必须先描写深层的黑暗”。2010年，迎来出道十周年的中岛美嘉宣布自己因耳咽管开放症暂停一切音乐活动。在疾病的影响下，歌唱对她而言变得无比艰难。2011年，她携单曲《Dear》复出，但复出后始终经历着状态的起伏和媒体的质疑。 中岛美嘉起先向amazarashi提出合作请求，希望乐队能为自己创作一首节奏明快的歌曲，但随后秋田弘向她播放了乐队一首未发行的样本歌曲，并认为该曲很适合由她来演唱。收到该曲时，中岛美嘉起先感到十分惊讶，但听到最后泪流不止，感到自己的心变得柔和，便立即要求演唱该曲。录制过程中，中岛美嘉将自己的心声融入到了该曲中，希望能将力量传达给低迷苦闷的听众。</p>
<pre class="line-numbers language-lrc" data-language="lrc"><code class="language-lrc">[00:00.10]僕が死のうと思ったのは (曾经我也想过一了百了) - 中島美嘉 (なかしま みか)
[00:00.20]词：秋田ひろむ
[00:00.30]曲：秋田ひろむ
[00:00.40]编曲：出羽良彰
[00:27.95]僕が死のうと思ったのは
[00:33.83]ウミネコが桟橋で鳴いたから
[00:39.20]波の随意に浮かんで消える
[00:45.33]過去も啄ばんで飛んでいけ
[00:50.70]僕が死のうと思ったのは
[00:56.52]誕生日に杏の花が咲いたから
[01:02.22]その木漏れ日でうたた寝したら
[01:08.09]虫の死骸と土になれるかな
[01:14.09]薄荷飴 漁港の灯台
[01:17.05]錆びたアーチ橋 捨てた自転車
[01:19.74]木造の駅のストーブの前で
[01:22.74]どこにも旅立てない心
[01:25.61]今日はまるで昨日みたいだ
[01:28.30]明日を変えるなら今日を変えなきゃ
[01:31.56]分かってる 分かってる けれど
[01:39.71]僕が死のうと思ったのは
[01:44.89]心が空っぽになったから
[01:50.71]満たされないと泣いているのは
[01:56.39]きっと満たされたいと願うから
[02:25.49]僕が死のうと思ったのは
[02:30.69]靴紐が解けたから
[02:36.57]結びなおすのは苦手なんだよ
[02:42.25]人との繋がりもまた然り
[02:47.90]僕が死のうと思ったのは
[02:53.65]少年が僕を見つめていたから
[02:59.30]ベッドの上で土下座してるよ
[03:05.12]あの日の僕にごめんなさいと
[03:11.43]パソコンの薄明かり
[03:14.05]上階の部屋の生活音
[03:16.80]インターフォンのチャイムの音
[03:19.80]耳を塞ぐ鳥かごの少年
[03:22.87]見えない敵と戦ってる
[03:25.43]六畳一間のドンキホーテ
[03:28.30]ゴールはどうせ醜いものさ
[03:36.74]僕が死のうと思ったのは
[03:42.05]冷たい人と言われたから
[03:47.94]愛されたいと泣いているのは
[03:53.63]人の温もりを知ってしまったから
[04:22.79]僕が死のうと思ったのは
[04:27.91]あなたが綺麗に笑うから
[04:33.49]死ぬことばかり考えてしまうのは
[04:39.62]きっと生きる事に真面目すぎるから
[04:45.43]僕が死のうと思ったのは
[04:50.70]まだあなたに出会ってなかったから
[04:56.51]あなたのような人が生まれた
[05:02.09]世界を少し好きになったよ
[05:07.96]あなたのような人が生きてる
[05:13.65]世界に少し期待するよ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="中文翻唱">中文翻唱</h2>

        <div id="aplayer-pARwhYaz" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;"></div>
			  <script>
				  var options = {"narrow":false,"autoplay":false,"showlrc":3,"mode":"random","mutex":true,"theme":"#e6d0b2","preload":"metadata","listmaxheight":"513px","music":[{"title":"曾经我也想过一了百了","author":"一么","url":"https://cdn.17lai.site/media/music/僕が死のうと思ったのは/曾经我也想过一了百了-一么.mp3","pic":"https://cdn.17lai.site/media/music/僕が死のうと思ったのは/僕が死のうと思ったのは.jpg","lrc":"https://cdn.17lai.site/media/music/僕が死のうと思ったのは/曾经我也想过一了百了-一么.lrc"},{"title":"僕が死のうと思ったのは","author":"中岛美嘉","url":"https://cdn.17lai.site/media/music/僕が死のうと思ったのは/01%20僕が死のうと思ったのは.mp3","pic":"https://cdn.17lai.site/media/music/僕が死のうと思ったのは/僕が死のうと思ったのは.jpg","lrc":"https://cdn.17lai.site/media/music/僕が死のうと思ったのは/01%20僕が死のうと思ったのは.lrc"}]};
				  options.element = document.getElementById("aplayer-pARwhYaz");
				  var ap = new APlayer(options);
			    window.aplayers || (window.aplayers = []);
				  window.aplayers.push(ap);
			  </script>
<pre class="line-numbers language-none"><code class="language-none">[00:02.09]作曲 : 秋田 ひろむ
[00:02.64]曾经我也想过一了百了
[00:03.21]原唱：中岛美嘉
[00:04.46] 
[00:29.85]曾经我 也想过 一了百了
[00:34.79]因为看见蜷缩的猫
[00:37.40]在码头望着远方
[00:40.40]海浪拍打在岸上
[00:43.44]一阵又一阵侵踏
[00:46.22]希望那些过往都消失
[00:49.38]不再回望
[00:52.43]曾经我 也想过
[00:54.82]一了百了
[00:57.46]是因为生日的那天
[01:00.10]杏花 又开放
[01:03.75]阳光灿烂树荫下
[01:06.41]落花已沉睡安详
[01:09.84]是否我也 能化作尘土
[01:12.16]不再流浪
[01:15.76]仍放抽屉里过期的糖
[01:18.28]迷路的单车被留在回家路上
[01:21.27]还有海边抛弃的避风港
[01:23.88]全都提醒 我和他们一样
[01:26.75]昨天和今天的画面不断浮现
[01:29.74]明天 渴望能不能有
[01:31.54]新的改变
[01:32.90]不能沮丧 我知道啊
[01:35.55]可是啊
[01:40.88]曾经我 也想过 一了百了
[01:46.24]身边一切都像在问我
[01:49.19]过得好不好
[01:52.28]泪不能停止的流
[01:55.05]流进心底的荒漠
[01:58.28]这颗心中的模样
[02:00.17]早空如一具躯壳
[02:26.84]曾经我 也想过 一了百了
[02:32.71]因为我的存在
[02:34.23]总让别人失望
[02:37.98]不曾拥有就不怕
[02:40.80]关于人与人的伤
[02:44.18]这么简单的道理
[02:45.96]我也只会搞砸
[02:49.80]曾经我 也想过 一了百了
[02:55.49]是因为墙上
[02:56.52]那张骄傲的自画像
[03:00.96]无力反驳地跪下
[03:03.66]只说的出一句话
[03:06.99]生而为人的我
[03:08.61]真的对不起呀
[03:12.75]房间里闪烁着荧幕微光
[03:15.56]伴随着屋外夜色的声音嘈杂
[03:18.43]电话那头传来窒息的话
[03:21.28]刺痛在笼中
[03:22.44]备受折磨的时间啊
[03:24.25]黑暗中我装备
[03:25.58]唐吉轲德的毅力
[03:26.89]对抗看不见的敌人
[03:28.38]摧毁我的决心
[03:29.85]不要害怕我知道啊可是啊
[03:38.04]曾经我也想过一了百了
[03:44.29]为何人们都说我无可救药
[03:49.69]不强求能明白我
[03:52.60]不奢望时间倒流
[03:55.70]因为很久很久以前我曾爱过
[04:00.86]曾经我 也想过 一了百了
[04:06.89]是因为我该那样
[04:08.43]灿烂那样美好
[04:12.49]一味消极着过去
[04:14.95]离去的念头缠绕
[04:17.29]闭上眼能感受到
[04:20.04]更好的明天来到
[04:24.35]茫茫人海中的你
[04:27.01]泪光中微笑的你
[04:30.26]在我耳边温柔唱起这首歌曲<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>PS: 数据丢失了一回，折腾了很长时间才重新补回来。</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>music</category>
      </categories>
      <tags>
        <tag>music</tag>
        <tag>中岛美嘉</tag>
      </tags>
  </entry>
  <entry>
    <title>node 项目从构建到使用 jenkins + docker + nginx + mysql + redis 自动化部署</title>
    <url>/posts/68d3867d/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1>概述</h1>
<p>这都2019年末了，你还不会 docker吗？ 你 low 爆了，我们作为一枚前端，不能说是要精通使用 docker 完成各种事情，但我觉得必须要学会使用 docker 干下面几件事：</p>
<ol>
<li>部署前端应用</li>
<li>部署nginx</li>
<li>使用docker-compose部署</li>
<li>在容器之间建立联系</li>
</ol>
<p>Docker 可理解为跑在宿主机上的非常精简、小巧、高度浓缩的虚拟机。 它可以将容器里的进程安稳的在宿主机上运行，之前我也有写过一些关于docker的文章，在这我就不做过多的介绍了，如有需要请自行查看我之前的文章即可，接下来我们通过项目来了解并使用 docker</p>
<h1>Egg.js ？</h1>
<p>在这里我使用 <code>egg.js</code> 来为大家实操一下项目的部署流程。有人会问 <code>egg.js</code> 是什么？ 我只能回答这是一款专业级的 <code>node</code> 框架。作为一个有梦想的前端，我们有必要去学习一种后端语言，而作为前端 <code>node</code> 的学习成本相对来说比较低的。 <code>egg.js</code> 这个框架在 node 现有框架中也是比较优秀的，如有需要，大家可以自行学习，我们今天的学习主要还是项目的部署流程，在这我就不给大家做过多的介绍。如有需要，请查阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Feggjs.org%2Fzh-cn%2Fintro%2Findex.html" title="https://eggjs.org/zh-cn/intro/index.html">官方文档</a></p>
<h1>开始前的准备</h1>
<blockquote>
<p>docker 与 docker-compose 的安装我就不给大家介绍了。在之前的文章中是有的，也比较详细，作为一位开发人员，我认为这点事情难不倒大家</p>
</blockquote>
<h2 id="初始化项目">初始化项目</h2>
<pre class="line-numbers language-none"><code class="language-none">$ mkdir egg-example &amp;&amp; cd egg-example
$ npm init egg --type=simple
$ npm i
复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="创建需要的文件">创建需要的文件</h2>
<p>我们需要在项目根目录创建我们所需要的文件</p>
<pre class="line-numbers language-none"><code class="language-none">$ touch Dockerfile
$ touch docker-compose.yml
$ setup.sh
复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="目录结构-2">目录结构</h2>
<pre class="line-numbers language-none"><code class="language-none">egg-project
├── package.json
├── setup.sh (新建)
├── Dockerfile (新建)
├── docker-compose.yml (新建)
├── app
|   ├── router.js
│   ├── controller
│   |   └── home.js
│   ├── service (可选)
│   |   └── user.js
│   ├── middleware (可选)
│   |   └── response_time.js
│   ├── schedule (可选)
│   |   └── my_task.js

...

复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="常用指令">常用指令</h2>
<p>在开始之前我们要学习下常用的一些指令，看下方：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110127.webp" alt=""></p>
<h1>了解流程</h1>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110133.webp" alt=""></p>
<h1>安装 jenkins</h1>
<p>在安装jenkins我选择了使用docker-compose<br>
docker-compose 是一个用来把 docker 自动化的东西<br>
有了 docker-compose 你可以把所有繁复的 docker 操作全都一条命令，自动化的完成。</p>
<h2 id="首先我们需要在服务器上创建一个目录机构-具体结构个人自行创建">首先我们需要在服务器上创建一个目录机构 (具体结构个人自行创建)</h2>
<pre class="line-numbers language-none"><code class="language-none">/home/jenkins
     - docker-compose.yml
     - jenkins-home
复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="接下来我们来编写-docker-compose-yml-安装jenkins">接下来我们来编写 docker-compose.yml 安装jenkins</h2>
<pre class="line-numbers language-none"><code class="language-none">version: '3'                                    # 指定 docker-compose.yml 文件的写法格式
services:                                       # 多个容器集合
  docker_jenkins: 
    user: root                                  # 为了避免一些权限问题 在这我使用了root
    restart: always                             # 重启方式
    image: jenkins/jenkins:lts                  # 指定服务所使用的镜像 在这里我选择了 LTS (长期支持)
    container_name: jenkins                     # 容器名称
    ports:                                      # 对外暴露的端口定义
      - '8080:8080'
      - '50000:50000'
    volumes:                                    # 卷挂载路径
      - /home/jenkins/jenkins_home/:/var/jenkins_home   # 这是我们一开始创建的目录挂载到容器内的jenkins_home目录
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker                 # 这是为了我们可以在容器内使用docker命令
      - /usr/local/bin/docker-compose:/usr/local/bin/docker-compose     # 同样的这是为了使用docker-compose命令
复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们需要进入到 jenkins 目录下执行：</p>
<pre class="line-numbers language-none"><code class="language-none">$ docker-compose up -d
复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="配置-2">配置</h2>
<p>不出意外你现在可以打开你的服务器地址 <a href="https://link.juejin.cn?target=http%3A%2F%2Fxxxxxxx" title="http://xxxxxxx">http://xxxxxxx</a>:端口号 就能看到这个界面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110139.webp" alt=""></p>
<p>打开你所创建的jenkins目录进入到jenkins-home<br>
/home/jenkins/jenkins-home</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110148.webp" alt=""></p>
<p>进入 secrets 目录</p>
<pre class="line-numbers language-none"><code class="language-none">$ cat initialAdminPassword
复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110209.webp" alt=""></p>
<p>然后把里面的文本复制出来填到管理员密码中</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110327.webp" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110215.webp" alt=""></p>
<p>接下来需要安装两个插件</p>
<pre class="line-numbers language-none"><code class="language-none">NodeJS Plugin
Publish Over SSH
复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110334.webp" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110221.webp" alt=""></p>
<p>然后我们滑到最下方</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110228.webp" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110341.webp" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110347.webp" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110235.webp" alt=""></p>
<h1>开始我们的操作</h1>
<h2 id="Dockerfile">Dockerfile</h2>
<p>我们在开始阶段的时候学过一些常用指令，大家应该一眼就可以看得懂这些命令。 加油！！</p>
<pre class="line-numbers language-none"><code class="language-none">FROM node:10.0-alpine             # 镜像版本

# 设置时区
RUN apk --update add tzdata \
    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
    &amp;&amp; echo "Asia/Shanghai" &gt; /etc/timezone \
    &amp;&amp; apk del tzdata

# 创建app目录
RUN mkdir -p /usr/src/node-app/egg-santak

# 设置工作目录
WORKDIR /usr/src/node-app/egg-santak

# 拷贝package.json文件到工作目录
# !!重要：package.json需要单独添加。
# Docker在构建镜像的时候，是一层一层构建的，仅当这一层有变化时，重新构建对应的层。
# 如果package.json和源代码一起添加到镜像，则每次修改源码都需要重新安装npm模块，这样木有必要。
# 所以，正确的顺序是: 添加package.json；安装npm模块；添加源代码。
COPY package.json /usr/src/node-app/egg-santak/package.json

# 安装npm依赖(使用淘宝的镜像源)
# 如果使用的境外服务器，无需使用淘宝的镜像源，即改为`RUN npm i`。
RUN npm i --registry=https://registry.npm.taobao.org

# 拷贝所有源代码到工作目录
COPY . /usr/src/node-app/egg-santak

# 暴露容器端口
EXPOSE 7001

# 启动node应用
CMD npm start
复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="在服务器中创建我们所需要挂载的数据卷">在服务器中创建我们所需要挂载的数据卷</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110241.webp" alt=""></p>
<pre class="line-numbers language-none"><code class="language-none"># nginx
$ mkdir -p nginx/conf.d nginx/logs

# mysql
$ mkdir mysql

# redis
$ mkdir redis
复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后进入 <code>nginx/conf.d</code> 文件夹中 创建一个后缀为 <code>conf</code> 的文件</p>
<pre class="line-numbers language-none"><code class="language-none">$ cd nginx/conf.d
$ touch default.conf
$ vim default.conf
复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>写入以下内容：</p>
<pre class="line-numbers language-none"><code class="language-none">server {
  listen 80;
  listen [::]:80;
  server_tokens off;

  root /var/www/html;
  index index.html index.htm;

  # 修改为自己的域名
  server_name api.lovelp.xin;

  # 访问 / 路径时执行反向代理
  location / {
    # 这里 nodejs 是 node 容器名
    proxy_pass http://nodejs:7001;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $host;
    # 后端的Web服务器可以通过 X-Forwarded-For 获取用户真实 IP
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # 允许客户端请求的最大单文件字节数
    client_max_body_size 15M;
    # 缓冲区代理缓冲用户端请求的最大字节数
    client_body_buffer_size 128k;
  }
}
复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="docker-compose-yml">docker-compose.yml</h2>
<pre class="line-numbers language-none"><code class="language-none">version: '3'

services:
  santak_redis:
    image: redis:3                  # 指定服务镜像
    container_name: santak_redis    # 容器名称
    restart: always                 # 重启方式
    hostname: redis
    command: redis-server /usr/local/etc/redis/redis.conf --requirepass 123456  --appendonly yes
    volumes:                        # 挂载数据卷
      - /root/redis/redis.conf:/usr/local/etc/redis/redis.conf
    ports:                          # 映射端口
      - "6379:6379"     
    networks:                       # 加入指定网络
      - app-network

  santak_nginx:
    image: nginx:stable-alpine      # 指定服务镜像
    container_name: santak_nginx    # 容器名称
    restart: always                 # 重启方式
    ports:                          # 映射端口
      - "80:80"
    volumes:                        # 挂载数据卷
      - /etc/localtime:/etc/localtime
      - /root/nginx/conf.d:/etc/nginx/conf.d
      - /root/nginx/logs:/var/log/nginx
    depends_on:                     # 启动顺序
      - nodejs
    networks:                       # 加入指定网络
      - app-network

  santak_mysql:
    image: mysql:5.7
    container_name: santak_mysql
    restart: always
    ports:                          # 映射端口
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_USER=lovelp           # 创建lovelp用户
      - MYSQL_PASSWORD=mm123321     # 设置lovelp用户的密码
      - MYSQL_DATABASE=santak       # 创建初始数据库
      - TZ=Asia/Shanghai            # 设置时区
    volumes:                        # 挂载数据卷
      - /root/mysql:/var/lib/mysql  # 为了数据持久化
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:                       # 加入指定网络
      - app-network 

  nodejs:
    build:                          # 这里指的是我们刚刚撸的 Dockerfile 文件
      context: .                    
      dockerfile: Dockerfile
    image: nodejs                   # 镜像名称
    container_name: nodejs          # 容器名称
    restart: always                 # 重启方式
    depends_on:                     # 启动顺序
      - santak_redis
      - santak_mysql
    links:                          # 容器连接
      - santak_redis:santak_redis
      - santak_mysql:santak_mysql
    networks:                       # 加入指定网络
      - app-network

volumes:
  certbot-etc:
  certbot-var:

networks:  # 实现通信
  app-network:
    driver: bridge
复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="在项目中的使用">在项目中的使用</h2>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110359.webp" alt=""></p>
<h2 id="setup-sh">setup.sh</h2>
<pre class="line-numbers language-none"><code class="language-none">#!/usr/bin/env bash
#image_version=`date +%Y%m%d%H%M`;

# 关闭容器
docker-compose stop || true;
# 删除容器
docker-compose down || true;
# 构建镜像
docker-compose build;
# 启动并后台运行
docker-compose up -d;
# 查看日志
docker logs nodejs;
# 对空间进行自动清理
docker system prune -a -f

复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1>jenkins 创建项目</h1>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110247.webp" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110248.webp" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110254.webp" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110409.webp" alt=""></p>
<p>最后我们就可以愉快的 <code>Build Now</code> 了</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1120220311110415.webp" alt=""></p>
<p>在这里我选择的是手动构建。其实jenkins有很多可配置项，比如自动化构建啥的，兴趣使然，大家自行摸索，谢谢大家</p>
<h2 id="整理转载">整理转载:</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904006184091662">掘金</a></li>
</ul>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>web</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>docker</tag>
        <tag>CI/CD</tag>
        <tag>node</tag>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 Shell 脚本实现一个简单 Docker</title>
    <url>/posts/90e60aac/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>《使用 Shell 脚本实现 Docker》旨在通过一系列的实验使用户对docker的底层技术，如Namespace、CGroups、rootfs、联合加载等有一个感性的认识。在此过程中，我们还将通过Shell脚本一步一步地实现一个简易的docker，以期使读者在使用docker的过程中知其然知其所以然。</p>
</blockquote>
<p>我们的实验环境为Ubuntu 18.04 64bit，简易docker工程的名字为docker.sh，该工程仓库地址如下：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html">https://github.com/pandengyang/docker.sh.git
https://github.com/appotry/docker.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>《使用 Shell 脚本实现 Docker》目录如下：</p>
<pre class="line-numbers language-none"><code class="language-none">1. Namespace
1.1. Namespace简介
1.2. uts namespace
1.2.1. uts namespace简介
1.2.2. docker.sh
1.3. mount namespace
1.3.1. /etc/mtab、/proc/self/mounts
1.3.2. /proc/self/mountinfo
1.3.3. bind mount
1.3.4. mount namespace简介
1.3.5. docker.sh
1.4. pid namespace
1.4.1. unshare的--fork选项
1.4.2. pid namespace简介
1.4.3. pid嵌套
1.4.4. docker.sh
2. CGroups
2.1. CGroups简介
2.2. 限制内存
2.2.1. 用CGroups限制内存
2.2.2. docker.sh
3. 切换根文件系统
3.1. 根文件系统
3.2. pivot_root
3.3. docker.sh
4. 联合加载
4.1. 联合加载简介
4.2. AUFS
4.3. docker.sh
5. 卷
5.1. 卷简介
5.2. docker.sh
6. 后记<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="1-Namespace">1.Namespace</h2>
<h3 id="1-1-Namespace简介">1.1.Namespace简介</h3>
<p>传统上，在Linux中，许多资源是全局管理的。例如，系统中的所有进程按照惯例是通过PID标识的，这意味着内核必须管理一个全局的PID列表。而且，所有调用者通过uname系统调用返回的系统相关信息都是相同的。用户id的管理方式类似，即各个用户是通过一个全局唯一的UID标识。</p>
<p>Namespace是Linux用来隔离上述全局资源的一种方式。把一个或多个进程加入到同一个namespace中后，这些进程只会看到该namespace中的资源。namespace是后来加入到Linux中的，为了兼容之前的全局资源管理方式，Linux为每一种资源准备了一个全局的namespace。Linux中的每一个进程都默认加入了这些全局namespace。</p>
<p>Linux中的每个进程都有一个/proc/[pid]/ns/目录，里面包含了该进程所属的namespace信息。我们查看一下当前Shell的/proc/[pid]/ns目录，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">sudo</span> <span class="token function">ls</span> -l /proc/<span class="token variable">$$</span>/ns
total <span class="token number">0</span>
lrwxrwxrwx <span class="token number">1</span> phl phl <span class="token number">0</span> Jan <span class="token number">22</span> 08:43 cgroup -<span class="token operator">&gt;</span> cgroup:<span class="token punctuation">[</span><span class="token number">4026531835</span><span class="token punctuation">]</span>
lrwxrwxrwx <span class="token number">1</span> phl phl <span class="token number">0</span> Jan <span class="token number">22</span> 08:43 ipc -<span class="token operator">&gt;</span> ipc:<span class="token punctuation">[</span><span class="token number">4026531839</span><span class="token punctuation">]</span>
lrwxrwxrwx <span class="token number">1</span> phl phl <span class="token number">0</span> Jan <span class="token number">22</span> 08:43 mnt -<span class="token operator">&gt;</span> mnt:<span class="token punctuation">[</span><span class="token number">4026531840</span><span class="token punctuation">]</span>
lrwxrwxrwx <span class="token number">1</span> phl phl <span class="token number">0</span> Jan <span class="token number">22</span> 08:43 net -<span class="token operator">&gt;</span> net:<span class="token punctuation">[</span><span class="token number">4026531993</span><span class="token punctuation">]</span>
lrwxrwxrwx <span class="token number">1</span> phl phl <span class="token number">0</span> Jan <span class="token number">22</span> 08:43 pid -<span class="token operator">&gt;</span> pid:<span class="token punctuation">[</span><span class="token number">4026531836</span><span class="token punctuation">]</span>
lrwxrwxrwx <span class="token number">1</span> phl phl <span class="token number">0</span> Jan <span class="token number">22</span> 08:43 pid_for_children -<span class="token operator">&gt;</span> pid:<span class="token punctuation">[</span><span class="token number">4026531836</span><span class="token punctuation">]</span>
lrwxrwxrwx <span class="token number">1</span> phl phl <span class="token number">0</span> Jan <span class="token number">22</span> 08:43 user -<span class="token operator">&gt;</span> user:<span class="token punctuation">[</span><span class="token number">4026531837</span><span class="token punctuation">]</span>
lrwxrwxrwx <span class="token number">1</span> phl phl <span class="token number">0</span> Jan <span class="token number">22</span> 08:43 uts -<span class="token operator">&gt;</span> uts:<span class="token punctuation">[</span><span class="token number">4026531838</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该目录下有很多符号链接，每个符号链接代表一个该进程所属的namespace。用readlink读取这些符号链接可以查看进程所属的namespace id。我们读一下当前Shell所属的uts namespace id，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">sudo</span> readlink /proc/<span class="token variable">$$</span>/ns/uts
uts:<span class="token punctuation">[</span><span class="token number">4026531838</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>后文中我们将介绍uts namespace、mount namespace、pid namespace的用法。</p>
<h3 id="1-2-uts-namespace">1.2.uts namespace</h3>
<h4 id="1-2-1-uts-namespace简介">1.2.1.uts namespace简介</h4>
<p>uts namespace用于隔离系统的主机名等信息，我们将通过实验学习其用法。在实验过程中，我们采用如下的步骤：</p>
<ol>
<li>查看全局uts namespace信息</li>
<li>新建一个uts namespace，查看其信息并作出修改</li>
<li>查看全局uts namespace，查看其是否被新建的uts namespace影响到</li>
</ol>
<p>对于其他namespace，我们也采取类似的步骤进行实验学习。</p>
<p>首先，我们查看一下全局的hostname及uts namespace id。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">hostname</span>
kernelnewbies

phl@kernelnewbies:~$ <span class="token function">sudo</span> readlink /proc/<span class="token variable">$$</span>/ns/uts
uts:<span class="token punctuation">[</span><span class="token number">4026531838</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，我们创建一个新的uts namespace，并查看其namespce id。</p>
<p>在继续之前，需要介绍一个namespace工具unshare。利用unshare我们可以新建一个的namespace，并在新namespace中执行一条命令。unshare执行时需要root权限。unshare的使用方法如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">unshare <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>program <span class="token punctuation">[</span>arguments<span class="token punctuation">]</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>执行unshare时，我们可以指定要新建的namespace的类型以及要执行的命令。unshare提供了一系列选项，当指定某个选项时可新建指定的namespace。namespace类型选项如下：</p>
<ul>
<li>--uts创建新的uts namespace</li>
<li>--mount创建新的mount namespace</li>
<li>--pid创建新的pid namespace</li>
<li>--user创建新的user namespace</li>
</ul>
<p>介绍完unshare之后，我们继续之前的实验。我们用unshare创建一个新的uts namespace，并在新的uts namespace中执行/bin/bash命令，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">sudo</span> unshare --uts /bin/bash
root@kernelnewbies:~<span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>我们用unshare创建了一个新的uts namespace。在新的uts namespace中查看其hostname和namespace id，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~$ <span class="token function">hostname</span>
kernelnewbies

root@kernelnewbies:~<span class="token comment"># readlink /proc/$$/ns/uts</span>
uts:<span class="token punctuation">[</span><span class="token number">4026532177</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，新uts namespace的id与全局uts namespace的id不一致。这说明/bin/bash已运行在一个新的uts namespace中了。</p>
<p>我们将新uts namespace的hostname改为dreamland，并强制更新Shell提示符。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~<span class="token comment"># hostname dreamland</span>
root@kernelnewbies:~<span class="token comment"># hostname</span>
dreamland

root@kernelnewbies:~<span class="token comment"># exec /bin/bash</span>
root@dreamland:~<span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，新uts namespace的hostname的确是被修改了，exec /bin/bash用于强制更新Shell的提示符。</p>
<p>我们重新打开一个Shell窗口，该Shell位于全局uts namespace中。在新的Shell窗口中查看全局uts namespace id及hostname，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">hostname</span>
kernelnewbies

phl@kernelnewbies:~$ <span class="token function">sudo</span> readlink /proc/<span class="token variable">$$</span>/ns/uts
uts:<span class="token punctuation">[</span><span class="token number">4026531838</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，我们在新uts namespace中所作的修改并未影响到全局的uts namespace。</p>
<p>父进程创建子进程时只有提供创建新namespace的标志，才可创建新的namespace，并使子进程处于新的namespace中。默认情况下，子进程与父进程处于相同的namespace中。我们在新的uts namespace中创建一个子进程，然后查看该子进程的uts namespace id，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">sudo</span> unshare --uts /bin/bash
root@kernelnewbies:~<span class="token comment"># readlink /proc/$$/ns/uts</span>
uts:<span class="token punctuation">[</span><span class="token number">4026532305</span><span class="token punctuation">]</span>

root@kernelnewbies:~<span class="token comment"># bash</span>
root@kernelnewbies:~<span class="token comment"># readlink /proc/$$/ns/uts</span>
uts:<span class="token punctuation">[</span><span class="token number">4026532305</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，子进程所属uts namespace的id与其父进程相同。其他namespae与uts namespace类似，子进程与父进程同属一个namespace。</p>
<h4 id="1-2-2-docker-sh">1.2.2.docker.sh</h4>
<p>有了以上关于uts namespace的介绍，我们就可以将uts namespace加入到docker.sh中了。docker.sh工程分为两个脚本：docker.sh和container.sh。</p>
<p>docker.sh用于收集用户输入、调用unshare创建namespace并执行container.sh脚本，docker.sh脚本如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token function-name function">usage</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\033">\033</span>[31mIMPORTANT: Run As Root<span class="token entity" title="\033">\033</span>[0m"</span>
        <span class="token builtin class-name">echo</span> <span class="token string">""</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"Usage:    docker.sh [OPTIONS]"</span>
        <span class="token builtin class-name">echo</span> <span class="token string">""</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"A docker written by shell"</span>
        <span class="token builtin class-name">echo</span> <span class="token string">""</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"Options:"</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"          -c string       docker command"</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"                          (<span class="token entity" title="\&quot;">\"</span>run<span class="token entity" title="\&quot;">\"</span>)"</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"          -m              memory"</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"                          (<span class="token entity" title="\&quot;">\"</span>100M, 200M, 300M...<span class="token entity" title="\&quot;">\"</span>)"</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"          -C string       container name"</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"          -I string       image name"</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"          -V string       volume"</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"          -P string       program to run in container"</span>

        <span class="token builtin class-name">return</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token builtin class-name">test</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">whoami</span><span class="token variable">)</span></span>"</span> <span class="token operator">!=</span> root
<span class="token keyword">then</span>
        usage
        <span class="token builtin class-name">exit</span> -1
<span class="token keyword">fi</span>

<span class="token keyword">while</span> <span class="token builtin class-name">getopts</span> c:m:C:I:V:P: option
<span class="token keyword">do</span>
        <span class="token keyword">case</span> <span class="token string">"<span class="token variable">$option</span>"</span>
        <span class="token keyword">in</span>
                c<span class="token punctuation">)</span> <span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token variable">$OPTARG</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                m<span class="token punctuation">)</span> <span class="token assign-left variable">memory</span><span class="token operator">=</span><span class="token variable">$OPTARG</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                C<span class="token punctuation">)</span> <span class="token assign-left variable">container</span><span class="token operator">=</span><span class="token variable">$OPTARG</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                I<span class="token punctuation">)</span> <span class="token assign-left variable">image</span><span class="token operator">=</span><span class="token variable">$OPTARG</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                V<span class="token punctuation">)</span> <span class="token assign-left variable">volume</span><span class="token operator">=</span><span class="token variable">$OPTARG</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                P<span class="token punctuation">)</span> <span class="token assign-left variable">program</span><span class="token operator">=</span><span class="token variable">$OPTARG</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                <span class="token punctuation">\</span>?<span class="token punctuation">)</span> usage
                    <span class="token builtin class-name">exit</span> -2<span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token keyword">esac</span>
<span class="token keyword">done</span>

<span class="token builtin class-name">export</span> <span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token variable">$cmd</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">memory</span><span class="token operator">=</span><span class="token variable">$memory</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">container</span><span class="token operator">=</span><span class="token variable">$container</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">image</span><span class="token operator">=</span><span class="token variable">$image</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">volume</span><span class="token operator">=</span><span class="token variable">$volume</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">program</span><span class="token operator">=</span><span class="token variable">$program</span>

unshare --uts ./container.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>脚本最开始为usage函数，该函数为docker.sh的使用说明。当用户以非预期的方式使用docker.sh时，该函数会被调用。该函数输出如下信息：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">IMPORTANT: Run As Root

Usage:  docker.sh <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span>

A <span class="token function">docker</span> written by shell

Options:
                -c string       <span class="token function">docker</span> <span class="token builtin class-name">command</span>
                                <span class="token punctuation">(</span><span class="token string">"run"</span><span class="token punctuation">)</span>
                -m              memory
                                <span class="token punctuation">(</span><span class="token string">"100M, 200M, 300M..."</span><span class="token punctuation">)</span>
                -C string       container name
                -I string       image name
                -V string       volume
                -P string       program to run <span class="token keyword">in</span> container<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从usage函数的输出我们可以看到，执行docker.sh时需要root权限且需要正确地传递参数。</p>
<p>docker.sh首先对当前用户进行检测，如果用户不为root，则打印使用说明并退出脚本；如果用户为root，则继续执行。检测用户的脚本如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">if</span> <span class="token builtin class-name">test</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">whoami</span><span class="token variable">)</span></span>"</span> <span class="token operator">!=</span> root
<span class="token keyword">then</span>
        usage
        <span class="token builtin class-name">exit</span> -1
<span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，docker.sh使用getopts从命令行提取参数，然后赋值给合适的变量。从命令行提取参数的脚本如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">while</span> <span class="token builtin class-name">getopts</span> c:m:C:I:V:P: option
<span class="token keyword">do</span>
        <span class="token keyword">case</span> <span class="token string">"<span class="token variable">$option</span>"</span>
        <span class="token keyword">in</span>
                c<span class="token punctuation">)</span> <span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token variable">$OPTARG</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                m<span class="token punctuation">)</span> <span class="token assign-left variable">memory</span><span class="token operator">=</span><span class="token variable">$OPTARG</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                C<span class="token punctuation">)</span> <span class="token assign-left variable">container</span><span class="token operator">=</span><span class="token variable">$OPTARG</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                I<span class="token punctuation">)</span> <span class="token assign-left variable">image</span><span class="token operator">=</span><span class="token variable">$OPTARG</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                V<span class="token punctuation">)</span> <span class="token assign-left variable">volume</span><span class="token operator">=</span><span class="token variable">$OPTARG</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                P<span class="token punctuation">)</span> <span class="token assign-left variable">program</span><span class="token operator">=</span><span class="token variable">$OPTARG</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
                <span class="token punctuation">\</span>?<span class="token punctuation">)</span> usage
                    <span class="token builtin class-name">exit</span> -2<span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token keyword">esac</span>
<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果用户的输入不正确，则打印使用说明并退出脚本；如果用户输入正确，则解析命令行参数并赋值给合适的变量。</p>
<p>为了简化，用户在运行docker.sh时需提供完整的参数列表，示例如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>当然，如果当前用户就是root，就不需要sudo了。下表列出了各个参数的含义及示例：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1820220318143125.png" alt="使用 Shell 脚本实现 Docker"></p>
<p>docker.sh将命令行参数赋值给变量后，需要将这些变量导出，以传递给container.sh。导出变量的脚本如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">cmd</span><span class="token operator">=</span><span class="token variable">$cmd</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">memory</span><span class="token operator">=</span><span class="token variable">$memory</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">container</span><span class="token operator">=</span><span class="token variable">$container</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">image</span><span class="token operator">=</span><span class="token variable">$image</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">volume</span><span class="token operator">=</span><span class="token variable">$volume</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">program</span><span class="token operator">=</span><span class="token variable">$program</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里说明一下为什么要将docker.sh工程拆分为docker.sh和container.sh两个脚本。因为调用unshare创建新的namespace时，会执行一个命令，该命令在新的namespace中运行。该命令一旦结束，unshare也就结束了，unshare创建的新namespace也就不存在了。</p>
<p>docker.sh不会并发地执行unshare命令与unshare之后的脚本，因此，只有unshare结束了，后续脚本才可继续运行。但是当unshare结束了，准备执行后续脚本时，新的namespae已经不存在了。因此一些加入cgroups、切换根文件系统等工作必须在unshare执行的命令中进行，所以我们采用在unshare中执行container.sh脚本的方式完成后续的工作。</p>
<p>最后，docker.sh调用unshare创建新的uts namespace，并执行container.sh脚本。调用unshare的脚本如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">unshare --uts ./container.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>container.sh将容器的hostname修改为通过-C传递的容器的名字，然后执行通过-P传递的程序。container.sh脚本如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token function">hostname</span> <span class="token variable">$container</span>
<span class="token builtin class-name">exec</span> <span class="token variable">$program</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在，我们运行docker.sh，并查看其hostname。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
root@dreamland:~/docker.sh<span class="token comment"># hostname</span>
dreamland<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，容器的hostname已经改变为我们传递的容器名字dreamland了。</p>
<h3 id="1-3-mount-namespace">1.3.mount namespace</h3>
<h4 id="1-3-1-etc-mtab、-proc-self-mounts">1.3.1./etc/mtab、/proc/self/mounts</h4>
<p>早期的Linux使用/etc/mtab文件来记录当前的挂载点信息。每次mount/umount文件系统时会更新/etc/mtab文件中的信息。</p>
<p>后来，linux引入了mount namespace，每个进程都有一份自己的挂载点信息。当然，处于同一个mount namespace里面的进程，其挂载点信息是相同的。进程的挂载点信息通过/proc/[pid]/mounts文件导出给用户。</p>
<p>为了兼容以前的/etc/mtab，/etc/mtab变成了指向/proc/self/mounts的符号链接。通过readlink查看/etc/mtab指向的文件，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ readlink /etc/mtab
<span class="token punctuation">..</span>/proc/self/mounts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>通过读取/proc/self/mounts文件，可以查看当前的挂载点信息，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">cat</span> /proc/self/mounts
sysfs /sys sysfs rw,nosuid,nodev,noexec,relatime <span class="token number">0</span> <span class="token number">0</span>
proc /proc proc rw,nosuid,nodev,noexec,relatime <span class="token number">0</span> <span class="token number">0</span>
/dev/sda1 / ext4 rw,relatime,errors<span class="token operator">=</span>remount-ro <span class="token number">0</span> <span class="token number">0</span>
securityfs /sys/kernel/security securityfs rw,nosuid,nodev,noexec,relatime <span class="token number">0</span> <span class="token number">0</span>
<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于该文件中内容太多，我们省略了一部分，只保留了一些比较重要的挂载点信息。每行的信息分为六个字段，各字段的含义及示例如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1820220318143143.png" alt="使用 Shell 脚本实现 Docker"></p>
<p>由于该文件有点过时，被后文介绍的/proc/self/mountinfo替换掉，所以不做过多介绍。</p>
<h4 id="1-3-2-proc-self-mountinfo">1.3.2./proc/self/mountinfo</h4>
<p>/proc/self/mountinfo包含了进程mount namespace中的挂载点信息。 它提供了旧的/proc/[pid]/mounts文件中缺少的各种信息（传播状态，挂载点id，父挂载点id等），并解决了/proc/[pid]/mounts文件的一些其他缺陷。我们查看进程挂载点信息时应优先使用该文件。</p>
<p>该文件中每一行代表一个挂载点信息，每个挂载点信息分为11个字段。挂载点信息的示例如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1820220318143124.png" alt="使用 Shell 脚本实现 Docker"></p>
<p>各字段的含义及示例如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1820220318143118.png" alt="使用 Shell 脚本实现 Docker"></p>
<p>我们主要关注可选字段中的传播状态选项。首先，我们看一下关于mount namespace的问题。问题如下：</p>
<p>当创建mount namespace时，新mount namespace会拷贝一份老mount namespace里面的挂载点信息。例如，全局mount namespace中有一个/a挂载点，新建的mount namespace中也会有一个/a挂载点。那么我们在新mount namespace中的/a下创建或删除一个挂载点，全局mount namespace中的/a会同步创建或删除该挂载点吗？或者在全局mount namespace中的/a下创建或删除一个挂载点，新mount namespace中的/a会同步创建或删除该挂载点吗？</p>
<p>mountinfo文件中可选字段的传播状态就是控制在一个挂载点下进行创建/删除挂载点操作时是否会传播到其他挂载点的选项。传播状态有四种可取值，常见的有如下两种：</p>
<ul>
<li>shared 表示创建/删除挂载点的操作会传播到其他挂载点</li>
<li>private 表示创建/删除挂载点的操作不会传播到其他挂载点</li>
</ul>
<p>由于在容器技术中要保证主机与容器的挂载点信息互不影响，因此要求容器中的挂载点的传播状态为private。</p>
<h4 id="1-3-3-bind-mount">1.3.3.bind mount</h4>
<p>bind mount可以将一个目录（源目录）挂载到另一个目录（目的目录），在目的目录里面的读写操作将直接作用于源目录。</p>
<p>下面我们通过实验了解一下bind mount的功能，首先，我们准备一下实验所需要的的目录及文件。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">mkdir</span> <span class="token builtin class-name">bind</span>
phl@kernelnewbies:~$ <span class="token builtin class-name">cd</span> bind/
phl@kernelnewbies:~/bind$ <span class="token function">mkdir</span> a
phl@kernelnewbies:~/bind$ <span class="token function">mkdir</span> b
phl@kernelnewbies:~/bind$ <span class="token builtin class-name">echo</span> hello, a <span class="token operator">&gt;</span> a/a.txt
phl@kernelnewbies:~/bind$ <span class="token builtin class-name">echo</span> hello, b <span class="token operator">&gt;</span> b/b.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，我们将a目录bind mount到b目录并查看b目录下的内容。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/bind$ <span class="token function">sudo</span> <span class="token function">mount</span> --bind a b
phl@kernelnewbies:~/bind$ tree b
b
└── a.txt
<span class="token number">0</span> directories, <span class="token number">1</span> <span class="token function">file</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，b目录下原先的内容被隐藏，取而代之的是a目录下的内容。</p>
<p>然后，我们修改b目录下的内容，修改完毕后，从b目录上卸载掉a目录。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/bind$ <span class="token builtin class-name">echo</span> hello, a from b <span class="token operator">&gt;</span> b/a.txt
phl@kernelnewbies:~/bind$ <span class="token function">sudo</span> <span class="token function">umount</span> b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>我们读取一下a目录中a.txt，看看其内容是否被改变。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/bind$ <span class="token function">cat</span> a/a.txt
hello, a from b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，a目录中的内容确实被当a被bind mount到b时对b目录的操作所修改了。</p>
<p>bind mount在容器技术中有很重要的用途，后文会有涉及。</p>
<h4 id="1-3-4-mount-namespace简介">1.3.4.mount namespace简介</h4>
<p>mount namespace用来隔离文件系统的挂载点信息, 使得不同的mount namespace拥有自己独立的挂载点信息。不同的namespace之间不会相互影响，其在unshare中的选项为--mount。</p>
<p>当用unshare创建新的mount namespace时，新创建的namespace将拷贝一份老namespace里的挂载点信息，但从这之后，他们就没有关系了。这是unshare将新 namespace 里面的所有挂载点的传播状态设置为private实现的。通过mount和umount增加和删除各自mount namespace里面的挂载点都不会相互影响。</p>
<p>下面我们将演示mount namespace的用法。首先，我们准备需要的目录和文件，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">mkdir</span> -p hds/hd1 hds/hd2 <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> hds

phl@kernelnewbies:~/hds$ <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">bs</span><span class="token operator">=</span>1M <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">of</span><span class="token operator">=</span>hd1.img <span class="token operator">&amp;&amp;</span> mkfs.ext2 hd1.img
phl@kernelnewbies:~/hds$ <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">bs</span><span class="token operator">=</span>1M <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">of</span><span class="token operator">=</span>hd2.img <span class="token operator">&amp;&amp;</span> mkfs.ext2 hd2.img

phl@kernelnewbies:~$ tree <span class="token builtin class-name">.</span>
<span class="token builtin class-name">.</span>
├── hd1
├── hd1.img
├── hd2
└── hd2.img
<span class="token number">2</span> directories, <span class="token number">2</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，我们在全局的mount namespace中挂载hd1.img到hd1目录，然后查看该mount namespace中的挂载点信息与mount namespace id。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/hds$ <span class="token function">sudo</span> <span class="token function">mount</span> hd1.img hd1
phl@kernelnewbies:~/hds$ <span class="token function">cat</span> /proc/self/mountinfo <span class="token operator">|</span> <span class="token function">grep</span> hd
<span class="token number">556</span> <span class="token number">27</span> <span class="token number">7</span>:18 / /home/phl/hds/hd1 rw,relatime shared:372 - ext2 /dev/loop18 rw

phl@kernelnewbies:~/hds$ <span class="token function">sudo</span> readlink /proc/<span class="token variable">$$</span>/ns/mnt
mnt:<span class="token punctuation">[</span><span class="token number">4026531840</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，执行unshare命令创建一个新的mount namespace并查看该mount namespace id和挂载点信息。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/hds$ <span class="token function">sudo</span> unshare --uts --mount /bin/bash
root@kernelnewbies:~/hds<span class="token comment"># cat /proc/self/mountinfo | grep hd</span>
<span class="token number">739</span> <span class="token number">570</span> <span class="token number">7</span>:18 / /home/phl/hds/hd1 rw,relatime - ext2 /dev/loop18 rw

root@kernelnewbies:~/hds<span class="token comment"># readlink /proc/$$/ns/mnt</span>
mnt:<span class="token punctuation">[</span><span class="token number">4026532180</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，新mount namespace中的挂载点信息与全局mountnamespace中的挂载点信息基本一致，一些挂载选项（如传播状态）变化了。新的mount namespace id与全局mount namespace id是不一样的。</p>
<p>然后，我们在新的mount namespace中挂载hd2.img到hd2目录，并查看挂载点信息。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/hds<span class="token comment"># mount hd2.img hd2</span>
root@kernelnewbies:~/hds<span class="token comment"># cat /proc/self/mountinfo | grep hd</span>
<span class="token number">739</span> <span class="token number">570</span> <span class="token number">7</span>:18 / /home/phl/hds/hd1 rw,relatime - ext2 /dev/loop18 rw
<span class="token number">740</span> <span class="token number">570</span> <span class="token number">7</span>:19 / /home/phl/hds/hd2 rw,relatime - ext2 /dev/loop19 rw<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，新mount namespace中有hd1和hd2这两个挂载点。现在启动一个新的Shell窗口，查看全局mount namespace中的挂载点信息。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/hds$ <span class="token function">cat</span> /proc/self/mountinfo <span class="token operator">|</span> <span class="token function">grep</span> hd
<span class="token number">556</span> <span class="token number">27</span> <span class="token number">7</span>:18 / /home/phl/hds/hd1 rw,relatime shared:372 - ext2 /dev/loop18 rw<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，全局mount namespace中的挂载点信息只有hd1，而没有hd2。这说明在新mount namespace中进行挂载/卸载操作不会影响其他mount namespace中的挂载点信息。</p>
<p>mount namespace只隔离挂载点信息，并不隔离挂载点下面的文件信息。对于多个mount namespace都能看到的挂载点，如果在一个namespace中修改了挂载点下面的文件，其他namespace也能感知到。下面，我们在新建的mount namespace中创建一个文件，命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/hds<span class="token comment"># echo hello from new mount namespace &gt; hd1/hello.txt</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在新启动的Shell中，查看hd1目录并读取hd1/hello.txt文件。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/hds$ tree hd1
hd1
├── hello.txt
└── lost+found <span class="token punctuation">[</span>error opening dir<span class="token punctuation">]</span>
<span class="token number">1</span> directory, <span class="token number">1</span> <span class="token function">file</span>

phl@kernelnewbies:~/hds$ <span class="token function">cat</span> hd1/hello.txt
hello from new <span class="token function">mount</span> namespace<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，在全局mount namespace中，我们可以读取到在新建的mount namespace中创建的文件。</p>
<h4 id="1-3-5-docker-sh">1.3.5.docker.sh</h4>
<p>有了以上关于mount namespace的知识，我们就可以将mount namespace加入到docker.sh中了。mount namespace将放在docker.sh中，带下划线的行是我们为实现mount namespace而修改的代码。修改后的docker.sh脚本如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>.
unshare --uts --mount ./container.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>从上述代码我们可以看到，我们仅仅是在调用unshare时加入--mount选项，就可为docker.sh引入了mount namespace功能。</p>
<h3 id="1-4-pid-namespace">1.4.pid namespace</h3>
<h4 id="1-4-1-unshare的-fork选项">1.4.1.unshare的--fork选项</h4>
<p>unshare有一个选项--fork，当执行unshare时，如果没有这个选项，unshare会直接exec新命令，也就是说unshare变成了新命令。如果带有--fork选项，unshare会fork一个子进程，该子进程exec新命令，unshare是该子进程的父进程。我们分别不带--fork和带--fork来执行unshare，然后查看进程之间的关系。</p>
<p>首先，我们不带--fork选项执行unshare，并查看当前Shell的进程id。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">sudo</span> unshare --uts /bin/bash
root@kernelnewbies:~/hds<span class="token comment"># echo $$</span>
<span class="token number">11699</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>此时unshare会创建一个新的uts namespace，然后exec /bin/bash。我们启动一个新Shell，然后使用pstree查看进程间关系，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/hds$ pstree -p <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">11699</span>
sudo<span class="token punctuation">(</span><span class="token number">11698</span><span class="token punctuation">)</span>---bash<span class="token punctuation">(</span><span class="token number">11699</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，sudo fork出一个子进程，该子进程执行unshare。unshare创建了新uts namespace后，exec了/bin/bash，也就是说unshare变成了/bin/bash。</p>
<p>然后，我们带--fork选项执行unshare，并查看当前Shell的进程id。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/hds$ <span class="token function">sudo</span> unshare --uts --fork /bin/bash
root@kernelnewbies:~/hds<span class="token comment"># echo $$</span>
<span class="token number">11866</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>此时unshare会创建一个新的uts namespace，然后fork出一个子进程，该子进程exec /bin/bash。我们启动一个新Shell，然后使用pstree查看进程间关系，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/hds$ pstree -p <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">11866</span>
sudo<span class="token punctuation">(</span><span class="token number">11864</span><span class="token punctuation">)</span>---unshare<span class="token punctuation">(</span><span class="token number">11865</span><span class="token punctuation">)</span>---bash<span class="token punctuation">(</span><span class="token number">11866</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，sudo fork出一个子进程，该子进程执行命令unshare。unshare创建了新uts namespace后，fork出一个子进程，该子进程exec /bin/bash，也就是说unshare变成了新的/bin/bash进程的父进程。</p>
<h4 id="1-4-2-pid-namespace简介">1.4.2.pid namespace简介</h4>
<p>pid namespace用来隔离进程pid空间，使得不同pid namespace里的进程 pid可以重复且相互之间不影响。进程所属的pid namespace在创建的时候就确定了，无法更改，因此需要--fork选项来创建一个新进程，然后将该新进程加入新建的pid namespace中。pid namespace在unshare中的选项为--pid。</p>
<p>unshare在创建pid namespace时需同时提供--pid与--fork选项。unshare本身会加入全局的pid namespace，其fork出的子进程会加入新建的pid namespace。</p>
<p>首先，我们查看全局pid namespace id，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">sudo</span> readlink /proc/<span class="token variable">$$</span>/ns/pid
pid:<span class="token punctuation">[</span><span class="token number">4026531836</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后，执行unshare命令创建一个新的pid namespace并查看该pid namespace id。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">sudo</span> unshare --mount --pid --fork /bin/bash
root@kernelnewbies:~<span class="token comment"># readlink /proc/$$/ns/pid</span>
pid:<span class="token punctuation">[</span><span class="token number">4026531836</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，新创建的进程也处于全局pid namespace中，而不是新的pid namespace。</p>
<p>出现这种情形是因为当前的/proc文件系统是老的。我们查看一下$$的值，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~<span class="token comment"># echo $$</span>
<span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，$$的值为1，但是/proc文件系统却是老的，因此我们查看的实际是init进程所属的pid namespace，当然是全局pid namespace了。</p>
<p>重新挂载/proc文件系统，这也是unshare执行时带--mount选项的原因，只有这样，重新挂载/proc文件系统时，不会搞乱整个系统。再次查看新进程所属的pid namespace，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~<span class="token comment"># mount -t proc proc /proc</span>
root@kernelnewbies:~<span class="token comment"># readlink /proc/$$/ns/pid</span>
pid:<span class="token punctuation">[</span><span class="token number">4026532182</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，新进程的pid namespace与全局pid namespace的id不同。</p>
<p>接下来，我们再来查看一下新pid namespace中的进程信息。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~<span class="token comment"># ps -ef</span>
<span class="token environment constant">UID</span>        PID  <span class="token environment constant">PPID</span>  C STIME TTY          TIME CMD
root         <span class="token number">1</span>     <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">19</span>:03 pts/1    00:00:00 /bin/bash
root        <span class="token number">10</span>     <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">19</span>:03 pts/1    00:00:00 <span class="token function">ps</span> -e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，当前pid namespace中只有2个进程，看不到全局pid namespace里面的其他进程。我们通过unshare执行的进程pid为1，也就是说该进程成了新pid namespace中的init进程。</p>
<h4 id="1-4-3-pid嵌套">1.4.3.pid嵌套</h4>
<p>pid namespace可以嵌套，也就是说有父子关系，在当前pid namespace里面创建的所有新的pid namespace都是当前pid namespace的子pid namespace。</p>
<p>首先，我们创建3个嵌套的pid namespace，并查看每个pid namespace id。--mount-proc选项用于自动挂载/proc文件系统，省去了手动挂载/proc文件系统的操作。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">sudo</span> readlink /proc/<span class="token variable">$$</span>/ns/pid
pid:<span class="token punctuation">[</span><span class="token number">4026531836</span><span class="token punctuation">]</span>

phl@kernelnewbies:~$ <span class="token function">sudo</span> unshare --uts --mount --pid --mount-proc --fork /bin/bash
root@kernelnewbies:~<span class="token comment"># readlink /proc/$$/ns/pid</span>
pid:<span class="token punctuation">[</span><span class="token number">4026532182</span><span class="token punctuation">]</span>

root@kernelnewbies:~<span class="token comment"># unshare --uts --mount --pid --mount-proc --fork /bin/bash</span>
root@kernelnewbies:~<span class="token comment"># readlink /proc/$$/ns/pid</span>
pid:<span class="token punctuation">[</span><span class="token number">4026532185</span><span class="token punctuation">]</span>

root@kernelnewbies:~<span class="token comment"># unshare --uts --mount --pid --mount-proc --fork /bin/bash</span>
root@kernelnewbies:~<span class="token comment"># readlink /proc/$$/ns/pid</span>
pid:<span class="token punctuation">[</span><span class="token number">4026532188</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，我们启动一个新Shell，然后使用pstree查看进程间关系。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ pstree -lp <span class="token operator">|</span> <span class="token function">grep</span> unshare
sudo<span class="token punctuation">(</span><span class="token number">12547</span><span class="token punctuation">)</span>---unshare<span class="token punctuation">(</span><span class="token number">12548</span><span class="token punctuation">)</span>---bash<span class="token punctuation">(</span><span class="token number">12549</span><span class="token punctuation">)</span>---unshare<span class="token punctuation">(</span><span class="token number">12579</span><span class="token punctuation">)</span>---bash<span class="token punctuation">(</span><span class="token number">12580</span><span class="token punctuation">)</span>---unshare<span class="token punctuation">(</span><span class="token number">12593</span><span class="token punctuation">)</span>---bash<span class="token punctuation">(</span><span class="token number">12594</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>使用cat /proc/[pid]/status | grep NSpid可查看某进程在当前pid namespace及子孙pid namespace中的pid。我们在全局pid namespace中查看上述各进程在各pid namespace中的pid，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">cat</span> /proc/12594/status <span class="token operator">|</span> <span class="token function">grep</span> NSpid
NSpid: <span class="token number">12594</span> <span class="token number">21</span> <span class="token number">11</span> <span class="token number">1</span>

phl@kernelnewbies:~$ <span class="token function">cat</span> /proc/12593/status <span class="token operator">|</span> <span class="token function">grep</span> NSpid
NSpid: <span class="token number">12593</span> <span class="token number">20</span> <span class="token number">10</span>

phl@kernelnewbies:~$ <span class="token function">cat</span> /proc/12580/status <span class="token operator">|</span> <span class="token function">grep</span> NSpid
NSpid: <span class="token number">12580</span> <span class="token number">11</span> <span class="token number">1</span>

phl@kernelnewbies:~$ <span class="token function">cat</span> /proc/12579/status <span class="token operator">|</span> <span class="token function">grep</span> NSpid
NSpid: <span class="token number">12579</span> <span class="token number">10</span>

phl@kernelnewbies:~$ <span class="token function">cat</span> /proc/12549/status <span class="token operator">|</span> <span class="token function">grep</span> NSpid
NSpid: <span class="token number">12549</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面我们将以上进程在各pid namespace中的pid，整理成表格。表格信息如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1820220318143156.png" alt="使用 Shell 脚本实现 Docker"></p>
<p>我们以最后一行为例进行介绍，最后一行有4个pid，这4个pid其实是同一个进程。这个进程在4个pid namespace中都可以被看到，且其在4个pid namespace中的pid各不相同。</p>
<h4 id="1-4-4-docker-sh">1.4.4.docker.sh</h4>
<p>有了以上关于pid namespace的知识，我们就可以将pid namespae加入到docker.sh中了。pid namespace将放在docker.sh中，带下划线的行是我们为实现pid namespace而修改的代码。修改后的docker.sh脚本如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>.
unshare --uts --mount --pid --fork ./container.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>从上述代码我们可以看到，我们仅仅是在调用unshare时加入--pid和--fork选项，就可为docker.sh引入了pid namespace功能。</p>
<p>然后，我们需要重新挂载/proc文件系统。重新挂载/proc文件系统的功能将放在container.sh中，带下划线的行是我们为重新挂载/proc文件系统而新添的代码。修改后的container.sh脚本如下如下所示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">hostname</span> <span class="token variable">$container</span>
<span class="token function">mount</span> -t proc proc /proc
<span class="token builtin class-name">exec</span> <span class="token variable">$program</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>现在，我们运行docker.sh，并查看当前的进程信息。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
root@dreamland:~/docker.sh<span class="token comment"># ps -ef</span>
<span class="token environment constant">UID</span>        PID  <span class="token environment constant">PPID</span>  C STIME TTY          TIME CMD
root         <span class="token number">1</span>     <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">17</span>:31 pts/1    00:00:00 /bin/bash
root        <span class="token number">16</span>     <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">17</span>:31 pts/1    00:00:00 <span class="token function">ps</span> -ef<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可看出，当前进程只有两个，不再有主机上的其他进程。</p>
<h2 id="2-CGroups">2.CGroups</h2>
<h3 id="2-1-CGroups简介">2.1.CGroups简介</h3>
<p>CGroups是一种将进程分组，并以组为单位对进程实施资源限制的技术。每个组都包含以下几类信息：</p>
<ul>
<li>进程列表</li>
<li>资源A限制</li>
<li>资源B限制</li>
<li>资源C限制</li>
<li>...</li>
</ul>
<p>我们将以常见的CPU资源及内存资源为例进行介绍。以下的信息将使进程号为1001、1002、2008、3306的四个进程总共只能使用一个CPU核心；总共最多使用25%的CPU资源；总共最多使用100M内存，这样的一个分组被称为cgroup。</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1820220318143103.png" alt="使用 Shell 脚本实现 Docker"></p>
<p>上面的介绍只是说明了要将何种资源限制施加于哪些进程，并未说明资源限制是如何施加到进程上。具体施加资源限制的过程需要subsystem来帮忙。subsystem读取cgroup中的资源限制和进程列表，然后将这些资源限制施加到这些进程上。常见的subsystem包括如下几种：</p>
<ul>
<li>cpu</li>
<li>memory</li>
<li>pids</li>
<li>devices</li>
<li>blkio</li>
<li>net_cls</li>
</ul>
<p>每个subsystem只读取与其相关的资源限制，然后施加到进程上。例如：memory子系统只读取内存限制，而cpu子系统只读取cpu限制。</p>
<p>cgroup被组织成树，如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1820220318143057.png" alt="使用 Shell 脚本实现 Docker"></p>
<p>采用树状结构可以方便地实现资源限制继承，一个cgroup中的资源限制将作用于该cgroup及其子孙cgroup中的进程。例如：图中13001、10339、2999受到A、B、C、D四个cgroup中的资源限制。这样的一个树状结构被称为hierarchy。</p>
<p>hierarchy中包含了系统中所有的进程，它们分布于各个cgroup中。在hierarchy中，一个进程必须属于且只属于一个cgroup，这样才能保证对进程施加的资源限制不会遗漏也不会冲突。</p>
<p>要想让一个subsystem读取hierarchy中各cgroup的资源限制，并施加于其中的进程需要将subsystem和hierarchy关联起来。subsystem与hierarchy的关系如下：</p>
<ul>
<li>系统中可以有多个hierarchy</li>
<li>一个hierarchy可以关联0个或多个subsystem，当关联0个subsystem时，该hierarchy只是对进程进行分类</li>
<li>一个subsystem最多关联到一个hierarchy，因为每个hierarchy都包含系统中所有的进程，若一个subsystem关联到了多个hierarchy，对同一进程将有多种资源限制，这是不对的</li>
</ul>
<p>系统使用CGroups通常有两种形式：一种是创建一个hierarchy，将所有的subsystem关联到其上，在这个hierarchy上配置各种资源限制；另一种是为每一个subsystem创建一个hierarchy，并将该subsystem关联到其上，每个hierarchy只对一种资源进行限制。后一种比较清晰，得到了更普遍的采用。</p>
<p>CGroups不像大多数的技术那样提供API或命令之类的用户接口，而是提供给用户一个虚拟文件系统，该虚拟文件系统类型为cgroup。一个挂载后的cgroup文件系统就是一个hierarchy，文件系统中的一个目录就是一个cgroup，目录中的文件代表了进程列表或者资源限制信息。文件系统是树状结构，其各个目录之间的父子关系就代表了cgroup之间的继承关系。挂载cgroup虚拟文件系统后，通过在该文件系统上创建目录、写进程列表文件、写资源限制文件就可以操作CGroups。</p>
<p>下面，我们通过实验学习一下CGroups的用法。首先，我们挂载一个cgroup虚拟文件系统，该文件系统不与任何subsystem关联，仅仅是将进程进行分类。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">mkdir</span> -p cg/test
<span class="token comment"># -o none,name=test 表示该cgroup文件系统不与任何子系统关联</span>
<span class="token comment"># 该文件系统用name=test来标识</span>
phl@kernelnewbies:~$ <span class="token function">sudo</span> <span class="token function">mount</span> -t cgroup -o none,name<span class="token operator">=</span>test <span class="token builtin class-name">test</span> cg/test
phl@kernelnewbies:~$ tree cg/test
cg/test
├── cgroup.clone_children
├── cgroup.procs
├── cgroup.sane_behavior
├── notify_on_release
├── release_agent
└── tasks
<span class="token number">0</span> directories, <span class="token number">6</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>挂载cgroup文件系统后，该cgroup文件系统的根目录下会生成许多文件，该根目录被称为root cgroup。cgroup.procs里面存放的是当前cgroup中的所有进程id，由于该hierarchy中只有一个cgroup，所以这个文件包含了系统中所有的进程id。其他的文件与cgroups基本功能关系不大，暂时可以忽略。</p>
<p>在cgroup文件系统中，创建一个目录就会创建一个cgroup。下面我们将会演示如何创建下面这样的hierarchy：</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1820220318143054.png" alt="使用 Shell 脚本实现 Docker"></p>
<p>命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">sudo</span> <span class="token function">mkdir</span> -p cg/test/test1/test11
phl@kernelnewbies:~$ <span class="token function">sudo</span> <span class="token function">mkdir</span> -p cg/test/test2/test22
phl@kernelnewbies:~$ tree cg/test
cg/test
├── cgroup.clone_children
├── cgroup.procs
├── cgroup.sane_behavior
├── notify_on_release
├── release_agent
├── tasks
├── test1
│   ├── cgroup.clone_children
│   ├── cgroup.procs
│   ├── notify_on_release
│   ├── tasks
│   └── test11
│       ├── cgroup.clone_children
│       ├── cgroup.procs
│       ├── notify_on_release
│       └── tasks
└── test2
    ├── cgroup.clone_children
    ├── cgroup.procs
    ├── notify_on_release
    ├── tasks
    └── test22
        ├── cgroup.clone_children
        ├── cgroup.procs
        ├── notify_on_release
        └── tasks

<span class="token number">4</span> directories, <span class="token number">22</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，我们创建了相应的目录后，这些目录下自动出现了包含cgroup信息的目录及文件。</p>
<p>删除cgroup时只需删除该cgroup所在的目录即可。下面我们将删除test11 cgroup，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">sudo</span> <span class="token function">rmdir</span> cg/test/test1/test11
phl@kernelnewbies:~$ tree cg/test
cg/test
├── cgroup.clone_children
├── cgroup.procs
├── cgroup.sane_behavior
├── notify_on_release
├── release_agent
├── tasks
├── test1
│   ├── cgroup.clone_children
│   ├── cgroup.procs
│   ├── notify_on_release
│   └── tasks
└── test2
    ├── cgroup.clone_children
    ├── cgroup.procs
    ├── notify_on_release
    ├── tasks
    └── test22
        ├── cgroup.clone_children
        ├── cgroup.procs
        ├── notify_on_release
        └── tasks

<span class="token number">3</span> directories, <span class="token number">18</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>每个cgroup下面都有一个cgroup.procs文件，该文件里面包含当前cgroup里面的所有进程id。只要将某个进程的id写入该文件，即可将该进程加入到该cgroup中。下面，我们将当前的bash加入到test22 cgroup中，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token builtin class-name">echo</span> <span class="token variable">$$</span>
<span class="token number">3894</span>
phl@kernelnewbies:~$ <span class="token function">sudo</span> <span class="token function">sh</span> -c <span class="token string">"echo 3894 &gt; cg/test/test2/test22/cgroup.procs"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>/proc/[pid]/cgroup包含了某个进程所在的cgroup信息。下面，我们查看一下当前bash进程所在的cgroup信息，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">cat</span> /proc/3894/cgroup
<span class="token number">13</span>:name<span class="token operator">=</span>test:/test2/test22
<span class="token number">12</span>:freezer:/
<span class="token number">11</span>:perf_event:/
<span class="token number">10</span>:blkio:/user.slice
<span class="token number">9</span>:devices:/user.slice
<span class="token number">8</span>:hugetlb:/
<span class="token number">7</span>:cpu,cpuacct:/user.slice
<span class="token number">6</span>:net_cls,net_prio:/
<span class="token number">5</span>:memory:/user.slice
<span class="token number">4</span>:rdma:/
<span class="token number">3</span>:pids:/user.slice/user-1001.slice/session-4.scope
<span class="token number">2</span>:cpuset:/
<span class="token number">1</span>:name<span class="token operator">=</span>systemd:/user.slice/user-1001.slice/session-4.scope
<span class="token number">0</span>::/user.slice/user-1001.slice/session-4.scope<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，当前bash进程加入了多个cgroup，其中带下划线的行为我们刚刚加入的cgroup。</p>
<p>要想将hierarchy与子系统关联起来，需要在-o选项中指定子系统名称。下面演示了如何将memory子系统与新挂载的cgroup文件系统关联起来。代码如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">sudo</span> <span class="token function">mkdir</span> cg/memory
phl@kernelnewbies:~$ <span class="token function">sudo</span> <span class="token function">mount</span> -t cgroup -o memory memcg cg/memory<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>由于很多发行版的操作系统已经为我们配置好了这些cgroup文件系统，我们应当直接使用这些已经挂在好的文件系统，不需要自己去挂载。</p>
<p>另外，当创建子进程时，子进程会自动加入父进程所在的cgroup。</p>
<h3 id="2-2-限制内存">2.2.限制内存</h3>
<h4 id="2-2-1-用CGroups限制内存">2.2.1.用CGroups限制内存</h4>
<p>下面我们将介绍演示CGroups如何限制进程使用的内存资源，我们以内存为例进行讲解。</p>
<p>Ubuntu18.04已经为我们挂载了一个关联memory子系统的cgroup虚拟文件系统。我们用mount命令查看一下该系统挂载到了何处，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">mount</span> <span class="token operator">|</span> <span class="token function">grep</span> cgroup
tmpfs on /sys/fs/cgroup <span class="token builtin class-name">type</span> tmpfs <span class="token punctuation">(</span>ro,nosuid,nodev,noexec,mode<span class="token operator">=</span><span class="token number">755</span><span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/unified <span class="token builtin class-name">type</span> cgroup2 <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,nsdelegate<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/systemd <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,xattr,name<span class="token operator">=</span>systemd<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/cpuset <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,cpuset<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/pids <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,pids<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/rdma <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,rdma<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/memory <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,memory<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/net_cls,net_prio <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,net_cls,net_prio<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/cpu,cpuacct <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,cpu,cpuacct<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/hugetlb <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,hugetlb<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/devices <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,devices<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/blkio <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,blkio<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/perf_event <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,perf_event<span class="token punctuation">)</span>
cgroup on /sys/fs/cgroup/freezer <span class="token builtin class-name">type</span> cgroup <span class="token punctuation">(</span>rw,nosuid,nodev,noexec,relatime,freezer<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该系统挂载到了/sys/fs/cgroup/memory目录下。我们在该hierarchy中创建一个test cgroup并查看该cgroup的目录结构，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">sudo</span> <span class="token function">mkdir</span> /sys/fs/cgroup/memory/test
phl@kernelnewbies:~$ tree /sys/fs/cgroup/memory/test
/sys/fs/cgroup/memory/test
├── cgroup.clone_children
├── cgroup.event_control
├── cgroup.procs
├── memory.failcnt
├── memory.force_empty
├── memory.kmem.failcnt
├── memory.kmem.limit_in_bytes
├── memory.kmem.max_usage_in_bytes
├── memory.kmem.slabinfo
├── memory.kmem.tcp.failcnt
├── memory.kmem.tcp.limit_in_bytes
├── memory.kmem.tcp.max_usage_in_bytes
├── memory.kmem.tcp.usage_in_bytes
├── memory.kmem.usage_in_bytes
├── memory.limit_in_bytes
├── memory.max_usage_in_bytes
├── memory.move_charge_at_immigrate
├── memory.numa_stat
├── memory.oom_control
├── memory.pressure_level
├── memory.soft_limit_in_bytes
├── memory.stat
├── memory.swappiness
├── memory.usage_in_bytes
├── memory.use_hierarchy
├── notify_on_release
└── tasks
<span class="token number">0</span> directories, <span class="token number">27</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，新建的test cgroup中有许多文件，这些文件中存放着资源限制信息。其中memory.limit_in_bytes里面存放的是该cgroup中的进程能够使用的内存额度。</p>
<p>下面，我们将当前bash加入到test cgroup中并查看当前bash所属的cgroup信息。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token builtin class-name">echo</span> <span class="token variable">$$</span>
<span class="token number">2984</span>
phl@kernelnewbies:~$ <span class="token function">sudo</span> <span class="token function">sh</span> -c <span class="token string">"echo 2984 &gt; /sys/fs/cgroup/memory/test/cgroup.procs"</span>
phl@kernelnewbies:~$ <span class="token function">cat</span> /proc/2984/cgroup
<span class="token number">12</span>:devices:/user.slice
<span class="token number">11</span>:hugetlb:/
<span class="token number">10</span>:memory:/test
<span class="token number">9</span>:rdma:/
<span class="token number">8</span>:perf_event:/
<span class="token number">7</span>:blkio:/user.slice
<span class="token number">6</span>:cpu,cpuacct:/user.slice
<span class="token number">5</span>:pids:/user.slice/user-1001.slice/session-4.scope
<span class="token number">4</span>:freezer:/
<span class="token number">3</span>:cpuset:/
<span class="token number">2</span>:net_cls,net_prio:/
<span class="token number">1</span>:name<span class="token operator">=</span>systemd:/user.slice/user-1001.slice/session-4.scope
<span class="token number">0</span>::/user.slice/user-1001.slice/session-4.scope<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，当前bash所属的memory cgroup变为了/test，该目录为一个相对于root cgroup的相对路径。</p>
<p>然后，将100M写入test cgroup中的memory.limit_in_bytes文件中，命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">sudo</span> <span class="token function">sh</span> -c <span class="token string">"echo 100M &gt; /sys/fs/cgroup/memory/test/memory.limit_in_bytes"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们在当前bash中启动一个占用300M进程的stress进程，该stress进程是bash的子进程，其与bash进程都在test cgroup中。命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ stress --vm <span class="token number">1</span> --vm-bytes 300M --vm-keep<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>启动一个新的Shell窗口，执行top命令查看stress进程占用的内存。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">PID <span class="token environment constant">USER</span>      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
<span class="token number">14216</span> root      <span class="token number">20</span>   <span class="token number">0</span>  <span class="token number">315440</span> <span class="token number">101224</span>    <span class="token number">264</span> D <span class="token number">27.7</span>  <span class="token number">2.5</span>   <span class="token number">0</span>:02.66 stress<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，stress进程占用了2.5%的内存。我的电脑的内存为4G，4G * 2.5% = 100M，stress进程确实受到了cgroup中设置的内存额度的限制。</p>
<h4 id="2-2-2-docker-sh">2.2.2.docker.sh</h4>
<p>下有了以上关于CGroups的知识，我们就可以将限制内存的功能加入到docker.sh中了。限制内存的功能将放在container.sh中，带下划线的行是我们为实现限制内存而新添的代码。修改后的container.sh脚本如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">hostname</span> <span class="token variable">$container</span>
<span class="token function">mkdir</span> -p /sys/fs/cgroup/memory/<span class="token variable">$container</span>
<span class="token builtin class-name">echo</span> <span class="token variable">$$</span> <span class="token operator">&gt;</span> /sys/fs/cgroup/memory/<span class="token variable">$container</span>/cgroup.procs
<span class="token builtin class-name">echo</span> <span class="token variable">$memory</span> <span class="token operator">&gt;</span> /sys/fs/cgroup/memory/<span class="token variable">$container</span>/memory.limit_in_bytes
<span class="token function">mount</span> -t proc proc /proc
<span class="token builtin class-name">exec</span> <span class="token variable">$program</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先，我们根据容器的名字创建cgroup，命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> -p /sys/fs/cgroup/memory/<span class="token variable">$container</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后，我们将当前bash加入到我们创建的cgroup中，命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token variable">$$</span> <span class="token operator">&gt;</span> /sys/fs/cgroup/memory/<span class="token variable">$container</span>/cgroup.procs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>最后，我们将内存限制写入新cgroup的memory.limit_in_bytes文件中，命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token variable">$memory</span> <span class="token operator">&gt;</span> /sys/fs/cgroup/memory/<span class="token variable">$container</span>/memory.limit_in_bytes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>现在，我们运行docker.sh，并启动一个占用300M进程的stress进程。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
root@dreamland:~/docker.sh<span class="token comment"># stress --vm 1 --vm-bytes 300M --vm-keep</span>
stress: info: <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> dispatching hogs: <span class="token number">0</span> cpu, <span class="token number">0</span> io, <span class="token number">1</span> vm, <span class="token number">0</span> hdd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>启动一个新的Shell窗口，执行top命令查看stress进程占用的内存。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">PID <span class="token environment constant">USER</span>      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
<span class="token number">14216</span> root      <span class="token number">20</span>   <span class="token number">0</span>  <span class="token number">315440</span> <span class="token number">101224</span>    <span class="token number">264</span> D <span class="token number">27.7</span>  <span class="token number">2.5</span>   <span class="token number">0</span>:02.66 stress<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，容器内的stress进程只使用了100M的内存。</p>
<h2 id="3-切换根文件系统">3.切换根文件系统</h2>
<h3 id="3-1-根文件系统">3.1.根文件系统</h3>
<p>在容器技术中，根文件系统可为容器进程提供一个与主机不一致的文件系统环境。举个例子，主机为Ubuntu 18.04，创建的容器采用Ubuntu 16.04的根文件系统，那么容器运行时所用的软件及其依赖库、配置文件等都是Ubuntu 16.04的。尽管该容器使用的内核是仍旧是Ubuntu 18.04的，但应用软件的表现却与Ubuntu 16.04一致，从虚拟化的角度来说该容器就是一个Ubuntu 16.04系统。</p>
<p>debootstrap是Ubuntu下的一个工具，用来构建根文件系统。生成的目录符合Linux文件系统标准，即包含了/boot、/etc、/bin、/usr等目录。debootstrap的安装命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">debootstrap</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>下面我们通过debootstrap构建Ubuntu 16.04的根文件系统。为了清晰，我们在images目录下生成根文件系统。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ <span class="token function">mkdir</span> images
phl@kernelnewbies:~/docker.sh$ <span class="token builtin class-name">cd</span> images
phl@kernelnewbies:~/docker.sh/images$ <span class="token function">sudo</span> <span class="token function">debootstrap</span> --arch amd64 xenial ./ubuntu1604<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>制作根文件系统需要从服务器下载很多文件，很耗时，请耐心等待。当文件系统制作好后，可以使用tree命令查看生成的根文件系统。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh/images$ tree -L <span class="token number">1</span> ubuntu1604/
ubuntu1604/
├── bin
├── boot
├── dev
├── etc
├── home
├── lib
├── lib64
├── media
├── mnt
├── old_root
├── opt
├── proc
├── root
├── run
├── sbin
├── srv
├── sys
├── tmp
├── usr
└── var
<span class="token number">20</span> directories, <span class="token number">0</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个根文件系统与Linux系统目录很相近，我们后续的实验将使用该根文件系统。</p>
<h3 id="3-2-pivot-root">3.2.pivot_root</h3>
<p>pivot_root命令用于切换根文件系统，其使用方式如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pivot_root new_root put_old<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>pivot_root将当前进程的根文件系统移至put_old目录并使new_root目录成为新的根文件系统。</p>
<p>下面我们将通过实验学习pivot_root的使用方法。为了简单，我们在一个新的mount namespace下进行实验。首先，我们创建一个新的mount namespace，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh/images$ <span class="token function">sudo</span> unshare --mount /bin/bash
root@kernelnewbies:~/docker.sh/images<span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在我们的实验中，我们的根文件系统将挂载在ubuntu1604目录，而老的根文件系统将被移动到ubuntu1604/old_root目录下。我们先创建old_root目录，命令如下：</p>
<p>root@kernelnewbies:~/docker.sh/images# mkdir -p ubuntu1604/old_root/</p>
<p>由于pivot_root命令要求老的根目录和新的根目录不能在同一个挂载点下，因此我们通过bind mount将ubuntu1604目录变成一个挂载点。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/docker.sh/images<span class="token comment"># mount --bind ubuntu1604 ubuntu1604</span>
root@kernelnewbies:~/docker.sh/images<span class="token comment"># cat /proc/self/mountinfo | grep ubuntu1604</span>
<span class="token number">624</span> <span class="token number">382</span> <span class="token number">8</span>:1 /home/phl/docker.sh/images/ubuntu1604 /home/phl/docker.sh/images/ubuntu1604 rw,relatime - ext4 /dev/sda1 rw,errors<span class="token operator">=</span>remount-ro<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>准备好切换根文件系统所需要的条件后，我们调用pivot_root切换根文件系统。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/docker.sh/images<span class="token comment"># cd ubuntu1604/</span>
root@kernelnewbies:~/docker.sh/images/ubuntu1604<span class="token comment"># pivot_root . old_root/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>此时，已完成根文件系统的切换，/proc文件系统也被挪到了<br>
/home/phl/docker.sh/images/ubuntu1604/old_root/proc，也就是说当前没有/proc文件系统，因此，我们无法查看挂载点信息，自然也无法执行一些依赖于/proc文件系统的操作。我们需要重新挂载/proc文件系统。命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/docker.sh/images/ubuntu1604<span class="token comment"># mount -t proc proc /proc</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>重新挂载/proc文件系统后，我们就可以查看当前的挂载点信息了。通过读取/proc/self/mountinfo文件来查看系统的挂载点信息。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/docker.sh/images/ubuntu1604<span class="token comment"># cat /proc/self/mountinfo</span>
<span class="token number">382</span> <span class="token number">624</span> <span class="token number">8</span>:1 / /old_root rw,relatime - ext4 /dev/sda1 rw,errors<span class="token operator">=</span>remount-ro
<span class="token punctuation">..</span>.
<span class="token number">624</span> <span class="token number">381</span> <span class="token number">8</span>:1 /home/phl/docker.sh/images/ubuntu1604 / rw,relatime - ext4 /dev/sda1 rw,errors<span class="token operator">=</span>remount-ro
<span class="token number">625</span> <span class="token number">624</span> <span class="token number">0</span>:5 / /proc rw,relatime - proc proc rw<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时的挂载点很多，为了方便查看，此处只保留了一些主要的挂载点信息。这些挂载点信息包括/、/proc、/old_root。/old_root为老的根文件系统，我们需要将其卸载。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/docker.sh/images/ubuntu1604<span class="token comment"># umount -l /old_root/</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>卸载掉老的根文件系统后，我们再查看系统的挂载点信息。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kernelnewbies:~/docker.sh/images/ubuntu1604<span class="token comment"># cat /proc/self/mountinfo</span>
<span class="token number">624</span> <span class="token number">381</span> <span class="token number">8</span>:1 /home/phl/docker.sh/images/ubuntu1604 / rw,relatime - ext4 /dev/sda1 rw,errors<span class="token operator">=</span>remount-ro
<span class="token number">625</span> <span class="token number">624</span> <span class="token number">0</span>:5 / /proc rw,relatime - proc proc rw<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>此时，挂载点信息中只有/、/proc，不再有主机的挂载点信息。</p>
<h3 id="3-3-docker-sh">3.3.docker.sh</h3>
<p>有了以上关于切换根文件系统的知识，我们就可以将切换根文件系统的功能加入到docker.sh中了。切换根文件系统的功能将放在container.sh中，带下划线的行是我们为实现切换根文件系统而新添的代码。修改后的container.sh脚本如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token function">hostname</span> <span class="token variable">$container</span>

<span class="token function">mkdir</span> -p /sys/fs/cgroup/memory/<span class="token variable">$container</span>
<span class="token builtin class-name">echo</span> <span class="token variable">$$</span> <span class="token operator">&gt;</span> /sys/fs/cgroup/memory/<span class="token variable">$container</span>/cgroup.procs
<span class="token builtin class-name">echo</span> <span class="token variable">$memory</span> <span class="token operator">&gt;</span> /sys/fs/cgroup/memory/<span class="token variable">$container</span>/memory.limit_in_bytes

<span class="token function">mkdir</span> -p images/<span class="token variable">$image</span>/old_root
<span class="token function">mount</span> --bind images/<span class="token variable">$image</span> images/<span class="token variable">$image</span>

<span class="token builtin class-name">cd</span> images/<span class="token variable">$image</span>
pivot_root <span class="token builtin class-name">.</span> ./old_root

<span class="token function">mount</span> -t proc proc /proc
<span class="token function">umount</span> -l /old_root

<span class="token builtin class-name">exec</span> <span class="token variable">$program</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先，我们在新的根文件系统目录中创建挂载老的根文件系统的目录。命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> -p images/<span class="token variable">$image</span>/old_root<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后，我们将新根文件系统目录bind mount成一个挂载点。命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mount</span> --bind images/<span class="token variable">$image</span> images/<span class="token variable">$image</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后，我们切换根文件系统。命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> images/<span class="token variable">$image</span>
pivot_root <span class="token builtin class-name">.</span> ./old_root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>最后，我们重新挂载/proc文件系统，然后卸载掉老的根文件系统。命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mount</span> -t proc proc /proc
<span class="token function">umount</span> -l /old_root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>现在，我们运行docker.sh，并查看当前的发行版信息。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
root@dreamland:/<span class="token comment"># cat /etc/issue</span>
Ubuntu <span class="token number">16.04</span> LTS <span class="token punctuation">\</span>n <span class="token punctuation">\</span>l<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看出，读出的发行版信息是Ubuntu 16.04 LTS \n \l，而非主机的Ubuntu 18.04.3 LTS \n \l。这说明当前使用的根文件系统确实是ubuntu16.04目录下的根文件系统，而非主机的根文件系统。</p>
<p>我们再查看一下当前的挂载点信息，看看是否只有/与/proc。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@dreamland:/<span class="token comment"># cat /proc/self/mountinfo</span>
<span class="token number">625</span> <span class="token number">381</span> <span class="token number">8</span>:1 /home/phl/docker.sh/images/ubuntu1604 / rw,relatime - ext4 /dev/sda1 rw,errors<span class="token operator">=</span>remount-ro
<span class="token number">626</span> <span class="token number">625</span> <span class="token number">0</span>:52 / /proc rw,relatime - proc proc rw<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可看出，当前挂载点信息中只有/、/proc，不再有主机的挂载点信息。</p>
<p>通过根文件系统，我们实现了在容器中虚拟出与主机不一样的操作系统的功能。</p>
<h2 id="4-联合加载">4.联合加载</h2>
<h3 id="4-1-联合加载简介">4.1.联合加载简介</h3>
<p>联合加载指的是一次同时加载多个文件系统，但是在外面看起来只能看到 一个文件系统。联合加载会将各层文件系统叠加到一起，这样最终的文件系统会 包含所有底层的文件和目录。</p>
<p>联合加载的多个文件系统中有一个是可读写文件系统，称为读写层，其他文件系统是只读的，称为只读层。当联合加载的文件系统发生变化时，这些变化都应用到这个读写层。比如，如果想修改一个文件，这个文件首先会从只读层复制到读写层。原只读层中的文件依然存在，但是被读写层中的该文件副本所隐藏。我们以后读写该文件时，都是读写的该文件在读写层中的副本。这种机制被称为 写时复制。</p>
<p>我们之前实现的docker.sh，有一个很大的缺陷。那就是，如果使用相同的根文件系统同时启动多个容器的实例，那么，这些容器实例使用的根文件系统位于同一个目录。我们在不同的容器实例对根文件系统所作的修改，这些容器彼此之间都可以看到，甚至一个容器可以覆覆盖另一个容器所作的修改。同时，容器实例退出时，对根文件系统所作的修改也直接作用于其所使用的根文件系统。当我们使用该根文件系统再次启动容器实例时，新启动的容器实例也可以看到以前的这些修改。例如，我们用ubuntu1604根文件系统启动两个容器实例，命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> ./docker.sh -c run -m 100M -C dreamland2 -I ubuntu1604 -V data1 -P /bin/bash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这两个容器实例对根文件系统做的修改彼此都可以看到。容器实例退出时，这些修改也被保存了下来，当用ubuntu1604根文件系统启动新的容器实例时，新实例也可看到以前实例所做的修改。</p>
<p>如果容器使用的根文件系统是一个联合加载的文件系统，原先的根文件系统作为一个只读层，再添加一个读写层，那么，在容器内所作的修改都将只作用于读写层。为了区分，我们以后称ubuntu1604目录下的根文件系统为镜像。而我们可以为每一个容器实例指定一个唯一的读写层目录，这样的话，多个容器实例就可以使用同一个镜像，容器内所作的修改不会影响彼此，也不会影响到以后启动的容器实例。例如：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> ./docker.sh -c run -m 100M -C dreamland2 -I ubuntu1604 -V data1 -P /bin/bash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>我们使用ubuntu1604镜像启动了两个容器示例，并在容器实例里进行读写操作。这两个容器实例的读写层目录是不一样的，在容器实例中所作的修改只作用于各自的读写层，彼此之间不会影响，当然更不会影响到后续启动的容器实例。</p>
<h3 id="4-2-AUFS">4.2. AUFS</h3>
<p>AUFS是一个实现了联合加载功能的文件系统。我们将采用AUFS实现docker.sh中的联合加载功能。</p>
<p>下面，我们将通过实验演示一下AUFS文件系统的用法。首先，我们准备需要用到的目录及文件。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~$ <span class="token function">mkdir</span> aufs
phl@kernelnewbies:~$ <span class="token builtin class-name">cd</span> aufs/
phl@kernelnewbies:~/aufs$ <span class="token function">mkdir</span> rw r1 r2 union
phl@kernelnewbies:~/aufs$ <span class="token builtin class-name">echo</span> hello r1 <span class="token operator">&gt;</span> r1/hellor1.txt
phl@kernelnewbies:~/aufs$ <span class="token builtin class-name">echo</span> hello r2 <span class="token operator">&gt;</span> r2/hellor2.txt
phl@kernelnewbies:~/aufs$ <span class="token builtin class-name">echo</span> hello rw <span class="token operator">&gt;</span> rw/hellorw.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下表列出了各个目录的作用。列表如下：</p>
<ul>
<li>rw为aufs文件系统的读写层目录</li>
<li>r1为aufs文件系统的只读层目录</li>
<li>r2为aufs文件系统的只读层目录</li>
<li>union为挂载点，联合加载的aufs文件系统挂载于此目录</li>
</ul>
<p>下面我们将rw、r1、r2联合加载到union目录。命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/aufs$ <span class="token function">sudo</span> <span class="token function">mount</span> -t aufs -o <span class="token assign-left variable">dirs</span><span class="token operator">=</span>rw:r1:r2 none union<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>-t aufs表示要挂载的文件系统类型为AUFS</li>
<li>-o dirs=rw:r1:r2表示要将哪些目录加载到afus文件系统中，多个目录之间以:分隔。目录列表中的第一个目录表示读写层目录</li>
<li>union表示aufs文件系统要挂载的目录</li>
</ul>
<p>挂载好AUFS文件系统后，我们进入该文件系统，查看其内容。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/aufs$ <span class="token builtin class-name">cd</span> union/
phl@kernelnewbies:~/aufs/union$ <span class="token function">ls</span>
hellor1.txt hellor2.txt hellorw.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>从输出结果来看，rw、r1、r2目录下的内容全部出现在了AUFS文件系统中，该文件系统由rw、r1、r2目录叠加而成。</p>
<p>然后，我们修改这些文件，看看原始的rw、r1、r2目录下的文件是否更改。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/aufs/union$ <span class="token builtin class-name">echo</span> hello to r1 from union <span class="token operator">&gt;</span> hellor1.txt
phl@kernelnewbies:~/aufs/union$ <span class="token builtin class-name">echo</span> hello to r2 from union <span class="token operator">&gt;</span> hellor2.txt
phl@kernelnewbies:~/aufs/union$ <span class="token builtin class-name">echo</span> hello to rw from union <span class="token operator">&gt;</span> hellorw.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>我们返回到aufs目录，直接查看aufs目录下的内容。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/aufs$ tree <span class="token builtin class-name">.</span>
<span class="token builtin class-name">.</span>
├── r1
│   └── hellor1.txt
├── r2
│   └── hellor2.txt
├── rw
│   ├── hellor1.txt
│   ├── hellor2.txt
│   └── hellorw.txt
└── union
    ├── hellor1.txt
    ├── hellor2.txt
    └── hellorw.txt

<span class="token number">4</span> directories, <span class="token number">8</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从输出结果我们可以看到，我们修改的hellor1.txt和hellor2.txt文件分别被拷贝了一份放在读写层目录rw中。我们查看一下这些文件的内容，命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/aufs$ <span class="token function">cat</span> r1/hellor1.txt
hello r1
phl@kernelnewbies:~/aufs$ <span class="token function">cat</span> r2/hellor2.txt
hello r2
phl@kernelnewbies:~/aufs$ <span class="token function">cat</span> rw/hellor1.txt
hello to r1 from union
phl@kernelnewbies:~/aufs$ <span class="token function">cat</span> rw/hellor2.txt
hello to r2 from union
phl@kernelnewbies:~/aufs$ <span class="token function">cat</span> rw/hellorw.txt
hello to rw from union<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从输出结果我们看到，用户修改只读层r1、r2中的文件时，这些文件被复制到了读写层，我们修改的是读写层的副本，原只读层中的文件没有变化。用户修改读写层rw中的文件时，修改直接作用于这些文件本身。</p>
<h3 id="4-3-docker-sh">4.3.docker.sh</h3>
<p>在继续之前，我们需要将上一章在ubuntu1604根文件系统中创建的old_root目录删除掉，以保证该根文件系统跟刚制作好时一样。命令及结果如下：</p>
<p>phl@kernelnewbies:~/docker.sh$ sudo rm -rf images/ubuntu1604/old_root</p>
<p>有了以上关于联合加载的介绍，我们就可以将联合加载功能加入到docker.sh中了。联合加载功能将放在container.sh脚本中，带下划线的行是我们为实现联合加载功能而新添的代码。修改后的container.sh如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token function">hostname</span> <span class="token variable">$container</span>

<span class="token function">mkdir</span> -p /sys/fs/cgroup/memory/<span class="token variable">$container</span>
<span class="token builtin class-name">echo</span> <span class="token variable">$$</span> <span class="token operator">&gt;</span> /sys/fs/cgroup/memory/<span class="token variable">$container</span>/cgroup.procs
<span class="token builtin class-name">echo</span> <span class="token variable">$memory</span> <span class="token operator">&gt;</span> /sys/fs/cgroup/memory/<span class="token variable">$container</span>/memory.limit_in_bytes

<span class="token function">mkdir</span> -p <span class="token variable">$container</span>/rwlayer
<span class="token function">mount</span> -t aufs -o <span class="token assign-left variable">dirs</span><span class="token operator">=</span><span class="token variable">$container</span>/rwlayer:./images/<span class="token variable">$image</span> none <span class="token variable">$container</span>

<span class="token function">mkdir</span> -p <span class="token variable">$container</span>/old_root
<span class="token builtin class-name">cd</span> <span class="token variable">$container</span>
pivot_root <span class="token builtin class-name">.</span> ./old_root

<span class="token function">mount</span> -t proc proc /proc
<span class="token function">umount</span> -l /old_root

<span class="token builtin class-name">exec</span> <span class="token variable">$program</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先，我们根据容器的名字创建联合加载需要的读写层目录及文件系统挂载目录。命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> -p <span class="token variable">$container</span>/rwlayer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>假如我们传递的容器的名字为dreamland，将创建以下目录：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ tree dreamland/
dreamland/
└── rwlayer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>其中dreamland/rwlayer目录为创建的AUFS文件系统的读写层，dreamland目录为AUFS文件系统的挂载点。</p>
<p>然后我们将镜像目录、读写层目录联合加载到挂载点目录。命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mount</span> -t aufs -o <span class="token assign-left variable">dirs</span><span class="token operator">=</span><span class="token variable">$container</span>/rwlayer:./images/<span class="token variable">$image</span> none <span class="token variable">$container</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>假如容器名字为dreamland，使用的镜像为ubuntu1604根文件系统，dreamland/rwlayer、images/ubuntu1604将被联合加载的dreamland目录。其中，dreamland/rwlayer为AUFS文件系统的读写层，images/ubuntu1604为AUFS文件系统的只读层。</p>
<p>之前我们将老的根文件系统挪到了rootfs/old_root，rootfs代表一个具体的镜像目录。创建old_root目录时直接修改了该镜像。下面我们将老的根文件系统的挂载点目录放在AUFS文件系统中，并将老的根文件系统挪到此处。命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> -p <span class="token variable">$container</span>/old_root
<span class="token builtin class-name">cd</span> <span class="token variable">$container</span>
pivot_root <span class="token builtin class-name">.</span> ./old_root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>此时，$container目录本身就是一个挂载点，挂载了AUFS文件系统。因此下面的代码就被移除了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mount</span> --bind images/<span class="token variable">$image</span> images/<span class="token variable">$image</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>现在，我们运行docker.sh，并在/root下创建一个文件。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
root@dreamland:/<span class="token comment"># cd /root</span>
root@dreamland:/root<span class="token comment"># ls</span>
root@dreamland:/root<span class="token comment"># cat /etc/issue &gt; hello.txt</span>
root@dreamland:/root<span class="token comment"># cat hello.txt</span>
Ubuntu <span class="token number">16.04</span> LTS <span class="token punctuation">\</span>n <span class="token punctuation">\</span>l<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动一个新的Shell窗口，查看一下该容器使用的AUFS文件系统。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> tree dreamland/
dreamland/
└── rwlayer
    ├── old_root
    └── root
        └── hello.txt

<span class="token number">2</span> directories, <span class="token number">1</span> <span class="token function">file</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，我们新建的文件及创建的老根文件系统的挂载点目录都出现在了读写层。我们再查看一下新创建的文件。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> <span class="token function">cat</span> dreamland/rwlayer/root/hello.txt
Ubuntu <span class="token number">16.04</span> LTS <span class="token punctuation">\</span>n <span class="token punctuation">\</span>l<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>文件内容是Ubuntu 16.04的发行版信息。</p>
<p>通过联合加载，我们实现了在容器中的读写不会影响使用的镜像。这样使用ubuntu1604镜像创建多个容器时，彼此之间就不会相互影响了。</p>
<h2 id="5-卷">5.卷</h2>
<h3 id="5-1-卷简介">5.1.卷简介</h3>
<p>卷是容器内的一个目录，这个目录可以绕过联合文件系统，提供数据共享（容器所使用的的联合文件系统不应该被主机或其他容器访问）与数据持久化的功能。</p>
<p>举个例子，假如容器有个目录为/data的卷，我们向这个卷写入的内容不会出现在联合文件系统的读写层，而是直接出现在这个目录里。主机与其他容器也可以访问该目录，从而达到数据共享与数据持久化的目的。</p>
<p>卷位于联合文件系统中，通常来说写入该目录的内容会被写入容器的读写层中，那么怎样才能是写入卷的目录直接出现在该目录中，而不是容器读写层呢？其实方法很简单，只要我们将该目录变成一个挂载点就行，变成挂载点后，这个目录中的内容就不属于联合文件系统了，写入该目录的内容自然会保存在挂载到该挂载点的设备中。</p>
<h3 id="5-2-docker-sh">5.2 docker.sh</h3>
<p>有了以上关于卷的介绍，我们就可以将卷功能加入到docker.sh中了。卷功能将放在container.sh脚本中，带下划线的行是我们为实现卷功能而新添的代码。修改后的container.sh脚本如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token function">hostname</span> <span class="token variable">$container</span>

<span class="token function">mkdir</span> -p /sys/fs/cgroup/memory/<span class="token variable">$container</span>
<span class="token builtin class-name">echo</span> <span class="token variable">$$</span> <span class="token operator">&gt;</span> /sys/fs/cgroup/memory/<span class="token variable">$container</span>/cgroup.procs
<span class="token builtin class-name">echo</span> <span class="token variable">$memory</span> <span class="token operator">&gt;</span> /sys/fs/cgroup/memory/<span class="token variable">$container</span>/memory.limit_in_bytes

<span class="token function">mkdir</span> -p <span class="token variable">$container</span>/rwlayer
<span class="token function">mount</span> -t aufs -o <span class="token assign-left variable">dirs</span><span class="token operator">=</span><span class="token variable">$container</span>/rwlayer:./images/<span class="token variable">$image</span> none <span class="token variable">$container</span>

<span class="token function">mkdir</span> -p <span class="token variable">$volume</span>
<span class="token function">mkdir</span> -p <span class="token variable">$container</span>/<span class="token variable">$volume</span>
<span class="token function">mount</span> --bind <span class="token variable">$volume</span> <span class="token variable">$container</span>/<span class="token variable">$volume</span>

<span class="token function">mkdir</span> -p <span class="token variable">$container</span>/old_root
<span class="token builtin class-name">cd</span> <span class="token variable">$container</span>
pivot_root <span class="token builtin class-name">.</span> ./old_root

<span class="token function">mount</span> -t proc proc /proc
<span class="token function">umount</span> -l /old_root

<span class="token builtin class-name">exec</span> <span class="token variable">$program</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先，我们根据卷的名字创建主机卷目录，我们在容器内部对卷的修改，都将作用于此目录。命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> -p <span class="token variable">$volume</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后，我们在容器内部创建同名卷目录，该目录本身会出现在容器的读写层中，因为该目录是在AUFS文件系统中创建的。因为<img src="https://math.now.sh?inline=container%E7%9B%AE%E5%BD%95%E4%B8%BA%E5%AE%B9%E5%99%A8%E7%9A%84%E6%A0%B9%E7%9B%AE%E5%BD%95%EF%BC%8C%E6%89%80%E4%BB%A5%E5%AE%B9%E5%99%A8%E5%86%85%E9%83%A8%E5%8D%B7%E7%9B%AE%E5%BD%95%E7%9A%84%E8%B7%AF%E5%BE%84%E4%B8%BA%2F" style="filter: opacity(90%);transform:scale(0.85);text-align:center;display:inline-block;margin: 0;">volume。命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> -p <span class="token variable">$container</span>/<span class="token variable">$volume</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>将主机上的卷目录bind mount到容器内部的卷目录上，这样容器内部对卷目录的修改，都将作用于主机卷目录。命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mount</span> --bind <span class="token variable">$volume</span> <span class="token variable">$container</span>/<span class="token variable">$volume</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>现在，我们运行docker.sh，并在卷目录（/data1）中创建一个文件。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> ./docker.sh -c run -m 100M -C dreamland -I ubuntu1604 -V data1 -P /bin/bash
root@dreamland:/<span class="token comment"># cd /data1</span>
root@dreamland:/data1<span class="token comment"># echo "hello to data1 volume from ubuntu16.04" &gt;&gt; hello.txt</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>启动一个新的Shell窗口，查看一下该容器使用的AUFS文件系统中的内容。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> tree dreamland/
dreamland/
└── rwlayer
    ├── data1
    ├── old_root
    └── root
        └── hello.txt

<span class="token number">4</span> directories, <span class="token number">1</span> <span class="token function">file</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，我们使用的卷目录被创建在了容器的读写层，但是我们在卷目录中新建的文件却没有出现在读写层中。</p>
<p>我们再来查看一下主机卷目录的内容。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> tree data1/
data1/
└── hello.txt

<span class="token number">0</span> directories, <span class="token number">1</span> <span class="token function">file</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，在容器内部对卷目录的修改直接作用在了主机上的卷目录。我们再来查看一下主机卷目录下hello.txt中的内容。命令及结果如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">phl@kernelnewbies:~/docker.sh$ <span class="token function">sudo</span> <span class="token function">cat</span> data1/hello.txt
hello to data1 volume from ubuntu16.04<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>从结果我们可以看到，该文件的内容与我们在容器内部写入hello.txt的内容一致。</p>
<p>通过卷目录，我们实现了容器之间数据共享与数据持久化的功能。</p>
<h2 id="6-后记">6.后记</h2>
<p>至此，我们通过一系列的实验对docker的底层技术有了一个感性的认识。我们在使用docker时，也能够对其是如何运作的有了一个大致的了解。当然，这对于掌握docker技术来说还远远不够，有很多知识我们没有涉及，例如user namespace、容器安全、其他的CGroups、虚拟网络等。</p>
<p>编辑整理 <a target="_blank" rel="noopener" href="https://www.toutiao.com/i6890898988879315468/?tt_from=weixin&amp;utm_campaign=client_share&amp;wxshare_count=1&amp;timestamp=1647576105&amp;app=news_article&amp;utm_source=weixin&amp;utm_medium=toutiao_android&amp;use_new_style=1&amp;req_id=202203181201440101511900790A2CBE46&amp;share_token=b2d9351e-4cb1-4a25-ae82-f70543ce2a3b&amp;group_id=6890898988879315468">ScratchLab</a></p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>docker</tag>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>winrar去广告和破解</title>
    <url>/posts/3b296307/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>WinRAR 是一款不错的解压缩软件，但还是收费软件，广告不少，今天就总结了一下网上的各路教程。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/hexo@latest/medias_webp/cover/winrar.webp" alt=""></p>
<h2 id="crack-winrar">crack winrar</h2>
<p>首先通过特殊方式获取软件许可：<br>
新建一个文本文档</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2022/03/1920220319200929.png" alt="img"></p>
<p>在这个文本文档里输入内容：</p>
<pre class="line-numbers language-key" data-language="key"><code class="language-key">RAR registration data``Federal Agency ``for` `Education``1000000 PC usage license``UID=b621cca9a84bc5deffbf``6412612250ffbf533df6db2dfe8ccc3aae5362c06d54762105357d``5e3b1489e751c76bf6e0640001014be50a52303fed29664b074145``7e567d04159ad8defc3fb6edf32831fd1966f72c21c0c53c02fbbb``2f91cfca671d9c482b11b8ac3281cb21378e85606494da349941fa``e9ee328f12dc73e90b6356b921fbfb8522d6562a6a4b97e8ef6c9f``fb866be1e3826b5aa126a4d2bfe9336ad63003fc0e71c307fc2c60``64416495d4c55a0cc82d402110498da970812063934815d81470829275<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0320211103230820.png" alt="img"></p>
<p>然后将文件名改为：rarreg.key</p>
<p><img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0320211103231031.png" alt="img"></p>
<p>再将这个文件导入WinRAR的安装文件夹<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0320211103231545.png" alt="img"><br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0320211103231839.png" alt="img"><br>
这时点开关于WinRAR，已经获取许可。<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0320211103231800.png" alt="img"></p>
<h2 id="去除广告">去除广告</h2>
<p>接下来使用Resource Hacker软件打开<strong>winrar</strong>.exe<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0320211103231916.png" alt="img"><br>
进入字串表，找到“80”，删除“1267”和“1277”行<br>
点击绿色三角形按钮，编译。<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0320211103231939.png" alt="img"><br>
然后：文件→另存为，进行保存。<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0320211103232002.png" alt="img"><br>
然后对源文件：winrar.exe进行替换,注意，要关闭winrar软件<br>
<img src="https://cdn.jsdelivr.net/gh/appotry/cloudimg@latest/data/2021/11/0320211103232039.png" alt="img"></p>
<p>至此，已经完成破解和去广告了。</p>
<p>参考来源 52pojie</p>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css">]]></content>
      <categories>
        <category>tools</category>
      </categories>
      <tags>
        <tag>tools</tag>
        <tag>winrar</tag>
        <tag>crack</tag>
      </tags>
  </entry>
</search>
